---
title: "Mulholland Lab Fiber Photometry Analysis R Notebook" 
output:                                                      
pdf_document: default                                      
html_notebook: default                                     
editor_options:                                            
markdown:                                                  
wrap: 72                                                   
---

# PURPOSE & BACKGROUND

This document details how to read in, analyze, and produce graphs with the data that is output from Mulholland Lab's MATLAB Fiber Photometry loop function AFTER compilation.

To run the code, **enable Visual mode and the Outline view** by clicking the buttons on the window of this document. Then simply navigate to the block of code and press the play button (green triangle). If the code errors, it will show you were the error occurred, making it easy to adapt the code as processes change.

To begin, you will need to install, R, RStudio, and Rtools as detailed in the protocol to do so on the Mulholland server in the "Computation Behavior" folder. To make things smoother, use the versions listed below.

BASE CODE'S AUTHOR: Christina L. Lebonville, PhD, 2022-2024 (Yes it is ok to bug me about this code)

QUICK START: This code is written in the order it should be run to create the necessary variables & data. To run the shortcut version, after you have **session.analysis3**, only run the steps with the asterisks to speed through to the stats and figures.

# SYSTEM ENVIRONMENT

Installation of R, RStudio, and Rtools can be found on the Mulholland Lab server:

"Z:\\01. PROTOCOLS\\Computation Behavior\\R & RStudio Installation\\R & RStudio - Installation Guide.docx"

To run this code, ideally, you are using the same system environment (versions of R, RStudio, and Rtools) I've tested it out on (see below). You can download and install any version of R or Rtools from here: <https://cran.r-project.org/bin/windows/>. If you are not using my tested environment, you need to first make sure that your R version and RTools version are compatible. Here is a trick, R 4.2 uses Rtools 42. R 4.0 and 4.1 use Rtools 40. Despite having installed the right ones, you could have multiple versions so that the wrong one is being used.

## Check Version/Compatibility of R, RStudio, & RTools

```{r}
#Install package DevTools if not already installed
install.packages("devtools");
```

```{r}
#Load packages from devtools that will help
library("pkgbuild");
library("rstudioapi");
library("devtools");

getRversion(); #Gets R version
info<-versionInfo(); #Gets RStudio version (second line prints it)
cat("RStudio Version:",info$long_version,info$release_name)
find_rtools(); #Says True/False whether RTools is installed
rtools_path(); #Gives path of RTools RStudio is talking to


##Check all system info (operating system, R, RStudio, and package versions) to save for comparison
sessioninfo::session_info(to_file = TRUE)
```

You can download and install R from <https://cran.r-project.org/bin/windows/>. Once you have double-checked that your R and Rtools will play nice together (which they will if you use my exact tested environment), the packages required by the code will install properly and be functional.

## Current Tested Environment

R 4.3.1 (2023-06-16 ucrt) --- "Beagle Scouts", Platform: x86_64-w64-mingw32/x64 (64-bit)\
RStudio 2023.06.1+524 "Mountain Hydrangea" Release (547dcf861cac0253a8abb52c135e44e02ba407a1, 2023-07-07) for windows\
Rtools43

#### Old Environments

R 4.2.3 (2023-03-15 ucrt) -- "Shortstop Beagle" Platform: x86_64-w64-mingw32/x64 (64-bit) RStudio 2023.03.0+386b "Cherry Blossom" Release (3c53477afb13ab959aeb5b34df1f10c237b256c3,2023-03-09) for Windows RTools 4.2.

R (v.4.2.2., 2022-10-31 ucrt-- "Innocent and Trusting") USING RStudio 2022.07.2+576 "Spotted Wakerobin" Release (e7373ef832b49b2a9b88162cfe7eac5f22c40b34, 2022-09-06) for Windows

# CITATIONS

R Core Team (2021). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL <https://www.R-project.org/>.\
Alboukadel Kassambara (2021). rstatix: Pipe-Friendly Framework for Basic Statistical Tests. R package version 0.7.0. <https://CRAN.R-project.org/package=rstatix>\
Alboukadel Kassambara. Comparing Multiple Means in R: Mixed ANOVA in R. Publisher: DataNovia. Access Year: 2022. <https://www.datanovia.com/en/lessons/mixed-anova-in-r/> Sochacki, Jakub (2022). 3-way ANOVA. Publisher: RPubs by RStudio. <https://rpubs.com/JS24/853604>

GENERAL PROJECT APPROACH/MANAGEMENT: <https://rfortherestofus.com/2021/02/how-to-use-git-github-with-r/>\
<https://happygitwithr.com/install-git.html> <https://goodresearch.dev/>

FOR LITERALLY EVERYTHING GRAPH RELATED\
<https://ggplot2-book.org/>\
<http://zevross.com/blog/2019/04/02/easy-multi-panel-plots-in-r-using-facet_wrap-and-facet_grid-from-ggplot2/>

For mixed/multilevel modeling <https://quantdev.ssri.psu.edu/tutorials/r-bootcamp-introduction-multilevel-model-and-interactions> <https://rpubs.com/rslbliss/r_mlm_ws> <https://www.stats.ox.ac.uk/~snijders/FixedRandomEffects.pdf> <https://mspeekenbrink.github.io/sdam-r-companion/linear-mixed-effects-models.html#formulating-and-estimating-linear-mixed-effects-models-with-lme4>

Heisig and Schaeffer 2019. <https://academic.oup.com/esr/article/35/2/258/5306121>

<https://uncdependlab.github.io/MLM_Tutorial/06_ModelSelection/model_comparison.html#akaike-information-criterion-aic>

<https://www.theanalysisfactor.com/six-differences-between-repeated-measures-anova-and-linear-mixed-models/>

# R Programming Cheat Sheets

```{r}
vignette("regular-expressions") # regular expressions are voodoo and this is really helpful for knowing what all of it means

vignette("ggplot2-specs") # for all of the aesthetic settings in ggplot2

#https://www.rdocumentation.org/packages/grDevices/versions/3.6.2/topics/plotmath 
#https://rdrr.io/r/grDevices/plotmath.html for all the rules for parsing text

#https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax #For use in styling text with Markdown (i.e., element_markdown())

```

# LOAD REQUIRED R PACKAGES

## 0) First Time Only: Install Required Packages

To run this code, you will need a number of packages to be installed. Packages and versions listed are the ones that I last used and should work with the current code. If renv is present under RStudio's Packages tab, which should be the case if you are within the MulhollandLabFiberPhotometry Project, use "Restore Library" from the drop-down menu to install compatible versions of the packages straight from the project library. I HIGHLY RECOMMEND USING RENV LIBRARY RESTORE INSTEAD OF CODE BELOW UNLESS YOU ARE USING A MORE MODERN VERSION OF R & RStudio than the one I tested. Alternatively, you can specify the version after naming the package to install like this: install.packages("xlsx", version='0.6.5'). By default, if a version is not specified, it will install the latest version.

```{r}
install.packages("xlsx"); #ver 0.6.5 used
install.packages("rstatix"); #ver 0.7.2 used
install.packages("reshape"); #ver 0.8.9 used
install.packages("rlang",INSTALL_opts = '--no-lock'); #ver 1.1.0 used
install.packages("tidyverse"); #ver 2.0.0 used
install.packages("ggpubr"); #0.6.0
install.packages("plyr"); #ver 1.8.8
install.packages("dplyr"); #ver 1.1.2
install.packages("datarium"); #ver. 0.1.0
install.packages("data.table"); #ver 1.14.8
install.packages("outliers"); #ver 0.15
install.packages("lubridate"); #ver 1.9.2
install.packages("sp"); #2.0-0
install.packages("scales"); #ver 1.2.1
install.packages("backports"); #ver 1.4.1     
install.packages("effects"); #ver 4.2-2    
install.packages("interactions"); #ver 1.1.5
install.packages("lme4"); #ver 1.1-34
install.packages("lmerTest"); #ver 3.1-3   
install.packages("psych"); #ver 2.3.6    
install.packages("ggpattern"); #ver 1.0.1
install.packages("memisc"); #ver 0.99.31.6
install.packages("broom.mixed"); #ver 0.2.9.4
install.packages("modelsummary"); #ver 1.4.1
install.packages("insight"); #ver 0.19.5
install.packages("knitr"); #ver 1.43
install.packages("ggbeeswarm"); #ver 0.7.2
install.packages("sjPlot"); #ver 2.8.14
install.packages("patchwork"); #ver 1.1.3
install.packages("ggtext"); #ver 0.1.2
install.packages("merTools"); #ver 0.6.1
install.packages("ggh4x"); #ver 0.2.6
install.packages("emmeans"); #ver 1.8.8
install.packages("ggbreak");
install.packages("ggimage");
install.packages("summclust"); 
install.packages("latex2exp");
install.packages("graph3d"); #ver 0.2.0
install.packages("r2mlm"); # for R-squared values
install.packages("performance"); 
install.packages("sjlabelled"); #For labelling model variables better in SJPlots
install.packages("car"); 
install.packages("ggsignif");
install.packages("extrafont"); # To get more fonts to use in ggplot2. MUST THEN RUN A FEW LINES OF CODE TO GET TO WORK (See Note Below)
install.packages("gridExtra"); 
```

## \*1) Load the Required Packages

```{r}
options(java.parameters = "- Xmx1024m") #rJava struggles with the massive data files produced so the memory must be increased before loading any libraries that use rJava. 

library(xlsx);
library(plyr); #must load before dplyr for proper function
library(rstatix);
library(reshape);
library(rlang);
library(vctrs);
library(tidyverse);
library(dplyr);
library(ggpubr);
library(datarium);
library(data.table);
library(outliers);
library(lubridate);
library(sp);
library(scales);
library(backports);     # to revive the isFALSE() function for sim_slopes()
library(effects);       # for probing interactions
library(interactions);  # for probing/plotting interactions
library(lme4);          # for multilevel models
library(lmerTest);      # for p-values
library(psych);         # for describing the data
library(ggpattern);	    # for making plots with patterns as legend keys
library(memisc);	      # for exporting lmer stats
library(broom.mixed);
library(modelsummary);
library(insight);       # for easily accessing parts of a model object
library(knitr);
library(ggbeeswarm);
library(sjPlot);
library(ggtext);        # for being able to wrap text in labels
library(patchwork);     # for inlaying graphs
library(merTools);      # for some nice plots exploring MLM effects
library(ggh4x);         # for extra faceting options in ggplot2
library(emmeans);       # for displaying interaction effects in mixed models
library(ggbreak);       # for discontinuous scales with different ranges
library(ggimage);
library(summclust);     # for diagnostics of clustered models
library(latex2exp);     # to plot diagnostics of clustered models
library(graph3d);       # to make cool 3d plots
library(r2mlm);         # for R-squared values
library(performance);    # for ICC
library(sjlabelled);      # for better variable labels in sjplot
library(car);          # another contrast tool that makes better contrast labels and vif diagnostics
library(ggsignif)   # A package that streamlines ggplot significance indicators
library(extrafont); # To get more fonts for ggplot2 <- after loading first time, need to run: "font_import(), type "y" then press enter, then run: loadfonts(device = "win")
library(gridExtra); # To make cool random effects plots in diagnostics
```

## \*2) Load Custom Functions

```{r}
# Believe it or not, std error doesn't have a built in function except in some packages - I did not want it to become contingent on those packages so I just wrote a function that does the std error calculation. 

std.error<-function(x){
  sd(x)/sqrt(length((x)))
}

# Returns a data.frame with info needed to draw quantile segments. CL found a bug where geom_violin_pattern doesn't find this function within ggplot2.
create_quantile_segment_frame <- function(data, draw_quantiles) {
  dens <- cumsum(data$density) / sum(data$density)
  ecdf <- stats::approxfun(dens, data$y, ties = "ordered")
  ys <- ecdf(draw_quantiles) # these are all the y-values for quantiles

  # Get the violin bounds for the requested quantiles.
  violin.xminvs <- (stats::approxfun(data$y, data$xminv))(ys)
  violin.xmaxvs <- (stats::approxfun(data$y, data$xmaxv))(ys)

  # We have two rows per segment drawn. Each segment gets its own group.
  data_frame0(
    x = vec_interleave(violin.xminvs, violin.xmaxvs),
    y = rep(ys, each = 2),
    group = rep(ys, each = 2)
  )
}

# Wrapping vctrs data_frame constructor with no name repair
data_frame0 <- function(...) tibble(..., .name_repair = "minimal")

```

# DATA PREPARATION

## \*1) Read in a study's fiber photometry data (Only One)

Data should be the default, [*compiled*]{.underline} bout output of the Mulholland Lab's MATLAB loop. Specifically Sheet 4 with Bout data. Alternatively, you can extract this sheet from the xlsx file and add manual data for each row like "Output.Order" &"Mouse" & "Sex" , and save as a CSV/xlsx. I found this way too tedious so don't worry, if you didn't want to do this manually, we'll create the variables later.

Your xlsx/CSV file should have a top row that is Variable Names that you will use to analyze the data. Special characters get transformed to "." so try not to use them.

### a) CL8

```{r}
##TrueBout DEG Updated Data with Signal Descriptive Stats & AUC Measures
file<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/20250612T113221_CompiledData.xls"

# ##TrueBout DEG Updated Data with Signal Descriptive Stats & AUC Measures - TEST WITH ONE FILE - manually added "% of C" from old file
# file<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Results/20201026CL8A1B8resultsB.xlsx"
# data<-read.xlsx(file,sheetIndex=4,header=TRUE)
# names(data)[which(names(data)=="X..of.C")]<- "x_OfC"


##TrueBout DEG Updated Data with Signal Descriptive Stats
# file<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/20231214T145514_CompiledData.xls"


##TrueBout DEG Updated Data
#file<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/20230823T084925_CompiledData.xls"

data<-read.xlsx(file,sheetIndex=1,header=TRUE)


##Original Data
#file<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/PrelimAnalysisBeforeTrueBout/PJM_CL8_Results/Bouts_CL8_PJM_NNLS_CompiledData.csv"

#data<-read.csv(file, header = TRUE, sep = ",", quote = "\"",dec = ".", fill = TRUE, comment.char = "")

```


## \*2) Clean up data

### (Option 1) All data in file is good data

```{r}
bout.analysis<-data
```

### (Option 2) Filter by column name (Incomplete & buggy - Work in progress)

Filter out what you need if there are things you don't care about in the spreadsheet. Otherwise, use previous code block to use all variables. I added customization here so it will detect whether you manually added Output.Order, Mouse, and Sex. Don't worry, if you didn't, we'll create them later.

```{r}
rootlist<-c('FileName','Channel','Mouse','Bout','BoutStarts','BoutDuration','LicksPerBout','LickFrequency','MeanBefore','MeanAfter','PeakBefore','PeakAfter','Onset','End','x_OfC')
  
root_output<-c('Output.Order','FileName','Channel','Mouse','Sex','Bout'  ,'BoutStarts','BoutDuration','LicksPerBout','LickFrequency','MeanBefore','MeanAfter','PeakBefore','PeakAfter','Onset','End','x_OfC')

root_outputsex<-c('Output.Order','FileName','Channel','Mouse','Sex','Bout','BoutStarts','BoutDuration','LicksPerBout','LickFrequency','MeanBefore','MeanAfter','PeakBefore','PeakAfter','Onset','End','x_OfC')

root_sex<-c('FileName','Channel','Mouse','Sex','Bout','BoutStarts','BoutDuration','LicksPerBout','LickFrequency','MeanBefore','MeanAfter','PeakBefore','PeakAfter','Onset','End','x_OfC')


if ("Output.Order" %in% names(data)==TRUE){
  if ("Sex" %in% names(data)==TRUE){
      bout.analysis<-data[,root_outputsex]
  }else{
      bout.analysis<-data[,root_output]
}}else{ 
  if ("Sex" %in% names(data)==TRUE){
      bout.analysis<-data[,root_sex]
  }else{bout.analysis<-data[,rootlist]
    }}
```

## \*3) Create study-specific key information

This step creates variables like groups, Output.Order, Mouse, Session (coded three ways), and Sex if they weren't filled in manually and sets important statistical factors and levels.

### a) For CL8

```{r}
file2<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/CL8exptkey.xlsx"  

sessionkey<-read.xlsx(file2, sheetIndex=1)  

sexkey<-read.xlsx(file2, sheetIndex=2)  

#Code to automatically enter in Output Order,Mouse,& Sex based on order in spreadsheet and FileName
setDT(bout.analysis)[,Output.Order:=c(1:length(row.names(bout.analysis)))] 
setDT(bout.analysis)[,Sex:=rep(NA,length(row.names(bout.analysis)))] 
setDT(bout.analysis)[,session.sol:=rep(NA,length(row.names(bout.analysis)))]
setDT(bout.analysis)[,session.lin:=rep(NA,length(row.names(bout.analysis)))]
setDT(bout.analysis)[,session.exp:=rep(NA,length(row.names(bout.analysis)))]
setDT(bout.analysis)[,Solution:=rep(NA,length(row.names(bout.analysis)))]  

#Fill in the correct session # and Solution from the matching FileName entry in the key 

###########################################################
## If running on raw, non-compiled Excel files, need this block of code to define FileName and Channel from the file name read in. 
# setDT(bout.analysis)[,FileName:=rep(str_extract(file,"(?<=Results/).+?(?=results)"),length(row.names(bout.analysis)))]
# setDT(bout.analysis)[,Channel:=rep(str_extract(file,"(?<=results).+?(?=.xlsx)"),length(row.names(bout.analysis)))]
# names(bout.analysis)<- str_replace(names(bout.analysis),"^A|^B","")
# setDT(bout.analysis)[,Bout:=1:length(row.names(bout.analysis))]
# ###########################################################

for (i in 1:length(bout.analysis$FileName)){ 
  bout.analysis$session.sol[[i]]<-sessionkey$session.solution[[which(sessionkey$FileName==bout.analysis$FileName[[i]])]]
  bout.analysis$session.lin[[i]]<-sessionkey$session.linear[[which(sessionkey$FileName==bout.analysis$FileName[[i]])]]
  bout.analysis$session.exp[[i]]<-sessionkey$session.experiment[[which(sessionkey$FileName==bout.analysis$FileName[[i]])]]
  bout.analysis$Solution[[i]]<-sessionkey$Solution[[which(sessionkey$FileName==bout.analysis$FileName[[i]])]]
}

## Grab the Mouse number from the FileName title - numbers that follow either A or B, depending on whether A or B is in "Channel"
for(i in 1:length(bout.analysis$FileName)){ 
  if(bout.analysis$Channel[[i]]=="A"){
    bout.analysis$Mouse[[i]]<-str_extract(bout.analysis$FileName[[i]],"(?<=A)[0-9]*")}
  if(bout.analysis$Channel[[i]]=="B"){
    bout.analysis$Mouse[[i]]<-str_extract(bout.analysis$FileName[[i]],"(?<=B)[0-9]*")}
}

## Grab the Sex from the entry in the key that matches each Mouse
for (i in 1:length(bout.analysis$Mouse)){ 
  bout.analysis$Sex[[i]]<-sexkey$Sex[[which(sexkey$Mouse==bout.analysis$Mouse[[i]])]]}

#Make new variables for signal differences pre- and post-bout and position (first 10 last 10)
meanbeforeafter<-bout.analysis$MeanAfter-bout.analysis$MeanBefore
pmeanbeforeafter<-((bout.analysis$MeanAfter-bout.analysis$MeanBefore)/bout.analysis$MeanBefore)*100
peakbeforeafter<-bout.analysis$PeakAfter-bout.analysis$PeakBefore
end.onset<-bout.analysis$End-bout.analysis$Onset

bout.analysis<-cbind(bout.analysis,meanbeforeafter,pmeanbeforeafter,peakbeforeafter,end.onset)

bout.analysis<-bout.analysis %>% mutate(Position=case_when(BoutStarts<=740 ~ "First 10 min",BoutStarts>=7288 ~ "Last 10 min", BoutStarts>740 & BoutStarts<7288 ~"Middle"))
  

bout.analysis<-sort_df(bout.analysis,c('Output.Order'))


rownames(bout.analysis)<-c(1:length(rownames(bout.analysis))) #reset row names so they follow a consecutive order again

##Levels of different factors specific to experiment - used later in 5) Finalize and is EXTREMELY IMPORTANT for contrasts
#This is used for the wide format data
group1.levels<-c("Female EtOH", "Male EtOH","Female Water","Male Water", "Female Sucrose", "Male Sucrose")
#This is used for the long format data
group2.levels<-c("Female EtOH Before","Female EtOH After", "Male EtOH Before","Male EtOH After","Female Water Before","Female Water After","Male Water Before","Male Water After","Female Sucrose Before","Female Sucrose After","Male Sucrose Before","Male Sucrose After")
sol.levels<-c("Water","Sucrose","EtOH")
pos.levels<-c("Middle","Last 10 min","First 10 min")

remove(meanbeforeafter,peakbeforeafter,pmeanbeforeafter,end.onset)
```


## \*4) Set dropped subjects, bouts, or sessions

For any mice whose data you don't want at this point, put their subject number in the dropped mice vector in quotations. You will have a chance to check and remove outliers later. Then you will manually define mouse-subject pairings by sex. You also here will define what way of coding "session" you want to use.

### a) For CL8

#### i) With Bad Placements Dropped

```{r}
droppedmice<-c("3","4","13") 
droppedbouts<-data.frame("FileName"=c("20220603CL8A18B23Sucrose","20220513CL8A17B21","20220512CL8A18B20"),"Mouse"=c("23","17","18"),"Bout"=c("40","4","18")) 
droppedsessions<-data.frame("FileName"=c(""), "Mouse"=c(""))  
droppedsolutions<-c("")

#Define replicates within sex manually here - exclude dropped animals! 
subject<-data.frame("mouse"=c(1,5,6,14,15,17,18,20,8,9,10,21,22,23),"subject"=c(1,2,3,4,5,6,7,8,1,2,3,4,5,6))  
sub.levels=c(1:13)

#Pick whether you want session to be coded within solution (session.sol), linear (just 1-# of sessions; session.lin), or by experiment (1-40 each cohort; session.exp)
names(bout.analysis)[which(names(bout.analysis)=="session.sol")]<-"session"
```

#### ii) With 17 Also Dropped - Signal Outlier (DIDN'T DO IN FINAL)

```{r}
droppedmice<-c("3","4","13","17")
droppedbouts<-data.frame("FileName"=c(""),"Mouse"=c(""),"Bout"=c(""))
droppedsessions<-data.frame("FileName"=c(""), "Mouse"=c(""))
droppedsolutions<-c("")

#Define replicates within sex manually here - exclude dropped animals!
subject<-data.frame("mouse"=c(1,5,6,14,15,18,20,8,9,10,21,22,23),"subject"=c(1,2,3,4,5,6,7,1,2,3,4,5,6)) 
sub.levels=c(1:13)

#Pick whether you want session to be coded within solution (session.sol), linear (just 1-# of sessions; session.lin), or by experiment (1-40 each cohort; session.exp)
names(bout.analysis)[which(names(bout.analysis)=="session.sol")]<-"session"
```

#### iii) With Bad Placements Dropped, 17 Dropped, and #s 8 & 22

```{r}
droppedmice<-c("3","4","13","17","8","22")
droppedbouts<-data.frame("FileName"=c(""),"Mouse"=c(""),"Bout"=c(""))
droppedsessions<-data.frame("FileName"=c(""), "Mouse"=c(""))
droppedsolutions<-c("")

#Define replicates within sex manually here - exclude dropped animals!
subject<-data.frame("mouse"=c(1,5,6,14,15,18,20,9,10,21,23),"subject"=c(1,2,3,4,5,6,7,1,2,3,4)) 
sub.levels=c(1:11)

#Pick whether you want session to be coded within solution (session.sol), linear (just 1-# of sessions; session.lin), or by experiment (1-40 each cohort; session.exp)
names(bout.analysis)[which(names(bout.analysis)=="session.sol")]<-"session"
```


## \*5) Semi-Finalize - Remove dropped data, set factors, sort, and put in semi-final formats (long, wide)

```{r}
bout.analysis2<-filter(bout.analysis, !Mouse %in% droppedmice)
for (j in 1:nrow(droppedbouts)){
bout.analysis2<-filter(bout.analysis2, !(FileName==droppedbouts$FileName[[j]] & Mouse==droppedbouts$Mouse[[j]] & Bout==droppedbouts$Bout[[j]]))
}
for (k in 1:nrow(droppedsessions)){
bout.analysis2<-filter(bout.analysis2, !(FileName==droppedsessions$FileName[[k]] & Mouse==droppedsessions$Mouse[[k]]))
}

bout.analysis2<-filter(bout.analysis2, !Solution %in% droppedsolutions, preserve=TRUE)


#Codes the subjects as replicate within sex  
setDT(bout.analysis2)[,subject:=rep(NA,length(row.names(bout.analysis2)))] 
for (i in 1:length(rownames(bout.analysis2))){     
      bout.analysis2$subject[[i]]<-subject$subject[[which(subject$mouse==bout.analysis2$Mouse[[i]])]]
}
bout.analysis2$subject<-factor(bout.analysis2$subject,levels=sub.levels)  

#Create group variable that is a combination of Sex and Solution
group_shrt<-paste(bout.analysis2$Sex,bout.analysis2$Solution,sep=" ") 
bout.analysis2<-cbind(bout.analysis2,group_shrt) 

remove(group_shrt,droppedbouts,droppedsessions,droppedmice,droppedsolutions,subject)
```

## \*6) Set Desired Group Color Palette & Text Size for Graphs

### a) For CL8

```{r}
c1<-"#D41159" #This is rgb(212,17,89, maxColorValue=255) or red for EtOH
c2<-"#1A85FF" #This is rgb(26,133,255, maxColorValue=255) or blue for Water
c3<-"#5225A0" #This is rgb(82,37,160, maxColorValue=255) or purple for Sucrose

custom<-c(c1,c2,c3) #Define custom color palette

#Set specifc relationships between titles, axis text, and other text categories so allow consistency between figures of the same size.

title.sz<-6.5*.pt
title.sz2<-8*.pt
txt.sz1<-5*.pt
txt.sz2<-5.5*.pt
txt.sz3<-7*.pt
otr.sz<-2.5*.pt
otr.sz1<-3.5*.pt
otr.sz2<-4.5*.pt
```


# TRUEBOUT DEG ANALYSIS & FILTERING

## 1) (Recommended) TrueBout Analysis - Graphs

If you used the TrueBout Deepethogram model to assign a percent consumption to each bout, we will need to explore what the appropriate threshold is to be able to separate real bouts from non-bouts. The easiest way to do this is to make some exploratory graphs.

### a) Stacked Histogram of % Consumatory by Solution

```{r}
q<-ggplot(data=data.analysis)+   
  geom_histogram(aes(x=x_OfC,color=Solution), size=1, binwidth=0.1)+  
  scale_x_continuous(n.breaks=10, expand = expansion(0.0))+
  scale_y_continuous(n.breaks=10, expand = expansion(0.0))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="% Consumatory Frames", y="Number") 
q
```

### b) Histogram of % Consumatory by Solution Separately as Percent Occurrence

```{r}
q<-ggplot(data=bout.analysis2, aes(x=(x_OfC*100),color=Solution,show.legend=FALSE))+facet_wrap(~Solution,drop = T)+theme_classic()+geom_vline(xintercept=50,linetype=2)+geom_bar(aes(y=(after_stat(count))/tapply(after_stat(count),..PANEL..,sum)[..PANEL..]),linewidth=3)+scale_color_manual(values=custom)+scale_x_continuous(n.breaks=6, expand = expansion(0.1))+scale_y_continuous(n.breaks=10, expand = expansion(c(0,0.05)))+theme(axis.title=element_text(size=16, face="bold"),axis.text=element_text(size=13),panel.grid.major = element_blank(),strip.text.x = element_text(face="bold",size=14),panel.grid.minor = element_blank())+labs(x="% Consumatory Frames", y="Data Proportion")+guides(color=FALSE)
q

#550 x 400

r<-ggplot(data=bout.analysis2, aes(x=(x_OfC*100),color=Solution))+facet_grid(Sex~Solution,drop = T)+theme_classic()+geom_vline(xintercept=50,linetype=2)+geom_bar(aes(y=(after_stat(count))/tapply(after_stat(count),..PANEL..,sum)[..PANEL..]),linewidth=3)+scale_color_manual(values=custom)+  scale_x_continuous(n.breaks=6, expand = expansion(0.1))+scale_y_continuous(n.breaks=10, expand = expansion(c(0,0.05)))+theme(axis.title=element_text(size=16, face="bold"),axis.text=element_text(size=13),panel.grid.major = element_blank(),strip.text.x = element_text(face="bold",size=14),strip.text.y = element_text(size=14,face="bold"),panel.grid.minor = element_blank())+labs(x="% Consumatory Frames", y="Data Proportion")+guides(color=FALSE)
r

#550 x 400
```

### c) Scatter plot of % Consumatory vs Bout Duration

```{r}
q<-ggplot(data=data.analysis,aes(x=BoutDuration,y=x_OfC))+
  geom_point(aes(color=Solution), size=2)+
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="Bout Duration (s)", y="% Consumatory Frames")
q
```

### d) Scatter plot of % Consumatory vs Number of Licks

```{r}
q<-ggplot(data=data.analysis,aes(x=LicksPerBout,y=x_OfC))+   
  geom_point(aes(color=Solution), size=2)+   
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  scale_x_continuous(n.breaks=10, expand = expansion(0.00))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+   
  labs(x="Number of Licks", y="% Consumatory Frames") 
q
```

### e) Scatter plot of % Consumatory vs Lick Rate

```{r}
q<-ggplot(data=data.analysis,aes(x=LickFrequency,y=x_OfC))+      
  geom_point(aes(color=Solution), size=2)+      
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+   
  scale_x_continuous(n.breaks=10, expand = expansion(0.00))+   
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+      
  labs(x="Lick Frequency", y="% Consumatory Frames")  
q
```

### f) Scatter plot of % Consumatory vs BoutStarts

```{r}
q<-ggplot(data=data.analysis,aes(x=BoutStarts,y=x_OfC))+         
  geom_point(aes(color=Solution), size=2)+         
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  scale_x_continuous(n.breaks=10, expand = expansion(0.00))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major =element_blank(),panel.grid.minor = element_blank())+
  labs(x="Bout Start (s)", y="% Consumatory Frames")
  #facet_grid(~Mouse)
q
```

### g) Scatter plot of % Consumatory vs Mouse

```{r}
q<-ggplot(data=data.analysis,aes(x=Mouse,y=x_OfC))+            
  geom_point(aes(color=Solution), size=2,position = "jitter")+            
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  scale_x_discrete(expand = expansion(0.05))+         
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+            
  labs(x="Mouse", y="% Consumatory Frames")+
  facet_wrap(~Sex,scales="free_x")
  #facet_wrap(Solution~Sex,scales="free_x")
 q
```

### h) Scatter plot of % Consumatory vs Session

```{r}
q<-ggplot(data=data.analysis,aes(x=session,y=x_OfC))+
  geom_point(aes(color=Solution), size=1,position = "jitter")+
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  scale_x_continuous(n.breaks=25,expand = expansion(0.05))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="Session", y="% Consumatory Frames")+
  facet_wrap(~Sex+Channel) 
q
```

## 2) (Optional) True Bout Analysis - QC

To check subsets of the data for quality control of DEG model, use code below.

### a) All 0 percent consumatory "bouts"

```{r}
data.analysis_zero<- data.analysis %>% 
  filter(between(x_OfC,0.0,0.0),preserve=TRUE)
```

### b) All 30-50% consumatory "bouts"

```{r}
data.analysis_grey<-data.analysis %>% 
  filter(between(x_OfC,0.3,0.5),preserve=TRUE)
```

### c) All 75-80% consumatory "bouts"

```{r}
data.analysis_highgrey<-data.analysis %>% 
  filter(between(x_OfC,0.75,0.8),preserve=TRUE)
```

## \*3) Apply True Bout Cut-off to Get Final Data Set

Once you decide what the appropriate threshold of a "true bout" is from exploring the data, set the threshold here and filter out presumptive "not bouts".

```{r}
bout.analysis2_true <- bout.analysis2 %>% 
  filter(between(x_OfC,0.5,1.0),preserve=TRUE)
bout.analysis2_false <- bout.analysis2 %>%
  filter(between(x_OfC,0,0.4999),preserve=TRUE)
```

# DATA FINALIZATION

## \*1) Standardize (Scale & Center) and Set Contrasts

Standardize calcium signal (two methods). Make standardized and centered bout-level variables. Set categorical variable contrasts. Session-level variables (e.g. drinking) will be made during session level analysis. Sort and divide into long/wide formats.
#### a) CL8

```{r}
#Make variables for Standardizations and Centering

#z1 = Signal Standardized Using Robust Z-score (Used initially but decided for diff strategy later). 
bout.analysis2_true<-bout.analysis2_true %>%
  mutate(z1MeanBefore=as.vector(0.6745*(bout.analysis2_true$MeanBefore-bout.analysis2_true$SigMedian)/bout.analysis2_true$SigMAD)) %>%
  mutate(z1MeanAfter=as.vector(0.6745*(bout.analysis2_true$MeanAfter-bout.analysis2_true$SigMedian)/bout.analysis2_true$SigMAD))

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(z1RAMP60to50sec=as.vector(0.6745*(bout.analysis2_true$RAMP60to50-bout.analysis2_true$SigMedian)/bout.analysis2_true$SigMAD)) %>%
  mutate(z1RAMP50to40sec=as.vector(0.6745*(bout.analysis2_true$RAMP50to40sec-bout.analysis2_true$SigMedian)/bout.analysis2_true$SigMAD))%>%
  mutate(z1RAMP40to30sec=as.vector(0.6745*(bout.analysis2_true$RAMP40to30-bout.analysis2_true$SigMedian)/bout.analysis2_true$SigMAD)) %>%
  mutate(z1RAMP30to20sec=as.vector(0.6745*(bout.analysis2_true$RAMP30to20sec-bout.analysis2_true$SigMedian)/bout.analysis2_true$SigMAD))%>%
  mutate(z1RAMP20to10sec=as.vector(0.6745*(bout.analysis2_true$RAMP20to10sec-bout.analysis2_true$SigMedian)/bout.analysis2_true$SigMAD))%>%
  mutate(z1RAMP10to0sec=as.vector(0.6745*(bout.analysis2_true$RAMP10to0sec-bout.analysis2_true$SigMedian)/bout.analysis2_true$SigMAD))

z1meanbeforeafter<-bout.analysis2_true$z1MeanAfter-bout.analysis2_true$z1MeanBefore
bout.analysis2_true<-cbind(bout.analysis2_true,z1meanbeforeafter)
                     


#z2 = Mouse-Level standard z-score to match what was done with the bout characteristics (USE THIS)

#First, get mouse level mean Before & After means

temp<-bout.analysis2_true %>% 	#Lumps together MeanBefore and MeanAfter before computing the mean and standard deviation
  gather(key="time", value="signal", MeanBefore, MeanAfter)

SignalMeans<- temp %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('signal'), type = "mean_sd")

setDT(bout.analysis2_true)[,MSig_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$MSig_m[[i]]<-SignalMeans$mean[[which(SignalMeans$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,MSig_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$MSig_sd[[i]]<-SignalMeans$sd[[which(SignalMeans$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(z2MeanBefore=as.vector((bout.analysis2_true$MeanBefore-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
  mutate(z2MeanAfter=as.vector((bout.analysis2_true$MeanAfter-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd))

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(z2RAMP60to50sec=as.vector((bout.analysis2_true$RAMP60to50-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
  mutate(z2RAMP50to40sec=as.vector((bout.analysis2_true$RAMP50to40-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
 mutate(z2RAMP40to30sec=as.vector((bout.analysis2_true$RAMP40to30-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
  mutate(z2RAMP30to20sec=as.vector((bout.analysis2_true$RAMP30to20-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
  mutate(z2RAMP20to10sec=as.vector((bout.analysis2_true$RAMP20to10-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
 mutate(z2RAMP10to0sec=as.vector((bout.analysis2_true$RAMP10to0-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) 

z2meanbeforeafter<-bout.analysis2_true$z2MeanAfter-bout.analysis2_true$z2MeanBefore
bout.analysis2_true<-cbind(bout.analysis2_true,z2meanbeforeafter)

#Export a key of this standardization to use in the 30sec graph data.
zkey<-subset(bout.analysis2_true,select=c("FileName","Channel","Bout","MSig_m","MSig_sd"))


#write.xlsx(zkey,file=file2,sheetName = "Zscore",append=TRUE)


#Next, get mouse level mean AUC & rise/fall time means (lumping before & after before averaging)

temp<-bout.analysis2_true %>% 	#Lumps together AUC15Before and MeanAfter before computing the mean and standard deviation
  gather(key="time", value="signalAUC", AUC15Before, AUC15After)

SignalAUCMeans<- temp %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('signalAUC'), type = "mean_sd")

setDT(bout.analysis2_true)[,MSigAUC_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$MSigAUC_m[[i]]<-SignalAUCMeans$mean[[which(SignalAUCMeans$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,MSigAUC_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$MSigAUC_sd[[i]]<-SignalAUCMeans$sd[[which(SignalAUCMeans$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(z2AUC15Before=as.vector((bout.analysis2_true$AUC15Before-bout.analysis2_true$MSigAUC_m)/bout.analysis2_true$MSigAUC_sd)) %>%
  mutate(z2AUC15After=as.vector((bout.analysis2_true$AUC15After-bout.analysis2_true$MSigAUC_m)/bout.analysis2_true$MSigAUC_sd))


temp<-bout.analysis2_true %>% 	#Lumps together TIMEDIFF15 and MeanAfter before computing the mean and standard deviation
  gather(key="time", value="signalTIMEDIFF", TIMEDIFFBefore, TIMEDIFFAfter)

SignalTIMEDIFFMeans<- temp %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('signalTIMEDIFF'), type = "mean_sd")

setDT(bout.analysis2_true)[,MSigTD_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$MSigTD_m[[i]]<-SignalTIMEDIFFMeans$mean[[which(SignalTIMEDIFFMeans$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,MSigTD_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$MSigTD_sd[[i]]<-SignalTIMEDIFFMeans$sd[[which(SignalTIMEDIFFMeans$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(z2TIMEDIFFBefore=as.vector((bout.analysis2_true$TIMEDIFFBefore-bout.analysis2_true$MSigTD_m)/bout.analysis2_true$MSigTD_sd)) %>%
  mutate(z2TIMEDIFFAfter=as.vector((bout.analysis2_true$TIMEDIFFAfter-bout.analysis2_true$MSigTD_m)/bout.analysis2_true$MSigTD_sd))


#Many of the measures are on vastly different scales. Thus we z-score them here to allow them to be used as predictors using the standard z-scoring method: x-mean/sd. Further, to probe within and between effects on variables, we create individual mean centered (imc) and one of the following: grand mean centered (gmc), sex mean centered (smc), or group mean centered (grpmc) transformation of key variables. The imc uses the mean and sd of each Mouse's data. The gmc uses the mean and sd of all mouse MEANS. The smc uses the mean and sd of each sex independently. The grpmc uses the mean and sd of each group independently. Each of these asks a slightly different question so know what each is asking! Standardizing both scales and centers the variables.

             
##Bout Duration Standardized Variables
Duration_means<- bout.analysis2_true %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('BoutDuration'), type = "mean_sd")
Duration_means<-Duration_means %>%
  mutate("gmc"=as.vector(scale(mean)))

setDT(bout.analysis2_true)[,Duration_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_m[[i]]<-Duration_means$mean[[which(Duration_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,Duration_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_sd[[i]]<-Duration_means$sd[[which(Duration_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Duration_imc=as.vector((bout.analysis2_true$BoutDuration-bout.analysis2_true$Duration_m)/bout.analysis2_true$Duration_sd))


setDT(bout.analysis2_true)[,Duration_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_gmc[[i]]<-Duration_means$gmc[[which(Duration_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##Bout Duration Standardized Variables - means by SEX!
Duration_means_sex<- bout.analysis2_true %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('BoutDuration'), type = "mean_sd")

Duration_means_sex<- Duration_means_sex %>% 
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Duration_means_sex<- Duration_means_sex %>% 
  mutate(variable="BoutDuration")

setDT(bout.analysis2_true)[,Duration_sm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_sm[[i]]<-Duration_means_sex$mean[[which(Duration_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

setDT(bout.analysis2_true)[,Duration_ssd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_ssd[[i]]<-Duration_means_sex$sd[[which(Duration_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Duration_smc=as.vector((bout.analysis2_true$Duration_m-bout.analysis2_true$Duration_sm)/bout.analysis2_true$Duration_ssd))

# Bout Duration Within-Solution Individually Standardized 
Duration.sol_means<- bout.analysis2_true %>% 
  group_by(Mouse,Solution) %>%
  get_summary_stats(c('BoutDuration'), type = "mean_sd")
Duration.sol_means<-Duration.sol_means %>%
  group_by(Solution)%>%
  mutate("gmc"=as.vector(scale(mean))) %>%
  ungroup()
Duration.sol_means2<-Duration.sol_means %>%
  group_by(Solution) %>%
  get_summary_stats(c('mean'), type= "mean_sd")
Duration.sol_means2<-Duration.sol_means2 %>%
  mutate(variable="BoutDuration")

setDT(bout.analysis2_true)[,Duration_solm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_solm[[i]]<-Duration.sol_means$mean[[which(Duration.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Duration.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] )]]
}

setDT(bout.analysis2_true)[,Duration_solsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_solsd[[i]]<-Duration.sol_means$sd[[which(Duration.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Duration.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Duration_sol_imc=as.vector((bout.analysis2_true$BoutDuration-bout.analysis2_true$Duration_solm)/bout.analysis2_true$Duration_solsd))

setDT(bout.analysis2_true)[,Duration_sol_gmc:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_sol_gmc[[i]]<-Duration.sol_means$gmc[[which(Duration.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Duration.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##Bout Duration Standardized Variables - means by group!
Duration_means_grp<- bout.analysis2_true %>% 
  group_by(Mouse,group_shrt) %>%
  get_summary_stats(c('BoutDuration'), type = "mean_sd")
Duration_means_grp<- Duration_means_grp %>% 
  group_by(group_shrt) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Duration_means_grp<- Duration_means_grp %>% 
  mutate(variable="BoutDuration")

setDT(bout.analysis2_true)[,Duration_grpm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_grpm[[i]]<-Duration_means_grp$mean[[which(Duration_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

setDT(bout.analysis2_true)[,Duration_grpsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_grpsd[[i]]<-Duration_means_grp$sd[[which(Duration_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Duration_grpmc=as.vector((bout.analysis2_true$Duration_solm-bout.analysis2_true$Duration_grpm)/bout.analysis2_true$Duration_grpsd))


##Bout Starts Standardized Variables: Not scaled! Since we want to treat it as time within session, not any form of "individual time". Also, since there are so many possible time points, I decided to bin the variable into 10-min segments and to code the now categorical variable into first 10 min vs the rest of the session to probe the question - are the first 10 min unique? **Note that there are likely slight variations in each session's start and end times so binning is a better strategy anyway. 

#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds) or <=740. Then the last 10 min is anything greater than or equal to 7889 (maximum start) minus 600 or >=7289.The remaining time is coded as a single category. 

BoutStarts_means<- bout.analysis2_true %>% 
  group_by(Sex,Mouse,Solution,session) %>%
  get_summary_stats(c('BoutStarts'), type =c("five_number"),show=c("n","min","max"))



##LicksPerBout Standardized Variables
LicksPerBout_means<- bout.analysis2_true %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('LicksPerBout'), type = "mean_sd")
LicksPerBout_means<-LicksPerBout_means %>%
  mutate("gmc"=as.vector(scale(mean)))

setDT(bout.analysis2_true)[,LicksPerBout_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_m[[i]]<-LicksPerBout_means$mean[[which(LicksPerBout_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,LicksPerBout_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_sd[[i]]<-LicksPerBout_means$sd[[which(LicksPerBout_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LicksPerBout_imc=as.vector((bout.analysis2_true$LicksPerBout-bout.analysis2_true$LicksPerBout_m)/bout.analysis2_true$LicksPerBout_sd))


setDT(bout.analysis2_true)[,LicksPerBout_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_gmc[[i]]<-LicksPerBout_means$gmc[[which(LicksPerBout_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##LicksPerBout Standardized Variables - means by SEX!
LicksPerBout_means_sex<- bout.analysis2_true %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('LicksPerBout'), type = "mean_sd")

LicksPerBout_means_sex<- LicksPerBout_means_sex %>% 
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
LicksPerBout_means_sex<- LicksPerBout_means_sex %>% 
  mutate(variable="LicksPerBout")

setDT(bout.analysis2_true)[,LicksPerBout_sm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_sm[[i]]<-LicksPerBout_means_sex$mean[[which(LicksPerBout_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

setDT(bout.analysis2_true)[,LicksPerBout_ssd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_ssd[[i]]<-LicksPerBout_means_sex$sd[[which(LicksPerBout_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LicksPerBout_smc=as.vector((bout.analysis2_true$LicksPerBout_m-bout.analysis2_true$LicksPerBout_sm)/bout.analysis2_true$LicksPerBout_ssd))

# Bout Lick Within-Solution Individually Standardized 
Lick.sol_means<- bout.analysis2_true %>% 
  group_by(Mouse,Solution) %>%
  get_summary_stats(c('LicksPerBout'), type = "mean_sd")
Lick.sol_means<-Lick.sol_means %>%
  group_by(Solution)%>%
  mutate("gmc"=as.vector(scale(mean))) %>%
  ungroup()
Lick.sol_means2<-Lick.sol_means %>%
  group_by(Solution) %>%
  get_summary_stats(c('mean'), type= "mean_sd")
Lick.sol_means2<-Lick.sol_means2 %>%
  mutate(variable="LicksPerBout")
  
setDT(bout.analysis2_true)[,LicksPerBout_solm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_solm[[i]]<-Lick.sol_means$mean[[which(Lick.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Lick.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] )]]
}

setDT(bout.analysis2_true)[,LicksPerBout_solsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_solsd[[i]]<-Lick.sol_means$sd[[which(Lick.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Lick.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LicksPerBout_sol_imc=as.vector((bout.analysis2_true$LicksPerBout-bout.analysis2_true$LicksPerBout_solm)/bout.analysis2_true$LicksPerBout_solsd))

setDT(bout.analysis2_true)[,LicksPerBout_sol_gmc:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_sol_gmc[[i]]<-Lick.sol_means$gmc[[which(Lick.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Lick.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##LicksPerBout Standardized Variables - means by group!
Lick_means_grp<- bout.analysis2_true %>% 
  group_by(Mouse,group_shrt) %>%
  get_summary_stats(c('LicksPerBout'), type = "mean_sd")
Lick_means_grp<- Lick_means_grp %>% 
  group_by(group_shrt) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Lick_means_grp<- Lick_means_grp %>% 
  mutate(variable="LicksPerBout")

setDT(bout.analysis2_true)[,LicksPerBout_grpm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_grpm[[i]]<-Lick_means_grp$mean[[which(Lick_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

setDT(bout.analysis2_true)[,LicksPerBout_grpsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_grpsd[[i]]<-Lick_means_grp$sd[[which(Lick_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LicksPerBout_grpmc=as.vector((bout.analysis2_true$LicksPerBout_solm-bout.analysis2_true$LicksPerBout_grpm)/bout.analysis2_true$LicksPerBout_grpsd))





##Lick Frequency Standardized Variables
LickFrequency_means<- bout.analysis2_true %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('LickFrequency'), type = "mean_sd")
LickFrequency_means<-LickFrequency_means %>%
  mutate("gmc"=as.vector(scale(mean)))

setDT(bout.analysis2_true)[,LickFrequency_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_m[[i]]<-LickFrequency_means$mean[[which(LickFrequency_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,LickFrequency_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_sd[[i]]<-LickFrequency_means$sd[[which(LickFrequency_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LickFrequency_imc=as.vector((bout.analysis2_true$LickFrequency-bout.analysis2_true$LickFrequency_m)/bout.analysis2_true$LickFrequency_sd))


setDT(bout.analysis2_true)[,LickFrequency_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_gmc[[i]]<-LickFrequency_means$gmc[[which(LickFrequency_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##Lick Frequency Standardized Variables - means by SEX!
LickFrequency_means_sex<- bout.analysis2_true %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('LickFrequency'), type = "mean_sd")

LickFrequency_means_sex<- LickFrequency_means_sex %>% 
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")

LickFrequency_means_sex<- LickFrequency_means_sex %>% 
  mutate(variable="LickFrequency")

setDT(bout.analysis2_true)[,LickFrequency_sm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_sm[[i]]<-LickFrequency_means_sex$mean[[which(LickFrequency_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

setDT(bout.analysis2_true)[,LickFrequency_ssd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_ssd[[i]]<-LickFrequency_means_sex$sd[[which(LickFrequency_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LickFrequency_smc=as.vector((bout.analysis2_true$LickFrequency_m-bout.analysis2_true$LickFrequency_sm)/bout.analysis2_true$LickFrequency_ssd))

# Lick Frequency Within-Solution Individually Standardized 
LickFrequency.sol_means<- bout.analysis2_true %>% 
  group_by(Mouse,Solution) %>%
  get_summary_stats(c('LickFrequency'), type = "mean_sd")
LickFrequency.sol_means<-LickFrequency.sol_means %>%
  group_by(Solution)%>%
  mutate("gmc"=as.vector(scale(mean))) %>%
  ungroup()
LickFrequency.sol_means2<-LickFrequency.sol_means %>%
  group_by(Solution) %>%
  get_summary_stats(c('mean'), type= "mean_sd")
LickFrequency.sol_means2<-LickFrequency.sol_means2 %>%
  mutate(variable="LickFrequency")
  
setDT(bout.analysis2_true)[,LickFrequency_solm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_solm[[i]]<-LickFrequency.sol_means$mean[[which(LickFrequency.sol_means$Solution==bout.analysis2_true$Solution[[i]] & LickFrequency.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] )]]
}

setDT(bout.analysis2_true)[,LickFrequency_solsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_solsd[[i]]<-LickFrequency.sol_means$sd[[which(LickFrequency.sol_means$Solution==bout.analysis2_true$Solution[[i]] & LickFrequency.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LickFrequency_sol_imc=as.vector((bout.analysis2_true$LickFrequency-bout.analysis2_true$LickFrequency_solm)/bout.analysis2_true$LickFrequency_solsd))

setDT(bout.analysis2_true)[,LickFrequency_sol_gmc:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_sol_gmc[[i]]<-LickFrequency.sol_means$gmc[[which(LickFrequency.sol_means$Solution==bout.analysis2_true$Solution[[i]] & LickFrequency.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##LicksPerBout Standardized Variables - means by group!
LickFrequency_means_grp<- bout.analysis2_true %>% 
  group_by(Mouse,group_shrt) %>%
  get_summary_stats(c('LickFrequency'), type = "mean_sd")
LickFrequency_means_grp<- LickFrequency_means_grp %>% 
  group_by(group_shrt) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
LickFrequency_means_grp<- LickFrequency_means_grp %>% 
  mutate(variable="LickFrequency")

setDT(bout.analysis2_true)[,LickFrequency_grpm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_grpm[[i]]<-LickFrequency_means_grp$mean[[which(LickFrequency_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

setDT(bout.analysis2_true)[,LickFrequency_grpsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_grpsd[[i]]<-LickFrequency_means_grp$sd[[which(LickFrequency_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LickFrequency_grpmc=as.vector((bout.analysis2_true$LickFrequency_solm-bout.analysis2_true$LickFrequency_grpm)/bout.analysis2_true$LickFrequency_grpsd))


## Sort columns into desired order (feel free to customize). This will also be used to refer to all your variables later on so DO NOT LEAVE ANY OUT. 


myorder<-c("Output.Order","FileName","Channel","Mouse","Sex","subject","Solution","group_shrt","session","x_OfC","Bout","Position","BoutStarts","BoutDuration","Duration_m","Duration_sd","Duration_imc","Duration_gmc","Duration_sm","Duration_ssd","Duration_smc","Duration_solm","Duration_solsd","Duration_sol_imc","Duration_sol_gmc","Duration_grpm","Duration_grpsd","Duration_grpmc","LicksPerBout","LicksPerBout_m","LicksPerBout_sd","LicksPerBout_imc","LicksPerBout_gmc","LicksPerBout_sm","LicksPerBout_ssd","LicksPerBout_smc","LicksPerBout_solm","LicksPerBout_solsd","LicksPerBout_sol_imc","LicksPerBout_sol_gmc","LicksPerBout_grpm","LicksPerBout_grpsd","LicksPerBout_grpmc","LickFrequency","LickFrequency_m","LickFrequency_sd","LickFrequency_imc","LickFrequency_gmc","LickFrequency_sm","LickFrequency_ssd","LickFrequency_smc","LickFrequency_solm","LickFrequency_solsd","LickFrequency_sol_imc","LickFrequency_sol_gmc","LickFrequency_grpm","LickFrequency_grpsd","LickFrequency_grpmc","SigMean","SigMedian","SigMAD","SigStdev","MSig_m","MSig_sd","MeanBefore","z1MeanBefore","z2MeanBefore","MeanDuring","MeanAfter","z1MeanAfter","z2MeanAfter","meanbeforeafter","z1meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","PeakBefore","PeakDuring","PeakAfter","peakbeforeafter","MinBefore","MinDuring","MinAfter","Onset","End","end.onset","SlopePolyfit","SlopeTwoPoint","RAMP60to50sec","RAMP50to40sec","RAMP40to30sec","RAMP30to20sec","RAMP20to10sec","RAMP10to0sec","z1RAMP60to50sec","z1RAMP50to40sec","z1RAMP40to30sec","z1RAMP30to20sec","z1RAMP20to10sec","z1RAMP10to0sec","z2RAMP60to50sec","z2RAMP50to40sec","z2RAMP40to30sec","z2RAMP30to20sec","z2RAMP20to10sec","z2RAMP10to0sec","AUC15Before","AUC15After","MSigAUC_m","MSigAUC_sd","z2AUC15Before","z2AUC15After","TIMEDIFFBefore","TIMEDIFFAfter","MSigTD_m","MSigTD_sd","z2TIMEDIFFBefore","z2TIMEDIFFAfter")


#Define variables that are key descriptors of the data (e.g. Filename, Channel, Mouse, Sex, subject...)
corevars<-c("Output.Order","FileName","Channel","Mouse","Sex","subject","Solution","group_shrt","session","x_OfC","Position")

bout.analysis2_true<-bout.analysis2_true[,..myorder]

#Make sure everything is set as factors with appropriate levels
bout.analysis2_true$Mouse<-factor(bout.analysis2_true$Mouse)
bout.analysis2_true$Solution<-factor(bout.analysis2_true$Solution,levels=sol.levels) 
bout.analysis2_true$Sex<-factor(bout.analysis2_true$Sex,levels=c("Female","Male"))
bout.analysis2_true$Position<-factor(bout.analysis2_true$Position,levels=pos.levels)

############### CONTRAST ASSIGNMENT ########################
#Assigned contrasts use the factor levels previously made. 
#Check contrasts and change if desired:
#contrasts(bout.analysis2_true$Sex)
#contrasts(bout.analysis2_true$Solution)
#NOTE: CL made a Word document summarizing all the pre-made and custom contrasts and how to use them in R. 

##Declare this line of options to make comparable to SAS
#options(contrasts = c(faccontrtor = "contr.SAS", ordered = "contr.poly")) #Contrasts (decided to use centered contrasts after reading Yaremych et al 2023) *Time is set as a contrast after data is separated below.

### IMPORTANT ###
#Here you will set the contrast scheme to be used for factors of different levels. You can use different contrasts depending on your hypotheses, but most options produce the same comparisons for a two-level factor. Things only get weird when it is a 3+ level factor. And do yourself a MASSIVE favor and use the colnames arguments to relabel the contrasts so you can determine what contrast you used. H = Helmert; S = Sum, E = Effect, T= Treatment. 

contrasts(bout.analysis2_true$Sex) <- contr.Helmert(levels(bout.analysis2_true$Sex))
colnames(contrasts(bout.analysis2_true$Sex))<-c("[H.Male-Female]")

contrasts(bout.analysis2_true$Solution) <- contr.Helmert(levels(bout.analysis2_true$Solution))
colnames(contrasts(bout.analysis2_true$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")

contrasts(bout.analysis2_true$Position) <- contr.Helmert(levels(bout.analysis2_true$Position))
colnames(contrasts(bout.analysis2_true$Position))<-c("[H.Last10-Middle]","[H.First10-avg(Last10,Middle)]")

#Make a copy of bout.analysis in its current wide format (needed for some analyses)
data.analysis_true<-bout.analysis2_true 

#Guess what? All your contrasts and levels reset. So we gotta do it again. MAKE SURE THIS IS IDENTICAL TO WHAT WAS DONE ABOVE TO Bout.Analysis2_true!!! There's probably a better way to do this but shrug.
data.analysis_true$Solution<-factor(data.analysis_true$Solution,levels=sol.levels)  
data.analysis_true$group_shrt<-factor(data.analysis_true$group_shrt,levels=group1.levels)   
data.analysis_true$Mouse<-factor(data.analysis_true$Mouse)
data.analysis_true$Sex<-factor(data.analysis_true$Sex,levels=c("Female","Male"))
data.analysis_true$Position<-factor(data.analysis_true$Position,levels=pos.levels)

contrasts(data.analysis_true$Sex) <- contr.Helmert(levels(data.analysis_true$Sex))
colnames(contrasts(data.analysis_true$Sex))<-c("[H.Male-Female]")

contrasts(data.analysis_true$Solution) <- contr.Helmert(levels(data.analysis_true$Solution))
colnames(contrasts(data.analysis_true$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")

contrasts(data.analysis_true$Position) <- contr.Helmert(levels(data.analysis_true$Position))
colnames(contrasts(data.analysis_true$Position))<-c("[H.Last10-Middle]","[H.First10-avg(Last10,Middle)]")


data.analysis_false<-bout.analysis2_false
data.analysis_false$Solution<-factor(data.analysis_false$Solution,levels=sol.levels)  
data.analysis_false$group_shrt<-factor(data.analysis_false$group_shrt,levels=group1.levels)   
data.analysis_false$Mouse<-factor(data.analysis_false$Mouse)
data.analysis_false$Sex<-factor(data.analysis_false$Sex,levels=c("Female","Male"))
data.analysis_false$Position<-factor(data.analysis_false$Position,levels=pos.levels)

contrasts(data.analysis_false$Sex) <- contr.Helmert(levels(data.analysis_false$Sex))
colnames(contrasts(data.analysis_false$Sex))<-c("[H.Male-Female]")

contrasts(data.analysis_false$Solution) <- contr.Helmert(levels(data.analysis_false$Solution))
colnames(contrasts(data.analysis_false$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")

contrasts(data.analysis_false$Position) <- contr.Helmert(levels(data.analysis_false$Position))
colnames(contrasts(data.analysis_false$Position))<-c("[H.Last10-Middle]","[H.First10-avg(Last10,Middle)]")


##Morph bout.analysis into long format for time variables
timecols = str_extract(names(bout.analysis2_true),"(.*)(.After|Before)")
timecols = timecols[!is.na(timecols)]
bout.analysis2_true<-bout.analysis2_true %>% 	
  pivot_longer(cols = all_of(timecols), names_to = c(".value","time"), names_pattern = "(.*)(After|Before)", values_to = test)

# Set time as a factor with levels 
bout.analysis2_true$time<-factor(bout.analysis2_true$time,levels=c("Before","After")) 

#Set long-format groups
setDT(bout.analysis2_true)[,group:=paste(bout.analysis2_true$Sex,bout.analysis2_true$Solution,bout.analysis2_true$time)]

bout.analysis2_true$group<-factor(bout.analysis2_true$group,levels=group2.levels)


#Now set contrasts for time
#Check contrasts and change if desired:
#contrasts(bout.analysis2_true$time)
#contrasts(bout.analysis2_truez1$time)
#contrasts(bout.analysis2_true$time)

contrasts(bout.analysis2_true$time) <- contr.Helmert(levels(bout.analysis2_true$time))
colnames(contrasts(bout.analysis2_true$time))<-c("[H.After-Before]")

## Only once - compile these standardization means/sd and export to Excel
# std.params1<-merge(SignalMeans,Duration_means,by=c("Mouse"),suffixes=c(".1",".2"))
# std.params1<-merge(std.params1,LicksPerBout_means,by=c("Mouse"),suffixes=c(".2",".3"))
# std.params1<-merge(std.params1,LickFrequency_means,by=c("Mouse"),suffixes=c(".3",".4"))
# std.params2<-BoutStarts_means
#  
# std.params3<-merge(Duration_means_sex,LicksPerBout_means_sex,by=c("Sex"),suffixes=c(".1",".2"))
# std.params3<-merge(std.params3,LickFrequency_means_sex,by=c("Sex"),suffixes=c(".2",".3"))
#  
# std.params4<-merge(Duration_means_grp,Lick_means_grp,by=c("group_shrt"),suffixes=c(".1",".2"))
# std.params4<-merge(std.params4,LickFrequency_means_grp,by=c("group_shrt"),suffixes=c(".2",".3"))
# std.params5<-merge(Duration.sol_means,Lick.sol_means,by=c("Solution","Mouse"),suffixes=c(".1",".2"))
# std.params5<-merge(std.params5,LickFrequency.sol_means, by=c("Solution","Mouse"),suffixes=c(".3",".4"))
# std.params6<-merge(Duration.sol_means2,Lick.sol_means2,by=c("Solution"),suffixes=c(".1",".2"))
# std.params6<-merge(std.params6,LickFrequency.sol_means2,by=c("Solution"),suffixes=c(".3",".4"))
# std.params7<-merge(std.params1,SignalAUCMeans,by=c("Mouse"),suffixes=c(".4",".5"))
# std.params7<-merge(std.params7,SignalTIMEDIFFMeans,by=c("Mouse"),suffixes=c(".5",".6"))
#  
# #Export Standardization Parameters - CL8
# filedesc<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout StandardizationParams.xlsx"
# 
# #filedesc<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout StandardizationParams.xlsx"
# 
# 
# write.xlsx(std.params7,file=filedesc,sheetName = "Most_Variables",append=TRUE)
# write.xlsx(std.params2,file=filedesc,sheetName = "BoutStarts",append=TRUE)
# write.xlsx(std.params3,file=filedesc,sheetName = "Sex_Centered",append=TRUE)
# write.xlsx(std.params4,file=filedesc,sheetName = "Group_Centered",append=TRUE)
# write.xlsx(std.params5,file=filedesc,sheetName = "Sol_Centered",append=TRUE)
# write.xlsx(std.params6,file=filedesc,sheetName = "Sol_Centered_Means",append=TRUE)

# remove(z1meanbeforeafter,z2meanbeforeafter,temp,LickFrequency_means,LickFrequency_means_sex,LickFrequency_means_grp,LicksPerBout_means,LicksPerBout_means_sex,Lick_means_grp,Duration_means,Duration_means_sex,Duration_means_grp,BoutStarts_means,std.params1,std.params2,std.params3,std.params4,std.params5,std.params6,std.params7,Lick.sol_means,Lick.sol_means2,LickFrequency.sol_means,LickFrequency.sol_means2,Duration.sol_means,Duration.sol_means2,SignalTIMEDIFFMeans,SignalAUCMeans,SignalAUCMeans,SignalMeans)

#Without the variables for export
remove(z1meanbeforeafter,z2meanbeforeafter,temp,LickFrequency_means,LickFrequency_means_sex,LickFrequency_means_grp,LicksPerBout_means,LicksPerBout_means_sex,Lick_means_grp,Duration_means,Duration_means_sex,Duration_means_grp,BoutStarts_means,Lick.sol_means,Lick.sol_means2,LickFrequency.sol_means,LickFrequency.sol_means2,Duration.sol_means,Duration.sol_means2,SignalMeans,SignalTIMEDIFFMeans,SignalAUCMeans,SignalAUCMeans)
```


# BOUT LEVEL ANALYSIS

## 1) Assemble & Get Descriptive Statistics

First, let's get descriptive statistics! This is really important to be able to start to understand our data AND verify that the data was read in correctly.

```{r}
subject.analysis<-data.analysis_true %>%
    group_by(Sex,Mouse,subject,Solution,group_shrt) %>%
    get_summary_stats(any_of(myorder))


group.analysis<-data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats()

data.analysis_true_long<-pivot_longer(data.analysis_true,cols= -any_of(corevars),names_to = "variable",values_to="value")

data.analysis_true_long$variable<-factor(data.analysis_true_long$variable)

# Signal Measures
timecols2<- str_extract(timecols,"(.*)(After|Before)",group=1)
indvsignalsummary<-bout.analysis2_true %>%
  group_by(Sex,Solution,Mouse,time) %>%
  get_summary_stats(all_of(timecols2), type = "mean_se")
indvsignalsummary$Mouse<-factor(indvsignalsummary$Mouse)

subsignalsummary<-indvsignalsummary %>%  #Used to find outliers in signal irrespective of group (collapses across time)
    mutate(type = variable) %>%
    group_by(Sex,Mouse,type) %>%
    get_summary_stats('mean', type = "mean_se")

grpsignalsummary<-indvsignalsummary %>%
  mutate(type = variable) %>%
	group_by(Sex,Solution,time,type) %>%
	get_summary_stats('mean', type = "mean_se")

```

## 2) Graph these variables to explore your data

```{r}
#Each beeswarm is a subject's average for all sessions and the group means are the larger symbols. Pick which variable to look at using the "var" variable. 

var<-c("z2MeanBefore","z2MeanAfter")
ggplot(data=subset(subject.analysis,variable==var),aes(x=group_shrt,y=mean), group= factor(group_shrt)) +theme_classic()+geom_beeswarm(cex=0.5,size=2,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=subset(group.analysis,variable==var),aes(x=group_shrt,y=mean,shape=Sex),size=2,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(expand = expansion(0.5))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical", legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=10,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y=var)+guides(color=guide_legend(override.aes = list(size=4)))


#Each beeswarm is a single bout - Bout Characteristics - All Bouts & Group Avgs
var<-c("BoutStarts")
r<-ggplot(data=data.analysis_true,aes(x=group_shrt,y=!!sym(var)), group= factor(group_shrt)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=subset(group.analysis,variable==var),aes(x=group_shrt,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=element_blank(),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y=var)+guides(color=guide_legend(override.aes = list(size=4)))

r

#Investigating outlying signals
ggplot(data=data.analysis_true, group_shrt= factor(group_shrt)) +theme_classic()+facet_wrap(~Solution*Sex)+geom_bar(stat="density",aes(x=z2MeanBefore,color=Solution,fill=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+scale_y_continuous(expand = expansion(0.2))+scale_x_continuous(n.breaks=10)+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="z2 Signal Normality",x="z2 Mean Before", y="Frequency")+guides(color=guide_legend(override.aes = list(size=4))) 

ggplot(data=data.analysis_true, group_shrt= factor(group_shrt)) +theme_classic()+facet_wrap(~Solution*Sex)+geom_bar(stat="density",aes(x=z2MeanAfter,color=Solution,fill=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+scale_y_continuous(expand = expansion(0.2))+scale_x_continuous(n.breaks=10)+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="z2 Signal Normality",x="z2 Mean After", y="Frequency")+guides(color=guide_legend(override.aes = list(size=4))) 


ggplot(data=data.analysis_true, group_shrt= factor(group_shrt)) +theme_classic()+facet_wrap(~Solution*Sex)+geom_bar(stat="density",aes(x=z2AUC15Before,color=Solution,fill=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+scale_y_continuous(expand = expansion(0.2))+scale_x_continuous(n.breaks=10)+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="z2 Signal Normality",x="z2 AUC Before", y="Frequency")+guides(color=guide_legend(override.aes = list(size=4))) 

ggplot(data=data.analysis_true, group_shrt= factor(group_shrt)) +theme_classic()+facet_wrap(~Solution*Sex)+geom_bar(stat="density",aes(x=z2AUC15After,color=Solution,fill=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+scale_y_continuous(expand = expansion(0.2))+scale_x_continuous(n.breaks=10)+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="z2 Signal Normality",x="z2 AUC15 After", y="Frequency")+guides(color=guide_legend(override.aes = list(size=4))) 
```

## 3) Test Assumptions of GLM

Test Assumptions of GLM statistical tests (like ANOVAs) and detect outliers in the signal data or in groups.

### a) Non-standardized signal (DO NOT RUN)

```{r}
##GLOBAL OUTLIERS
#Grubbs method of detecting outliers globally - investigating subject outliers by looking at avg dF/F for all substances before and after within subject
outliersglob1<-grubbs.test(subsignalsummary$mean,type=10,two.sided=TRUE)

#Grubbs method of detecting outliers globally - all bout mean before signals
outliersglob2<-grubbs.test(data.analysis_true$MeanBefore,type=10,two.sided=TRUE)

#Grubbs method of detecting outliers globally - all bout mean after signals
outliersglob3<-grubbs.test(data.analysis_true$MeanAfter,type=10,two.sided=TRUE)

#Outlying points within a subject
outlierssub1<-bout.analysis2_true %>%
  group_by(Mouse)%>%  
  identify_outliers('signal') 


##GROUP OUTLIERS
#Grubbs method of detecting outliers with groupings - subsetted by Sex, MeanBefore
outliers1<-data.analysis_true %>%
  group_by(Sex)%>%  
  identify_outliers('MeanBefore') 
outliers1<-cbind(outliers1,"Grouped Var"=c(rep("Sex - MeanBefore",nrow(outliers1))))

#Grubbs method of detecting outliers with groupings - subsetted by Sex, MeanAfter
outliers2<-data.analysis_true %>%
  group_by(Sex)%>%  
  identify_outliers('MeanAfter') 
outliers2<-cbind(outliers2,"Grouped Var"=c(rep("Sex- MeanAfter",nrow(outliers2))))

#Grubbs method of detecting outliers with groupings- subsetted by Solution, MeanBefore
outliers3<-data.analysis_true %>%
  group_by(Solution) %>%  
  identify_outliers('MeanBefore') 
outliers3<-cbind(outliers3,"Grouped Var"=c(rep("Solution,MeanBefore",nrow(outliers3))))                                           

#Grubbs method of detecting outliers with groupings- subsetted by Solution, MeanAfter
outliers4<-data.analysis_true %>%
  group_by(Solution) %>%  
  identify_outliers(c('MeanAfter')) 
outliers4<-cbind(outliers4,"Grouped Var"=c(rep("Solution,MeanAfter",nrow(outliers4))))    

#Grubbs method of detecting outliers with groupings- subsetted by Sex, Solution, time
outliers5<-data.analysis_true %>%
  group_by(Sex,Solution) %>%  
  identify_outliers('MeanBefore') 
outliers5<-cbind(outliers5,"Grouped Var"=c(rep("Sex,Solution - MeanBefore",nrow(outliers5))))

#Grubbs method of detecting outliers with groupings- subsetted by Sex, Solution, time
outliers6<-data.analysis_true %>%
  group_by(Sex,Solution) %>%  
  identify_outliers('MeanAfter') 
outliers6<-cbind(outliers6,"Grouped Var"=c(rep("Sex,Solution - MeanAfter",nrow(outliers6))))

#Grubbs method of detecting outliers globally in bout characteristics
outliers7<-data.analysis_true %>%
  identify_outliers('BoutDuration') 
outliers7<-cbind(outliers7,"Grouped Var"=c(rep("Ungrouped",nrow(outliers7))))
outliers8<-data.analysis_true %>%
  identify_outliers('LickFrequency') 
outliers8<-cbind(outliers8,"Grouped Var"=c(rep("Ungrouped",nrow(outliers8))))
outliers9<-data.analysis_true %>%
  identify_outliers('LicksPerBout') 
outliers9<-cbind(outliers9,"Grouped Var"=c(rep("Ungrouped",nrow(outliers9))))


#Boxplot method of detecting outliers - individual bouts
bxp <- ggboxplot(indvsignalsummary, x = "time", y = "mean", add = "point", facet.by="Solution", order=c("MeanBefore","MeanAfter"))
bxp

#Test for normality
shapiro_test<-indvsignalsummary %>%
  group_by(Sex,Solution,time) %>%
  shapiro_test(mean)

#Test for equality of variances for the BETWEEN-SUBJECTS variable at every level of the WITHIN-SUBJECTS Variables. If there are two between, separate them by "*" in the test.
levene_test<- indvsignalsummary %>%
	group_by(time,Solution) %>%
	levene_test(mean ~ Sex)

##CL Can't figure out which vars to test against sex - need to think about more. 
#Test for equality of co-variances for the BETWEEN-SUBJECTS variable
#box_m(bout.analysis2_true[, "", drop = FALSE], bout.analysis2_true[,"Sex"]) #Just make note if significant -> there's a lot of "IF"s to interpreting this if violated

#Graph it
#ggqqplot(indvsignalsummary, "mean", facet.by = c("Sex","Solution")) #Use if only 1-2 variables, otherwise use code below

ggqqplot(indvsignalsummary, "mean", ggtheme = theme_bw()) +
  facet_grid(Sex + Solution ~ time, labeller = "label_both")

```

### b) Standardized signal (USE THIS!)

```{r}
##GLOBAL OUTLIERS
#Grubbs method of detecting outliers globally - investigating subject outliers by looking at measures collapsed across time for all substances, comparing mice
outliersglob<-subsignalsummary %>%
  group_by(type) %>%
  identify_outliers('mean')
            
#Grubbs method of detecting outliers globally - all bout mean before and after signals 
outliersglob1<-bout.analysis2_true %>%
  dplyr::select(Mouse,FileName,Sex,Solution,time,z2Mean) %>%
  identify_outliers('z2Mean')

#Grubbs method of detecting outliers globally - all AUC
outliersglob2<-bout.analysis2_true %>%
  dplyr::select(Mouse,FileName,Sex,Solution,time,z2AUC15) %>%
  identify_outliers('z2AUC15')

#Grubbs method of detecting outliers globally - all TIMEDIFF
outliersglob3<-bout.analysis2_true %>%
  dplyr::select(Mouse,FileName,Sex,Solution,time,z2TIMEDIFF) %>%
  identify_outliers('z2TIMEDIFF')

##GROUP OUTLIERS
#Grubbs method of detecting outliers within groups - all bout mean before and after signals 
outliersgroup1<-bout.analysis2_true %>%
  dplyr::select(Mouse,FileName,Sex,Solution,time,z2Mean) %>%
  group_by(Sex,Solution,time) %>%
  identify_outliers('z2Mean')

#Grubbs method of detecting outliers within groups  - all AUC
outliersgroup2<-bout.analysis2_true %>%
  dplyr::select(Mouse,FileName,Sex,Solution,time,z2AUC15) %>%
  group_by(Sex,Solution,time) %>%
  identify_outliers('z2AUC15')

#Grubbs method of detecting outliers within groups  - all TIMEDIFF
outliersgroup3<-bout.analysis2_true %>%
  dplyr::select(Mouse,FileName,Sex,Solution,time,z2TIMEDIFF) %>%
  group_by(Sex, Solution, time) %>%
  identify_outliers('z2TIMEDIFF')


#Test for normality by measure
shapiro_test<-indvsignalsummary %>%
  mutate(type=variable) %>%
  group_by(type) %>%
  shapiro_test(mean)

#Test for normality by group
shapiro_test1<-indvsignalsummary %>%
  mutate(type=variable) %>%
  group_by(Sex,Solution,time,type) %>%
  shapiro_test(mean)


#Test for equality of variances for the BETWEEN-SUBJECTS variable at every level of the WITHIN-SUBJECTS Variables. If there are two between, separate them by "*" in the test.
levene_test<- indvsignalsummary %>%
  mutate(type=variable) %>%
	group_by(Solution,time,type) %>%
	levene_test(mean ~ Sex)

##CL Can't figure out which vars to test against sex - need to think about more. 
#Test for equality of co-variances for the BETWEEN-SUBJECTS variable
#box_m(bout.analysis2_true[, "", drop = FALSE], bout.analysis2_true[,"Sex"]) #Just make note if significant -> there's a lot of "IF"s to interpreting this if violated

#Graph it
#ggqqplot(indvsignalsummary, "mean", facet.by = c("Sex","Solution")) #Use if only 1-2 variables, otherwise use code below

ggqqplot(indvsignalsummary, "mean", ggtheme = theme_bw()) +
  facet_grid(Sex + Solution ~ time, labeller = "label_both")

```

## 4) Export your descriptive statistics including summaries and assumption testing to an Excel File for records and sharing

### a) For CL8

```{r}
##Run this for first time through
filedesc<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Bout Descriptive Stats.xlsx"

#filedesc<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout Bout Descriptive Stats.xlsx"

##Run this after you have removed outliers and repeated analysis
#filedesc<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Bout Descriptive Stats_OutliersRemoved.xlsx"

##Run this after you have removed outliers and repeated analysis
#filedesc<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Bout Descriptive Stats_Outlierand8.22Removed.xlsx"

write.xlsx(subject.analysis,file=filedesc,sheetName = "Subject.Analysis",append=TRUE)
write.xlsx(group.analysis,file=filedesc,sheetName = "Group.Analysis",append=TRUE)

write.xlsx(indvsignalsummary,file=filedesc,sheetName = "Indv_Signal_Means",append=TRUE)

write.xlsx(subsignalsummary,file=filedesc,sheetName = "Sub_Signal_Means", append=TRUE)

write.xlsx(grpsignalsummary,file=filedesc,sheetName = "Grp_Signal_Means",append=TRUE)


write.xlsx(outliersglob,file=filedesc,sheetName = "GlobalSubjectOutlierTest",append=TRUE)

write.xlsx(outliersglob1,file=filedesc,sheetName="Global z2Mean Outliers",append=TRUE)

write.xlsx(outliersglob2,file=filedesc,sheetName = "Global z2AUC15 Outliers",append=TRUE)

write.xlsx(outliersglob3,file=filedesc,sheetName = "Global TIMEDIFF Outliers",append=TRUE)

write.xlsx(outliersgroup1,file=filedesc,sheetName = "Group z2Mean Outliers",append=TRUE)

write.xlsx(outliersgroup2,file=filedesc,sheetName = "Group z2AUC15 Outliers",append=TRUE)

write.xlsx(outliersgroup3,file=filedesc,sheetName = "Group z2TIMEDIFF Outliers",append=TRUE)

write.xlsx(shapiro_test,file=filedesc,sheetName = "NormalityTest",append=TRUE)

write.xlsx(levene_test,file=filedesc,sheetName = "HOVTest",append=TRUE)

```


## 5) Filter out outliers found in the previous analysis by modifying code in Data Preparation 4) and 5) and then run Bout Level Analysis again to re-check assumptions

## 6) Export Final Bout Data

This may seem tedious, but trust me, you'll want a record.

### a) For CL8

#### i) If #17 Retained

```{r}
filedesc<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout FINALDATA.xlsx"  

#filedesc<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout Raw FINALDATA.xlsx"

write.xlsx(data.analysis_true,file=filedesc,sheetName = "TrueBout_Filtered_Data",append=TRUE) 
write.xlsx(data.analysis_false,file=filedesc,sheetName = "Excluded_by_TrueBout",append=TRUE)
write.xlsx(bout.analysis2_true,file=filedesc,sheetName = "TrueBout_Filtered_Data_Long",append=TRUE) 
write.xlsx(bout.analysis2_false,file=filedesc,sheetName = "Excluded_by_TrueBout_Long",append=TRUE)
```

#### ii) If #17 Dropped

```{r}
filedesc<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Raw FINALDATA_OutlierRemoved.xlsx"

write.xlsx(data.analysis_true,file=filedesc,sheetName = "TrueBout_Filtered_Data",append=TRUE)
write.xlsx(data.analysis_false,file=filedesc,sheetName = "Excluded_by_TrueBout",append=TRUE)
```

#### iii) If #17 and 8/22 Dropped

```{r}
filedesc<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Raw FINALDATA_Outlierand8.22Removed.xlsx"  

write.xlsx(data.analysis_true,file=filedesc,sheetName = "TrueBout_Filtered_Data",append=TRUE) 
write.xlsx(data.analysis_false,file=filedesc,sheetName = "Excluded_by_TrueBout",append=TRUE)
```


## 7) Clear Unnecessary Variables

Once you've graphed everything you'd like this helps reduce memory usage and your overall list of environmental variables to look through.

```{r}
remove(outliersglob,outliersglob2,outliersglob3,outliersgroup1,outliersgroup2,outliersgroup3,shapiro_test,shapiro_test1,subsignalsummary,subsignalsummaryz1,subsignalsummaryz2,outlierexport,outlierexport2,outlierexport2z,outlierexportz,outliers1,outliers2,outliers3,outliers4,outliers5,outliers6,outliers7,outliers8,outliers9,outliers1z,outliers2z,outliers3z,outliers4z,outliers5z,outliers6z,outliersglob1,outliersglob1z,outliersglob2,outliersglob2z,outliersglob3,levene_test,levene_testz,indvsignalsummaryz2,indvsignalsummaryz1,indvsignalsummary,grpsignalsummaryz1,grpsignalsummaryz2,grpsignalsummary,group.analysis,bxp,bxpz,subject.analysis)
```

# SESSION LEVEL ANALYSIS

This section takes the Bout Analysis data and gets session-wise measures that can be combined with drinking data from that session.

## 1) Assemble & Get Descriptive Statistics

```{r}
data.analysis_true$Bout<-as.numeric(as.character(data.analysis_true$Bout)) 
data.analysis_true$Mouse<-as.numeric(as.character(data.analysis_true$Mouse)) 

myorder3<-myorder[myorder !="Position"]

session.analysis<-data.analysis_true %>%
  group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>%
  reframe(across(any_of(myorder3),c(mean=mean,se=std.error,min=min,max=max)))

session.analysis.bout<-data.analysis_true %>%
    group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>%
    summarise_at(vars("Bout"),list(TotalBouts=length))

session.analysis.licks<-data.analysis_true %>%
    group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>%
    summarise_at(vars("LicksPerBout","BoutDuration"),list(Total=sum,Max=max))

session.analysis.order<-data.analysis_true %>%
    group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>%
    summarise_at(vars("Output.Order"),list(OutputOrder_Start=min)) 

session.analysis2<-merge.data.frame(session.analysis,session.analysis.bout,by=c("group_shrt","session","Mouse","subject","Solution","Sex","Channel","FileName"))
session.analysis2<-merge.data.frame(session.analysis2,session.analysis.licks,by=c("group_shrt","session","Mouse","subject","Solution","Sex","Channel","FileName"))
session.analysis2<-merge.data.frame(session.analysis2,session.analysis.order,by=c("group_shrt","session","Mouse","subject","Solution","Sex","Channel","FileName"))


data.analysis_true.sort<-sort_df(data.analysis_true, c('Output.Order','group_shrt','Sex','FileName','Channel','Solution','session','Mouse','subject'))
session.analysis2<-sort_df(session.analysis2, c('OutputOrder_Start','group_shrt','Sex','FileName','Channel','Solution','session','Mouse','subject'))


##Check that each are sorted the same by checking session run values. All should say "TRUE"
rle(session.analysis2$Mouse)$values==rle(data.analysis_true.sort$Mouse)$values

```

## 2) Export Prelim Session Data

Note that the variable name followed by \$y is the mean and \$ymin and \$ymax are the mean minus or plus the standard error, respectively.

### a) For CL8

#### i) If #17 Retained

```{r}
file3<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Session Descriptive Stats.xlsx"

#file3<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout Session Descriptive Stats.xlsx"

write.xlsx(as.data.frame(session.analysis2),file=file3,sheetName = "SessionData",append=TRUE)

write.xlsx(data.analysis_true.sort,file=file3,sheetName = "IndvBoutData",append=TRUE)
```

#### ii) If #17 Dropped

```{r}
file3<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Session Descriptive Stats_OutlierRemoved.xlsx"

write.xlsx(as.data.frame(session.analysis2),file=file3,sheetName = "SessionData",append=TRUE)

write.xlsx(data.analysis_true.sort,file=file3,sheetName = "IndvBoutData",append=TRUE)
```

#### iii) If #17 and 8/22 Dropped

```{r}
file3<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Session Descriptive Stats_Outlierand8.22Removed.xlsx"  

write.xlsx(as.data.frame(session.analysis2),file=file3,sheetName = "SessionData",append=TRUE)  
write.xlsx(data.analysis_true.sort,file=file3,sheetName = "IndvBoutData",append=TRUE)
```


## 3) Fill in Drinking Data

Open the file created in the previous step and fill in your drinking data for each session. CRITICAL: KEEP SORTED AS IS! SORT DRINKING DATA INSTEAD TO MATCH. Sorting by 'FileName' then 'Channel' should do it. 

## \*4) Import Updated Session Data File

### a) For CL8

\*If using QUICKSTART path, run both code blocks. If not, run just the bottom.

```{r}
#If retaining #17
file3<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Session Descriptive Stats.xlsx"

#file3<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout Session Descriptive Stats.xlsx"

#file3<-"C:/Users/y3sci/OneDrive/Desktop/CL8 Joint_TrueBout Session Descriptive Stats.xlsx"

#If #17 dropped
#file3<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Session Descriptive Stats_OutlierRemoved.xlsx"
```

```{r}
session.analysis3<-read.xlsx(file3, sheetName='SessionData',header = TRUE)
session.analysis3$Solution<-factor(session.analysis3$Solution,levels=sol.levels)  
session.analysis3$group_shrt<-factor(session.analysis3$group_shrt,levels=c(group1.levels))   
session.analysis3$Mouse<-factor(session.analysis3$Mouse)
session.analysis3$Sex<-factor(session.analysis3$Sex,levels=c("Female","Male"))

contrasts(session.analysis3$Sex) <- contr.Helmert(levels(session.analysis3$Sex))
colnames(contrasts(session.analysis3$Sex))<-c("[H.Male-Female]")

contrasts(session.analysis3$Solution) <- contr.Helmert(levels(session.analysis3$Solution))
colnames(contrasts(session.analysis3$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")

```

## \*5) Get Session Summary Data

We will export this and use it for all of the publishable bar graphs.

```{r}
##Get Omnibus Subject Summaries######
myorder2<-paste(myorder,"_mean",sep="")
myorder2<-c(myorder2,"Drinking.mL.kg","EtOH.gkg")

#Since we don't too much care about the previous se, min, max when averaging up the next level, we can use reframe () to select just the mean columns.
subject.analysis_avgs<-session.analysis3 %>%
    group_by(group_shrt,Mouse,subject,Solution,Sex) %>%
    reframe(across(any_of(myorder2)))

subject.analysis_avgs.bout<-session.analysis3 %>%
    group_by(group_shrt,Mouse,subject,Solution,Sex) %>%
    summarise_at(vars("TotalBouts","LicksPerBout_Total","BoutDuration_Total"),list(Total=sum))

subject.analysis_avgs.licks<-session.analysis3 %>%
    group_by(group_shrt,Mouse,subject,Solution,Sex) %>%
    summarise_at(vars("LicksPerBout_Max","BoutDuration_Max"),list(Max=max))

subject.analysis_avgs2<-subject.analysis_avgs %>%
  group_by(Mouse,Solution,Sex,subject,group_shrt) %>%
  reframe(across(any_of(myorder2),list(mean=mean,se=std.error),.unpack=TRUE))

subject.analysis_avgs2<-merge.data.frame(subject.analysis_avgs2,subject.analysis_avgs.bout,by=c("group_shrt","Mouse","subject","Solution","Sex"))
subject.analysis_avgs2<-merge.data.frame(subject.analysis_avgs2,subject.analysis_avgs.licks,by=c("group_shrt","Mouse","subject","Solution","Sex"))

subject.analysis_avgs2$group_shrt<-factor(subject.analysis_avgs2$group_shrt,levels=c(group1.levels)) #Sets the order as desired for graphing
subject.analysis_avgs2$Sex<-factor(subject.analysis_avgs2$Sex)



##Get Omnibus Group Summaries######
myorder4<-paste(myorder2,"_mean",sep="")

group.analysis_avgs<-subject.analysis_avgs2 %>%
    group_by(group_shrt,Solution,Sex) %>%
    reframe(across(any_of(myorder4)))

group.analysis_avgs.bouts<-subject.analysis_avgs2 %>%
    group_by(group_shrt,Solution,Sex) %>%
    summarise_at(vars("TotalBouts_Total","LicksPerBout_Total_Total","BoutDuration_Total_Total"),list(Total=sum))

group.analysis_avgs.licks<-subject.analysis_avgs2 %>%
    group_by(group_shrt,Solution,Sex) %>%
    summarise_at(vars("LicksPerBout_Max_Max","BoutDuration_Max_Max"),list(Max=max))

group.analysis_avgs2<-group.analysis_avgs %>%
  group_by(group_shrt,Solution,Sex) %>%
  reframe(across(any_of(myorder4),list(mean=mean,se=std.error),.unpack=TRUE))

group.analysis_avgs2<-merge.data.frame(group.analysis_avgs2,group.analysis_avgs.bouts,by=c("group_shrt","Solution","Sex"))
group.analysis_avgs2<-merge.data.frame(group.analysis_avgs2,group.analysis_avgs.licks,by=c("group_shrt","Solution","Sex"))


subject.analysis_avgs2$Solution<-factor(subject.analysis_avgs2$Solution,levels=sol.levels)
contrasts(subject.analysis_avgs2$Solution)<-contr.Helmert(levels(subject.analysis_avgs2$Solution))
colnames(contrasts(subject.analysis_avgs2$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")

subject.analysis_avgs2$Sex<-factor(subject.analysis_avgs2$Sex,levels=c("Female","Male"))
contrasts(subject.analysis_avgs2$Sex)<-contr.Helmert(levels(subject.analysis_avgs2$Sex))
colnames(contrasts(subject.analysis_avgs2$Sex))<-c("[H.Male-Female]")

subject.analysis_avgs2$group_shrt<-factor(subject.analysis_avgs2$group_shrt,levels=group1.levels)
```

## 6) Export Final Session Summary Data

```{r}
write.xlsx(session.analysis3,file=file3,sheetName = "Session_Means",append=TRUE)

write.xlsx(subject.analysis_avgs2,file=file3,sheetName = "Subject_Means",append=TRUE)

write.xlsx(group.analysis_avgs2,file=file3,sheetName = "Group_Means",append=TRUE)
```

# STATISTICS: 3-Way ANOVA With Interactions

## \*1) Initial Setup

Our data for session, subject and group averages are still in wide format so we need to melt it to get a single variable, "signal", that has a time factor (Mean Before vs Mean After).

```{r}
##Specify path of the output file - heads up that this will be used for all the statistical outputs from this point on!!!
#filemod<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout ANOVA Results.xlsx"

filemod<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout ANOVA Results.xlsx"


#OR 

#filemod<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout ANOVA Results_OutlierRemoved.xlsx"

#or

#filemod<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout ANOVA Results_Outlierand8.22Removed.xlsx"

## Next we create two averaged datasets - "Session.analysis4" which is averaged by session, "Subject.analysis2" which is averaged by Mouse. Each is gathered into long data formats (either regular signal, z1 signal, or z2 signal) and factors/contrasts reset.

session.analysis4<-session.analysis3 %>%
  gather(key="time", value="signal", MeanBefore_mean, MeanAfter_mean, z1MeanBefore_mean,z1MeanAfter_mean,z2MeanBefore_mean,z2MeanAfter_mean)
session.analysis4$time<-factor(session.analysis4$time,levels=c("MeanBefore_mean","MeanAfter_mean","z1MeanBefore_mean","z1MeanAfter_mean","z2MeanBefore_mean","z2MeanAfter_mean")) 

session.analysis4$Mouse<-factor(session.analysis4$Mouse, levels=c(1:25))

session.analysis4.mean<-filter(session.analysis4,time=="MeanBefore_mean" |time== "MeanAfter_mean",preserve=TRUE)
session.analysis4.meanz1<-filter(session.analysis4,time=="z1MeanBefore_mean" |time== "z1MeanAfter_mean",preserve=TRUE)
session.analysis4.meanz2<-filter(session.analysis4,time=="z2MeanBefore_mean" |time== "z2MeanAfter_mean",preserve=TRUE)

# Re-Set Factor Levels
session.analysis4.mean$time<-factor(session.analysis4.mean$time,levels=c("MeanBefore_mean","MeanAfter_mean"))
session.analysis4.meanz1$time<-factor(session.analysis4.meanz1$time,levels=c("z1MeanBefore_mean","z1MeanAfter_mean")) 
session.analysis4.meanz2$time<-factor(session.analysis4.meanz2$time,levels=c("z2MeanBefore_mean","z2MeanAfter_mean")) 

# Re-Set Contrasts
contrasts(session.analysis4.mean$Sex) <- contr.Helmert(levels(session.analysis4.mean$Sex))
colnames(contrasts(session.analysis4.mean$Sex))<-c("[H.Male-Female]")

contrasts(session.analysis4.mean$Solution) <- contr.Helmert(levels(session.analysis4.mean$Solution))
colnames(contrasts(session.analysis4.mean$Solution))<-c("[H.Sucrose-Water],[H.EtOH-avg(S,W)]")

contrasts(session.analysis4.mean$time) <- contr.Helmert(levels(session.analysis4.mean$time))
colnames(contrasts(session.analysis4.mean$time))<-c("[H.After-Before]")


contrasts(session.analysis4.meanz1$Sex) <- contr.Helmert(levels(session.analysis4.meanz1$Sex))
colnames(contrasts(session.analysis4.meanz1$Sex))<-c("[H.Male-Female]")

contrasts(session.analysis4.meanz1$Solution) <- contr.Helmert(levels(session.analysis4.meanz1$Solution))
colnames(contrasts(session.analysis4.meanz1$Solution))<-c("[H.Sucrose-Water],[H.EtOH-avg(S,W)]")

contrasts(session.analysis4.meanz1$time) <- contr.Helmert(levels(session.analysis4.meanz1$time))
colnames(contrasts(session.analysis4.meanz1$time))<-c("[H.After-Before]")


contrasts(session.analysis4.meanz2$Sex) <- contr.Helmert(levels(session.analysis4.meanz2$Sex))
colnames(contrasts(session.analysis4.meanz2$Sex))<-c("[H.Male-Female]")

contrasts(session.analysis4.meanz2$Solution) <- contr.Helmert(levels(session.analysis4.meanz2$Solution))
colnames(contrasts(session.analysis4.meanz2$Solution))<-c("[H.Sucrose-Water],[H.EtOH-avg(S,W)]")

contrasts(session.analysis4.meanz2$time) <- contr.Helmert(levels(session.analysis4.meanz2$time))
colnames(contrasts(session.analysis4.meanz2$time))<-c("[H.After-Before]")

####################################################################


subject.analysis2<-subject.analysis_avgs2 %>% 	
  gather(key="time", value="signal", MeanBefore_mean_mean, MeanAfter_mean_mean, z1MeanBefore_mean_mean, z1MeanAfter_mean_mean,z2MeanBefore_mean_mean, z2MeanAfter_mean_mean)

subject.analysis2$time<-factor(subject.analysis2$time,levels=c("MeanBefore_mean_mean","MeanAfter_mean_mean","z2MeanBefore_mean_mean","z2MeanAfter_mean_mean")) 
subject.analysis2$Mouse<-factor(subject.analysis2$Mouse, levels=c(1:25))

subject.analysis2.mean<-filter(subject.analysis2,time=="MeanBefore_mean_mean" |time== "MeanAfter_mean_mean",preserve=TRUE)
subject.analysis2.meanz1<-filter(subject.analysis2,time=="z1MeanBefore_mean_mean" |time== "z1MeanAfter_mean_mean",preserve=TRUE)
subject.analysis2.meanz2<-filter(subject.analysis2,time=="z2MeanBefore_mean_mean" |time== "z2MeanAfter_mean_mean",preserve=TRUE)

# Re-Set Factor Levels
subject.analysis2.mean$time<-factor(subject.analysis2.mean$time,levels=c("MeanBefore_mean_mean","MeanAfter_mean_mean"))
subject.analysis2.meanz1$time<-factor(subject.analysis2.meanz1$time,levels=c("z1MeanBefore_mean_mean","z1MeanAfter_mean_mean")) 
subject.analysis2.meanz2$time<-factor(subject.analysis2.meanz2$time,levels=c("z2MeanBefore_mean_mean","z2MeanAfter_mean_mean")) 

# Re-Set Contrasts
contrasts(subject.analysis2.mean$Sex) <- contr.Helmert(levels(subject.analysis2.mean$Sex))
colnames(contrasts(subject.analysis2.mean$Sex))<-c("[H.Male-Female]")

contrasts(subject.analysis2.mean$Solution) <- contr.Helmert(levels(subject.analysis2.mean$Solution))
colnames(contrasts(subject.analysis2.mean$Solution))<-c("[H.Sucrose-Water],[H.EtOH-avg(S,W)]")

contrasts(subject.analysis2.mean$time) <- contr.Helmert(levels(subject.analysis2.mean$time))
colnames(contrasts(subject.analysis2.mean$time))<-c("[H.After-Before]")


contrasts(subject.analysis2.meanz1$Sex) <- contr.Helmert(levels(subject.analysis2.meanz1$Sex))
colnames(contrasts(subject.analysis2.meanz1$Sex))<-c("[H.Male-Female]")

contrasts(subject.analysis2.meanz1$Solution) <- contr.Helmert(levels(subject.analysis2.meanz1$Solution))
colnames(contrasts(subject.analysis2.meanz1$Solution))<-c("[H.Sucrose-Water],[H.EtOH-avg(S,W)]")

contrasts(subject.analysis2.meanz1$time) <- contr.Helmert(levels(subject.analysis2.meanz1$time))
colnames(contrasts(subject.analysis2.meanz1$time))<-c("[H.After-Before]")



contrasts(subject.analysis2.meanz2$Sex) <- contr.Helmert(levels(subject.analysis2.meanz2$Sex))
colnames(contrasts(subject.analysis2.meanz2$Sex))<-c("[H.Male-Female]")

contrasts(subject.analysis2.meanz2$Solution) <- contr.Helmert(levels(subject.analysis2.meanz2$Solution))
colnames(contrasts(subject.analysis2.meanz2$Solution))<-c("[H.Sucrose-Water],[H.EtOH-avg(S,W)]")

contrasts(subject.analysis2.meanz2$time) <- contr.Helmert(levels(subject.analysis2.meanz2$time))
colnames(contrasts(subject.analysis2.meanz2$time))<-c("[H.After-Before]")

```

## 2) Basic ANOVA

```{r}
## For final data & modelling comparisions, decided to use only the z2 dataset

#Signal
anova.basic<-aov(signal ~ Sex*Solution*time, data=subject.analysis2.meanz2)
summary(anova.basic)

#plot(lm(anova.basic))

#Consumption
anova.basic2<-aov(Drinking.mL.kg_mean ~ Sex*Solution, data=subject.analysis2.meanz2)
summary(anova.basic2)

#plot(lm(anova.basic2))

#Duration
anova.basic3<-aov(BoutDuration_mean_mean ~ Sex*Solution, data=subject.analysis2.meanz2)

summary(anova.basic3)

```

## 3) Mouse-Nested ANOVAs

```{r}
## For final data & modelling comparisions, decided to use only the z2 dataset

#Each Mouse has Average for each Solution
anova.nested1<-aov(signal ~ Sex*Solution*time + Error(Mouse), data=subject.analysis2.meanz2)
summary(anova.nested1)
#plot(lm(anova.nested1))

#Each Mouse has Average for each Session
anova.nested2<-aov(signal ~ Sex*Solution*time + Error(Mouse), data=session.analysis4.meanz2)
summary(anova.nested2)
#plot(lm(anova.nested2))

#Each Mouse using all Bouts
anova.nested3<-aov(signal ~ Sex*Solution*time + Error(Mouse), data=bout.analysis2_true)
summary(anova.nested3)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding Duration
anova.nested4<-aov(signal ~ Sex*Solution*time*Duration_sol_imc + Error(Mouse), data=bout.analysis2_true)
summary(anova.nested4)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding position
anova.nested4<-aov(signal ~ Sex*Solution*time*Position+ Error(Mouse), data=bout.analysis2_true)
summary(anova.nested4)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding position+Duration
anova.nested5<-aov(signal ~ Sex*Solution*time*Position*Duration_imc+ Error(Mouse), data=bout.analysis2_true)
summary(anova.nested5)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding position+Duration
anova.nested5<-aov(signal ~ Sex*Solution*time*Position*Duration_imc+ Error(Mouse), data=bout.analysis2_true)
summary(anova.nested5)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding position+Duration
anova.nested5<-aov(signal ~ Sex*Solution*time*Position*Duration_imc+ Error(Mouse), data=bout.analysis2_true)
summary(anova.nested5)
#plot(lm(anova.nested3))

#
#For Consumption Only, for Each Session but Nested within Mouse
anova.nested6<-aov(Drinking.mL.kg ~ Sex*Solution + Error(Mouse), data=session.analysis4.meanz2)
summary(anova.nested6)
#plot(lm(anova.nested4))

#Each Mouse using all Bouts - BoutDuration
anova.nested7<-aov(BoutDuration ~ Sex*Solution + Error(Mouse), data=data.analysis_true)
summary(anova.nested7)
#plot(lm(anova.nested5))

#Each Mouse using all Bouts - LickFreq
anova.nested8<-aov(LickFrequency ~ Sex*Solution + Error(Mouse), data=data.analysis_true)
summary(anova.nested8)
#plot(lm(anova.nested6))

#Each Mouse has all Bouts - LicksPerBout
anova.nested9<-aov(LicksPerBout ~ Sex*Solution + Error(Mouse), data=data.analysis_true)
summary(anova.nested9)
#plot(lm(anova.nested7))

#Each Mouse has all Bouts - BoutDuration by first 10 last 10
anova.nested8<-aov(BoutDuration ~ Position*Sex*Solution, data=data.analysis_true)
summary(anova.nested8)
#plot(lm(anova.nested8))

#Each Mouse has all Bouts - LickFreq by Position
anova.nested9<-aov(LickFrequency ~ Position*Sex*Solution, data=data.analysis_true)
summary(anova.nested9)
#plot(lm(anova.nested9))



#FIRST BOUTS from four mice
anova.nested.first<-aov(signal ~ time*Solution + Error(Mouse), data=bout.analysis2_true.first)
summary(anova.nested.first)

```

## 4) PostHoc Comparisons

```{r}
#Signal
tukey3<-emmeans(anova.nested3, list(pairwise ~ Solution*Sex*time), adjust = "tukey")

#Consumption
tukey4<-emmeans(anova.nested4, list(pairwise ~ Solution*Sex), adjust = "tukey")

#BoutDuration
tukey5<-emmeans(anova.nested5, list(pairwise ~ Solution*Sex), adjust = "tukey")

#LickFreq
tukey6<-emmeans(anova.nested6, list(pairwise ~ Solution*Sex), adjust = "tukey")
#LicksPerBout
tukey7<-emmeans(anova.nested7, list(pairwise ~ Solution*Sex), adjust = "tukey")

#BoutDuration First 10 Last 10
tukey8<-emmeans(anova.nested8, list(pairwise ~ Position*Solution*Sex), adjust = "tukey")

#LickFreq First 10 Last 10
tukey9<-emmeans(anova.nested9, list(pairwise ~ Position*Solution*Sex), adjust = "tukey")
#LicksPerBout First 10 Last 10
tukey10<-emmeans(anova.nested10, list(pairwise ~ Position*Solution*Sex), adjust = "tukey")

```

## 5) Model Diagnostics

```{r}
# Define model to investigate
model.diag <- lm(anova.nested3z)

#Residual plots, Q-Q Residuals, Scale-Location Plots, and Residual-Leverage Plots
plot(model.diag)

#Kolmogorov-Smirnov Tests for Normality in large sample sizes
ks.test(residuals(model.diag),y=pnorm)

#Effects plot
plot_model(model.diag, show.values = TRUE, vline.color = "black")


# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(model.diag, pbkrtest.limit = 5667, at=list(LickFrequency_imc=c(-2,0,2,4),LickFrequency_mc=c(-2.5,0,1.5), Duration_imc=c(-1,0,3.5,8), Duration_mc=c(-1,0,2.5),Drinking.mL.kg_imc=c(-4,-2,0,2)))

             
# Plot specific interactions
emmip(RG, Solution ~ LickFrequency_imc*Duration_imc | time*Sex, style = "factor", CIs=TRUE)

# Plot diagnostics for clustered models
#refit as lm manually (sorry no workaround)
data.nna<-na.omit(bout.analysis2_true)
an3lm<-lm(signal~Sex*Solution*time,data=data.nna)
params<-names(coef(an3lm))
summclust_res<-summclust(obj=an3lm,params = params,cluster= ~ Mouse)
summary.lev<-summary(summclust_res)
plot(summclust_res$coef_estimates)
plot(summclust_res$leverage_g)
plot(summclust_res$cluster)
```

## 6) Export Statistic Test Results

```{r}
models<-ls(envir=.GlobalEnv,pattern="anova")  
models.call<-lapply(mget(models),get_call)  
for(x in names(models.call)){
  if(is.null(models.call[[x]])==TRUE){
    temp<-as.character(attributes(get(x))$call)
    models.call[x]<-paste0(temp[1],"(formula = ",temp[2],", data = ", temp[3],")")
  } 
}
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.info<-NULL
model.obs<-NULL  
model.obs.df<-NULL   
slice<-NULL
slice.df<-NULL
grps<-NULL

for(k in models){ 
  slice.df<-NULL
  info<-model_info(get(k))
  obs<-info$n_obs
  counts<-get_predictors(get(k))
  n<-lapply(counts, FUN="freq_table")
  m<-counts %>% unite("group.full",1:2)
  grps.temp1<-freq_table(m,group.full)
  grps.temp2<-grps.temp1 %>% unite(factor,group.full,n,sep=" ")
  grps<-toString(grps.temp2$factor)
  for (j in names(n)){
  slice.temp1<-n[[j]] %>% unite(factor,group,n,sep=" ")
  slice.temp2<-slice.temp1[1]
  slice<-toString(slice.temp2$factor)
  slice.df<-cbind(slice.df,slice)
    }
 
  colnames(slice.df)<-names(n)
  
  model.obs<-data.frame("Model"=k,"Total_Observations"=toString(paste(names(obs),obs)),"N_by_Group"=grps,"N_by_Slice"=slice.df, "Included_Subjects"=toString(unique(counts$Mouse)))  
  
  if(k==models[1]){
    model.obs.df<-model.obs
  }else{
  model.obs.df<-merge(model.obs.df,model.obs,by=intersect(colnames(model.obs.df),colnames(model.obs)),all=TRUE)
  }
  
#png(paste0(filemod,"/..","/","Diagnostics_",k,".png"), width=10, height=10, units='in', res=600)
#layout(matrix(1:4, ncol = 2))
#plot(lm(get(k)))
#layout(1)
#dev.off()
} 

model.info<-merge(models.call.df,model.obs.df,all=TRUE)  


summary<-modelsummary::msummary(mget(models),shape = term + group  ~ model + statistic,statistic= c("df","conf.int","s.e. = {std.error}", "F = {statistic}","p = {p.value}"),stars=T,output="data.frame")

remove(tukey)
tukey<-ls(envir=.GlobalEnv,pattern="tukey") 
tuk.summary1<-NULL
tuk.summary2<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)

}

write.xlsx(model.info,file=filemod,sheetName = "3WayANOVA_Info",append=TRUE)
write.xlsx(summary,file=filemod,sheetName = "3WayANOVA",append=TRUE)
write.xlsx(tuk.summary1,file=filemod,sheetName = "Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filemod,sheetName = "Tukey_Pairs",append=TRUE)
```

# STATISTICS: Linear Mixed Modeling/Multilevel

## \*1) Initial Setup

### a) For CL8

```{r}
##Specify path of the output file - heads up that this will be used for all the statistical outputs from this point on!!!
#filemod2<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Mixed Models and PostHoc Results.xlsx"

#filemod2<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout Mixed Models and PostHoc Results.xlsx"

#filemod2<-"C:/Users/y3sci/OneDrive/Desktop/CL8 Joint_TrueBout Mixed Models Results.xlsx"

# or

#filemod2<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Mixed Models Results_OutlierRemoved.xlsx"

#filemod2<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout Mixed Models Results_signalcentered.xlsx"

#Previous code should have done these important steps for you: 
## 1) Make sure the variables are factors! 
## 2) Specify the order of the levels of each factor so that you can make the appropriate contrasts (i.e. Males then Females to get Female estimate or Females then Males to get Male estimate)
## 3) Melt the photometry signal measurements so that the data is in long format with a single different line for each measure (i.e. bout.analysis2_true).

#Next we want to merge the bout and session data so that each level is represented by data at the lowest level. In other words, drinking, which is a session level measure, will be paired with all individual bouts from that session.

#Fill in the correct drinking data from the matching FileName and Channel entries in the session data 


#####################################################################
# Standardized Signal Dataset
setDT(bout.analysis2_true)[,Drinking.mL.kg:=rep(NA,length(row.names(bout.analysis2_true)))]  
setDT(bout.analysis2_true)[,EtOH.gkg:=rep(NA,length(row.names(bout.analysis2_true)))] 
setDT(bout.analysis2_true)[,BoutTotal:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.mL.kg[[i]]<-session.analysis3$Drinking.mL.kg[[which(session.analysis3$FileName==bout.analysis2_true$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true$Channel[[i]])]]
  
   bout.analysis2_true$EtOH.gkg[[i]]<-session.analysis3$EtOH.gkg[[which(session.analysis3$FileName==bout.analysis2_true$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true$Channel[[i]])]] 
   
   bout.analysis2_true$BoutTotal[[i]]<-session.analysis3$Bout_max[[which(session.analysis3$FileName==bout.analysis2_true$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true$Channel[[i]])]] 
}

# Wide Dataset
setDT(data.analysis_true)[,Drinking.mL.kg:=rep(NA,length(row.names(data.analysis_true)))]  
setDT(data.analysis_true)[,EtOH.gkg:=rep(NA,length(row.names(data.analysis_true)))] 
setDT(data.analysis_true)[,BoutTotal:=rep(NA,length(row.names(data.analysis_true)))] 

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg[[i]]<-session.analysis3$Drinking.mL.kg[[which(session.analysis3$FileName==data.analysis_true$FileName[[i]] & session.analysis3$Channel==data.analysis_true$Channel[[i]])]]
  
   data.analysis_true$EtOH.gkg[[i]]<-session.analysis3$EtOH.gkg[[which(session.analysis3$FileName==data.analysis_true$FileName[[i]] & session.analysis3$Channel==data.analysis_true$Channel[[i]])]] 
   
   data.analysis_true$BoutTotal[[i]]<-session.analysis3$Bout_max[[which(session.analysis3$FileName==data.analysis_true$FileName[[i]] & session.analysis3$Channel==data.analysis_true$Channel[[i]])]] 
}

###############################################
# Now make the standardized drinking variables

# Make tables of means and std dev for all variables to be standardized 

#Drinking.mL.kg Global Standardized
Drinking.mL.kg_means<- data.analysis_true %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('Drinking.mL.kg'), type = "mean_sd")
Drinking.mL.kg_means<-Drinking.mL.kg_means %>%
  mutate("gmc"=as.vector(scale(mean)))

# Within-Solution Individually Standardized Drinking
Drinking.sol_means<- data.analysis_true %>% 
  group_by(Mouse,Solution) %>%
  get_summary_stats(c('Drinking.mL.kg'), type = "mean_sd")
Drinking.sol_means<-Drinking.sol_means %>%
  group_by(Solution)%>%
  mutate("gmc"=as.vector(scale(mean))) %>%
  ungroup()
Drinking.sol_means2<-Drinking.sol_means %>%
  group_by(Solution) %>%
  get_summary_stats(c('mean'), type= "mean_sd")

#Drinking.mL.kg Standardized - by Sex!
Drinking.mL.kg_means_sex<- data.analysis_true %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('Drinking.mL.kg'), type = "mean_sd")
Drinking.mL.kg_means_sex<- Drinking.mL.kg_means_sex %>%
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Drinking.mL.kg_means_sex<- Drinking.mL.kg_means_sex %>%
  mutate(variable="Drinking.mL.kg")

#Drinking.mL.kg Standardized - by Group!
Drinking.mL.kg_means_grp<- data.analysis_true %>% 
  group_by(Mouse,group_shrt) %>%
  get_summary_stats(c('Drinking.mL.kg'), type = "mean_sd")
Drinking.mL.kg_means_grp<- Drinking.mL.kg_means_grp %>%
  group_by(group_shrt) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Drinking.mL.kg_means_grp<- Drinking.mL.kg_means_grp %>%
  mutate(variable="Drinking.mL.kg")

# EtOH as g/kg Standardized (same as Within Solution for EtOH, just different units)
temp<- subset(data.analysis_true,!is.na(EtOH.gkg))

EtOH.gkg_means<- temp %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('EtOH.gkg'), type = "mean_sd")
EtOH.gkg_means<-EtOH.gkg_means %>%
  mutate("gmc"=as.vector(scale(mean)))

# EtOH as g/kg Standardized by Sex
EtOH.gkg_means_sex<- temp %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('EtOH.gkg'), type = "mean_sd")
EtOH.gkg_means_sex<- EtOH.gkg_means_sex %>% 
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
EtOH.gkg_means_sex<- EtOH.gkg_means_sex %>% 
  mutate(variable="EtOH.gkg")

### Now add these standardized measures to the dataset


######################################################################

#Drinking.mL.kg Standardized
setDT(bout.analysis2_true)[,Drinking.mL.kg_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.mL.kg_m[[i]]<-Drinking.mL.kg_means$mean[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,Drinking.mL.kg_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.mL.kg_sd[[i]]<-Drinking.mL.kg_means$sd[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Drinking.mL.kg_imc=as.vector((bout.analysis2_true$Drinking.mL.kg-bout.analysis2_true$Drinking.mL.kg_m)/bout.analysis2_true$Drinking.mL.kg_sd))


setDT(bout.analysis2_true)[,Drinking.mL.kg_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.mL.kg_gmc[[i]]<-Drinking.mL.kg_means$gmc[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

#Within Solution Standardized Drinking
setDT(bout.analysis2_true)[,Drinking.sol_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.sol_m[[i]]<-Drinking.sol_means$mean[[which(Drinking.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true$Solution[[i]])]]
}

setDT(bout.analysis2_true)[,Drinking.sol_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.sol_sd[[i]]<-Drinking.sol_means$sd[[which(Drinking.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true$Solution[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Drinking.sol_imc=as.vector((bout.analysis2_true$Drinking.mL.kg-bout.analysis2_true$Drinking.sol_m)/bout.analysis2_true$Drinking.sol_sd))


setDT(bout.analysis2_true)[,Drinking.sol_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.sol_gmc[[i]]<-Drinking.sol_means$gmc[[which(Drinking.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true$Solution[[i]])]]
}

## Drinking.mL.kg Standardized - by Sex!
setDT(bout.analysis2_true)[,Drinking.mL.kg_sm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.mL.kg_sm[[i]]<-Drinking.mL.kg_means_sex$mean[[which(Drinking.mL.kg_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

setDT(bout.analysis2_true)[,Drinking.mL.kg_ssd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.mL.kg_ssd[[i]]<-Drinking.mL.kg_means_sex$sd[[which(Drinking.mL.kg_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Drinking.mL.kg_smc=as.vector((bout.analysis2_true$Drinking.mL.kg_m-bout.analysis2_true$Drinking.mL.kg_sm)/bout.analysis2_true$Drinking.mL.kg_ssd))


## Drinking.mL.kg Standardized - by Group!
setDT(bout.analysis2_true)[,Drinking.mL.kg_grpm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.mL.kg_grpm[[i]]<-Drinking.mL.kg_means_grp$mean[[which(Drinking.mL.kg_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

setDT(bout.analysis2_true)[,Drinking.mL.kg_grpsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Drinking.mL.kg_grpsd[[i]]<-Drinking.mL.kg_means_grp$sd[[which(Drinking.mL.kg_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Drinking.mL.kg_grpmc=as.vector((bout.analysis2_true$Drinking.sol_m-bout.analysis2_true$Drinking.mL.kg_grpm)/bout.analysis2_true$Drinking.mL.kg_grpsd))


## EtOH.gkg Standardized

setDT(bout.analysis2_true)[,EtOH.gkg_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  if(is.na(bout.analysis2_true$EtOH.gkg[[i]])==FALSE){
  bout.analysis2_true$EtOH.gkg_m[[i]]<-EtOH.gkg_means$mean[[which(EtOH.gkg_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
  }
}
setDT(bout.analysis2_true)[,EtOH.gkg_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  if(is.na(bout.analysis2_true$EtOH.gkg[[i]])==FALSE){
  bout.analysis2_true$EtOH.gkg_sd[[i]]<-EtOH.gkg_means$sd[[which(EtOH.gkg_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
  }
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(EtOH.gkg_imc=as.vector((bout.analysis2_true$EtOH.gkg-bout.analysis2_true$EtOH.gkg_m)/bout.analysis2_true$EtOH.gkg_sd))


setDT(bout.analysis2_true)[,EtOH.gkg_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  if(is.na(bout.analysis2_true$EtOH.gkg[[i]])==FALSE){
  bout.analysis2_true$EtOH.gkg_gmc[[i]]<-EtOH.gkg_means$gmc[[which(EtOH.gkg_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
  }
}

## EtOH Standardized By Sex
setDT(bout.analysis2_true)[,EtOH.gkg_sm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){
  if(is.na(bout.analysis2_true$EtOH.gkg[[i]])==FALSE){
  bout.analysis2_true$EtOH.gkg_sm[[i]]<-EtOH.gkg_means_sex$mean[[which(EtOH.gkg_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
  }
}

setDT(bout.analysis2_true)[,EtOH.gkg_ssd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$EtOH.gkg_ssd[[i]]<-EtOH.gkg_means_sex$sd[[which(EtOH.gkg_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

setDT(bout.analysis2_true)[,EtOH.gkg_smc:=rep(NA,length(row.names(bout.analysis2_true)))] 

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(EtOH.gkg_smc=as.vector((bout.analysis2_true$EtOH.gkg_m-bout.analysis2_true$EtOH.gkg_sm)/bout.analysis2_true$EtOH.gkg_ssd))

  
# Just to make sure we can graph and analyze the data.analysis_true dataset based on these variables, we add them here. 

#Drinking.mL.kg Standardized
setDT(data.analysis_true)[,Drinking.mL.kg_m:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_m[[i]]<-Drinking.mL.kg_means$mean[[which(Drinking.mL.kg_means$Mouse==data.analysis_true$Mouse[[i]])]]
}

setDT(data.analysis_true)[,Drinking.mL.kg_sd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_sd[[i]]<-Drinking.mL.kg_means$sd[[which(Drinking.mL.kg_means$Mouse==data.analysis_true$Mouse[[i]])]]
}

data.analysis_true<-data.analysis_true %>%
  mutate(Drinking.mL.kg_imc=as.vector((data.analysis_true$Drinking.mL.kg-data.analysis_true$Drinking.mL.kg_m)/data.analysis_true$Drinking.mL.kg_sd))


setDT(data.analysis_true)[,Drinking.mL.kg_gmc:=rep(NA,length(row.names(data.analysis_true)))] 

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_gmc[[i]]<-Drinking.mL.kg_means$gmc[[which(Drinking.mL.kg_means$Mouse==data.analysis_true$Mouse[[i]])]]
}

#Within Solution Standardized Drinking
setDT(data.analysis_true)[,Drinking.sol_m:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.sol_m[[i]]<-Drinking.sol_means$mean[[which(Drinking.sol_means$Mouse==data.analysis_true$Mouse[[i]] & Drinking.sol_means$Solution==data.analysis_true$Solution[[i]])]]
}

setDT(data.analysis_true)[,Drinking.sol_sd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.sol_sd[[i]]<-Drinking.sol_means$sd[[which(Drinking.sol_means$Mouse==data.analysis_true$Mouse[[i]] & Drinking.sol_means$Solution==data.analysis_true$Solution[[i]])]]
}

data.analysis_true<-data.analysis_true %>%
  mutate(Drinking.sol_imc=as.vector((data.analysis_true$Drinking.mL.kg-data.analysis_true$Drinking.sol_m)/data.analysis_true$Drinking.sol_sd))


setDT(data.analysis_true)[,Drinking.sol_gmc:=rep(NA,length(row.names(data.analysis_true)))] 

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.sol_gmc[[i]]<-Drinking.sol_means$gmc[[which(Drinking.sol_means$Mouse==data.analysis_true$Mouse[[i]] & Drinking.sol_means$Solution==data.analysis_true$Solution[[i]])]]
}

## Drinking.mL.kg Standardized - by Sex!
setDT(data.analysis_true)[,Drinking.mL.kg_sm:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_sm[[i]]<-Drinking.mL.kg_means_sex$mean[[which(Drinking.mL.kg_means_sex$Sex==data.analysis_true$Sex[[i]])]]
}

setDT(data.analysis_true)[,Drinking.mL.kg_ssd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_ssd[[i]]<-Drinking.mL.kg_means_sex$sd[[which(Drinking.mL.kg_means_sex$Sex==data.analysis_true$Sex[[i]])]]
}

data.analysis_true<-data.analysis_true %>%
  mutate(Drinking.mL.kg_smc=as.vector((data.analysis_true$Drinking.mL.kg_m-data.analysis_true$Drinking.mL.kg_sm)/data.analysis_true$Drinking.mL.kg_ssd))


## Drinking.mL.kg Standardized - by Group!
setDT(data.analysis_true)[,Drinking.mL.kg_grpm:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_grpm[[i]]<-Drinking.mL.kg_means_grp$mean[[which(Drinking.mL.kg_means_grp$group_shrt==data.analysis_true$group_shrt[[i]])]]
}

setDT(data.analysis_true)[,Drinking.mL.kg_grpsd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_grpsd[[i]]<-Drinking.mL.kg_means_grp$sd[[which(Drinking.mL.kg_means_grp$group_shrt==data.analysis_true$group_shrt[[i]])]]
}

data.analysis_true<-data.analysis_true %>%
  mutate(Drinking.mL.kg_grpmc=as.vector((data.analysis_true$Drinking.sol_m-data.analysis_true$Drinking.mL.kg_grpm)/data.analysis_true$Drinking.mL.kg_grpsd))


## EtOH.gkg Standardized

setDT(data.analysis_true)[,EtOH.gkg_m:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  if(is.na(data.analysis_true$EtOH.gkg[[i]])==FALSE){
  data.analysis_true$EtOH.gkg_m[[i]]<-EtOH.gkg_means$mean[[which(EtOH.gkg_means$Mouse==data.analysis_true$Mouse[[i]])]]
  }
}
setDT(data.analysis_true)[,EtOH.gkg_sd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  if(is.na(data.analysis_true$EtOH.gkg[[i]])==FALSE){
  data.analysis_true$EtOH.gkg_sd[[i]]<-EtOH.gkg_means$sd[[which(EtOH.gkg_means$Mouse==data.analysis_true$Mouse[[i]])]]
  }
}

data.analysis_true<-data.analysis_true %>%
  mutate(EtOH.gkg_imc=as.vector((data.analysis_true$EtOH.gkg-data.analysis_true$EtOH.gkg_m)/data.analysis_true$EtOH.gkg_sd))


setDT(data.analysis_true)[,EtOH.gkg_gmc:=rep(NA,length(row.names(data.analysis_true)))] 

for (i in 1:length(data.analysis_true$FileName)){ 
  if(is.na(data.analysis_true$EtOH.gkg[[i]])==FALSE){
  data.analysis_true$EtOH.gkg_gmc[[i]]<-EtOH.gkg_means$gmc[[which(EtOH.gkg_means$Mouse==data.analysis_true$Mouse[[i]])]]
  }
}

## EtOH Standardized By Sex
setDT(data.analysis_true)[,EtOH.gkg_sm:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){
  if(is.na(data.analysis_true$EtOH.gkg[[i]])==FALSE){
  data.analysis_true$EtOH.gkg_sm[[i]]<-EtOH.gkg_means_sex$mean[[which(EtOH.gkg_means_sex$Sex==data.analysis_true$Sex[[i]])]]
  }
}

setDT(data.analysis_true)[,EtOH.gkg_ssd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$EtOH.gkg_ssd[[i]]<-EtOH.gkg_means_sex$sd[[which(EtOH.gkg_means_sex$Sex==data.analysis_true$Sex[[i]])]]
}

setDT(data.analysis_true)[,EtOH.gkg_smc:=rep(NA,length(row.names(data.analysis_true)))] 

data.analysis_true<-data.analysis_true %>%
  mutate(EtOH.gkg_smc=as.vector((data.analysis_true$EtOH.gkg_m-data.analysis_true$EtOH.gkg_sm)/data.analysis_true$EtOH.gkg_ssd))


#Export Standardization Parameters - Only do once!
# filedesc2<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout StandardizationParams.xlsx"  
# 
# #filedesc2<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout StandardizationParams.xlsx"
# 
# write.xlsx(Drinking.mL.kg_means,file=filedesc2,sheetName = "Drinking.mL.kg",append=TRUE)
# write.xlsx(Drinking.mL.kg_means_sex,file=filedesc2,sheetName = "Drinking.mL.kg_sex",append=TRUE)
# write.xlsx(Drinking.mL.kg_means_grp,file=filedesc2,sheetName = "Drinking.mLkg_grp",append=TRUE)
# write.xlsx(Drinking.sol_means,file=filedesc2,sheetName = "Drinking.sol",append=TRUE)
# write.xlsx(Drinking.sol_means2,file=filedesc2,sheetName = "Drinking.sol2",append=TRUE)
# write.xlsx(EtOH.gkg_means,file=filedesc2,sheetName = "EtOH.gkg",append=TRUE)
# write.xlsx(EtOH.gkg_means_sex,file=filedesc2,sheetName = "EtOH.gkg_smc",append=TRUE)

```


## 2) Do Some Preliminary Checks on Your Variation

```{r}
#Look at within-subject effects to determine how outcome is varying as a function of mouse

#Check Each Mouse's Trends
mouse.data<-data.analysis_true %>%
  filter(Mouse==8,preserve=TRUE)
ggplot(data=mouse.data, aes(x=LickFrequency_imc,y=z2meanbeforeafter,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  labs(title="Mouse 8 (Female)",subtitle="Standardized Signal",x="Lick Frequency", y="Signal (%dF/F)") +
  facet_grid2(session~Solution) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=17, face="bold"),
        axis.title=element_text(size=16,face="bold"),
        axis.text=element_text(size=12),
        strip.text=element_text(size=14))


##Check if enough bouts per session to use as nested variable
groupn_bout<-bout.analysis2_true %>%
  group_by(Sex,Solution,time) %>%
  get_summary_stats(Bout, show=c("n"))

##Check if enough sessions per group to use as nested variable
groupn_session<-bout.analysis2_true %>%
    group_by(Sex,Solution,time,session) %>%
    get_summary_stats(Bout, show=c("n"))
```

## 3) The Unconditional Means Model (UCM)

#### a) z2Mean
```{r}
##To start, we often fit an unconditional means model that provides us information about how much of the total variance in the outcome variable is within-subject variance and how much is between-subject variance. This also allows us to test out which variables are useful control variables.

#Your inter-class correlation (ICC) between Mouse variation leaving within Mouse variation at 1-ICC_0.   

##The regular model0 just tests whether Mouse explains a good portion of the signal without any other factors. The other models test other nested or crossed factors to see which model best fits the data.   

#Model 0z: Just Random Intercept for Mouse, Mouse:session, or session 
model0.0z_fit <- lmerTest::lmer(formula = z2Mean ~ 1 + (1|Mouse),                     data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0z <- as.data.frame(VarCorr(model0.0z_fit))  
ICC_0.0z <- RandomEffects0.0z[1,4]/(RandomEffects0.0z[1,4]+RandomEffects0.0z[2,4])    

model0.0za_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|session),                     data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0za <- as.data.frame(VarCorr(model0.0za_fit))  
ICC_0.0za <- RandomEffects0.0za[1,4]/(RandomEffects0.0za[1,4]+RandomEffects0.0za[2,4])    
model0.0zb_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:session), data=bout.analysis2_true, na.action=na.exclude); 
RandomEffects0.0zb <- as.data.frame(VarCorr(model0.0zb_fit))  
ICC_0.0zb <- RandomEffects0.0zb[1,4]/(RandomEffects0.0zb[1,4]+RandomEffects0.0zb[2,4])   
model0.0zc_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Bout),                  data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0zc <- as.data.frame(VarCorr(model0.0zc_fit))  
ICC_0.0zc <- RandomEffects0.0zc[1,4]/(RandomEffects0.0zc[1,4]+RandomEffects0.0zc[2,4])  

model0.0zd_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|session:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0zd <- as.data.frame(VarCorr(model0.0zd_fit))

ICC_0.0zd <- RandomEffects0.0zd[1,4]/(RandomEffects0.0zd[1,4]+RandomEffects0.0zd[2,4]) 

model0.0ze_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0ze <- as.data.frame(VarCorr(model0.0ze_fit))

ICC_0.0ze <- RandomEffects0.0ze[1,4]/(RandomEffects0.0ze[1,4]+RandomEffects0.0ze[2,4]) 

model0.0zf_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:session:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0zf <- as.data.frame(VarCorr(model0.0zf_fit))

ICC_0.0zf <- RandomEffects0.0zf[1,4]/(RandomEffects0.0zf[1,4]+RandomEffects0.0zf[2,4]) 

#Model 0.1z: Random intercept for fully nested Bout in session in Mouse 
model0.1z_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout), data=bout.analysis2_true,          na.action=na.exclude); 
RandomEffects0.1z <- as.data.frame(VarCorr(model0.1z_fit))  
ICC_0.1z_1 <- RandomEffects0.1z[1,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])  
ICC_0.1z_2 <- RandomEffects0.1z[2,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])  
ICC_0.1z_3 <- RandomEffects0.1z[3,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])

#Model 0.1za: Random intercept for fully nested everything sans Mouse 
model0.1za_fit <- lmerTest::lmer(formula = signal ~ 1+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout),data=bout.analysis2_true,  na.action=na.exclude); 
RandomEffects0.1za <- as.data.frame(VarCorr(model0.1za_fit))  
ICC_0.1za_1 <- RandomEffects0.1za[1,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
ICC_0.1za_2 <- RandomEffects0.1za[2,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
ICC_0.1za_3 <- RandomEffects0.1za[3,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
#ICC_0.1za_4 <- RandomEffects0.1za[4,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4]+RandomEffects0.1za[5,4])    

#Model 0.1zb: Model 0.1z with also both session and bout crossed factors 
model0.1zb_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout)+(1|session),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zb <- as.data.frame(VarCorr(model0.1zb_fit))  
ICC_0.1zb_1 <- RandomEffects0.1zb[1,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_2 <- RandomEffects0.1zb[2,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_3 <- RandomEffects0.1zb[3,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_4 <- RandomEffects0.1zb[4,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])   

#Model 0.1zc: Model 0.1z with also just bout crossed factor 
model0.1zc_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zc <- as.data.frame(VarCorr(model0.1zc_fit))  
ICC_0.1zc_1 <- RandomEffects0.1zc[1,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_2 <- RandomEffects0.1zc[2,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_3 <- RandomEffects0.1zc[3,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_4 <- RandomEffects0.1zc[4,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])   

#Model 0.1zd: Model 0.1z with also just bout crossed factor 
model0.1zd_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|session),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zd <- as.data.frame(VarCorr(model0.1zd_fit))  
ICC_0.1zd_1 <- RandomEffects0.1zd[1,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_2 <- RandomEffects0.1zd[2,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_3 <- RandomEffects0.1zd[3,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_4 <- RandomEffects0.1zd[4,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])   

#Model 0.1ze: Model 0.1zc without Mouse only factor
model0.1ze_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude);  
RandomEffects0.1ze <- as.data.frame(VarCorr(model0.1ze_fit))  
ICC_0.1ze_1 <- RandomEffects0.1ze[1,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  
ICC_0.1ze_2 <- RandomEffects0.1ze[2,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  
ICC_0.1ze_3 <- RandomEffects0.1ze[3,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  

#Model 0.2z: Random intercept for individual nesting within Mouse AND crossed factors 
model0.2z_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|session)+(1|Bout),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.2z <- as.data.frame(VarCorr(model0.2z_fit))  
ICC_0.2z_1 <- RandomEffects0.2z[1,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_2 <- RandomEffects0.2z[2,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_3 <- RandomEffects0.2z[3,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_4 <- RandomEffects0.2z[4,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_5 <- RandomEffects0.2z[5,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  

#Model 0.2za: Model 0.2z without the crossed intercept for session 
model0.2za_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|Bout),               data=bout.analysis2_true,               na.action=na.exclude);  RandomEffects0.2za <- as.data.frame(VarCorr(model0.2za_fit))  
ICC_0.2za_1 <- RandomEffects0.2za[1,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])  
ICC_0.2za_2 <- RandomEffects0.2za[2,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])  
ICC_0.2za_3 <- RandomEffects0.2za[3,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])   
ICC_0.2za_4 <- RandomEffects0.2za[4,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])   

#Model 0.2zb: Model 0.2z but without crossed intercept for bout 
model0.2zb_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|session),               data=bout.analysis2_true,               na.action=na.exclude); 
RandomEffects0.2zb <- as.data.frame(VarCorr(model0.2zb_fit))  
ICC_0.2zb_1 <- RandomEffects0.2zb[1,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])   
ICC_0.2zb_2 <- RandomEffects0.2zb[2,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])  
ICC_0.2zb_3 <- RandomEffects0.2zb[3,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])  
ICC_0.2zb_4 <- RandomEffects0.2zb[4,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])    

#Model 0.2zc - Model 0.2z without either crossed random factor 
model0.2zc_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout),               data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.2zc <- as.data.frame(VarCorr(model0.2zc_fit))  
ICC_0.2zc_1 <- RandomEffects0.2zc[1,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])
ICC_0.2zc_2 <- RandomEffects0.2zc[2,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])
ICC_0.2zc_3 <- RandomEffects0.2zc[3,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4]) 
#ICC_0.2zc_4 <- RandomEffects0.2zc[4,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])  

#Model 0.3z: Random intercept for nested session and mostly crossed bout 
model0.3z_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3z <- as.data.frame(VarCorr(model0.3z_fit))  
ICC_0.3z_1 <- RandomEffects0.3z[1,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4]) 
ICC_0.3z_2 <- RandomEffects0.3z[2,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4]) 
ICC_0.3z_3 <- RandomEffects0.3z[3,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4])  

# Model 0.3za - Model 0.3z with added nesting of Bout and crossed session
model0.3za_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:Bout)+(1|session),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3za <- as.data.frame(VarCorr(model0.3za_fit))  
ICC_0.3za_1 <- RandomEffects0.3za[1,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4])
ICC_0.3za_2 <- RandomEffects0.3za[2,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4])
ICC_0.3za_3 <- RandomEffects0.3za[3,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4]) 
#ICC_0.3za_4 <- RandomEffects0.3za[4,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4]+RandomEffects0.3za[5,4])  

# Model 0.3zb - Model 0.3z with only nested session 
model0.3zb_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3zb <- as.data.frame(VarCorr(model0.3zb_fit))  
ICC_0.3zb_1 <- RandomEffects0.3zb[1,4]/(RandomEffects0.3zb[1,4]+RandomEffects0.3zb[2,4]+RandomEffects0.3zb[3,4]) 
ICC_0.3zb_2 <- RandomEffects0.3zb[2,4]/(RandomEffects0.3zb[1,4]+RandomEffects0.3zb[2,4]+RandomEffects0.3zb[3,4])  

# Model 0.3zc - Model 0.3z with only nested bout 
model0.3zc_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3zc <- as.data.frame(VarCorr(model0.3zc_fit))  
ICC_0.3zc_1 <- RandomEffects0.3zc[1,4]/(RandomEffects0.3zc[1,4]+RandomEffects0.3zc[2,4]+RandomEffects0.3zc[3,4]) 
ICC_0.3zc_2 <- RandomEffects0.3zc[2,4]/(RandomEffects0.3zc[1,4]+RandomEffects0.3zc[2,4]+RandomEffects0.3zc[3,4])  

#Random intercept for fully crossed and completely unnested factors 
model0.4z_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|session)+(1|Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); RandomEffects0.4z <- as.data.frame(VarCorr(model0.4z_fit))   
ICC_0.4z_1 <- RandomEffects0.4z[1,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
ICC_0.4z_2 <- RandomEffects0.4z[2,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
ICC_0.4z_3 <- RandomEffects0.4z[3,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
#ICC_0.4z_4 <- RandomEffects0.4z[4,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4]+RandomEffects0.4z[5,4])   
```



#### b) z2AUC
```{r}
##To start, we often fit an unconditional means model that provides us information about how much of the total variance in the outcome variable is within-subject variance and how much is between-subject variance. This also allows us to test out which variables are useful control variables.

#Your inter-class correlation (ICC) between Mouse variation leaving within Mouse variation at 1-ICC_0.   

##The regular model0 just tests whether Mouse explains a good portion of the signal without any other factors. The other models test other nested or crossed factors to see which model best fits the data.   

#Model 0z: Just Random Intercept for Mouse, Mouse:session, or session 
model0.0z_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse),                     data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0z <- as.data.frame(VarCorr(model0.0z_fit))  
ICC_0.0z <- RandomEffects0.0z[1,4]/(RandomEffects0.0z[1,4]+RandomEffects0.0z[2,4])    

model0.0za_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|session),                     data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0za <- as.data.frame(VarCorr(model0.0za_fit))  
ICC_0.0za <- RandomEffects0.0za[1,4]/(RandomEffects0.0za[1,4]+RandomEffects0.0za[2,4])    
model0.0zb_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse:session), data=bout.analysis2_true, na.action=na.exclude); 
RandomEffects0.0zb <- as.data.frame(VarCorr(model0.0zb_fit))  
ICC_0.0zb <- RandomEffects0.0zb[1,4]/(RandomEffects0.0zb[1,4]+RandomEffects0.0zb[2,4])   
model0.0zc_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Bout),                  data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0zc <- as.data.frame(VarCorr(model0.0zc_fit))  
ICC_0.0zc <- RandomEffects0.0zc[1,4]/(RandomEffects0.0zc[1,4]+RandomEffects0.0zc[2,4])  

model0.0zd_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|session:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0zd <- as.data.frame(VarCorr(model0.0zd_fit))

ICC_0.0zd <- RandomEffects0.0zd[1,4]/(RandomEffects0.0zd[1,4]+RandomEffects0.0zd[2,4]) 

model0.0ze_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0ze <- as.data.frame(VarCorr(model0.0ze_fit))

ICC_0.0ze <- RandomEffects0.0ze[1,4]/(RandomEffects0.0ze[1,4]+RandomEffects0.0ze[2,4]) 

model0.0zf_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse:session:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0zf <- as.data.frame(VarCorr(model0.0zf_fit))

ICC_0.0zf <- RandomEffects0.0zf[1,4]/(RandomEffects0.0zf[1,4]+RandomEffects0.0zf[2,4]) 

#Model 0.1z: Random intercept for fully nested Bout in session in Mouse 
model0.1z_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout), data=bout.analysis2_true,          na.action=na.exclude); 
RandomEffects0.1z <- as.data.frame(VarCorr(model0.1z_fit))  
ICC_0.1z_1 <- RandomEffects0.1z[1,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])  
ICC_0.1z_2 <- RandomEffects0.1z[2,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])  
ICC_0.1z_3 <- RandomEffects0.1z[3,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])

#Model 0.1za: Random intercept for fully nested everything sans Mouse 
model0.1za_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout),data=bout.analysis2_true,  na.action=na.exclude); 
RandomEffects0.1za <- as.data.frame(VarCorr(model0.1za_fit))  
ICC_0.1za_1 <- RandomEffects0.1za[1,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
ICC_0.1za_2 <- RandomEffects0.1za[2,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
ICC_0.1za_3 <- RandomEffects0.1za[3,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
#ICC_0.1za_4 <- RandomEffects0.1za[4,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4]+RandomEffects0.1za[5,4])    

#Model 0.1zb: Model 0.1z with also both session and bout crossed factors 
model0.1zb_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout)+(1|session),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zb <- as.data.frame(VarCorr(model0.1zb_fit))  
ICC_0.1zb_1 <- RandomEffects0.1zb[1,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_2 <- RandomEffects0.1zb[2,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_3 <- RandomEffects0.1zb[3,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_4 <- RandomEffects0.1zb[4,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])   

#Model 0.1zc: Model 0.1z with also just bout crossed factor 
model0.1zc_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zc <- as.data.frame(VarCorr(model0.1zc_fit))  
ICC_0.1zc_1 <- RandomEffects0.1zc[1,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_2 <- RandomEffects0.1zc[2,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_3 <- RandomEffects0.1zc[3,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_4 <- RandomEffects0.1zc[4,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])   

#Model 0.1zd: Model 0.1z with also just bout crossed factor 
model0.1zd_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|session),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zd <- as.data.frame(VarCorr(model0.1zd_fit))  
ICC_0.1zd_1 <- RandomEffects0.1zd[1,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_2 <- RandomEffects0.1zd[2,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_3 <- RandomEffects0.1zd[3,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_4 <- RandomEffects0.1zd[4,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])   

#Model 0.1ze: Model 0.1zc without Mouse only factor
model0.1ze_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude);  
RandomEffects0.1ze <- as.data.frame(VarCorr(model0.1ze_fit))  
ICC_0.1ze_1 <- RandomEffects0.1ze[1,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  
ICC_0.1ze_2 <- RandomEffects0.1ze[2,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  
ICC_0.1ze_3 <- RandomEffects0.1ze[3,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  

#Model 0.2z: Random intercept for individual nesting within Mouse AND crossed factors 
model0.2z_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|session)+(1|Bout),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.2z <- as.data.frame(VarCorr(model0.2z_fit))  
ICC_0.2z_1 <- RandomEffects0.2z[1,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_2 <- RandomEffects0.2z[2,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_3 <- RandomEffects0.2z[3,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_4 <- RandomEffects0.2z[4,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_5 <- RandomEffects0.2z[5,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  

#Model 0.2za: Model 0.2z without the crossed intercept for session 
model0.2za_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|Bout),               data=bout.analysis2_true,               na.action=na.exclude);  RandomEffects0.2za <- as.data.frame(VarCorr(model0.2za_fit))  
ICC_0.2za_1 <- RandomEffects0.2za[1,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])  
ICC_0.2za_2 <- RandomEffects0.2za[2,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])  
ICC_0.2za_3 <- RandomEffects0.2za[3,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])   
ICC_0.2za_4 <- RandomEffects0.2za[4,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])   

#Model 0.2zb: Model 0.2z but without crossed intercept for bout 
model0.2zb_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|session),               data=bout.analysis2_true,               na.action=na.exclude); 
RandomEffects0.2zb <- as.data.frame(VarCorr(model0.2zb_fit))  
ICC_0.2zb_1 <- RandomEffects0.2zb[1,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])   
ICC_0.2zb_2 <- RandomEffects0.2zb[2,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])  
ICC_0.2zb_3 <- RandomEffects0.2zb[3,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])  
ICC_0.2zb_4 <- RandomEffects0.2zb[4,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])    

#Model 0.2zc - Model 0.2z without either crossed random factor 
model0.2zc_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout),               data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.2zc <- as.data.frame(VarCorr(model0.2zc_fit))  
ICC_0.2zc_1 <- RandomEffects0.2zc[1,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])
ICC_0.2zc_2 <- RandomEffects0.2zc[2,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])
ICC_0.2zc_3 <- RandomEffects0.2zc[3,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4]) 
#ICC_0.2zc_4 <- RandomEffects0.2zc[4,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])  

#Model 0.3z: Random intercept for nested session and mostly crossed bout 
model0.3z_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3z <- as.data.frame(VarCorr(model0.3z_fit))  
ICC_0.3z_1 <- RandomEffects0.3z[1,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4]) 
ICC_0.3z_2 <- RandomEffects0.3z[2,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4]) 
ICC_0.3z_3 <- RandomEffects0.3z[3,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4])  

# Model 0.3za - Model 0.3z with added nesting of Bout and crossed session
model0.3za_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|Mouse:Bout)+(1|session),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3za <- as.data.frame(VarCorr(model0.3za_fit))  
ICC_0.3za_1 <- RandomEffects0.3za[1,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4])
ICC_0.3za_2 <- RandomEffects0.3za[2,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4])
ICC_0.3za_3 <- RandomEffects0.3za[3,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4]) 
#ICC_0.3za_4 <- RandomEffects0.3za[4,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4]+RandomEffects0.3za[5,4])  

# Model 0.3zb - Model 0.3z with only nested session 
model0.3zb_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|Mouse:session),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3zb <- as.data.frame(VarCorr(model0.3zb_fit))  
ICC_0.3zb_1 <- RandomEffects0.3zb[1,4]/(RandomEffects0.3zb[1,4]+RandomEffects0.3zb[2,4]+RandomEffects0.3zb[3,4]) 
ICC_0.3zb_2 <- RandomEffects0.3zb[2,4]/(RandomEffects0.3zb[1,4]+RandomEffects0.3zb[2,4]+RandomEffects0.3zb[3,4])  

# Model 0.3zc - Model 0.3z with only nested bout 
model0.3zc_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|Mouse:Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3zc <- as.data.frame(VarCorr(model0.3zc_fit))  
ICC_0.3zc_1 <- RandomEffects0.3zc[1,4]/(RandomEffects0.3zc[1,4]+RandomEffects0.3zc[2,4]+RandomEffects0.3zc[3,4]) 
ICC_0.3zc_2 <- RandomEffects0.3zc[2,4]/(RandomEffects0.3zc[1,4]+RandomEffects0.3zc[2,4]+RandomEffects0.3zc[3,4])  

#Random intercept for fully crossed and completely unnested factors 
model0.4z_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse)+(1|session)+(1|Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); RandomEffects0.4z <- as.data.frame(VarCorr(model0.4z_fit))   
ICC_0.4z_1 <- RandomEffects0.4z[1,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
ICC_0.4z_2 <- RandomEffects0.4z[2,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
ICC_0.4z_3 <- RandomEffects0.4z[3,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
#ICC_0.4z_4 <- RandomEffects0.4z[4,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4]+RandomEffects0.4z[5,4])   
```




#### c) z2TIMEDIFF
```{r}
##To start, we often fit an unconditional means model that provides us information about how much of the total variance in the outcome variable is within-subject variance and how much is between-subject variance. This also allows us to test out which variables are useful control variables.

#Your inter-class correlation (ICC) between Mouse variation leaving within Mouse variation at 1-ICC_0.   

##The regular model0 just tests whether Mouse explains a good portion of the signal without any other factors. The other models test other nested or crossed factors to see which model best fits the data.   

#Model 0z: Just Random Intercept for Mouse, Mouse:session, or session 
model0.0z_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse),                     data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0z <- as.data.frame(VarCorr(model0.0z_fit))  
ICC_0.0z <- RandomEffects0.0z[1,4]/(RandomEffects0.0z[1,4]+RandomEffects0.0z[2,4])    

model0.0za_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|session),                     data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0za <- as.data.frame(VarCorr(model0.0za_fit))  
ICC_0.0za <- RandomEffects0.0za[1,4]/(RandomEffects0.0za[1,4]+RandomEffects0.0za[2,4])    
model0.0zb_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse:session), data=bout.analysis2_true, na.action=na.exclude); 
RandomEffects0.0zb <- as.data.frame(VarCorr(model0.0zb_fit))  
ICC_0.0zb <- RandomEffects0.0zb[1,4]/(RandomEffects0.0zb[1,4]+RandomEffects0.0zb[2,4])   
model0.0zc_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Bout),                  data=bout.analysis2_true,na.action=na.exclude); 
RandomEffects0.0zc <- as.data.frame(VarCorr(model0.0zc_fit))  
ICC_0.0zc <- RandomEffects0.0zc[1,4]/(RandomEffects0.0zc[1,4]+RandomEffects0.0zc[2,4])  

model0.0zd_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|session:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0zd <- as.data.frame(VarCorr(model0.0zd_fit))

ICC_0.0zd <- RandomEffects0.0zd[1,4]/(RandomEffects0.0zd[1,4]+RandomEffects0.0zd[2,4]) 

model0.0ze_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0ze <- as.data.frame(VarCorr(model0.0ze_fit))

ICC_0.0ze <- RandomEffects0.0ze[1,4]/(RandomEffects0.0ze[1,4]+RandomEffects0.0ze[2,4]) 

model0.0zf_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse:session:Bout), 
                   data=bout.analysis2_true,
                   na.action=na.exclude);
RandomEffects0.0zf <- as.data.frame(VarCorr(model0.0zf_fit))

ICC_0.0zf <- RandomEffects0.0zf[1,4]/(RandomEffects0.0zf[1,4]+RandomEffects0.0zf[2,4]) 

#Model 0.1z: Random intercept for fully nested Bout in session in Mouse 
model0.1z_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout), data=bout.analysis2_true,          na.action=na.exclude); 
RandomEffects0.1z <- as.data.frame(VarCorr(model0.1z_fit))  
ICC_0.1z_1 <- RandomEffects0.1z[1,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])  
ICC_0.1z_2 <- RandomEffects0.1z[2,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])  
ICC_0.1z_3 <- RandomEffects0.1z[3,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])

#Model 0.1za: Random intercept for fully nested everything sans Mouse 
model0.1za_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout),data=bout.analysis2_true,  na.action=na.exclude); 
RandomEffects0.1za <- as.data.frame(VarCorr(model0.1za_fit))  
ICC_0.1za_1 <- RandomEffects0.1za[1,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
ICC_0.1za_2 <- RandomEffects0.1za[2,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
ICC_0.1za_3 <- RandomEffects0.1za[3,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
#ICC_0.1za_4 <- RandomEffects0.1za[4,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4]+RandomEffects0.1za[5,4])    

#Model 0.1zb: Model 0.1z with also both session and bout crossed factors 
model0.1zb_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout)+(1|session),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zb <- as.data.frame(VarCorr(model0.1zb_fit))  
ICC_0.1zb_1 <- RandomEffects0.1zb[1,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_2 <- RandomEffects0.1zb[2,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_3 <- RandomEffects0.1zb[3,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_4 <- RandomEffects0.1zb[4,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])   

#Model 0.1zc: Model 0.1z with also just bout crossed factor 
model0.1zc_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zc <- as.data.frame(VarCorr(model0.1zc_fit))  
ICC_0.1zc_1 <- RandomEffects0.1zc[1,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_2 <- RandomEffects0.1zc[2,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_3 <- RandomEffects0.1zc[3,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_4 <- RandomEffects0.1zc[4,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])   

#Model 0.1zd: Model 0.1z with also just bout crossed factor 
model0.1zd_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|session),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.1zd <- as.data.frame(VarCorr(model0.1zd_fit))  
ICC_0.1zd_1 <- RandomEffects0.1zd[1,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_2 <- RandomEffects0.1zd[2,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_3 <- RandomEffects0.1zd[3,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_4 <- RandomEffects0.1zd[4,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])   

#Model 0.1ze: Model 0.1zc without Mouse only factor
model0.1ze_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude);  
RandomEffects0.1ze <- as.data.frame(VarCorr(model0.1ze_fit))  
ICC_0.1ze_1 <- RandomEffects0.1ze[1,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  
ICC_0.1ze_2 <- RandomEffects0.1ze[2,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  
ICC_0.1ze_3 <- RandomEffects0.1ze[3,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  

#Model 0.2z: Random intercept for individual nesting within Mouse AND crossed factors 
model0.2z_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|session)+(1|Bout),                data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.2z <- as.data.frame(VarCorr(model0.2z_fit))  
ICC_0.2z_1 <- RandomEffects0.2z[1,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_2 <- RandomEffects0.2z[2,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_3 <- RandomEffects0.2z[3,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_4 <- RandomEffects0.2z[4,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_5 <- RandomEffects0.2z[5,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  

#Model 0.2za: Model 0.2z without the crossed intercept for session 
model0.2za_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|Bout),               data=bout.analysis2_true,               na.action=na.exclude);  RandomEffects0.2za <- as.data.frame(VarCorr(model0.2za_fit))  
ICC_0.2za_1 <- RandomEffects0.2za[1,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])  
ICC_0.2za_2 <- RandomEffects0.2za[2,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])  
ICC_0.2za_3 <- RandomEffects0.2za[3,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])   
ICC_0.2za_4 <- RandomEffects0.2za[4,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])   

#Model 0.2zb: Model 0.2z but without crossed intercept for bout 
model0.2zb_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|session),               data=bout.analysis2_true,               na.action=na.exclude); 
RandomEffects0.2zb <- as.data.frame(VarCorr(model0.2zb_fit))  
ICC_0.2zb_1 <- RandomEffects0.2zb[1,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])   
ICC_0.2zb_2 <- RandomEffects0.2zb[2,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])  
ICC_0.2zb_3 <- RandomEffects0.2zb[3,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])  
ICC_0.2zb_4 <- RandomEffects0.2zb[4,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])    

#Model 0.2zc - Model 0.2z without either crossed random factor 
model0.2zc_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout),               data=bout.analysis2_true,               na.action=na.exclude);  
RandomEffects0.2zc <- as.data.frame(VarCorr(model0.2zc_fit))  
ICC_0.2zc_1 <- RandomEffects0.2zc[1,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])
ICC_0.2zc_2 <- RandomEffects0.2zc[2,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])
ICC_0.2zc_3 <- RandomEffects0.2zc[3,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4]) 
#ICC_0.2zc_4 <- RandomEffects0.2zc[4,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])  

#Model 0.3z: Random intercept for nested session and mostly crossed bout 
model0.3z_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3z <- as.data.frame(VarCorr(model0.3z_fit))  
ICC_0.3z_1 <- RandomEffects0.3z[1,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4]) 
ICC_0.3z_2 <- RandomEffects0.3z[2,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4]) 
ICC_0.3z_3 <- RandomEffects0.3z[3,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4])  

# Model 0.3za - Model 0.3z with added nesting of Bout and crossed session
model0.3za_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|Mouse:Bout)+(1|session),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3za <- as.data.frame(VarCorr(model0.3za_fit))  
ICC_0.3za_1 <- RandomEffects0.3za[1,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4])
ICC_0.3za_2 <- RandomEffects0.3za[2,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4])
ICC_0.3za_3 <- RandomEffects0.3za[3,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4]) 
#ICC_0.3za_4 <- RandomEffects0.3za[4,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4]+RandomEffects0.3za[5,4])  

# Model 0.3zb - Model 0.3z with only nested session 
model0.3zb_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|Mouse:session),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3zb <- as.data.frame(VarCorr(model0.3zb_fit))  
ICC_0.3zb_1 <- RandomEffects0.3zb[1,4]/(RandomEffects0.3zb[1,4]+RandomEffects0.3zb[2,4]+RandomEffects0.3zb[3,4]) 
ICC_0.3zb_2 <- RandomEffects0.3zb[2,4]/(RandomEffects0.3zb[1,4]+RandomEffects0.3zb[2,4]+RandomEffects0.3zb[3,4])  

# Model 0.3zc - Model 0.3z with only nested bout 
model0.3zc_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|Mouse:Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); 
RandomEffects0.3zc <- as.data.frame(VarCorr(model0.3zc_fit))  
ICC_0.3zc_1 <- RandomEffects0.3zc[1,4]/(RandomEffects0.3zc[1,4]+RandomEffects0.3zc[2,4]+RandomEffects0.3zc[3,4]) 
ICC_0.3zc_2 <- RandomEffects0.3zc[2,4]/(RandomEffects0.3zc[1,4]+RandomEffects0.3zc[2,4]+RandomEffects0.3zc[3,4])  

#Random intercept for fully crossed and completely unnested factors 
model0.4z_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse)+(1|session)+(1|Bout),                       data=bout.analysis2_true,                      na.action=na.exclude); RandomEffects0.4z <- as.data.frame(VarCorr(model0.4z_fit))   
ICC_0.4z_1 <- RandomEffects0.4z[1,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
ICC_0.4z_2 <- RandomEffects0.4z[2,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
ICC_0.4z_3 <- RandomEffects0.4z[3,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
#ICC_0.4z_4 <- RandomEffects0.4z[4,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4]+RandomEffects0.4z[5,4])   
```


### c) (Info) Interpretation of Model Performance

Remember as you read these that you can't rule out that there would be some other model that fits your data better - these values only test the relative chance that models you've proposed describe your data.

#### i) ICC

The first measure we got from different model structures was intra-class correlation (ICC). ICC tells us how much variance is explained by the particular cluster (and each cluster is broken down in the different models). Think of this like the R2 of a regression line. It is the percent correlation between the variables. In MLM/LMM, you want your ICC to be high enough that clustering matters (maybe over 10%?) but not SO high that it explains ALL of the variance in the data, leaving nothing for your between subject fixed factors (i.e. your main variables of interest) to explain anything. There is too much of a good thing in this case. It is very subjective, however, in terms of what a "good ICC" is. If you'd be impressed if your data had that value as an R2, it might be worth using the MLM/LMM approach. What this code generates is the "variation/clustering" captured by ICC-within (since all our random vars are within-subject) that your other variables of interest can try to explain. Thus, the higher ICC-within, the better as long as 1 minus the ICC (ICC-between) is still a large enough proportion to warrant further probing with your fixed factors.

#### ii) Log Likelihood, BIC, & AIC

The next measures we have are some measures of overall model fit to the data from log likelihood (logLik), "consistency" from Bayesian Information Criterion (BIC) and "efficiency" from Akaike Information Criterion (AIC). LogLik looks at fit simply whereas AIC tries to get the best fit with the least number of parameters (parsimony). BIC uses the fact that larger sample sizes most likely represent the "true model" to see how consistently new data fits into the model. There are two critical things to know about these measures: 1) they are all relative measures - they don't mean anything by themselves and are only useful when comparing different models and 2) because of they way they are computed, AIC and BIC indicate "better fit" when they are LOWER but loglikelihood indicates "better fit" when it is HIGHER.

From UNCDependLab on how much difference is a lot of difference: "Summarizing extensive simulation work, Burnham and Anderson (2002) offer useful rules-of-thumb for inferring the degree of certainty afforded to a particular model relative to the best fitting model in the set:

-   models within 0--2 points on the AIC also have substantial support

-   models in the 4--7 point range have considerably less support

-   models greater than 10 points apart have almost no support."

#### iii) Log-Likelihood Ratio Test (LRT)

Finally, we have the LRT which basically uses statistics to see if dropping a variable to the model significantly changes the fit of the model. Just one more piece to the puzzle. If you can drop a parameter from the model and it not change it, it's best to just drop it in favor of parsimony.

### d) Export UCM Results to Excel

```{r}
#Write these models, RandomEffects, and ICCs to an Excel spreadsheet 
ICCs<-ls(envir=.GlobalEnv, pattern="ICC_0") 
ICC<-data.frame(mget(ICCs),row.names="Values") 
ICC<-t(ICC) 
ICC[,"Values"]<-round(ICC[,"Values"],3)   
##TO-DO: Eventually want to add the variable names next to their ICC

models<-ls(envir=.GlobalEnv,pattern="model0") 
models.call<-lapply(mget(models),get_call) 
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))   
model.obs<-NULL 
model.obs.df<-NULL 

for(k in models){
  obs<-sapply(ranef(get(k)),nrow)   
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs))) 
  model.obs.df<-rbind(model.obs.df,model.obs) 
  }  

model.info<-merge(models.call.df,model.obs.df)  
LLR<-NULL 
LLR.df<-NULL 
for(k in models){ 
  LLR<-data.frame("Model"=k,rand(get(k)))  
  LLR.df<-rbind(LLR.df,LLR) 
  }   
write.xlsx(model.info,file=filemod2, sheetName = "UCM TIMEDIFF Info", append=TRUE, row.names=FALSE) 
write.xlsx(ICC,file=filemod2, sheetName = "UCM TIMEDIFF ICC", append=TRUE, row.names=TRUE) 

write.xlsx(LLR.df,file=filemod2, sheetName = "UCM TIMEDIFF LLR", append=TRUE, row.names=TRUE)  
summary<-modelsummary::msummary(mget(models),stars=T, output="data.frame") 
write.xlsx(summary,file=filemod2, sheetName = "UCM TIMEDIFF Compare", append=TRUE, row.names=FALSE)  
rands<-ls(envir=.GlobalEnv,pattern="RandomEffects0") 
random<-NULL 
random.df<-NULL 
for(k in rands){ 
  names<-names(get(k)) 
  random<-cbind("Model"=k,get(k))  
  random.df<-merge(random.df,random,by=intersect(names(random.df),names(random)),all=TRUE) 
  }  
random.df<-sort.data.frame(random.df,by="var1",na.last=TRUE) #puts residuals at bottom and decreasing complexity of terms for easy viewing  

write.xlsx(random.df,file=filemod2, sheetName = "UCM TIMEDIFF Var", append=TRUE, row.names=FALSE)  

#Optional: Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
#plotREsim(REsim(model0.1ze_fit),labs=TRUE) 

##You can also check to see if your similar models are significantly different from each other from an ANOVA 
#anova(model0.3z_fit, model0.3za_fit)
```

## 4) Mixed Model Omnibus Analysis

### a) Info & Level 1 Model

#### i) Fit Models

######II) z2Mean
```{r}
##ONCE YOU DECIDE ON YOUR FINAL MODEL, THEN PROCEED##

##So what I'm thinking is that the models I want to test are (Standardized and Unstandardized): 

#Simple: 
#model0.0b_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:session),data=bout.analysis2_true,na.action=na.exclude);
#model0.0zf_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:session:Bout),data=bout.analysis2_true,na.action=na.exclude);

#Complex:
#model0.1ze_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude);  
#model0.3_fit <- lmerTest::lmer(forumla= signal ~ 1 + (1|Mouse) + (1|Mouse:session) + (1|Bout), data=bout.analysis2_true, na.action=na.exclude);

## Patrick ran in SAS code using the PROC MIXED function and specified the MODEL PeakAfter= Solution|Sex/solution("the /solution" refers to options that will display the fixed-effect parameter estimates. This formula is equivalent to ## Solution Sex Solution*Sex - two main effects and an interaction), REPEATED /subject=Mouse which is the same as treating Mouse as a random effect except that it isn't constrained to be a positive correlation) and LSMEANS Solution Sex Solution*Sex/tdiff ("/tdiff is an option that makes it display the t-values in a comparison between LSMEAN estimates). We can do the same thing with the emmeans package. See supporting documents.

#In the Step-Up strategy for model building used here, we next add in Level 1 covariates and consider adding in random effects for these variables to Level 2 during the next step. I have chosen to fit both the "basic model" (0.0/0.0z) with data simply nested within Mouse, and the selected random effect model 0.3/0.3z to allow us to determine whether this more complex linear mixed modeling/multilevel modeling is worth the hassle (i.e. does it change any effects).


model1.0_fit <- lmerTest::lmer(formula = signal ~ time + (1|Mouse:session),data=bout.analysis2_true,na.action=na.exclude)

model1.3_fit<-lmerTest::lmer(formula= signal ~ time + (1|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude)

model1.0z_fit <- lmerTest::lmer(formula = signal ~ time + (1|Mouse:session:Bout),data=bout.analysis2_true,na.action=na.exclude);

model1.1z_fit <- lmerTest::lmer(formula = signal ~ time + (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude)  


```

######II) z2AUC
```{r}
##ONCE YOU DECIDE ON YOUR FINAL MODEL, THEN PROCEED##

##So what I'm thinking is that the models I want to test are: 

#Simple: 
#model0.0b_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse),data=bout.analysis2_true,na.action=na.exclude);
#model0.0zf_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1 + (1|Mouse:session:Bout),data=bout.analysis2_true,na.action=na.exclude);

#Complex:
#model0.1ze_fit <- lmerTest::lmer(formula = z2AUC15 ~ 1+ (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude);  

#model0.1za_fit <-

## Patrick ran in SAS code using the PROC MIXED function and specified the MODEL PeakAfter= Solution|Sex/solution("the /solution" refers to options that will display the fixed-effect parameter estimates. This formula is equivalent to ## Solution Sex Solution*Sex - two main effects and an interaction), REPEATED /subject=Mouse which is the same as treating Mouse as a random effect except that it isn't constrained to be a positive correlation) and LSMEANS Solution Sex Solution*Sex/tdiff ("/tdiff is an option that makes it display the t-values in a comparison between LSMEAN estimates). We can do the same thing with the emmeans package. See supporting documents.

#In the Step-Up strategy for model building used here, we next add in Level 1 covariates and consider adding in random effects for these variables to Level 2 during the next step. I have chosen to fit both the "basic model" (0.0/0.0z) with data simply nested within Mouse, and the selected random effect model 0.3/0.3z to allow us to determine whether this more complex linear mixed modeling/multilevel modeling is worth the hassle (i.e. does it change any effects).


model1.0_fit <- lmerTest::lmer(formula = z2AUC15 ~ time + (1|Mouse),data=bout.analysis2_true,na.action=na.exclude);

model1.1_fit<-lmerTest::lmer(formula = z2AUC15 ~ time + (1|Mouse:session:Bout),data=bout.analysis2_true,na.action=na.exclude);

model1.2_fit <- lmerTest::lmer(formula = z2AUC15 ~ time + (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude)  

model1.3_fit <- lmerTest::lmer(formula = z2AUC15 ~ time + (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude)  

```

######II) z2TIMEDIFF
```{r}
##ONCE YOU DECIDE ON YOUR FINAL MODEL, THEN PROCEED##

##So what I'm thinking is that the models I want to test are: 

#Simple: 
#model0.0zb_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse:session),data=bout.analysis2_true,na.action=na.exclude);
#model0.0zf_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1 + (1|Mouse:session:Bout),data=bout.analysis2_true,na.action=na.exclude);

#Complex:
#model0.1ze_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ 1+ (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude);  


## Patrick ran in SAS code using the PROC MIXED function and specified the MODEL PeakAfter= Solution|Sex/solution("the /solution" refers to options that will display the fixed-effect parameter estimates. This formula is equivalent to ## Solution Sex Solution*Sex - two main effects and an interaction), REPEATED /subject=Mouse which is the same as treating Mouse as a random effect except that it isn't constrained to be a positive correlation) and LSMEANS Solution Sex Solution*Sex/tdiff ("/tdiff is an option that makes it display the t-values in a comparison between LSMEAN estimates). We can do the same thing with the emmeans package. See supporting documents.

#In the Step-Up strategy for model building used here, we next add in Level 1 covariates and consider adding in random effects for these variables to Level 2 during the next step. I have chosen to fit both the "basic model" (0.0/0.0z) with data simply nested within Mouse, and the selected random effect model 0.3/0.3z to allow us to determine whether this more complex linear mixed modeling/multilevel modeling is worth the hassle (i.e. does it change any effects).


model1.0_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time + (1|Mouse:session),data=bout.analysis2_true,na.action=na.exclude);

model1.1_fit<-lmerTest::lmer(formula = z2TIMEDIFF ~ time + (1|Mouse:session:Bout),data=bout.analysis2_true,na.action=na.exclude);

model1.2_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time + (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude)  


```


#### ii) Gather Model Summaries (for Export)

```{r}
models1<-ls(envir=.GlobalEnv,pattern="model1")
models.call<-lapply(mget(models1),get_call)
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))


model.obs<-NULL
model.obs.df<-NULL
for(k in models1){
obs<-sapply(ranef(get(k)),nrow)  
model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))
model.obs.df<-rbind(model.obs.df,model.obs)
}

model.info<-merge(models.call.df,model.obs.df)


summary<-modelsummary::msummary(mget(models1),stars=T,output="data.frame")
```

#### iii) (Optional) Plot Effects and Interactions**

```{r}
# ##Make plots & tables to probe interactions - IMPORTANT to do this BEFORE you refit models using REML=FALSE in next step which will change estimates slightly. MOI = "Model of interest" 

#moi<-model1.0_fit
#moi<-model1.3_fit
moi<-model1.2_fit

sjPlot::tab_model(moi,
                   show.re.var= TRUE,
                   pred.labels =c("(Intercept)", "Time"),
                   dv.labels= "Effects of Variables on Signal")
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

```

#### iv) Make Model Comparisons

```{r}
#To compare the two models - UCM and Lvl1, we need to refit all models using REML=FALSE. It is easier to let the function do this and ignore the warnings than to redo the models. 

#Note that these comparisons are ONLY valid if both models have the same # of observations as their UCM counterparts!
model.0_anova<-anova(model0.0zb_fit,model1.0_fit)
model.1_anova<-anova(model0.0zf_fit,model1.1_fit)

model.2_anova<-anova(model0.1ze_fit,model1.2_fit)



LLR<-rbind(model.0_anova,model.1_anova,model.2_anova)
```

#### v) Export Model Summaries and Comparisons to Excel

```{r}
#FYI sometimes the first Excel file is still processing when the second tries to run and it will error. Just run the code again by line.

write.xlsx(model.info,file=filemod2, sheetName = "Lvl1 TimeD Info", append=TRUE, row.names=FALSE)

write.xlsx(LLR,file=filemod2, sheetName = "Lvl1 TimeD LLR", append=TRUE, row.names=TRUE)

write.xlsx(summary,file=filemod2, sheetName = "Lvl1 TimeD Compare", append=TRUE, row.names=FALSE)
```

### b) Level 2 Model
#### i) Fit Models

##### z2Mean

##### z2AUC

```{r}
#In the Step-Up strategy for model building used here, we next add in Level 2 covariates and consider adding in random effects for these variables to Level 3 during the next step. All of these models now include time as a random slope because we are looking at cross-level effects. See Heisig and Schaeffer 2019 for why this is true. (Also as a side note, when I did early comparisons between models including time as a random slope and not, the fit JUMPED higher. So it definitely fits the data but tested the addition here before incorporating all of the Lvl 2 measures)


model2.0_fit <- lmerTest::lmer(formula = z2AUC15 ~ time + (1+time|Mouse:session:Bout),data=bout.analysis2_true,na.action=na.exclude);

model2.1_fit <- lmerTest::lmer(formula = z2AUC15 ~ time + (1+time|Mouse),data=bout.analysis2_true,na.action=na.exclude);

#Since including time slope made 2.2 not converge, carrying forward Model 1.0za as 2.3
model2.2_fit<-lmerTest::lmer(formula= z2AUC15 ~ time + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

model2.2_fitalt1<-lmerTest::lmer(formula= z2AUC15 ~ time + (1+time|Mouse)+(1+time|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

model2.2_fitalt2<-lmerTest::lmer(formula= z2AUC15 ~ time + (1+time|Mouse)+(1|Mouse:session)+(1+time|Bout),data=bout.analysis2_true, na.action=na.exclude);

model2.2_fitalt3<-lmerTest::lmer(formula= z2AUC15 ~ time + (1+time|Mouse)+(1+time|Mouse:session)+(1+time|Bout),data=bout.analysis2_true, na.action=na.exclude);

model2.2_fitalt4<-lmerTest::lmer(formula= z2AUC15 ~ time + (1|Mouse)+(1+time|Mouse:session)+(1+time|Bout),data=bout.analysis2_true, na.action=na.exclude);

model2.2_fitalt5<-lmerTest::lmer(formula= z2AUC15 ~ time + (1|Mouse)+(1|Mouse:session)+(1+time|Bout),data=bout.analysis2_true, na.action=na.exclude);

model2.2_fitalt6<-lmerTest::lmer(formula= z2AUC15 ~ time + (1|Mouse)+(1+time|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);


model2.3_fit <- lmerTest::lmer(formula = z2AUC15 ~ time + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 

model2.3_fitalt1 <- lmerTest::lmer(formula = z2AUC15 ~ time + (1+time|Mouse:session)+(1+time|Mouse:session:Bout)+(1|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 

model2.3_fitalt2 <- lmerTest::lmer(formula = z2AUC15 ~ time + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1+time|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 

model2.3_fitalt3 <- lmerTest::lmer(formula = z2AUC15 ~ time + (1+time|Mouse:session)+(1+time|Mouse:session:Bout)+(1+time|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 

model2.3_fitalt4 <- lmerTest::lmer(formula = z2AUC15 ~ time + (1|Mouse:session)+(1+time|Mouse:session:Bout)+(1+time|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 

model2.3_fitalt5 <- lmerTest::lmer(formula = z2AUC15 ~ time + (1|Mouse:session)+(1|Mouse:session:Bout)+(1+time|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 

model2.3_fitalt6 <- lmerTest::lmer(formula = z2AUC15 ~ time + (1|Mouse:session)+(1+time|Mouse:session:Bout)+(1|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude);


# model2.0a_fit <-lmerTest::lmer(formula= signal ~ time * Duration_imc * LickFrequency_imc * BoutStarts_imc * LicksPerBout_imc + (1+time|Mouse:session),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0a_fit <-lmerTest::lmer(formula= signal ~ time *Duration_imc *LickFrequency_imc * BoutStarts_imc + (1+time|Mouse:session),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0b_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc *LickFrequency_imc * LicksPerBout_imc + (1+time|Mouse:session),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0c_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc * Duration_imc * LicksPerBout_imc + (1+time|Mouse:session),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0d_fit <-lmerTest::lmer(formula= signal ~ time * Duration_imc + (1+time|Mouse:session),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0e_fit <-lmerTest::lmer(formula= signal ~ time * LickFrequency_imc + (1+time|Mouse:session),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0f_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0g_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0h_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * BoutStarts_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0i_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * Duration_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0j_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * LickFrequency_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0k_fit <-lmerTest::lmer(formula= signal ~ time *LickFrequency_imc * BoutStarts_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0l_fit <-lmerTest::lmer(formula= signal ~ time *LickFrequency_imc * Duration_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0m_fit <-lmerTest::lmer(formula= signal ~ time *BoutStarts_imc * Duration_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# 
# model2.3_fit <-lmerTest::lmer(formula= signal ~ time * Duration_imc * LickFrequency_imc * BoutStarts_imc * LicksPerBout_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3a_fit <-lmerTest::lmer(formula= signal ~ time *Duration_imc *LickFrequency_imc * BoutStarts_imc +(1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3b_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc *LickFrequency_imc * LicksPerBout_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3c_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc * Duration_imc * LicksPerBout_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3d_fit <-lmerTest::lmer(formula= signal ~ time * Duration_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3e_fit <-lmerTest::lmer(formula= signal ~ time * LickFrequency_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3f_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3g_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3h_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * BoutStarts_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3i_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * Duration_imc +(1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3j_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * LickFrequency_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3k_fit <-lmerTest::lmer(formula= signal ~ time *LickFrequency_imc * BoutStarts_imc +(1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3l_fit <-lmerTest::lmer(formula= signal ~ time *LickFrequency_imc * Duration_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3m_fit <-lmerTest::lmer(formula= signal ~ time *BoutStarts_imc * Duration_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# 
# 
# 
# model2.0z_fit <-lmerTest::lmer(formula= signal ~ time * Duration_imc * LickFrequency_imc * BoutStarts_imc * LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0za_fit <-lmerTest::lmer(formula= signal ~ time *Duration_imc *LickFrequency_imc * BoutStarts_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zb_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc *LickFrequency_imc * LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zc_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc * Duration_imc * LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zd_fit <-lmerTest::lmer(formula= signal ~ time * Duration_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0ze_fit <-lmerTest::lmer(formula= signal ~ time * LickFrequency_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zf_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zg_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zh_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * BoutStarts_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zi_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * Duration_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zj_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * LickFrequency_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zk_fit <-lmerTest::lmer(formula= signal ~ time *LickFrequency_imc * BoutStarts_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zl_fit <-lmerTest::lmer(formula= signal ~ time *LickFrequency_imc * Duration_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.0zm_fit <-lmerTest::lmer(formula= signal ~ time *BoutStarts_imc * Duration_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);
# 
# 
# 
# model2.3z_fit <-lmerTest::lmer(formula= signal ~ time * Duration_imc * LickFrequency_imc * BoutStarts_imc * LicksPerBout_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3za_fit <-lmerTest::lmer(formula= signal ~ time *Duration_imc *LickFrequency_imc * BoutStarts_imc +(1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zb_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc *LickFrequency_imc * LicksPerBout_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zc_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc * Duration_imc * LicksPerBout_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zd_fit <-lmerTest::lmer(formula= signal ~ time * Duration_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3ze_fit <-lmerTest::lmer(formula= signal ~ time * LickFrequency_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zf_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zg_fit <-lmerTest::lmer(formula= signal ~ time * BoutStarts_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zh_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * BoutStarts_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zi_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * Duration_imc +(1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zj_fit <-lmerTest::lmer(formula= signal ~ time *LicksPerBout_imc * LickFrequency_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zk_fit <-lmerTest::lmer(formula= signal ~ time *LickFrequency_imc * BoutStarts_imc +(1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zl_fit <-lmerTest::lmer(formula= signal ~ time *LickFrequency_imc * Duration_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
# 
# model2.3zm_fit <-lmerTest::lmer(formula= signal ~ time *BoutStarts_imc * Duration_imc + (1+time|Mouse)+(1|Mouse:session)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
```

##### z2TIMEDIFF

```{r}
#In the Step-Up strategy for model building used here, we next add in Level 2 covariates and consider adding in random effects for these variables to Level 3 during the next step. All of these models now include time as a random slope because we are looking at cross-level effects. See Heisig and Schaeffer 2019 for why this is true. (Also as a side note, when I did early comparisons between models including time as a random slope and not, the fit JUMPED higher. So it definitely fits the data but tested the addition here before incorporating all of the Lvl 2 measures)


model2.0_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time + (1+time|Mouse:session),data=bout.analysis2_true,na.action=na.exclude);

model2.1_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time + (1+time|Mouse:session:Bout),data=bout.analysis2_true,na.action=na.exclude);

model2.2_fit<-lmerTest::lmer(formula= z2TIMEDIFF ~ time + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);


```

#### ii) Gather Model Summaries (for Export)

```{r}
models2<-ls(envir=.GlobalEnv,pattern="model2")
models.call<-lapply(mget(models2),get_call)
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))


model.obs<-NULL
model.obs.df<-NULL
for(k in models2){
obs<-sapply(ranef(get(k)),nrow)  
model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))
model.obs.df<-rbind(model.obs.df,model.obs)
}

model.info<-merge(models.call.df,model.obs.df)


summary<-modelsummary::msummary(mget(models2),stars=T,output="data.frame")
```

#### iii) (Optional) Plot Effects and Interactions

```{r}
# ##Make plots & tables to probe interactions - IMPORTANT to do this BEFORE you refit models using REML=FALSE in next step which will change estimates slightly. MOI = "Model of interest" 

moi<-model2.0zi_fit

# sjPlot::tab_model(moi,
#                    show.re.var= TRUE,
#                    pred.labels =c("(Intercept)", "Time","Indv Duration","Indv Lick Freq","Time x Indv Duration", "Time x Indv Lick Freq", "Indv Duration x Indv Lick Freq", "Time x Indv Duration x Indv Lick Freq"), dv.labels= "Effects of Variables on Signal")

sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Create Reference Grid for Estimated Marginal Means - Allows you to see what levels of multiple variables do to the dependent variable
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(LicksPerBout_imc=c(-1,0,2,4), Duration_imc=c(-1,0,3.5,6)))

# Plot specific interactions
emmip(RG, LicksPerBout_imc ~ Duration_imc | time, style = "factor", CIs=TRUE)
```

#### iv) Make Model Comparisons

```{r}
#To compare models - Lvl1 and Lvl2 and Lvl2 to Lvl2, we need to refit candidate models using REML=F. Easiest to let the fuction below do it automatically and just ignore the warnings of it doing so. 

#Note that these comparisons are ONLY valid if both models have the same # of observations as their UCM counterparts!
model.0_anova<-anova(model1.0_fit,model2.0_fit)
model.1_anova<-anova(model1.1_fit,model2.1_fit)
model.2_anova<-anova(model1.2_fit,model2.2_fit)

LLR<-rbind(model.0_anova,model.1_anova,model.2_anova)
```

#### v) Export Model Summaries and Comparisons

```{r}
write.xlsx(LLR,file=filemod2, sheetName = "Lvl2 TImeD LLR", append=TRUE, row.names=TRUE)

write.xlsx(model.info,file=filemod2, sheetName = "Lvl2 TimeD Info", append=TRUE, row.names=FALSE)

write.xlsx(summary,file=filemod2, sheetName = "Lvl2 TimeD Compare", append=TRUE, row.names=FALSE)
```

### c) Level 3 Model

#### i) Fit Models
##### z2AUC
```{r}
#In the Step-Up strategy for model building used here, we next add in Level 3 covariates and consider adding in random effects for these variables to Level 4 during the next step. The model we selected at level 2 was model 2.3.

#Simple - without Time random var since none worked well
model3.0_fit <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex + (1|Mouse:session), data=bout.analysis2_true, na.action=na.exclude); 

model3.1_fit <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex + (1|Mouse:session:Bout), data=bout.analysis2_true, na.action=na.exclude); 

#Complex - only 3.3 has time as random variable
model3.2_fit <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex + (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude); 

model3.3_fit <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 



```

##### z2TIMEDIFF
```{r}
#In the Step-Up strategy for model building used here, we next add in Level 3 covariates and consider adding in random effects for these variables to Level 4 during the next step. The model we selected at level 2 was model 2.3.

#Simple - without Time random var since none worked well
model3.0_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time*Sex + (1+time|Mouse:session), data=bout.analysis2_true, na.action=na.exclude); 

model3.1_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time*Sex + (1+time|Mouse:session:Bout), data=bout.analysis2_true, na.action=na.exclude); 

#Complex - only 3.3 has time as random variable
model3.2_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time*Sex + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude); 


```


#### ii) Gather Model Summaries (for Export)

```{r}
models3<-ls(envir=.GlobalEnv,pattern="model3") 
models.call<-lapply(mget(models3),get_call) 
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))   

model.obs<-NULL 
model.obs.df<-NULL 

for(k in models3){ 
  obs<-sapply(ranef(get(k)),nrow)   
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs))) 
  model.obs.df<-rbind(model.obs.df,model.obs) 
}  

model.info<-merge(models.call.df,model.obs.df)

summary<-modelsummary::msummary(mget(models3),stars=T,output="data.frame")
```

#### iii) (Optional) Plot Effects and Interactions

```{r}

moi<-model3.3_fit

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(EtOH.gkg_gmc=c(-1,0,2,4),EtOH.gkg_imc=c(-1,0,1)))

             
# Plot specific interactions
emmip(RG, Solution*Drinking.mL.kg_imc ~ LicksPerBout_imc*LicksPerBout_gmc | time, style = "factor", CIs=TRUE)+ facet_wrap(time~Solution)

```

#### iv) Make Model Comparisons

```{r}
#To compare the two models - Lvl2 & Lvl3, we need to refit all models using REML=F. Easiest to let the below function automatically refit and to ignore the warnings that it is doing this. 

#Note that these comparisons are ONLY valid if both models have the same # of observations as their counterparts! 

model.0_anova<-anova(model2.0_fit,model3.0_fit) 
model.1_anova<-anova(model2.1_fit,model3.1_fit) 
model.2_anova<-anova(model2.2_fit,model3.2_fit) 


LLR<-rbind(model.0_anova,model.1_anova,model.2_anova)    
```

#### v) Export Model Summaries and Comparisons

```{r}
write.xlsx(model.info,file=filemod2, sheetName = "Lvl3 TimeD Info", append=TRUE, row.names=FALSE)

write.xlsx(summary,file=filemod2, sheetName = "Lvl3 TimeD Compare", append=TRUE, row.names=FALSE)

write.xlsx(LLR,file=filemod2, sheetName = "Lvl3 TimeD LLR", append=TRUE, row.names=TRUE) 

```

### d) Level 4 Model

#### i) Fit Models

##### z2AUC
```{r}
#In the Step-Up strategy for model building, we next add in Level 4 covariates. The best model at level 3 was not clear so using the select candidates 3.3, 3.3e, and 3.0 and 3.0c.    

#Simple - without Time random var since none worked well
model4.0_fit <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex*Solution + (1|Mouse), data=bout.analysis2_true, na.action=na.exclude); 

model4.1_fit <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex*Solution + (1|Mouse:session:Bout), data=bout.analysis2_true, na.action=na.exclude); 

#Complex - only 3.3 has time as random variable
model4.2_fit <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex*Solution + (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude); 

model4.3_fit <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex*Solution + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 

model4.3_fitalt1 <- lmerTest::lmer(formula = z2AUC15 ~ time*Sex*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout), data=bout.analysis2_true, na.action=na.exclude); 

#FIRST BOUTS from four mice - data created in graph section
model4.first_fit<-lmerTest::lmer(z2AUC15 ~ time*Solution + (1|Mouse), data=bout.analysis2_true.first)
summary(model4.first_fit)

```

##### z2TIMEDIFF
```{r}
#In the Step-Up strategy for model building, we next add in Level 4 covariates. The best model at level 3 was not clear so using the select candidates 3.3, 3.3e, and 3.0 and 3.0c.    

#Simple
model4.0_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time*Sex*Solution + (1+time|Mouse:session), data=bout.analysis2_true, na.action=na.exclude); 

model4.1_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time*Sex*Solution + (1+time|Mouse:session:Bout), data=bout.analysis2_true, na.action=na.exclude); 

#Complex 
model4.2_fit <- lmerTest::lmer(formula = z2TIMEDIFF ~ time*Sex*Solution + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude); 

#With Solution slope - Does not converge
model4.2_fitalt1 <- lmerTest::lmer(formula = z2TIMEDIFF ~ time*Sex*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude);

#FIRST BOUTS from four mice - data created in graph section
model4.first_fit<-lmerTest::lmer(z2TIMEDIFF ~ time*Solution + (1|Mouse), data=bout.analysis2_true.first)
summary(model4.first_fit)

```


#### ii) Gather Model Summaries (for Export)

```{r}
models4<-ls(envir=.GlobalEnv,pattern="model4")  
models.call<-lapply(mget(models4),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models4){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info4<-merge(models.call.df,model.obs.df)  

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg"="Drinking","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking_sol_imc" = "Drinking_within","Drinking_sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between")

summary4<-modelsummary::msummary(mget(models4),stars=T,output="data.frame",coef_rename = term.streamline)

# Test if every variable in the model is necessary by using the function drop1. 
model.drop4<-NULL  
model.drop.df4<-NULL   
for(k in models4){    
  drop4<-drop1(get(k))      
  model.drop4<-data.frame("Model"=k,drop4)  
  model.drop.df4<-rbind(model.drop.df4,model.drop4)  
  }    



## Now that we have our full model, one last check to see if any of the random terms should be dropped. Only do this once. You'll need the LLR for the rest of the models for model comparison. AKA - comment this part out after doing once with the base models.
# 
LLR<-NULL
LLR.df4<-NULL
for(k in models4){
  LLR<-data.frame("Model"=k,rand(get(k)))
  LLR.df4<-rbind(LLR.df4,LLR)
}

```

#### iii) (Optional) Plot Effects and Interactions

```{r}
moi<-model4.3_fitalt1


# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Random Effects Plot (EBLUP)
plotREsim(REsim(moi),labs=TRUE) 
  
# Create Reference Grid for Estimated Marginal Means
#RG<-ref_grid(moi, pbkrtest.limit = 5667)
#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Drinking.mL.kg_gmc=c(-0.8,0,1.2)))
#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Drinking.mL.kg_imc=c(-1,0,1)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Drinking.mL.kg_imc=c(-0.5,0,0.5),Drinking.mL.kg_gmc=c(-0.5,0,0.5)))

#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(EtOH.gkg_imc=c(-1,0,1)))   
#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(EtOH.gkg_imc=c(-1,0,1),EtOH.gkg_gmc=c(-2,0,0.8)))             

# Plot specific interactions
#emmip(RG, Solution~time|Sex, style = "factor", CIs=TRUE)+facet_wrap(Sex~time)
#emmip(RG, Solution~Drinking.mL.kg_imc|Sex*time, style = "factor", CIs=TRUE)+facet_wrap(Sex*time~Solution)+scale_color_manual(values=c(c2,c1,c3))
#emmip(RG, Solution~Drinking.mL.kg_gmc|Sex*time, style = "factor", CIs=TRUE)+facet_wrap(Sex*time~Solution)
emmip(RG, Drinking.mL.kg_imc*Solution~Drinking.mL.kg_gmc|Sex*time, style = "factor", CIs=TRUE)+facet_wrap(Sex*time~Solution)
emmip(RG, Drinking.mL.kg_imc*Solution~Drinking.mL.kg_gmc|time, style = "factor", CIs=TRUE)+facet_wrap(time~Solution)
emmip(RG, Drinking.mL.kg_imc*Solution~Drinking.mL.kg_gmc|Sex, style = "factor", CIs=TRUE)+facet_wrap(Sex~Solution)

emmip(RG, EtOH.gkg_imc ~ time|Sex, style = "factor", CIs=TRUE)

emmip(RG, EtOH.gkg_imc ~ EtOH.gkg_gmc|Sex*time, style = "factor", CIs=TRUE)+facet_wrap(Sex~time)

emmeans()

#Optional: Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
#plotREsim(REsim(moi),labs=TRUE) 



moi<-model4.0zduration_fit2

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,1)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,4)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_gmc=c(-0.8,0,1.2)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,1),Drinking.mL.kg_gmc=c(-0.8,0,1.2)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,1)))   
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,1),Duration_gmc=c(-2,0,0.8)))             

# Plot specific interactions
#emmip(RG, Solution~Duration_imc|time, style = "factor", CIs=TRUE)+facet_wrap(time~Solution)
#emmip(RG, Solution~Duration_imc|Sex, style = "factor", CIs=TRUE)+facet_wrap(~Sex)
emmip(RG, Duration_imc~time|Solution, style = "factor", CIs=TRUE)

emmip(RG, Duration_imc~time|Sex*Solution, style = "factor", CIs=TRUE)+facet_wrap(Sex~Solution)

#Optional: Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
#plotREsim(REsim(moi),labs=TRUE) 


moi<-model4.0zp_fit

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(moi, pbkrtest.limit = 5667)
         

# Plot specific interactions
emmip(RG, Sex~time|Solution, style = "factor", CIs=TRUE)

#Optional: Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
#plotREsim(REsim(moi),labs=TRUE) 
```

#### iv) Make Model Comparisons

```{r}
#To compare the two models - Lvl3 & Lvl4, we need to refit all models using REML=F. Easiest to let the below function automatically refit models and to ignore warnings about it. 

#Note that these comparisons are ONLY valid if both models have the same # of observations as their UCM counterparts!   

model.0_anova<-anova(model3.0_fit,model4.0_fit)  

model.1_anova<-anova(model3.1_fit,model4.1_fit)  

model.1_anova<-anova(model3.2_fit,model4.2_fit)  

LLR4<-rbind(model.0_anova,model.1_anova)
```

#### v) Post Hoc Comparisons
###### zAUC
```{r}
## Only run the ones justified by the omnibus statistics or ones that are specific comparisons not given by the model

#Compare effect of time for EtOH vs either solution
tukey.signal<-emmeans(model4.3_fitalt1, list(pairwise~time|Solution), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663) 
simple.tukey<-pairs(pairs(tukey.signal),simple="Solution") # Contrast of contrasts

#Probing 3-way interaction 
# 2-ways by Solution (Simple)  
tukey.signal1<-emmeans(model4.3_fitalt1, ~time*Sex|Solution, adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663) 
simple.tukey1 <-pairs(tukey.signal1,interaction="pairwise")

# 2-ways by time (Simple)
tukey.signal2<-emmeans(model4.3_fitalt1, ~Solution*Sex|time, adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663) 
simple.tukey2 <-pairs(tukey.signal2,interaction="pairwise")

# 2-ways by Sex (Simple)
tukey.signal3<-emmeans(model4.3_fitalt1, ~Solution*time|Sex, adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663) 
simple.tukey3 <-pairs(tukey.signal3,interaction="pairwise")

## ONLY USE FOR THOSE 2-WAYS ABOVE THAT ARE SIGNIFICANT 
# Sex*time at Solution=Water (Simple simple)
tukey.signal4<-emmeans(model4.3_fitalt1, ~Sex|time, adjust = "tukey",lmer.df="satterthwaite",at=list(Solution = "Water"),lmerTest.limit=5663) 
simple.simple.tukey <-pairs(tukey.signal4,simple="time")
ss.tuk.factor<-"Water"

# Solution*time at Sex = Male (Simple simple)
tukey.signal5<-emmeans(model4.3_fitalt1, ~Solution|time, adjust = "tukey",lmer.df="satterthwaite",at=list(Sex = "Male"),lmerTest.limit=5663) 
simple.simple.tukey1 <-pairs(tukey.signal5,simple="time")
ss.tuk.factor1<-"Male"

CI.signal<-confint(tukey.signal,level=0.95)

CI.simple<-confint(simple.tukey,level=0.95)
CI.simple1<-confint(simple.tukey1,level=0.95)
CI.simple2<-confint(simple.tukey2,level=0.95)
CI.simple3<-confint(simple.tukey3,level=0.95)

CI.ssimple<-confint(simple.simple.tukey,level=0.95)
CI.ssimple1<-confint(simple.simple.tukey1,level=0.95)

remove(tukey)
remove(CI)
remove(simple)
remove(CI.simp)
remove(ssimple)
remove(CI.ssimp)
tukey<-ls(envir=.GlobalEnv,pattern="tukey.signal") 
CI<-ls(envir=.GlobalEnv,pattern="CI.signal")
simple<-ls(envir=.GlobalEnv,pattern="simple.tukey")
CI.simp<-ls(envir=.GlobalEnv,pattern="CI.simple")
CI.ssimp<-ls(envir=.GlobalEnv,pattern="CI.ssimple")

tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL
tuk.summary4<-NULL
tuk.summary5<-NULL

for (n in 1:length(tukey)){
  if(any(class(get(tukey[[n]]))=="emm_list")==TRUE){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
  }else{
temp<-NULL
temp<-rbind(summary(get(tukey[[n]])),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
  }
}

for (n in 1:length(CI)){
  if(any(class(get(CI[[n]]))=="list")==TRUE){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}
}

##For simple comparisions
for (n in 1:length(simple)){
temp<-NULL
temp<-rbind(summary(get(simple[[n]])),temp)
temp<-cbind(temp,"Test"=rep(simple[n],nrow(temp)))
tuk.summary4<-rbind.fill(tuk.summary4,temp)
}
for (n in 1:length(CI.simp)){
temp<-NULL
temp<-rbind(get(CI.simp[[n]]),temp)
temp<-cbind(temp,"Test"=rep(CI.simp[n],nrow(temp)))
tuk.summary5<-rbind.fill(tuk.summary5,temp)
}

##For simple simple comparisions

for (n in 1:length(CI.ssimp)){
temp<-NULL
temp<-rbind(get(CI.ssimp[[n]]),temp)
temp<-cbind(temp,"Test"=rep(CI.ssimp[n],nrow(temp)))
tuk.summary5<-rbind.fill(tuk.summary5,temp)
}

remove(temp,temp2)

tuk.cols<-intersect(names(tuk.summary2),names(tuk.summary3))
tuk.cols<-tuk.cols[which(!tuk.cols=="Test")]

simple.cols<-intersect(names(tuk.summary4),names(tuk.summary5))
simple.cols<-simple.cols[which(!simple.cols=="Test")]

remove(tuk.summary)
remove(tuk.summary.simple)

tuk.summary<-merge.data.frame(tuk.summary2,tuk.summary3,by = tuk.cols,all.y=TRUE)
tuk.summary.simple<-merge.data.frame(tuk.summary4,tuk.summary5,by = simple.cols,all.y=TRUE)

tuk.summary.simple<-tuk.summary.simple %>% mutate(Masked_Factor=case_when((Test.x=="simple.simple.tukey" & Test.y=="CI.ssimple" ~ ss.tuk.factor),(Test.x=="simple.simple.tukey1"& Test.y=="CI.ssimple1") ~ ss.tuk.factor1))

remove(tukey,tuk.cols,tukey.signal,tukey.signal1,tukey.signal2,tukey.signal3,tukey.signal4,tukey.signal5,tuk.summary2,tuk.summary3,tuk.summary4,tuk.summary5,simple.tukey,simple.tukey1,simple.tukey2,simple.tukey3,simple.simple.tukey,simple.simple.tukey1,CI.simple,CI.signal,CI.simple1,CI.simple2,CI.simple3,CI.ssimple,CI.ssimple1,ssimple,simple.cols,simple,CI.simp,CI.ssimpCI,CI,ss.tuk.factor,ss.tuk.factor1)
```

###### zTIMEDIFF
```{r}
## Only run the ones justified by the omnibus statistics or ones that are specific comparisons not given by the model

#3-way because the model doesn't run a pure 3-way. 
tukey.3wy <-emmeans(model4.2_fit, ~Sex*time*Solution,lmer.df="satterthwaite",lmerTest.limit=5663)
simple.3wy <-pairs(tukey.3wy,simple="each")

tukey.signal<-emmeans(model4.2_fit, ~Sex*time|Solution, adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663) 
simple.tukey <-pairs(tukey.signal,interaction="pairwise")

#Probing 3-way interaction 
# 2-ways by Solution (Simple)  
tukey.signal1<-emmeans(model4.2_fit, ~time*Sex|Solution, adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663) 
simple.tukey1 <-pairs(tukey.signal1,interaction="pairwise")

# 2-ways by time (Simple)
tukey.signal2<-emmeans(model4.2_fit, ~Solution*Sex|time, adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663) 
simple.tukey2 <-pairs(tukey.signal2,interaction="pairwise")

# 2-ways by Sex (Simple)
tukey.signal3<-emmeans(model4.2_fit, ~Solution*time|Sex, adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663) 
simple.tukey3 <-pairs(tukey.signal3,interaction="pairwise")

## ONLY USE FOR THOSE 2-WAYS ABOVE THAT ARE SIGNIFICANT 
# Sex*time at Solution=EtOH (Simple simple)
tukey.signal4<-emmeans(model4.2_fit, ~Sex|time, adjust = "tukey",lmer.df="satterthwaite",at=list(Solution = "EtOH"),lmerTest.limit=5663) 
simple.simple.tukey <-pairs(tukey.signal4,simple="time")
ss.tuk.factor<-"EtOH"

tukey.signal5<-emmeans(model4.2_fit, ~Sex|time, adjust = "tukey",lmer.df="satterthwaite",at=list(Solution = "Water"),lmerTest.limit=5663) 
simple.simple.tukey1<-pairs(tukey.signal5,simple="time")
ss.tuk.factor1<-"Water"

tukey.signal6<-emmeans(model4.2_fit, ~Sex|time, adjust = "tukey",lmer.df="satterthwaite",at=list(Solution = "Sucrose"),lmerTest.limit=5663) 
simple.simple.tukey2<-pairs(tukey.signal6,simple="time")
ss.tuk.factor2<-"Sucrose"

# Sex*Solution at Time=Before (Simple simple)
tukey.signal7<-emmeans(model4.2_fit, ~Sex*Solution, adjust = "tukey",lmer.df="satterthwaite",at=list(time = "Before"),lmerTest.limit=5663) 
simple.simple.tukey3 <-pairs(tukey.signal7,simple="Sex")
ss.tuk.factor3<-"Before"

# Solution*time at Sex = Male (Simple simple)
tukey.signal8<-emmeans(model4.2_fit, ~Solution*time, adjust = "tukey",lmer.df="satterthwaite",at=list(Sex = "Male"),lmerTest.limit=5663) 
simple.simple.tukey4 <-pairs(tukey.signal8,simple="Solution")
ss.tuk.factor4<-"Male"

#CI.signal<-confint(tukey.signal,level=0.95)

CI.simple<-confint(simple.tukey,level=0.95)
CI.simple1<-confint(simple.tukey1,level=0.95)
CI.simple2<-confint(simple.tukey2,level=0.95)
CI.simple3<-confint(simple.tukey3,level=0.95)

CI.ssimple<-confint(simple.simple.tukey,level=0.95)
CI.ssimple1<-confint(simple.simple.tukey1,level=0.95)
CI.ssimple2<-confint(simple.simple.tukey2,level=0.95)
CI.ssimple3<-confint(simple.simple.tukey3,level=0.95)
CI.ssimple4<-confint(simple.simple.tukey4,level=0.95)

remove(tukey)
remove(CI)
remove(simple)
remove(CI.simp)
remove(ssimple)
remove(CI.ssimp)
tukey<-ls(envir=.GlobalEnv,pattern="tukey.signal") 
CI<-ls(envir=.GlobalEnv,pattern="CI.signal")
simple<-ls(envir=.GlobalEnv,pattern="simple.tukey")
CI.simp<-ls(envir=.GlobalEnv,pattern="CI.simple")
CI.ssimp<-ls(envir=.GlobalEnv,pattern="CI.ssimple")

tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL
tuk.summary4<-NULL
tuk.summary5<-NULL

for (n in 1:length(tukey)){
  if(any(class(get(tukey[[n]]))=="emm_list")==TRUE){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
  }else{
temp<-NULL
temp<-rbind(summary(get(tukey[[n]])),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
  }
}

for (n in 1:length(CI)){
  if(!length(CI)){
    }else{
  if(any(class(get(CI[[n]]))=="list")==TRUE){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}}
}

##For simple comparisions
for (n in 1:length(simple)){
temp<-NULL
temp<-rbind(summary(get(simple[[n]])),temp)
temp<-cbind(temp,"Test"=rep(simple[n],nrow(temp)))
tuk.summary4<-rbind.fill(tuk.summary4,temp)
}
for (n in 1:length(CI.simp)){
temp<-NULL
temp<-rbind(get(CI.simp[[n]]),temp)
temp<-cbind(temp,"Test"=rep(CI.simp[n],nrow(temp)))
tuk.summary5<-rbind.fill(tuk.summary5,temp)
}

##For simple simple comparisions

for (n in 1:length(CI.ssimp)){
temp<-NULL
temp<-rbind(get(CI.ssimp[[n]]),temp)
temp<-cbind(temp,"Test"=rep(CI.ssimp[n],nrow(temp)))
tuk.summary5<-rbind.fill(tuk.summary5,temp)
}

remove(temp,temp2)

tuk.cols<-intersect(names(tuk.summary2),names(tuk.summary3))
tuk.cols<-tuk.cols[which(!tuk.cols=="Test")]

simple.cols<-intersect(names(tuk.summary4),names(tuk.summary5))
simple.cols<-simple.cols[which(!simple.cols=="Test")]

remove(tuk.summary)
remove(tuk.summary.simple)

tuk.summary<-merge.data.frame(tuk.summary2,tuk.summary3,by = tuk.cols,all.y=TRUE)
tuk.summary.simple<-merge.data.frame(tuk.summary4,tuk.summary5,by = simple.cols,all.y=TRUE)

tuk.summary.simple<-tuk.summary.simple %>% mutate(Masked_Factor=case_when((Test.x=="simple.simple.tukey" & Test.y=="CI.ssimple" ~ ss.tuk.factor),(Test.x=="simple.simple.tukey1"& Test.y=="CI.ssimple1") ~ ss.tuk.factor1,(Test.x=="simple.simple.tukey2"& Test.y=="CI.ssimple2") ~ ss.tuk.factor2,(Test.x=="simple.simple.tukey3"& Test.y=="CI.ssimple3") ~ ss.tuk.factor3))

#remove(tukey,tuk.cols,tukey.signal,tukey.signal1,tukey.signal2,tukey.signal3,tukey.signal4,tukey.signal5,tuk.summary2,tuk.summary3,tuk.summary4,tuk.summary5,simple.tukey,simple.tukey1,simple.tukey2,simple.tukey3,simple.simple.tukey,simple.simple.tukey1,CI.simple,CI.signal,CI.simple1,CI.simple2,CI.simple3,CI.ssimple,CI.ssimple1,ssimple,simple.cols,simple,CI.simp,CI.ssimpCI,CI,ss.tuk.factor,ss.tuk.factor1)
```


#### vi) Export Model Summaries and Comparisons

```{r}
write.xlsx(model.info4,file=filemod2, sheetName = "Lvl4 TimeD Info", append=TRUE, row.names=FALSE)  

write.xlsx(summary4,file=filemod2, sheetName = "Lvl4 TimeD Compare", append=TRUE, row.names=FALSE)  

write.xlsx(LLR.df4,file=filemod2, sheetName = "Lvl4 TimeD LLR", append=TRUE, row.names=TRUE) 

write.xlsx(model.drop.df4,file=filemod2, sheetName = "Lvl4 TimeD Drop1", append=TRUE, row.names=TRUE) 

write.xlsx(tuk.summary1,file=filemod2, sheetName = "Lvl4 TimeD Tukey Means", append=TRUE, row.names=TRUE) 
write.xlsx(tuk.summary,file=filemod2, sheetName = "Lvl4 TimeD Tukey Pairs", append=TRUE, row.names=TRUE) 
write.xlsx(tuk.summary.simple,file=filemod2, sheetName = "Lvl4 TimeD Tukey Simple", append=TRUE, row.names=TRUE)

```

### e) Characteristics Models: Bout & Session Characteristics

#### i) Unconditional Means Models (UCM)

```{r}
## Note here that the random structure may be slightly different between them because of what level they are at and there may not be enough variation to prevent it from model issues. So we need to check on a structure for each outcome first! You also need to clear out any other UCMs from signal otherwise they will export along with these. 

#Also, the dataset each model uses differs. I decided to use the dataset that was the simplest AT the level of the outcome. So session level stats (Total Bouts, Consumption) use the session.analysis3 dataset (1 row per session) and bout level outcomes use the data.analysis_true dataset (1 row per bout)

#Unconditional Means Models 

#Drinking.mL.kg
#Negative Control
model0.drink_fit<-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|Mouse),data=session.analysis3, na.action=na.exclude);

#Rest of the random structures to test
model0.drink_fita <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);
model0.drink_fitb <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|session),data=session.analysis3, na.action=na.exclude);
model0.drink_fitc <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|Mouse:session)+(1|Mouse),data=session.analysis3, na.action=na.exclude);
model0.drink_fitd <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|Mouse:session) + (1|session),data=session.analysis3, na.action=na.exclude);
model0.drink_fite <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|session) + (1|Mouse),data=session.analysis3, na.action=na.exclude);
model0.drink_fitf <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|session) + (1|Mouse) + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);

#Lick Frequency
#Negative Control
model0.freq_fit<-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse),data=data.analysis_true, na.action=na.exclude);

#Rest of the random structures to test
model0.freq_fita <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
model0.freq_fitb <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|session) + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
model0.freq_fitc <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout),data=data.analysis_true, na.action=na.exclude);
model0.freq_fitd <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
model0.freq_fite <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|session),data=data.analysis_true, na.action=na.exclude);
model0.freq_fitf <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
model0.freq_fitg <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse)+(1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
model0.freq_fith <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|session)+(1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);


#Session Total Bouts
model0.bout_fit<-lmerTest::lmer(formula= Bout_max ~ 1 + (1|Mouse),data=session.analysis3, na.action=na.exclude);
model0.bout_fita <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);
model0.bout_fitb <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|session),data=session.analysis3, na.action=na.exclude);
model0.bout_fitc <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|Mouse:session)+(1|Mouse),data=session.analysis3, na.action=na.exclude);
model0.bout_fitd <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|Mouse:session) + (1|session),data=session.analysis3, na.action=na.exclude);
model0.bout_fite <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|session) + (1|Mouse),data=session.analysis3, na.action=na.exclude);
model0.bout_fitf <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|session) + (1|Mouse) + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);


#LicksPerBout
model0.lick_fit<-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
model0.lick_fita <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
model0.lick_fitb <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|session) + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
model0.lick_fitc <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout),data=data.analysis_true, na.action=na.exclude);
model0.lick_fitd <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
model0.lick_fite <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|session),data=data.analysis_true, na.action=na.exclude);
model0.lick_fitf <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);

#Bout Duration
model0.duration_fit<-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
model0.duration_fita <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
model0.duration_fitb <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|session) + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
model0.duration_fitc <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout),data=data.analysis_true, na.action=na.exclude);
model0.duration_fitd <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
model0.duration_fite <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|session),data=data.analysis_true, na.action=na.exclude);
model0.duration_fitf <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);

#EtOH.gkg
model0.etoh_fit<-lmerTest::lmer(formula= EtOH.gkg ~ 1 + (1|Mouse),data=session.analysis3, na.action=na.exclude);
#model0.etoh_fita <-lmerTest::lmer(formula= EtOH.gkg ~ 1 + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);#Has error with grouping levels being > obs
model0.etoh_fitb <-lmerTest::lmer(formula= EtOH.gkg ~ 1 + (1|session),data=session.analysis3, na.action=na.exclude); 
model0.etoh_fitc <-lmerTest::lmer(formula= EtOH.gkg ~ 1 + (1|session) + (1|Mouse),data=session.analysis3, na.action=na.exclude);


models0<-ls(envir=.GlobalEnv,pattern="model0")  
models.call<-lapply(mget(models0),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models0){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info0c<-merge(models.call.df,model.obs.df)  

summary0c<-modelsummary::msummary(mget(models0),stars=T,output="data.frame")

LLR<-NULL 
LLR.df0c<-NULL 
for(k in models0){ 
  LLR<-data.frame("Model"=k,rand(get(k)))  
  LLR.df0c<-rbind(LLR.df0c,LLR) 
  }   

write.xlsx(model.info0c,file=filemod2, sheetName = "Characters UCM Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary0c,file=filemod2, sheetName = "Characters UCM", append=TRUE, row.names=FALSE)  
write.xlsx(LLR.df0c,file=filemod2,sheetName = "Characters UCM LLR",append=TRUE)


```

#### ii) Outcome Models

```{r}
model5.bout_basic <-lm(formula= TotalBouts_Total ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
 
model5.bout_nested <-lmerTest::lmer(formula= Bout_max ~ Sex*Solution + (1|Mouse),data=session.analysis3, na.action=na.exclude);
 
model5.bout_fit <-lmerTest::lmer(formula= Bout_max ~ Sex*Solution + (1|Mouse),data=session.analysis3, na.action=na.exclude); #Doesn't converge with Solution slope


model5.drink_fit <-lmerTest::lmer(formula= Drinking.mL.kg ~ Sex*Solution + (1|Mouse),data=session.analysis3, na.action=na.exclude);

model5.drink_basic <-lm(formula= Drinking.mL.kg_mean ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
 
model5.drink_nested <-lmerTest::lmer(formula= Drinking.mL.kg ~ Sex*Solution + (1|Mouse),data=session.analysis3, na.action=na.exclude);
 

model5.duration_fita <-lmerTest::lmer(formula= BoutDuration ~ Sex*Solution + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);

model5.duration_basic <-lm(formula= BoutDuration_mean_mean ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
 
model5.duration_nested <-lmerTest::lmer(formula= BoutDuration ~ Sex*Solution + (1|Mouse),data=data.analysis_true, na.action=na.exclude);


model5.lick_fita <-lmerTest::lmer(formula= LicksPerBout ~ Sex*Solution + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);

model5.lick_basic <-lm(formula= LicksPerBout_mean_mean ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
 
model5.lick_nested <-lmerTest::lmer(formula= LicksPerBout ~ Sex*Solution + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
 

model5.freq_fitf <-lmerTest::lmer(formula= LickFrequency ~ Sex*Solution + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);

model5.freq_basic <-lm(formula= LickFrequency_mean_mean ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
 
model5.freq_nested <-lmerTest::lmer(formula= LickFrequency ~ Sex*Solution + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
 

model5.etoh_fitc <-lmerTest::lmer(formula= EtOH.gkg ~ Sex + (1|session) + (1|Mouse),data=session.analysis3, na.action=na.exclude);


model5.positionduration_fit <-lmerTest::lmer(formula= BoutDuration ~ Sex*Solution*Position + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);


model5.positionfreq_fit <-lmerTest::lmer(formula= LickFrequency ~ Sex*Solution*Position + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);


```

#### iii) Gather Model Summaries (for Export)

```{r}

models5<-ls(envir=.GlobalEnv,pattern="model5")  
models.call<-lapply(mget(models5),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models5){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info5<-merge(models.call.df,model.obs.df)  

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg"="Drinking","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking_sol_imc" = "Drinking_within","Drinking_sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between")

summary5<-modelsummary::msummary(mget(models5),stars=T,output="data.frame",coef_rename = term.streamline)
```

#### iv) (Optional) Plot Effects and Interactions

```{r}
moi<-model5.drink_fit
moi.name<-"model5.drink_fit"

models.call<-lapply(mget(moi),get_call)  

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,vline.color = "black",
                   title= paste("Effects: ",moi.name))

##Plot it!
emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### v) PostHoc Comparisons

```{r}
tukey5.drink<-emmeans(model5.drink_fit, list(pairwise ~ Solution*Sex), adjust = "tukey",lmer.df="satterthwaite",digits=3, digits.p=4)
CI.5drink<-confint(tukey5.drink,level=0.95)

tukey5.duration<-emmeans(model5.duration_fita, list(pairwise ~ Solution*Sex), adjust = "tukey", lmer.df="satterthwaite")
CI.5duration<-confint(tukey5.duration,level=0.95)

tukey5.freq<-emmeans(model5.freq_fitf, list(pairwise ~ Solution*Sex), adjust = "tukey", lmer.df="satterthwaite")
tukey5.lick<-emmeans(model5.lick_fita, list(pairwise ~ Solution*Sex), adjust = "tukey", lmer.df="satterthwaite")

tukey5.bout<-emmeans(model5.bout_fit, list(pairwise ~ Solution*Sex), adjust = "tukey", lmer.df="satterthwaite")
CI.bout<-confint(tukey5.bout,level=0.95)

tukey5.posduration<-emmeans(model5.positionduration_fit, list(pairwise ~ Position* Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664)
tukey5.posfreq<-emmeans(model5.positionfreq_fit, list(pairwise ~ Position*Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664)

remove(tukey)
remove(CI)
tukey<-ls(envir=.GlobalEnv,pattern="tukey") 
CI<-ls(envir=.GlobalEnv,pattern="CI") 
tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
}

for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}
```

#### vi) Export Model Summaries and PostHoc Comparisons

```{r}

write.xlsx(model.info5,file=filemod2, sheetName = "Characters Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary5,file=filemod2, sheetName = "Characters Omnibus", append=TRUE, row.names=FALSE)  

write.xlsx(tuk.summary1,file=filemod2,sheetName = "Characters Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filemod2,sheetName = "Characters Tukey_Pairs",append=TRUE)

```

### f) Signal-Drinking Models

#### i) Fit Models

```{r}
#Drinking.sol_imc - need to filter out inf values from the problem children
#Four pesky Inf values for #9 have to be filtered out
bout.analysis2_true2<-subset(bout.analysis2_true,!Drinking.sol_imc=="Inf")

#Drinking.mL.kg Control Models
#Drinking.mL.kg_imc
model4.2zcdrink_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_imc + (1|Mouse),data=bout.analysis2_true, na.action=na.exclude);

#Drinking.mL.kg_sol_imc*Drinking.mL.kg_grpmc
model4.2zcdrink_nested9 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_imc*Drinking.mL.kg_grpmc + (1|Mouse),data=bout.analysis2_true2, na.action=na.exclude);

#Drinking.mL.kg_imc
model4.2zcdrink_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#Drinking.sol_imc
model4.2zcdrink_fit1 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true2, na.action=na.exclude);

#Drinking.mL.kg_gmc
model4.2zcdrink_fit2 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#Drinking.mL.kg_smc
model4.2zcdrink_fit3 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_smc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#Drinking.mL.kg_grpmc
model4.2zcdrink_fit4 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#Drinking.sol_gmc
model4.2zcdrink_fit5 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

## Filter out everything but EtOH sessions:
bout.analysis2_truee<-subset(bout.analysis2_true,!is.na(EtOH.gkg)==TRUE)
bout.analysis2_truee<-subset(bout.analysis2_truee,!EtOH.gkg_imc=="-Inf")

#EtOH.gkg_imc
model4.2zcdrink_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*EtOH.gkg_imc + (1+time|Mouse:session)+(1|Mouse:session:Bout),data=bout.analysis2_truee, na.action=na.exclude); # Removed (1|Bout) because effect was 0

#EtOH.gkg_gmc
model4.2zcdrink_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*EtOH.gkg_gmc + (1+time|Mouse:session)+(1|Mouse:session:Bout),data=bout.analysis2_truee, na.action=na.exclude); # Removed (1|Bout) because effect was 0

#EtOH.gkg_smc
model4.2zcdrink_fit8 <-lmerTest::lmer(formula= signal ~ time*Sex*EtOH.gkg_smc + (1+time|Mouse:session)+(1|Mouse:session:Bout),data=bout.analysis2_truee, na.action=na.exclude); # Removed (1|Bout) because effect was 0


#Drinking.sol_imc * Drinking.mL.kg_grpmc

##Did not converge
#model4.2zcdrink_fit9 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_imc*Drinking.mL.kg_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true2, na.action=na.exclude);

#Removed Solution random slope - results in less fit overall so hard to interpret
model4.2zcdrink_fit9 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_imc*Drinking.mL.kg_grpmc + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true2, na.action=na.exclude);
```

#### ii) (Optional) Plot Effects

```{r}
moi<-model4.2zcdrink_fit9
moi.name<-"model4.2zcdrink_fit9"

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")


# Effects Plot
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name))
#800 x 600

##Plot it!
emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### iii) PostHoc Comparisons

```{r}
tukey.drink<-emmeans(model4.2zcdrink_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Drinking.mL.kg_imc"=c(-1,0,1)))
CI.drink<-confint(tukey.drink,level=0.95)

tukey.drinka<-emmeans(model4.2zcdrink_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Drinking.mL.kg_imc"=c(1)))
CI.drinka<-confint(tukey.drinka,level=0.95)

tukey.drinkb<-emmeans(model4.2zcdrink_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Drinking.mL.kg_imc"=c(-1)))
CI.drinkb<-confint(tukey.drinkb,level=0.95)

tukey.drinkc<-emmeans(model4.2zcdrink_fit, list(pairwise ~ time|Drinking.mL.kg_imc*Sex),by="Solution", adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Drinking.mL.kg_imc"=c(-1,1)))
simple.drink<-pairs(pairs(tukey.drinkc),simple="Drinking.mL.kg_imc") # Contrast of contrasts)
CI.simp.drink<-confint(simple.drink,level=0.95)


remove(tukey)
remove(CI)
remove(simple)
remove(CI.simple)
tukey<-ls(envir=.GlobalEnv,pattern="tukey.drink") 
CI<-ls(envir=.GlobalEnv,pattern="CI.drink") 
simple<-ls(envir=.GlobalEnv,pattern="simple.drink")
CI.simple<-ls(envir=.GlobalEnv,pattern="CI.simp.drink")

tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL
tuk.summary4<-NULL
tuk.summary5<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
}

for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}

##For simple comparisions
for (n in 1:length(simple)){
temp<-NULL
temp<-rbind(summary(get(simple[[n]])),temp)
temp<-cbind(temp,"Test"=rep(simple[n],nrow(temp)))
tuk.summary4<-rbind.fill(tuk.summary4,temp)
}
for (n in 1:length(CI.simple)){
temp<-NULL
temp<-rbind(get(CI.simple[[n]]),temp)
temp<-cbind(temp,"Test"=rep(CI.simple[n],nrow(temp)))
tuk.summary5<-rbind.fill(tuk.summary5,temp)
}
```

#### iv) Export Model Summaries

```{r}

models.drink<-ls(envir=.GlobalEnv,pattern="model4.2zcdrink")  
models.call<-lapply(mget(models.drink),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models.drink){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.infosd<-merge(models.call.df,model.obs.df)  

term.streamline<-c("Solution[H.1]"="Solution[H.Sucrose-Water]","Solution[H.2]"="Solution[H.EtOH-avg(S,W)]","Sex[H.1]"="Sex[H.Male-Female]","time[H.1]"="time[H.After-Before]","LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking.sol_imc" = "Drinking_within","Drinking.sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between","EtOH.gkg_imc"="Drinking_within","EtOH.gkg_smc"="Drinking_between","EtOH.gkg_gmc"="Drinking_between")

summarysd<-modelsummary::msummary(mget(models.drink),stars=T,output="data.frame",coef_rename = term.streamline)


write.xlsx(model.infosd,file=filemod2, sheetName = "Signal-Drink Info", append=TRUE, row.names=FALSE)  
write.xlsx(summarysd,file=filemod2, sheetName = "Signal-Drink Compare", append=TRUE, row.names=FALSE)  

write.xlsx(tuk.summary1,file=filemod2,sheetName = "Signal-Drink Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filemod2,sheetName = "Signal-Drink Tukey_Pairs",append=TRUE)
write.xlsx(tuk.summary3,file=filemod2,sheetName = "Signal-Drink Tukey_CIs",append=TRUE)
write.xlsx(tuk.summary4,file=filemod2,sheetName = "Signal-Drink Simple",append=TRUE)
write.xlsx(tuk.summary5,file=filemod2,sheetName = "Signal-Drink Simple_CIs",append=TRUE)


```

#### v) Make Model Comparisons

```{r}
#To compare the two models - Signal Lvl4 and Signal-Drink, we need to refit all models using REML=F.  
model4.2zc_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude, REML=FALSE); 

model4.2zcdrink_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude, REML=FALSE); 

#Note that these comparisons are ONLY valid if both models have the same # of observations!  

model.0z_anova<-anova(model4.2zcdrink_fit,model4.2zc_fit)  

LLR4<-rbind(model.0z_anova)
write.xlsx(LLR4,file=filemod2,sheetName = "Signal-Drink LLR",append=TRUE)

```
### g) Signal_Duration Models

#### i) Fit Models

```{r}
#Duration Control Models
#Duration_imc
model4.2zcDuration_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_imc + (1|Mouse),data=bout.analysis2_true, na.action=na.exclude); #Singular
#Duration_sol_imc*Duration_grpmc
model4.2zcdDuration_nested6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_sol_imc*Duration_grpmc + (1|Mouse),data=bout.analysis2_true, na.action=na.exclude);

#BoutDuration_imc
model4.2zcDuration_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#BoutDuration_sol_imc
model4.2zcDuration_fit1 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#BoutDuration_gmc
model4.2zcDuration_fit2 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#BoutDuration.sol_gmc
model4.2zcDuration_fit3 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_sol_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#BoutDuration_smc
model4.2zcDuration_fit4 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_smc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#BoutDuration_grpmc
model4.2zcDuration_fit5 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#BoutDuration_grpmc*Duration_sol_imc
model4.2zcDuration_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_grpmc*Duration_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#BoutDuration_gmc*Duration_imc
model4.2zcDuration_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_gmc*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
```

#### ii) (Optional) Plot Effects

```{r}
moi<-model4.2zcDuration_fit7 
moi.name<-"model4.2zcDuration_fit7"  

# Effects Table sjPlot::tab_model(moi,           show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")  
# Effects Plot 
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name)) #1000 x 600  
##Plot it! 
emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### iii) PostHoc Comparisons

```{r}
tukey.duration<-emmeans(model4.2zcDuration_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Duration_imc"=c(-1,0,1)))
CI.duration<-confint(tukey.duration,level=0.95)

tukey.drinka<-emmeans(model4.2zcDuration_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Duration_imc"=c(1)))
CI.durationa<-confint(tukey.drinka,level=0.95)

tukey.durationb<-emmeans(model4.2zcDuration_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Duration_imc"=c(-1)))
CI.durationb<-confint(tukey.durationb,level=0.95)

tukey.durationc<-emmeans(model4.2zcDuration_fit, list(pairwise ~ time|Duration_imc*Sex),by="Solution", adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Duration_imc"=c(-1,1)))
simple.duration<-pairs(pairs(tukey.durationc),simple="Duration_imc") # Contrast of contrasts)
CI.simp.duration<-confint(simple.duration,level=0.95)
simple.duration1<-pairs(pairs(tukey.durationc),simple="Solution") # Contrast of contrasts)
CI.simp.duration1<-confint(simple.duration1,level=0.95)

remove(tukey)
remove(CI)
remove(simple)
remove(CI.simple)
tukey<-ls(envir=.GlobalEnv,pattern="tukey.duration") 
CI<-ls(envir=.GlobalEnv,pattern="CI.duration") 
simple<-ls(envir=.GlobalEnv,pattern="simple.duration")
CI.simple<-ls(envir=.GlobalEnv,pattern="CI.simp.duration")

tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL
tuk.summary4<-NULL
tuk.summary5<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
}

for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}

##For simple comparisions
for (n in 1:length(simple)){
temp<-NULL
temp<-rbind(summary(get(simple[[n]])),temp)
temp<-cbind(temp,"Test"=rep(simple[n],nrow(temp)))
tuk.summary4<-rbind.fill(tuk.summary4,temp)
}
for (n in 1:length(CI.simple)){
temp<-NULL
temp<-rbind(get(CI.simple[[n]]),temp)
temp<-cbind(temp,"Test"=rep(CI.simple[n],nrow(temp)))
tuk.summary5<-rbind.fill(tuk.summary5,temp)
}
```

#### iv) Export Model Summaries

```{r}
models.duration<-ls(envir=.GlobalEnv,pattern="model4.2zcDuration")   
models.call<-lapply(mget(models.duration),get_call)   
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))       

model.obs<-NULL   
model.obs.df<-NULL    
for(k in models.duration){       
  obs<-sapply(ranef(get(k)),nrow)         
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))       
  model.obs.df<-rbind(model.obs.df,model.obs)    
  }      
model.info<-merge(models.call.df,model.obs.df)    

term.streamline<-c("Solution[H.1]"="Solution[H.Sucrose-Water]","Solution[H.2]"="Solution[H.EtOH-avg(S,W)]","Sex[H.1]"="Sex[H.Male-Female]","time[H.1]"="time[H.After-Before]","LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking.sol_imc" = "Drinking_within","Drinking.sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between","EtOH.gkg_imc"="Drinking_within","EtOH.gkg_smc"="Drinking_between","EtOH.gkg_gmc"="Drinking_between")

summary<-modelsummary::msummary(mget(models.duration),stars=T,output="data.frame",coef_rename = term.streamline)  

write.xlsx(model.info,file=filemod2, sheetName = "Signal-Duration Info", append=TRUE, row.names=FALSE)   
write.xlsx(summary,file=filemod2, sheetName = "Signal-Duration Compare", append=TRUE, row.names=FALSE)   
write.xlsx(tuk.summary1,file=filemod2,sheetName = "Signal-Duration Tukey_Means",append=TRUE) 
write.xlsx(tuk.summary2,file=filemod2,sheetName = "Signal-Duration Tukey_Pairs",append=TRUE) 
write.xlsx(tuk.summary3,file=filemod2,sheetName = "Signal-Duration Tukey_CIs",append=TRUE)
write.xlsx(tuk.summary4,file=filemod2,sheetName = "Signal-Duration Simple",append=TRUE) 
write.xlsx(tuk.summary5,file=filemod2,sheetName = "Signal-Duration Simple_CIs",append=TRUE) 


```
#### v) Make Model Comparisons

```{r}
#To compare the two models - Signal Lvl4 and Signal-Drink, we need to refit all models using REML=F.  
model4.2zc_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude, REML=FALSE); 

model4.2zcDuration_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude, REML=FALSE); 

#Note that these comparisons are ONLY valid if both models have the same # of observations!  

model.0z_anova<-anova(model4.2zcDuration_fit,model4.2zc_fit)  

LLR4<-rbind(model.0z_anova)
write.xlsx(LLR4,file=filemod2,sheetName = "Signal-Duration LLR",append=TRUE)

```
### 

```{r} ##CHECK RANDOM STRUCTURE!!}


#LickFrequency
model4.0zfreq_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);

model4.0zfreq_fit2 <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LickFrequency_gmc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);

model4.0zfreq_fit3 <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LickFrequency_gmc*LickFrequency_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);

model4.0zfreq_fit3a <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LickFrequency_gmc*LickFrequency_imc + (1+time+Solution|Mouse),data=bout.analysis2_true, na.action=na.exclude);

#LicksPerBout
model4.0zlick_fit <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);

model4.0zlick_fit2 <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LicksPerBout_gmc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);

model4.0zlick_fit3 <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LicksPerBout_gmc*LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true, na.action=na.exclude);

```

### h) Signal_Frequency Models

#### i) Fit Models

```{r}
#LickFrequency Control Models
#LickFrequency_imc
model4.2zcLickFreq_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_imc + (1|Mouse),data=bout.analysis2_true, na.action=na.exclude); #Singular
#LickFrequency_sol_imc*LickFrequency_sol_gmc
model4.2zcLickFreq_nested7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_sol_gmc*LickFrequency_sol_imc + (1|Mouse),data=bout.analysis2_true, na.action=na.exclude);

#LickFrequency_imc 
model4.2zcLickFreq_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);  

#LickFrequency_sol_imc 
model4.2zcLickFreq_fit1 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);  

#LickFrequency_gmc 
model4.2zcLickFreq_fit2 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#LickFrequency_sol_gmc 
model4.2zcLickFreq_fit3 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_sol_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#LickFrequency_smc 
model4.2zcLickFreq_fit4 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_smc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#LickFrequency_grpmc 
model4.2zcLickFreq_fit5 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);  

#LickFrequency__grpmc*LickFrequency__sol_imc 
model4.2zcLickFreq_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_grpmc*LickFrequency_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#LickFrequency_sol_gmc*LickFrequency_sol_imc 
model4.2zcLickFreq_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_sol_gmc*LickFrequency_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
```

#### ii) (Optional) Plot Effects

```{r}
moi<-model4.2zcLickFreq_fit7 
moi.name<-"model4.2zcLickFreq_fit7"    

# Effects Table 
sjPlot::tab_model(moi,show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")   

# Effects Plot  
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name)) #1000 x 600   

##Plot it!  
emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### iii) PostHoc Comparisons

```{r}
tukey.drink<-emmeans(model4.2zcdrink_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",pbkrtest.limit = 5664) tukey.drink1<-emmeans(model4.2zcdrink_fit1, list(pairwise ~ Solution*Sex), adjust = "tukey",pbkrtest.limit = 5664) tukey.drink2<-emmeans(model4.2zcdrink_fit2, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664) tukey.drink3<-emmeans(model4.2zcdrink_fit3, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664) tukey.drink4<-emmeans(model4.2zcdrink_fit4, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664)   remove(tukey) tukey<-ls(envir=.GlobalEnv,pattern="tukey.drink")  tuk.summary1<-NULL tuk.summary2<-NULL  for (n in 1:length(tukey)){ temp<-NULL temp2<-NULL temp<-rbind(summary(get(tukey[[n]])[[1]]),temp) temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp))) tuk.summary1<-rbind.fill(tuk.summary1,temp) temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2) temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2))) tuk.summary2<-rbind.fill(tuk.summary2,temp2)  }
```

#### iv) Export Model Summaries

```{r}
models.freq<-ls(envir=.GlobalEnv,pattern="model4.2zcLickFreq")    
models.call<-lapply(mget(models.freq),get_call)    
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))         

model.obs<-NULL    
model.obs.df<-NULL     
for(k in models.freq){          
  obs<-sapply(ranef(get(k)),nrow)            
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))          
  model.obs.df<-rbind(model.obs.df,model.obs)       
  }      
model.info<-merge(models.call.df,model.obs.df)     

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking.sol_imc" = "Drinking_within","Drinking.sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between","EtOH.gkg_imc"="Drinking_within","EtOH.gkg_smc"="Drinking_between","EtOH.gkg_gmc"="Drinking_between")

summarysf<-modelsummary::msummary(mget(models.freq),stars=T,output="data.frame",coef_rename = term.streamline)   

write.xlsx(model.info,file=filemod2, sheetName = "Signal-LickFreq Info", append=TRUE, row.names=FALSE)    
write.xlsx(summarysf,file=filemod2, sheetName = "Signal-LickFreq Compare", append=TRUE, row.names=FALSE)     

#write.xlsx(tuk.summary1,file=filemod2,sheetName = "Signal-Drink Tukey_Means",append=TRUE)  
#write.xlsx(tuk.summary2,file=filemod2,sheetName = "Signal-Drink Tukey_Pairs",append=TRUE) 
```

### 

### h) Signal_Position Models

#### i) Fit Models

```{r}
#Position Control
model4.2zcPos_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position + (1|Mouse),data=bout.analysis2_true, na.action=na.exclude);

#Position Alone
model4.2zcPos_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude); #DOES NOT CONVERGE WITH DEFAULT OPTIMIZER SOMETIMES

model4.2zcPos_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude,control=lmerControl(optimizer="bobyqa")); #Used ultimately in final final data

#Position + Duration_imc
model4.2zcPos_fit2 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#Position + Duration_grpmc
model4.2zcPos_fit3 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Duration_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude); #Rank deficient

#Position + Frequency_sol_imc
model4.2zcPos_fit4 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*LickFrequency_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

#Position + Frequency_sol_gmc
model4.2zcPos_fit5 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*LickFrequency_sol_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude); #Rank deficient

#Position + Drinking_imc
model4.2zcPos_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);

##Position + Drinking_imc+Duration_imc
model4.2zcPos_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Duration_imc*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude);
```

#### ii) (Optional) Plot Effects

```{r}
moi<-model4.2zcPos_fit  
moi.name<-"model4.2zcPos_fit"      

# Effects Table  
sjPlot::tab_model(moi,show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")     

# Effects Plot   
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name)) #1000 x 600    

##Plot it!   emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### iii) PostHoc Comparisons

```{r}
tukey.pos<-emmeans(model4.2zcPos_fit, list(pairwise ~ time|Position),by="Solution",at=list(Position=c("First 10 min","Last 10 min")), adjust = "tukey",pbkrtest.limit = 5664) 
CI.pos<-confint(tukey.pos,level=0.95)
simple.pos<-pairs(pairs(tukey.pos),simple="Position") # Contrast of contrasts)
CI.simp.pos<-confint(simple.pos,level=0.95)


remove(tukey)
remove(CI)
remove(simple)
remove(CI.simple)
tukey<-ls(envir=.GlobalEnv,pattern="tukey.pos") 
CI<-ls(envir=.GlobalEnv,pattern="CI.pos") 
simple<-ls(envir=.GlobalEnv,pattern="simple.pos")
CI.simple<-ls(envir=.GlobalEnv,pattern="CI.simp.pos")

tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL
tuk.summary4<-NULL
tuk.summary5<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
}

for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}

##For simple comparisions
for (n in 1:length(simple)){
temp<-NULL
temp<-rbind(summary(get(simple[[n]])),temp)
temp<-cbind(temp,"Test"=rep(simple[n],nrow(temp)))
tuk.summary4<-rbind.fill(tuk.summary4,temp)
}
for (n in 1:length(CI.simple)){
temp<-NULL
temp<-rbind(get(CI.simple[[n]]),temp)
temp<-cbind(temp,"Test"=rep(CI.simple[n],nrow(temp)))
tuk.summary5<-rbind.fill(tuk.summary5,temp)
}
```

#### v) Make Model Comparisons

```{r}
#To compare the two models - Signal Lvl4 and Signal-Drink, we need to refit all models using REML=F.  
model4.2zc_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude, REML=FALSE); 

model4.2zcPos_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Position + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude, REML=FALSE); 

model4.2zcDuration_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude, REML=FALSE); 

model4.2zcPos_fit2 <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Position*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true, na.action=na.exclude, REML=FALSE); 

model4.2zcdrink_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude,REML=FALSE);


model4.2zcPos_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude,REML=FALSE);

model4.2zcPos_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Duration_imc*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true, na.action=na.exclude,REML=FALSE);


#Note that these comparisons are ONLY valid if both models have the same # of observations!  

model.0z_anova<-anova(model4.2zcPos_fit2,model4.2zcDuration_fit)  
model.0z1_anova<-anova(model4.2zcPos_fit,model4.2zc_fit)
model.0z2_anova<-anova(model4.2zcPos_fit6,model4.2zcdrink_fit)
model.0z3_anova<-anova(model4.2zcPos_fit7,model4.2zcdrink_fit)
model.0z4_anova<-anova(model4.2zcPos_fit7,model4.2zcDuration_fit)

LLRpos<-rbind(model.0z_anova,model.0z1_anova,model.0z2_anova,model.0z3_anova,model.0z4_anova)
write.xlsx(LLRpos,file=filemod2,sheetName = "Signal-Pos LLR",append=TRUE)

```


#### iv) Export Model Summaries

```{r}
models.pos<-ls(envir=.GlobalEnv,pattern="model4.2zcPos")     
models.call<-lapply(mget(models.pos),get_call)    
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))           
model.obs<-NULL    
model.obs.df<-NULL      
for(k in models.pos){             
  obs<-sapply(ranef(get(k)),nrow)               
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))             
  model.obs.df<-rbind(model.obs.df,model.obs)          
  }      
model.info<-merge(models.call.df,model.obs.df)      

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking.sol_imc" = "Drinking_within","Drinking.sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between","EtOH.gkg_imc"="Drinking_within","EtOH.gkg_smc"="Drinking_between","EtOH.gkg_gmc"="Drinking_between")

summary<-modelsummary::msummary(mget(models.pos),stars=T,output="data.frame",coef_rename = term.streamline)

write.xlsx(model.info,file=filemod2, sheetName = "Signal-Pos Info", append=TRUE, row.names=FALSE)     
write.xlsx(summary,file=filemod2, sheetName = "Signal-Pos Compare", append=TRUE, row.names=FALSE)       

write.xlsx(tuk.summary1,file=filemod2,sheetName = "Signal-Pos Tukey_Means",append=TRUE)   
write.xlsx(tuk.summary2,file=filemod2,sheetName = "Signal-Pos Tukey_Pairs",append=TRUE) 
write.xlsx(tuk.summary3,file=filemod2,sheetName = "Signal-Pos Tukey_CI",append=TRUE) 
write.xlsx(tuk.summary4,file=filemod2,sheetName = "Signal-Pos Tukey_Simple",append=TRUE) 
write.xlsx(tuk.summary5,file=filemod2,sheetName = "Signal-Pos Tukey_SimpleCI",append=TRUE) 

```

### 

## 5) Model Diagnostics

```{r}
moi<-model4.2zcPos_fit
moi.name<-"model1.peakf_fitc"

moi<-model4.3_fitalt1
moi.name<-"model4.3_fitalt1 (Signal AUC Outcome Model)"

moi<-model4.2_fit
moi.name<-"model4.2_fit (Signal TimeD Outcome Model)"

moi<-model4.2zcdrink_fit
moi.name<-"model4.2zcdrink_fit"

moi<-model4.2zcDuration_fit
moi.name<-"model4.2zcDuration_fit"

moi<-model4.2zcPos_fit
moi.name<-"model4.2zcPos_fit"

moi<-model5.drink_fit
moi.name<-"model5.drink_fit (Consumption Outcome Model)"

moi<-model5.duration_fita
moi.name<-"model5.duration_fita (Bout Duration Outcome Model)"

moi<-model4.first_fit
moi.name<-"model4.first_fit (First Bout Only Model)"

#standard fitted vs. residual plots,
plot(moi, type = c("p", "smooth"))
#scale-location plots,
plot(moi, sqrt(abs(resid(.))) ~ fitted(.),
type = c("p", "smooth"))
#and quantile-quantile plots (from lattice),
qqmath(moi, id = 0.05)

#Kolmogorov-Smirnov Tests for Normality in large sample sizes
ks.test(residuals(moi),y=pnorm)

# Overall performance summary - LOVEEEEEE
performance::check_model(moi)

#Effects plots for Predicted Values Against Any Other Factor
plot_model(moi, show.values = TRUE, vline.color = "black")

fe <- fixef(moi)
re <- ranef(moi)$`Mouse:session`
int<- int(moi)

re.df<-as.data.frame(re)
re <- re %>%
  mutate("Mouse:session"= )

clr <- rainbow(nrow(re))  ## define n colors

par(mfrow=c(1, 2))

ggplot()

p1<-sjPlot::plot_model(moi, type="pred", terms=c("time","Sex","Solution","session [1,6,11,15]"), pred.type="re", ci.lvl=NA)  

p2<-lattice::qqmath(ranef(moi, condVar=TRUE))
grid.arrange(p2[[3]],ncol=1)

#Statistical Summary Tables
sjPlot::tab_model(moi,show.ci=0.95,show.df=TRUE,show.r2=TRUE,show.icc=TRUE, show.p=TRUE,show.stat=TRUE,show.aic=TRUE,show.re.var= TRUE, title= moi.name,digits=3,digits.p=4, df.method = "satterthwaite",col.order = c("est", "se", "std.est", "std.se", "ci", "std.ci", "ci.inner", "ci.outer","df.error", "stat", "std.stat", "p", "std.p", "response.level"))

#QQPlots for Random Effects 
qqnorm(ranef(moi)$'Mouse:session'[,1])
qqnorm(ranef(moi)$'Mouse'[,1])
qqnorm(ranef(moi)$'Bout'[,1])


# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Drinking.mL.kg_gmc=c(),Drinking.mL.kg_imc=c(-2,0,2)))

             
# Plot specific interactions
emmip(RG, Solution ~ Duration_imc*Drinking.mL.kg_imc | time*Sex, style = "factor", CIs=TRUE)

# Plot diagnostics for clustered models
#refit as lm
model.clus<-lm(signal~Sex*Solution*time)
summclust(anova.nested3)


# See what proportions of variance are explained at each level
VarCorr(moi) #Take note of the names of each part of the random term. These will be what your PCA results represent and allow you to get rid of interactions or other variables that don't help (i.e. have near zero explained variance)
pca<-rePCA(moi)
var.MouseSesssionBout<-pca$`Mouse:session:Bout`$sdev^2
var.MouseSession.each<-pca$`Mouse:session`$sdev^2
var.MouseSession<-sum(pca$`Mouse:session`$sdev^2)
var.Bout<-pca$Bout$sdev^2
total.var<-sum(pca$`Mouse:session:Bout`$sdev^2,pca$`Bout`$sdev^2,pca$`Mouse:session`$sdev^2)

var_explained<-c("Mouse:Session:Bout"=(var.MouseSesssionBout/total.var),"Mouse:session"=(var.MouseSession/total.var),"Bout"=(var.Bout/total.var))
var_explained<-c("Mouse:Session:Bout"=(var.MouseSesssionBout/total.var),"Mouse:session"=(var.MouseSession.each/total.var),"Bout"=(var.Bout/total.var))

#Graph it!
qplot(names(var_explained), var_explained) + 
  geom_point(size=5)+
  xlab("Principal Component") + 
  ylab("Variance Explained") +
  ggtitle("Scree Plot") +
  ylim(0, 1)


## If failure to converge is not preceeded by a warning about singularity, you may want to see if a different optimizer can help it converge. Check all the optimizers using this code. This takes a while because it basically has to run your model through 7 times.

diff_optims <- allFit(model4.2zcPos_fit) #Run all the optimizers. NOTE: "OK" does NOT MEAN THE MODEL CONVERGES! Gotta do the steps below to see that. 

summary.opt<-modelsummary::msummary(unlist(diff_optims),stars=T,output="data.frame")

#Check all the messages for each model.
diff_optims_OK <- diff_optims[sapply(diff_optims, is, "merMod")]
comp<-lapply(diff_optims_OK, function(x) x@optinfo$conv$lme4$messages)

names<-names(comp)
comp.temp<-NULL
for (j in names(comp)){
  if(!is.null(comp[[j]])==TRUE){
  comp.temp[[j]]<-comp[[j]]
  }else{
    comp.temp[[j]]<-"NA"
}
  
}

write.xlsx(summary.opt,file=filemod2, sheetName = "Opt_Signal-Posfit7", append=TRUE, row.names=FALSE)     
write.xlsx(summary,file=filemod2, sheetName = "Signal-Pos Compare", append=TRUE, row.names=FALSE) 

#Rerun model with specific optimizer using the option in lmer: 
#model_fit <-lmerTest::lmer(...,control=lmerControl(optimizer="bobyqa")); 

##Check for problematic multicolinearity!!!! <5 is Ok. More than that and you might have an issue.
vif(moi)

ab <- augment(model4.2zd_fit)
ggplot(ab,
       aes(signal, .resid, colour = factor(Solution))) + geom_point() + geom_smooth()
```



# CREATE PUBLISHABLE GRAPHS

## 1) Bout Histograms

```{r}
###Bout Histogram by Sex and Solution

data.analysis_graph<-data.analysis_true
data.analysis_graph$Solution<-factor(data.analysis_graph$Solution, levels=c("EtOH","Water","Sucrose"))

ggplot(data.analysis_graph,aes(x=BoutStarts/60,fill=Solution)) + labs(x="**Bout Onset** (min)", y="**Percent of Bouts**")+theme_minimal()+geom_histogram(aes(y = after_stat(width*density)*100),binwidth=1)+facet_grid(Solution + Sex ~ .,space="free_y",labeller=labeller(Solution=c("Water"="","Sucrose"="","EtOH"="")))+scale_fill_manual(values = custom)+scale_x_continuous(breaks=scales::breaks_width(5),expand = expansion(0))+scale_y_continuous(expand = expansion(0))+theme(plot.title=element_text(size=title.sz,face="bold"),legend.title=element_blank(),legend.text=element_text(size=txt.sz2),legend.justification="center", legend.position="top",legend.direction ="horizontal",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=otr.sz1,color="black"),axis.title.y=element_markdown(margin=margin(r=3,unit="mm"),size=title.sz),axis.title.x=element_markdown(margin=margin(t=3,unit="mm"),size=title.sz),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text.y = element_text(margin=margin(l=3,unit="mm"),face="bold",size=txt.sz1),axis.ticks = element_line())+geom_hline(yintercept=0,linewidth=1,color="black")+geom_vline(xintercept=0,size=1,color="black")

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
ggsave(filename="CL8_Histogram_BoutProportion_by_Onset_Sex_Solution.tiff",plot=last_plot(), units="mm", width=715/.pt, height=450/.pt, dpi=1000,path=output)

#650 x 450 - bin width 0.5

##Mean Signal Plots with duration as the width of the tile 
bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Mean-Before Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=MeanBefore),width=bout.analysis2_true$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

bout.histogram<-ggplot(bout.analysis4,aes(x=BoutStarts/60,y=session)) + labs(title="Mean-After Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=MeanAfter),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Mean Difference (After-Before) Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=meanbeforeafter),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

#Mean by subject
bout.histogram<-ggplot(data.analysis_true,aes(x=BoutStarts/60,y=Mouse)) + labs(title="Mean-Before Across Session",x="Bout Start (min)", y="Mouse")+ geom_tile(stat = "identity", aes(fill=MeanBefore),width=data.analysis_true$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_discrete(labels = NULL,expand = expansion(0))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

##Peak Plots with duration as the width of the tile
bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Peak-Before Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=PeakBefore),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Peak-After Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=PeakAfter),width=bout.analysis2$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Peak Difference (After-Before) Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=peakbeforeafter),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()


##Licks Plot with duration as the width of the tile
bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Licks Across Session",x="Bout Start (min)", y="Session",size=16)+ geom_tile(stat = "identity", aes(fill=LicksPerBout),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Licks")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()
```

## 2) Bout Characteristics - Histograms of Raw & Centered Data

```{r}
##Signal raw
ggplot(data=bout.analysis2_true)+geom_bar(aes(x=signal),stat="density")
ggplot(data=bout.analysis2_true)+geom_bar(aes(x=signal),stat="density")+facet_wrap(~Sex*Solution)
ggplot(data=bout.analysis2_true)+geom_bar(aes(x=signal),stat="density")+facet_wrap(~Sex)

##Signal z2 Standardized
ggplot(data=bout.analysis2_true)+geom_bar(aes(x=signal),stat="density")
ggplot(data=bout.analysis2_true)+geom_bar(aes(x=signal),stat="density")+facet_wrap(~Sex*Solution)
ggplot(data=bout.analysis2_true)+geom_bar(aes(x=signal),stat="density")+facet_wrap(~Sex)


##Drinking.mL.kg
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg),stat="density")+facet_wrap(~Sex*Solution)
##Drinking.mL.kg
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg),stat="density")+facet_wrap(~Solution)


##Drinking.mL.kg_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_imc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_imc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_imc),stat="density")+facet_wrap(~Sex*Solution)

##Drinking.mL.kg_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_gmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_gmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_gmc),stat="density")+facet_wrap(~Sex*Solution)

#Drinking Within-Solution
#Drinkin.sol_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_imc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_imc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_imc),stat="density")+facet_wrap(~Sex*Solution)

##Drinking.sol_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_gmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_gmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_gmc),stat="density")+facet_wrap(~Sex*Solution)

# Sex-mean Centered Drinking
##Drinking.mL.kg_smc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_smc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_smc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_smc),stat="density")+facet_wrap(~Sex*Solution)

# Group-mean Centered Drinking (Centered within Context)
##Drinking.mL.kg_grpmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_grpmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_grpmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_grpmc),stat="density")+facet_wrap(~Sex*Solution)

##EtOH.gkg
ggplot(data=data.analysis_true)+geom_bar(aes(x=EtOH.gkg),stat="density")+facet_wrap(~Sex)

#EtOH.gkg_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=EtOH.gkg_imc),stat="density")+facet_wrap(~Sex)

#EtOH.gkg_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=EtOH.gkg_gmc),stat="density")+facet_wrap(~Sex)

#EtOH.gkg_smc
ggplot(data=data.analysis_true)+geom_bar(aes(x=EtOH.gkg_smc),stat="density")+facet_wrap(~Sex)


#Duration 
ggplot(data=data.analysis_true)+geom_bar(aes(x=BoutDuration),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=BoutDuration),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=BoutDuration),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=BoutDuration),stat="density")+facet_wrap(Sex~Solution)

##Duration_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_imc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_imc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_imc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_imc),stat="density")+facet_wrap(Sex~Solution)


##Duration_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_gmc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_gmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_gmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_gmc),stat="density")+facet_wrap(Sex~Solution)


##Duration_smc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_smc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_smc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_smc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_smc),stat="density")+facet_wrap(Sex~Solution)

##Duration_grpmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")+facet_wrap(Sex~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")+facet_wrap(Sex~Solution)

##LicksPerBout
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout),stat="density")+facet_wrap(Sex~Solution)

##LicksPerBout_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_imc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_imc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_imc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_imc),stat="density")+facet_wrap(Sex~Solution)


##LicksPerBout_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_gmc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_gmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_gmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_gmc),stat="density")+facet_wrap(Sex~Solution)
```

## 3) Bout Characteristics - Correlations

```{r}
#Bout Duration by LicksPerBout
ggplot(data=data.analysis_true, aes(x=BoutDuration, y=LicksPerBout))+ geom_point(alpha=0.2)+facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0)+theme_classic()+scale_y_continuous(n.breaks = 9,expand = expansion(c(0.02,0.04)))+ scale_x_continuous(breaks = c(0,8,16,24),expand = expansion(c(0.15,0.15)))+theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Duration (s)", y="Total Licks in Bout (#)")

#500 x 500

#Bout Duration by LicksPerBout - can check each mouse
ggplot(data=subset(data.analysis_true,Mouse==14), aes(x=BoutDuration, y=LicksPerBout))+geom_point()+ facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+ geom_smooth(method=lm)+stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+theme_classic()+scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+ scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Duration (s)", y="LicksPerBout")

#Bout Duration by Bout Start
ggplot(data=data.analysis_true, aes(x=BoutStarts, y=BoutDuration))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Bout Duration (s)")

#Duration vs BoutStarts
ggplot(data=data.analysis_true, aes(x=BoutStarts, y=Duration))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Lick Frequency (Hz)")

#Duration vs BoutDuration
ggplot(data=data.analysis_true, aes(x=BoutDuration, y=Duration))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Duration (s)", y="Lick Frequency (Hz)")

#Duration vs LicksPerBout
ggplot(data=data.analysis_true, aes(x=LicksPerBout_imc, y=Duration_imc))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Licks Per Bout", y="Lick Frequency (Hz)")


#BoutStarts vs LicksPerBout
ggplot(data=data.analysis_true, aes(x=BoutStarts, y=LicksPerBout_imc))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Licks Per Bout (individually centered)")

# BoutStarts by Bout
ggplot(data=bout.analysis2.meanz2, aes(x=Bout,y=BoutStarts))+geom_point()+geom_smooth()+facet_grid(Sex~Solution)
```

## 4) Bout-Level Characteristics - Group Differences

```{r}
####################################
####### PUBLISHED GRAPH ############
####################################

ReplicateAverages <- data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","MeanBefore","z2MeanBefore","z2MeanBefore","MeanAfter","z2MeanAfter","z2MeanAfter","meanbeforeafter","z2meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset","LicksPerBout_imc","LicksPerBout_gmc","Duration_imc","Duration_gmc","Drinking.mL.kg_imc","Drinking.mL.kg_gmc","EtOH.gkg_imc","EtOH.gkg_gmc","RAMP60to50sec","RAMP50to40sec","RAMP40to30sec","RAMP30to20sec","RAMP20to10sec","RAMP10to0sec","z1RAMP60to50sec","z1RAMP50to40sec","z1RAMP40to30sec","z1RAMP30to20sec","z1RAMP20to10sec","z1RAMP10to0sec","z2RAMP60to50sec","z2RAMP50to40sec","z2RAMP40to30sec","z2RAMP30to20sec","z2RAMP20to10sec","z2RAMP10to0sec"),type = "mean_se");  
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))  
ReplicateAverages$Solution <-factor(ReplicateAverages$Solution,levels=c("EtOH","Water","Sucrose"))
ReplicateAverages$group_shrt <-factor(ReplicateAverages$group_shrt,labels=c("Female EtOH", "Male EtOH","Female Water","Male Water","Female Sucrose","Male Sucrose")) 

ReplicateAverages.duration<-filter(ReplicateAverages, variable=="BoutDuration",preserve=TRUE) 
ReplicateAverages.MeanBefore<-filter(ReplicateAverages, variable=="MeanBefore",preserve=TRUE) 
ReplicateAverages.MeanAfter<-filter(ReplicateAverages, variable=="MeanAfter",preserve=TRUE) 
ReplicateAverages.freq<-filter(ReplicateAverages, variable=="LickFrequency",preserve=TRUE)   
ReplicateAverages.lick<-filter(ReplicateAverages, variable=="LicksPerBout",preserve=TRUE)
ReplicateAverages.drink.imc<-filter(ReplicateAverages,variable=="Drinking.mL.kg_imc",preserve=TRUE) 
ReplicateAverages.drink.gmc<-filter(ReplicateAverages,variable=="Drinking.mL.kg_gmc",preserve=TRUE) 
ReplicateAverages.duration.imc<-filter(ReplicateAverages, variable=="BoutDuration_imc",preserve=TRUE) 
ReplicateAverages.duration.gmc<-filter(ReplicateAverages, variable=="BoutDuration_gmc",preserve=TRUE)
ReplicateAverages.freq.imc<-filter(ReplicateAverages, variable=="Duration_imc",preserve=TRUE)   
ReplicateAverages.lick.imc<-filter(ReplicateAverages, variable=="LicksPerBout_imc",preserve=TRUE)
ReplicateAverages.freq.gmc<-filter(ReplicateAverages, variable=="Duration_gmc",preserve=TRUE)   
ReplicateAverages.lick.gmc<-filter(ReplicateAverages, variable=="LicksPerBout_gmc",preserve=TRUE)
ReplicateAverages.etoh<-filter(ReplicateAverages, variable=="EtOH.gkg",preserve=TRUE)
ReplicateAverages.etoh.imc<-filter(ReplicateAverages, variable=="EtOH.gkg_imc",preserve=TRUE)   
ReplicateAverages.etoh.gmc<-filter(ReplicateAverages, variable=="EtOH.gkg_gmc",preserve=TRUE)

ReplicateAverages.r60<-filter(ReplicateAverages,variable=="RAMP60to50sec")
ReplicateAverages.r50<-filter(ReplicateAverages,variable=="RAMP50to40sec")
ReplicateAverages.r40<-filter(ReplicateAverages,variable=="RAMP40to30sec")
ReplicateAverages.r30<-filter(ReplicateAverages,variable=="RAMP30to20sec")
ReplicateAverages.r20<-filter(ReplicateAverages,variable=="RAMP20to10sec")
ReplicateAverages.r10<-filter(ReplicateAverages,variable=="RAMP10to0sec")

ReplicateAverages.rz60<-filter(ReplicateAverages,variable=="z2RAMP60to50sec")
ReplicateAverages.rz50<-filter(ReplicateAverages,variable=="z2RAMP50to40sec")
ReplicateAverages.rz40<-filter(ReplicateAverages,variable=="z2RAMP40to30sec")
ReplicateAverages.rz30<-filter(ReplicateAverages,variable=="z2RAMP30to20sec")
ReplicateAverages.rz20<-filter(ReplicateAverages,variable=="z2RAMP20to10sec")
ReplicateAverages.rz10<-filter(ReplicateAverages,variable=="z2RAMP10to0sec")

data.analysis_t_graph<-data.analysis_true
data.analysis_t_graph$Solution<-factor(data.analysis_t_graph$Solution,levels=c("EtOH","Water","Sucrose"))

##BoutDuration#
# Lines above individual bars or sets of bars
annotation_df<-data.frame(
  xstart=c(0.6,1.6,2.6,3.6,4.6,5.6),
  xend=c(1.4,2.4,3.4,4.4,5.4,6.4),
  yvals= c(14.5,15.5,15,16,10.5,17.5),
  labels=c(paste("list(symbol(''))",sep=","))
  )
# Lines above solutions (both sexes)
annotation_df1<-data.frame(
  xstart=c(0.6,2.6,4.6,2.6),
  xend=c(2.4,4.4,6.4,6.4),
  yvals= c(17.9,18.2,19.75,22.1),
  labels=c(paste("list(symbol(''))",sep=","))
  )
#Sig indicator connectors to indicate differences between sexes - EtOH
annotation_df2<-data.frame(
  xstart=c(1),
  xend=c(2),
  yvals= c(16.2),
  labels=c(paste("list(symbol('***'))",sep=",")))

#Sig indicator connectors to indicate differences between sexes - Water
annotation_df3<-data.frame(
  xstart=c(3),
  xend=c(4),
  yvals= c(16.7),
  labels=c(paste("list(scriptstyle('ns'))",sep=",")))

#Sig indicator connectors to indicate differences between sexes - Sucrose
annotation_df4<-data.frame(
  xstart=c(5),
  xend=c(6),
  yvals= c(18.1),
  labels=c(paste("list(symbol('*'))",sep=",")))

#Sig indicator connectors to indicate differences between Solutions
annotation_df5<-data.frame(
  xstart=c(1.5),
  xend=c(4.5),
  yvals= c(23),
  labels=c(paste("list(symbol('*'))",sep=",")))

annotation_df6<-data.frame(
  xstart=c(3.5),
  xend=c(5.5),
  yvals= c(20.5),
  labels=c(paste("list(symbol('**'))",sep=",")))


ggplot(data=data.analysis_t_graph,aes(x=group_shrt,y=BoutDuration, fill=Solution), group= factor(group_shrt)) +theme_classic()+scale_fill_manual(values = custom,guide=guide_legend(override.aes = list(size=4)))+geom_bar(data=ReplicateAverages.duration,stat="identity",aes(y=mean,fill=Solution),size=1,alpha=0.3)+scale_color_manual(values = custom)+geom_beeswarm(cex=0.35,size=1.5,alpha=0.55,priority="density",aes(color=Solution))+geom_errorbar(data=ReplicateAverages.duration,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+scale_x_discrete(labels=c("Female","Male","Female","Male","Female","Male"),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,25),expand = expansion(c(0.00,0.03)))+theme(legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.8,0.97),legend.background=element_rect(fill="transparent"),axis.text.x=element_text(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(group_shrt=c("Female","Male","Female","Male","Female","Male"),x=NULL, y="**Bout Duration** (seconds)")+geom_signif(inherit.aes=FALSE,data=annotation_df1,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0,size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.032,0.032),size=0.5,vjust= 0,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.032,0.032),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.032,0.032),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df5,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.224,0.036),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df6,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.099,0.031),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE) 

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
ggsave(filename="CL8_BeeswarmBouts_Duration_by_Sex_Solution.tiff",plot=last_plot(), units="mm", width=350/.pt, height=450/.pt, dpi=600,path=output,device=grDevices::tiff)
#550 x 450


#Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

##LickFrequency# 
p1<-ggplot(data=data.analysis_t_graph,aes(x=group_shrt,y=LickFrequency), group_shrt= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.freq,stat="identity",aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.4,size=2,alpha=0.45,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.freq,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=2,limits=c(0,14),expand = expansion(c(0.0,0.0)))+scale_y_break(breaks=c(3,4.8),scales=15,ticklabels = c(4,5,6,7,8,9,10,11,12,13,14),expand = expansion(c(0.04,0.02)))+theme(legend.title=element_blank(),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.5,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.y.right = element_blank(),axis.ticks.y.right = element_blank(),axis.line.y.right = element_blank())+labs(x=NULL, y="**Lick Frequency**<br>(licks/sec)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep="")),y_position = c(12.5,12.5,13),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female EtOH"), xmax = c("Male EtOH"),annotations= c(paste("list(~symbol('*'))",sep="")),y_position = c(13.5),textsize = 6,tip_length = 0.00,size=1,vjust= -0.05,parse=TRUE,extend_line = .05)

## ggbreak plot without legend
p2 <- p1 +
    theme(legend.position="none") 

## extract legend from original plot
leg = cowplot::get_legend(p1)

## redraw the figure
p3 <- ggplotify::as.ggplot(print(p2))

## place the legend 
p3 + ggimage::geom_subview(x=.75, y=.95, subview=leg)
#700x500


##LickPerBout# 
ggplot(data=data.analysis_true,aes(x=group_shrt,y=LicksPerBout), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.lick,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.2,size=2,alpha=0.6,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.lick,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,160),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Licks in Each Bout**<br>(number)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1))) 
#750 x 300

##LicksPerBout_imc# 
ggplot(data=data.analysis_true,aes(x=group_shrt,y=LicksPerBout_imc), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.lick.imc,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.lick.imc,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-1.5,9),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Individual LicksPerBout**<br>(Bout Licks Mouse-Mean Centered)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1))) 

#BoutDuration_imc
ggplot(data=data.analysis_true,aes(x=group_shrt,y=Duration_imc), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.duration.imc,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.duration.imc,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-1.5,9),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Individual Bout Duration**<br>(Mouse-Mean Centered)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1))) 

#Duration_imc
ggplot(data=data.analysis_true,aes(x=group_shrt,y=Duration_imc), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.freq.imc,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.freq.imc,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-3,5.5),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Individual Bout Duration**<br>(Mouse-Mean Centered)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1))) 

##RAMP Signal - plug in each# 
ggplot(data=data.analysis_true,aes(x=group_shrt,y=RAMP10to0sec), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.r10,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.r10,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-10,45),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Signal**<br>(%dF/F,10-0sec Signal)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

##RAMP Signal - population#
spec<-data.frame(".name"=c("RAMP60to50sec","RAMP50to40sec","RAMP40to30sec","RAMP30to20sec","RAMP20to10sec","RAMP10to0sec"),".value"=c(rep.int("rampsignal",6)),"timepoint"=c("60","50","40","30","20","10"))
dat<-data.analysis_true %>%
  pivot_longer_spec(spec)

dat$Output.Order<-factor(dat$Output.Order,levels=c(1:3549))
dat$timepoint<-as.numeric(dat$timepoint)

ReplicateAverages.dat <- dat %>% group_by(Mouse,Sex,Solution,group_shrt,timepoint) %>% get_summary_stats(c("rampsignal"),type = "mean_se")
ReplicateAverages.dat$Sex <-factor(ReplicateAverages.dat$Sex,levels=c("Female", "Male"))  

ReplicateAverages.dat$group_shrt <-factor(ReplicateAverages.dat$group_shrt,labels=c("Female EtOH", "Male EtOH","Female Water","Male Water","Female Sucrose","Male Sucrose"))

ggplot(data=dat,aes(x=timepoint,y=rampsignal,group_shrt=Output.Order))+theme_classic()+geom_point(color="grey")+geom_line(size=0.5,alpha=0.6,aes(color=Solution))+facet_grid(~Solution)+geom_line(data=ReplicateAverages.dat,aes(x=timepoint,y=mean,group=Mouse))+scale_color_manual(values = c(custom))+scale_x_reverse(expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-10,45),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text=element_text(size=14,face="bold"))+labs(x="**Interval Beginning at X Seconds Before Bout**", y="**Ramping Signal**<br>(%dF/F)")+guides(color=guide_legend(override.aes = list(linewidth=6,alpha=1)))

##z1RAMP Signal - population#
spec<-data.frame(".name"=c("z1RAMP60to50sec","z1RAMP50to40sec","z1RAMP40to30sec","z1RAMP30to20sec","z1RAMP20to10sec","z1RAMP10to0sec"),".value"=c(rep.int("rampsignal",6)),"timepoint"=c("60","50","40","30","20","10"))
dat<-data.analysis_true %>%
  pivot_longer_spec(spec)

dat$Output.Order<-factor(dat$Output.Order,levels=c(1:3549))
dat$timepoint<-as.numeric(dat$timepoint)

ReplicateAverages.dat <- dat %>% group_by(Mouse,Sex,Solution,group_shrt,timepoint) %>% get_summary_stats(c("rampsignal"),type = "mean_se")
ReplicateAverages.dat$Sex <-factor(ReplicateAverages.dat$Sex,levels=c("Female", "Male"))  

WholeAvg.dat <- dat %>% group_by(Sex,Solution,group_shrt,timepoint) %>% get_summary_stats(c("rampsignal"),type = "mean_se")
WholeAvg.dat$Sex <-factor(WholeAvg.dat$Sex,levels=c("Female", "Male"))  

ReplicateAverages.dat$group_shrt <-factor(ReplicateAverages.dat$group_shrt,labels=c("Female EtOH", "Male EtOH","Female Water","Male Water","Female Sucrose","Male Sucrose"))

ggplot(data=dat,aes(x=timepoint,y=rampsignal,group=Output.Order))+theme_classic()+geom_point(color="grey")+geom_line(size=0.5,alpha=0.5,aes(color=Solution),show.legend=FALSE)+facet_grid(~Solution)+geom_line(data=ReplicateAverages.dat,aes(x=timepoint,y=mean,group=Mouse))+geom_line(data=WholeAvg.dat,aes(x=timepoint,y=mean,group=group_shrt),linewidth=2)+geom_ribbon(data=WholeAvg.dat,aes(x=timepoint,y=mean,ymin=mean-se,ymax=mean+se,group=group_shrt),linetype=2,linewidth=3,alpha=0.1)+scale_color_manual(values = c(custom))+scale_x_reverse(expand = expansion(0.1),breaks=c(60,50,40,30,20,10,0))+scale_y_continuous(n.breaks=10, limits=c(-2,12),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.87,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text=element_text(size=14,face="bold"))+labs(x="**Seconds Before Bout**", y="**Signal**<br>(z%dF/F)")+guides(color=guide_legend(override.aes = list(linewidth=6,alpha=1)))

ggplot(data=dat,aes(x=timepoint,y=rampsignal,group=Output.Order))+theme_classic()+facet_grid(~Solution)+geom_line(data=ReplicateAverages.dat,aes(x=timepoint,y=mean,group=Mouse,color=Mouse),linewidth=1)+geom_line(data=WholeAvg.dat,aes(x=timepoint,y=mean,group=group_shrt),linewidth=1)+scale_x_reverse(expand = expansion(0.1),breaks=c(60,50,40,30,20,10,0))+scale_y_continuous(n.breaks=10, limits=c(-0.5,2.5),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.99,0.87),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text=element_text(size=14,face="bold"))+labs(x="**Seconds Before Bout**", y="**Ramping Signal**<br>(z%dF/F)")+guides(color=guide_legend(override.aes = list(linewidth=6,alpha=1)))


ggplot(data=dat,aes(x=timepoint,y=rampsignal,group=Output.Order))+theme_classic()+facet_grid(~Solution)+geom_line(data=WholeAvg.dat,aes(x=timepoint,y=mean,group=group_shrt,linetype=Sex),linewidth=1)+geom_ribbon(data=WholeAvg.dat,aes(x=timepoint,y=mean,ymin=mean-se,ymax=mean+se,group=group_shrt,fill=Solution),linetype=2,linewidth=3,alpha=0.2,show.legend=FALSE)+scale_color_manual(values = c(custom))+scale_x_reverse(expand = expansion(0.1),breaks=c(60,50,40,30,20,10,0))+scale_y_continuous(n.breaks=10, limits=c(0,2),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=15),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.35,0.85),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=16),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text=element_text(size=14,face="bold"))+labs(x="**Seconds Before Bout**", y="**Signal**<br>(z%dF/F)")+guides(color=guide_legend(override.aes = list(linewidth=7,alpha=1)))




#Moving to Session Level Relationships with Bout Characteristics

#Get Stupid summaries of the new statistical variables
session.analysis5<-data.analysis_true %>%
    group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>% 
   summarize(across(c("Drinking.mL.kg_imc","LicksPerBout_imc","Duration_imc","Duration_imc"),list(mean=mean,se=std.error,min=min,max=max)))

##Drinking.mL.kg_imc 
ggplot(data=session.analysis5,aes(x=group_shrt,y=Drinking.mL.kg_imc_mean), group= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.drink.imc,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.drink.imc,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-4,2.5),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Individual Drinking**<br>(Session Drinking Mouse-Mean Centered)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

## Now trying to get a handle on the crazy interactions



```

#### a) First 10 vs Last 10 minutes - Signal and Characteristics

```{r}
###############################
## First 10 vs Last 10 min#####

data.analysis_t_graph<-data.analysis_true
data.analysis_t_graph$Solution<-factor(data.analysis_t_graph$Solution,levels=c("EtOH","Water","Sucrose"))
data.analysis_t_graph$Position<-factor(data.analysis_t_graph$Position,levels=c("First 10 min","Middle","Last 10 min"))

#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds)

ReplicateAverages1 <- data.analysis_t_graph %>% group_by(Sex,Solution,group_shrt,Position) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","z2MeanAfter","z2MeanBefore","z2meanbeforeafter"),type = "mean_se"); 
ReplicateAverages1$Sex <-factor(ReplicateAverages1$Sex,levels=c("Female", "Male"))
ReplicateAverages1$Position <-factor(ReplicateAverages1$Position,levels=c("First 10 min", "Middle","Last 10 min"))

ReplicateAverages1.sigaft<-filter(ReplicateAverages1,variable=="z2MeanAfter",preserve=TRUE)
ReplicateAverages1.sigbef<-filter(ReplicateAverages1,variable=="z2MeanBefore",preserve=TRUE)
ReplicateAverages1.sigdiff<-filter(ReplicateAverages1,variable=="z2meanbeforeafter",preserve=TRUE)
ReplicateAverages1.freq<-filter(ReplicateAverages1,variable=="LickFrequency",preserve=TRUE)
ReplicateAverages1.duration<-filter(ReplicateAverages1,variable=="BoutDuration",preserve=TRUE)
ReplicateAverages1.licks<-filter(ReplicateAverages1,variable=="LicksPerBout" ,preserve=TRUE)

# Standardized Signal After 
ggplot(data=data.analysis_t_graph)+theme_classic()+geom_col_pattern(data=ReplicateAverages1.sigaft,aes(x=group_shrt,y=mean,pattern=Position), pattern_fill="black",pattern_density=0.55,pattern_spacing=0.02,pattern_key_scale_factor=2,fill="grey",size=1,position="dodge")+geom_beeswarm(data=data.analysis_t_graph,cex=0.25,size=2,alpha=0.6,aes(x=group_shrt,y=z2MeanAfter,group= factor(Position),color=Solution),dodge.width = .8)+scale_color_manual(values = custom)+geom_errorbar(data=subset(ReplicateAverages1.sigaft,!is.na(Position)),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.8))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-3,6),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.background=element_rect(fill="transparent"),legend.direction = "horizontal", legend.position=c(0.90,0.90),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Std Signal After (z%dF/F)**")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

#700 x 550

#Standardized Signal Before
ggplot(data=subset(data.analysis_true,!is.na(Position)))+theme_classic()+geom_col_pattern(data=subset(ReplicateAverages1.sigbef,!is.na(Position)),aes(x=group,y=mean,pattern=Position), pattern_fill="black",pattern_density=0.55,pattern_spacing=0.02,pattern_key_scale_factor=2,fill="grey",size=1,position="dodge")+geom_beeswarm(data=subset(data.analysis_true,!is.na(Position)),cex=0.25,size=2,alpha=0.6,aes(x=group_shrt,y=z2MeanBefore,group= factor(Position),color=Solution),dodge.width = .8)+scale_color_manual(values = custom)+geom_errorbar(data=subset(ReplicateAverages1.sigbef,!is.na(Position)),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.8))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-3,6),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.background=element_rect(fill="transparent"),legend.direction = "horizontal", legend.position=c(0.90,0.90),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Std Signal Before (z%dF/F)**")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

#700 x 550

#Standardized Signal Difference (After-Before) by First and Last 10 min
ggplot(data=subset(data.analysis_true,!is.na(Position)))+theme_classic()+geom_col_pattern(data=subset(ReplicateAverages1.sigdiff,!is.na(Position)),aes(x=group_shrt,y=mean,pattern=Position), pattern_fill="black",pattern_density=0.55,pattern_spacing=0.02,pattern_key_scale_factor=2,fill="grey",size=1,position="dodge")+geom_beeswarm(data=subset(data.analysis_true,!is.na(Position)),cex=0.25,size=2,alpha=0.6,aes(x=group_shrt,y=z2meanbeforeafter,group= factor(Position),color=Solution),dodge.width = .8)+scale_color_manual(values = custom)+geom_errorbar(data=subset(ReplicateAverages1.sigdiff,!is.na(Position)),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.8))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-3.5,7),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.90),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Std Signal Difference (z%dF/F)**")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))


##LickFrequency by Position
p1<-ggplot(data=data.analysis_t_graph)+theme_classic()+geom_col_pattern(data=ReplicateAverages1.freq,aes(x=group_shrt,y=mean,pattern=Position), pattern_fill="black",pattern_density=0.55,pattern_spacing=0.02,pattern_key_scale_factor=1,fill="grey",size=1,position="dodge")+geom_beeswarm(data=data.analysis_t_graph,cex=0.1,size=2,alpha=0.6,aes(x=group_shrt,y=LickFrequency,group=Position,color=Solution),dodge.width = .85)+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages1.freq,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=Position),width=0.4,size=1,color="black",position=position_dodge(0.85))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=2,limits=c(0,14),expand = expansion(c(0.0,0.0)))+scale_y_break(breaks=c(3,4.8),scales=15,ticklabels = c(4,5,6,7,8,9,10,11,12,13,14),expand = expansion(c(0.04,0.02)))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.90),legend.spacing.y= unit(-0.1,"cm"),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=16),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Lick Frequency**<br>(licks/sec)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep="")),y_position = c(12.5,12.5,13),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female EtOH"), xmax = c("Male EtOH"),annotations= c(paste("list(~symbol('*'))",sep="")),y_position = c(13.5),textsize = 6,tip_length = 0.00,size=1,vjust= -0.05,parse=TRUE,extend_line = .05)

## ggbreak plot without legend
p2 <- p1 +
    theme(legend.position="none") 

## extract legend from original plot
leg = cowplot::get_legend(p1)

## redraw the figure
p3 <- ggplotify::as.ggplot(print(p2))

## place the legend 
p3 + ggimage::geom_subview(x=.75, y=.95, subview=leg)
#700x500


#750 x 500

##LicksPerBout
ggplot(data=subset(data.analysis_true,!is.na(Position)))+theme_classic()+geom_col_pattern(data=subset(ReplicateAverages1.licks,!is.na(Position)),aes(x=group_shrt,y=mean,pattern=Position),pattern_fill="black", pattern_density = 0.55, pattern_spacing=0.02,pattern_key_scale_factor = .85,fill="grey",size=1,position="dodge")+geom_beeswarm(data=subset(data.analysis_true,!is.na(Position)),cex=0.05,size=3,alpha=0.6,aes(x=group_shrt,y=LicksPerBout, group= Position,color=Solution),stat="identity",dodge.width = .85)+scale_color_manual(values = custom)+geom_errorbar(data=subset(ReplicateAverages1.licks,!is.na(Position)),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.85))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,150),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.90),legend.spacing.y= unit(-0.1,"cm"),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Licks Within Bout (#)**")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

#BoutDuration
ggplot(data=data.analysis_t_graph)+theme_classic()+geom_col_pattern(data=ReplicateAverages1.duration,aes(x=group_shrt,y=mean,pattern=Position),pattern_fill="black", pattern_density = 0.55, pattern_spacing=0.02,pattern_key_scale_factor = .85,fill="grey",size=1,position="dodge")+geom_beeswarm(data=data.analysis_t_graph,cex=0.1,size=2,alpha=0.6,aes(x=group_shrt,y=BoutDuration, group= Position,color=Solution),stat="identity",dodge.width =0.85)+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages1.duration,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.85))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,25),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.90),legend.spacing.y =  unit(-0.1,"cm"),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Bout Duration**<br>(seconds)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

#+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep="")),y_position = c(12.5,12.5,13),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female EtOH"), xmax = c("Male EtOH"),annotations= c(paste("list(~symbol('*'))",sep="")),y_position = c(13.5),textsize = 6,tip_length = 0.00,size=1,vjust= -0.05,parse=TRUE,extend_line = .05)
#750x 500
```

## 5) Signal

### a) For CL8

#### i) Individual Bouts & Averages by Sex, Solution, & Time

```{r}
################ SIGNAL #####################
## By default, these use the solution as the color key but you can change this for any of these graphs by changing "aes(x= ,y=),group=factor(group)" to "aes(x= ,y=), group=subject" and change "scale_color_manual(values = custom)" to "scale_colour_brewer(palette = "Dark2")"

#Overall Within-Mouse Trend - Mean Before vs Mean After
ggplot(data=bout.analysis2_true, aes(x=time,y=signal,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+
  labs(title="Mouse #",y="Mean Signal (%dF/F)",x="Time Around Bout") + 
  facet_grid2(Solution~ Mouse) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=14, face="bold"),
        axis.title.x = element_markdown(size=16),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text=element_text(size=12),
        strip.text=element_text(size=14))


#Overall Within-Mouse Trend - Mean After minus Mean Before  
ggplot(data=data.analysis_true, aes(x=Mouse,y=meanbeforeafter,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  labs(title="Mouse #",y="Mean Signal After-Before (%dF/F)") + 
  facet_grid2(Solution~ Mouse) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=14, face="bold"),
        axis.title.x = element_blank(),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size=12),
        strip.text=element_text(size=14))

#Overall Within-Session Trend - Mean Before vs Mean After
ggplot(data=bout.analysis2_true, aes(x=time,y=signal,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+
  labs(title="Session #",y="Mean Signal (%dF/F)",x="Time Around Bout") + 
  facet_grid2(Solution~ session) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=14, face="bold"),
        axis.title.x = element_markdown(size=16),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text=element_text(size=12),
        strip.text=element_text(size=14))

############
##Plot signal for all bouts per group 
ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","signal","meanbeforeafter","z1meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="signal",preserve=TRUE)
ReplicateAverages.signal.mean<-filter(ReplicateAverages.signal,time=="MeanBefore"|time=="MeanAfter",preserve=TRUE)
ReplicateAverages.signal.meanz1<-filter(ReplicateAverages.signal,time=="z1MeanBefore"|time=="z1MeanAfter",preserve=TRUE)

ggplot(data=bout.analysis2_true,aes(x=group,y=signal), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages.signal.mean,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(-5,20))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

#Same as above but now color encodes animals (as an example)
ggplot(data=bout.analysis2_true,aes(x=group,y=signal), group= subject) +
theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=subject,size=2))+
scale_colour_brewer(palette = "Dark2")+geom_point(data=ReplicateAverages.signal.mean,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))

#First 10 min vs last 10 min
##Plot signal for all bouts per group 
#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds)
bout.analysis2_true10<-filter(bout.analysis2_true,BoutStarts<=740,preserve=TRUE)
ReplicateAverages1 <- bout.analysis2_true10 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","signal","meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages1$Sex <-factor(ReplicateAverages1$Sex,levels=c("Female", "Male"))
ReplicateAverages1.signal<-filter(ReplicateAverages1,variable=="signal",preserve=TRUE)
ReplicateAverages1.freq<-filter(ReplicateAverages1,variable=="Duration",preserve=TRUE)

ggplot(data=bout.analysis2_true10,aes(x=group,y=signal), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages1.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-5,34),breaks=c(-5,0,5,10,15,20,25,30,35))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))



#Last 10 min (7888-600)
bout.analysis2_true90<-filter(bout.analysis2_true,BoutStarts>=7288,preserve=TRUE)

ReplicateAverages2 <- bout.analysis2_true90 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","signal","meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages2$Sex <-factor(ReplicateAverages2$Sex,levels=c("Female", "Male"))
ReplicateAverages2.signal<-filter(ReplicateAverages2,variable=="signal",preserve=TRUE)
ReplicateAverages2.freq<-filter(ReplicateAverages2,variable=="Duration",preserve=TRUE)

ggplot(data=bout.analysis2_true90,aes(x=group,y=signal), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages2.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-5,34),breaks=c(-5,0,5,10,15,20,25,30,35))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))

#Let's look at differences between before and after
#As Mean Difference
ReplicateAverages.data<-data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.data.meandiff<-filter(ReplicateAverages.data,variable=="meanbeforeafter",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=meanbeforeafter,group= factor(group_shrt))) + geom_beeswarm(cex=0.4,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom)+geom_point(data=ReplicateAverages.data.meandiff,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(limits=c(-10,25),breaks=c(-10,-5,0,5,10,15,20,25),labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+labs(x="**Group**", y="**Signal Change**<br>(Post-Pre Bout,%dF/F)")+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title.y =element_markdown(size=18),axis.title.x =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))+geom_hline(aes(yintercept=0),linetype="88",linewidth=1.3)

#As Percent Difference - GARBAGE. Too Variable
ReplicateAverages.data<-data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.data.pmeandiff<-filter(ReplicateAverages.data,variable=="pmeanbeforeafter",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=pmeanbeforeafter,group= factor(group_shrt))) + geom_beeswarm(cex=.09,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom)+geom_point(data=ReplicateAverages.data.pmeandiff,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=3)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(limits=c(-10000,15000),labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Percent Signal Change (Post-Pre Bout,%dF/F)")+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))

##Now bout duration#
ReplicateAverages.data.duration<-filter(ReplicateAverages.data,variable=="BoutDuration",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=BoutDuration), group= factor(group_shrt)) + geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2)) + scale_colour_manual(values = custom)+geom_point(data=ReplicateAverages.data.duration,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Bout Duration (s)")+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))

##Lick frequency#
ReplicateAverages.data.freq<-filter(ReplicateAverages.data,variable=="Duration",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=Duration), group= factor(group_shrt)) + geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2)) + scale_colour_manual(values = custom)+geom_point(data=ReplicateAverages.data.freq,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Lick Frequency (licks/s)")+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))

##Licks/Bout#
ReplicateAverages.data.licksbout<-filter(ReplicateAverages.data,variable=="LicksPerBout",preserve=TRUE)

ggplot(data=data.analysis,aes(x=group_shrt,y=LicksPerBout, color=factor(subject)), group= factor(Solution)) + geom_beeswarm(cex=0.5,size=1) + scale_colour_brewer(palette = "Dark2")+geom_point(data=ReplicateAverages.data.licksbout,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Licks/Bout")


##Tried out error bars. Hated it:
ggplot(data=bout.analysis2_true,aes(x=group,y=signal, color=subject), group= factor(Solution)) + geom_beeswarm(cex=0.5,size=1) + scale_colour_brewer(palette = "Dark2")+geom_errorbar(data=ReplicateAverages.signal.mean,aes(x=group,y=mean,ymin=mean-se,ymax=mean+se),color="black")+geom_point(data=ReplicateAverages.signal.mean,aes(x=group,y=mean,shape=Sex),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend("Subject"),shape=guide_legend("Sex"))
```

#### iii) Global Correlations With Bout Characteristics

##### 1) Bout Duration

```{r}
#Bout Duration by Solution
ggplot(data=bout.analysis2_true, aes(x=Duration_imc, y=signal))+
  geom_point()+
  facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration (ind. mean centered)", y="Signal %dF/F")

#Bout Duration by Solution & Sex
ggplot(data=bout.analysis2_true, aes(x=Duration_imc, y=signal))+
  geom_point()+
  facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration (indiv. mean centered)", y="Signal %dF/F")

#Bout Duration by Solution - Diff Between After and Before
ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Sex - Signal Difference between Before & After
ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Mouse - Signal Difference between Before & After
ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")
```

##### b) Bout \#

```{r}
#Bout Duration by Solution
ggplot(data=bout.analysis2_true, aes(x=Bout, y=signal))+
  geom_point()+
  facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal %dF/F")

#Bout Duration by Solution & Sex
ggplot(data=bout.analysis2_true, aes(x=Bout, y=signal))+
  geom_point()+
  facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal %dF/F")

#Bout Duration by Solution - Signal Diff Between Before & After
ggplot(data=bout.analysis2_true, aes(x=Bout, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Sex - Signal Diff Between Before & After
ggplot(data=bout.analysis2_true, aes(x=Bout, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Mouse - Signal Difference between Before & After
ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")
```

##### c) Bout Start

```{r}
#Bout Starts by Solution 
ggplot(data=bout.analysis2_true, aes(x=BoutStarts, y=signal))+   geom_point()+   facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Signal %dF/F")  
#Bout Duration by Solution & Sex 
ggplot(data=bout.analysis2_true, aes(x=BoutStarts, y=signal))+   geom_point()+   facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Signal %dF/F")
```

##### 4) Lick Frequency

```{r}
#Lick Frequency by Solution
ggplot(data=bout.analysis2_true, aes(x=Duration_mc, y=signal))+
  geom_point()+
  facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (z-score)", y="Signal (%dF/F)")

#Lick Frequency by Solution & Sex
ggplot(data=bout.analysis2_true, aes(x=Duration, y=signal))+
  geom_point()+
  facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (%dF/F)")

#Lick Frequency by Solution & Mouse 
ggplot(data=bout.analysis2_true, aes(x=Duration, y=signal))+
  geom_point()+
  facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (%dF/F)")

#Lick Frequency by Solution - Signal Diff Between Before & After
ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (scaled)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Sex - Signal Diff Between Before & After
ggplot(data=bout.analysis2_true, aes(x=Duration, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (After-Before) %dF/F")

#Lick Frequency by Solution & Mouse - Signal Difference between Before & After
ggplot(data=bout.analysis2_true, aes(x=Duration, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (After-Before) %dF/F")
```

## 6) Standardized Signal

### a) For CL8

#### i) Individual Bouts & Averages by Sex, Solution, & Time
##### z2Mean

```{r}
#Overall Within-Mouse Trend - Mean Before vs Mean After 
ggplot(data=bout.analysis2_true, aes(x=time,y=z2Mean,color=Solution)) +   geom_point(show.legend = FALSE) +   theme_minimal()+   scale_color_manual(values=custom)+   stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +   scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+   labs(title="Mouse #",y="Standardized Mean Signal (z%dF/F)",x="Time Around Bout") +    facet_grid2(Solution~ Mouse) +   theme(panel.grid.minor = element_blank(),         title = element_text(size=14, face="bold"),         axis.title.x = element_markdown(size=16),         axis.title.y=element_text(size=16,face="bold"),         axis.text=element_text(size=12), strip.text=element_text(size=14))

#Overall Within-Mouse Trend - Mean After minus Mean Before  
ggplot(data=data.analysis_true, aes(x=Mouse,y=z2meanbeforeafter,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  labs(title="Mouse #",y="Standardized Mean Signal After-Before (z%dF/F)") + 
  facet_grid2(Solution~ Mouse) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=14, face="bold"),
        axis.title.x = element_blank(),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size=12),
        strip.text=element_text(size=14))

#Overall Within-Session Trend - Mean Before vs Mean After
ggplot(data=bout.analysis2_true, aes(x=time,y=signal,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+
  labs(title="Session #",y="Standardized Mean Signal (z%dF/F)",x="Time Around Bout") + 
  facet_grid2(Solution~ session) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=14, face="bold"),
        axis.title.x = element_markdown(size=16),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text=element_text(size=12),
        strip.text=element_text(size=14))

################################################
######### Published Graph ######################
################################################

##Plot signal for all bouts per group 
ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="z2Mean",preserve=TRUE)


boutgraphz2<-bout.analysis2_true
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=c("EtOH","Water","Sucrose"))

ggplot(data=boutgraphz2,aes(x=group,y=z2Mean), group= factor(group))+theme_classic()+geom_beeswarm(cex=0.7,size=2,alpha=0.5,aes(color=Solution,size=2),corral="wrap")+scale_color_manual(values =custom)+geom_point(data=ReplicateAverages.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"),expand=expansion(0.05))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-2.5,6),breaks=c(-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.key.size=unit(5,"mm"),legend.text=element_text(size=title.sz),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.73,0.94),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz3,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=title.sz,hjust=c(0.053,-3.6,-4.43,-10.5,-8.9,-17.4)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes=list(size=6,alpha=1)),shape=guide_legend(override.aes=list(size=6,alpha=1))) +geom_signif(xmin=c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"), xmax = c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"),annotations=c(paste("list(symbol('*')~plain('^'))",sep=","),paste("list(~symbol('*')~plain('^'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=",")),y_position = c(5,5,3,3,5,5),textsize = otr.sz2, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_BeeswarmBouts_StandardizedSignal_by_time_Sex_SI.tiff",plot=last_plot(), units="mm", width=900/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

#650 x 450
 
################################################
######### Published Graph - Violin #############
################################################

##Plot signal for all bouts per group 
ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","signal","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="signal",preserve=TRUE)
ReplicateAverages.signal.mean<-filter(ReplicateAverages.signal,time=="MeanBefore"|time=="MeanAfter",preserve=TRUE)
ReplicateAverages.signal.meanz2<-filter(ReplicateAverages.signal,time=="z2MeanBefore"|time=="z2MeanAfter",preserve=TRUE)

boutgraphz2<-bout.analysis2_true
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=c("EtOH","Water","Sucrose"))

#+geom_crossbar(data=ReplicateAverages.signal.meanz2,aes(x=group,y=mean,ymin=mean,ymax=mean),width=c(0.45,0.5,0.5,0.45),linewidth=0.2,color="black")
ggplot(data=boutgraphz2,aes(x=group,y=signal), group= factor(group))+theme_classic()+geom_violin(aes(fill=Solution),alpha=0.8,stat="ydensity")+scale_fill_manual(values =custom)+geom_point(data=ReplicateAverages.signal.meanz2,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"),expand=expansion(0.05))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-2.5,6),breaks=c(-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz3),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.82,0.92),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=txt.sz2,hjust=c(0.048,-3,-3.7,-8.85,-7.455,-14.63)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes=list(size=4,alpha=1))) +geom_signif(xmin=c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"), xmax = c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"),annotations=c(paste("list(symbol('*')~plain('^'))",sep=","),paste("list(~symbol('*')~plain('^'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=",")),y_position = c(5,5,3,3,5,5),textsize = otr.sz1, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_ViolinAreaBouts_StandardizedSignal_by_time_Sex_SI.tiff",plot=last_plot(), units="mm", width=650/.pt, height=450/.pt, dpi=600,path=output,device=grDevices::tiff)



    theme(panel.spacing = unit(0, "lines"), 
         strip.background = element_blank(),
         strip.placement = "outside")

#Same as above but now color encodes animals (as an example)
ggplot(data=bout.analysis2_true,aes(x=group,y=signal), group=subject)+theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.7,aes(color=subject,size=2))+geom_point(data=ReplicateAverages.signal.meanz2,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(-2.5,6),breaks=c(-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.74,0.92),legend.spacing = unit(-0.25,"cm"),axis.text.x=element_text(size=11,color="black"),axis.text.y=element_text(size=12),axis.title.y=element_markdown(size=14),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(color=NULL,x=NULL, y="**Standardized Signal**<br> (z%dF/F)")+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#850 x 450

#First 10 min vs last 10 min
##Plot signal for all bouts per group 
#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds)
bout.analysis2_true10<-filter(bout.analysis2_truez1,BoutStarts<=740,preserve=TRUE)
ReplicateAverages1 <- bout.analysis2_true10 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","signal","meanbeforeafter","z1meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages1$Sex <-factor(ReplicateAverages1$Sex,levels=c("Female", "Male"))
ReplicateAverages1.signal<-filter(ReplicateAverages1,variable=="signal",preserve=TRUE)

ggplot(data=bout.analysis2_true10,aes(x=group,y=signal), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages1.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-2,17.5),breaks=c(0,2.5,5,7.5,10,12.5,15,17.5))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="First 10 min",x="Group", y="Standardized Signal (z%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))

#Last 10 min (7888-600)
bout.analysis2_true90<-filter(bout.analysis2_truez1,BoutStarts>=7288,preserve=TRUE)
ReplicateAverages2 <- bout.analysis2_true90 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","signal","meanbeforeafter","z1meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages2$Sex <-factor(ReplicateAverages2$Sex,levels=c("Female", "Male"))
ReplicateAverages2.signal<-filter(ReplicateAverages2,variable=="signal",preserve=TRUE)

ggplot(data=bout.analysis2_true90,aes(x=group,y=signal), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages2.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-2,17.5),breaks=c(0,2.5,5,7.5,10,12.5,15,17.5))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Last 10 min",x="Group", y="Standardized Signal (z%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))


################################################
######### Published Graph ######################
################################################

#### 1st Bout Ever
bout.analysis2_true.first<-filter(bout.analysis2_true,Bout==1 & session==1,preserve=TRUE)
colnames(contrasts(bout.analysis2_true.first$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")
colnames(contrasts(bout.analysis2_true.first$time))<-c("[H.After-Before]")

ReplicateAverages.first <- bout.analysis2_true.first %>% group_by(Solution,time) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Onset","End","signal","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.first.signal<-filter(ReplicateAverages.first,variable=="signal",preserve=TRUE)

boutgraphz2<-bout.analysis2_true.first
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=c("EtOH","Water","Sucrose"))

xvals<- interaction(boutgraphz2$time,boutgraphz2$Solution)

ggplot(data=boutgraphz2,aes(x=xvals,y=signal), group= factor(Solution))+theme_classic()+geom_beeswarm(cex=4.5,size=4,alpha=0.5,aes(color=Solution,size=2))+scale_color_manual(values =custom)+geom_point(data=ReplicateAverages.first.signal,aes(x=interaction(time,Solution),y=mean),size=4.5,color="black",position=position_dodge(width=0.5))+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After"),expand=expansion(0.1))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-2.5,6),breaks=c(-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.key.size=unit(5,"mm"),legend.text=element_text(size=title.sz),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.75,0.97),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz3,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=title.sz,hjust=c(0.053,-3.6,-4.43,-10.5,-8.9,-17.4)),plot.caption.position="panel")+labs(x=NULL,color=NULL,shape=NULL, y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes=list(size=6,alpha=1)),shape=guide_legend(override.aes=list(size=6,alpha=1)))+geom_signif(xmin=c(as.character(levels(xvals)[[2]])), xmax = c(as.character(levels(xvals)[[2]])),annotations=c(paste("list(symbol('*')~plain('^'))",sep=",")),y_position = c(4.75),textsize = otr.sz1, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

#output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_BeeswarmBouts_StandardizedSignal_1stBout.tiff",plot=last_plot(), units="mm", width=400/.pt, height=500/.pt, dpi=1000,path=output,device=grDevices::tiff)

#650 x 450
 
#Let's look at differences between before and after
#As Mean Difference
ReplicateAverages.data<-data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","meanbeforeafter","z1meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.data.meandiff<-filter(ReplicateAverages.data,variable=="z1meanbeforeafter",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=z1meanbeforeafter,group= factor(group_shrt))) + geom_beeswarm(cex=0.4,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom)+geom_point(data=ReplicateAverages.data.meandiff,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(limits=c(-5,15),breaks=c(-5,0,2.5,5,7.5,10,12.5,15),labels=scales::label_wrap(4),expand = expansion(0))+theme_classic2()+labs(x="**Group**", y="**Standardized Signal Change**<br>(Post-Pre Bout,z%dF/F)")+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title.y =element_markdown(size=18),axis.title.x =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))+geom_hline(aes(yintercept=0),linetype="88",linewidth=1.3)
```

##### z2AUC15

```{r}
#Overall Within-Mouse Trend - Mean Before vs Mean After 
ggplot(data=bout.analysis2_true, aes(x=time,y=z2AUC15,color=Solution)) +   geom_point(show.legend = FALSE) +   theme_minimal()+   scale_color_manual(values=custom)+   stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +   scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+   labs(title="Mouse #",y="Standardized Mean Signal (z%dF/F)",x="Time Around Bout") +    facet_grid2(Solution~ Mouse) +   theme(panel.grid.minor = element_blank(),         title = element_text(size=14, face="bold"),         axis.title.x = element_markdown(size=16),         axis.title.y=element_text(size=16,face="bold"),         axis.text=element_text(size=12), strip.text=element_text(size=14))


#Overall Within-Session Trend - Mean Before vs Mean After
ggplot(data=bout.analysis2_true, aes(x=time,y=z2AUC15,color=Solution))+  geom_point(show.legend = FALSE) +theme_minimal()+ scale_color_manual(values=custom)+ stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) + scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+ labs(title="AUC15",y="Standardized Mean Signal (z%dF/F)",x="Time Around Bout") + facet_grid2(Solution~ session) + theme(panel.grid.minor = element_blank(),title = element_text(size=14, face="bold"), axis.title.x = element_markdown(size=16), axis.title.y=element_text(size=16,face="bold"), axis.text=element_text(size=12), strip.text=element_text(size=14))

################################################
######### Published Graph ######################
################################################

##Plot signal for all bouts per group 
ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="z2AUC15",preserve=TRUE)


boutgraphz2<-bout.analysis2_true
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=c("EtOH","Water","Sucrose"))

ggplot(data=boutgraphz2,aes(x=group,y=z2AUC15), group= factor(group))+theme_classic()+geom_beeswarm(cex=0.7,size=2,alpha=0.5,aes(color=Solution,size=2),corral="wrap")+scale_color_manual(values =custom)+geom_point(data=ReplicateAverages.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"),expand=expansion(0.05))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-3.5,6),breaks=c(-3,-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.key.size=unit(5,"mm"),legend.text=element_text(size=title.sz),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.73,0.94),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz3,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=title.sz,hjust=c(0.053,-3.6,-4.43,-10.5,-8.9,-17.4)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**GCaMP7f AUC** (z(%<span style='font-family: Symbol;'>D</span>_F/F_*Time)") +guides(color=guide_legend(override.aes=list(size=6,alpha=1)),shape=guide_legend(override.aes=list(size=6,alpha=1)))+geom_signif(xmin=c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"), xmax = c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"),annotations=c(paste("list(symbol('*')~plain('^'))",sep=","),paste("list(~symbol('*')~plain('^'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol(''))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=",")),y_position = c(5,5,4,4,5,5),textsize = otr.sz2, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_BeeswarmBouts_StandardizedAUC_by_time_Sex.tiff",plot=last_plot(), units="mm", width=900/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

ggsave(filename="CL8_BeeswarmBouts_StandardizedAUC_by_time_Sex.jpeg",plot=last_plot(), units="mm", width=900/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::jpeg)

#650 x 450
 
################################################
######### Publishable Graph - Violin #############
################################################

##Plot signal for all bouts per group 
ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="z2AUC15",preserve=TRUE)


boutgraphz2<-bout.analysis2_true
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=c("EtOH","Water","Sucrose"))

#+geom_crossbar(data=ReplicateAverages.signal.meanz2,aes(x=group,y=mean,ymin=mean,ymax=mean),width=c(0.45,0.5,0.5,0.45),linewidth=0.2,color="black")
ggplot(data=boutgraphz2,aes(x=group,y=z2AUC15), group= factor(group))+theme_classic()+geom_violin(aes(fill=Solution),alpha=0.8,stat="ydensity")+scale_fill_manual(values =custom)+geom_point(data=ReplicateAverages.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"),expand=expansion(0.05))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-2.5,6),breaks=c(-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz3),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.82,0.92),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=txt.sz2,hjust=c(0.048,-3,-3.7,-8.85,-7.455,-14.63)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes=list(size=4,alpha=1))) +geom_signif(xmin=c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"), xmax = c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"),annotations=c(paste("list(symbol('*')~plain('^'))",sep=","),paste("list(~symbol('*')~plain('^'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=",")),y_position = c(5,5,3,3,5,5),textsize = otr.sz1, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_ViolinAreaBouts_StandardizedSignal_by_time_Sex_SI.tiff",plot=last_plot(), units="mm", width=650/.pt, height=450/.pt, dpi=600,path=output,device=grDevices::tiff)



    theme(panel.spacing = unit(0, "lines"), 
         strip.background = element_blank(),
         strip.placement = "outside")

#Same as above but now color encodes animals (as an example)
ggplot(data=bout.analysis2_true,aes(x=group,y=signal), group=subject)+theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.7,aes(color=subject,size=2))+geom_point(data=ReplicateAverages.signal.meanz2,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(-2.5,6),breaks=c(-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.74,0.92),legend.spacing = unit(-0.25,"cm"),axis.text.x=element_text(size=11,color="black"),axis.text.y=element_text(size=12),axis.title.y=element_markdown(size=14),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(color=NULL,x=NULL, y="**Standardized Signal**<br> (z%dF/F)")+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#850 x 450

#First 10 min vs last 10 min
##Plot signal for all bouts per group 
#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds)
bout.analysis2_true.10<-filter(bout.analysis2_true,BoutStarts<=740,preserve=TRUE)
ReplicateAverages1 <- bout.analysis2_true.10 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages1$Sex <-factor(ReplicateAverages1$Sex,levels=c("Female", "Male"))
ReplicateAverages1.signal<-filter(ReplicateAverages1,variable=="z2AUC15",preserve=TRUE)


boutgraphz2.10<-bout.analysis2_true.10
boutgraphz2.10$Solution<-factor(boutgraphz2.10$Solution,levels=c("EtOH","Water","Sucrose"))

ggplot(data=boutgraphz2.10,aes(x=group,y=z2AUC15), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.7,size=2,alpha=0.5,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages1.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-3.5,6),breaks=c(0,2.5,5,7.5,10,12.5,15,17.5))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="First 10 min",x="Group", y="AUC (z(%dF/F*time)")+guides(color=guide_legend(override.aes = list(size=4)))

#Last 10 min (7888-600)
bout.analysis2_true.90<-filter(bout.analysis2_true,BoutStarts>=7288,preserve=TRUE)
ReplicateAverages2 <- bout.analysis2_true.90 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages2$Sex <-factor(ReplicateAverages2$Sex,levels=c("Female", "Male"))
ReplicateAverages2.signal<-filter(ReplicateAverages2,variable=="z2AUC15",preserve=TRUE)

boutgraphz2.90<-bout.analysis2_true.90
boutgraphz2.90$Solution<-factor(boutgraphz2.90$Solution,levels=c("EtOH","Water","Sucrose"))


ggplot(data=bout.analysis2_true.90,aes(x=group,y=z2AUC15), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages2.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-3,6),breaks=c(0,2.5,5,7.5,10,12.5,15,17.5))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Last 10 min",x="Group", y="Standardized Signal (z%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))


################################################
######### Published Graph ######################
################################################

#### 1st Bout Ever
bout.analysis2_true.first<-filter(bout.analysis2_true,Bout==1 & session==1,preserve=TRUE)
colnames(contrasts(bout.analysis2_true.first$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")
colnames(contrasts(bout.analysis2_true.first$time))<-c("[H.After-Before]")

ReplicateAverages.first <- bout.analysis2_true.first %>% group_by(Solution,time) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.first.signal<-filter(ReplicateAverages.first,variable=="z2AUC15",preserve=TRUE)

boutgraph.first<-bout.analysis2_true.first
boutgraph.first$Solution<-factor(boutgraph.first$Solution,levels=c("EtOH","Water","Sucrose"))

xvals<- interaction(boutgraph.first$time,boutgraph.first$Solution)

ggplot(data=boutgraph.first,aes(x=xvals,y=z2AUC15), group= factor(Solution))+theme_classic()+geom_beeswarm(cex=4.5,size=4,alpha=0.5,aes(color=Solution,size=2))+scale_color_manual(values =custom)+geom_point(data=ReplicateAverages.first.signal,aes(x=interaction(time,Solution),y=mean),size=4.5,color="black",position=position_dodge(width=0.5))+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After"),expand=expansion(0.1))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-2.5,6),breaks=c(-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.key.size=unit(5,"mm"),legend.text=element_text(size=title.sz),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.75,0.97),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz3,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=title.sz,hjust=c(0.053,-3.6,-4.43,-10.5,-8.9,-17.4)),plot.caption.position="panel")+labs(x=NULL,color=NULL,shape=NULL, y="**AUC** (z(%<span style='font-family: Symbol;'>D</span>_F/F_*Time)") +guides(color=guide_legend(override.aes=list(size=6,alpha=1)),shape=guide_legend(override.aes=list(size=6,alpha=1)))

#+geom_signif(xmin=c(as.character(levels(xvals)[[2]])), xmax = c(as.character(levels(xvals)[[2]])),annotations=c(paste("list(symbol('*')~plain('^'))",sep=",")),y_position = c(4.75),textsize = otr.sz1, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

#output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_BeeswarmBouts_StandardizedAUC_1stBout.tiff",plot=last_plot(), units="mm", width=400/.pt, height=500/.pt, dpi=1000,path=output,device=grDevices::tiff)

ggsave(filename="CL8_BeeswarmBouts_StandardizedAUC_1stBout.jpeg",plot=last_plot(), units="mm", width=400/.pt, height=500/.pt, dpi=1000,path=output,device=grDevices::jpeg)

#650 x 450
 

```


##### z2TIMEDIFF

```{r}
#Overall Within-Mouse Trend - Mean Before vs Mean After 
ggplot(data=bout.analysis2_true, aes(x=time,y=z2TIMEDIFF,color=Solution)) +   geom_point(show.legend = FALSE) +   theme_minimal()+   scale_color_manual(values=custom)+   stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +   scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+   labs(title="Mouse #",y="Time Difference (sec)",x="Time Around Bout") +    facet_grid2(Solution~ Mouse) +   theme(panel.grid.minor = element_blank(),         title = element_text(size=14, face="bold"),         axis.title.x = element_markdown(size=16),         axis.title.y=element_text(size=16,face="bold"),         axis.text=element_text(size=12), strip.text=element_text(size=14))


#Overall Within-Session Trend - Mean Before vs Mean After
ggplot(data=bout.analysis2_true, aes(x=time,y=z2TIMEDIFF,color=Solution))+  geom_point(show.legend = FALSE) +theme_minimal()+ scale_color_manual(values=custom)+ stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) + scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+ labs(title="z2TIMEDIFF",y="Time Difference (sec)",x="Time Around Bout") + facet_grid2(Solution~ session) + theme(panel.grid.minor = element_blank(),title = element_text(size=14, face="bold"), axis.title.x = element_markdown(size=16), axis.title.y=element_text(size=16,face="bold"), axis.text=element_text(size=12), strip.text=element_text(size=14))

################################################
######### Published Graph ######################
################################################

##Plot signal for all bouts per group 
ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="z2TIMEDIFF",preserve=TRUE)


boutgraphz2<-bout.analysis2_true
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=c("EtOH","Water","Sucrose"))

ggplot(data=boutgraphz2,aes(x=group,y=z2TIMEDIFF), group= factor(group))+theme_classic()+geom_beeswarm(cex=0.7,size=2,alpha=0.5,aes(color=Solution,size=2),corral="wrap")+scale_color_manual(values =custom)+geom_point(data=ReplicateAverages.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"),expand=expansion(0.05))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-3.5,3),breaks=c(-3,-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.key.size=unit(5,"mm"),legend.text=element_text(size=title.sz),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.73,0.94),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz3,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=title.sz,hjust=c(0.053,-3.6,-4.43,-10.5,-8.9,-17.4)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**GCaMP7f Rise/Fall Time** (z(sec))") +guides(color=guide_legend(override.aes=list(size=6,alpha=1)),shape=guide_legend(override.aes=list(size=6,alpha=1)))+geom_signif(xmin=c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"), xmax = c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"),annotations=c(paste("list(symbol('')~plain(''))",sep=","),paste("list(~symbol('*')~plain(''))",sep=","),paste("list(symbol(''))",sep=","),paste("list(symbol('*~'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=",")),y_position = c(2,1.65,2,1.75,2.2,1.7),textsize = otr.sz2, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))+geom_signif(xmin=c("Male EtOH Before"), xmax = c("Male EtOH After"), annotations=c(paste("list(symbol('')~plain('^'))",sep=",")),y_position = c(2.1),textsize = otr.sz2, tip_length = 0.00,size=1,vjust= 0.35,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_BeeswarmBouts_StandardizedRISEFALLTime_by_time_Sex.tiff",plot=last_plot(), units="mm", width=900/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

ggsave(filename="CL8_BeeswarmBouts_StandardizedRISEFALLTime_by_time_Sex.jpeg",plot=last_plot(), units="mm", width=900/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::jpeg)

#650 x 450
 
################################################
######### Publishable Graph - Violin #############
################################################

##Plot signal for all bouts per group 
ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="z2TIMEDIFF",preserve=TRUE)


boutgraphz2<-bout.analysis2_true
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=c("EtOH","Water","Sucrose"))

#+geom_crossbar(data=ReplicateAverages.signal.meanz2,aes(x=group,y=mean,ymin=mean,ymax=mean),width=c(0.45,0.5,0.5,0.45),linewidth=0.2,color="black")
ggplot(data=boutgraphz2,aes(x=group,y=z2TIMEDIFF), group= factor(group))+theme_classic()+geom_violin(aes(fill=Solution),alpha=0.8,stat="ydensity")+scale_fill_manual(values =custom)+geom_point(data=ReplicateAverages.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"),expand=expansion(0.05))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-3.5,3),breaks=c(-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz3),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.82,0.92),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=txt.sz2,hjust=c(0.048,-3,-3.7,-8.85,-7.455,-14.63)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**Time Difference** (z(sec)") +guides(color=guide_legend(override.aes=list(size=4,alpha=1)))

#+geom_signif(xmin=c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"), xmax = c("Female EtOH After","Male EtOH After","Female Water After","Male Water After","Female Sucrose After","Male Sucrose After"),annotations=c(paste("list(symbol('*')~plain('^'))",sep=","),paste("list(~symbol('*')~plain('^'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=","),paste("list(symbol('*'))",sep=",")),y_position = c(5,5,3,3,5,5),textsize = otr.sz1, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_ViolinAreaBouts_StandardizedTIMEDIFF_by_time_Sex_SI.tiff",plot=last_plot(), units="mm", width=650/.pt, height=450/.pt, dpi=600,path=output,device=grDevices::tiff)



#First 10 min vs last 10 min
##Plot signal for all bouts per group 
#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds)
bout.analysis2_true.10<-filter(bout.analysis2_true,BoutStarts<=740,preserve=TRUE)
ReplicateAverages1 <- bout.analysis2_true.10 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages1$Sex <-factor(ReplicateAverages1$Sex,levels=c("Female", "Male"))
ReplicateAverages1.signal<-filter(ReplicateAverages1,variable=="z2TIMEDIFF",preserve=TRUE)


boutgraphz2.10<-bout.analysis2_true.10
boutgraphz2.10$Solution<-factor(boutgraphz2.10$Solution,levels=c("EtOH","Water","Sucrose"))

ggplot(data=boutgraphz2.10,aes(x=group,y=z2TIMEDIFF), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.7,size=2,alpha=0.5,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages1.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="First 10 min",x="Group", y="Time Difference (z(sec))")+guides(color=guide_legend(override.aes = list(size=4)))

#Last 10 min (7888-600)
bout.analysis2_true.90<-filter(bout.analysis2_true,BoutStarts>=7288,preserve=TRUE)
ReplicateAverages2 <- bout.analysis2_true.90 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages2$Sex <-factor(ReplicateAverages2$Sex,levels=c("Female", "Male"))
ReplicateAverages2.signal<-filter(ReplicateAverages2,variable=="z2TIMEDIFF",preserve=TRUE)

boutgraphz2.90<-bout.analysis2_true.90
boutgraphz2.90$Solution<-factor(boutgraphz2.90$Solution,levels=c("EtOH","Water","Sucrose"))


ggplot(data=boutgraphz2.90,aes(x=group,y=z2TIMEDIFF), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.7,size=2,alpha=0.5,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages2.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Last 10 min",x="Group", y="Standardized Signal (z%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))


################################################
######### Published Graph ######################
################################################

#### 1st Bout Ever
bout.analysis2_true.first<-filter(bout.analysis2_true,Bout==1 & session==1,preserve=TRUE)
colnames(contrasts(bout.analysis2_true.first$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")
colnames(contrasts(bout.analysis2_true.first$time))<-c("[H.After-Before]")

ReplicateAverages.first <- bout.analysis2_true.first %>% group_by(Solution,time) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","z2Mean","z2AUC15","z2TIMEDIFF","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.first.signal<-filter(ReplicateAverages.first,variable=="z2TIMEDIFF",preserve=TRUE)

boutgraph.first<-bout.analysis2_true.first
boutgraph.first$Solution<-factor(boutgraph.first$Solution,levels=c("EtOH","Water","Sucrose"))

xvals<- interaction(boutgraph.first$time,boutgraph.first$Solution)

ggplot(data=boutgraph.first,aes(x=xvals,y=z2TIMEDIFF), group= factor(Solution))+theme_classic()+geom_beeswarm(cex=4.5,size=4,alpha=0.5,aes(color=Solution,size=2))+scale_color_manual(values =custom)+geom_point(data=ReplicateAverages.first.signal,aes(x=interaction(time,Solution),y=mean),size=4.5,color="black",position=position_dodge(width=0.5))+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After"),expand=expansion(0.1))+scale_y_continuous(expand=expansion(c(0,0.02)),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.key.size=unit(5,"mm"),legend.text=element_text(size=title.sz),legend.justification="right",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.75,0.97),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz3,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor=element_blank(),plot.caption=element_markdown(lineheight=1,size=title.sz,hjust=c(0.053,-3.6,-4.43,-10.5,-8.9,-17.4)),plot.caption.position="panel")+labs(x=NULL,color=NULL,shape=NULL, y="**Time Difference** (z(sec)") +guides(color=guide_legend(override.aes=list(size=6,alpha=1)),shape=guide_legend(override.aes=list(size=6,alpha=1)))

#+geom_signif(xmin=c(as.character(levels(xvals)[[2]])), xmax = c(as.character(levels(xvals)[[2]])),annotations=c(paste("list(symbol('*')~plain('^'))",sep=",")),y_position = c(4.75),textsize = otr.sz1, tip_length = 0.00,size=0,vjust= 0.5,parse=TRUE,position=position_dodge(0.3))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

#output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_BeeswarmBouts_StandardizedTIMEDIFF_1stBout.tiff",plot=last_plot(), units="mm", width=400/.pt, height=500/.pt, dpi=1000,path=output,device=grDevices::tiff)

ggsave(filename="CL8_BeeswarmBouts_StandardizedTIMEDIFF_1stBout.jpeg",plot=last_plot(), units="mm", width=400/.pt, height=500/.pt, dpi=1000,path=output,device=grDevices::jpeg)

#650 x 450
 

```

#### ii) Correlations With Bout Characteristics

##### 1) Bout Duration

```{r}
#Bout Duration 
ggplot(data=bout.analysis2_truez1, aes(x=Duration_imc, y=signal,group=subject))+geom_point(aes(color=time))+facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+geom_smooth(method=lm,aes(fill=subject))+theme_classic()+scale_color_manual(values=c("z1MeanBefore"="black","z1MeanAfter"="grey"))+scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+scale_x_continuous(n.breaks = 10,expand = expansion(0.02),labels = scales::number_format(accuracy = 0.1))+theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration (ind. mean centered)", y="Signal %dF/F")    

#Bout Duration by Solution - Diff Between After and Before 
ggplot(data=bout.analysis2_truez1, aes(x=Duration_imc, y=z1meanbeforeafter))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 20,expand = expansion(0.02),labels = scales::number_format(accuracy = 0.1))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Individual Bout Duration  (s)", y="Signal (After-Before) %dF/F")  


#Bout Duration by Solution & Sex - Signal Difference between Before & After ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+   geom_point()+   facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")  #Bout Duration by Solution & Mouse - Signal Difference between Before & After ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+   geom_point()+   facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")
```

##### b) Bout \#

`{r} #Bout Duration by Solution ggplot(data=bout.analysis2_true, aes(x=Bout, y=signal))+   geom_point()+   facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal %dF/F")  #Bout Duration by Solution & Sex ggplot(data=bout.analysis2_true, aes(x=Bout, y=signal))+   geom_point()+   facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal %dF/F")  #Bout Duration by Solution - Signal Diff Between Before & After ggplot(data=bout.analysis2_true, aes(x=Bout, y=meanbeforeafter))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal (After-Before) %dF/F")  #Bout Duration by Solution & Sex - Signal Diff Between Before & After ggplot(data=bout.analysis2_true, aes(x=Bout, y=meanbeforeafter))+   geom_point()+   facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal (After-Before) %dF/F")  #Bout Duration by Solution & Mouse - Signal Difference between Before & After ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+   geom_point()+   facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")}`

##### c) Bout Start

`{r} #Bout Starts by Solution  ggplot(data=bout.analysis2_true, aes(x=BoutStarts, y=signal))+   geom_point()+   facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Signal %dF/F")   #Bout Duration by Solution & Sex  ggplot(data=bout.analysis2_true, aes(x=BoutStarts, y=signal))+   geom_point()+   facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Signal %dF/F")}`

##### 4) Lick Frequency

`{r} #Lick Frequency by Solution ggplot(data=bout.analysis2_true, aes(x=Duration_mc, y=signal))+   geom_point()+   facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (z-score)", y="Signal (%dF/F)")  #Lick Frequency by Solution & Sex ggplot(data=bout.analysis2_true, aes(x=Duration, y=signal))+   geom_point()+   facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (%dF/F)")  #Lick Frequency by Solution & Mouse  ggplot(data=bout.analysis2_true, aes(x=Duration, y=signal))+   geom_point()+   facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (%dF/F)")  #Lick Frequency by Solution - Signal Diff Between Before & After ggplot(data=bout.analysis2_true, aes(x=Duration_scaled, y=meanbeforeafter))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (scaled)", y="Signal (After-Before) %dF/F")  #Bout Duration by Solution & Sex - Signal Diff Between Before & After ggplot(data=bout.analysis2_true, aes(x=LickFrequency, y=meanbeforeafter))+   geom_point()+   facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (After-Before) %dF/F")  #Lick Frequency by Solution & Mouse - Signal Difference between Before & After ggplot(data=bout.analysis2_true, aes(x=LickFrequency, y=meanbeforeafter))+   geom_point()+   facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (After-Before) %dF/F")}`

#### ii) Standardization at the Session-level - Is it necessary?

```{r}
#Each point is a single session - Signal vs Descriptive Stats, Session Avgs
ggplot(data=session.analysis3,aes(x=z1meanbeforeafter_mean,y=SigMedian_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.01,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),axis.title.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Standardized Signal Difference<br>(After Bout- Before Bout)", y="Session Signal Median")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

#500x 400

ggplot(data=session.analysis3,aes(x=meanbeforeafter_mean,y=SigMAD_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Signal Diff", y="Signal MAD")+guides(color=guide_legend(override.aes = list(size=4)))+ facet_wrap(~Solution)

ggplot(data=session.analysis3,aes(x=meanbeforeafter_mean,y=SigStdev_mean), group= factor(group_shrt))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Signal Diff", y="Signal StDev")+guides(color=guide_legend(override.aes = list(size=4)))+ facet_wrap(~Solution)

ggplot(data=session.analysis3,aes(x=MeanBefore_mean,y=z1MeanBefore_mean), group= factor(group_shrt)) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal vs Standardized Signal",x="Signal", y="Standardized Signal")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_wrap(~Solution)


ggplot(data=session.analysis3,aes(x=subject,y=SigMedian_mean, group= factor(Mouse)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Subject # (of group)", y="Signal Median")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

ggplot(data=session.analysis3,aes(x=subject,y=SigMAD_mean, group= factor(Mouse)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Subject # (of group)", y="Signal MAD")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)


ggplot(data=session.analysis3,aes(x=subject,y=(SigMedian_mean/SigMAD_mean), group= factor(Mouse)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Subject # (of group)", y="Signal Median/Signal MAD")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

ggplot(data=session.analysis3,aes(x=z1MeanAfter_mean,y=(SigMedian_mean/SigMAD_mean), group= factor(group_shrt)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=1.0,label.x.npc = 0.1) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Standardized Signal After Bout", y="Signal Median/Signal MAD")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)



#Each point is a single session - Signal, Session Avgs
ggplot(data=session.analysis3,aes(x=session,y=MeanAfter_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.01,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),axis.title.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Characteristic Standardization",x="Session (Chronological Order)", y="Session Signal After Mean")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

#500x 500

ggplot(data=session.analysis3,aes(x=session,y=z1MeanAfter_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.01,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),axis.title.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Characteristic Standardization",x="Session (Chronological Order)", y="Session Std Signal After Mean")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)


ggplot(data=session.analysis3,aes(x=session,y=z2MeanAfter_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.01,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),axis.title.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Characteristic Standardization",x="Session (Chronological Order)", y="Session Std Signal After Mean")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

```

## 7) Session Bouts & Consumption

### a) CL8

#### i) Session Consumption Averages by Sex and Solution

```{r}
#####################################################
############### Publication Plot ####################
#####################################################

ReplicateAverages <- session.analysis3 %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(type = "mean_se");  
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male")) 
ReplicateAverages$Solution <-factor(ReplicateAverages$Solution, levels=c("EtOH","Water","Sucrose")) 
ReplicateAverages$group_shrt<-factor(ReplicateAverages$group_shrt,levels=c("Female EtOH","Male EtOH","Female Water", "Male Water", "Female Sucrose", "Male Sucrose")) 
ReplicateAverages.mL<-filter(ReplicateAverages,variable=="Drinking.mL.kg",preserve=TRUE)
ReplicateAverages.g<-filter(ReplicateAverages,variable=="EtOH.gkg",preserve=TRUE)
ReplicateAverages.bout<-filter(ReplicateAverages,variable=="Bout_max",preserve=TRUE) 

##Plot all bouts per group with each solution a different color
session.analysis_graph<-session.analysis3 
session.analysis_graph$Solution<-factor(session.analysis_graph$Solution,levels=c("EtOH","Water","Sucrose"))

# Lines above individual bars or sets of bars
annotation_df<-data.frame(
  xstart=c(0.6,1.6,2.6,3.6,4.6,5.6),
  xend=c(1.4,2.4,3.4,4.4,5.4,6.4),
  yvals= c(27,30,57,39,62,53),
  labels=c(paste("list(symbol(''))",sep=","))
  )
# Lines above solutions (both sexes)
annotation_df1<-data.frame(
  xstart=c(0.6,2.6),
  xend=c(2.4,6.4),
  yvals= c(39,79),
  labels=c(paste("list(symbol(''))",sep=","))
  )
#Sig indicator connectors to indicate differences between sexes - EtOH
annotation_df2<-data.frame(
  xstart=c(1),
  xend=c(2),
  yvals= c(33),
  labels=c(paste("list(scriptstyle('ns'))",sep=",")))

#Sig indicator connectors to indicate differences between sexes - Water
annotation_df3<-data.frame(
  xstart=c(3),
  xend=c(4),
  yvals= c(60),
  labels=c(paste("list(symbol('*'))",sep=",")))

#Sig indicator connectors to indicate differences between sexes - Sucrose
annotation_df4<-data.frame(
  xstart=c(5),
  xend=c(6),
  yvals= c(65),
  labels=c(paste("list(symbol('*'))",sep=",")))

#Sig indicator connectors to indicate differences between Solutions
annotation_df5<-data.frame(
  xstart=c(1.5),
  xend=c(4.5),
  yvals= c(82),
  labels=c(paste("list(symbol('***'))",sep=",")))

annotation_df6<-data.frame(
  xstart=c(3.5),
  xend=c(5.5),
  yvals= c(73.5),
  labels=c(paste("list(symbol('**'))",sep=",")))

ggplot(data=session.analysis_graph,aes(x=group_shrt,y=Drinking.mL.kg, fill=Solution), group= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.mL,stat="identity",aes(y=mean,fill=Solution),size=1,alpha=0.3)+geom_beeswarm(cex=2.4,size=4,alpha=0.8,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+geom_errorbar(data=ReplicateAverages.mL,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+scale_x_discrete(labels=c("Female","Male","Female","Male","Female","Male"),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,90),expand = expansion(c(0.01,0.03)))+theme(legend.title=element_blank(),legend.text=element_text(size=txt.sz2),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.8,0.97),legend.background=element_rect(fill="transparent"),axis.text.x=element_text(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(group_shrt=c("Female","Male","Female","Male","Female","Male"),x=NULL, y="**Consumption** (mL/kg)")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df1,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0,size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.038,0.038),size=0.5,vjust= 0,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.038,0.038),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.038,0.038),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df5,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.531,0.036),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

#+geom_signif(inherit.aes=FALSE,data=annotation_df6,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.09,0.031),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)  


output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_BeeswarmSessions_Consumption_by_Sex_SI.tiff",plot=last_plot(), units="mm", width=350/.pt, height=450/.pt, dpi=600,path=output)

#350 x 450


#Same as above but now color encodes animals 
ggplot(data=session.analysis3,aes(x=group_shrt,y=Drinking.mL.kg)) + theme_classic()+geom_beeswarm(cex=2.5,size=4,alpha=0.8,aes(color=factor(subject)))+ scale_colour_brewer(palette = "Dark2")+geom_point(data=ReplicateAverages.mL,aes(x=group_shrt,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,70),expand = expansion(0.03))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.38,0.9),legend.box.spacing = unit(-0.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Consumption (mL/kg)")+guides(color=guide_legend("Subject",override.aes = list(size=4)))  

##Now g/kg 
session.analysis_graph.EtOH<-filter(session.analysis_graph,Solution=="EtOH",preserve=TRUE) 
g<-ggplot(data=session.analysis_graph.EtOH,aes(x=Sex,y=EtOH.gkg)) +theme_classic()+geom_bar(data=ReplicateAverages.g,stat="identity",aes(y=mean),width=0.95,color="grey", fill="grey")+geom_beeswarm(cex=6,size=4.5,alpha=0.8,priority="density",aes(color=Solution),show.legend=FALSE)+scale_color_manual(values = c1)+geom_errorbar(data=ReplicateAverages.g,aes(x=Sex,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,6),expand = expansion(0.03))+theme(axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="g/kg")+geom_signif(xmin=c("Female"), xmax = c("Male"),annotations= c(paste("list(~scriptstyle(ns)",")",sep="")),parse=TRUE,vjust=-0.2,y_position = c(5),textsize = 6,tip_length = 0.07,size=1) 
print(g)

##Final mL/kg plot with inset of g/kg  
ggplot(data=session.analysis_graph,aes(x=group_shrt,y=Drinking.mL.kg), group= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.mL,stat="identity",aes(y=mean),width=0.9,color="grey", fill="grey")+geom_beeswarm(cex=2,size=5,alpha=0.8,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.mL,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(c(0.08,0.08)))+scale_y_continuous(n.breaks=10, limits=c(0,70),expand = expansion(c(0.02,0.03)))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.98),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Consumption** <br> mL/kg")+guides(color=guide_legend(override.aes = list(size=6)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns)",")",sep=""),paste("list(~symbol('*'))",sep=","),paste("list(~symbol('*'))",sep=",")),y_position = c(30,58,58),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female Water"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol('***'))",sep=",")),y_position = c(65),textsize = 6,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.2)+geom_signif(xmin=c("Female Sucrose"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol('**'))",sep=",")),y_position = c(61.5),textsize = 6,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.06)+inset_element(g, left = unit(0, "npc") + unit(22, "mm"),bottom = 0.6,right = 0.45,top = unit(1, "npc") - unit(1, "mm"),align_to = "full")

#700x550

## Session Bouts
ggplot(data=session.analysis_graph,aes(x=group_shrt,y=Bout_max), group= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.bout,stat="identity",aes(y=mean),width=0.9,color="grey", fill="grey")+geom_beeswarm(cex=2,size=5,alpha=0.8,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.bout,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(c(0.08,0.08)))+scale_y_continuous(n.breaks=10, limits=c(0,90),expand = expansion(c(0.02,0.03)))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.52,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Total Session Bouts** (#)")+guides(color=guide_legend(override.aes = list(size=6)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns)",")",sep=""),paste("list(~scriptstyle(ns))",sep=","),paste("list(~scriptstyle(ns))",sep=",")),y_position = c(35,70,70),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female Water"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol('***'))",sep=",")),y_position = c(75),textsize = 6,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line = 0.03)

#700 x 550
```

#### ii) Correlations With Session Bout Characteristics

```{r}
#Bout Duration Total by Solution 
ggplot(data=session.analysis3, aes(x=BoutDuration_Total, y=Drinking.mL.kg))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 10,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Consumption (mL/kg)")  

#Bout Duration Total by Solution & Sex 
ggplot(data=session.analysis3, aes(x=BoutDuration_Total, y=Drinking.mL.kg))+   geom_point()+   facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 10,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Consumption (mL/kg)")

#Total Licks vs Consumption by Solution and Sex
ggplot(data=session.analysis3, aes(x=LicksPerBout_Total, y=Drinking.mL.kg))+   geom_point()+   facet_grid2(~group_shrt,strip=strip_themed(background_x = elem_list_rect(fill = c(c1,c1,c2,c2,c3,c3))))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Licks  (#)", y="Consumption (mL/kg)")  

#Total Licks vs Consumption by Solution
ggplot(data=session.analysis3, aes(x=LicksPerBout_Total, y=Drinking.mL.kg))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = c(c1,c2,c3))))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Licks  (#)", y="Consumption (mL/kg)")

#Total Licks vs Consumption EtOH only
ggplot(data=session.analysis3, aes(x=LicksPerBout_Total, y=EtOH.gkg))+   geom_point()+   facet_grid2(~Sex,strip=strip_themed(background_x = elem_list_rect(fill = c(c1,c2,c3))))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Licks  (#)", y="EtOH (g/kg)")
```

## 8) MLM Results & Interactions

### a) z2Mean

#### i) Signal Outcome Model 4.2zc

```{r}
## Signal Outcome Model Estimated Means Collapsed Across Sex
## Estimated Means of Signal Outcome Model
sig2zc.df<-emmip(model4.2zc_fit,"Solution"~"time", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig2zc.df$Solution<-factor(sig2zc.df$Solution,levels=c("EtOH","Water","Sucrose"))

sig2zc.df$xvar<-factor(sig2zc.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=sig2zc.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.12))+geom_point(position=position_dodge(0.12),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.12))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.01,0.07)),breaks=c(-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4))+labs(x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+theme(legend.title=element_blank(),legend.text=element_text(size=title.sz),legend.justification="right", legend.direction = "vertical", legend.position=c(0.45,0.9),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=title.sz,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title=element_text(size=title.sz2),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_Model4.2zc_fit EstimatedMeans_by_time_SexCollapsed.tiff",plot=last_plot(), units="mm", width=350/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

#500 x 450
```

#### ii) Signal Outcome Model 4.2zd

```{r}
## Signal Outcome Model Estimated Means Collapsed Across Sex
## Estimated Means of Drinking.mL.kg Outcome Model
sig.df<-emmip(model4.2zd_fit,"Solution"~"time", pbkrtest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig.df$Solution<-factor(sig.df$Solution,levels=c("EtOH","Water","Sucrose"))

sig.df$xvar<-factor(sig.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=sig.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.065))+geom_point(position=position_dodge(0.065))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.065))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.07)),breaks=c(-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.84,0.95),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#500 x 450
```

### b) z2AUC

#### i) Signal Outcome Model 4.3alt1

```{r}
## Signal Outcome Model Estimated Means Collapsed Across Sex
## Estimated Means of Signal Outcome Model
sig2zc.df<-emmip(model4.3_fitalt1,"Solution"~"time", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig2zc.df$Solution<-factor(sig2zc.df$Solution,levels=c("EtOH","Water","Sucrose"))

sig2zc.df$xvar<-factor(sig2zc.df$xvar, levels=c("Before","After"),labels=c("Before Bout","After Bout"))

ggplot(data=sig2zc.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.12))+geom_point(position=position_dodge(0.12),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.12))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.01,0.07)),breaks=c(-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4))+labs(x=NULL,y="**GCaMP7f Signal AUC** (z(%<span style='font-family: Symbol;'>D</span>_F/F_*Time))<br>Estimated Means")+theme(legend.title=element_blank(),legend.text=element_text(size=title.sz),legend.justification="right", legend.direction = "vertical", legend.position=c(0.45,0.9),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=title.sz,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title=element_text(size=title.sz2),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_Model4.3_fitalt1 EstimatedMeans_by_time_SexCollapsed.tiff",plot=last_plot(), units="mm", width=350/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

#500 x 450


## Signal Outcome Model Estimated Means by Sex
## Estimated Means of Signal Outcome Model
sig2zc.df<-emmip(model4.3_fitalt1,"Solution"~"time", by="Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig2zc.df$Solution<-factor(sig2zc.df$Solution,levels=c("EtOH","Water","Sucrose"))

sig2zc.df$xvar<-factor(sig2zc.df$xvar, levels=c("Before","After"),labels=c("Before Bout","After Bout"))

ggplot(data=sig2zc.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.12))+geom_point(position=position_dodge(0.12),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.12))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.01,0.07)),breaks=c(-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4))+labs(x=NULL,y="**GCaMP7f Signal AUC** (z(%<span style='font-family: Symbol;'>D</span>_F/F_*Time))<br>Estimated Means")+theme(legend.title=element_blank(),legend.text=element_text(size=title.sz),legend.justification="right", legend.direction = "vertical", legend.position=c(0.37,0.9),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=title.sz,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title=element_text(size=title.sz2),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text.x = element_text(size=title.sz2,face="bold")) +guides(color=guide_legend(override.aes = list(size=6,alpha=1)))+facet_grid(~Sex)

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_Model4.3_fitalt1 EstimatedMeans_by_time_Sex.tiff",plot=last_plot(), units="mm", width=400/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)
```


### c) z2TIMEDIFF

#### i) Signal Outcome Model 4.2

```{r}
## Signal Outcome Model Estimated Means Collapsed Across Sex
## Estimated Means of Signal Outcome Model
sig2zc.df<-emmip(model4.2_fit,"Solution"~"time", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig2zc.df$Solution<-factor(sig2zc.df$Solution,levels=c("EtOH","Water","Sucrose"))

sig2zc.df$xvar<-factor(sig2zc.df$xvar, levels=c("Before","After"),labels=c("Before Bout","After Bout"))

ggplot(data=sig2zc.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.12))+geom_point(position=position_dodge(0.12),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.12))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.01,0.07)),breaks=c(-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4))+labs(x=NULL,y="**GCaMP7f Rise/Fall Time** (z(sec))<br>Estimated Means")+theme(legend.title=element_blank(),legend.text=element_text(size=title.sz),legend.justification="right", legend.direction = "vertical", legend.position=c(0.45,0.9),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=title.sz,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title=element_text(size=title.sz2),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

output<-"C:/Users/Christina/OneDrive/Desktop"


ggsave(filename="CL8_Model4.2_fit EstimatedMeans_TIMEDIFF_by_time_SexCollapsed.tiff",plot=last_plot(), units="mm", width=350/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

#500 x 450


## Signal Outcome Model Estimated Means by Sex
## Estimated Means of Signal Outcome Model
sig2zc.df<-emmip(model4.2_fit,"Solution"~"time", by="Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig2zc.df$Solution<-factor(sig2zc.df$Solution,levels=c("EtOH","Water","Sucrose"))

sig2zc.df$xvar<-factor(sig2zc.df$xvar, levels=c("Before","After"),labels=c("Before Bout","After Bout"))

ggplot(data=sig2zc.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.12))+geom_point(position=position_dodge(0.12),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.12))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.01,0.07)),breaks=c(-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4))+labs(x=NULL,y="**GCaMP7f Rise/Fall Time** (z(sec))<br>Estimated Means")+theme(legend.title=element_blank(),legend.text=element_text(size=title.sz),legend.justification="right", legend.direction = "vertical", legend.position=c(0.37,0.9),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=title.sz,color="black"),axis.text.y=element_text(size=title.sz,color="black"),axis.title=element_text(size=title.sz2),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text.x = element_text(size=title.sz2,face="bold")) +guides(color=guide_legend(override.aes = list(size=6,alpha=1)))+facet_grid(~Sex)

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_Model4.2_fit TimeDiff EstimatedMeans_by_time_Sex.tiff",plot=last_plot(), units="mm", width=400/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

ggsave(filename="CL8_Model4.2_fit TimeDiff EstimatedMeans_by_time_Sex.jpeg",plot=last_plot(), units="mm", width=400/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::jpeg)

```

### c) Characteristic Outcome Models

#### i) Consumption

```{r}
################################
######## PUBLISHED GRAPH #######
################################


drink.df<-emmip(model5.drink_fit,"Solution"~"Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

drink.df$Solution<-factor(drink.df$Solution,levels=c("EtOH","Water","Sucrose"))

ggplot(data=drink.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.12))+geom_point(position=position_dodge(0.12),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.12))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(0,44),breaks=c(0,5,10,15,20,25,30,35,40,45))+labs(x=NULL,y="**Consumption** (mL/kg)<br> Estimated Means")+theme(legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.78,0.975),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title.x=element_text(size=title.sz),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit = "mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"

ggsave(filename="CL8_Model5.drink_fit EstimatedMeans_by_Sex.tiff",plot=last_plot(), units="mm", width=350/.pt, height=450/.pt, dpi=600,path=output)


#500 x 450
```

#### ii) Total Bouts

```{r}
bout.df<-emmip(model5.bout_fit,"Solution"~"Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)  

bout.df$Solution<-factor(bout.df$Solution,levels=c("EtOH","Water","Sucrose"))  

ggplot(data=bout.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.065))+geom_point(position=position_dodge(0.065))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.065))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.03)),breaks=c(5,10,15,20,25,30,35,40,45))+labs(x=NULL,y="**Total Bouts (#)**<br> Estimated Means")+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.98),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #500 x 450
```


####iii) Bout Duration
```{r}
#############################
#### PUBLICATION GRAPH ######
#############################

duration.df<-emmip(model5.duration_fita,"Solution"~"Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)  

duration.df$Solution<-factor(duration.df$Solution,levels=c("EtOH","Water","Sucrose"))  

ggplot(data=duration.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.12))+geom_point(position=position_dodge(0.12), size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.12))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.02,0.03)),limits=c(0,5),breaks=c(0,0.5,1,1.5,2,2.5,3,3.5,4,4.5,5,5.5))+labs(color=NULL,x=NULL,y="**Bout Duration** (seconds)<br> Estimated Means")+theme(legend.title=element_text(size=txt.sz1,face="bold"),legend.text=element_text(size=txt.sz1),legend.justification="right", legend.direction = "horizontal",legend.position="inside", legend.position.inside =c(0.8,0.975),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
ggsave(filename="CL8_Model5.duration_fita EstimatedMeans_by_Sex_Solution.tiff",plot=last_plot(), units="mm", width=350/.pt, height=450/.pt, dpi=600,path=output,device=grDevices::tiff)


#350 x 450
```

### 

### d) Signal-Characteristic Outcome Models

#### i) Session-Level: Consumption

```{r}
## Wide range graphs
## Estimated Means of Drinking.mL.kg_imc Outcome Model - Males
drinkm.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1,2),Sex=c("Male")))

drinkm.df$Drinking.mL.kg_imc <- factor(drinkm.df$Drinking.mL.kg_imc,levels=c("-1","0","1","2"),labels=c("Male<br>Low<br>Drinking<br>Session", "Male<br>Mean<br>Drinking<br>Session", "Male<br>High<br>Drinking<br>Session","Male<br>Very<br>High<br>Drinking<br>Session"))

drinkm.df$Solution<-factor(drinkm.df$Solution,levels=c("EtOH","Water","Sucrose"))
drinkm.df$xvar<-factor(drinkm.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drinkm.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc,ncol=4)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.4,3.2),breaks=c(-1.6,-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.8,3.2))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.54,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=14,color="black"),axis.title.y =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))


#650 x 400

## Estimated Means of Drinking.mL.kg_imc Outcome Model - Females
drinkf.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1,2),Sex=c("Female")))

drinkf.df$Drinking.mL.kg_imc <- factor(drinkf.df$Drinking.mL.kg_imc,levels=c("-1","0","1","2"),labels=c("Female<br>Low<br>Drinking<br>Session", "Female<br>Mean<br>Drinking<br>Session", "Female<br>High<br>Drinking<br>Session","Female<br>Very<br>High<br>Drinking<br>Session"))

drinkf.df$Solution<-factor(drinkf.df$Solution,levels=c("EtOH","Water","Sucrose"))
drinkf.df$xvar<-factor(drinkf.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drinkf.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc,ncol=4)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.4,3.2),breaks=c(-1.6,-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.8,3.2))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.54,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=14,color="black"),axis.title.y =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400



## Normal range graphs
## Estimated Means of Drinking.mL.kg_imc Outcome Model - Males
drinkm.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1),Sex=c("Male")))

drinkm.df$Drinking.mL.kg_imc <- factor(drinkm.df$Drinking.mL.kg_imc,levels=c("-1","0","1"),labels=c("Male<br>Low<br>Drinking Session", "Male<br>Mean<br>Drinking Session", "Male<br>High<br>Drinking Session"))

drinkm.df$Solution<-factor(drinkm.df$Solution,levels=c("EtOH","Water","Sucrose"))
drinkm.df$xvar<-factor(drinkm.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drinkm.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.16))+geom_point(position=position_dodge(0.16), size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.16))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc,ncol=4)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.08,2.38),breaks=c(-1.5,-1.2,-0.9,-0.6,-0.3,0,0.3,0.6,.9,1.2,1.5,1.8,2.1,2.4,2.7,3.1))+labs(color=NULL,x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=title.sz),legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz2),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.45,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
ggsave(filename="CL8_Model4.2zcdrink_fit EstimatedMeans_by_time_Males.tiff",plot=last_plot(), units="mm", width=600/.pt, height=225/.pt, dpi=600,path=output)

#650 x 400

## Estimated Means of Drinking.mL.kg_imc Outcome Model - Females
drinkf.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1),Sex=c("Female")))

drinkf.df$Drinking.mL.kg_imc <- factor(drinkf.df$Drinking.mL.kg_imc,levels=c("-1","0","1"),labels=c("Female<br>Low<br>Drinking Session", "Female<br>Mean<br>Drinking Session", "Female<br>High<br>Drinking Session"))

drinkf.df$Solution<-factor(drinkf.df$Solution,levels=c("EtOH","Water","Sucrose"))
drinkf.df$xvar<-factor(drinkf.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drinkf.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc,ncol=4)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.08,2.38),breaks=c(-1.5,-1.2,-0.9,-0.6,-0.3,0,0.3,0.6,.9,1.2,1.5,1.8,2.1,2.4,2.7,3.1))+labs(color=NULL,x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=title.sz),legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz2),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.6,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title.y =element_markdown(size=title.sz),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

#######################################
########## PUBLICATION GRAPH ##########
#######################################

## Estimated Means of Drinking.mL.kg_imc Outcome Model - Both Sexes on same graph
drink.df<-emmip(model4.2zcdrink_fit,Solution*Sex~time,by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1)))

drink.df$Drinking.mL.kg_imc <- factor(drink.df$Drinking.mL.kg_imc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Session", "Mean Drinking<br>Session", "High Drinking<br>Session"))

drink.df$Solution<-factor(drink.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink.df$xvar<-factor(drink.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.32))+geom_point(position=position_dodge(0.32),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.32))+theme_classic()+facet_grid(Sex~Drinking.mL.kg_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.5))+scale_y_continuous(expand = expansion(c(0.1,0.1)),limits=c(-1.08,2.38),n.breaks=10)+labs(x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=title.sz),strip.text.y = element_markdown(face="bold",size=title.sz),legend.title=element_blank(),legend.text=element_text(size=txt.sz2),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.475,0.94),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
ggsave(filename="CL8_Model4.2zcdrink_fit EstimatedMeans_by_Sex_Solution.tiff",plot=last_plot(), units="mm", width=600/.pt, height=450/.pt, dpi=600,path=output,device=grDevices::tiff)


#650 x 400
########################################################################

## Estimated Means of Drinking.sol_imc Outcome Model - Males
drink1m.df<-emmip(model4.2zcdrink_fit1,"Solution"~"time",by="Drinking.sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Sex=c("Male")))

drink1m.df$Drinking.sol_imc <- factor(drink1m.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("Male<br>Low Drinking<br>Session", "Male<br>Mean Drinking<br>Session", "Male<br>High Drinking<br>Session"))

drink1m.df$Solution<-factor(drink1m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink1m.df$xvar<-factor(drink1m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink1m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.9),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.sol_imc Outcome Model - Females
drink1f.df<-emmip(model4.2zcdrink_fit1,"Solution"~"time",by="Drinking.sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Sex=c("Female")))

drink1f.df$Drinking.sol_imc <- factor(drink1f.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("Female<br>Low Drinking<br>Session", "Female<br>Mean Drinking<br>Session", "Female<br>High Drinking<br>Session"))

drink1f.df$Solution<-factor(drink1f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink1f.df$xvar<-factor(drink1f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink1f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.7,1.9),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Version with just EtOH
drink1.df<-emmip(model4.2zcdrink_fit1,"Sex"~"time",by="Drinking.sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Solution=c("EtOH")))

drink1.df$Drinking.sol_imc<-factor(drink1.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("Low EtOH<br>Drinking Session", "Mean EtOH<br>Drinking Session", "High EtOH<br>Drinking Session"))

drink1.df$xvar<-factor(drink1.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

linetypes<-c("longdash","solid","dotted")

ggplot(data=drink1.df,aes(x=xvar,y=yvar,group=Drinking.sol_imc,color=Drinking.sol_imc))+geom_line(aes(linetype=Drinking.sol_imc),linewidth=0.75,position=position_dodge(0.10))+geom_point(position=position_dodge(0.10))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.10),linetype="solid", show.legend = FALSE)+theme_classic()+facet_wrap(~Sex)+scale_color_manual(values = c("#F399A7","#D41159","#66192D"))+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.7,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8))+labs(linetype=NULL,color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_markdown(size=13,face="bold"),legend.text=element_markdown(size=13,margin = unit(0.1,"cm")),legend.justification="right", legend.direction = "vertical", legend.position=c(0.38,0.81),legend.key.width = unit(1.6,"cm"),legend.box.spacing = unit(-1.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)),linetype=guide_legend(override.aes = list(linewidth=0.75)))

#650 x 400


########################################################################

## Estimated Means of Drinking.mL.kg_gmc Outcome Model - Males
drink2m.df<-emmip(model4.2zcdrink_fit2,"Solution"~"time",by="Drinking.mL.kg_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_gmc=c(-1,0,0.5),Sex=c("Male")))

drink2m.df$Drinking.mL.kg_gmc <- factor(drink2m.df$Drinking.mL.kg_gmc,levels=c("-1","0","0.5"),labels=c("Low Drinking<br>Male", "Mean Drinking<br>Male", "High Drinking<br>Male"))

drink2m.df$Solution<-factor(drink2m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink2m.df$xvar<-factor(drink2m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink2m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.35,2.3),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_gmc Outcome Model - Females
drink2f.df<-emmip(model4.2zcdrink_fit2,"Solution"~"time",by="Drinking.mL.kg_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_gmc=c(-1,0,0.5),Sex=c("Female")))

drink2f.df$Drinking.mL.kg_gmc <- factor(drink2f.df$Drinking.mL.kg_gmc,levels=c("-1","0","0.5"),labels=c("Low Drinking<br>Female", "Mean Drinking<br>Female", "High Drinking<br>Female"))

drink2f.df$Solution<-factor(drink2f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink2f.df$xvar<-factor(drink2f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink2f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.35,2.3),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400


########################################################################

## Estimated Means of Drinking.mL.kg_smc Outcome Model - Males
drink3m.df<-emmip(model4.2zcdrink_fit3,"Solution"~"time",by="Drinking.mL.kg_smc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_smc=c(-1,0,1),Sex=c("Male")))

drink3m.df$Drinking.mL.kg_smc <- factor(drink3m.df$Drinking.mL.kg_smc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Male", "Mean Drinking<br>Male", "High Drinking<br>Male"))

drink3m.df$Solution<-factor(drink3m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink3m.df$xvar<-factor(drink3m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink3m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_smc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.9),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_smc Outcome Model - Females
drink3f.df<-emmip(model4.2zcdrink_fit3,"Solution"~"time",by="Drinking.mL.kg_smc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_smc=c(-1,0,1),Sex=c("Female")))

drink3f.df$Drinking.mL.kg_smc <- factor(drink3f.df$Drinking.mL.kg_smc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Female", "Mean Drinking<br>Female", "High Drinking<br>Female"))

drink3f.df$Solution<-factor(drink3f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink3f.df$xvar<-factor(drink3f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink3f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_smc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.9),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

########################################################################

## Estimated Means of Drinking.mL.kg_grpmc Outcome Model - Males
drink4m.df<-emmip(model4.2zcdrink_fit4,"Solution"~"time",by="Drinking.mL.kg_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_grpmc=c(-1,0,1),Sex=c("Male")))

drink4m.df$Drinking.mL.kg_grpmc <- factor(drink4m.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Male", "Mean Drinking<br>Male", "High Drinking<br>Male"))

drink4m.df$Solution<-factor(drink4m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink4m.df$xvar<-factor(drink4m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink4m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_gmc Outcome Model - Females
drink4f.df<-emmip(model4.2zcdrink_fit4,"Solution"~"time",by="Drinking.mL.kg_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_grpmc=c(-1,0,1),Sex=c("Female")))

drink4f.df$Drinking.mL.kg_grpmc <- factor(drink4f.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Female", "Mean Drinking<br>Female", "High Drinking<br>Female"))

drink4f.df$Solution<-factor(drink4f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink4f.df$xvar<-factor(drink4f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink4f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Version with just EtOH
drink4.df<-emmip(model4.2zcdrink_fit4,"Sex"~"time",by="Drinking.mL.kg_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_grpmc=c(-1,0,1),Solution=c("EtOH")))

drink4.df$Drinking.mL.kg_grpmc<-factor(drink4.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low EtOH Drinker","Mean EtOH Drinker","High EtOH Drinker"))

drink4.df$xvar<-factor(drink4.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

linetypes<-c("longdash","solid","dotted")

ggplot(data=drink4.df,aes(x=xvar,y=yvar,group=Drinking.mL.kg_grpmc,color=Drinking.mL.kg_grpmc))+geom_line(aes(linetype=Drinking.mL.kg_grpmc),linewidth=0.75,position=position_dodge(0.10))+geom_point(position=position_dodge(0.10))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.10),linetype="solid", show.legend = FALSE)+theme_classic()+facet_wrap(~Sex)+scale_color_manual(values = c("#F399A7","#D41159","#66192D"))+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.2,2.0),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8))+labs(linetype=NULL,color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_markdown(size=13,face="bold"),legend.text=element_markdown(size=13,margin = unit(0.1,"cm")),legend.justification="right", legend.direction = "vertical", legend.position=c(0.42,0.88),legend.key.width = unit(1.6,"cm"),legend.box.spacing = unit(-1.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)),linetype=guide_legend(override.aes = list(linewidth=0.75)))

#650 x 400


########################################################################

## Estimated Means of Drinking.sol_gmc Outcome Model - Males
drink5m.df<-emmip(model4.2zcdrink_fit5,"Solution"~"time",by="Drinking.sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_gmc=c(-1,0,1),Sex=c("Male")))

drink5m.df$Drinking.sol_gmc <- factor(drink5m.df$Drinking.sol_gmc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Male", "Mean Drinking<br>Male", "High Drinking<br>Male"))

drink5m.df$Solution<-factor(drink5m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink5m.df$xvar<-factor(drink5m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink5m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,1.94),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.sol_gmc Outcome Model - Females
drink5f.df<-emmip(model4.2zcdrink_fit5,"Solution"~"time",by="Drinking.sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_gmc=c(-1,0,1),Sex=c("Female")))

drink5f.df$Drinking.sol_gmc <- factor(drink5f.df$Drinking.sol_gmc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Female", "Mean Drinking<br>Female", "High Drinking<br>Female"))

drink5f.df$Solution<-factor(drink5f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink5f.df$xvar<-factor(drink5f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink5f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,1.94),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400


########################################################################
########################################################################

## Estimated Means of Drinking.sol_gmc Outcome Model - Males
drink9m.df<-emmip(model4.2zcdrink_fit9,"Solution"~"time",by=c("Drinking.sol_imc","Drinking.mL.kg_grpmc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Drinking.mL.kg_grpmc=c(-1,0,1),Sex=c("Male")))

drink9m.df<-filter(drink9m.df, !Drinking.sol_imc=="0" & !Drinking.mL.kg_grpmc=="0")

drink9m.df$Drinking.mL.kg_grpmc <- factor(drink9m.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low Drinker", "Mean Drinker", "High Drinker"))

drink9m.df$Drinking.sol_imc <- factor(drink9m.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("in <br>Low Drinking Session", "in<br>Mean Drinking Session", "in<br>High Drinking Session"))

drink9m.df<-drink9m.df %>%
  mutate(group=paste(Drinking.mL.kg_grpmc,Drinking.sol_imc))

drink9m.df$group<-factor(drink9m.df$group,levels=c("Low Drinker in <br>Low Drinking Session","Low Drinker in<br>High Drinking Session","High Drinker in <br>Low Drinking Session","High Drinker in<br>High Drinking Session"))

drink9m.df$Solution<-factor(drink9m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink9m.df$xvar<-factor(drink9m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")

ggplot(data=drink9m.df,aes(x=xvar,y=yvar, group=group,color=Solution, linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_wrap(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-2.2,2.4),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=11),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color="none")

#950 x 500



## Estimated Means of Drinking.sol_imc*Drinking.mL.kg_grpmc Outcome Model - Females
drink9f.df<-emmip(model4.2zcdrink_fit9,"Solution"~"time",by=c("Drinking.sol_imc","Drinking.mL.kg_grpmc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Drinking.mL.kg_grpmc=c(-1,0,1),Sex=c("Female")))

drink9f.df<-filter(drink9f.df, !Drinking.sol_imc=="0" & !Drinking.mL.kg_grpmc=="0")

drink9f.df$Drinking.mL.kg_grpmc <- factor(drink9f.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low Drinker", "Mean Drinker", "High Drinker"))

drink9f.df$Drinking.sol_imc <- factor(drink9f.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("in <br>Low Drinking Session", "in<br>Mean Drinking Session", "in<br>High Drinking Session"))

drink9f.df<-drink9f.df %>%
  mutate(group=paste(Drinking.mL.kg_grpmc,Drinking.sol_imc))

drink9f.df$group<-factor(drink9f.df$group,levels=c("Low Drinker in <br>Low Drinking Session","Low Drinker in<br>High Drinking Session","High Drinker in <br>Low Drinking Session","High Drinker in<br>High Drinking Session"))

drink9f.df$Solution<-factor(drink9f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink9f.df$xvar<-factor(drink9f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")

ggplot(data=drink9f.df,aes(x=xvar,y=yvar, group=group,color=Solution, linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_wrap(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-2.2,2.7),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=11),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")

#950 x 500



#Better interaction graph
## Estimated Means of Drinking.sol_imc*Drinking Outcome Model  
drink9.df<-emmip(model4.2zcdrink_fit9,"Solution"~"Sex",by=c("Drinking.sol_imc","Drinking.mL.kg_grpmc","time"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Drinking.mL.kg_grpmc=c(-1,0,1)))

drink9.df<-filter(drink9.df, !Drinking.sol_imc=="0" & !Drinking.mL.kg_grpmc=="0")

drink9.df$Drinking.mL.kg_grpmc <- factor(drink9.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low<br>Drinker", "Mean<br>Drinker", "High<br>Drinker"))

drink9.df$Drinking.sol_imc <- factor(drink9.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("<br>Low Drinking<br>Session", "<br>Mean Drinking<br> Session", "<br>High Drinking<br>Session"))

drink9.df<-drink9.df %>%
  mutate(group=paste(Drinking.mL.kg_grpmc,Drinking.sol_imc))

drink9.df$group<-factor(drink9.df$group,levels=c("Low<br>Drinker <br>Low Drinking<br>Session","Low<br>Drinker <br>High Drinking<br>Session",
"High<br>Drinker <br>Low Drinking<br>Session", "High<br>Drinker <br>High Drinking<br>Session"))

drink9.df$Solution<-factor(drink9.df$Solution,levels=c("EtOH","Water","Sucrose"))

drink9.df$time<-factor(drink9.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")


ggplot(data=drink9.df,aes(x=group,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.21),linewidth=0.75)+geom_point(position=position_dodge(0.21))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.21),linetype="solid")+theme_classic()+facet_grid(Sex~time)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.04)),limits=c(-2.2,2.7),breaks=c(-2.2,-1.8,-1.4,-1.0,-0.6,-0.2,.2,.6,1.0,1.4,1.8,2.2,2.6,3.0,3.4,3.8))+labs(color=NULL,x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=14),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.36,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14 ),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#900 x 500


########################################################################

## Estimated Means of EtOH.gkg_imc Outcome Model  
drink6.df<-emmip(model4.2zcdrink_fit6,"Sex"~"time",by="EtOH.gkg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(EtOH.gkg_imc=c(-1,0,1)))

drink6.df$EtOH.gkg_imc <- factor(drink6.df$EtOH.gkg_imc,levels=c("-1","0","1"),labels=c("Low EtOH<br>Drinking Session", "Mean EtOH<br>Drinking Session", "High EtOH<br>Drinking Session"))

drink6.df$xvar<-factor(drink6.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

linetypes<-c("longdash","solid","dotted")

ggplot(data=drink6.df,aes(x=xvar,y=yvar,group=EtOH.gkg_imc,color=EtOH.gkg_imc))+geom_line(aes(linetype=EtOH.gkg_imc),linewidth=0.75,position=position_dodge(0.10))+geom_point(position=position_dodge(0.10))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.10),linetype="solid", show.legend = FALSE)+theme_classic()+facet_wrap(~Sex)+scale_color_manual(values = c("#F399A7","#D41159","#66192D"))+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.7,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8))+labs(linetype=NULL,color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_markdown(size=13,face="bold"),legend.text=element_markdown(size=13,margin = unit(0.1,"cm")),legend.justification="right", legend.direction = "vertical", legend.position=c(0.38,0.81),legend.key.width = unit(1.6,"cm"),legend.box.spacing = unit(-1.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)),linetype=guide_legend(override.aes = list(linewidth=0.75)))

#650 x 400

## Estimated Means of EtOH.gkg_imc Outcome Model  
drink7.df<-emmip(model4.2zcdrink_fit7,"Sex"~"time",by="EtOH.gkg_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(EtOH.gkg_gmc=c(-1.0,0.0,1.0)))

drink7.df$EtOH.gkg_gmc <- factor(drink7.df$EtOH.gkg_gmc,levels=c(-1.0,0.0,1.0),labels=c("Low EtOH Drinker","Mean EtOH Drinker","High EtOH Drinker"))

drink7.df$xvar<-factor(drink7.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

linetypes<-c("longdash","solid","dotted")

ggplot(data=drink7.df,aes(x=xvar,y=yvar,group=EtOH.gkg_gmc,color=EtOH.gkg_gmc))+geom_line(aes(linetype=EtOH.gkg_gmc),linewidth=0.75,position=position_dodge(0.1))+geom_point(position=position_dodge(0.1))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.1),linetype="solid", show.legend = FALSE)+theme_classic()+facet_wrap(~Sex)+scale_color_manual(values = c("#F399A7","#D41159","#66192D"))+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.96,2.2),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8))+labs(linetype=NULL,color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_markdown(size=13,face="bold"),legend.text=element_markdown(size=13,margin = unit(0.1,"cm")),legend.justification="right", legend.direction = "vertical", legend.position=c(0.42,0.88),legend.key.width = unit(1.6,"cm"),legend.box.spacing = unit(-1.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)),linetype=guide_legend(override.aes = list(linewidth=0.75)))

#650 x 400



```

#### ii) Bout-Level: Duration_imc

```{r}
##Signal-BoutDuration_imc Males
durationm.df<-emmip(model4.2zcDuration_fit,"Solution"~"time",by="Duration_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_imc=c(-1,0,1),Sex=c("Male")))

durationm.df$Duration_imc <- factor(durationm.df$Duration_imc,levels=c("-1","0","1"),labels=c("Males<br>During Shorter<br>Drinking Bouts", "Males<br>During Mean<br>Drinking Bouts", "Males<br>During Longer<br>Drinking Bouts"))

durationm.df$Solution<-factor(durationm.df$Solution,levels=c("EtOH","Water","Sucrose"))
durationm.df$xvar<-factor(durationm.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=durationm.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.55,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=16,color="black"),axis.title.y=element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_imc Females
durationf.df<-emmip(model4.2zcDuration_fit,"Solution"~"time",by="Duration_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_imc=c(-1,0,1),Sex=c("Female")))

durationf.df$Duration_imc <- factor(durationf.df$Duration_imc,levels=c("-1","0","1"),labels=c("Females<br>During Shorter<br>Drinking Bouts", "Females<br>During Mean<br>Drinking Bouts", "Females<br>During Longer<br>Drinking Bouts"))

durationf.df$Solution<-factor(durationf.df$Solution,levels=c("EtOH","Water","Sucrose"))
durationf.df$xvar<-factor(durationf.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=durationf.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.55,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=16,color="black"),axis.title.y=element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))
#650 x 400


#########################################################
############## Publishable Graph ########################
#########################################################

##Signal-BoutDuration_imc Both Sexes - Same graph
duration.df<-emmip(model4.2zcDuration_fit,Solution*Sex~time,by="Duration_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_imc=c(-1,0,1)))

duration.df$Duration_imc <- factor(duration.df$Duration_imc,levels=c("-1","0","1"),labels=c("Shorter<br>Drinking Bouts", "Mean<br>Drinking Bouts", "Longer<br>Drinking Bouts"))

duration.df$Solution<-factor(duration.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration.df$xvar<-factor(duration.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.32))+geom_point(position=position_dodge(0.32),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.32))+theme_classic()+facet_grid(Sex~Duration_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.5))+scale_y_continuous(expand = expansion(c(0.01,0.1)),limits=c(-0.8,1.4),n.breaks=7)+labs(x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=title.sz),strip.text.y = element_markdown(face="bold",size=title.sz),legend.title=element_blank(),legend.text=element_text(size=txt.sz2),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.475,0.94),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
ggsave(filename="CL8_Model4.2zcduration_fit EstimatedMeans_by_Sex_Solution.tiff",plot=last_plot(), units="mm", width=600/.pt, height=450/.pt, dpi=600,path=output,device=grDevices::tiff)
#600 x 450


## Solution Centered
##Signal-BoutDuration_sol_imc Males
duration1m.df<-emmip(model4.2zcDuration_fit1,"Solution"~"time",by="Duration_sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1),Sex=c("Male")))

duration1m.df$Duration_sol_imc <- factor(duration1m.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("Males During<br>Shorter Drinking", "Males During<br>Mean Drinking", "Males During<br>Longer Drinking"))

duration1m.df$Solution<-factor(duration1m.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration1m.df$xvar<-factor(duration1m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration1m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_sol_imc Females
duration1f.df<-emmip(model4.2zcDuration_fit1,"Solution"~"time",by="Duration_sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1),Sex=c("Female")))

duration1f.df$Duration_sol_imc <- factor(duration1f.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("Females During<br>Shorter Drinking", "Females During<br>Mean Drinking", "Females During<br>Longer Drinking"))

duration1f.df$Solution<-factor(duration1f.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration1f.df$xvar<-factor(duration1f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration1f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_sol_imc Both Sexes
duration1.df<-emmip(model4.2zcDuration_fit1,"Solution"~"time",by="Duration_sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1)))

duration1.df$Duration_sol_imc <- factor(duration1.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("DuringShorter<br>Drinking Bouts", "During Mean<br>Drinking Bouts", "During Longer<br>Drinking Bouts"))

duration1.df$Solution<-factor(duration1.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration1.df$xvar<-factor(duration1.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration1.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400
```

#### iii) Bout-Level: Duration_gmc

```{r}
##Signal-BoutDuration_gmc Males
duration2m.df<-emmip(model4.2zcDuration_fit2,"Solution"~"time",by="Duration_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_gmc=c(-1,0,1),Sex=c("Male")))

duration2m.df$Duration_gmc <- factor(duration2m.df$Duration_gmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Males", "Mean Drinking<br>Males", "Sustained Drinking<br>Males"))

duration2m.df$Solution<-factor(duration2m.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration2m.df$xvar<-factor(duration2m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration2m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-2.8,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_gmc Females
duration2f.df<-emmip(model4.2zcDuration_fit2,"Solution"~"time",by="Duration_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_gmc=c(-1,0,1),Sex=c("Female")))

duration2f.df$Duration_gmc <- factor(duration2f.df$Duration_gmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Females", "Mean Drinking<br>Females", "Sustained Drinking<br>Females"))

duration2f.df$Solution<-factor(duration2f.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration2f.df$xvar<-factor(duration2f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration2f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-2.8,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

########################################################################

##Signal-BoutDuration_grpmc Males
duration5m.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1),Sex=c("Male")))

duration5m.df$Duration_grpmc <- factor(duration5m.df$Duration_grpmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Males", "Mean Drinking<br>Males", "Sustained Drinking<br>Males"))

duration5m.df$Solution<-factor(duration5m.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration5m.df$xvar<-factor(duration5m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration5m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.2),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_grpmc Females
duration5f.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1),Sex=c("Female")))

duration5f.df$Duration_grpmc <- factor(duration5f.df$Duration_grpmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Females", "Mean Drinking<br>Females", "Sustained Drinking<br>Females"))

duration5f.df$Solution<-factor(duration5f.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration5f.df$xvar<-factor(duration5f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration5f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.2),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_sol_gmc Both Sexes
duration5.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1)))

duration5.df$Duration_grpmc <- factor(duration5.df$Duration_grpmc,levels=c("-1","0","1"),labels=c("Quick Drinkers", "Mean Drinkers", "Sustained Drinkers"))

duration5.df$Solution<-factor(duration5.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration5.df$xvar<-factor(duration5.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration5.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-.9,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400
```

#### iv) Bout-Level: Duration_imc\*\_gmc

```{r}
## Estimated Means of Duration.sol_imc*Duration_grpmc Outcome Model  
duration6.df<-emmip(model4.2zcDuration_fit6,"Solution"~"Sex",by=c("Duration_sol_imc","Duration_grpmc","time"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1),Duration_grpmc=c(-1,0,1)))

duration6.df<-filter(duration6.df, !Duration_sol_imc=="0" & !Duration_grpmc=="0")

duration6.df$Duration_grpmc <- factor(duration6.df$Duration_grpmc,levels=c("-1","0","1"),labels=c("Quick<br>Drinker", "Mean<br>Drinker", "Sustained<br>Drinker"))

duration6.df$Duration_sol_imc <- factor(duration6.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("<br>Short Bout", "<br>Mean Bout", "<br>Long Bout"))

duration6.df<-duration6.df %>%
  mutate(group=paste(Duration_grpmc,Duration_sol_imc))

duration6.df$group<-factor(duration6.df$group,levels=c("Quick<br>Drinker <br>Short Bout","Quick<br>Drinker <br>Long Bout","Sustained<br>Drinker <br>Short Bout","Sustained<br>Drinker <br>Long Bout"))

duration6.df$Solution<-factor(duration6.df$Solution,levels=c("EtOH","Water","Sucrose"))

duration6.df$time<-factor(duration6.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")

ggplot(data=duration6.df,aes(x=xvar,y=yvar, group=group,color=Solution, linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_wrap(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.7),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=11),legend.justification="right", legend.direction = "horizontal", legend.key.width = unit(1.6,"cm"),legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")

#1000 x 500

ggplot(data=duration6.df,aes(x=group,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.21),linewidth=0.75)+geom_point(position=position_dodge(0.21))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.21),linetype="solid")+theme_classic()+facet_grid(Sex~time)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.04)),limits=c(-1.3,2.4),breaks=c(-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=14),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.36,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#900 x 500

```

#### ii) Bout-Level: LickFreq_imc

```{r}
##Signal-LickFreq_imc Males 
freqm.df<-emmip(model4.2zcLickFreq_fit,"Solution"~"time",by="LickFrequency_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_imc=c(-1,0,1),Sex=c("Male")))  

freqm.df$LickFrequency_imc <- factor(freqm.df$LickFrequency_imc,levels=c("-1","0","1"),labels=c("Males During<br>Slow Drinking", "Males During<br>Mean Drinking", "Males During<br>Fast Drinking"))  

freqm.df$Solution<-factor(freqm.df$Solution,levels=c("EtOH","Water","Sucrose")) 
freqm.df$xvar<-factor(freqm.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freqm.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.44),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  
#650 x 400 

##Signal-LickFreq_imc Females 
freqf.df<-emmip(model4.2zcLickFreq_fit,"Solution"~"time",by="LickFrequency_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_imc=c(-1,0,1),Sex=c("Female")))  

freqf.df$LickFrequency_imc <- factor(freqf.df$LickFrequency_imc,levels=c("-1","0","1"),labels=c("Females During<br>Slow Drinking", "Females During<br>Mean Drinking", "Females During<br>Fast Drinking"))  

freqf.df$Solution<-factor(freqf.df$Solution,levels=c("EtOH","Water","Sucrose")) 

freqf.df$xvar<-factor(freqf.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freqf.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.44),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  
#650 x 400 

 
##Signal-LickFreq_imc Both Sexes 
freq.df<-emmip(model4.2zcLickFreq_fit,"Solution"~"time",by="LickFrequency_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_imc=c(-1,0,1)))  

freq.df$LickFrequency_imc <- factor(freq.df$LickFrequency_imc,levels=c("-1","0","1"),labels=c("During<br>Slow Drinking", "During<br>Mean Drinking", "During<br>Fast Drinking"))  

freq.df$Solution<-factor(freq.df$Solution,levels=c("EtOH","Water","Sucrose")) 

freq.df$xvar<-factor(freq.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freq.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.44),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  
# 650 x 400


## Trying to pull out what the sex interaction looks like - all vars
freq.df<-emmip(model4.2zcLickFreq_fit,"Solution"~"Sex",by=c("LickFrequency_imc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_imc=c(-1,0,1)))  

freq.df$LickFrequency_imc <- factor(freq.df$LickFrequency_imc,levels=c("-1","0","1"),labels=c("During<br>Slow Drinking", "During<br>Mean Drinking", "During<br>Fast Drinking"))  

freq.df$Solution<-factor(freq.df$Solution,levels=c("EtOH","Water","Sucrose")) 


ggplot(data=freq.df,aes(x=LickFrequency_imc,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_grid(~Sex)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.4,1.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),axis.text.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  
#650 x 400 
```

#### iii) Bout-Level: LickFreq_gmc

```{r}
##Signal-LickFrequency_sol_gmc Males 
freq2m.df<-emmip(model4.2zcLickFreq_fit3,"Solution"~"time",by="LickFrequency_sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_gmc=c(-1,0,1),Sex=c("Male")))  

freq2m.df$LickFrequency_sol_gmc <- factor(freq2m.df$LickFrequency_sol_gmc,levels=c(-1,0,1),labels=c("Slow Drinking<br>Males", "Mean Drinking<br>Males", "Fast Drinking<br>Males"))  

freq2m.df$Solution<-factor(freq2m.df$Solution,levels=c("EtOH","Water","Sucrose")) 

freq2m.df$xvar<-factor(freq2m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freq2m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#650 x 400  

##Signal-LickFrequency_sol_gmc Males 
freq2f.df<-emmip(model4.2zcLickFreq_fit3,"Solution"~"time",by="LickFrequency_sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_gmc=c(-1,0,1),Sex=c("Female")))  

freq2f.df$LickFrequency_sol_gmc <- factor(freq2f.df$LickFrequency_sol_gmc,levels=c(-1,0,1),labels=c("Slow Drinking<br>Females", "Mean Drinking<br>Females", "Fast Drinking<br>Females"))  

freq2f.df$Solution<-factor(freq2f.df$Solution,levels=c("EtOH","Water","Sucrose")) 

freq2f.df$xvar<-factor(freq2f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freq2f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.1,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#650 x 400 

########################################################################  
##Signal-BoutDuration_grpmc Males 
freq5m.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1),Sex=c("Male")))  freq5m.df$Duration_grpmc <- factor(freq5m.df$Duration_grpmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Males", "Mean Drinking<br>Males", "Sustained Drinking<br>Males"))  freq5m.df$Solution<-factor(freq5m.df$Solution,levels=c("EtOH","Water","Sucrose")) freq5m.df$xvar<-factor(freq5m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  ggplot(data=freq5m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.2),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #650 x 400  ##Signal-BoutDuration_grpmc Females freq5f.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1),Sex=c("Female")))  freq5f.df$Duration_grpmc <- factor(freq5f.df$Duration_grpmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Females", "Mean Drinking<br>Females", "Sustained Drinking<br>Females"))  freq5f.df$Solution<-factor(freq5f.df$Solution,levels=c("EtOH","Water","Sucrose")) freq5f.df$xvar<-factor(freq5f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  ggplot(data=freq5f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.2),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #650 x 400  ##Signal-BoutDuration_sol_gmc Both Sexes freq5.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1)))  freq5.df$Duration_grpmc <- factor(freq5.df$Duration_grpmc,levels=c("-1","0","1"),labels=c("Quick Drinkers", "Mean Drinkers", "Sustained Drinkers"))  freq5.df$Solution<-factor(freq5.df$Solution,levels=c("EtOH","Water","Sucrose")) freq5.df$xvar<-factor(freq5.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  ggplot(data=freq5.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-.9,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #650 x 400
```

#### iv) Bout-Level: LickFreq_imc\*\_gmc

```{r}
## Estimated Means of LickFrequency.sol_imc*LickFrequency_sol_gmc Outcome Model - all vars 
freq7.df<-emmip(model4.2zcLickFreq_fit7,"Solution"~"Sex",by=c("LickFrequency_sol_imc","LickFrequency_sol_gmc","time"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_imc=c(-1,0,1),LickFrequency_sol_gmc=c(-1,0,1)))

freq7.df<-filter(freq7.df, !LickFrequency_sol_imc=="0" & !LickFrequency_sol_gmc=="0")  

freq7.df$LickFrequency_sol_gmc <- factor(freq7.df$LickFrequency_sol_gmc,levels=c("-1","0","1"),labels=c("Low Frequency<br>Licker", "Mean<br>Drinker", "High Frequency<br>Licker")) 

freq7.df$LickFrequency_sol_imc <- factor(freq7.df$LickFrequency_sol_imc,levels=c("-1","0","1"),labels=c("<br>Slow Lick Bout", "<br>Mean Bout", "<br>Fast Lick Bout"))  

freq7.df<-freq7.df %>%   
  mutate(group=paste(LickFrequency_sol_gmc,LickFrequency_sol_imc))  

freq7.df$group<-factor(freq7.df$group,levels=c("Low Frequency<br>Licker <br>Slow Lick Bout","Low Frequency<br>Licker <br>Fast Lick Bout","High Frequency<br>Licker <br>Slow Lick Bout", "High Frequency<br>Licker <br>Fast Lick Bout"))  

freq7.df$Solution<-factor(freq7.df$Solution,levels=c("EtOH","Water","Sucrose"))  

freq7.df$time<-factor(freq7.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))   

linetypes=c("dotted","dotdash","dashed","solid")  


ggplot(data=freq7.df,aes(x=group,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.21),linewidth=0.75)+geom_point(position=position_dodge(0.21))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.21),linetype="solid")+theme_classic()+facet_grid(Sex~time)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.04)),limits=c(-1.3,1.8),breaks=c(-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=14),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.36,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #900 x 500 


## Estimated Means of LickFrequency.sol_imc*LickFrequency_sol_gmc Outcome Model - collapsed on sex 
freq7ns.df<-emmip(model4.2zcLickFreq_fit7,"Solution"~"time",by=c("LickFrequency_sol_imc","LickFrequency_sol_gmc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_imc=c(-1,0,1),LickFrequency_sol_gmc=c(-1,0,1)))

freq7ns.df<-filter(freq7ns.df, !LickFrequency_sol_imc=="0" & !LickFrequency_sol_gmc=="0")  

freq7ns.df$LickFrequency_sol_gmc <- factor(freq7ns.df$LickFrequency_sol_gmc,levels=c("-1","0","1"),labels=c("Low Frequency<br>Licker", "Mean<br>Drinker", "High Frequency<br>Licker")) 

freq7ns.df$LickFrequency_sol_imc <- factor(freq7ns.df$LickFrequency_sol_imc,levels=c("-1","0","1"),labels=c("<br>Slow Lick Bout", "<br>Mean Bout", "<br>Fast Lick Bout"))  

freq7ns.df<-freq7ns.df %>%   
  mutate(group=paste(LickFrequency_sol_gmc,LickFrequency_sol_imc))  

freq7ns.df$group<-factor(freq7ns.df$group,levels=c("Low Frequency<br>Licker <br>Slow Lick Bout","Low Frequency<br>Licker <br>Fast Lick Bout","High Frequency<br>Licker <br>Slow Lick Bout", "High Frequency<br>Licker <br>Fast Lick Bout"))  

freq7ns.df$Solution<-factor(freq7ns.df$Solution,levels=c("EtOH","Water","Sucrose"))  

freq7ns.df$time<-factor(freq7ns.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before<br>Bout","After<br>Bout"))   

linetypes=c("dotted","dotdash","dashed","solid")  


ggplot(data=freq7ns.df,aes(x=time,y=yvar, group=group,color=Solution,linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_grid(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.key.width = unit(1.6,"cm"),legend.title=element_blank(),legend.text=element_markdown(size=12),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.98,0.90),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")
#900 x 500 



## Estimated Means of LickFrequency.sol_imc*LickFrequency_sol_gmc Outcome Model - collapsed on sex and LickFrequency.sol_imc
freq7nsni.df<-emmip(model4.2zcLickFreq_fit7,"Solution"~"time",by=c("LickFrequency_sol_gmc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_gmc=c(-1,0,1)))

freq7nsni.df<-filter(freq7nsni.df, !LickFrequency_sol_gmc=="0")  

freq7nsni.df$LickFrequency_sol_gmc <- factor(freq7nsni.df$LickFrequency_sol_gmc,levels=c("-1","0","1"),labels=c("Low Frequency<br>Licker", "Mean<br>Drinker", "High Frequency<br>Licker")) 

freq7nsni.df$Solution<-factor(freq7nsni.df$Solution,levels=c("EtOH","Water","Sucrose"))  

freq7nsni.df$time<-factor(freq7nsni.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before<br>Bout","After<br>Bout"))   

linetypes=c("dotted","dotdash","dashed","solid")  


ggplot(data=freq7nsni.df,aes(x=time,y=yvar, group=LickFrequency_sol_gmc,color=Solution,linetype=LickFrequency_sol_gmc))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_grid(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.key.width = unit(1.6,"cm"),legend.title=element_blank(),legend.text=element_markdown(size=13),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.98,0.90),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")
#450 x 500 
```

#### ii) Position

```{r}
##Signal-Position Males & Females (no sex diffs with just Position) 
pos.df<-emmip(model4.2zcPos_fit,"Solution"~"Position", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE)  

pos.df$xvar <- factor(pos.df$xvar,levels=c("First 10 min","Middle","Last 10 min"))  

pos.df$Solution<-factor(pos.df$Solution,levels=c("EtOH","Water","Sucrose")) 

#pos.df$xvar<-factor(pos.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=pos.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.1))+geom_point(position=position_dodge(0.1))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.1))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.4,0.85),n.breaks=10)+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#650 x 400  

####################################################
############ Publishable Graph #####################
####################################################

##Signal-Position Males & Females (no sex diffs with just Position) 
pos.df<-emmip(model4.2zcPos_fit,"Solution"~"Position", by="time",lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE)  

pos.df$xvar <- factor(pos.df$xvar,levels=c("First 10 min","Middle","Last 10 min"))  

pos.df$Solution<-factor(pos.df$Solution,levels=c("EtOH","Water","Sucrose")) 

pos.df$time<-factor(pos.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=pos.df,aes(x=time,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.32))+geom_point(position=position_dodge(0.32),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.32))+theme_classic()+facet_grid(.~xvar)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.5))+scale_y_continuous(expand = expansion(c(0.01,0.1)),limits=c(-0.8,1.5),n.breaks=8)+labs(x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=title.sz),strip.text.y = element_markdown(face="bold",size=title.sz),legend.title=element_blank(),legend.text=element_text(size=txt.sz2),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.46,0.94),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
ggsave(filename="CL8_Model4.2zcpos_fit EstimatedMeans_by_Solution.tiff",plot=last_plot(), units="mm", width=600/.pt, height=450/.pt, dpi=600,path=output,device=grDevices::tiff)

#600 x 450  

##Signal-LickFrequency_sol_gmc Males 
freq2f.df<-emmip(model4.2zcLickFreq_fit3,"Solution"~"time",by="LickFrequency_sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_gmc=c(-1,0,1),Sex=c("Female")))  

freq2f.df$LickFrequency_sol_gmc <- factor(freq2f.df$LickFrequency_sol_gmc,levels=c(-1,0,1),labels=c("Slow Drinking<br>Females", "Mean Drinking<br>Females", "Fast Drinking<br>Females"))  

freq2f.df$Solution<-factor(freq2f.df$Solution,levels=c("EtOH","Water","Sucrose")) 


freq2f.df$xvar<-factor(freq2f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freq2f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.1,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#650 x 400 


####################################################################

## Estimated Means of Duration.sol_imc*Duration_grpmc Outcome Model  
duration6.df<-emmip(model4.2zcDuration_fit6,"Solution"~"Sex",by=c("Duration_sol_imc","Duration_grpmc","time"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1),Duration_grpmc=c(-1,0,1)))

duration6.df<-filter(duration6.df, !Duration_sol_imc=="0" & !Duration_grpmc=="0")

duration6.df$Duration_grpmc <- factor(duration6.df$Duration_grpmc,levels=c("-1","0","1"),labels=c("Quick<br>Drinker", "Mean<br>Drinker", "Sustained<br>Drinker"))

duration6.df$Duration_sol_imc <- factor(duration6.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("<br>Short Bout", "<br>Mean Bout", "<br>Long Bout"))

duration6.df<-duration6.df %>%
  mutate(group=paste(Duration_grpmc,Duration_sol_imc))

duration6.df$group<-factor(duration6.df$group,levels=c("Quick<br>Drinker <br>Short Bout","Quick<br>Drinker <br>Long Bout","Sustained<br>Drinker <br>Short Bout","Sustained<br>Drinker <br>Long Bout"))

duration6.df$Solution<-factor(duration6.df$Solution,levels=c("EtOH","Water","Sucrose"))

duration6.df$time<-factor(duration6.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")

ggplot(data=duration6.df,aes(x=xvar,y=yvar, group=group,color=Solution, linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_wrap(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.7),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=11),legend.justification="right", legend.direction = "horizontal", legend.key.width = unit(1.6,"cm"),legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")

#1000 x 500

ggplot(data=duration6.df,aes(x=group,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.21),linewidth=0.75)+geom_point(position=position_dodge(0.21))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.21),linetype="solid")+theme_classic()+facet_grid(Sex~time)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.04)),limits=c(-1.3,2.4),breaks=c(-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=14),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.36,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#900 x 500


```

## 470 SIGNAL & DIP ANALYSIS

### 1) Read in Data

```{r}
filenorm<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Normalization Comparison - Dips and Overall Activity/Normalization_Method_Comparison.xlsx"

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Normalization Comparison - Dips and Overall Activity"


signal.analysis<-read.xlsx(filenorm,sheetIndex=1,header=TRUE) # This is the Overall Signal data
dip.analysis<-read.xlsx(filenorm,sheetIndex=2,header=TRUE) # This is the 405 deflection signal data
```

### 2) Filter & Finalize Data

```{r}
file2<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/CL8exptkey.xlsx"  

sessionkey<-read.xlsx(file2, sheetIndex=1)  

sexkey<-read.xlsx(file2, sheetIndex=2)  

##For signal analysis
#Code to automatically enter in Output Order,Mouse,& Sex based on order in spreadsheet and FileName
setDT(signal.analysis)[,Sex:=rep(NA,length(row.names(signal.analysis)))] 
setDT(signal.analysis)[,session.sol:=rep(NA,length(row.names(signal.analysis)))]
setDT(signal.analysis)[,session.lin:=rep(NA,length(row.names(signal.analysis)))]
setDT(signal.analysis)[,session.exp:=rep(NA,length(row.names(signal.analysis)))]
setDT(signal.analysis)[,Solution:=rep(NA,length(row.names(signal.analysis)))]  

#Fill in the correct session # and Solution from the matching FileName entry in the key 
for (i in 1:length(signal.analysis$FileName)){ 
  signal.analysis$session.sol[[i]]<-sessionkey$session.solution[[which(sessionkey$FileName==signal.analysis$FileName[[i]])]]
  signal.analysis$session.lin[[i]]<-sessionkey$session.linear[[which(sessionkey$FileName==signal.analysis$FileName[[i]])]]
  signal.analysis$session.exp[[i]]<-sessionkey$session.experiment[[which(sessionkey$FileName==signal.analysis$FileName[[i]])]]
  signal.analysis$Solution[[i]]<-sessionkey$Solution[[which(sessionkey$FileName==signal.analysis$FileName[[i]])]]
}

## Grab the Mouse number from the FileName title - numbers that follow either A or B, depending on whether A or B is in "Channel"
for(i in 1:length(signal.analysis$FileName)){ 
  if(signal.analysis$Channel[[i]]=="A"){
    signal.analysis$Mouse[[i]]<-str_extract(signal.analysis$FileName[[i]],"(?<=A)[0-9]*")}
  if(signal.analysis$Channel[[i]]=="B"){
    signal.analysis$Mouse[[i]]<-str_extract(signal.analysis$FileName[[i]],"(?<=B)[0-9]*")}
}

## Grab the Sex from the entry in the key that matches each Mouse
for (i in 1:length(signal.analysis$Mouse)){ 
  signal.analysis$Sex[[i]]<-sexkey$Sex[[which(sexkey$Mouse==signal.analysis$Mouse[[i]])]]}




## For dip/deflection data
#Code to automatically enter in Output Order,Mouse,& Sex based on order in spreadsheet and FileName
setDT(dip.analysis)[,Sex:=rep(NA,length(row.names(dip.analysis)))] 
setDT(dip.analysis)[,session.sol:=rep(NA,length(row.names(dip.analysis)))]
setDT(dip.analysis)[,session.lin:=rep(NA,length(row.names(dip.analysis)))]
setDT(dip.analysis)[,session.exp:=rep(NA,length(row.names(dip.analysis)))]
setDT(dip.analysis)[,Solution:=rep(NA,length(row.names(dip.analysis)))]  

#Fill in the correct session # and Solution from the matching FileName entry in the key 
for (i in 1:length(dip.analysis$FileName)){ 
  dip.analysis$session.sol[[i]]<-sessionkey$session.solution[[which(sessionkey$FileName==dip.analysis$FileName[[i]])]]
  dip.analysis$session.lin[[i]]<-sessionkey$session.linear[[which(sessionkey$FileName==dip.analysis$FileName[[i]])]]
  dip.analysis$session.exp[[i]]<-sessionkey$session.experiment[[which(sessionkey$FileName==dip.analysis$FileName[[i]])]]
  dip.analysis$Solution[[i]]<-sessionkey$Solution[[which(sessionkey$FileName==dip.analysis$FileName[[i]])]]
}

## Grab the Mouse number from the FileName title - numbers that follow either A or B, depending on whether A or B is in "Channel"
for(i in 1:length(dip.analysis$FileName)){ 
  if(dip.analysis$Channel[[i]]=="A"){
    dip.analysis$Mouse[[i]]<-str_extract(dip.analysis$FileName[[i]],"(?<=A)[0-9]*")}
  if(dip.analysis$Channel[[i]]=="B"){
    dip.analysis$Mouse[[i]]<-str_extract(dip.analysis$FileName[[i]],"(?<=B)[0-9]*")}
}

## Grab the Sex from the entry in the key that matches each Mouse
for (i in 1:length(dip.analysis$Mouse)){ 
  dip.analysis$Sex[[i]]<-sexkey$Sex[[which(sexkey$Mouse==dip.analysis$Mouse[[i]])]]}


##Levels of different factors specific to experiment - used later and is EXTREMELY IMPORTANT for contrasts

#This is used for the wide format data
group1.levels<-c("Female EtOH", "Male EtOH","Female Water","Male Water", "Female Sucrose", "Male Sucrose")

#This is used for the long format data
group2.levels<-c("Female EtOH 470","Female EtOH Standard","Female EtOH NNLS","Female EtOH Joint","Male EtOH 470","Male EtOH Standard","Male EtOH NNLS","Male EtOH Joint")

sol.levels<-c("EtOH","Water","Sucrose")
sol.levels.contr<-c("Water","Sucrose","EtOH")
method.levels<-c("None","Standard","NNLS","Joint")
method.levels2<-c("470","Doric","NNLS","Joint")
method.labels<-c("UN 470","Standard","Robust","JCBM")


#Drop any sessions from dropped mice (doesn't include bout b/c this is session level data)
droppedmice<-c("3","4","13") 
droppedsessions<-data.frame("FileName"=c(""), "Mouse"=c(""))  
droppedsolutions<-c("")

#Define replicates within sex manually here - exclude dropped animals! 
subject<-data.frame("mouse"=c(1,5,6,14,15,17,18,20,8,9,10,21,22,23),"subject"=c(1,2,3,4,5,6,7,8,1,2,3,4,5,6))  
sub.levels=c(1:13)

#Pick whether you want session to be coded within solution (session.sol), linear (just 1-# of sessions; session.lin), or by experiment (1-40 each cohort; session.exp)
names(signal.analysis)[which(names(signal.analysis)=="session.sol")]<-"session"
names(dip.analysis)[which(names(dip.analysis)=="session.sol")]<-"session"


#Drop sessions and solutions defined above
signal.analysis2<-filter(signal.analysis, !Mouse %in% droppedmice)
for (k in 1:nrow(droppedsessions)){
signal.analysis2<-filter(signal.analysis2, !(FileName==droppedsessions$FileName[[k]] & Mouse==droppedsessions$Mouse[[k]]))
}

signal.analysis2<-filter(signal.analysis2, !Solution %in% droppedsolutions, preserve=TRUE)

dip.analysis2<-filter(dip.analysis, !Mouse %in% droppedmice)
for (k in 1:nrow(droppedsessions)){
dip.analysis2<-filter(dip.analysis2, !(FileName==droppedsessions$FileName[[k]] & Mouse==droppedsessions$Mouse[[k]]))
}

dip.analysis2<-filter(dip.analysis2, !Solution %in% droppedsolutions, preserve=TRUE)

#Set Levels for Solutions
signal.analysis2$Solution<-factor(signal.analysis2$Solution,levels=sol.levels)
dip.analysis2$Solution<-factor(dip.analysis2$Solution,levels=sol.levels)


#Codes the subjects as replicate within sex  
setDT(signal.analysis2)[,subject:=rep(NA,length(row.names(signal.analysis2)))] 
for (i in 1:length(rownames(signal.analysis2))){     
      signal.analysis2$subject[[i]]<-subject$subject[[which(subject$mouse==signal.analysis2$Mouse[[i]])]]
}
signal.analysis2$subject<-factor(signal.analysis2$subject,levels=sub.levels)  

setDT(dip.analysis2)[,subject:=rep(NA,length(row.names(dip.analysis2)))] 
for (i in 1:length(rownames(dip.analysis2))){     
      dip.analysis2$subject[[i]]<-subject$subject[[which(subject$mouse==dip.analysis2$Mouse[[i]])]]
}
dip.analysis2$subject<-factor(dip.analysis2$subject,levels=sub.levels)  

#Create group variable that is a combination of Sex and Solution
group_shrt<-paste(signal.analysis2$Sex,signal.analysis2$Solution,sep=" ") 
signal.analysis2<-cbind(signal.analysis2,group_shrt) 

signal.analysis2$group_shrt<-factor(signal.analysis2$group_shrt,levels=group1.levels)

group_shrt<-paste(dip.analysis2$Sex,dip.analysis2$Solution,sep=" ") 
dip.analysis2<-cbind(dip.analysis2,group_shrt) 

dip.analysis2$group_shrt<-factor(dip.analysis2$group_shrt,levels=group1.levels)


remove(group_shrt,droppedsessions,droppedmice,droppedsolutions,subject)


## Sort columns into desired order (feel free to customize). This will also be used to refer to all your variables later on so don't leave any out - THEY WILL BE DROPPED! 

myorder.sa<-c("Output.Order","FileName","Channel","Mouse","Sex","subject","Solution","group_shrt","session","None.ChannelMean405","None.ChannelMean470","None.PeakFrequency","None.MAD","None.MeanPeak","Standard.ChannelMean405","Standard.ChannelMean470","Standard.PeakFrequency","Standard.MAD","Standard.MeanPeak","Joint.ChannelMean405","Joint.ChannelMean470","Joint.PeakFrequency","Joint.MAD","Joint.MeanPeak","NNLS.ChannelMean405","NNLS.ChannelMean470","NNLS.PeakFrequency", "NNLS.MAD","NNLS.MeanPeak")

myorder.da<-c("Output.Order","FileName","Channel","Mouse","Sex","subject","Solution","group_shrt","session","Start","Stop","Duration","mean.405","sd.405","mean.NNLS","sd.NNLS","mean.Doric","sd.Doric","mean.Joint","sd.Joint","mean.Mirror","sd.Mirror","mean.470","sd.470")

#Define variables that are key descriptors of the data (e.g. Filename, Channel, Mouse, Sex, subject...)

corevars.sa<-c("Output.Order","FileName","Channel","Mouse","Sex","subject","Solution","group_shrt","session")

corevars.da<-c("Output.Order","FileName","Channel","Mouse","Sex","subject","Solution","group_shrt","session","Start","Stop","Duration")

signal.analysis2<-signal.analysis2[,..myorder.sa]
dip.analysis2<-dip.analysis2[,..myorder.da]

signal.analysis2<-sort_df(signal.analysis2,c('Output.Order'))
dip.analysis2<-sort_df(dip.analysis2,c('Output.Order'))

rownames(signal.analysis2)<-c(1:length(rownames(signal.analysis2))) #reset row names so they follow a consecutive order again
rownames(dip.analysis2)<-c(1:length(rownames(dip.analysis2))) #reset row names so they follow a consecutive order again

myorder2.sa<-myorder.sa[which(!myorder.sa %in% corevars.sa) ]
myorder2.da<-myorder.da[which(!myorder.da %in% corevars.da) ]

signal.analysis2_long<-signal.analysis2 %>% pivot_longer(cols=all_of(myorder2.sa), cols_vary="slowest",names_to=c("Method",".value"),names_sep = "\\.") 

dip.analysis2_long<-dip.analysis2 %>% pivot_longer(cols=all_of(myorder2.da), cols_vary="slowest",names_to=c(".value","Method"),names_sep = "\\.")

signal.analysis2_long$Method<-factor(signal.analysis2_long$Method, levels=method.levels,labels=method.labels)

#Drop Mirror and 405 Methods and relabel remaining ones to what is used in manuscript
dip.analysis3_long<-subset(dip.analysis2_long, !Method=="405" & !Method=="Mirror")
dip.analysis3_long$Method<-factor(dip.analysis3_long$Method,levels=method.levels2,labels=method.labels)


```

### 3) Set Graph Color Palette and Text Size
```{r}
c1<-"#D41159" #This is rgb(212,17,89, maxColorValue=255) or red for EtOH
c2<-"#1A85FF" #This is rgb(26,133,255, maxColorValue=255) or blue for Water
c3<-"#5225A0" #This is rgb(82,37,160, maxColorValue=255) or purple for Sucrose

custom<-c(c1,c2,c3) #Define custom color palette

c4<-"white" #For None
c5<-"lightgrey" #For Standard
c6<-"darkgrey" #For NNLS
c7<-"#B4F8DF" #This is rgb(180,248,223,maxColorValue=255)or sea green for Joint

custom2<-c(c4,c5,c6,c7)

patterns24<-c("stripe","stripe","stripe","stripe",rep.int("none",20))
patterns12<-c("stripe","stripe","stripe",rep.int("none",9))
patterns4<-c("stripe","none","none","none")

#Set specifc relationships between titles, axis text, and other text categories so allow consistency between figures of the same size.

title.sz<-6.5*.pt
txt.sz1<-5*.pt
txt.sz2<-5.5*.pt
txt.sz3<-6*.pt
otr.sz<-2.5*.pt
otr.sz1<-3.5*.pt
otr.sz2<-4.5*.pt
```

###4) Graph Data - Overall Signal
####a) CAL & CTL
```{r}
##Plot signal for all sessions for raw signal divided only by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Sex,Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.CAL<-filter(ReplicateAverages,variable=="ChannelMean470",preserve=TRUE)
ReplicateAverages.CTL<-filter(ReplicateAverages,variable=="ChannelMean405",preserve=TRUE)

#Method = None for pre-existing group differences
ggplot(data=subset(signal.analysis2_long,Method=="UN 470"),aes(x=Sex,y=ChannelMean470)) +theme_classic()+geom_col_pattern(data=subset(ReplicateAverages.CAL,Method=="None"),aes(x=Sex,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=subset(ReplicateAverages.CAL,Method=="None"),aes(x=Sex,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = rep.int(custom2[1],6))+scale_pattern_manual(values = rep.int(patterns4[1],6)) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,730),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Mean 470 Raw")+guides(color=guide_legend(override.aes = list(size=4)))

#Method = None for pre-existing group differences
ggplot(data=subset(signal.analysis2_long,Method=="UN 470"),aes(x=Sex,y=ChannelMean405)) +theme_classic()+geom_col_pattern(data=subset(ReplicateAverages.CTL,Method=="None"),aes(x=Sex,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_beeswarm(cex=3,size=5,alpha=0.8,aes(size=2,color=Mouse))+scale_fill_manual(values = rep.int(custom2[1],6))+geom_errorbar(data=subset(ReplicateAverages.CTL,Method=="None"),aes(x=Sex,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+scale_color_viridis_d()+scale_pattern_manual(values = rep.int(patterns4[1],6)) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,935),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_text(face="bold",size=txt.sz2),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal",legend.position="inside", legend.position.inside=c(0.45,0.85),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Mean 405 Raw")+guides(color=guide_legend(override.aes = list(size=4)))

```

#### a) MAD

```{r}
############
##Plot signal for all sessions per group divided only by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Sex,Method) %>% get_summary_stats(type = "mean_se");
ReplicateAverages$Method <-factor(ReplicateAverages$Method,levels=c("UN 470", "Standard", "Robust","JCBM"))

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)
ReplicateAverages.CAL_m<-filter(ReplicateAverages,variable=="CAL_m",preserve=TRUE)
ReplicateAverages.CAL_m<-filter(ReplicateAverages,variable=="CAL_m",preserve=TRUE)

#Method = None for pre-existing group differences
ggplot(data=subset(signal.analysis2_long,Method=="UN 470"),aes(x=Sex,y=MAD)) +theme_classic()+geom_col_pattern(data=subset(ReplicateAverages.MAD,Method=="UN 470"),aes(x=Sex,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=subset(ReplicateAverages.MAD,Method=="UN 470"),aes(x=Sex,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = rep.int(custom2[1],6))+scale_pattern_manual(values = rep.int(patterns4[1],6)) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,3.5),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="MAD")+guides(color=guide_legend(override.aes = list(size=4)))


##Plot signal for all sessions per group divided by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Sex,Solution,Method,group_shrt) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)

#Method = None for pre-existing group differences
ggplot(data=subset(signal.analysis2_long,Method=="UN 470"),aes(x=group_shrt,y=MAD)) +theme_classic()+geom_col_pattern(data=subset(ReplicateAverages.MAD,Method=="UN 470"),aes(x=group_shrt,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=subset(ReplicateAverages.MAD,Method=="UN 470"),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = rep.int(custom2[1],6))+scale_pattern_manual(values = rep.int(patterns4[1],6)) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,4.5))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="MAD")+guides(color=guide_legend(override.aes = list(size=4)))


#Group by Method
ggplot(data=signal.analysis2_long,aes(x=group_shrt,y=MAD)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MAD,aes(x=group_shrt,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MAD,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method,ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,4.5))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="MAD")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

ggplot(data=signal.analysis2_long,aes(x=Method,y=MAD)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MAD,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MAD,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~group_shrt) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,4.5))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Normalization Method", y="MAD ")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450 

############
##Plot signal for all sessions per group collapsed by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Solution,Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Solution<-factor(ReplicateAverages$Solution,levels=sol.levels)
ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)

ggplot(data=signal.analysis2_long,aes(x=Solution,y=MAD)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MAD,aes(x=Solution,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MAD,aes(x=Solution,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method,ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,4.5))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="MAD ")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

ggplot(data=signal.analysis2_long,aes(x=Method,y=MAD)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MAD,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MAD,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Solution) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,4.5),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz1,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="MAD ")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450 or #650 x 350 (Smaller)

######################################
######## Publication Graph ###########
######################################

##Plot signal for all sessions per group collapsed by sex and Solution 
ReplicateAverages <- signal.analysis2_long %>% group_by(Method) %>% get_summary_stats(type = "mean_se");
ReplicateAverages$Method <-factor(ReplicateAverages$Method,labels=c("UN 470", "Standard","Robust","JCBM"))

ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)

#Sig indicator lines over any group to begin to indicate differences between methods 
annotation_df<-data.frame(
  xstart=c(0.6,1.6,2.6,3.6),
  xend=c(1.4,2.4,3.4,4.4),
  yvals= c(3.6,4.1,3.5,3.75),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over methods to begin to indicate differences between them 
annotation_df2<-data.frame(
  xstart=c(1),
  xend=c(2),
  yvals= c(4.2),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df3<-data.frame(
  xstart=c(1),
  xend=c(3),
  yvals= c(4.5),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df4<-data.frame(
  xstart=c(1),
  xend=c(4),
  yvals= c(4.8),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )

ggplot(data=signal.analysis2_long,aes(x=Method,y=MAD)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MAD,aes(x=Method,y=mean,fill=Method,pattern=Method),width=.7,color=c("black",NA,NA,NA),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MAD,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_beeswarm(cex=1.5,size=3,alpha=0.6,aes(x = as.integer(Method) +.35,size=2),corral="wrap",corral.width = 0.4)+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.2)))+scale_y_continuous(expand = expansion(c(0,0.02)),limits=c(0,5),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz3,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Session 470 nm Signal MAD**")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.5,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.131,0.02),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.069,0.22),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.075,0.23),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

#500 x 450 
ggsave(filename="CL8_SignalAnalysis_BeeswarmSessions_MAD_by_Method.tiff",plot=last_plot(), units="mm", width=500/.pt, height=450/.pt, dpi=900,path=output)

ggplot(data=signal.analysis2_long,aes(x=Method,y=MAD))+theme_classic()+geom_violin_pattern(data=signal.analysis2_long,aes(pattern=Method, fill=Method,color=Method),stat="ydensity",width=0.75,show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MAD,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_crossbar(data=ReplicateAverages.MAD,aes(x=Method,y=mean,ymin=mean,ymax=mean),width=c(0.45,0.5,0.5,0.45),linewidth=0.2,color="black")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+scale_color_manual(values=c("black",NA,NA,NA)) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0,0.02)),limits=c(0,5),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=title.sz,color="black"),axis.text.x=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Session 470 nm Signal MAD**")+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.131,0.02),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.069,0.05),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.075,0.08),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

#400 x 450 
#output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Normalization Comparison - Dips and Overall Activity/"
output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_SignalAnalysis_ViolinSessions_MAD_by_Method.tiff",plot=last_plot(), units="mm", width=400/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

```

#### b) PeakFrequency

```{r}
############
##Plot signal for all sessions per group divided by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Sex,Solution,Method,group_shrt) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)


ggplot(data=signal.analysis2_long,aes(x=group_shrt,y=PeakFrequency)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.PeakFrequency,aes(x=group_shrt,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.PeakFrequency,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2),corral="wrap")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method,ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(0,0.47),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Event Frequency ")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

ggplot(data=signal.analysis2_long,aes(x=Method,y=PeakFrequency)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.PeakFrequency,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.PeakFrequency,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~group_shrt,nrow=2,dir="v") +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(0,0.45))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Peak Frequency ")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450 

############
##Plot signal for all sessions per group collapsed by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Solution,Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Solution<-factor(ReplicateAverages$Solution,levels=sol.levels)
ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)

ggplot(data=signal.analysis2_long,aes(x=Solution,y=PeakFrequency)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.PeakFrequency,aes(x=Solution,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.PeakFrequency,aes(x=Solution,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method,ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(0,0.45),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Peak Frequency")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

ggplot(data=signal.analysis2_long,aes(x=Method,y=PeakFrequency)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.PeakFrequency,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.PeakFrequency,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Solution) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(0,0.45),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Peak Frequency")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450 

###################################
###### PUBLICATION GRAPH ##########
###################################

##Plot signal for all sessions collapsed by sex and solution
ReplicateAverages <- signal.analysis2_long %>% group_by(Method) %>% get_summary_stats(type = "mean_se");
ReplicateAverages$Method <-factor(ReplicateAverages$Method,labels=c("UN 470", "Standard","Robust","JCBM"))

ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)

#Sig indicator lines over any group to begin to indicate differences between methods 
annotation_df<-data.frame(
  xstart=c(0.6,1.6,2.6,3.6),
  xend=c(1.4,2.4,3.4,4.4),
  yvals= c(0.35,0.37,0.39,0.34),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over methods to begin to indicate differences between them 
annotation_df2<-data.frame(
  xstart=c(1),
  xend=c(2),
  yvals= c(0.42),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df3<-data.frame(
  xstart=c(1),
  xend=c(3),
  yvals= c(0.45),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df4<-data.frame(
  xstart=c(1),
  xend=c(4),
  yvals= c(0.48),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )

ggplot(data=signal.analysis2_long,aes(x=Method,y=PeakFrequency)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.PeakFrequency,aes(x=Method,y=mean,fill=Method,pattern=Method),width=.7,color=c("black",NA,NA,NA),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.PeakFrequency,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_beeswarm(cex=1.5,size=3,alpha=0.6,aes(x = as.integer(Method) +.35,size=2),corral="wrap",corral.width = 0.4)+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.2)))+scale_y_continuous(expand = expansion(c(0,0.05)),limits=c(0,0.48),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz3,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Session 470 nm Signal<br>Event Frequency** (Events/Second)")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.5,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.07,0.02),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.069,0.045),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.075,0.23),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

ggsave(filename="CL8_SignalAnalysis_BeeswarmSessions_PeakFrequency_by_Method.tiff",plot=last_plot(), units="mm", width=400/.pt, height=450/.pt, dpi=900,path=output)

#500 x 450 



ggplot(data=signal.analysis2_long,aes(x=Method,y=PeakFrequency))+theme_classic()+geom_violin_pattern(data=signal.analysis2_long,aes(pattern=Method, fill=Method,color=Method),stat="ydensity",width=0.75,show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.PeakFrequency,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_crossbar(data=ReplicateAverages.PeakFrequency,aes(x=Method,y=mean,ymin=mean,ymax=mean),width=c(0.4,0.55,0.4,0.4),linewidth=0.2,color="black")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+scale_color_manual(values=c("black",NA,NA,NA)) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0,0.05)),limits=c(0,0.48),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=title.sz,color="black"),axis.text.x=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Session 470 nm Signal<br>Event Frequency** (Events/Second)")+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.07,0.02),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.069,0.045),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.075,0.05),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

#400 x 450 
#output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Normalization Comparison - Dips and Overall Activity/"
output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_SignalAnalysis_ViolinSessions_PeakFrequency_by_Method.tiff",plot=last_plot(), units="mm", width=400/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)
#500 x 450 
```


#### c) Mean Peak

```{r}
############
##Plot signal for all sessions per group divided by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Sex,Solution,Method,group_shrt) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)

ggplot(data=signal.analysis2_long,aes(x=group_shrt,y=MeanPeak)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MeanPeak,aes(x=group_shrt,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MeanPeak,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method, ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(0,14),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Mean Peak Amplitude")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

ggplot(data=signal.analysis2_long,aes(x=Method,y=MeanPeak)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MeanPeak,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MeanPeak,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~group_shrt) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(0,14))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Normalization Method", y="Mean Peak")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450 

############
##Plot signal for all sessions per group collapsed by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Solution,Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Solution<-factor(ReplicateAverages$Solution,levels=sol.levels)
ReplicateAverages.MAD<-filter(ReplicateAverages,variable=="MAD",preserve=TRUE)
ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)
ReplicateAverages.PeakFrequency<-filter(ReplicateAverages,variable=="PeakFrequency",preserve=TRUE)

ggplot(data=signal.analysis2_long,aes(x=Solution,y=MeanPeak)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MeanPeak,aes(x=Solution,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MeanPeak,aes(x=Solution,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method,ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(0,14),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Mean Peak Amplitude")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

ggplot(data=signal.analysis2_long,aes(x=Method,y=MeanPeak)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MeanPeak,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MeanPeak,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2))+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Solution) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(0,14),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz2,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Mean Peak Amplitude")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450 

#######################################
########## Publication Graph ##########
#######################################

##Plot signal for all sessions per group collapsed by sex 
ReplicateAverages <- signal.analysis2_long %>% group_by(Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Method <-factor(ReplicateAverages$Method,labels=c("UN 470", "Standard","Robust","JCBM"))

ReplicateAverages.MeanPeak<-filter(ReplicateAverages,variable=="MeanPeak",preserve=TRUE)

#Sig indicator lines over any group to begin to indicate differences between methods 
annotation_df<-data.frame(
  xstart=c(0.6,1.6,2.6,3.6),
  xend=c(1.4,2.4,3.4,4.4),
  yvals= c(8,9,12,13.7),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over methods to begin to indicate differences between them 
annotation_df2<-data.frame(
  xstart=c(1),
  xend=c(2),
  yvals= c(14.41),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df3<-data.frame(
  xstart=c(1),
  xend=c(3),
  yvals= c(15.43),
  labels=c(paste("list(symbol('*'))",sep=","))
  )

annotation_df4<-data.frame(
  xstart=c(1),
  xend=c(4),
  yvals= c(16.45),
  labels=c(paste("list(symbol('**'))",sep=","))
  )

ggplot(data=signal.analysis2_long,aes(x=Method,y=MeanPeak)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.MeanPeak,aes(x=Method,y=mean,fill=Method,pattern=Method),width=.7,color=c("black",NA,NA,NA),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MeanPeak,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_beeswarm(cex=1.5,size=3,alpha=0.6,aes(x = as.integer(Method) +.35,size=2),corral="wrap",corral.width = 0.4)+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.2)))+scale_y_continuous(expand = expansion(c(0,0.01)),limits=c(0,15),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=title.sz,color="black"),axis.text.x=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Session 470 nm Signal<br>Mean Peak Amplitude** (%<span style='font-family: Symbol;'>D</span>_F/F_)")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = 0.00,size=0.5,vjust= 0.5,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.343,0.27),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.08,0.14),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.075,0.068),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

ggsave(filename="CL8_SignalAnalysis_BeeswarmSessions_MeanPeak_by_Method.tiff",plot=last_plot(), units="mm", width=500/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)
#500 x 450 



ggplot(data=signal.analysis2_long,aes(x=Method,y=MeanPeak))+theme_classic()+geom_violin_pattern(data=signal.analysis2_long,aes(pattern=Method, fill=Method,color=Method),stat="ydensity",width=0.75,show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.MeanPeak,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_crossbar(data=ReplicateAverages.MeanPeak,aes(x=Method,y=mean,ymin=mean,ymax=mean),width=c(0.7,0.6,0.75,0.7),linewidth=0.2,color="black")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+scale_color_manual(values=c("black",NA,NA,NA)) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0,0.02)),limits=c(0,17),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=title.sz,color="black"),axis.text.x=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Session 470 nm Signal<br>Mean Event Amplitude** (%<span style='font-family: Symbol;'>D</span>_F/F_)")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.08,0.025),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.08,0.068),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.075,0.068),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)
#400 x 450 
#output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_SignalAnalysis_ViolinSessions_MeanPeak_by_Method.tiff",plot=last_plot(), units="mm", width=400/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)
```


###5) Graph Data - Signal in Dips
#### a) Mean

```{r}
############
##Plot signal for all sessions per group divided by sex 
ReplicateAverages <- dip.analysis3_long %>% group_by(Sex,Solution,Method,group_shrt) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.mean<-filter(ReplicateAverages,variable=="mean",preserve=TRUE)

ggplot(data=dip.analysis3_long,aes(x=group_shrt,y=mean)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.mean,aes(x=group_shrt,y=mean,fill=Method,pattern=Method),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.mean,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.5,aes(size=2),corral="wrap")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method,ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(-7.5,40))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz,color="black"),axis.title.y=element_markdown(size=title.sz),axis.title.x=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**GCaMP7f Signal<br> During 405 Dip** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

##Without Beeswarm
ggplot(data=dip.analysis3_long,aes(x=group_shrt,y=mean)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.mean,aes(x=group_shrt,y=mean,fill=Method,pattern=Method),color=c("black","black","black","black","black","black",rep.int(c(NA),18)),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.mean,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method,ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(0,15))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz,color="black"),axis.title.y=element_markdown(size=title.sz),axis.title.x=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**GCaMP7f Signal<br> During 405 Dip** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes = list(size=4)))

#750x450
ggplot(data=dip.analysis3_long,aes(x=Method,y=mean)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.mean,aes(x=Method,y=mean,fill=Method,pattern=Method),color=rep.int(c("black",NA,NA,NA),6),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.mean,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.7,size=2,alpha=0.5,aes(size=2),corral="wrap")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~group_shrt,dir="v",nrow=2) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.2))+scale_y_continuous(expand = expansion(0),limits=c(-7.5,40))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz1,color="black"),axis.title.y=element_markdown(size=title.sz),axis.title.x=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**GCaMP7f Signal<br> During 405 Dip** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450 

############
##Plot signal for all sessions per group collapsed by sex 
ReplicateAverages <- dip.analysis3_long %>% group_by(Solution,Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Solution <-factor(ReplicateAverages$Solution,levels=sol.levels)


ReplicateAverages.mean<-filter(ReplicateAverages,variable=="mean",preserve=TRUE)
ReplicateAverages.sd<-filter(ReplicateAverages,variable=="sd",preserve=TRUE)

ggplot(data=dip.analysis3_long,aes(x=Solution,y=mean)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.mean,aes(x=Solution,y=mean,fill=Method,pattern=Method),color=c("black","black","black",NA,NA,NA,NA,NA,NA,NA,NA,NA),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.mean,aes(x=Solution,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.7,size=2,alpha=0.5,aes(size=2),corral="wrap")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Method,ncol=4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.3))+scale_y_continuous(expand = expansion(0),limits=c(-7.5,40),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz1,color="black"),axis.title.y=element_markdown(size=title.sz),axis.title.x=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**GCaMP7f Signal<br> During 405 Dip** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

ggplot(data=dip.analysis3_long,aes(x=Method,y=mean)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.mean,aes(x=Method,y=mean,fill=Method,pattern=Method),color=rep.int(c("black",NA,NA,NA),3),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.mean,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.7,size=1,alpha=0.5,aes(size=2),corral="wrap")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Solution,ncol=3) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.2))+scale_y_continuous(expand = expansion(0),limits=c(-7.5,40),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz1,color="black"),axis.title.y=element_markdown(size=title.sz),axis.title.x=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**GCaMP7f Signal<br> During 405 Dip** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450 or #650 x 350 (Smaller)


##############################################
############ Publication Graph ###############
##############################################
##Plot signal for all sessions collapsed by sex and Solution

ReplicateAverages <- dip.analysis3_long %>% group_by(Method) %>% get_summary_stats(type = "mean_se");
ReplicateAverages$Method <-factor(ReplicateAverages$Method,labels=c("UN 470", "Standard","Robust","JCBM"))


ReplicateAverages.mean<-filter(ReplicateAverages,variable=="mean",preserve=TRUE)

#Sig indicator lines over any group to begin to indicate differences between methods 
annotation_df<-data.frame(
  xstart=c(0.6,1.6,2.6,3.6),
  xend=c(1.4,2.4,3.4,4.4),
  yvals= c(30,36,24,32),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over methods to begin to indicate differences between them 
annotation_df2<-data.frame(
  xstart=c(1),
  xend=c(2),
  yvals= c(37),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df3<-data.frame(
  xstart=c(1),
  xend=c(3),
  yvals= c(40.5),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df4<-data.frame(
  xstart=c(1),
  xend=c(4),
  yvals= c(44),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )
ggplot(data=dip.analysis3_long,aes(x=Method,y=mean)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.mean,aes(x=Method,y=mean,fill=Method,pattern=Method),width=.7,color=c("black",NA,NA,NA),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.mean,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=0.7,color="black")+geom_beeswarm(cex=1.5,size=1.75,alpha=0.4,aes(x = as.integer(Method) +.35,size=2),corral="wrap",corral.width = 0.4)+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.2)))+scale_y_continuous(expand = expansion(c(0,0.02)),limits=c(-7.7,45),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz3,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**470 nm Signal<br>During 405 Deflections** (%<span style='font-family: Symbol;'>D</span>_F/F_) ")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.5,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.136,0.018),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.065,0.322),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.065,0.233),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

#500 x 450 
ggsave(filename="CL8_DipAnalysis_BeeswarmSessions_mean_by_Method.tiff",plot=last_plot(), units="mm", width=500/.pt, height=450/.pt, dpi=900,path=output,device=grDevices::tiff)


ggplot(data=dip.analysis3_long,aes(x=Method,y=mean))+theme_classic()+geom_violin_pattern(data=dip.analysis3_long,aes(pattern=Method, fill=Method,color=Method),stat="ydensity",width=0.75,show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.mean,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_crossbar(data=ReplicateAverages.mean,aes(x=Method,y=mean,ymin=mean,ymax=mean),width=c(0.5,0.5,0.6,0.5),linewidth=0.2,color="black")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+scale_color_manual(values=c("black",NA,NA,NA)) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.02,0.02)),limits=c(-7.7,45),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=title.sz,color="black"),axis.text.x=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**470 nm Signal<br>During 405 Deflections** (%<span style='font-family: Symbol;'>D</span>_F/F_) ")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.08,0.018),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.065,0.08),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.065,0.08),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)
#400 x 450 
#output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/"
output<-"C:/Users/Christina/OneDrive/Desktop"

ggsave(filename="CL8_DipAnalysis_ViolinSessions_Mean_by_Method.tiff",plot=last_plot(), units="mm", width=400/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)




############
##Plot signal for all sessions for NNLS ONLY divided by sex 
ReplicateAverages <- dip.analysis3_long %>% group_by(Sex,Solution,Method,group_shrt) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.mean<-filter(ReplicateAverages,variable=="mean",preserve=TRUE)

ReplicateAverages.mean.nnls<-filter(ReplicateAverages.mean,Method=="NNLS",preserve=TRUE)

ggplot(data=subset(dip.analysis3_long,Method=="NNLS"),aes(x=group_shrt,y=mean)) +theme_classic()+geom_point(data=ReplicateAverages.mean.nnls,aes(x=group_shrt,y=mean,fill="black"),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages.mean.nnls,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.0,size=2,alpha=0.5,aes(size=2),corral="wrap")+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(-7.5,22))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title.y=element_markdown(size=title.sz),axis.title.x=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**GCaMP7f Signal<br> During 405 Dip** (z%<span style='font-family: Symbol;'>D</span>_F/F_)") +guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450
```
### 6) Lies, Damn Lies, & Statistics - Overall Signal

#### i) Set Contrasts & Standardize Vars
```{r}
filenormmod2<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Normalization Comparison - Dips and Overall Activity/CL8 Normalization Analysis Mixed Models Results (Effect Coded Method).xlsx"

############### CONTRAST ASSIGNMENT ########################
#Assigned contrasts use the factor levels previously made. 
#Check contrasts and change if desired:
#contrasts(bout.analysis2_true$Sex)
#contrasts(bout.analysis2_true$Solution)
#NOTE: CL made a Word document summarizing all the pre-made and custom contrasts and how to use them in R. 

##Declare this line of options to make comparable to SAS
#options(contrasts = c(faccontrtor = "contr.SAS", ordered = "contr.poly")) #Contrasts (decided to use centered contrasts after reading Yaremych et al 2023) *Time is set as a contrast after data is separated below.

### IMPORTANT ###
#Here you will set the contrast scheme to be used for factors of different levels. You can use different contrasts depending on your hypotheses, but most options produce the same comparisons for a two-level factor. Things only get weird when it is a 3+ level factor. And do yourself a MASSIVE favor and use the colnames arguments to relabel the contrasts so you can determine what contrast you used. H = Helmert; S = Sum, E = Effect, T= Treatment. 

signal.analysis2_long$Sex<-factor(signal.analysis2_long$Sex,levels=c("Female","Male"))
contrasts(signal.analysis2_long$Sex)<-contr.Helmert(levels(signal.analysis2_long$Sex))
colnames(contrasts(signal.analysis2_long$Sex))<-c("[H.Male-Female]")

signal.analysis2_long$Solution<-factor(signal.analysis2_long$Solution,levels=sol.levels.contr)
contrasts(signal.analysis2_long$Solution)<-contr.Helmert(levels(signal.analysis2_long$Solution))
colnames(contrasts(signal.analysis2_long$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-avg(S,W)]")

# Effects Contrast Code: 
#Creating the contrast matrix manually by modifying the dummy coding scheme
c<-contr.treatment(4)
my.coding<-matrix(rep(1/4, 12), ncol=3) # The first part of rep for matrix is 1/levels; Cols = 1-levels so the second part of rep for matrix is (1-levels * levels)
my.simple<-c-my.coding
colnames(my.simple)<-c("[E.Standard]","[E.Robust]","[E.Joint]")

contrasts(signal.analysis2_long$Method)<- my.simple

#Center the 470 and 405 signals around population mean

rawsig_means<- signal.analysis2_long %>% 
  group_by(Mouse,Method) %>%
  get_summary_stats(c('ChannelMean470','ChannelMean405'), type = "mean_sd")
rawsig_means<-rawsig_means %>%
  group_by(variable,Method) %>%
  mutate("gmc"=as.vector(scale(mean)))

# 470 Means Standardized and 

setDT(signal.analysis2_long)[,CAL_m:=rep(NA,length(row.names(signal.analysis2_long)))]  

for (i in 1:length(signal.analysis2_long$FileName)){ 
  signal.analysis2_long$CAL_m[[i]]<-rawsig_means$mean[[which(rawsig_means$Mouse==signal.analysis2_long$Mouse[[i]] & rawsig_means$variable=="ChannelMean470" & rawsig_means$Method==signal.analysis2_long$Method[[i]])]]
}

setDT(signal.analysis2_long)[,CAL_sd:=rep(NA,length(row.names(signal.analysis2_long)))]  

for (i in 1:length(signal.analysis2_long$FileName)){ 
  signal.analysis2_long$CAL_sd[[i]]<-rawsig_means$sd[[which(rawsig_means$Mouse==signal.analysis2_long$Mouse[[i]]& rawsig_means$variable=="ChannelMean470" & rawsig_means$Method==signal.analysis2_long$Method[[i]])]]
}

signal.analysis2_long<-signal.analysis2_long %>%
  mutate(CAL_imc=as.vector((signal.analysis2_long$ChannelMean470-signal.analysis2_long$CAL_m)/signal.analysis2_long$CAL_sd))

setDT(signal.analysis2_long)[,CAL_gmc:=rep(NA,length(row.names(signal.analysis2_long)))]  

for (i in 1:length(signal.analysis2_long$FileName)){ 
  signal.analysis2_long$CAL_gmc[[i]]<-rawsig_means$gmc[[which(rawsig_means$Mouse==signal.analysis2_long$Mouse[[i]]& rawsig_means$variable=="ChannelMean470" & rawsig_means$Method==signal.analysis2_long$Method[[i]])]]
}

## 405 Means Standardized & Centered

setDT(signal.analysis2_long)[,CTL_m:=rep(NA,length(row.names(signal.analysis2_long)))]  

for (i in 1:length(signal.analysis2_long$FileName)){ 
  signal.analysis2_long$CTL_m[[i]]<-rawsig_means$mean[[which(rawsig_means$Mouse==signal.analysis2_long$Mouse[[i]] & rawsig_means$variable=="ChannelMean405" & rawsig_means$Method==signal.analysis2_long$Method[[i]])]]
}

setDT(signal.analysis2_long)[,CTL_sd:=rep(NA,length(row.names(signal.analysis2_long)))]  

for (i in 1:length(signal.analysis2_long$FileName)){ 
  signal.analysis2_long$CTL_sd[[i]]<-rawsig_means$sd[[which(rawsig_means$Mouse==signal.analysis2_long$Mouse[[i]]& rawsig_means$variable=="ChannelMean405" & rawsig_means$Method==signal.analysis2_long$Method[[i]])]]
}

signal.analysis2_long<-signal.analysis2_long %>%
  mutate(CTL_imc=as.vector((signal.analysis2_long$ChannelMean405-signal.analysis2_long$CTL_m)/signal.analysis2_long$CTL_sd))

setDT(signal.analysis2_long)[,CTL_gmc:=rep(NA,length(row.names(signal.analysis2_long)))]  

for (i in 1:length(signal.analysis2_long$FileName)){ 
  signal.analysis2_long$CTL_gmc[[i]]<-rawsig_means$gmc[[which(rawsig_means$Mouse==signal.analysis2_long$Mouse[[i]]& rawsig_means$variable=="ChannelMean405" & rawsig_means$Method==signal.analysis2_long$Method[[i]])]]
}
```

#### ii) Unconditional Means Models (UCM)

```{r}
## Note here that the random structure may be slightly different between measures. So we need to check on a structure for each measure first! 


#Unconditional Means Models 

#MAD
model0.mad_fit<-lmerTest::lmer(formula= MAD ~ 1 + (1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.mad_fita <-lmerTest::lmer(formula= MAD ~ 1 + (1|Mouse:session),data=signal.analysis2_long, na.action=na.exclude);
model0.mad_fitb <-lmerTest::lmer(formula= MAD ~ 1 + (1|session),data=signal.analysis2_long, na.action=na.exclude);
model0.mad_fitc <-lmerTest::lmer(formula= MAD ~ 1 + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.mad_fitd <-lmerTest::lmer(formula= MAD ~ 1 + (1|Mouse:session) + (1|session),data=signal.analysis2_long, na.action=na.exclude);
model0.mad_fite <-lmerTest::lmer(formula= MAD ~ 1 + (1|session) + (1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.mad_fitf <-lmerTest::lmer(formula= MAD ~ 1 + (1|session) + (1|Mouse) + (1|Mouse:session),data=signal.analysis2_long, na.action=na.exclude);


#Peak Frequency
model0.peakf_fit<-lmerTest::lmer(formula= PeakFrequency ~ 1 + (1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.peakf_fita <-lmerTest::lmer(formula= PeakFrequency ~ 1 + (1|Mouse:session),data=signal.analysis2_long, na.action=na.exclude);
model0.peakf_fitb <-lmerTest::lmer(formula= PeakFrequency ~ 1 + (1|session),data=signal.analysis2_long, na.action=na.exclude);
model0.peakf_fitc <-lmerTest::lmer(formula= PeakFrequency ~ 1 + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.peakf_fitd <-lmerTest::lmer(formula= PeakFrequency ~ 1 + (1|Mouse:session) + (1|session),data=signal.analysis2_long, na.action=na.exclude);
model0.peakf_fite <-lmerTest::lmer(formula= PeakFrequency ~ 1 + (1|session) + (1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.peakf_fitf <-lmerTest::lmer(formula= PeakFrequency ~ 1 + (1|session) + (1|Mouse) + (1|Mouse:session),data=signal.analysis2_long, na.action=na.exclude);


#Mean Peak
model0.peakm_fit<-lmerTest::lmer(formula= MeanPeak ~ 1 + (1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.peakm_fita <-lmerTest::lmer(formula= MeanPeak ~ 1 + (1|Mouse:session),data=signal.analysis2_long, na.action=na.exclude);
model0.peakm_fitb <-lmerTest::lmer(formula= MeanPeak ~ 1 + (1|session),data=signal.analysis2_long, na.action=na.exclude);
model0.peakm_fitc <-lmerTest::lmer(formula= MeanPeak ~ 1 + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.peakm_fitd <-lmerTest::lmer(formula= MeanPeak ~ 1 + (1|Mouse:session) + (1|session),data=signal.analysis2_long, na.action=na.exclude);
model0.peakm_fite <-lmerTest::lmer(formula= MeanPeak ~ 1 + (1|session) + (1|Mouse),data=signal.analysis2_long, na.action=na.exclude);
model0.peakm_fitf <-lmerTest::lmer(formula= MeanPeak ~ 1 + (1|session) + (1|Mouse) + (1|Mouse:session),data=signal.analysis2_long, na.action=na.exclude);


models0<-ls(envir=.GlobalEnv,pattern="model0")  
models.call<-lapply(mget(models0),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models0){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info0c<-merge(models.call.df,model.obs.df)  

summary0c<-modelsummary::msummary(mget(models0),stars=T,output="data.frame")

LLR<-NULL 
LLR.df0c<-NULL 
for(k in models0){ 
  LLR<-data.frame("Model"=k,rand(get(k)))  
  LLR.df0c<-rbind(LLR.df0c,LLR) 
  }   

write.xlsx(model.info0c,file=filenormmod2, sheetName = "Method_Sig UCM Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary0c,file=filenormmod2, sheetName = "Method_Sig UCM", append=TRUE, row.names=FALSE)  
write.xlsx(LLR.df0c,file=filenormmod2,sheetName = "Method_Sig UCM LLR",append=TRUE)

```

#### ii) Lvl1 Models

```{r}
model1.mad_fitc <-lmerTest::lmer(formula= MAD ~ Method + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);

model1.peakf_fitc <-lmerTest::lmer(formula= PeakFrequency ~ Method + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);

model1.peakm_fitc <-lmerTest::lmer(formula= MeanPeak ~ Method + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);

```

#### iii) Gather Model Summaries (for Export)

```{r}

models1<-ls(envir=.GlobalEnv,pattern="model1")  
models.call<-lapply(mget(models1),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models1){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info1<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary1<-modelsummary::msummary(mget(models1),stars=T,output="data.frame",coef_rename = term.streamline)
```


#### ii) Lvl2 Models

```{r}
model2.mad_fitc <-lmerTest::lmer(formula= MAD ~ Method*Solution + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


model2.peakf_fitc <-lmerTest::lmer(formula= PeakFrequency ~ Method*Solution + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


model2.peakm_fitc <-lmerTest::lmer(formula= MeanPeak ~ Method*Solution + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


```

#### ii) Lvl2.5 Models

```{r}
model2.5.mad_fitc <-lmerTest::lmer(formula= MAD ~ Method*Sex + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


model2.5.peakf_fitc <-lmerTest::lmer(formula= PeakFrequency ~ Method*Sex + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


model2.5.peakm_fitc <-lmerTest::lmer(formula= MeanPeak ~ Method*Sex + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


```
#### iii) Gather Model Summaries (for Export)

```{r}

models2<-ls(envir=.GlobalEnv,pattern="model2")  
models.call<-lapply(mget(models2),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models2){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info2<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary2<-modelsummary::msummary(mget(models2),stars=T,output="data.frame",coef_rename = term.streamline)
```

#### ii) Lvl3 Models

```{r}
model3.mad_fitc <-lmerTest::lmer(formula= MAD ~ Method*Solution*Sex + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


model3.peakf_fitc <-lmerTest::lmer(formula= PeakFrequency ~ Method*Solution*Sex + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


model3.peakm_fitc <-lmerTest::lmer(formula= MeanPeak ~ Method*Solution*Sex + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


```


#### iii) Gather Model Summaries (for Export)

```{r}

models3<-ls(envir=.GlobalEnv,pattern="model3")  
models.call<-lapply(mget(models3),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models3){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info3<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary3<-modelsummary::msummary(mget(models3),stars=T,output="data.frame",coef_rename = term.streamline)
```

#### ii) Lvl4 Models

```{r}
model4.mad_fitc <-lmerTest::lmer(formula= MAD ~ Method*CAL_imc*CAL_gmc + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


model4.peakf_fitc <-lmerTest::lmer(formula= PeakFrequency ~ Method*CAL_imc*CAL_gmc + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);


model4.peakm_fitc <-lmerTest::lmer(formula= MeanPeak ~ Method*CAL_imc*CAL_gmc + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);

```

#### iii) Gather Model Summaries (for Export)

```{r}

models4<-ls(envir=.GlobalEnv,pattern="model4")  
models.call<-lapply(mget(models4),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models4){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info4<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary4<-modelsummary::msummary(mget(models4),stars=T,output="data.frame",coef_rename = term.streamline)
```

#### ii) Lvl5 Models

```{r}
model5.mad_fitc <-lmerTest::lmer(formula= MAD ~ Method*Solution*CAL_imc*CAL_gmc + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);

model5.peakf_fitc <-lmerTest::lmer(formula= PeakFrequency ~ Method*Solution*CAL_imc*CAL_gmc + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);

model5.peakm_fitc <-lmerTest::lmer(formula= MeanPeak ~ Method*Solution*CAL_imc*CAL_gmc + (1|Mouse:session)+(1|Mouse),data=signal.analysis2_long, na.action=na.exclude);

```

#### iii) Gather Model Summaries (for Export)

```{r}

models5<-ls(envir=.GlobalEnv,pattern="model5")  
models.call<-lapply(mget(models5),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models5){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info5<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary5<-modelsummary::msummary(mget(models5),stars=T,output="data.frame",coef_rename = term.streamline)
```
#### iv) (Optional) Plot Effects and Interactions

```{r}
moi<-model2.mad_fitc
moi.name<-"model2.mad_fitc (Normalization Analysis; 2-hr Signal MAD)"

moi<-model2.peakm_fitc
moi.name<-"model2.peakm_fitc (Normalization Analysis; 2-hr Signal Mean Peak Amplitude)"

moi<-model1.peakf_fitc
moi.name<-"model1.peakf_fitc (Normalization Analysis; 2-hr Signal Mean Peak Frequency)"

models.call<-lapply(mget(moi),get_call)  

# Effects Table
sjPlot::tab_model(moi,show.ci=0.95,show.df=TRUE,show.r2=TRUE,show.icc=TRUE, show.p=TRUE,show.stat=TRUE,show.aic=TRUE,show.re.var= TRUE, title= moi.name,digits=3,digits.p=4, df.method = "satterthwaite",col.order = c("est", "se", "std.est", "std.se", "ci", "std.ci", "ci.inner", "ci.outer","df.error", "stat", "std.stat", "p", "std.p", "response.level"))

# Effects Plot
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name)) 
#1000 x 600 


##Plot it!
table<-emmip(model3.mad_fitc,"Solution"~"Method", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE)

table$Solution<-factor(table$Solution,levels=c("EtOH","Water","Sucrose"))

table$xvar<-factor(table$xvar, levels=c("None","Standard","NNLS","Joint"))

table$CAL_imc<-factor(table$CAL_imc, levels=c(-1.5,0,1.5),labels=c("Low CA <br>Session","Average CA<br>Session","High CA<br>Session"))

ggplot(data=table,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.35))+geom_point(position=position_dodge(0.35))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.35))+theme_classic()+scale_color_manual(values = custom)+facet_wrap(.~CAL_imc)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.01,0.07)),breaks=c(-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4))+labs(x=NULL,y="**MAD** (z%dF/F)<br>Estimated Means")+theme(strip.text.x=element_markdown(size=txt.sz2),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.75,0.95),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#500 x 450
```

#### v) Model Comparisons
```{r}
#To compare two models - we need to refit all models using REML=F.  
#Note that these comparisons are ONLY valid if both models have the same # of observations! 

#Easiest just to let it do that automatically when you try to run the code

model.0mad_anova<-anova(model1.mad_fitc,model0.mad_fitc)  
model.0peakf_anova<-anova(model1.peakf_fitc,model0.peakf_fitc)
model.0peakm_anova<-anova(model1.peakm_fitc,model0.peakm_fitc)  

LLR1<-rbind(model.0mad_anova,model.0peakf_anova,model.0peakm_anova)

write.xlsx(LLR1,file=filenormmod2,sheetName = "Method Sig Lvl1-Lvl0 LLR",append=TRUE)



##Level 2
model.1mad_anova<-anova(model2.mad_fitc,model1.mad_fitc)  
model.1peakf_anova<-anova(model2.peakf_fitc,model1.peakf_fitc)
model.1peakm_anova<-anova(model2.peakm_fitc,model1.peakm_fitc)  

LLR2<-rbind(model.1mad_anova,model.1peakf_anova,model.1peakm_anova)

write.xlsx(LLR2,file=filenormmod2,sheetName = "Method Sig Lvl2-Lvl1 LLR",append=TRUE)

##Level 2.5
model.1mad_anova<-anova(model2.5.mad_fitc,model1.mad_fitc)  
model.1peakf_anova<-anova(model2.5.peakf_fitc,model1.peakf_fitc)
model.1peakm_anova<-anova(model2.5.peakm_fitc,model1.peakm_fitc)  

LLR2.5<-rbind(model.1mad_anova,model.1peakf_anova,model.1peakm_anova)

write.xlsx(LLR2.5,file=filenormmod2,sheetName = "Method Sig Lvl2.5-Lvl1 LLR",append=TRUE)

##Level 3
model.2mad_anova<-anova(model3.mad_fitc,model2.mad_fitc)  
model.2peakf_anova<-anova(model3.peakf_fitc,model2.peakf_fitc)
model.2peakm_anova<-anova(model3.peakm_fitc,model2.peakm_fitc)  

LLR3<-rbind(model.2mad_anova,model.2peakf_anova,model.2peakm_anova)

write.xlsx(LLR3,file=filenormmod2,sheetName = "Method Sig Lvl3-Lvl2 LLR",append=TRUE)

##Level 3
model.3mad_anova<-anova(model3.mad_fitc,model1.mad_fitc)  
model.3peakf_anova<-anova(model3.peakf_fitc,model1.peakf_fitc)
model.3peakm_anova<-anova(model3.peakm_fitc,model1.peakm_fitc)  

LLR4<-rbind(model.3mad_anova,model.3peakf_anova,model.3peakm_anova)

write.xlsx(LLR4,file=filenormmod2,sheetName = "Method Sig Lvl3-Lvl1 LLR",append=TRUE)

```

#### vi) PostHoc Comparisons

```{r}
tukey2.mad<-emmeans(model2.mad_fitc, list(pairwise ~ Method), adjust = "tukey",lmer.df="satterthwaite")

CI.mad<-confint(tukey2.mad,level=0.95)

tukey2.mad2<-emmeans(model2.mad_fitc, list(pairwise ~ Solution), adjust = "tukey",lmer.df="satterthwaite")

CI.mad2<-confint(tukey2.mad2,level=0.95)


tukey2.peakf<-emmeans(model1.peakf_fitc, list(pairwise ~ Method), adjust = "tukey",lmer.df="satterthwaite")

CI.peakf<-confint(tukey2.peakf,level=0.95)



tukey2.peakm<-emmeans(model2.peakm_fitc, list(pairwise ~ Method), adjust = "tukey",lmer.df="satterthwaite")

CI.peakm<-confint(tukey2.peakm,level=0.95)

tukey2.peakm2<-emmeans(model2.peakm_fitc, list(pairwise ~ Solution), adjust = "tukey",lmer.df="satterthwaite")

CI.peakm2<-confint(tukey2.peakm2,level=0.95)


remove(tukey)
remove(CI)
tukey<-ls(envir=.GlobalEnv,pattern="tukey") 
CI<-ls(envir=.GlobalEnv,pattern="CI")
tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)

}


for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}
```

#### viii) Export Model Summaries and PostHoc Comparisons

```{r}
write.xlsx(model.info1,file=filenormmod2, sheetName = "Method Sig Lvl1 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary1,file=filenormmod2, sheetName = "Method Sig Lvl1", append=TRUE, row.names=FALSE)
write.xlsx(model.info2,file=filenormmod2, sheetName = "Method Sig Lvl2 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary2,file=filenormmod2, sheetName = "Method Sig Lvl2", append=TRUE, row.names=FALSE)
#write.xlsx(model.info2,file=filenormmod2, sheetName = "Method Sig Lvl2.5 Info", append=TRUE, row.names=FALSE)  
#write.xlsx(summary2,file=filenormmod2, sheetName = "Method Sig Lvl2.5", append=TRUE, row.names=FALSE)
write.xlsx(model.info3,file=filenormmod2, sheetName = "Method Sig Lvl3 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary3,file=filenormmod2, sheetName = "Method Sig Lvl3", append=TRUE, row.names=FALSE)
write.xlsx(model.info4,file=filenormmod2, sheetName = "Method Sig Lvl4 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary4,file=filenormmod2, sheetName = "Method Sig Lvl4", append=TRUE, row.names=FALSE)  
write.xlsx(model.info5,file=filenormmod2, sheetName = "Method Sig Lvl5 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary5,file=filenormmod2, sheetName = "Method Sig Lvl5", append=TRUE, row.names=FALSE)  

write.xlsx(tuk.summary1,file=filenormmod2,sheetName = "Method Sig Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filenormmod2,sheetName = "Method Sig Tukey_Pairs",append=TRUE)
write.xlsx(tuk.summary3,file=filenormmod2,sheetName = "Method Sig Tukey_CI",append=TRUE)
```
### 7) Lies, Damn Lies, & Statistics - Dip Signal

#### i) Set Contrasts
```{r}
filenormmod2<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Normalization Comparison - Dips and Overall Activity/CL8 Normalization Analysis Mixed Models Results (Effect Coded Method).xlsx"

############### CONTRAST ASSIGNMENT ########################
#Assigned contrasts use the factor levels previously made. 
#Check contrasts and change if desired:
#contrasts(bout.analysis2_true$Sex)
#contrasts(bout.analysis2_true$Solution)
#NOTE: CL made a Word document summarizing all the pre-made and custom contrasts and how to use them in R. 

##Declare this line of options to make comparable to SAS
#options(contrasts = c(faccontrtor = "contr.SAS", ordered = "contr.poly")) #Contrasts (decided to use centered contrasts after reading Yaremych et al 2023) *Time is set as a contrast after data is separated below. And do yourself a MASSIVE favor and use the colnames arguments to relabel the contrasts so you can determine what contrast you used. H = Helmert; S = Sum, E = Effect, T= Treatment. 

### IMPORTANT ###
#Here you will set the contrast scheme to be used for factors of different levels. You can use different contrasts depending on your hypotheses, but most options produce the same comparisons for a two-level factor. Things only get weird when it is a 3+ level factor.

dip.analysis3_long$Sex<-factor(dip.analysis3_long$Sex,levels=c("Female","Male"))
contrasts(dip.analysis3_long$Sex)<-contr.Helmert(levels(dip.analysis3_long$Sex))
colnames(contrasts(dip.analysis3_long$Sex))<-c("[H.Male-Female]")

dip.analysis3_long$Solution<-factor(dip.analysis3_long$Solution,levels=sol.levels.contr)
contrasts(dip.analysis3_long$Solution)<-contr.Helmert(levels(dip.analysis3_long$Solution))
colnames(contrasts(dip.analysis3_long$Solution))<-c("[H.Sucrose-Water]","[H.EtOH-Avg(S,W)]")


# Effects Contrast Code: 
#creating the contrast matrix manually by modifying the dummy coding scheme
c<-contr.treatment(4)
my.coding<-matrix(rep(1/4, 12), ncol=3) # The first part of rep for matrix is 1/levels; Cols = 1-levels so the second part of rep for matrix is (1-levels * levels)
my.simple<-c-my.coding
colnames(my.simple)<-c("[E.Standard]","[E.Robust]","[E.Joint]")

contrasts(dip.analysis3_long$Method)<- my.simple

```

#### ii) Unconditional Means Models (UCM)

```{r}
## Note here that the random structure may be slightly different between measures. So we need to check on a structure for each measure first! 


#Unconditional Means Models 

#mean
model0.mean_fit<-lmerTest::lmer(formula= mean ~ 1 + (1|Mouse),data=dip.analysis3_long, na.action=na.exclude);
model0.mean_fita <-lmerTest::lmer(formula= mean ~ 1 + (1|Mouse:session),data=dip.analysis3_long, na.action=na.exclude);
model0.mean_fitb <-lmerTest::lmer(formula= mean ~ 1 + (1|session),data=dip.analysis3_long, na.action=na.exclude);
model0.mean_fitc <-lmerTest::lmer(formula= mean ~ 1 + (1|Mouse:session)+(1|Mouse),data=dip.analysis3_long, na.action=na.exclude);
model0.mean_fitd <-lmerTest::lmer(formula= mean ~ 1 + (1|Mouse:session) + (1|session),data=dip.analysis3_long, na.action=na.exclude);
model0.mean_fite <-lmerTest::lmer(formula= mean ~ 1 + (1|session) + (1|Mouse),data=dip.analysis3_long, na.action=na.exclude);
model0.mean_fitf <-lmerTest::lmer(formula= mean ~ 1 + (1|session) + (1|Mouse) + (1|Mouse:session),data=dip.analysis3_long, na.action=na.exclude);



models0<-ls(envir=.GlobalEnv,pattern="model0")  
models.call<-lapply(mget(models0),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models0){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info0c<-merge(models.call.df,model.obs.df)  

summary0c<-modelsummary::msummary(mget(models0),stars=T,output="data.frame")

LLR<-NULL 
LLR.df0c<-NULL 
for(k in models0){ 
  LLR<-data.frame("Model"=k,rand(get(k)))  
  LLR.df0c<-rbind(LLR.df0c,LLR) 
  }   

write.xlsx(model.info0c,file=filenormmod2, sheetName = "Method Dip UCM Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary0c,file=filenormmod2, sheetName = "Method Dip UCM", append=TRUE, row.names=FALSE)  
write.xlsx(LLR.df0c,file=filenormmod2,sheetName = "Method Dip UCM LLR",append=TRUE)

```

#### iii) Lvl1 Models

```{r}
model1.mean_fit<-lmerTest::lmer(formula= mean ~ Method + (1|Mouse),data=dip.analysis3_long, na.action=na.exclude);

```
#### iv) Gather Model Summaries (for Export)

```{r}

models1<-ls(envir=.GlobalEnv,pattern="model1")  
models.call<-lapply(mget(models1),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models1){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info1<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary1<-modelsummary::msummary(mget(models1),stars=T,output="data.frame",coef_rename = term.streamline)
```

#### v) Lvl2 Models

```{r}
model2.mean_fit<-lmerTest::lmer(formula= mean ~ Method*Sex + (1|Mouse),data=dip.analysis3_long, na.action=na.exclude);

```
#### vi) Gather Model Summaries (for Export)

```{r}

models2<-ls(envir=.GlobalEnv,pattern="model2")  
models.call<-lapply(mget(models2),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models2){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info2<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary2<-modelsummary::msummary(mget(models2),stars=T,output="data.frame",coef_rename = term.streamline)
```

#### vii) Lvl2.5 Models

```{r}
model2.5.mean_fit<-lmerTest::lmer(formula= mean ~ Method*Solution + (1|Mouse),data=dip.analysis3_long, na.action=na.exclude);


```
#### viii) Gather Model Summaries (for Export)

```{r}

models2<-ls(envir=.GlobalEnv,pattern="model2")  
models.call<-lapply(mget(models2),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models2){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info2<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary2<-modelsummary::msummary(mget(models2),stars=T,output="data.frame",coef_rename = term.streamline)
```

#### ix) Lvl3 Models

```{r}
model3.mean_fit<-lmerTest::lmer(formula= mean ~ Method*Sex*Solution + (1|Mouse),data=dip.analysis3_long, na.action=na.exclude);

```


#### x) Gather Model Summaries (for Export)

```{r}

models3<-ls(envir=.GlobalEnv,pattern="model3")  
models.call<-lapply(mget(models3),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models3){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info3<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary3<-modelsummary::msummary(mget(models3),stars=T,output="data.frame",coef_rename = term.streamline)
```
#### xi) (Optional) Plot Effects and Interactions

```{r}

moi<-model3.mean_fit
moi.name<-"model3.mean_fit (Normalization Analysis; 470 Signal During Dips)"

# Effects Table
sjPlot::tab_model(moi,show.ci=0.95,show.df=TRUE,show.r2=TRUE,show.icc=TRUE, show.p=TRUE,show.stat=TRUE,show.aic=TRUE,show.re.var= TRUE, title= moi.name,digits=3,digits.p=4, df.method = "satterthwaite",col.order = c("est", "se", "std.est", "std.se", "ci", "std.ci", "ci.inner", "ci.outer","df.error", "stat", "std.stat", "p", "std.p", "response.level"))

# Effects Plot
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name)) 
#1000 x 600 

##Plot it!
table<-emmip(model3.mad_fitc,"Solution"~"Method", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE)

table$Solution<-factor(table$Solution,levels=c("EtOH","Water","Sucrose"))

table$xvar<-factor(table$xvar, levels=c("None","Standard","NNLS","Joint"))

table$CAL_imc<-factor(table$CAL_imc, levels=c(-1.5,0,1.5),labels=c("Low CA <br>Session","Average CA<br>Session","High CA<br>Session"))

ggplot(data=table,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.35))+geom_point(position=position_dodge(0.35))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.35))+theme_classic()+scale_color_manual(values = custom)+facet_wrap(.~CAL_imc)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.01,0.07)),breaks=c(-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4))+labs(x=NULL,y="**MAD** (z%dF/F)<br>Estimated Means")+theme(strip.text.x=element_markdown(size=txt.sz2),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.75,0.95),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y = element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#500 x 450
```


#### v) Model Comparisons
```{r}
#To compare two models - we need to refit all models using REML=F.  
#Note that these comparisons are ONLY valid if both models have the same # of observations! 

#Easiest just to let it do that automatically when you try to run the code

model.0mean_anova<-anova(model1.mean_fit,model0.mean_fit)  


LLR1<-rbind(model.0mean_anova)

write.xlsx(LLR1,file=filenormmod2,sheetName = "Method Dip Lvl1-Lvl0 LLR",append=TRUE)



##Level 2
model.1mean_anova<-anova(model2.mean_fit,model1.mean_fit)  

LLR2<-rbind(model.1mean_anova)

write.xlsx(LLR2,file=filenormmod2,sheetName = "Method Dip Lvl2-Lvl1 LLR",append=TRUE)

##Level 2.5
model.1mean_anova<-anova(model2.5.mean_fit,model1.mean_fit)  

LLR2.5<-rbind(model.1mean_anova)

write.xlsx(LLR2.5,file=filenormmod2,sheetName = "Method Dip Lvl2.5-Lvl1 LLR",append=TRUE)

##Level 3
model.2mean_anova<-anova(model3.mean_fit,model2.mean_fit)  


LLR3<-rbind(model.2mean_anova)

write.xlsx(LLR3,file=filenormmod2,sheetName = "Method Dip Lvl3-Lvl2 LLR",append=TRUE)
```

#### vi) PostHoc Comparisons

```{r}
tukey3.mean<-emmeans(model3.mean_fit, list(pairwise ~ Method*Sex*Solution), adjust = "tukey",lmer.df="satterthwaite")

CI.mean<-confint(tukey3.mean,level=0.95)

tukey3a.mean<-emmeans(model3.mean_fit, list(pairwise ~ Method), adjust = "tukey",lmer.df="satterthwaite")

CIa.mean<-confint(tukey3a.mean,level=0.95)


remove(tukey)
remove(CI)
tukey<-ls(envir=.GlobalEnv,pattern="tukey") 
CI<-ls(envir=.GlobalEnv,pattern="CI")
tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)

}


for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}
```

#### viii) Export Model Summaries and PostHoc Comparisons

```{r}
write.xlsx(model.info1,file=filenormmod2, sheetName = "Method Dip Lvl1 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary1,file=filenormmod2, sheetName = "Method Dip Lvl1", append=TRUE, row.names=FALSE)


write.xlsx(model.info2,file=filenormmod2, sheetName = "Method Dip Lvl2 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary2,file=filenormmod2, sheetName = "Method Dip Lvl2", append=TRUE, row.names=FALSE)


write.xlsx(model.info2,file=filenormmod2, sheetName = "Method Dip Lvl2.5 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary2,file=filenormmod2, sheetName = "Method Dip Lvl2.5", append=TRUE, row.names=FALSE)

write.xlsx(model.info3,file=filenormmod2, sheetName = "Method Dip Lvl3 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary3,file=filenormmod2, sheetName = "Method Dip Lvl3", append=TRUE, row.names=FALSE)


write.xlsx(tuk.summary1,file=filenormmod2,sheetName = "Method Dip Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filenormmod2,sheetName = "Method Dip Tukey_Pairs",append=TRUE)
write.xlsx(tuk.summary3,file=filenormmod2,sheetName = "Method Dip Tukey_CI",append=TRUE)
```



## SIGNAL CORRELATION ANALYSIS
Based on: https://rpubs.com/cokyfauzialfi/correlation_meta-analysis 

### 1) Read in Data

```{r}
filecorr<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Correlation_Results/Compiled_Correlations_Master.xlsx"

output<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/Normalization Comparison - Correlations"


signal.analysis<-read.xlsx(filecorr,sheetIndex=3,header=TRUE) # This is correlation data from each session

# Delete mean and stdev rows so they aren't used in calculations
signal.analysis2<-signal.analysis[-(137:138),]
```

### 2) Set Graph Color Palette and Text Size
```{r}
c1<-"#D41159" #This is rgb(212,17,89, maxColorValue=255) or red for EtOH
c2<-"#1A85FF" #This is rgb(26,133,255, maxColorValue=255) or blue for Water
c3<-"#5225A0" #This is rgb(82,37,160, maxColorValue=255) or purple for Sucrose

custom<-c(c1,c2,c3) #Define custom color palette

c4<-"white" #For None
c5<-"lightgrey" #For Standard
c6<-"darkgrey" #For NNLS
c7<-"#B4F8DF" #This is rgb(180,248,223,maxColorValue=255)or sea green for Joint

custom2<-c(c4,c5,c6,c7)

patterns24<-c("stripe","stripe","stripe","stripe",rep.int("none",20))
patterns12<-c("stripe","stripe","stripe",rep.int("none",9))
patterns4<-c("stripe","none","none","none")

rainbow<-viridis_pal(option = "A")(66)
rainbow_random<-sample(rainbow)

#Set specifc relationships between titles, axis text, and other text categories so allow consistency between figures of the same size.

title.sz<-6.5*.pt
txt.sz1<-5*.pt
txt.sz2<-5.5*.pt
txt.sz3<-6*.pt
otr.sz<-2.5*.pt
otr.sz1<-3.5*.pt
otr.sz2<-4.5*.pt
```

###3) Graph Data - Signal Correlations
```{r}
##Plot signal for all sessions for raw signal divided only by sex 
group.corr<-names(signal.analysis2)[4:69]

ReplicateAverages <- signal.analysis2[4:69] %>% get_summary_stats(type = "mean_se");

+geom_col(data=ReplicateAverages,aes(x=variable,y=mean),show.legend = FALSE)+geom_errorbar(data=ReplicateAverages,aes(x=variable,y=se,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")

signal.analysis2_long<-pivot_longer(signal.analysis2, cols = all_of(group.corr),
             names_to = "Type", values_to = "Correlation")

signal.analysis2_long$Type <-factor(signal.analysis2_long$Type)

#Group Correlations by Type
ggplot(data=signal.analysis2_long,aes(x=Type,y=Correlation,color=Type)) +theme_classic()+geom_beeswarm(cex=0.75,size=1,alpha=0.8,aes(size=1),corral="wrap")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.0))+scale_color_manual(values=rainbow_random)+scale_y_continuous(expand = expansion(0),limits=c(-1,1),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.position="none",legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz,color="black",angle=90,vjust=0.75),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="Correlation")+guides(color=guide_legend(override.aes = list(size=4)))


```

```{r}
# Input data - All versions of signal vs all versions of signal
subject <- signal.analysis2$Subject
#corr <- signal.analysis2$F405_dt405
#corr <- signal.analysis2$F405_sn405
#corr<- signal.analysis2$F405_Robust405
#corr<- signal.analysis2$F405_JCBM405
#corr<- signal.analysis2$F405_F470
#corr <- signal.analysis2$F405_dt470
#corr <- signal.analysis2$F405_sn470
#corr <- signal.analysis2$F405_std470
#corr <- signal.analysis2$F405_Robust470
#corr <- signal.analysis2$F405_JCBM470
#corr <- signal.analysis2$dt405_sn405
#corr <- signal.analysis2$dt405_Robust405
#corr <- signal.analysis2$dt405_JCBM405
#corr <- signal.analysis2$dt405_F470
#corr <- signal.analysis2$dt405_dt470
#corr <- signal.analysis2$dt405_sn470
#corr <- signal.analysis2$dt405_std470
#corr <- signal.analysis2$dt405_Robust470
#corr <- signal.analysis2$dt405_JCBM470
#corr <- signal.analysis2$sn405_Robust405
#corr <- signal.analysis2$sn405_JCBM405
#corr <- signal.analysis2$sn405_F470
#corr <- signal.analysis2$sn405_dt470
#corr <- signal.analysis2$sn405_sn470
#corr <- signal.analysis2$sn405_std470
#corr <- signal.analysis2$sn405_Robust470
#corr <- signal.analysis2$sn405_JCBM470
#corr <- signal.analysis2$Robust405_JCBM405
#corr <- signal.analysis2$Robust405_F470
#corr <- signal.analysis2$Robust405_dt470
#corr <- signal.analysis2$Robust405_sn470
#corr <- signal.analysis2$Robust405_std470
#corr <- signal.analysis2$Robust405_Robust470
#corr <- signal.analysis2$Robust405_JCBM470
#corr <- signal.analysis2$JCBM405_F470
#corr <- signal.analysis2$JCBM405_dt470
#corr <- signal.analysis2$JCBM405_sn470
#corr <- signal.analysis2$JCBM405_std470
#corr <- signal.analysis2$JCBM405_Robust470
#corr <- signal.analysis2$JCBM405_JCBM470
#corr <- signal.analysis2$F470_dt470
#corr <- signal.analysis2$F470_sn470
#corr <- signal.analysis2$F470_std470
#corr <- signal.analysis2$F470_Robust470
#corr <- signal.analysis2$F470_JCBM470
#corr <- signal.analysis2$dt470_sn470
#corr <- signal.analysis2$dt470_std470
#corr <- signal.analysis2$dt470_Robust470
#corr <- signal.analysis2$dt470_JCBM470
#corr <- signal.analysis2$sn470_std470
#corr <- signal.analysis2$sn470_Robust470
#corr <- signal.analysis2$sn470_JCBM470
#corr <- signal.analysis2$std470_Robust470
#corr <- signal.analysis2$std470_JCBM470
corr <- signal.analysis2$Robust470_JCBM470



n <- signal.analysis2$N

# Convert correlations to Fisher's z for meta-analysis (better normality)
meta_data <- data.frame(subject, corr, n)
meta_data$z <- 0.5 * log((1 + meta_data$corr) / (1 - meta_data$corr)) # Fisher's z
meta_data$se_z <- 1 / sqrt(meta_data$n - 3) # Standard error of Fisher's z


## Use when there are issues of transformation yielding -Inf or +Inf
meta_data$z[which(meta_data$z==Inf)]<-0.9999
meta_data$z[which(meta_data$z==-Inf)]<--0.9999

# Perform random-effects meta-analysis (on Fisher's z scale)
meta_result <- metagen(
  TE = z,
  seTE = se_z,
  data = meta_data,
  sm = "ZCOR", # Fisher's z transformed correlations
  comb.fixed = FALSE, # Force random-effects model
  comb.random = TRUE,
  method.tau = "REML", # Restricted maximum-likelihood estimator
  cluster = subject,
  backtransf = TRUE
)

summary(meta_result)

png(file = "forestplot.png", width = 2800, height = 9000, res = 300)

forest(meta_result, 
       layout = "JAMA",xlim=c(-1,1))
dev.off()
```

