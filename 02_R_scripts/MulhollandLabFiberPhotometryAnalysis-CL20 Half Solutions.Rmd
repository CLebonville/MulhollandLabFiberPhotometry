---
title: "Mulholland Lab Fiber Photometry Analysis R Notebook" 
output:                                                      
pdf_document: default                                      
html_notebook: default                                     
editor_options:                                            
markdown:                                                  
wrap: 72                                                   
---

# PURPOSE & BACKGROUND

This document details how to read in, analyze, and produce graphs with the data that is output from Mulholland Lab's MATLAB Fiber Photometry loop function AFTER compilation.

To run the code, **enable Visual mode and the Outline view** by clicking the buttons on the window of this document. Then simply navigate to the block of code and press the play button (green triangle). If the code errors, it will show you were the error occurred, making it easy to adapt the code as processes change.

To begin, you will need to install, R, RStudio, and Rtools as detailed in the protocol to do so on the Mulholland server in the "Computation Behavior" folder. To make things smoother, use the versions listed below.

BASE CODE'S AUTHOR: Christina L. Lebonville, PhD, 2022-2024 (Yes it is ok to bug me about this code)

QUICK START: This code is written in the order it should be run to create the necessary variables & data. To run the shortcut version, after you have **session.analysis3**, only run the steps with the asterisks to speed through to the stats and figures.

# SYSTEM ENVIRONMENT

Installation of R, RStudio, and Rtools can be found on the Mulholland Lab server:

"Z:\\01. PROTOCOLS\\Computation Behavior\\R & RStudio Installation\\R & RStudio - Installation Guide.docx"

To run this code, ideally, you are using the same system environment (versions of R, RStudio, and Rtools) I've tested it out on (see below). You can download and install any version of R or Rtools from here: <https://cran.r-project.org/bin/windows/>. If you are not using my tested environment, you need to first make sure that your R version and RTools version are compatible. Here is a trick, R 4.2 uses Rtools 42. R 4.0 and 4.1 use Rtools 40. Despite having installed the right ones, you could have multiple versions so that the wrong one is being used.

## Check Version/Compatibility of R, RStudio, & RTools

```{r}
#Install package DevTools if not already installed
install.packages("devtools");
```

```{r}
#Load packages from devtools that will help
library("pkgbuild");
library("rstudioapi");

getRversion(); #Gets R version
info<-versionInfo(); #Gets RStudio version (second line prints it)
cat("RStudio Version:",info$long_version,info$release_name)
find_rtools(); #Says True/False whether RTools is installed
rtools_path(); #Gives path of RTools RStudio is talking to

#Check package versions and install specific versions if necessary to match another environment
sessionInfo()

#Find the package url in the archive on CRAN to install specific version
install.packages("https://cran.r-project.org/src/contrib/Archive/insight/insight_0.19.8.tar.gz", repos=NULL, type = "source")

install.packages("https://cran.r-project.org/src/contrib/Archive/sjPlot/sjPlot_2.8.15.tar.gz", repos=NULL, type = "source")

install.packages("https://cran.r-project.org/src/contrib/Archive/knitr/knitr_1.44.tar.gz", repos=NULL, type = "source")

install.packages("https://cran.r-project.org/src/contrib/Archive/modelsummary/modelsummary_1.4.2.tar.gz", repos=NULL, type = "source")

install.packages("https://cran.r-project.org/src/contrib/Archive/dplyr/dplyr_1.1.3.tar.gz, repos=NULL", type = "source")
```

You can download and install R from <https://cran.r-project.org/bin/windows/>. Once you have double-checked that your R and Rtools will play nice together (which they will if you use my exact tested environment), the packages required by the code will install properly and be functional.

## Current Tested Environment

R 4.3.1 (2023-06-16 ucrt) --- "Beagle Scouts", Platform: x86_64-w64-mingw32/x64 (64-bit)\
RStudio Version: 2023.06.2+561 Mountain Hydrangea 
Rtools43

#### Old Environments

R 4.2.3 (2023-03-15 ucrt) -- "Shortstop Beagle" Platform: x86_64-w64-mingw32/x64 (64-bit) RStudio 2023.03.0+386b "Cherry Blossom" Release (3c53477afb13ab959aeb5b34df1f10c237b256c3,2023-03-09) for Windows RTools 4.2.

R (v.4.2.2., 2022-10-31 ucrt-- "Innocent and Trusting") USING RStudio 2022.07.2+576 "Spotted Wakerobin" Release (e7373ef832b49b2a9b88162cfe7eac5f22c40b34, 2022-09-06) for Windows

# CITATIONS

R Core Team (2021). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL <https://www.R-project.org/>.\
Alboukadel Kassambara (2021). rstatix: Pipe-Friendly Framework for Basic Statistical Tests. R package version 0.7.0. <https://CRAN.R-project.org/package=rstatix>\
Alboukadel Kassambara. Comparing Multiple Means in R: Mixed ANOVA in R. Publisher: DataNovia. Access Year: 2022. <https://www.datanovia.com/en/lessons/mixed-anova-in-r/> Sochacki, Jakub (2022). 3-way ANOVA. Publisher: RPubs by RStudio. <https://rpubs.com/JS24/853604>

GENERAL PROJECT APPROACH/MANAGEMENT: <https://rfortherestofus.com/2021/02/how-to-use-git-github-with-r/>\
<https://happygitwithr.com/install-git.html> <https://goodresearch.dev/>

FOR LITERALLY EVERYTHING GRAPH RELATED\
<https://ggplot2-book.org/>\
<http://zevross.com/blog/2019/04/02/easy-multi-panel-plots-in-r-using-facet_wrap-and-facet_grid-from-ggplot2/>

For mixed/multilevel modeling <https://quantdev.ssri.psu.edu/tutorials/r-bootcamp-introduction-multilevel-model-and-interactions> <https://rpubs.com/rslbliss/r_mlm_ws> <https://www.stats.ox.ac.uk/~snijders/FixedRandomEffects.pdf> <https://mspeekenbrink.github.io/sdam-r-companion/linear-mixed-effects-models.html#formulating-and-estimating-linear-mixed-effects-models-with-lme4>

Heisig and Schaeffer 2019. <https://academic.oup.com/esr/article/35/2/258/5306121>

<https://uncdependlab.github.io/MLM_Tutorial/06_ModelSelection/model_comparison.html#akaike-information-criterion-aic>

<https://www.theanalysisfactor.com/six-differences-between-repeated-measures-anova-and-linear-mixed-models/>

# R Programming Cheat Sheets

```{r}
vignette("regular-expressions") # regular expressions are voodoo and this is really helpful for knowing what all of it means

vignette("ggplot2-specs") # for all of the aesthetic settings in ggplot2

#https://www.rdocumentation.org/packages/grDevices/versions/3.6.2/topics/plotmath 
#https://rdrr.io/r/grDevices/plotmath.html for all the rules for parsing text

#https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax #For use in styling text with Markdown (i.e., element_markdown())
#https://wilkelab.org/ggtext/index.html for more on ggtext element_markdown

```

# LOAD REQUIRED R PACKAGES

## 0) First Time Only: Install Required Packages

To run this code, you will need a number of packages to be installed. Packages and versions listed are the ones that I last used and should work with the current code. If renv is present under RStudio's Packages tab, which should be the case if you are within the MulhollandLabFiberPhotometry Project, use "Restore Library" from the drop-down menu to install compatible versions of the packages straight from the project library. I HIGHLY RECOMMEND USING RENV LIBRARY RESTORE INSTEAD OF CODE BELOW UNLESS YOU ARE USING A MORE MODERN VERSION OF R & RStudio than the one I tested. Alternatively, you can specify the version after naming the package to install like this: install.packages("xlsx", version='0.6.5'). By default, if a version is not specified, it will install the latest version.

```{r}
install.packages("xlsx"); #ver 0.6.5 used
install.packages("rstatix"); #ver 0.7.2 used
install.packages("reshape"); #ver 0.8.9 used
install.packages("rlang"); #ver 1.1.0 used
install.packages("tidyverse"); #ver 2.0.0 used
install.packages("ggpubr"); #0.6.0
install.packages("plyr"); #ver 1.8.8
install.packages("dplyr"); #ver 1.1.2
install.packages("datarium"); #ver. 0.1.0
install.packages("data.table"); #ver 1.14.8
install.packages("outliers"); #ver 0.15
install.packages("lubridate"); #ver 1.9.2
install.packages("sp"); #2.0-0
install.packages("scales"); #ver 1.2.1
install.packages("backports"); #ver 1.4.1     
install.packages("effects"); #ver 4.2-2    
install.packages("interactions"); #ver 1.1.5
install.packages("lme4"); #ver 1.1-34
install.packages("lmerTest"); #ver 3.1-3   
install.packages("psych"); #ver 2.3.6    
install.packages("ggpattern"); #ver 1.0.1
install.packages("memisc"); #ver 0.99.31.6
install.packages("broom.mixed"); #ver 0.2.9.4
install.packages("modelsummary"); #ver 1.4.1
install.packages("insight"); #ver 0.19.5
install.packages("knitr"); #ver 1.43
install.packages("ggbeeswarm"); #ver 0.7.2
install.packages("sjPlot"); #ver 2.8.14
install.packages("patchwork"); #ver 1.1.3
install.packages("ggtext"); #ver 0.1.2
install.packages("gridtext"); #ver 0.1.5
install.packages("merTools"); #ver 0.6.1
install.packages("ggh4x"); #ver 0.2.6
install.packages("emmeans"); #ver 1.8.8
install.packages("ggbreak");
install.packages("ggimage");
install.packages("summclust"); 
install.packages("latex2exp");
install.packages("graph3d"); #ver 0.2.0
install.packages("r2mlm"); # for R-squared values
install.packages("performance"); 
install.packages("sjlabelled"); #For labelling model variables better in SJPlots
install.packages("car"); 
install.packages("ggsignif"); #To add significance indicators
install.packages("extrafont"); # To get more fonts to use in ggplot2. MUST THEN RUN A FEW LINES OF CODE TO GET TO WORK (See Note Below)
```

## \*1) Load the Required Packages

```{r}
options(java.parameters = "- Xmx1024m") #rJava struggles with the massive data files produced so the memory must be increased before loading any libraries that use rJava. 

library(xlsx);
library(plyr); #must load before dplyr for proper function
library(rstatix);
library(reshape);
library(rlang);
library(tidyverse);
library(dplyr);
library(ggpubr);
library(datarium);
library(data.table);
library(outliers);
library(lubridate);
library(sp);
library(scales);
library(backports);     # to revive the isFALSE() function for sim_slopes()
library(effects);       # for probing interactions
library(interactions);  # for probing/plotting interactions
library(lme4);          # for multilevel models
library(lmerTest);      # for p-values
library(psych);         # for describing the data
library(ggpattern);	    # for making plots with patterns as legend keys
library(memisc);	      # for exporting lmer stats
library(broom.mixed);
library(modelsummary);
library(insight);       # for easily accessing parts of a model object
library(knitr);
library(ggbeeswarm);
library(sjPlot);
library(ggtext);        # for being able to wrap text in labels
library(gridtext);      # for multipanel plot stuffs (allows markdown text annotations)
library(patchwork);     # for inlaying graphs
library(merTools);      # for some nice plots exploring MLM effects
library(ggh4x);         # for extra faceting options in ggplot2
library(emmeans);       # for displaying interaction effects in mixed models
library(ggbreak);       # for discontinuous scales with different ranges
library(ggimage);
library(summclust);     # for diagnostics of clustered models
library(latex2exp);     # to plot diagnostics of clustered models
library(graph3d);       # to make cool 3d plots
library(r2mlm);         # for R-squared values
library(performance);    # for ICC
library(sjlabelled);      # for better variable labels in sjplot
library(car);          # another contrast tool that makes better contrast labels & tests for problematic multicolinearity
library(ggsignif);   # A package that streamlines ggplot significance indicators
library(extrafont); # To get more fonts for ggplot2 <- after loading first time, need to run: "font_import(), type "y" then press enter, then run: loadfonts(device = "win")
```

## \*2) Load Custom Functions

```{r}
# Believe it or not, std error doesn't have a built in function except in some packages - I did not want it to become contingent on those packages so I just wrote a function that does the std error calculation. 

std.error<-function(x){
  sd(x)/sqrt(length((x)))
}

# Doing geom_signif across facets is stupidly difficult and needs this function to calculate ending points of the line on the x-axis. This function will figure that out. DO NOT HAVE WORKING! Can't figure out why I can't adapt it to our stuff but *Shrug*. 

# xpos_F2 <- function(data, fac1, fac2, xvar, yvals, labels) {
# 
#   get_xpos <- function(data, fac1, fac2, xvar) {
#     datafac  <- list(xvar = data[[names(xvar)[1]]],
#                      fac1 = data[[names(fac1)[1]]],
#                      fac2 = data[[names(fac2)[1]]])
#     datafac  <- lapply(datafac, as.factor)
#     datalevs <- lapply(datafac, levels)
#     datanum <- lapply(datalevs, function(x) as.numeric(factor(x)))
#     datanum[-1] <- lapply(datanum[-1], function(x) x - 1)
#     datanum$fac2 <- (max(datanum$xvar) + 1/3) * datanum$fac2
#     datanum$fac1 <- (max(datanum$xvar + 1/3) + max(datanum$fac2)) * datanum$fac1
#     levs <- Map(match, list(unlist(xvar), unlist(fac1), unlist(fac2)), datalevs)
#     final_vals <- Map(function(x, i) x[i], datanum, levs)
#     facet_add <- final_vals$fac1 + final_vals$fac2
#     facet_add[2] - facet_add[1] + final_vals$xvar[2]
#   }
#   
#   names(fac1[[1]]) <- rep(names(fac1), length(fac1[[1]]))
#   names(fac2[[1]]) <- rep(names(fac2), length(fac2[[1]]))
#   names(xvar[[1]]) <- rep(names(xvar), length(xvar[[1]]))
#   
#   x <- sapply(seq_along(xvar[[1]]), function(i) {
#     get_xpos(data, fac1[[1]][i], fac2[[1]][i], xvar[[1]][i])
#   })
#   d <- data.frame(sapply(fac1[[1]], `[`, 1), sapply(fac2[[1]], `[`, 1),
#                   sapply(xvar[[1]], `[`, 1), x, yvals[[1]], labels)
#   setNames(d, c(names(fac1), names(fac2), names(xvar), 
#                 "xpos", names(yvals), "labels"))
# }
# 
# #Reworked for only one facet: 
# xpos_F1 <- function(data, fac1, xvar, yvals, labels) {
# 
#   get_xpos <- function(data, fac1, xvar) {
#     datafac  <- list(xvar = data[[names(xvar)[1]]],
#                      fac1 = data[[names(fac1)[1]]])
#     datafac  <- lapply(datafac, as.factor)
#     datalevs <- lapply(datafac, levels)
#     datanum <- lapply(datalevs, function(x) as.numeric(factor(x)))
#     datanum[-1] <- lapply(datanum[-1], function(x) x - 1)
#     datanum$fac1 <- (max(datanum$xvar + 2/3) * datanum$fac1)
#     levs <- Map(match, list(unlist(xvar), unlist(fac1)), datalevs)
#     final_vals <- Map(function(x, i) x[i], datanum, levs)
#     facet_add <- final_vals$fac1 
#     facet_add[2] - facet_add[1] + final_vals$xvar[2]
#   }
#   
#   names(fac1[[1]]) <- rep(names(fac1), length(fac1[[1]]))
#   names(xvar[[1]]) <- rep(names(xvar), length(xvar[[1]]))
#   
#   x <- sapply(seq_along(xvar[[1]]), function(i) {
#     get_xpos(data, fac1[[1]][i], xvar[[1]][i])
#   })
#   d <- data.frame(sapply(fac1[[1]], `[`, 1),
#                   sapply(xvar[[1]], `[`, 1), x, yvals[[1]], labels)
#   setNames(d, c(names(fac1), names(xvar), 
#                 "xpos", names(yvals), "labels"))
# }

```

# DATA PREPARATION

## \*1) Read in a study's fiber photometry data (Only One)

Data should be the default, [*compiled*]{.underline} bout output of the Mulholland Lab's MATLAB loop. Specifically Sheet 4 with Bout data. Alternatively, you can extract this sheet from the xlsx file and add manual data for each row like "Output.Order" &"Mouse" & "Sex" , and save as a CSV/xlsx. I found this way too tedious so don't worry, if you didn't want to do this manually, we'll create the variables later.

Your xlsx/CSV file should have a top row that is Variable Names that you will use to analyze the data. Special characters get transformed to "." so try not to use them.


```{r}
file<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/Results_TrueBout_DEG_Validated/20230811T101940_CompiledData.xls"

data<-read.xlsx(file,sheetIndex=1,header=TRUE)

## PreTrueBout
#file<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/20230811T102252_CompiledData.csv"
#data<-read.csv(file, header = TRUE, sep = ",", quote = "\"",dec = ".", fill = TRUE, comment.char = "")
```

## \*2) Clean up data

### (Option 1) All data in file is good data

```{r}
bout.analysis<-data
```

### (Option 2) Filter by column name (Incomplete & buggy - Work in progress)

Filter out what you need if there are things you don't care about in the spreadsheet. Otherwise, use previous code block to use all variables. I added customization here so it will detect whether you manually added Output.Order, Mouse, and Sex. Don't worry, if you didn't, we'll create them later.

```{r}
rootlist<-c('FileName','Channel','Mouse','Bout','BoutStarts','BoutDuration','LicksPerBout','LickFrequency','MeanBefore','MeanAfter','PeakBefore','PeakAfter','Onset','End','x_OfC')
  
root_output<-c('Output.Order','FileName','Channel','Mouse','Sex','Bout'  ,'BoutStarts','BoutDuration','LicksPerBout','LickFrequency','MeanBefore','MeanAfter','PeakBefore','PeakAfter','Onset','End','x_OfC')

root_outputsex<-c('Output.Order','FileName','Channel','Mouse','Sex','Bout','BoutStarts','BoutDuration','LicksPerBout','LickFrequency','MeanBefore','MeanAfter','PeakBefore','PeakAfter','Onset','End','x_OfC')

root_sex<-c('FileName','Channel','Mouse','Sex','Bout','BoutStarts','BoutDuration','LicksPerBout','LickFrequency','MeanBefore','MeanAfter','PeakBefore','PeakAfter','Onset','End','x_OfC')


if ("Output.Order" %in% names(data)==TRUE){
  if ("Sex" %in% names(data)==TRUE){
      bout.analysis<-data[,root_outputsex]
  }else{
      bout.analysis<-data[,root_output]
}}else{ 
  if ("Sex" %in% names(data)==TRUE){
      bout.analysis<-data[,root_sex]
  }else{bout.analysis<-data[,rootlist]
    }}
```

## \*3) Create study-specific key information

This step creates variables like groups, Output.Order, Mouse, Session (coded three ways), and Sex if they weren't filled in manually and sets important statistical factors and levels.


```{r}
file2<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20exptkey.xlsx"  

sessionkey<-read.xlsx(file2, sheetIndex=1)  
sexkey<-read.xlsx(file2, sheetIndex=2)  

#Code to automatically enter in Output Order,Mouse,& Sex based on order in spreadsheet and FileName
setDT(bout.analysis)[,Output.Order:=c(1:length(row.names(bout.analysis)))] 
setDT(bout.analysis)[,Sex:=rep(NA,length(row.names(bout.analysis)))] 
setDT(bout.analysis)[,session:=rep(NA,length(row.names(bout.analysis)))]  
setDT(bout.analysis)[,Solution:=rep(NA,length(row.names(bout.analysis)))]  

#Fill in the correct session # and Solution from the matching FileName entry in the key 
for (i in 1:length(bout.analysis$FileName)){ 
  bout.analysis$session[[i]]<-sessionkey$session[[which(sessionkey$FileName==bout.analysis$FileName[[i]])]] 
  bout.analysis$Solution[[i]]<-sessionkey$Solution[[which(sessionkey$FileName==bout.analysis$FileName[[i]])]]
}

## Grab the Mouse number from the FileName title - numbers that follow either A or B, depending on whether A or B is in "Channel"
for(i in 1:length(bout.analysis$FileName)){ 
  if(bout.analysis$Channel[[i]]=="A"){
    bout.analysis$Mouse[[i]]<-str_extract(bout.analysis$FileName[[i]],"(?<=A)[0-9]*")}
  if(bout.analysis$Channel[[i]]=="B"){
    bout.analysis$Mouse[[i]]<-str_extract(bout.analysis$FileName[[i]],"(?<=B)[0-9]*")}
}

## Grab the Sex from the entry in the key that matches each Mouse
for (i in 1:length(bout.analysis$Mouse)){ 
  bout.analysis$Sex[[i]]<-sexkey$Sex[[which(sexkey$Mouse==bout.analysis$Mouse[[i]])]]}

#Make new variables for differences between times
meanbeforeafter<-bout.analysis$MeanAfter-bout.analysis$MeanBefore
pmeanbeforeafter<-((bout.analysis$MeanAfter-bout.analysis$MeanBefore)/bout.analysis$MeanBefore)*100
peakbeforeafter<-bout.analysis$PeakAfter-bout.analysis$PeakBefore
end.onset<-bout.analysis$End-bout.analysis$Onset

bout.analysis<-cbind(bout.analysis,meanbeforeafter,pmeanbeforeafter,peakbeforeafter,end.onset)

bout.analysis<-bout.analysis %>% mutate(Position=case_when(BoutStarts<=740 ~ "First 10 min",BoutStarts>=7288 ~ "Last 10 min", BoutStarts>740 & BoutStarts<7288 ~"Middle"))
  

bout.analysis<-sort_df(bout.analysis,c('Output.Order'))

rownames(bout.analysis)<-c(1:length(rownames(bout.analysis))) #reset row names so they follow a consecutive order again

##Levels of different factors specific to experiment - used later in 5) Finalize

sol.levels<-c("QHCl (Low)","Water","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)")

sol.levels.contr<-c("Water","QHCl (Low)","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)")

pos.levels<-c("Middle","Last 10 min","First 10 min")

#This is used for the wide format data
#group1.levels=c("Female QHCl (High)","Male QHCl (High)","Female QHCl (Low)","Male QHCl (Low)","Female Water","Male Water","Female Water + Dep","Male Water + Dep","Female Sucrose + QHCl (Low)","Male Sucrose + QHCl (Low)","Female Sucrose + QHCl (High)","Male Sucrose + QHCl (High)","Female EtOH","Male EtOH","Female Saccharin","Male Saccharin","Female Citric Acid","Male Citric Acid")

group1.levels=c("Female QHCl (Low)","Male QHCl (Low)","Female Water","Male Water","Female Water + Dep","Male Water + Dep","Female Sucrose + QHCl (Low)","Male Sucrose + QHCl (Low)","Female Sucrose + QHCl (High)","Male Sucrose + QHCl (High)")


#This is used for the long format data
#group2.levels=c("Female QHCl (High) Before","Female QHCl (High) After", "Male QHCl (High) Before","Male QHCl (High) After","Female QHCl (Low) Before","Female QHCl (Low) After","Male QHCl (Low) Before","Male QHCl (Low) After","Female Water Before","Female Water After","Male Water Before","Male Water After","Female Water + Dep Before","Female Water + Dep After","Male Water + Dep Before","Male Water + Dep After","Female Sucrose + QHCl (Low) Before","Female Sucrose + QHCl (Low) After","Male Sucrose + QHCl (Low) Before","Male Sucrose + QHCl (Low) After","Female Sucrose + QHCl (High) Before","Female Sucrose + QHCl (High) After","Male Sucrose + QHCl (High) Before","Male Sucrose + QHCl (High) After","Female EtOH Before","Female EtOH After","Male EtOH Before","Male EtOH After","Female Saccharin Before","Female Saccharin After", "Male Saccharin Before","Male Saccharin After","Female Citric Acid Before","Female Citric Acid After","Male Citric Acid Before","Male Citric Acid After")

group2.levels=c("Female QHCl (Low) Before","Female QHCl (Low) After","Male QHCl (Low) Before","Male QHCl (Low) After","Female Water Before","Female Water After","Male Water Before","Male Water After","Female Water + Dep Before","Female Water + Dep After","Male Water + Dep Before","Male Water + Dep After","Female Sucrose + QHCl (Low) Before","Female Sucrose + QHCl (Low) After","Male Sucrose + QHCl (Low) Before","Male Sucrose + QHCl (Low) After","Female Sucrose + QHCl (High) Before","Female Sucrose + QHCl (High) After","Male Sucrose + QHCl (High) Before","Male Sucrose + QHCl (High) After")

```

## \*4) Set dropped subjects, bouts, or sessions

For any mice whose data you don't want at this point, put their subject number in the dropped mice vector in quotations. You will have a chance to check and remove outliers later. Then you will manually define mouse-subject pairings by sex. You also here will define what way of coding "session" you want to use.

```{r}
droppedmice<-c("")
droppedbouts<-data.frame("FileName"=c(""),"Mouse"=c(""),"Bout"=c(""))

#20230118CL20A6B3sucroseqmid was dropped because only two bouts were in the session and there was no signal stabilization at this point.

#20230105CL20A6B3waterdep" and "20230105CL20A6B3waterdep were dropped because these were only partial (~2hrs) water deprivation sessions by accident

droppedsessions<-data.frame("FileName"=c("20230118CL20A6B3sucroseqmid","20230105CL20A6B3waterdep","20230105CL20A6B3waterdep"), "Mouse"=c("6","6","3"))
#droppedsolutions<-c("")
droppedsolutions<-c("QHCl (Very High)","QHCl (High)","EtOH","Saccharin","Citric Acid")
                    

#Define replicates within sex manually here - exclude dropped animals!
subject<-data.frame("mouse"=c(2,3,4,5,6,7,8,9),"subject"=c(1,2,3,1,2,3,4,5)) 
sub.levels=c(1:9)

#Pick whether you want session to be coded within solution (session.sol), linear (just 1-# of sessions; session.lin), or by experiment (1-40 each cohort; session.exp)
names(bout.analysis)[which(names(bout.analysis)=="session.sol")]<-"session"
```

## \*5) Semi-Finalize - Remove dropped data, set factors, sort, and put in semi-final formats (long, wide)

```{r}
bout.analysis2<-filter(bout.analysis, !Mouse %in% droppedmice)
for (j in 1:nrow(droppedbouts)){
bout.analysis2<-filter(bout.analysis2, !(FileName==droppedbouts$FileName[[j]] & Mouse==droppedbouts$Mouse[[j]] & Bout==droppedbouts$Bout[[j]]))
}
for (k in 1:nrow(droppedsessions)){
bout.analysis2<-filter(bout.analysis2, !(FileName==droppedsessions$FileName[[k]] & Mouse==droppedsessions$Mouse[[k]]))
}

bout.analysis2<-filter(bout.analysis2, !Solution %in% droppedsolutions, preserve=TRUE)


#Codes the subjects as replicate within sex  
setDT(bout.analysis2)[,subject:=rep(NA,length(row.names(bout.analysis2)))] 
for (i in 1:length(rownames(bout.analysis2))){     
      bout.analysis2$subject[[i]]<-subject$subject[[which(subject$mouse==bout.analysis2$Mouse[[i]])]]
}
bout.analysis2$subject<-factor(bout.analysis2$subject,levels=sub.levels)  

#Create group variable that is a combination of Sex and Solution
group_shrt<-paste(bout.analysis2$Sex,bout.analysis2$Solution,sep=" ") 
bout.analysis2<-cbind(bout.analysis2,group_shrt) 

remove(group_shrt,droppedbouts,droppedsessions,droppedmice,droppedsolutions,subject)
```

## \*6) Set Desired Group Color Palette & Text Size for Graphs

```{r}
c1<-"#D41159" #This is rgb(212,17,89, maxColorValue=255) rgb% [0.83,0.07,0.35] or red for EtOH
c1.2<-"#E5709B" #This is rgb(229,112,155, maxColorValue=255) rgb% [0.90, 0.44, 0.61]
c2<-"#1A85FF" #This is rgb(26,133,255, maxColorValue=255) rgb% [0.10,0.52,1.00] or blue for Water
c2.2<-"grey" #This is for water in Expt 2
c3<-"#5225A0" #This is rgb(82,37,160, maxColorValue=255) rgb% [0.32,0.15,0.63] or dark purple for Sucrose' or Sucrose + QHCl High
c4<-"chocolate1" # This is rgb(255,127,36, maxColorValue=255) rgb% [1.0,0.50,0.14] or orange for Quinine HEX: #FF7F24
#c5<-"darkorchid1" # This is rgb(191,62,255, maxColorValue=255) rgb% [0.75,0.24,1.0] or light purple 
#c6<-"chartreuse" # This is rgb(127,255,0, maxColorValue=255) rgb% [0.50,1.0,0] or neon green 
c7<-"darkblue" #This is rgb(0,0,139, maxColorValue=255) rgb% [0.0,0.0,0.55] HEX: #00008B
#c8<-"chocolate4"#This is rgb(139,69,19, maxColorValue=255) rgb% [0.55,0.27,0.07] or HEX: #8B4513
c9<-"#a440b0" #This is rgb(164, 64, 176, maxColorValue=255) rgb% [0.64,0.25,0.69]Publishable color used for Sucrose+QHCl Low
# c10<-"#caa600" #This is rgb(255,215,0, maxColorValue=255) rgb% [0.79,0.65,0] Publishable color used for Citric Acid
# c11<-"#ffaaf7" #This is rgb(255, 170, 247, maxColorValue=255) rgb% [1.0,0.67,0.67]Publishable color used for Saccharin

custom<-c(c4,c2,c7,c9,c3,c1) #Define custom color palette
custom.alt<-c(c2.2,c4,c7,c9,c3,c1)



#Set specific relationships between titles, axis text, and other text categories so allow consistency between figures of approximately the same size.

title.sz<-6.5*.pt
title.sz2<-8*.pt
txt.sz1<-5*.pt
txt.sz2<-5.5*.pt
otr.sz<-2.5*.pt
otr.sz1<-3.5*.pt
otr.sz2<-4.5*.pt
```

# TRUEBOUT DEG ANALYSIS & FILTERING

## 1) (Recommended) TrueBout Analysis - Graphs

If you used the TrueBout Deepethogram model to assign a percent consumption to each bout, we will need to explore what the appropriate threshold is to be able to separate real bouts from non-bouts. The easiest way to do this is to make some exploratory graphs.

### a) Stacked Histogram of % Consumatory by Solution

```{r}
q<-ggplot(data=data.analysis)+   
  geom_histogram(aes(x=x_OfC,color=Solution), size=1, binwidth=0.1)+  
  scale_x_continuous(n.breaks=10, expand = expansion(0.0))+
  scale_y_continuous(n.breaks=10, expand = expansion(0.0))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="% Consumatory Frames", y="Number") 
q
```

### b) Histogram of % Consumatory by Solution Separately as Percent Occurrence

```{r}
q<-ggplot(data=bout.analysis2, aes(x=(x_OfC*100),color=Solution,show.legend=FALSE))+facet_wrap(~Solution,drop = T)+theme_classic()+geom_vline(xintercept=50,linetype=2)+geom_bar(aes(y=(after_stat(count))/tapply(after_stat(count),..PANEL..,sum)[..PANEL..]),linewidth=3)+scale_color_manual(values=custom)+scale_x_continuous(n.breaks=6, expand = expansion(0.1))+scale_y_continuous(n.breaks=10, expand = expansion(c(0,0.05)))+theme(axis.title=element_text(size=16, face="bold"),axis.text=element_text(size=13),panel.grid.major = element_blank(),strip.text.x = element_text(face="bold",size=14),panel.grid.minor = element_blank())+labs(x="% Consumatory Frames", y="Data Proportion")+guides(color=FALSE)
q

#550 x 400

r<-ggplot(data=bout.analysis2, aes(x=(x_OfC*100),color=Solution))+facet_grid(Sex~Solution,drop = T)+theme_classic()+geom_vline(xintercept=50,linetype=2)+geom_bar(aes(y=(after_stat(count))/tapply(after_stat(count),..PANEL..,sum)[..PANEL..]),linewidth=3)+scale_color_manual(values=custom)+  scale_x_continuous(n.breaks=6, expand = expansion(0.1))+scale_y_continuous(n.breaks=10, expand = expansion(c(0,0.05)))+theme(axis.title=element_text(size=16, face="bold"),axis.text=element_text(size=13),panel.grid.major = element_blank(),strip.text.x = element_text(face="bold",size=14),strip.text.y = element_text(size=14,face="bold"),panel.grid.minor = element_blank())+labs(x="% Consumatory Frames", y="Data Proportion")+guides(color=FALSE)
r

#550 x 400
```

### c) Scatter plot of % Consumatory vs Bout Duration

```{r}
q<-ggplot(data=data.analysis,aes(x=BoutDuration,y=x_OfC))+
  geom_point(aes(color=Solution), size=2)+
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="Bout Duration (s)", y="% Consumatory Frames")
q
```

### d) Scatter plot of % Consumatory vs Number of Licks

```{r}
q<-ggplot(data=data.analysis,aes(x=LicksPerBout,y=x_OfC))+   
  geom_point(aes(color=Solution), size=2)+   
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  scale_x_continuous(n.breaks=10, expand = expansion(0.00))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+   
  labs(x="Number of Licks", y="% Consumatory Frames") 
q
```

### e) Scatter plot of % Consumatory vs Lick Rate

```{r}
q<-ggplot(data=data.analysis,aes(x=LickFrequency,y=x_OfC))+      
  geom_point(aes(color=Solution), size=2)+      
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+   
  scale_x_continuous(n.breaks=10, expand = expansion(0.00))+   
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+      
  labs(x="Lick Frequency", y="% Consumatory Frames")  
q
```

### f) Scatter plot of % Consumatory vs BoutStarts

```{r}
q<-ggplot(data=data.analysis,aes(x=BoutStarts,y=x_OfC))+         
  geom_point(aes(color=Solution), size=2)+         
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  scale_x_continuous(n.breaks=10, expand = expansion(0.00))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major =element_blank(),panel.grid.minor = element_blank())+
  labs(x="Bout Start (s)", y="% Consumatory Frames")
  #facet_grid(~Mouse)
q
```

### g) Scatter plot of % Consumatory vs Mouse

```{r}
q<-ggplot(data=data.analysis,aes(x=Mouse,y=x_OfC))+            
  geom_point(aes(color=Solution), size=2,position = "jitter")+            
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  scale_x_discrete(expand = expansion(0.05))+         
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+            
  labs(x="Mouse", y="% Consumatory Frames")+
  facet_wrap(~Sex,scales="free_x")
  #facet_wrap(Solution~Sex,scales="free_x")
 q
```

### h) Scatter plot of % Consumatory vs Session

```{r}
q<-ggplot(data=data.analysis,aes(x=session,y=x_OfC))+
  geom_point(aes(color=Solution), size=1,position = "jitter")+
  scale_y_continuous(n.breaks=10, expand = expansion(0.05))+
  scale_x_continuous(n.breaks=25,expand = expansion(0.05))+
  theme(axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="Session", y="% Consumatory Frames")+
  facet_wrap(~Sex+Channel) 
q
```

## 2) (Optional) True Bout Analysis - QC

To check subsets of the data for quality control of DEG model, use code below.

### a) All 0 percent consumatory "bouts"

```{r}
data.analysis_zero<- data.analysis %>% 
  filter(between(x_OfC,0.0,0.0),preserve=TRUE)
```

### b) All 30-50% consumatory "bouts"

```{r}
data.analysis_grey<-data.analysis %>% 
  filter(between(x_OfC,0.3,0.5),preserve=TRUE)
```

### c) All 75-80% consumatory "bouts"

```{r}
data.analysis_highgrey<-data.analysis %>% 
  filter(between(x_OfC,0.75,0.8),preserve=TRUE)
```

## \*3) Apply True Bout Cut-off to Get Final Data Set

Once you decide what the appropriate threshold of a "true bout" is from exploring the data, set the threshold here and filter out presumptive "not bouts".

```{r}
bout.analysis2_true <- bout.analysis2 %>% 
  filter(between(x_OfC,0.5,1.0),preserve=TRUE)
bout.analysis2_false <- bout.analysis2 %>%
  filter(between(x_OfC,0,0.4999),preserve=TRUE)
```

# DATA FINALIZATION

## \*1) Standardize (Scale & Center) and Set Contrasts

Standardize calcium signal (two methods). Make standardized and centered bout-level variables. Set categorical variable contrasts. Session-level variables (e.g. drinking) will be made during session level analysis. Sort and divide into long/wide formats.

```{r}
#Make variables for Standardizations and Centering

#z2 = Mouse-Level standard z-score to match what was done with the bout characteristics 

#########################################################################################
#First, get mouse level mean session-mean and sdev - This is using HALF SOLUTIONS

temp<-bout.analysis2_true %>% 	#Lumps together MeanBefore and MeanAfter before computing the mean and standard deviation
  gather(key="time", value="signal", MeanBefore, MeanAfter)

SignalMeans<- temp %>%
  group_by(Mouse) %>%
  get_summary_stats(c('signal'), type = "mean_sd")

setDT(bout.analysis2_true)[,MSig_m:=rep(NA,length(row.names(bout.analysis2_true)))]

for (i in 1:length(bout.analysis2_true$FileName)){
  bout.analysis2_true$MSig_m[[i]]<-SignalMeans$mean[[which(SignalMeans$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,MSig_sd:=rep(NA,length(row.names(bout.analysis2_true)))]

for (i in 1:length(bout.analysis2_true$FileName)){
  bout.analysis2_true$MSig_sd[[i]]<-SignalMeans$sd[[which(SignalMeans$Mouse==bout.analysis2_true$Mouse[[i]])]]
}


bout.analysis2_true<-bout.analysis2_true %>%
  mutate(z2MeanBefore=as.vector((bout.analysis2_true$MeanBefore-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
  mutate(z2MeanAfter=as.vector((bout.analysis2_true$MeanAfter-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd))

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(z2RAMP60to50sec=as.vector((bout.analysis2_true$RAMP60to50-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
  mutate(z2RAMP50to40sec=as.vector((bout.analysis2_true$RAMP50to40-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
 mutate(z2RAMP40to30sec=as.vector((bout.analysis2_true$RAMP40to30-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
  mutate(z2RAMP30to20sec=as.vector((bout.analysis2_true$RAMP30to20-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
  mutate(z2RAMP20to10sec=as.vector((bout.analysis2_true$RAMP20to10-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) %>%
 mutate(z2RAMP10to0sec=as.vector((bout.analysis2_true$RAMP10to0-bout.analysis2_true$MSig_m)/bout.analysis2_true$MSig_sd)) 

z2meanbeforeafter<-bout.analysis2_true$z2MeanAfter-bout.analysis2_true$z2MeanBefore
bout.analysis2_true<-cbind(bout.analysis2_true,z2meanbeforeafter)

# #JUST ONCE Export a key of this standardization to use in the 30sec graph data.
zkey<-subset(bout.analysis2_true,select=c("FileName","Mouse","Channel","Bout","MSig_m","MSig_sd"))
#write.xlsx(zkey,file=file2,sheetName = "Zscore_Half",append=TRUE)


#Many of the measures are on vastly different scales. Thus we z-score them here to allow them to be used as predictors using the standard z-scoring method: x-mean/sd. Further, to probe within and between effects on variables, we create individual mean centered (imc) and one of the following: grand mean centered (gmc), sex mean centered (smc), or group mean centered (grpmc) transformation of key variables. The imc uses the mean and sd of each Mouse's data. The gmc uses the mean and sd of all mouse MEANS. The smc uses the mean and sd of each sex independently. The grpmc uses the mean and sd of each group independently. Each of these asks a slightly different question so know what each is asking! Standardizing both scales and centers the variables.

             
##Bout Duration Standardized Variables
Duration_means<- bout.analysis2_true %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('BoutDuration'), type = "mean_sd")
Duration_means<-Duration_means %>%
  mutate("gmc"=as.vector(scale(mean)))

setDT(bout.analysis2_true)[,Duration_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_m[[i]]<-Duration_means$mean[[which(Duration_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,Duration_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_sd[[i]]<-Duration_means$sd[[which(Duration_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Duration_imc=as.vector((bout.analysis2_true$BoutDuration-bout.analysis2_true$Duration_m)/bout.analysis2_true$Duration_sd))


setDT(bout.analysis2_true)[,Duration_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_gmc[[i]]<-Duration_means$gmc[[which(Duration_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##Bout Duration Standardized Variables - means by SEX!
Duration_means_sex<- bout.analysis2_true %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('BoutDuration'), type = "mean_sd")

Duration_means_sex<- Duration_means_sex %>% 
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Duration_means_sex<- Duration_means_sex %>% 
  mutate(variable="BoutDuration")

setDT(bout.analysis2_true)[,Duration_sm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_sm[[i]]<-Duration_means_sex$mean[[which(Duration_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

setDT(bout.analysis2_true)[,Duration_ssd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_ssd[[i]]<-Duration_means_sex$sd[[which(Duration_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Duration_smc=as.vector((bout.analysis2_true$Duration_m-bout.analysis2_true$Duration_sm)/bout.analysis2_true$Duration_ssd))

# Bout Duration Within-Solution Individually Standardized 
Duration.sol_means<- bout.analysis2_true %>% 
  group_by(Mouse,Solution) %>%
  get_summary_stats(c('BoutDuration'), type = "mean_sd")
Duration.sol_means<-Duration.sol_means %>%
  group_by(Solution)%>%
  mutate("gmc"=as.vector(scale(mean))) %>%
  ungroup()
Duration.sol_means2<-Duration.sol_means %>%
  group_by(Solution) %>%
  get_summary_stats(c('mean'), type= "mean_sd")
Duration.sol_means2<-Duration.sol_means2 %>%
  mutate(variable="BoutDuration")

setDT(bout.analysis2_true)[,Duration_solm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_solm[[i]]<-Duration.sol_means$mean[[which(Duration.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Duration.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] )]]
}

setDT(bout.analysis2_true)[,Duration_solsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_solsd[[i]]<-Duration.sol_means$sd[[which(Duration.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Duration.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Duration_sol_imc=as.vector((bout.analysis2_true$BoutDuration-bout.analysis2_true$Duration_solm)/bout.analysis2_true$Duration_solsd))

setDT(bout.analysis2_true)[,Duration_sol_gmc:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_sol_gmc[[i]]<-Duration.sol_means$gmc[[which(Duration.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Duration.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##Bout Duration Standardized Variables - means by group!
Duration_means_grp<- bout.analysis2_true %>% 
  group_by(Mouse,group_shrt) %>%
  get_summary_stats(c('BoutDuration'), type = "mean_sd")
Duration_means_grp<- Duration_means_grp %>% 
  group_by(group_shrt) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Duration_means_grp<- Duration_means_grp %>% 
  mutate(variable="BoutDuration")

setDT(bout.analysis2_true)[,Duration_grpm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_grpm[[i]]<-Duration_means_grp$mean[[which(Duration_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

setDT(bout.analysis2_true)[,Duration_grpsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$Duration_grpsd[[i]]<-Duration_means_grp$sd[[which(Duration_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(Duration_grpmc=as.vector((bout.analysis2_true$Duration_solm-bout.analysis2_true$Duration_grpm)/bout.analysis2_true$Duration_grpsd))


##Bout Starts Standardized Variables: Not scaled! Since we want to treat it as time within session, not any form of "individual time". Also, since there are so many possible time points, I decided to bin the variable into 10-min segments and to code the now categorical variable into first 10 min vs the rest of the session to probe the question - are the first 10 min unique? **Note that there are likely slight variations in each session's start and end times so binning is a better strategy anyway. 

#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds) or <=740. Then the last 10 min is anything greater than or equal to 7889 (maximum start) minus 600 or >=7289.The remaining time is coded as a single category. 

BoutStarts_means<- bout.analysis2_true %>% 
  group_by(Sex,Mouse,Solution,session) %>%
  get_summary_stats(c('BoutStarts'), type =c("five_number"),show=c("n","min","max"))



##LicksPerBout Standardized Variables
LicksPerBout_means<- bout.analysis2_true %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('LicksPerBout'), type = "mean_sd")
LicksPerBout_means<-LicksPerBout_means %>%
  mutate("gmc"=as.vector(scale(mean)))

setDT(bout.analysis2_true)[,LicksPerBout_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_m[[i]]<-LicksPerBout_means$mean[[which(LicksPerBout_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,LicksPerBout_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_sd[[i]]<-LicksPerBout_means$sd[[which(LicksPerBout_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LicksPerBout_imc=as.vector((bout.analysis2_true$LicksPerBout-bout.analysis2_true$LicksPerBout_m)/bout.analysis2_true$LicksPerBout_sd))


setDT(bout.analysis2_true)[,LicksPerBout_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_gmc[[i]]<-LicksPerBout_means$gmc[[which(LicksPerBout_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##LicksPerBout Standardized Variables - means by SEX!
LicksPerBout_means_sex<- bout.analysis2_true %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('LicksPerBout'), type = "mean_sd")

LicksPerBout_means_sex<- LicksPerBout_means_sex %>% 
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
LicksPerBout_means_sex<- LicksPerBout_means_sex %>% 
  mutate(variable="LicksPerBout")

setDT(bout.analysis2_true)[,LicksPerBout_sm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_sm[[i]]<-LicksPerBout_means_sex$mean[[which(LicksPerBout_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

setDT(bout.analysis2_true)[,LicksPerBout_ssd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_ssd[[i]]<-LicksPerBout_means_sex$sd[[which(LicksPerBout_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LicksPerBout_smc=as.vector((bout.analysis2_true$LicksPerBout_m-bout.analysis2_true$LicksPerBout_sm)/bout.analysis2_true$LicksPerBout_ssd))

# Bout Lick Within-Solution Individually Standardized 
Lick.sol_means<- bout.analysis2_true %>% 
  group_by(Mouse,Solution) %>%
  get_summary_stats(c('LicksPerBout'), type = "mean_sd")
Lick.sol_means<-Lick.sol_means %>%
  group_by(Solution)%>%
  mutate("gmc"=as.vector(scale(mean))) %>%
  ungroup()
Lick.sol_means2<-Lick.sol_means %>%
  group_by(Solution) %>%
  get_summary_stats(c('mean'), type= "mean_sd")
Lick.sol_means2<-Lick.sol_means2 %>%
  mutate(variable="LicksPerBout")
  
setDT(bout.analysis2_true)[,LicksPerBout_solm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_solm[[i]]<-Lick.sol_means$mean[[which(Lick.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Lick.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] )]]
}

setDT(bout.analysis2_true)[,LicksPerBout_solsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_solsd[[i]]<-Lick.sol_means$sd[[which(Lick.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Lick.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LicksPerBout_sol_imc=as.vector((bout.analysis2_true$LicksPerBout-bout.analysis2_true$LicksPerBout_solm)/bout.analysis2_true$LicksPerBout_solsd))

setDT(bout.analysis2_true)[,LicksPerBout_sol_gmc:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_sol_gmc[[i]]<-Lick.sol_means$gmc[[which(Lick.sol_means$Solution==bout.analysis2_true$Solution[[i]] & Lick.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##LicksPerBout Standardized Variables - means by group!
Lick_means_grp<- bout.analysis2_true %>% 
  group_by(Mouse,group_shrt) %>%
  get_summary_stats(c('LicksPerBout'), type = "mean_sd")
Lick_means_grp<- Lick_means_grp %>% 
  group_by(group_shrt) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Lick_means_grp<- Lick_means_grp %>% 
  mutate(variable="LicksPerBout")

setDT(bout.analysis2_true)[,LicksPerBout_grpm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_grpm[[i]]<-Lick_means_grp$mean[[which(Lick_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

setDT(bout.analysis2_true)[,LicksPerBout_grpsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LicksPerBout_grpsd[[i]]<-Lick_means_grp$sd[[which(Lick_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LicksPerBout_grpmc=as.vector((bout.analysis2_true$LicksPerBout_solm-bout.analysis2_true$LicksPerBout_grpm)/bout.analysis2_true$LicksPerBout_grpsd))





##Lick Frequency Standardized Variables
LickFrequency_means<- bout.analysis2_true %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('LickFrequency'), type = "mean_sd")
LickFrequency_means<-LickFrequency_means %>%
  mutate("gmc"=as.vector(scale(mean)))

setDT(bout.analysis2_true)[,LickFrequency_m:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_m[[i]]<-LickFrequency_means$mean[[which(LickFrequency_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

setDT(bout.analysis2_true)[,LickFrequency_sd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_sd[[i]]<-LickFrequency_means$sd[[which(LickFrequency_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LickFrequency_imc=as.vector((bout.analysis2_true$LickFrequency-bout.analysis2_true$LickFrequency_m)/bout.analysis2_true$LickFrequency_sd))


setDT(bout.analysis2_true)[,LickFrequency_gmc:=rep(NA,length(row.names(bout.analysis2_true)))] 

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_gmc[[i]]<-LickFrequency_means$gmc[[which(LickFrequency_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##Lick Frequency Standardized Variables - means by SEX!
LickFrequency_means_sex<- bout.analysis2_true %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('LickFrequency'), type = "mean_sd")

LickFrequency_means_sex<- LickFrequency_means_sex %>% 
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")

LickFrequency_means_sex<- LickFrequency_means_sex %>% 
  mutate(variable="LickFrequency")

setDT(bout.analysis2_true)[,LickFrequency_sm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_sm[[i]]<-LickFrequency_means_sex$mean[[which(LickFrequency_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

setDT(bout.analysis2_true)[,LickFrequency_ssd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_ssd[[i]]<-LickFrequency_means_sex$sd[[which(LickFrequency_means_sex$Sex==bout.analysis2_true$Sex[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LickFrequency_smc=as.vector((bout.analysis2_true$LickFrequency_m-bout.analysis2_true$LickFrequency_sm)/bout.analysis2_true$LickFrequency_ssd))

# Lick Frequency Within-Solution Individually Standardized 
LickFrequency.sol_means<- bout.analysis2_true %>% 
  group_by(Mouse,Solution) %>%
  get_summary_stats(c('LickFrequency'), type = "mean_sd")
LickFrequency.sol_means<-LickFrequency.sol_means %>%
  group_by(Solution)%>%
  mutate("gmc"=as.vector(scale(mean))) %>%
  ungroup()
LickFrequency.sol_means2<-LickFrequency.sol_means %>%
  group_by(Solution) %>%
  get_summary_stats(c('mean'), type= "mean_sd")
LickFrequency.sol_means2<-LickFrequency.sol_means2 %>%
  mutate(variable="LickFrequency")
  
setDT(bout.analysis2_true)[,LickFrequency_solm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_solm[[i]]<-LickFrequency.sol_means$mean[[which(LickFrequency.sol_means$Solution==bout.analysis2_true$Solution[[i]] & LickFrequency.sol_means$Mouse==bout.analysis2_true$Mouse[[i]] )]]
}

setDT(bout.analysis2_true)[,LickFrequency_solsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_solsd[[i]]<-LickFrequency.sol_means$sd[[which(LickFrequency.sol_means$Solution==bout.analysis2_true$Solution[[i]] & LickFrequency.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LickFrequency_sol_imc=as.vector((bout.analysis2_true$LickFrequency-bout.analysis2_true$LickFrequency_solm)/bout.analysis2_true$LickFrequency_solsd))

setDT(bout.analysis2_true)[,LickFrequency_sol_gmc:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_sol_gmc[[i]]<-LickFrequency.sol_means$gmc[[which(LickFrequency.sol_means$Solution==bout.analysis2_true$Solution[[i]] & LickFrequency.sol_means$Mouse==bout.analysis2_true$Mouse[[i]])]]
}

##LicksPerBout Standardized Variables - means by group!
LickFrequency_means_grp<- bout.analysis2_true %>% 
  group_by(Mouse,group_shrt) %>%
  get_summary_stats(c('LickFrequency'), type = "mean_sd")
LickFrequency_means_grp<- LickFrequency_means_grp %>% 
  group_by(group_shrt) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
LickFrequency_means_grp<- LickFrequency_means_grp %>% 
  mutate(variable="LickFrequency")

setDT(bout.analysis2_true)[,LickFrequency_grpm:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_grpm[[i]]<-LickFrequency_means_grp$mean[[which(LickFrequency_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

setDT(bout.analysis2_true)[,LickFrequency_grpsd:=rep(NA,length(row.names(bout.analysis2_true)))]  

for (i in 1:length(bout.analysis2_true$FileName)){ 
  bout.analysis2_true$LickFrequency_grpsd[[i]]<-LickFrequency_means_grp$sd[[which(LickFrequency_means_grp$group_shrt==bout.analysis2_true$group_shrt[[i]])]]
}

bout.analysis2_true<-bout.analysis2_true %>%
  mutate(LickFrequency_grpmc=as.vector((bout.analysis2_true$LickFrequency_solm-bout.analysis2_true$LickFrequency_grpm)/bout.analysis2_true$LickFrequency_grpsd))


## Sort columns into desired order (feel free to customize). This will also be used to refer to all your variables later on so don't leave any out. 

myorder<-c("Output.Order","FileName","Channel","Mouse","Sex","subject","Solution","group_shrt","session","x_OfC","Bout","Position","BoutStarts","BoutDuration","Duration_m","Duration_sd","Duration_imc","Duration_gmc","Duration_sm","Duration_ssd","Duration_smc","Duration_solm","Duration_solsd","Duration_sol_imc","Duration_sol_gmc","Duration_grpm","Duration_grpsd","Duration_grpmc","LicksPerBout","LicksPerBout_m","LicksPerBout_sd","LicksPerBout_imc","LicksPerBout_gmc","LicksPerBout_sm","LicksPerBout_ssd","LicksPerBout_smc","LicksPerBout_solm","LicksPerBout_solsd","LicksPerBout_sol_imc","LicksPerBout_sol_gmc","LicksPerBout_grpm","LicksPerBout_grpsd","LicksPerBout_grpmc","LickFrequency","LickFrequency_m","LickFrequency_sd","LickFrequency_imc","LickFrequency_gmc","LickFrequency_sm","LickFrequency_ssd","LickFrequency_smc","LickFrequency_solm","LickFrequency_solsd","LickFrequency_sol_imc","LickFrequency_sol_gmc","LickFrequency_grpm","LickFrequency_grpsd","LickFrequency_grpmc","MSig_m","MSig_sd","MeanBefore","z2MeanBefore","MeanDuring","MeanAfter","z2MeanAfter","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","PeakBefore","PeakDuring","PeakAfter","peakbeforeafter","MinBefore","MinDuring","MinAfter","Onset","End","end.onset","SlopePolyfit","SlopeTwoPoint","RAMP60to50sec","RAMP50to40sec","RAMP40to30sec","RAMP30to20sec","RAMP20to10sec","RAMP10to0sec","z2RAMP60to50sec","z2RAMP50to40sec","z2RAMP40to30sec","z2RAMP30to20sec","z2RAMP20to10sec","z2RAMP10to0sec")

#Define variables that are key descriptors of the data (e.g. Filename, Channel, Mouse, Sex, subject...)
corevars<-c("Output.Order","FileName","Channel","Mouse","Sex","subject","Solution","group_shrt","session")

bout.analysis2_true<-bout.analysis2_true[,..myorder]

#Make sure everything is set as factors with appropriate levels
bout.analysis2_true$Mouse<-factor(bout.analysis2_true$Mouse)
bout.analysis2_true$Solution<-factor(bout.analysis2_true$Solution,levels=sol.levels.contr) 
bout.analysis2_true$Sex<-factor(bout.analysis2_true$Sex,levels=c("Female","Male"))
bout.analysis2_true$Position<-factor(bout.analysis2_true$Position,levels=pos.levels)

############### CONTRAST ASSIGNMENT ########################
#Assigned contrasts use the factor levels previously made. 
#Check contrasts and change if desired:
#contrasts(bout.analysis2_true$Sex)
#contrasts(bout.analysis2_true$Solution)
#NOTE: CL made a Word document summarizing all the pre-made and custom contrasts and how to use them in R. 

##Declare this line of options to make comparable to SAS
#options(contrasts = c(faccontrtor = "contr.SAS", ordered = "contr.poly")) 
#Contrasts (decided to use centered contrasts after reading Yaremych et al 2023) *Time is set as a contrast after data is separated below.

### IMPORTANT ###
#Here you will set the contrast scheme to be used for factors of different levels. You can use different contrasts depending on your hypotheses, but most options produce the same comparisons for a two-level factor.

# Effects Contrast Code: 
#creating the contrast matrix manually by modifying the dummy coding scheme
c<-contr.treatment(5)
my.coding<-matrix(rep(1/5, 20), ncol=4) # The first part of rep for matrix is 1/levels; Cols = levels -1 so the second part of rep for matrix is (levels-1 * levels)
my.simple<-c-my.coding
colnames(my.simple)<-c("[E.QHCl]","[E.WaterDep]","[E.Suc+QHClow]","[E.Suc+QHClhigh]")

contrasts(bout.analysis2_true$Sex) <- contr.Helmert(levels(bout.analysis2_true$Sex))
colnames(contrasts(bout.analysis2_true$Sex))<-c("[H.Male-Female]")
contrasts(bout.analysis2_true$Solution) <- my.simple
contrasts(bout.analysis2_true$Position) <- contr.Helmert(levels(bout.analysis2_true$Position))
colnames(contrasts(bout.analysis2_true$Position))<-c("[H.Last10-Middle]","[H.First10-Other]")

#Make a copy of bout.analysis in its current wide format (needed for some analyses)
data.analysis_true<-bout.analysis2_true 

#Guess what? All your contrasts and levels reset. So we gotta do it again. MAKE SURE THIS IS IDENTICAL TO WHAT WAS DONE ABOVE TO Bout.Analysis2_true!!! There's probably a better way to do this but shrug.
data.analysis_true$Solution<-factor(data.analysis_true$Solution,levels=sol.levels.contr)
data.analysis_true$group_shrt<-factor(data.analysis_true$group_shrt,levels=group1.levels)   
data.analysis_true$Mouse<-factor(data.analysis_true$Mouse)
data.analysis_true$Sex<-factor(data.analysis_true$Sex,levels=c("Female","Male"))
data.analysis_true$Position<-factor(data.analysis_true$Position,levels=pos.levels)

contrasts(data.analysis_true$Sex) <- contr.Helmert(levels(data.analysis_true$Sex))
colnames(contrasts(data.analysis_true$Sex))<-c("[H.Male-Female]")
contrasts(data.analysis_true$Solution) <- my.simple
contrasts(data.analysis_true$Position) <- contr.Helmert(levels(data.analysis_true$Position))
colnames(contrasts(data.analysis_true$Position))<-c("[H.Last10-Middle]","[H.First10-Other]")


data.analysis_false<-bout.analysis2_false
data.analysis_false$Solution<-factor(data.analysis_false$Solution,levels=sol.levels.contr)  
data.analysis_false$group_shrt<-factor(data.analysis_false$group_shrt,levels=group1.levels)   
data.analysis_false$Mouse<-factor(data.analysis_false$Mouse)
data.analysis_false$Sex<-factor(data.analysis_false$Sex,levels=c("Female","Male"))
data.analysis_false$Position<-factor(data.analysis_false$Position,levels=pos.levels)

contrasts(data.analysis_false$Sex) <- contr.Helmert(levels(data.analysis_false$Sex))
colnames(contrasts(data.analysis_false$Sex))<-c("[H.Male-Female]")
contrasts(data.analysis_false$Solution) <- my.simple
contrasts(data.analysis_false$Position) <- contr.Helmert(levels(data.analysis_false$Position))
colnames(contrasts(data.analysis_false$Position))<-c("[H.Last10-Middle]","[H.First10-Other]")

##Morph bout.analysis into long format for time variables
bout.analysis2_true<-bout.analysis2_true %>% 	
  gather(key="time", value="signal", MeanBefore, MeanAfter, z2MeanBefore, z2MeanAfter)
bout.analysis2$time<-factor(bout.analysis2$time,levels=c("MeanBefore","MeanAfter","z2MeanBefore","z2MeanAfter")) 

#Set long-format groups
timepatt<-paste(c("Before","After"), collapse="|")

setDT(bout.analysis2_true)[,group:=paste(bout.analysis2_true$Sex,bout.analysis2_true$Solution,str_extract_all(bout.analysis2_true$time,timepatt),sep=" ")]

bout.analysis2_true$group<-factor(bout.analysis2_true$group,levels=group2.levels)



#Separate data sets for different forms of signal means 
bout.analysis2_true.mean<-filter(bout.analysis2_true,time=="MeanBefore"|time =="MeanAfter",preserve=TRUE) 
bout.analysis2_true.mean$time<-factor(bout.analysis2_true.mean$time,levels=c("MeanBefore","MeanAfter")) 

bout.analysis2_true.meanz2<-filter(bout.analysis2_true,time=="z2MeanBefore"|time =="z2MeanAfter",preserve=TRUE) 
bout.analysis2_true.meanz2$time<-factor(bout.analysis2_true.meanz2$time,levels=c("z2MeanBefore","z2MeanAfter")) 

#Now set contrasts for time
#Check contrasts and change if desired:
#contrasts(bout.analysis2_true.mean$time)
#contrasts(bout.analysis2_true.meanz2$time)

contrasts(bout.analysis2_true.mean$time) <- contr.Helmert(levels(bout.analysis2_true.mean$time))
colnames(contrasts(bout.analysis2_true.mean$time))<-c("[H.After-Before]")

contrasts(bout.analysis2_true.meanz2$time) <- contr.Helmert(levels(bout.analysis2_true.meanz2$time)) 
colnames(contrasts(bout.analysis2_true.meanz2$time))<-c("[H.After-Before]")


# # ## Only once - compile these standardization means/sd and export to Excel
# std.params1<-merge(SignalMeans,Duration_means,by=c("Mouse"),suffixes=c(".1",".2"))
# std.params1<-merge(std.params1,LicksPerBout_means,by=c("Mouse"),suffixes=c(".2",".3"))
#  std.params1<-merge(std.params1,LickFrequency_means,by=c("Mouse"),suffixes=c(".3",".4"))
#  std.params2<-BoutStarts_means
# 
# std.params3<-merge(Duration_means_sex,LicksPerBout_means_sex,by=c("Sex"),suffixes=c(".1",".2"))
# std.params3<-merge(std.params3,LickFrequency_means_sex,by=c("Sex"),suffixes=c(".2",".3"))
# 
# std.params4<-merge(Duration_means_grp,Lick_means_grp,by=c("group_shrt"),suffixes=c(".1",".2"))
# std.params4<-merge(std.params4,LickFrequency_means_grp,by=c("group_shrt"),suffixes=c(".2",".3"))
# 
# std.params5<-merge(Duration.sol_means,Lick.sol_means,by=c("Solution","Mouse"),suffixes=c(".1",".2"))
# std.params5<-merge(std.params5,LickFrequency.sol_means, by=c("Solution","Mouse"),suffixes=c(".3",".4"))
# 
# std.params6<-merge(Duration.sol_means2,Lick.sol_means2,by=c("Solution"),suffixes=c(".1",".2"))
# std.params6<-merge(std.params6,LickFrequency.sol_means2,by=c("Solution"),suffixes=c(".3",".4"))
# 
# 
# #Export Standardization Parameters - CL20
# filedesc<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout StandardizationParams_HalfSolutions.xlsx"
# 
# write.xlsx(std.params1,file=filedesc,sheetName = "Most_Variables",append=TRUE)
# write.xlsx(std.params2,file=filedesc,sheetName = "BoutStarts",append=TRUE)
# write.xlsx(std.params3,file=filedesc,sheetName = "Sex_Centered",append=TRUE)
# write.xlsx(std.params4,file=filedesc,sheetName = "Group_Centered",append=TRUE)
# write.xlsx(std.params5,file=filedesc,sheetName = "Sol_Centered",append=TRUE)
# write.xlsx(std.params6,file=filedesc,sheetName = "Sol_Centered_Means",append=TRUE)
# 
# remove(z2meanbeforeafter,timepatt,temp,LickFrequency_means,LickFrequency_means_sex,LickFrequency_means_grp,LicksPerBout_means,LicksPerBout_means_sex,Lick_means_grp,Duration_means,Duration_means_sex,Duration_means_grp,BoutStarts_means,std.params1,std.params2,std.params3,std.params4,std.params5,std.params6,Lick.sol_means,Lick.sol_means2,LickFrequency.sol_means,LickFrequency.sol_means2,Duration.sol_means,Duration.sol_means2)

# Without the variables for export
remove(z2meanbeforeafter,timepatt,temp,LickFrequency_means,LickFrequency_means_sex,LickFrequency_means_grp,LicksPerBout_means,LicksPerBout_means_sex,Lick_means_grp,Duration_means,Duration_means_sex,Duration_means_grp,BoutStarts_means,Lick.sol_means,Lick.sol_means2,LickFrequency.sol_means,LickFrequency.sol_means2,Duration.sol_means,Duration.sol_means2,temp.h2o,temp.qhcl,zkey)
```

# BOUT LEVEL ANALYSIS

## 1) Assemble & Get Descriptive Statistics

First, let's get descriptive statistics! This is really important to be able to start to understand our data AND verify that the data was read in correctly.

```{r}
subject.analysis<-data.analysis_true %>%
    group_by(Sex,Mouse,subject,Solution,group_shrt) %>%
    get_summary_stats(any_of(myorder))


group.analysis<-data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats()

data.analysis_true_long<-gather(data.analysis_true,variable,value,-any_of(corevars),factor_key=TRUE)

data.analysis_true_long$variable<-factor(data.analysis_true_long$variable)

# Unstandardized Signal
indvsignalsummary<-bout.analysis2_true.mean %>%
  group_by(Sex,Solution,Mouse,time) %>%
  get_summary_stats('signal', type = "mean_se")
indvsignalsummary$Mouse<-factor(indvsignalsummary$Mouse)

subsignalsummary<-indvsignalsummary %>%  #Used to find outliers in signal irrespective of group
    group_by(Sex,Mouse) %>%
    get_summary_stats('mean', type = "mean_se")

grpsignalsummary<-indvsignalsummary %>%
	group_by(Sex,Solution,time) %>%
	get_summary_stats('mean', type = "mean_se")

# Standardized Signal #Comment out z1 variables for CL20
# indvsignalsummaryz1<-bout.analysis2_true.meanz1 %>%
#   group_by(Sex,Solution,Mouse,time) %>%
#   get_summary_stats('signal', type = "mean_se")
# indvsignalsummaryz1$Mouse<-factor(indvsignalsummaryz1$Mouse)
# 
# subsignalsummaryz1<-indvsignalsummaryz1 %>%  #Used to find outliers in signal irrespective of group
#     group_by(Sex,Mouse) %>%
#     get_summary_stats('mean', type = "mean_se")
# 
# grpsignalsummaryz1<-indvsignalsummaryz1 %>%
# 	group_by(Sex,Solution,time) %>%
# 	get_summary_stats('mean', type = "mean_se")

indvsignalsummaryz2<-bout.analysis2_true.meanz2 %>%
  group_by(Sex,Solution,Mouse,time) %>%
  get_summary_stats('signal', type = "mean_se")
indvsignalsummaryz2$Mouse<-factor(indvsignalsummaryz2$Mouse)

subsignalsummaryz2<-indvsignalsummaryz2 %>%  #Used to find outliers in signal irrespective of group
    group_by(Sex,Mouse) %>%
    get_summary_stats('mean', type = "mean_se")

grpsignalsummaryz2<-indvsignalsummaryz2 %>%
	group_by(Sex,Solution,time) %>%
	get_summary_stats('mean', type = "mean_se")
```

## 2) Graph these variables to explore your data

```{r}
#Each beeswarm is a subject's average for all sessions and the group means are the larger symbols. Pick which variable to look at using the "var" variable. 

var<-c("BoutStarts")
ggplot(data=subset(subject.analysis,variable==var),aes(x=group,y=mean), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=2,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=subset(group.analysis,variable==var),aes(x=group,y=mean,shape=Sex),size=2,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(expand = expansion(0.5))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical", legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=10,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y=var)+guides(color=guide_legend(override.aes = list(size=4)))


#Each beeswarm is a single bout - Bout Characteristics - All Bouts & Group Avgs
var<-c("BoutStarts")
r<-ggplot(data=data.analysis_true,aes(x=group_shrt,y=!!sym(var)), group= factor(group_shrt)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=subset(group.analysis,variable==var),aes(x=group_shrt,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=element_blank(),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y=var)+guides(color=guide_legend(override.aes = list(size=4)))

r

#Investigating outlying signals
ggplot(data=data.analysis_true, group_shrt= factor(group_shrt)) +theme_classic()+facet_wrap(~Solution*Sex)+geom_bar(stat="density",aes(x=z1MeanBefore,color=Solution,fill=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+scale_y_continuous(expand = expansion(0.2))+scale_x_continuous(n.breaks=10)+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="z1 Signal Normality",x="z1 Mean Before", y="Frequency")+guides(color=guide_legend(override.aes = list(size=4))) 

ggplot(data=data.analysis_true, group_shrt= factor(group_shrt)) +theme_classic()+facet_wrap(~Solution*Sex)+geom_bar(stat="density",aes(x=z1MeanAfter,color=Solution,fill=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+scale_y_continuous(expand = expansion(0.2))+scale_x_continuous(n.breaks=10)+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="z1 Signal Normality",x="z1 Mean After", y="Frequency")+guides(color=guide_legend(override.aes = list(size=4))) 


ggplot(data=data.analysis_true, group_shrt= factor(group_shrt)) +theme_classic()+facet_wrap(~Solution*Sex)+geom_bar(stat="density",aes(x=z2MeanBefore,color=Solution,fill=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+scale_y_continuous(expand = expansion(0.2))+scale_x_continuous(n.breaks=10)+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="z2 Signal Normality",x="z2 Mean Before", y="Frequency")+guides(color=guide_legend(override.aes = list(size=4))) 

ggplot(data=data.analysis_true, group_shrt= factor(group_shrt)) +theme_classic()+facet_wrap(~Solution*Sex)+geom_bar(stat="density",aes(x=z2MeanAfter,color=Solution,fill=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+scale_y_continuous(expand = expansion(0.2))+scale_x_continuous(n.breaks=10)+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="z2 Signal Normality",x="z2 Mean After", y="Frequency")+guides(color=guide_legend(override.aes = list(size=4))) 
```

## 3) Test Assumptions of GLM

Test Assumptions of GLM statistical tests (like ANOVAs) and detect outliers in the signal data or in groups.

### a) Non-standardized signal

```{r}
##GLOBAL OUTLIERS
#Grubbs method of detecting outliers globally - investigating subject outliers by looking at avg dF/F for all substances before and after within subject
outliersglob1<-grubbs.test(subsignalsummary$mean,type=10,two.sided=TRUE)

#Grubbs method of detecting outliers globally - all bout mean before signals
outliersglob2<-grubbs.test(data.analysis_true$MeanBefore,type=10,two.sided=TRUE)

#Grubbs method of detecting outliers globally - all bout mean after signals
outliersglob3<-grubbs.test(data.analysis_true$MeanAfter,type=10,two.sided=TRUE)

#Outlying points within a subject
outlierssub1<-bout.analysis2_true.mean %>%
  group_by(Mouse)%>%  
  identify_outliers('signal') 


##GROUP OUTLIERS
#Grubbs method of detecting outliers with groupings - subsetted by Sex, MeanBefore
outliers1<-data.analysis_true %>%
  group_by(Sex)%>%  
  identify_outliers('MeanBefore') 
outliers1<-cbind(outliers1,"Grouped Var"=c(rep("Sex - MeanBefore",nrow(outliers1))))

#Grubbs method of detecting outliers with groupings - subsetted by Sex, MeanAfter
outliers2<-data.analysis_true %>%
  group_by(Sex)%>%  
  identify_outliers('MeanAfter') 
outliers2<-cbind(outliers2,"Grouped Var"=c(rep("Sex- MeanAfter",nrow(outliers2))))

#Grubbs method of detecting outliers with groupings- subsetted by Solution, MeanBefore
outliers3<-data.analysis_true %>%
  group_by(Solution) %>%  
  identify_outliers('MeanBefore') 
outliers3<-cbind(outliers3,"Grouped Var"=c(rep("Solution,MeanBefore",nrow(outliers3))))                                           

#Grubbs method of detecting outliers with groupings- subsetted by Solution, MeanAfter
outliers4<-data.analysis_true %>%
  group_by(Solution) %>%  
  identify_outliers(c('MeanAfter')) 
outliers4<-cbind(outliers4,"Grouped Var"=c(rep("Solution,MeanAfter",nrow(outliers4))))    

#Grubbs method of detecting outliers with groupings- subsetted by Sex, Solution, time
outliers5<-data.analysis_true %>%
  group_by(Sex,Solution) %>%  
  identify_outliers('MeanBefore') 
outliers5<-cbind(outliers5,"Grouped Var"=c(rep("Sex,Solution - MeanBefore",nrow(outliers5))))

#Grubbs method of detecting outliers with groupings- subsetted by Sex, Solution, time
outliers6<-data.analysis_true %>%
  group_by(Sex,Solution) %>%  
  identify_outliers('MeanAfter') 
outliers6<-cbind(outliers6,"Grouped Var"=c(rep("Sex,Solution - MeanAfter",nrow(outliers6))))

#Grubbs method of detecting outliers globally in bout characteristics
outliers7<-data.analysis_true %>%
  identify_outliers('BoutDuration') 
outliers7<-cbind(outliers7,"Grouped Var"=c(rep("Ungrouped",nrow(outliers7))))
outliers8<-data.analysis_true %>%
  identify_outliers('LickFrequency') 
outliers8<-cbind(outliers8,"Grouped Var"=c(rep("Ungrouped",nrow(outliers8))))
outliers9<-data.analysis_true %>%
  identify_outliers('LicksPerBout') 
outliers9<-cbind(outliers9,"Grouped Var"=c(rep("Ungrouped",nrow(outliers9))))


#Boxplot method of detecting outliers - individual bouts
bxp <- ggboxplot(indvsignalsummary, x = "time", y = "mean", add = "point", facet.by="Solution", order=c("MeanBefore","MeanAfter"))
bxp

#Test for normality
shapiro_test<-indvsignalsummary %>%
  group_by(Sex,Solution,time) %>%
  shapiro_test(mean)

#Test for equality of variances for the BETWEEN-SUBJECTS variable at every level of the WITHIN-SUBJECTS Variables. If there are two between, separate them by "*" in the test.
levene_test<- indvsignalsummary %>%
	group_by(time,Solution) %>%
	levene_test(mean ~ Sex)

##CL Can't figure out which vars to test against sex - need to think about more. 
#Test for equality of co-variances for the BETWEEN-SUBJECTS variable
#box_m(bout.analysis2_true.mean[, "", drop = FALSE], bout.analysis2_true.mean[,"Sex"]) #Just make note if significant -> there's a lot of "IF"s to interpreting this if violated

#Graph it
#ggqqplot(indvsignalsummary, "mean", facet.by = c("Sex","Solution")) #Use if only 1-2 variables, otherwise use code below

ggqqplot(indvsignalsummary, "mean", ggtheme = theme_bw()) +
  facet_grid(Sex + Solution ~ time, labeller = "label_both")

```

### b) Standardized signal

```{r}
##GLOBAL OUTLIERS
#Grubbs method of detecting outliers globally - investigating subject outliers by looking at avg zdF/F for all substances before and after within subject
outliersglob1z<-grubbs.test(subsignalsummaryz2$mean,type=10,two.sided=TRUE)

#Grubbs method of detecting outliers globally - all bout mean before signals
outliersglob2z<-grubbs.test(data.analysis_true$z2MeanBefore,type=10,two.sided=TRUE)
#Grubbs method of detecting outliers globally - all bout mean after signals
outliersglob3z<-grubbs.test(data.analysis_true$z2MeanAfter,type=10,two.sided=TRUE)

#Outlying points within a subject
outlierssub1z<-bout.analysis2_true.meanz2 %>%
  group_by(Mouse)%>%  
  identify_outliers('signal') 



##GROUP OUTLIERS
#Grubbs method of detecting outliers with groupings - subsetted by Sex, z2MeanBefore
outliers1z<-data.analysis_true %>%
  group_by(Sex)%>%  
  identify_outliers('z2MeanBefore') 
outliers1z<-cbind(outliers1z,"Grouped Var"=c(rep("Sex - z2MeanBefore",nrow(outliers1z))))

#Grubbs method of detecting outliers with groupings - subsetted by Sex, z2MeanAfter
outliers2z<-data.analysis_true %>%
  group_by(Sex)%>%  
  identify_outliers('z2MeanAfter') 
outliers2z<-cbind(outliers2z,"Grouped Var"=c(rep("Sex- z2MeanAfter",nrow(outliers2z))))

#Grubbs method of detecting outliers with groupings- subsetted by Solution, z2MeanBefore
outliers3z<-data.analysis_true %>%
  group_by(Solution) %>%  
  identify_outliers('z2MeanBefore') 
outliers3z<-cbind(outliers3z,"Grouped Var"=c(rep("Solution,z2MeanBefore",nrow(outliers3z))))                                           

#Grubbs method of detecting outliers with groupings- subsetted by Solution, MeanAfter
outliers4z<-data.analysis_true %>%
  group_by(Solution) %>%  
  identify_outliers(c('z2MeanAfter')) 
outliers4z<-cbind(outliers4z,"Grouped Var"=c(rep("Solution,z2MeanAfter",nrow(outliers4z))))    

#Grubbs method of detecting outliers with groupings- subsetted by Sex, Solution, time
outliers5z<-data.analysis_true %>%
  group_by(Sex,Solution) %>%  
  identify_outliers('z2MeanBefore') 
outliers5z<-cbind(outliers5z,"Grouped Var"=c(rep("Sex,Solution - z2MeanBefore",nrow(outliers5z))))

#Grubbs method of detecting outliers with groupings- subsetted by Sex, Solution, time
outliers6z<-data.analysis_true %>%
  group_by(Sex,Solution) %>%  
  identify_outliers('z2MeanAfter') 
outliers6z<-cbind(outliers6z,"Grouped Var"=c(rep("Sex,Solution - z2MeanAfter",nrow(outliers6z))))

#Boxplot method of detecting outliers - individual bouts
bxpz <- ggboxplot(indvsignalsummaryz2, x = "time", y = "mean", add = "point", facet.by=c("Solution","Sex"), order=c("z2MeanBefore","z2MeanAfter"))
bxpz

#Test for normality
shapiro_testz<-indvsignalsummaryz2 %>%
  group_by(Sex,Solution,time) %>%
  shapiro_test(mean)

#Test for equality of variances for the BETWEEN-SUBJECTS variable at every level of the WITHIN-SUBJECTS Variables. If there are two between, separate them by "*" in the test.
levene_testz<- indvsignalsummaryz2 %>%
	group_by(time,Solution) %>%
	levene_test(mean ~ Sex)
  #levene_test(mean~Solution)
##CL Can't figure out which vars to test against sex - need to think about more. 
#Test for equality of co-variances for the BETWEEN-SUBJECTS variable
#box_m(bout.analysis2_true.mean[, "", drop = FALSE], bout.analysis2_true.mean[,"Sex"]) #Just make note if significant -> there's a lot of "IF"s to interpreting this if violated

#Graph it
#ggqqplot(indvsignalsummary, "mean", facet.by = c("Sex","Solution")) #Use if only 1-2 variables, otherwise use code below

ggqqplot(indvsignalsummaryz2, "mean", ggtheme = theme_bw()) +
  facet_grid(Sex + Solution ~ time, labeller = "label_both")

```

## 4) Export your descriptive statistics including summaries and assumption testing to an Excel File for records and sharing

```{r}
#Run this the first time through
filedesc<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Descriptive Stats HALF SOLUTIONS.xlsx"

##Run this after you have removed outliers and repeated analysis
#filedesc<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Descriptive Stats_OutliersRemoved.xlsx"

##Final Pub Data - only the first few solutions
#filedesc<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Descriptive Stats_FinalPubData.xlsx"

write.xlsx(subject.analysis,file=filedesc,sheetName = "Subject.Analysis",append=TRUE)
write.xlsx(group.analysis,file=filedesc,sheetName = "Group.Analysis",append=TRUE)

write.xlsx(indvsignalsummary,file=filedesc,sheetName = "Indv_Signal_Means",append=TRUE)

write.xlsx(subsignalsummary,file=filedesc,sheetName = "Sub_Signal_Means", append=TRUE)

write.xlsx(grpsignalsummary,file=filedesc,sheetName = "Grp_Signal_Means",append=TRUE)

x<-c("Data","Method","G-Statistic","U-Statistic","p-value","Outlier")
y1<-c(outliersglob1$data.name,outliersglob1$method,outliersglob1$statistic[["G"]],outliersglob1$statistic[["U"]],outliersglob1$p.value,outliersglob1$alternative)

y2<-c(outliersglob2$data.name,outliersglob2$method,outliersglob2$statistic[["G"]],outliersglob2$statistic[["U"]],outliersglob2$p.value,outliersglob2$alternative)
outlierexport<-data.frame(x,y1,y2)

outlierexport2<-rbind(outliers1,outliers2,outliers3,outliers4,outliers5,outliers6,outliers7,outliers8,outliers9)

write.xlsx(outlierexport,file=filedesc,sheetName = "GlobalOutlierTests",append=TRUE)

write.xlsx(outlierssub1,file=filedesc,sheetName="Within Subject Outliers",append=TRUE)

write.xlsx(outlierexport2,file=filedesc,sheetName = "GroupOutlierTests",append=TRUE)

#write.xlsx(shapiro_test,file=filedesc,sheetName = "NormalityTest",append=TRUE)

write.xlsx(levene_test,file=filedesc,sheetName = "HOVTest",append=TRUE)
##########################################################
#Repeat for z-scored data

#write.xlsx(subject.analysis,file=filedesc,sheetName = "zSubject.Analysis",append=TRUE) #Is the same as non-standardized

#write.xlsx(group.analysis,file=filedesc,sheetName = "zGroup.Analysis",append=TRUE) #Is the same as non-standardized

write.xlsx(indvsignalsummaryz2,file=filedesc,sheetName = "z2Indv_Signal_Means",append=TRUE)

write.xlsx(subsignalsummaryz2,file=filedesc,sheetName = "z2Sub_Signal_Means", append=TRUE)

write.xlsx(grpsignalsummaryz2,file=filedesc,sheetName = "z2Grp_Signal_Means",append=TRUE)

x<-c("Data","Method","G-Statistic","U-Statistic","p-value","Outlier")
y1<-c(outliersglob1z$data.name,outliersglob1z$method,outliersglob1z$statistic[["G"]],outliersglob1z$statistic[["U"]],outliersglob1z$p.value,outliersglob1z$alternative)

y2<-c(outliersglob2z$data.name,outliersglob2z$method,outliersglob2z$statistic[["G"]],outliersglob2z$statistic[["U"]],outliersglob2z$p.value,outliersglob2z$alternative)

outlierexportz<-data.frame(x,y1,y2)

outlierexport2z<-rbind(outliers1z,outliers2z,outliers3z,outliers4z,outliers5z,outliers6z,outliers7,outliers8,outliers9)

write.xlsx(outlierexportz,file=filedesc,sheetName = "z2GlobalOutlierTests",append=TRUE)

write.xlsx(outlierssub1z,file=filedesc,sheetName="z2Within Subject Outliers",append=TRUE)

write.xlsx(outlierexport2z,file=filedesc,sheetName = "z2GroupOutlierTests",append=TRUE)

#write.xlsx(shapiro_testz,file=filedesc,sheetName = "z2NormalityTest",append=TRUE)

#write.xlsx(levene_testz,file=filedesc,sheetName = "z2HOVTest",append=TRUE)
```

## 5) Filter out outliers found in the previous analysis by modifying code in Data Preparation 4) and 5) and then run Bout Level Analysis again to re-check assumptions

## 6) Export Final Bout Data

This may seem tedious, but trust me, you'll want a record.

```{r}
filedesc<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Raw FINALDATA_HalfSolutions.xlsx"

write.xlsx(data.analysis_true,file=filedesc,sheetName = "TrueBout_Filtered_Data",append=TRUE)
write.xlsx(data.analysis_false,file=filedesc,sheetName = "Excluded_by_TrueBout",append=TRUE)
```

## 7) Clear Unnecessary Variables

Once you've graphed everything you'd like this helps reduce memory usage and your overall list of environmental variables to look through.

```{r}
remove(x,y1,y2,meanbeforeafter,peakbeforeafter,pmeanbeforeafter,end.onset,temp,group.analysis_avgs.bouts,group.analysis_avgs.licks,outlierssub1,outliersglob3z,outlierssub1z,shapiro_test,shapiro_testz,subsignalsummary,subsignalsummaryz1,subsignalsummaryz2,subject.analysis_avgs.licks,subject.analysis_avgs.bout,subject.analysis_avgs,group.analysis_avgs,SignalMeans.h2o,SignalMeans.qhcl,outlierexport,outlierexport2,outlierexport2z,outlierexportz,outliers1,outliers2,outliers3,outliers4,outliers5,outliers6,outliers7,outliers8,outliers9,outliers1z,outliers2z,outliers3z,outliers4z,outliers5z,outliers6z,outliersglob1,outliersglob1z,outliersglob2,outliersglob2z,outliersglob3,levene_test,levene_testz,indvsignalsummaryz2,indvsignalsummaryz1,indvsignalsummary,grpsignalsummaryz1,grpsignalsummaryz2,grpsignalsummary,group.analysis,bxp,bxpz,subject.analysis)
```

# SESSION LEVEL ANALYSIS

This section takes the Bout Analysis data and gets session-wise measures that can be combined with drinking data from that session.

## 1) Assemble & Get Descriptive Statistics

```{r}
data.analysis_true$Bout<-as.numeric(as.character(data.analysis_true$Bout)) 
data.analysis_true$Mouse<-as.numeric(as.character(data.analysis_true$Mouse)) 

myorder3<-myorder[myorder !="Position"]

session.analysis<-data.analysis_true %>%
  group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>%
  reframe(across(any_of(myorder3),c(mean=mean,se=std.error,min=min,max=max)))

session.analysis.bout<-data.analysis_true %>%
    group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>%
    summarise_at(vars("Bout"),list(TotalBouts=length))

session.analysis.licks<-data.analysis_true %>%
    group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>%
    summarise_at(vars("LicksPerBout","BoutDuration"),list(Total=sum,Max=max))

session.analysis.order<-data.analysis_true %>%
    group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>%
    summarise_at(vars("Output.Order"),list(OutputOrder_Start=min)) 

session.analysis2<-merge.data.frame(session.analysis,session.analysis.bout,by=c("group_shrt","session","Mouse","subject","Solution","Sex","Channel","FileName"))
session.analysis2<-merge.data.frame(session.analysis2,session.analysis.licks,by=c("group_shrt","session","Mouse","subject","Solution","Sex","Channel","FileName"))
session.analysis2<-merge.data.frame(session.analysis2,session.analysis.order,by=c("group_shrt","session","Mouse","subject","Solution","Sex","Channel","FileName"))


data.analysis_true.sort<-sort_df(data.analysis_true, c('Output.Order','group_shrt','Sex','FileName','Channel','Solution','session','Mouse','subject'))
session.analysis2<-sort_df(session.analysis2, c('OutputOrder_Start','group_shrt','Sex','FileName','Channel','Solution','session','Mouse','subject'))


##Check that each are sorted the same by checking session run values. All should say "TRUE"
rle(session.analysis2$Mouse)$values==rle(data.analysis_true.sort$Mouse)$values

```

## 2) Export Prelim Session Data

Note that the variable name followed by \$y is the mean and \$ymin and \$ymax are the mean minus or plus the standard error, respectively.

```{r}
file3<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Session Descriptive Stats_Half Solutions.xlsx"

write.xlsx(as.data.frame(session.analysis2),file=file3,sheetName = "SessionData",append=TRUE)

write.xlsx(data.analysis_true.sort,file=file3,sheetName = "IndvBoutData",append=TRUE)
```

## 3) Fill in Drinking Data

Open the file created in the previous step and fill in your drinking data for each session. CRITICAL: KEEP SORTED AS IS! SORT DRINKING DATA INSTEAD TO MATCH. Sorting by 'FileName' then 'Channel' should do it. For CL20, added a EtOH.gkg column header even though no data to go there in final dataset (left blank).

## \*4) Import Updated Session Data File

\*If using QUICKSTART path, run both code blocks. If not, run just the bottom.

```{r}
file3<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Session Descriptive Stats_Half Solutions.xlsx"
```

```{r}
session.analysis3<-read.xlsx(file3, sheetName='SessionData',header = TRUE)

session.analysis3$Solution<-factor(session.analysis3$Solution,levels=sol.levels.contr)
contrasts(session.analysis3$Solution)<-my.simple

session.analysis3$Sex<-factor(session.analysis3$Sex,levels=c("Female","Male"))
contrasts(session.analysis3$Sex)<-contr.Helmert(levels(session.analysis3$Sex))
colnames(contrasts(session.analysis3$Sex))<-c("[H.Male-Female]")

session.analysis3$group_shrt<-factor(session.analysis3$group_shrt,levels=group1.levels)
```

## \*5) Get Session Summary Data

We will export this and use it for all of the publishable bar graphs.

```{r}
##Get Omnibus Subject Summaries######
myorder2<-paste(myorder,"_mean",sep="")
myorder2<-c(myorder2,"Drinking.mL.kg","EtOH.gkg")

#Since we don't too much care about the previous se, min, max when averaging up the next level, we can use reframe () to select just the mean columns.
subject.analysis_avgs<-session.analysis3 %>%
    group_by(group_shrt,Mouse,subject,Solution,Sex) %>%
    reframe(across(any_of(myorder2)))

subject.analysis_avgs.bout<-session.analysis3 %>%
    group_by(group_shrt,Mouse,subject,Solution,Sex) %>%
    summarise_at(vars("TotalBouts","LicksPerBout_Total","BoutDuration_Total"),list(Total=sum))

subject.analysis_avgs.licks<-session.analysis3 %>%
    group_by(group_shrt,Mouse,subject,Solution,Sex) %>%
    summarise_at(vars("LicksPerBout_Max","BoutDuration_Max"),list(Max=max))

subject.analysis_avgs2<-subject.analysis_avgs %>%
  group_by(Mouse,Solution,Sex,subject,group_shrt) %>%
  reframe(across(any_of(myorder2),list(mean=mean,se=std.error),.unpack=TRUE))

subject.analysis_avgs2<-merge.data.frame(subject.analysis_avgs2,subject.analysis_avgs.bout,by=c("group_shrt","Mouse","subject","Solution","Sex"))
subject.analysis_avgs2<-merge.data.frame(subject.analysis_avgs2,subject.analysis_avgs.licks,by=c("group_shrt","Mouse","subject","Solution","Sex"))

subject.analysis_avgs2$group_shrt<-factor(subject.analysis_avgs2$group_shrt,levels=c(group1.levels)) #Sets the order as desired for graphing
subject.analysis_avgs2$Sex<-factor(subject.analysis_avgs2$Sex)



##Get Omnibus Group Summaries######
myorder4<-paste(myorder2,"_mean",sep="")

group.analysis_avgs<-subject.analysis_avgs2 %>%
    group_by(group_shrt,Solution,Sex) %>%
    reframe(across(any_of(myorder4)))

group.analysis_avgs.bouts<-subject.analysis_avgs2 %>%
    group_by(group_shrt,Solution,Sex) %>%
    summarise_at(vars("TotalBouts_Total","LicksPerBout_Total_Total","BoutDuration_Total_Total"),list(Total=sum))

group.analysis_avgs.licks<-subject.analysis_avgs2 %>%
    group_by(group_shrt,Solution,Sex) %>%
    summarise_at(vars("LicksPerBout_Max_Max","BoutDuration_Max_Max"),list(Max=max))

group.analysis_avgs2<-group.analysis_avgs %>%
  group_by(group_shrt,Solution,Sex) %>%
  reframe(across(any_of(myorder4),list(mean=mean,se=std.error),.unpack=TRUE))

group.analysis_avgs2<-merge.data.frame(group.analysis_avgs2,group.analysis_avgs.bouts,by=c("group_shrt","Solution","Sex"))
group.analysis_avgs2<-merge.data.frame(group.analysis_avgs2,group.analysis_avgs.licks,by=c("group_shrt","Solution","Sex"))


subject.analysis_avgs2$Solution<-factor(subject.analysis_avgs2$Solution,levels=sol.levels.contr)
contrasts(subject.analysis_avgs2$Solution)<-my.simple
subject.analysis_avgs2$Sex<-factor(subject.analysis_avgs2$Sex,levels=c("Female","Male"))
contrasts(subject.analysis_avgs2$Sex)<-contr.Helmert(levels(subject.analysis_avgs2$Sex))
colnames(contrasts(subject.analysis_avgs2$Sex))<-c("[H.Male-Female]")


subject.analysis_avgs2$group_shrt<-factor(subject.analysis_avgs2$group_shrt,levels=group1.levels)
```

## 6) Export Final Session Summary Data

```{r}
write.xlsx(session.analysis3,file=file3,sheetName = "Session_Means",append=TRUE)

write.xlsx(subject.analysis_avgs2,file=file3,sheetName = "Subject_Means",append=TRUE)

write.xlsx(group.analysis_avgs2,file=file3,sheetName = "Group_Means",append=TRUE)
```

# STATISTICS: 3-Way ANOVA With Interactions

## \*1) Initial Setup

Our data for session, subject and group averages are still in wide format so we need to melt it to get a single variable, "signal", that has a time factor (Mean Before vs Mean After).

```{r}
##Specify path of the output file - heads up that this will be used for all the statistical outputs from this point on!!!
#filemod<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout ANOVA Results.xlsx"

filemod<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout ANOVA Results.xlsx"


#OR 

#filemod<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout ANOVA Results_OutlierRemoved.xlsx"

#or

#filemod<-"Z:/Christina Lebonville/2020.06.16 (CL8 or DRK-MK) CeA Dyn Fiber Recording in DID/Fiber Photometry Data/DeepEthogram_TrueBout_Analysis_FinalData/CL8 Joint_TrueBout ANOVA Results_Outlierand8.22Removed.xlsx"

#OR

#filemod<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Session ANOVA Results_PubData.xlsx"

## Next we create two averaged datasets - "Session.analysis4" which is averaged by session, "Subject.analysis2" which is averaged by Mouse. Each is gathered into long data formats (either regular signal, z1 signal, or z2 signal) and factors/contrasts reset.

session.analysis4<-session.analysis3 %>%
  gather(key="time", value="signal", MeanBefore_mean, MeanAfter_mean, z1MeanBefore_mean,z1MeanAfter_mean,z2MeanBefore_mean,z2MeanAfter_mean)
session.analysis4$time<-factor(session.analysis4$time,levels=c("MeanBefore_mean","MeanAfter_mean","z1MeanBefore_mean","z1MeanAfter_mean","z2MeanBefore_mean","z2MeanAfter_mean")) 

session.analysis4$Mouse<-factor(session.analysis4$Mouse, levels=c(1:25))

session.analysis4.mean<-filter(session.analysis4,time=="MeanBefore_mean" |time== "MeanAfter_mean",preserve=TRUE)
session.analysis4.meanz1<-filter(session.analysis4,time=="z1MeanBefore_mean" |time== "z1MeanAfter_mean",preserve=TRUE)
session.analysis4.meanz2<-filter(session.analysis4,time=="z2MeanBefore_mean" |time== "z2MeanAfter_mean",preserve=TRUE)

# Re-Set Factor Levels
session.analysis4.mean$time<-factor(session.analysis4.mean$time,levels=c("MeanBefore_mean","MeanAfter_mean"))
session.analysis4.meanz1$time<-factor(session.analysis4.meanz1$time,levels=c("z1MeanBefore_mean","z1MeanAfter_mean")) 
session.analysis4.meanz2$time<-factor(session.analysis4.meanz2$time,levels=c("z2MeanBefore_mean","z2MeanAfter_mean")) 

# Re-Set Contrasts
contrasts(session.analysis4.mean$Sex) <- contr.Helmert(levels(session.analysis4.mean$Sex))
colnames(contrasts(session.analysis4.mean$Sex))<-c("[H.Male-Female]")
contrasts(session.analysis4.mean$Solution) <- my.simple
contrasts(session.analysis4.mean$time) <- contr.Helmert(levels(session.analysis4.mean$time))
colnames(contrasts(session.analysis4.mean$time))<-c("[H.After-Before]")

contrasts(session.analysis4.meanz1$Sex) <- contr.Helmert(levels(session.analysis4.meanz1$Sex))
colnames(contrasts(session.analysis4.meanz1$Sex))<-c("[H.Male-Female]")
contrasts(session.analysis4.meanz1$Solution) <- my.simple
contrasts(session.analysis4.meanz1$time) <- contr.Helmert(levels(session.analysis4.meanz1$time))
colnames(contrasts(session.analysis4.meanz1$time))<-c("[H.After-Before]")

contrasts(session.analysis4.meanz2$Sex) <- contr.Helmert(levels(session.analysis4.meanz2$Sex))
colnames(contrasts(session.analysis4.meanz2$Sex))<-c("[H.Male-Female]")
contrasts(session.analysis4.meanz2$Solution) <- my.simple
contrasts(session.analysis4.meanz2$time) <- contr.Helmert(levels(session.analysis4.meanz2$time))
colnames(contrasts(session.analysis4.meanz2$time))<-c("[H.After-Before]")

####################################################################


subject.analysis2<-subject.analysis_avgs2 %>% 	
  gather(key="time", value="signal", MeanBefore_mean_mean, MeanAfter_mean_mean, z1MeanBefore_mean_mean, z1MeanAfter_mean_mean,z2MeanBefore_mean_mean, z2MeanAfter_mean_mean)

subject.analysis2$time<-factor(subject.analysis2$time,levels=c("MeanBefore_mean_mean","MeanAfter_mean_mean","z2MeanBefore_mean_mean","z2MeanAfter_mean_mean")) 
subject.analysis2$Mouse<-factor(subject.analysis2$Mouse, levels=c(1:25))

subject.analysis2.mean<-filter(subject.analysis2,time=="MeanBefore_mean_mean" |time== "MeanAfter_mean_mean",preserve=TRUE)
subject.analysis2.meanz1<-filter(subject.analysis2,time=="z1MeanBefore_mean_mean" |time== "z1MeanAfter_mean_mean",preserve=TRUE)
subject.analysis2.meanz2<-filter(subject.analysis2,time=="z2MeanBefore_mean_mean" |time== "z2MeanAfter_mean_mean",preserve=TRUE)

# Re-Set Factor Levels
subject.analysis2.mean$time<-factor(subject.analysis2.mean$time,levels=c("MeanBefore_mean_mean","MeanAfter_mean_mean"))
subject.analysis2.meanz1$time<-factor(subject.analysis2.meanz1$time,levels=c("z1MeanBefore_mean_mean","z1MeanAfter_mean_mean")) 
subject.analysis2.meanz2$time<-factor(subject.analysis2.meanz2$time,levels=c("z2MeanBefore_mean_mean","z2MeanAfter_mean_mean")) 

# Re-Set Contrasts
contrasts(subject.analysis2.mean$Sex) <- contr.Helmert(levels(subject.analysis2.mean$Sex))
colnames(contrasts(subject.analysis2.mean$Sex))<-c("[H.Male-Female]")
contrasts(subject.analysis2.mean$Solution) <- my.simple
contrasts(subject.analysis2.mean$time) <- contr.Helmert(levels(subject.analysis2.mean$time))
colnames(contrasts(subject.analysis2.mean$time))<-c("[H.After-Before]")


contrasts(subject.analysis2.meanz1$Sex) <- contr.Helmert(levels(subject.analysis2.meanz1$Sex))
colnames(contrasts(subject.analysis2.meanz1$Sex))<-c("[H.Male-Female]")
contrasts(subject.analysis2.meanz1$Solution) <- my.simple
contrasts(subject.analysis2.meanz1$time) <- contr.Helmert(levels(subject.analysis2.meanz1$time))
colnames(contrasts(subject.analysis2.meanz1$time))<-c("[H.After-Before]")

contrasts(subject.analysis2.meanz2$Sex) <- contr.Helmert(levels(subject.analysis2.meanz2$Sex))
colnames(contrasts(subject.analysis2.meanz2$Sex))<-c("[H.Male-Female]")
contrasts(subject.analysis2.meanz2$Solution) <- my.simple
contrasts(subject.analysis2.meanz2$time) <- contr.Helmert(levels(subject.analysis2.meanz2$time))
colnames(contrasts(subject.analysis2.meanz2$time))<-c("[H.After-Before]")
```

## 2) Basic ANOVA

```{r}
## For final data & modelling comparisions, decided to use only the z2 dataset

#Signal
anova.basic<-aov(signal ~ Sex*Solution*time, data=subject.analysis2.meanz2)
summary(anova.basic)

#plot(lm(anova.basic))

#Consumption
anova.basic2<-aov(Drinking.mL.kg_mean ~ Sex*Solution, data=subject.analysis2.meanz2)
summary(anova.basic2)

#plot(lm(anova.basic2))

#Duration
anova.basic3<-aov(BoutDuration_mean_mean ~ Sex*Solution, data=subject.analysis2.meanz2)

summary(anova.basic3)

```

## 3) Mouse-Nested ANOVAs

```{r}
## For final data & modelling comparisions, decided to use only the z2 dataset

#Each Mouse has Average for each Solution
anova.nested1<-aov(signal ~ Sex*Solution*time + Error(Mouse), data=subject.analysis2.meanz2)
summary(anova.nested1)
#plot(lm(anova.nested1))

#Each Mouse has Average for each Session
anova.nested2<-aov(signal ~ Sex*Solution*time + Error(Mouse), data=session.analysis4.meanz2)
summary(anova.nested2)
#plot(lm(anova.nested2))

#Each Mouse using all Bouts
anova.nested3<-aov(signal ~ Sex*Solution*time + Error(Mouse), data=bout.analysis2_true.meanz2)
summary(anova.nested3)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding Duration
anova.nested4<-aov(signal ~ Sex*Solution*time*Duration_sol_imc + Error(Mouse), data=bout.analysis2_true.meanz2)
summary(anova.nested4)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding position
anova.nested4<-aov(signal ~ Sex*Solution*time*Position+ Error(Mouse), data=bout.analysis2_true.meanz2)
summary(anova.nested4)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding position+Duration
anova.nested5<-aov(signal ~ Sex*Solution*time*Position*Duration_imc+ Error(Mouse), data=bout.analysis2_true.meanz2)
summary(anova.nested5)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding position+Duration
anova.nested5<-aov(signal ~ Sex*Solution*time*Position*Duration_imc+ Error(Mouse), data=bout.analysis2_true.meanz2)
summary(anova.nested5)
#plot(lm(anova.nested3))

#Each Mouse using all Bouts - adding position+Duration
anova.nested5<-aov(signal ~ Sex*Solution*time*Position*Duration_imc+ Error(Mouse), data=bout.analysis2_true.meanz2)
summary(anova.nested5)
#plot(lm(anova.nested3))

#
#For Consumption Only, for Each Session but Nested within Mouse
anova.nested6<-aov(Drinking.mL.kg ~ Sex*Solution + Error(Mouse), data=session.analysis4.meanz2)
summary(anova.nested6)
#plot(lm(anova.nested4))

#Each Mouse using all Bouts - BoutDuration
anova.nested7<-aov(BoutDuration ~ Sex*Solution + Error(Mouse), data=data.analysis_true)
summary(anova.nested7)
#plot(lm(anova.nested5))

#Each Mouse using all Bouts - LickFreq
anova.nested8<-aov(LickFrequency ~ Sex*Solution + Error(Mouse), data=data.analysis_true)
summary(anova.nested8)
#plot(lm(anova.nested6))

#Each Mouse has all Bouts - LicksPerBout
anova.nested9<-aov(LicksPerBout ~ Sex*Solution + Error(Mouse), data=data.analysis_true)
summary(anova.nested9)
#plot(lm(anova.nested7))

#Each Mouse has all Bouts - BoutDuration by first 10 last 10
anova.nested8<-aov(BoutDuration ~ Position*Sex*Solution, data=data.analysis_true)
summary(anova.nested8)
#plot(lm(anova.nested8))

#Each Mouse has all Bouts - LickFreq by Position
anova.nested9<-aov(LickFrequency ~ Position*Sex*Solution, data=data.analysis_true)
summary(anova.nested9)
#plot(lm(anova.nested9))

```

## 4) PostHoc Comparisons

```{r}
#Signal
tukey3<-emmeans(anova.nested3, list(pairwise ~ Solution*Sex*time), adjust = "tukey")

#Consumption
tukey4<-emmeans(anova.nested4, list(pairwise ~ Solution*Sex), adjust = "tukey")

#BoutDuration
tukey5<-emmeans(anova.nested5, list(pairwise ~ Solution*Sex), adjust = "tukey")

#LickFreq
tukey6<-emmeans(anova.nested6, list(pairwise ~ Solution*Sex), adjust = "tukey")
#LicksPerBout
tukey7<-emmeans(anova.nested7, list(pairwise ~ Solution*Sex), adjust = "tukey")

#BoutDuration First 10 Last 10
tukey8<-emmeans(anova.nested8, list(pairwise ~ Position*Solution*Sex), adjust = "tukey")

#LickFreq First 10 Last 10
tukey9<-emmeans(anova.nested9, list(pairwise ~ Position*Solution*Sex), adjust = "tukey")
#LicksPerBout First 10 Last 10
tukey10<-emmeans(anova.nested10, list(pairwise ~ Position*Solution*Sex), adjust = "tukey")

```

## 5) Model Diagnostics

```{r}
# Define model to investigate
model.diag <- lm(anova.nested3z)

#Residual plots, Q-Q Residuals, Scale-Location Plots, and Residual-Leverage Plots
plot(model.diag)

#Kolmogorov-Smirnov Tests for Normality in large sample sizes
ks.test(residuals(model.diag),y=pnorm)

#Effects plot
plot_model(model.diag, show.values = TRUE, vline.color = "black")


# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(model.diag, pbkrtest.limit = 5667, at=list(LickFrequency_imc=c(-2,0,2,4),LickFrequency_mc=c(-2.5,0,1.5), Duration_imc=c(-1,0,3.5,8), Duration_mc=c(-1,0,2.5),Drinking.mL.kg_imc=c(-4,-2,0,2)))

             
# Plot specific interactions
emmip(RG, Solution ~ LickFrequency_imc*Duration_imc | time*Sex, style = "factor", CIs=TRUE)

# Plot diagnostics for clustered models
#refit as lm manually (sorry no workaround)
data.nna<-na.omit(bout.analysis2_true.mean)
an3lm<-lm(signal~Sex*Solution*time,data=data.nna)
params<-names(coef(an3lm))
summclust_res<-summclust(obj=an3lm,params = params,cluster= ~ Mouse)
summary.lev<-summary(summclust_res)
plot(summclust_res$coef_estimates)
plot(summclust_res$leverage_g)
plot(summclust_res$cluster)
```

## 6) Export Statistic Test Results

```{r}
models<-ls(envir=.GlobalEnv,pattern="anova")  
models.call<-lapply(mget(models),get_call)  
for(x in names(models.call)){
  if(is.null(models.call[[x]])==TRUE){
    temp<-as.character(attributes(get(x))$call)
    models.call[x]<-paste0(temp[1],"(formula = ",temp[2],", data = ", temp[3],")")
  } 
}
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.info<-NULL
model.obs<-NULL  
model.obs.df<-NULL   
slice<-NULL
slice.df<-NULL
grps<-NULL

for(k in models){ 
  slice.df<-NULL
  info<-model_info(get(k))
  obs<-info$n_obs
  counts<-get_predictors(get(k))
  n<-lapply(counts, FUN="freq_table")
  m<-counts %>% unite("group.full",1:2)
  grps.temp1<-freq_table(m,group.full)
  grps.temp2<-grps.temp1 %>% unite(factor,group.full,n,sep=" ")
  grps<-toString(grps.temp2$factor)
  for (j in names(n)){
  slice.temp1<-n[[j]] %>% unite(factor,group,n,sep=" ")
  slice.temp2<-slice.temp1[1]
  slice<-toString(slice.temp2$factor)
  slice.df<-cbind(slice.df,slice)
    }
 
  colnames(slice.df)<-names(n)
  
  model.obs<-data.frame("Model"=k,"Total_Observations"=toString(paste(names(obs),obs)),"N_by_Group"=grps,"N_by_Slice"=slice.df, "Included_Subjects"=toString(unique(counts$Mouse)))  
  
  if(k==models[1]){
    model.obs.df<-model.obs
  }else{
  model.obs.df<-merge(model.obs.df,model.obs,by=intersect(colnames(model.obs.df),colnames(model.obs)),all=TRUE)
  }
  
#png(paste0(filemod,"/..","/","Diagnostics_",k,".png"), width=10, height=10, units='in', res=600)
#layout(matrix(1:4, ncol = 2))
#plot(lm(get(k)))
#layout(1)
#dev.off()
} 

model.info<-merge(models.call.df,model.obs.df,all=TRUE)  


summary<-modelsummary::msummary(mget(models),shape = term + group  ~ model + statistic,statistic= c("df","conf.int","s.e. = {std.error}", "F = {statistic}","p = {p.value}"),stars=T,output="data.frame")

remove(tukey)
tukey<-ls(envir=.GlobalEnv,pattern="tukey") 
tuk.summary1<-NULL
tuk.summary2<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)

}

write.xlsx(model.info,file=filemod,sheetName = "3WayANOVA_Info",append=TRUE)
write.xlsx(summary,file=filemod,sheetName = "3WayANOVA",append=TRUE)
write.xlsx(tuk.summary1,file=filemod,sheetName = "Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filemod,sheetName = "Tukey_Pairs",append=TRUE)
```

# STATISTICS: Linear Mixed Modeling/Multilevel

## \*1) Initial Setup

```{r}
##Specify path of the MAIN MODELS output file - heads up that this will be used for all the statistical outputs from this point on!!! 

filemod2<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Mixed Models Results_HalfSolutions_MainModels.xlsx"

##Specify path of the POST HOCS output file - heads up that this will be used for all the statistical outputs from this point on!!! 

filemod3<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout Mixed Models Results_HalfSolutions_PostHocs.xlsx"

corevars2<-c(corevars,"Position","x_OfC")

myorder5<-myorder[!(myorder %in% corevars2)]


#Previous code should have done these important steps for you: 
## 1) Make sure the variables are factors! 
## 2) Specify the order of the levels of each factor so that you can make the appropriate contrasts (i.e. Males then Females to get Female estimate or Females then Males to get Male estimate)
## 3) Melt the photometry signal measurements so that the data is in long format with a single different line for each measure (i.e. bout.analysis2_true.mean).

#Next we want to merge the bout and session data so that each level is represented by data at the lowest level. In other words, drinking, which is a session level measure, will be paired with all individual bouts from that session.

#Fill in the correct drinking data from the matching FileName and Channel entries in the session data 

# Unstandardized Signal Dataset
setDT(bout.analysis2_true.mean)[,Drinking.mL.kg:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  
setDT(bout.analysis2_true.mean)[,EtOH.gkg:=rep(NA,length(row.names(bout.analysis2_true.mean)))] 
setDT(bout.analysis2_true.mean)[,BoutTotal:=rep(NA,length(row.names(bout.analysis2_true.mean)))] 

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.mL.kg[[i]]<-session.analysis3$Drinking.mL.kg[[which(session.analysis3$FileName==bout.analysis2_true.mean$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true.mean$Channel[[i]])]]
  
   bout.analysis2_true.mean$EtOH.gkg[[i]]<-session.analysis3$EtOH.gkg[[which(session.analysis3$FileName==bout.analysis2_true.mean$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true.mean$Channel[[i]])]] 
   
    bout.analysis2_true.mean$BoutTotal[[i]]<-session.analysis3$Bout_max[[which(session.analysis3$FileName==bout.analysis2_true.mean$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true.mean$Channel[[i]])]] 
}

#####################################################################
# Standardized Signal Dataset
setDT(bout.analysis2_true.meanz2)[,Drinking.mL.kg:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  
setDT(bout.analysis2_true.meanz2)[,EtOH.gkg:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))] 
setDT(bout.analysis2_true.meanz2)[,BoutTotal:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))] 

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.mL.kg[[i]]<-session.analysis3$Drinking.mL.kg[[which(session.analysis3$FileName==bout.analysis2_true.meanz2$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true.meanz2$Channel[[i]])]]
  
   bout.analysis2_true.meanz2$EtOH.gkg[[i]]<-session.analysis3$EtOH.gkg[[which(session.analysis3$FileName==bout.analysis2_true.meanz2$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true.meanz2$Channel[[i]])]] 
   
   bout.analysis2_true.meanz2$BoutTotal[[i]]<-session.analysis3$Bout_max[[which(session.analysis3$FileName==bout.analysis2_true.meanz2$FileName[[i]] & session.analysis3$Channel==bout.analysis2_true.meanz2$Channel[[i]])]] 
}

# Wide Dataset
setDT(data.analysis_true)[,Drinking.mL.kg:=rep(NA,length(row.names(data.analysis_true)))]  
setDT(data.analysis_true)[,EtOH.gkg:=rep(NA,length(row.names(data.analysis_true)))] 
setDT(data.analysis_true)[,BoutTotal:=rep(NA,length(row.names(data.analysis_true)))] 

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg[[i]]<-session.analysis3$Drinking.mL.kg[[which(session.analysis3$FileName==data.analysis_true$FileName[[i]] & session.analysis3$Channel==data.analysis_true$Channel[[i]])]]
  
   data.analysis_true$EtOH.gkg[[i]]<-session.analysis3$EtOH.gkg[[which(session.analysis3$FileName==data.analysis_true$FileName[[i]] & session.analysis3$Channel==data.analysis_true$Channel[[i]])]] 
   
   data.analysis_true$BoutTotal[[i]]<-session.analysis3$Bout_max[[which(session.analysis3$FileName==data.analysis_true$FileName[[i]] & session.analysis3$Channel==data.analysis_true$Channel[[i]])]] 
}

###############################################
# Now make the standardized drinking variables

# Make tables of means and std dev for all variables to be standardized 

#Drinking.mL.kg Global Standardized
Drinking.mL.kg_means<- data.analysis_true %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('Drinking.mL.kg'), type = "mean_sd")
Drinking.mL.kg_means<-Drinking.mL.kg_means %>%
  mutate("gmc"=as.vector(scale(mean)))

# Within-Solution Individually Standardized Drinking
Drinking.sol_means<- data.analysis_true %>% 
  group_by(Mouse,Solution) %>%
  get_summary_stats(c('Drinking.mL.kg'), type = "mean_sd")
Drinking.sol_means<-Drinking.sol_means %>%
  group_by(Solution)%>%
  mutate("gmc"=as.vector(scale(mean))) %>%
  ungroup()
Drinking.sol_means2<-Drinking.sol_means %>%
  group_by(Solution) %>%
  get_summary_stats(c('mean'), type= "mean_sd")

#Drinking.mL.kg Standardized - by Sex!
Drinking.mL.kg_means_sex<- data.analysis_true %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('Drinking.mL.kg'), type = "mean_sd")
Drinking.mL.kg_means_sex<- Drinking.mL.kg_means_sex %>%
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Drinking.mL.kg_means_sex<- Drinking.mL.kg_means_sex %>%
  mutate(variable="Drinking.mL.kg")

#Drinking.mL.kg Standardized - by Group!
Drinking.mL.kg_means_grp<- data.analysis_true %>% 
  group_by(Mouse,group_shrt) %>%
  get_summary_stats(c('Drinking.mL.kg'), type = "mean_sd")
Drinking.mL.kg_means_grp<- Drinking.mL.kg_means_grp %>%
  group_by(group_shrt) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
Drinking.mL.kg_means_grp<- Drinking.mL.kg_means_grp %>%
  mutate(variable="Drinking.mL.kg")

# EtOH as g/kg Standardized (same as Within Solution for EtOH, just different units)
temp<- subset(data.analysis_true,!is.na(EtOH.gkg))
if(!length(temp)){
  
EtOH.gkg_means<- temp %>% 
  group_by(Mouse) %>%
  get_summary_stats(c('EtOH.gkg'), type = "mean_sd")
EtOH.gkg_means<-EtOH.gkg_means %>%
  mutate("gmc"=as.vector(scale(mean)))

# EtOH as g/kg Standardized by Sex
EtOH.gkg_means_sex<- temp %>% 
  group_by(Mouse,Sex) %>%
  get_summary_stats(c('EtOH.gkg'), type = "mean_sd")
EtOH.gkg_means_sex<- EtOH.gkg_means_sex %>% 
  group_by(Sex) %>%
  get_summary_stats(c('mean'), type = "mean_sd")
EtOH.gkg_means_sex<- EtOH.gkg_means_sex %>% 
  mutate(variable="EtOH.gkg")
}

### Now add these standardized measures to the different datasets

## Unstandardized Signal Dataset
#Drinking.mL.kg Standardized
setDT(bout.analysis2_true.mean)[,Drinking.mL.kg_m:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.mL.kg_m[[i]]<-Drinking.mL.kg_means$mean[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true.mean$Mouse[[i]])]]
}

setDT(bout.analysis2_true.mean)[,Drinking.mL.kg_sd:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.mL.kg_sd[[i]]<-Drinking.mL.kg_means$sd[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true.mean$Mouse[[i]])]]
}

bout.analysis2_true.mean<-bout.analysis2_true.mean %>%
  mutate(Drinking.mL.kg_imc=as.vector((bout.analysis2_true.mean$Drinking.mL.kg-bout.analysis2_true.mean$Drinking.mL.kg_m)/bout.analysis2_true.mean$Drinking.mL.kg_sd))


setDT(bout.analysis2_true.mean)[,Drinking.mL.kg_gmc:=rep(NA,length(row.names(bout.analysis2_true.mean)))] 

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.mL.kg_gmc[[i]]<-Drinking.mL.kg_means$gmc[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true.mean$Mouse[[i]])]]
}

#Within Solution Standardized Drinking
setDT(bout.analysis2_true.mean)[,Drinking.sol_m:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.sol_m[[i]]<-Drinking.sol_means$mean[[which(Drinking.sol_means$Mouse==bout.analysis2_true.mean$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true.mean$Solution[[i]])]]
}

setDT(bout.analysis2_true.mean)[,Drinking.sol_sd:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.sol_sd[[i]]<-Drinking.sol_means$sd[[which(Drinking.sol_means$Mouse==bout.analysis2_true.mean$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true.mean$Solution[[i]])]]
}

bout.analysis2_true.mean<-bout.analysis2_true.mean %>%
  mutate(Drinking.sol_imc=as.vector((bout.analysis2_true.mean$Drinking.mL.kg-bout.analysis2_true.mean$Drinking.sol_m)/bout.analysis2_true.mean$Drinking.sol_sd))


setDT(bout.analysis2_true.mean)[,Drinking.sol_gmc:=rep(NA,length(row.names(bout.analysis2_true.mean)))] 

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.sol_gmc[[i]]<-Drinking.sol_means$gmc[[which(Drinking.sol_means$Mouse==bout.analysis2_true.mean$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true.mean$Solution[[i]])]]
}

## Drinking.mL.kg Standardized - by Sex!
setDT(bout.analysis2_true.mean)[,Drinking.mL.kg_sm:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.mL.kg_sm[[i]]<-Drinking.mL.kg_means_sex$mean[[which(Drinking.mL.kg_means_sex$Sex==bout.analysis2_true.mean$Sex[[i]])]]
}

setDT(bout.analysis2_true.mean)[,Drinking.mL.kg_ssd:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.mL.kg_ssd[[i]]<-Drinking.mL.kg_means_sex$sd[[which(Drinking.mL.kg_means_sex$Sex==bout.analysis2_true.mean$Sex[[i]])]]
}

bout.analysis2_true.mean<-bout.analysis2_true.mean %>%
  mutate(Drinking.mL.kg_smc=as.vector((bout.analysis2_true.mean$Drinking.mL.kg_m-bout.analysis2_true.mean$Drinking.mL.kg_sm)/bout.analysis2_true.mean$Drinking.mL.kg_ssd))


## Drinking.mL.kg Standardized - by Group!
setDT(bout.analysis2_true.mean)[,Drinking.mL.kg_grpm:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.mL.kg_grpm[[i]]<-Drinking.mL.kg_means_grp$mean[[which(Drinking.mL.kg_means_grp$group_shrt==bout.analysis2_true.mean$group_shrt[[i]])]]
}

setDT(bout.analysis2_true.mean)[,Drinking.mL.kg_grpsd:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  

for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
  bout.analysis2_true.mean$Drinking.mL.kg_grpsd[[i]]<-Drinking.mL.kg_means_grp$sd[[which(Drinking.mL.kg_means_grp$group_shrt==bout.analysis2_true.mean$group_shrt[[i]])]]
}

bout.analysis2_true.mean<-bout.analysis2_true.mean %>%
  mutate(Drinking.mL.kg_grpmc=as.vector((bout.analysis2_true.mean$Drinking.sol_m-bout.analysis2_true.mean$Drinking.mL.kg_grpm)/bout.analysis2_true.mean$Drinking.mL.kg_grpsd))

# ## EtOH.gkg Standardized
# 
# if(exists(EtOH.gkg))
# setDT(bout.analysis2_true.mean)[,EtOH.gkg_m:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  
# 
# for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
#   if(is.na(bout.analysis2_true.mean$EtOH.gkg[[i]])==FALSE){
#   bout.analysis2_true.mean$EtOH.gkg_m[[i]]<-EtOH.gkg_means$mean[[which(EtOH.gkg_means$Mouse==bout.analysis2_true.mean$Mouse[[i]])]]
#   }
# }
# setDT(bout.analysis2_true.mean)[,EtOH.gkg_sd:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  
# 
# for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
#   if(is.na(bout.analysis2_true.mean$EtOH.gkg[[i]])==FALSE){
#   bout.analysis2_true.mean$EtOH.gkg_sd[[i]]<-EtOH.gkg_means$sd[[which(EtOH.gkg_means$Mouse==bout.analysis2_true.mean$Mouse[[i]])]]
#   }
# }
# 
# bout.analysis2_true.mean<-bout.analysis2_true.mean %>%
#   mutate(EtOH.gkg_imc=as.vector((bout.analysis2_true.mean$EtOH.gkg-bout.analysis2_true.mean$EtOH.gkg_m)/bout.analysis2_true.mean$EtOH.gkg_sd))
# 
# 
# setDT(bout.analysis2_true.mean)[,EtOH.gkg_gmc:=rep(NA,length(row.names(bout.analysis2_true.mean)))] 
# 
# for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
#   if(is.na(bout.analysis2_true.mean$EtOH.gkg[[i]])==FALSE){
#   bout.analysis2_true.mean$EtOH.gkg_gmc[[i]]<-EtOH.gkg_means$gmc[[which(EtOH.gkg_means$Mouse==bout.analysis2_true.mean$Mouse[[i]])]]
#   }
# }
# 
# ## EtOH Standardized By Sex
# setDT(bout.analysis2_true.mean)[,EtOH.gkg_sm:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  
# 
# for (i in 1:length(bout.analysis2_true.mean$FileName)){
#   if(is.na(bout.analysis2_true.mean$EtOH.gkg[[i]])==FALSE){
#   bout.analysis2_true.mean$EtOH.gkg_sm[[i]]<-EtOH.gkg_means_sex$mean[[which(EtOH.gkg_means_sex$Sex==bout.analysis2_true.mean$Sex[[i]])]]
#   }
# }
# 
# setDT(bout.analysis2_true.mean)[,EtOH.gkg_ssd:=rep(NA,length(row.names(bout.analysis2_true.mean)))]  
# 
# for (i in 1:length(bout.analysis2_true.mean$FileName)){ 
#   bout.analysis2_true.mean$EtOH.gkg_ssd[[i]]<-EtOH.gkg_means_sex$sd[[which(EtOH.gkg_means_sex$Sex==bout.analysis2_true.mean$Sex[[i]])]]
# }
# 
# setDT(bout.analysis2_true.mean)[,EtOH.gkg_smc:=rep(NA,length(row.names(bout.analysis2_true.mean)))] 
# 
# bout.analysis2_true.mean<-bout.analysis2_true.mean %>%
#   mutate(EtOH.gkg_smc=as.vector((bout.analysis2_true.mean$EtOH.gkg_m-bout.analysis2_true.mean$EtOH.gkg_sm)/bout.analysis2_true.mean$EtOH.gkg_ssd))



######################################################################
# Next, add standardized drinking vars with Standardized calcium signals (z2 dataset)

#Drinking.mL.kg Standardized
setDT(bout.analysis2_true.meanz2)[,Drinking.mL.kg_m:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.mL.kg_m[[i]]<-Drinking.mL.kg_means$mean[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]])]]
}

setDT(bout.analysis2_true.meanz2)[,Drinking.mL.kg_sd:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.mL.kg_sd[[i]]<-Drinking.mL.kg_means$sd[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]])]]
}

bout.analysis2_true.meanz2<-bout.analysis2_true.meanz2 %>%
  mutate(Drinking.mL.kg_imc=as.vector((bout.analysis2_true.meanz2$Drinking.mL.kg-bout.analysis2_true.meanz2$Drinking.mL.kg_m)/bout.analysis2_true.meanz2$Drinking.mL.kg_sd))


setDT(bout.analysis2_true.meanz2)[,Drinking.mL.kg_gmc:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))] 

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.mL.kg_gmc[[i]]<-Drinking.mL.kg_means$gmc[[which(Drinking.mL.kg_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]])]]
}

#Within Solution Standardized Drinking
setDT(bout.analysis2_true.meanz2)[,Drinking.sol_m:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.sol_m[[i]]<-Drinking.sol_means$mean[[which(Drinking.sol_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true.meanz2$Solution[[i]])]]
}

setDT(bout.analysis2_true.meanz2)[,Drinking.sol_sd:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.sol_sd[[i]]<-Drinking.sol_means$sd[[which(Drinking.sol_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true.meanz2$Solution[[i]])]]
}

bout.analysis2_true.meanz2<-bout.analysis2_true.meanz2 %>%
  mutate(Drinking.sol_imc=as.vector((bout.analysis2_true.meanz2$Drinking.mL.kg-bout.analysis2_true.meanz2$Drinking.sol_m)/bout.analysis2_true.meanz2$Drinking.sol_sd))


setDT(bout.analysis2_true.meanz2)[,Drinking.sol_gmc:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))] 

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.sol_gmc[[i]]<-Drinking.sol_means$gmc[[which(Drinking.sol_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]] & Drinking.sol_means$Solution==bout.analysis2_true.meanz2$Solution[[i]])]]
}

## Drinking.mL.kg Standardized - by Sex!
setDT(bout.analysis2_true.meanz2)[,Drinking.mL.kg_sm:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.mL.kg_sm[[i]]<-Drinking.mL.kg_means_sex$mean[[which(Drinking.mL.kg_means_sex$Sex==bout.analysis2_true.meanz2$Sex[[i]])]]
}

setDT(bout.analysis2_true.meanz2)[,Drinking.mL.kg_ssd:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.mL.kg_ssd[[i]]<-Drinking.mL.kg_means_sex$sd[[which(Drinking.mL.kg_means_sex$Sex==bout.analysis2_true.meanz2$Sex[[i]])]]
}

bout.analysis2_true.meanz2<-bout.analysis2_true.meanz2 %>%
  mutate(Drinking.mL.kg_smc=as.vector((bout.analysis2_true.meanz2$Drinking.mL.kg_m-bout.analysis2_true.meanz2$Drinking.mL.kg_sm)/bout.analysis2_true.meanz2$Drinking.mL.kg_ssd))


## Drinking.mL.kg Standardized - by Group!
setDT(bout.analysis2_true.meanz2)[,Drinking.mL.kg_grpm:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.mL.kg_grpm[[i]]<-Drinking.mL.kg_means_grp$mean[[which(Drinking.mL.kg_means_grp$group_shrt==bout.analysis2_true.meanz2$group_shrt[[i]])]]
}

setDT(bout.analysis2_true.meanz2)[,Drinking.mL.kg_grpsd:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  

for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
  bout.analysis2_true.meanz2$Drinking.mL.kg_grpsd[[i]]<-Drinking.mL.kg_means_grp$sd[[which(Drinking.mL.kg_means_grp$group_shrt==bout.analysis2_true.meanz2$group_shrt[[i]])]]
}

bout.analysis2_true.meanz2<-bout.analysis2_true.meanz2 %>%
  mutate(Drinking.mL.kg_grpmc=as.vector((bout.analysis2_true.meanz2$Drinking.sol_m-bout.analysis2_true.meanz2$Drinking.mL.kg_grpm)/bout.analysis2_true.meanz2$Drinking.mL.kg_grpsd))


# ## EtOH.gkg Standardized
# 
# setDT(bout.analysis2_true.meanz2)[,EtOH.gkg_m:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  
# 
# for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
#   if(is.na(bout.analysis2_true.meanz2$EtOH.gkg[[i]])==FALSE){
#   bout.analysis2_true.meanz2$EtOH.gkg_m[[i]]<-EtOH.gkg_means$mean[[which(EtOH.gkg_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]])]]
#   }
# }
# setDT(bout.analysis2_true.meanz2)[,EtOH.gkg_sd:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  
# 
# for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
#   if(is.na(bout.analysis2_true.meanz2$EtOH.gkg[[i]])==FALSE){
#   bout.analysis2_true.meanz2$EtOH.gkg_sd[[i]]<-EtOH.gkg_means$sd[[which(EtOH.gkg_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]])]]
#   }
# }
# 
# bout.analysis2_true.meanz2<-bout.analysis2_true.meanz2 %>%
#   mutate(EtOH.gkg_imc=as.vector((bout.analysis2_true.meanz2$EtOH.gkg-bout.analysis2_true.meanz2$EtOH.gkg_m)/bout.analysis2_true.meanz2$EtOH.gkg_sd))
# 
# 
# setDT(bout.analysis2_true.meanz2)[,EtOH.gkg_gmc:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))] 
# 
# for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
#   if(is.na(bout.analysis2_true.meanz2$EtOH.gkg[[i]])==FALSE){
#   bout.analysis2_true.meanz2$EtOH.gkg_gmc[[i]]<-EtOH.gkg_means$gmc[[which(EtOH.gkg_means$Mouse==bout.analysis2_true.meanz2$Mouse[[i]])]]
#   }
# }
# 
# ## EtOH Standardized By Sex
# setDT(bout.analysis2_true.meanz2)[,EtOH.gkg_sm:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  
# 
# for (i in 1:length(bout.analysis2_true.meanz2$FileName)){
#   if(is.na(bout.analysis2_true.meanz2$EtOH.gkg[[i]])==FALSE){
#   bout.analysis2_true.meanz2$EtOH.gkg_sm[[i]]<-EtOH.gkg_means_sex$mean[[which(EtOH.gkg_means_sex$Sex==bout.analysis2_true.meanz2$Sex[[i]])]]
#   }
# }
# 
# setDT(bout.analysis2_true.meanz2)[,EtOH.gkg_ssd:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))]  
# 
# for (i in 1:length(bout.analysis2_true.meanz2$FileName)){ 
#   bout.analysis2_true.meanz2$EtOH.gkg_ssd[[i]]<-EtOH.gkg_means_sex$sd[[which(EtOH.gkg_means_sex$Sex==bout.analysis2_true.meanz2$Sex[[i]])]]
# }
# 
# setDT(bout.analysis2_true.meanz2)[,EtOH.gkg_smc:=rep(NA,length(row.names(bout.analysis2_true.meanz2)))] 
# 
# bout.analysis2_true.meanz2<-bout.analysis2_true.meanz2 %>%
#   mutate(EtOH.gkg_smc=as.vector((bout.analysis2_true.meanz2$EtOH.gkg_m-bout.analysis2_true.meanz2$EtOH.gkg_sm)/bout.analysis2_true.meanz2$EtOH.gkg_ssd))

  
# Just to make sure we can graph and analyze the data.analysis_true dataset based on these variables, we add them here. 

#Drinking.mL.kg Standardized
setDT(data.analysis_true)[,Drinking.mL.kg_m:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_m[[i]]<-Drinking.mL.kg_means$mean[[which(Drinking.mL.kg_means$Mouse==data.analysis_true$Mouse[[i]])]]
}

setDT(data.analysis_true)[,Drinking.mL.kg_sd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_sd[[i]]<-Drinking.mL.kg_means$sd[[which(Drinking.mL.kg_means$Mouse==data.analysis_true$Mouse[[i]])]]
}

data.analysis_true<-data.analysis_true %>%
  mutate(Drinking.mL.kg_imc=as.vector((data.analysis_true$Drinking.mL.kg-data.analysis_true$Drinking.mL.kg_m)/data.analysis_true$Drinking.mL.kg_sd))


setDT(data.analysis_true)[,Drinking.mL.kg_gmc:=rep(NA,length(row.names(data.analysis_true)))] 

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_gmc[[i]]<-Drinking.mL.kg_means$gmc[[which(Drinking.mL.kg_means$Mouse==data.analysis_true$Mouse[[i]])]]
}

#Within Solution Standardized Drinking
setDT(data.analysis_true)[,Drinking.sol_m:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.sol_m[[i]]<-Drinking.sol_means$mean[[which(Drinking.sol_means$Mouse==data.analysis_true$Mouse[[i]] & Drinking.sol_means$Solution==data.analysis_true$Solution[[i]])]]
}

setDT(data.analysis_true)[,Drinking.sol_sd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.sol_sd[[i]]<-Drinking.sol_means$sd[[which(Drinking.sol_means$Mouse==data.analysis_true$Mouse[[i]] & Drinking.sol_means$Solution==data.analysis_true$Solution[[i]])]]
}

data.analysis_true<-data.analysis_true %>%
  mutate(Drinking.sol_imc=as.vector((data.analysis_true$Drinking.mL.kg-data.analysis_true$Drinking.sol_m)/data.analysis_true$Drinking.sol_sd))


setDT(data.analysis_true)[,Drinking.sol_gmc:=rep(NA,length(row.names(data.analysis_true)))] 

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.sol_gmc[[i]]<-Drinking.sol_means$gmc[[which(Drinking.sol_means$Mouse==data.analysis_true$Mouse[[i]] & Drinking.sol_means$Solution==data.analysis_true$Solution[[i]])]]
}

## Drinking.mL.kg Standardized - by Sex!
setDT(data.analysis_true)[,Drinking.mL.kg_sm:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_sm[[i]]<-Drinking.mL.kg_means_sex$mean[[which(Drinking.mL.kg_means_sex$Sex==data.analysis_true$Sex[[i]])]]
}

setDT(data.analysis_true)[,Drinking.mL.kg_ssd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_ssd[[i]]<-Drinking.mL.kg_means_sex$sd[[which(Drinking.mL.kg_means_sex$Sex==data.analysis_true$Sex[[i]])]]
}

data.analysis_true<-data.analysis_true %>%
  mutate(Drinking.mL.kg_smc=as.vector((data.analysis_true$Drinking.mL.kg_m-data.analysis_true$Drinking.mL.kg_sm)/data.analysis_true$Drinking.mL.kg_ssd))


## Drinking.mL.kg Standardized - by Group!
setDT(data.analysis_true)[,Drinking.mL.kg_grpm:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_grpm[[i]]<-Drinking.mL.kg_means_grp$mean[[which(Drinking.mL.kg_means_grp$group_shrt==data.analysis_true$group_shrt[[i]])]]
}

setDT(data.analysis_true)[,Drinking.mL.kg_grpsd:=rep(NA,length(row.names(data.analysis_true)))]  

for (i in 1:length(data.analysis_true$FileName)){ 
  data.analysis_true$Drinking.mL.kg_grpsd[[i]]<-Drinking.mL.kg_means_grp$sd[[which(Drinking.mL.kg_means_grp$group_shrt==data.analysis_true$group_shrt[[i]])]]
}

data.analysis_true<-data.analysis_true %>%
  mutate(Drinking.mL.kg_grpmc=as.vector((data.analysis_true$Drinking.sol_m-data.analysis_true$Drinking.mL.kg_grpm)/data.analysis_true$Drinking.mL.kg_grpsd))


# ## EtOH.gkg Standardized
# 
# setDT(data.analysis_true)[,EtOH.gkg_m:=rep(NA,length(row.names(data.analysis_true)))]  
# 
# for (i in 1:length(data.analysis_true$FileName)){ 
#   if(is.na(data.analysis_true$EtOH.gkg[[i]])==FALSE){
#   data.analysis_true$EtOH.gkg_m[[i]]<-EtOH.gkg_means$mean[[which(EtOH.gkg_means$Mouse==data.analysis_true$Mouse[[i]])]]
#   }
# }
# setDT(data.analysis_true)[,EtOH.gkg_sd:=rep(NA,length(row.names(data.analysis_true)))]  
# 
# for (i in 1:length(data.analysis_true$FileName)){ 
#   if(is.na(data.analysis_true$EtOH.gkg[[i]])==FALSE){
#   data.analysis_true$EtOH.gkg_sd[[i]]<-EtOH.gkg_means$sd[[which(EtOH.gkg_means$Mouse==data.analysis_true$Mouse[[i]])]]
#   }
# }
# 
# data.analysis_true<-data.analysis_true %>%
#   mutate(EtOH.gkg_imc=as.vector((data.analysis_true$EtOH.gkg-data.analysis_true$EtOH.gkg_m)/data.analysis_true$EtOH.gkg_sd))
# 
# 
# setDT(data.analysis_true)[,EtOH.gkg_gmc:=rep(NA,length(row.names(data.analysis_true)))] 
# 
# for (i in 1:length(data.analysis_true$FileName)){ 
#   if(is.na(data.analysis_true$EtOH.gkg[[i]])==FALSE){
#   data.analysis_true$EtOH.gkg_gmc[[i]]<-EtOH.gkg_means$gmc[[which(EtOH.gkg_means$Mouse==data.analysis_true$Mouse[[i]])]]
#   }
# }
# 
# ## EtOH Standardized By Sex
# setDT(data.analysis_true)[,EtOH.gkg_sm:=rep(NA,length(row.names(data.analysis_true)))]  
# 
# for (i in 1:length(data.analysis_true$FileName)){
#   if(is.na(data.analysis_true$EtOH.gkg[[i]])==FALSE){
#   data.analysis_true$EtOH.gkg_sm[[i]]<-EtOH.gkg_means_sex$mean[[which(EtOH.gkg_means_sex$Sex==data.analysis_true$Sex[[i]])]]
#   }
# }
# 
# setDT(data.analysis_true)[,EtOH.gkg_ssd:=rep(NA,length(row.names(data.analysis_true)))]  
# 
# for (i in 1:length(data.analysis_true$FileName)){ 
#   data.analysis_true$EtOH.gkg_ssd[[i]]<-EtOH.gkg_means_sex$sd[[which(EtOH.gkg_means_sex$Sex==data.analysis_true$Sex[[i]])]]
# }
# 
# setDT(data.analysis_true)[,EtOH.gkg_smc:=rep(NA,length(row.names(data.analysis_true)))] 
# 
# data.analysis_true<-data.analysis_true %>%
#   mutate(EtOH.gkg_smc=as.vector((data.analysis_true$EtOH.gkg_m-data.analysis_true$EtOH.gkg_sm)/data.analysis_true$EtOH.gkg_ssd))


#Export Standardization Parameters - Only do once!
# filedesc2<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20 Joint_TrueBout StandardizationParams_HalfSolutions.xlsx"
# #filedesc2<-"C:/Users/Christina/OneDrive/Desktop/CL8 Joint_TrueBout StandardizationParams.xlsx"
# 
# write.xlsx(Drinking.mL.kg_means,file=filedesc2,sheetName = "Drinking.mL.kg",append=TRUE)
# write.xlsx(Drinking.mL.kg_means_sex,file=filedesc2,sheetName = "Drinking.mL.kg_sex",append=TRUE)
# write.xlsx(Drinking.mL.kg_means_grp,file=filedesc2,sheetName = "Drinking.mLkg_grp",append=TRUE)
# write.xlsx(Drinking.sol_means,file=filedesc2,sheetName = "Drinking.sol",append=TRUE)
# write.xlsx(Drinking.sol_means2,file=filedesc2,sheetName = "Drinking.sol2",append=TRUE)
# # #write.xlsx(EtOH.gkg_means,file=filedesc2,sheetName = "EtOH.gkg",append=TRUE)
# # #write.xlsx(EtOH.gkg_means_sex,file=filedesc2,sheetName = "EtOH.gkg_smc",append=TRUE)

```

## 2) Do Some Preliminary Checks on Your Variation

```{r}
#Look at within-subject effects to determine how outcome is varying as a function of mouse

#Check Each Mouse's Trends
mouse.data<-data.analysis_true %>%
  filter(Mouse==8,preserve=TRUE)
ggplot(data=mouse.data, aes(x=LickFrequency_imc,y=z2meanbeforeafter,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  labs(title="Mouse 8 (Female)",subtitle="Standardized Signal",x="Lick Frequency", y="Signal (%dF/F)") +
  facet_grid2(session~Solution) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=17, face="bold"),
        axis.title=element_text(size=16,face="bold"),
        axis.text=element_text(size=12),
        strip.text=element_text(size=14))


##Check if enough bouts per session to use as nested variable
groupn_bout<-bout.analysis2_true.meanz2 %>%
  group_by(Sex,Solution,time) %>%
  get_summary_stats(Bout, show=c("n"))

##Check if enough sessions per group to use as nested variable
groupn_session<-bout.analysis2_true.meanz2 %>%
    group_by(Sex,Solution,time,session) %>%
    get_summary_stats(Bout, show=c("n"))
```

## 3) The Unconditional Means Model (UCM)

```{r}
##To start, we often fit an unconditional means model that provides us information about how much of the total variance in the outcome variable is within-subject variance and how much is between-subject variance. This also allows us to test out which variables are useful control variables.

#Your inter-class correlation (ICC) between Mouse variation leaving within Mouse variation at 1-ICC_0.   

##The regular model0 just tests whether Mouse explains a good portion of the signal without any other factors. The other models test other nested or crossed factors to see which model best fits the data.   

#Model 0z: Just Random Intercept for Mouse, Mouse:session, or session 
model0.0z_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse),                     data=bout.analysis2_true.meanz2,na.action=na.exclude); 
RandomEffects0.0z <- as.data.frame(VarCorr(model0.0z_fit))  
ICC_0.0z <- RandomEffects0.0z[1,4]/(RandomEffects0.0z[1,4]+RandomEffects0.0z[2,4])    

model0.0za_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|session),                     data=bout.analysis2_true.meanz2,na.action=na.exclude); 
RandomEffects0.0za <- as.data.frame(VarCorr(model0.0za_fit))  
ICC_0.0za <- RandomEffects0.0za[1,4]/(RandomEffects0.0za[1,4]+RandomEffects0.0za[2,4])    

model0.0zb_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:session), data=bout.analysis2_true.meanz2, na.action=na.exclude); 
RandomEffects0.0zb <- as.data.frame(VarCorr(model0.0zb_fit))  
ICC_0.0zb <- RandomEffects0.0zb[1,4]/(RandomEffects0.0zb[1,4]+RandomEffects0.0zb[2,4])   

model0.0zc_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Bout),                  data=bout.analysis2_true.meanz2,na.action=na.exclude); 
RandomEffects0.0zc <- as.data.frame(VarCorr(model0.0zc_fit))  
ICC_0.0zc <- RandomEffects0.0zc[1,4]/(RandomEffects0.0zc[1,4]+RandomEffects0.0zc[2,4])  

model0.0zd_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|session:Bout), 
                   data=bout.analysis2_true.meanz2,
                   na.action=na.exclude);
RandomEffects0.0zd <- as.data.frame(VarCorr(model0.0zd_fit))
ICC_0.0zd <- RandomEffects0.0zd[1,4]/(RandomEffects0.0zd[1,4]+RandomEffects0.0zd[2,4]) 

model0.0ze_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:Bout), 
                   data=bout.analysis2_true.meanz2,
                   na.action=na.exclude);
RandomEffects0.0ze <- as.data.frame(VarCorr(model0.0ze_fit))
ICC_0.0ze <- RandomEffects0.0ze[1,4]/(RandomEffects0.0ze[1,4]+RandomEffects0.0ze[2,4]) 

model0.0zf_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:session:Bout), 
                   data=bout.analysis2_true.meanz2,
                   na.action=na.exclude);
RandomEffects0.0zf <- as.data.frame(VarCorr(model0.0zf_fit))
ICC_0.0zf <- RandomEffects0.0zf[1,4]/(RandomEffects0.0zf[1,4]+RandomEffects0.0zf[2,4]) 

#Model 0.1z: Random intercept for fully nested Bout in session in Mouse 
model0.1z_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout), data=bout.analysis2_true.meanz2,na.action=na.exclude);  
RandomEffects0.1z <- as.data.frame(VarCorr(model0.1z_fit))  
ICC_0.1z_1 <- RandomEffects0.1z[1,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])  
ICC_0.1z_2 <- RandomEffects0.1z[2,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])  
ICC_0.1z_3 <- RandomEffects0.1z[3,4]/(RandomEffects0.1z[1,4]+RandomEffects0.1z[2,4]+RandomEffects0.1z[3,4]+RandomEffects0.1z[4,4])

#Model 0.1za: Random intercept for fully nested everything sans Mouse 
model0.1za_fit <- lmerTest::lmer(formula = signal ~ 1+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2,  na.action=na.exclude);  
RandomEffects0.1za <- as.data.frame(VarCorr(model0.1za_fit))  
ICC_0.1za_1 <- RandomEffects0.1za[1,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
ICC_0.1za_2 <- RandomEffects0.1za[2,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
ICC_0.1za_3 <- RandomEffects0.1za[3,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4])   
#ICC_0.1za_4 <- RandomEffects0.1za[4,4]/(RandomEffects0.1za[1,4]+RandomEffects0.1za[2,4]+RandomEffects0.1za[3,4]+RandomEffects0.1za[4,4]+RandomEffects0.1za[5,4])    

#Model 0.1zb: Model 0.1z with also both session and bout crossed factors 
model0.1zb_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout)+(1|session),                data=bout.analysis2_true.meanz2, na.action=na.exclude);  
RandomEffects0.1zb <- as.data.frame(VarCorr(model0.1zb_fit))  
ICC_0.1zb_1 <- RandomEffects0.1zb[1,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_2 <- RandomEffects0.1zb[2,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_3 <- RandomEffects0.1zb[3,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])  
ICC_0.1zb_4 <- RandomEffects0.1zb[4,4]/(RandomEffects0.1zb[1,4]+RandomEffects0.1zb[2,4]+RandomEffects0.1zb[3,4]+RandomEffects0.1zb[4,4]+RandomEffects0.1zb[5,4])   

#Model 0.1zc: Model 0.1z with also just bout crossed factor 
model0.1zc_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),                data=bout.analysis2_true.meanz2,na.action=na.exclude);   
RandomEffects0.1zc <- as.data.frame(VarCorr(model0.1zc_fit))  
ICC_0.1zc_1 <- RandomEffects0.1zc[1,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_2 <- RandomEffects0.1zc[2,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_3 <- RandomEffects0.1zc[3,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])  
ICC_0.1zc_4 <- RandomEffects0.1zc[4,4]/(RandomEffects0.1zc[1,4]+RandomEffects0.1zc[2,4]+RandomEffects0.1zc[3,4]+RandomEffects0.1zc[4,4]+RandomEffects0.1zc[5,4])   

#Model 0.1zd: Model 0.1z with also just bout crossed factor 
model0.1zd_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|session),                data=bout.analysis2_true.meanz2,na.action=na.exclude);
RandomEffects0.1zd <- as.data.frame(VarCorr(model0.1zd_fit))  
ICC_0.1zd_1 <- RandomEffects0.1zd[1,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_2 <- RandomEffects0.1zd[2,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_3 <- RandomEffects0.1zd[3,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])  
ICC_0.1zd_4 <- RandomEffects0.1zd[4,4]/(RandomEffects0.1zd[1,4]+RandomEffects0.1zd[2,4]+RandomEffects0.1zd[3,4]+RandomEffects0.1zd[4,4]+RandomEffects0.1zd[5,4])   

#Model 0.1ze: Model 0.1zc without Mouse only factor
model0.1ze_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude);  
RandomEffects0.1ze <- as.data.frame(VarCorr(model0.1ze_fit))  
ICC_0.1ze_1 <- RandomEffects0.1ze[1,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  
ICC_0.1ze_2 <- RandomEffects0.1ze[2,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  
ICC_0.1ze_3 <- RandomEffects0.1ze[3,4]/(RandomEffects0.1ze[1,4]+RandomEffects0.1ze[2,4]+RandomEffects0.1ze[3,4]+RandomEffects0.1ze[4,4])  

#Model 0.2z: Random intercept for individual nesting within Mouse AND crossed factors 
model0.2z_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|session)+(1|Bout),                data=bout.analysis2_true.meanz2,na.action=na.exclude); #SINGULAR
RandomEffects0.2z <- as.data.frame(VarCorr(model0.2z_fit))  
ICC_0.2z_1 <- RandomEffects0.2z[1,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_2 <- RandomEffects0.2z[2,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_3 <- RandomEffects0.2z[3,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_4 <- RandomEffects0.2z[4,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  
ICC_0.2z_5 <- RandomEffects0.2z[5,4]/(RandomEffects0.2z[1,4]+RandomEffects0.2z[2,4]+RandomEffects0.2z[3,4]+RandomEffects0.2z[4,4]+RandomEffects0.2z[5,4]+RandomEffects0.2z[6,4])  

#Model 0.2za: Model 0.2z without the crossed intercept for session 
model0.2za_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|Bout),               data=bout.analysis2_true.meanz2,na.action=na.exclude); 
RandomEffects0.2za <- as.data.frame(VarCorr(model0.2za_fit))  
ICC_0.2za_1 <- RandomEffects0.2za[1,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])  
ICC_0.2za_2 <- RandomEffects0.2za[2,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])  
ICC_0.2za_3 <- RandomEffects0.2za[3,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])   
ICC_0.2za_4 <- RandomEffects0.2za[4,4]/(RandomEffects0.2za[1,4]+RandomEffects0.2za[2,4]+RandomEffects0.2za[3,4]+RandomEffects0.2za[4,4]+RandomEffects0.2za[5,4])   

#Model 0.2zb: Model 0.2z but without crossed intercept for bout 
model0.2zb_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout)+(1|session),               data=bout.analysis2_true.meanz2,na.action=na.exclude); #SINGULAR
RandomEffects0.2zb <- as.data.frame(VarCorr(model0.2zb_fit))  
ICC_0.2zb_1 <- RandomEffects0.2zb[1,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])   
ICC_0.2zb_2 <- RandomEffects0.2zb[2,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])  
ICC_0.2zb_3 <- RandomEffects0.2zb[3,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])  
ICC_0.2zb_4 <- RandomEffects0.2zb[4,4]/(RandomEffects0.2zb[1,4]+RandomEffects0.2zb[2,4]+RandomEffects0.2zb[3,4]+RandomEffects0.2zb[4,4]+RandomEffects0.2zb[5,4])    

#Model 0.2zc - Model 0.2z without either crossed random factor 
model0.2zc_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse) + (1|Mouse:session)+(1|Mouse:Bout),               data=bout.analysis2_true.meanz2,na.action=na.exclude);#SINGULAR
RandomEffects0.2zc <- as.data.frame(VarCorr(model0.2zc_fit))  
ICC_0.2zc_1 <- RandomEffects0.2zc[1,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])
ICC_0.2zc_2 <- RandomEffects0.2zc[2,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])
ICC_0.2zc_3 <- RandomEffects0.2zc[3,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4]) 
#ICC_0.2zc_4 <- RandomEffects0.2zc[4,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])  

#Model 0.2zd - Model 0.2z without either crossed random factor 
model0.2zd_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:session)+(1|Mouse:Bout),               data=bout.analysis2_true.meanz2,na.action=na.exclude); 

RandomEffects0.2zd <- as.data.frame(VarCorr(model0.2zd_fit))  
ICC_0.2zd_1 <- RandomEffects0.2zd[1,4]/(RandomEffects0.2zd[1,4]+RandomEffects0.2zd[2,4]+RandomEffects0.2zd[3,4])
ICC_0.2zd_2 <- RandomEffects0.2zd[2,4]/(RandomEffects0.2zd[1,4]+RandomEffects0.2zd[2,4]+RandomEffects0.2zd[3,4])
#ICC_0.2zc_4 <- RandomEffects0.2zc[4,4]/(RandomEffects0.2zc[1,4]+RandomEffects0.2zc[2,4]+RandomEffects0.2zc[3,4]+RandomEffects0.2zc[4,4])  

#Model 0.2ze - Model 0.2zd without full nesting of bout 
model0.2ze_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse:session)+(1|session:Bout),               data=bout.analysis2_true.meanz2,na.action=na.exclude); 

RandomEffects0.2ze <- as.data.frame(VarCorr(model0.2ze_fit))  
ICC_0.2ze_1 <- RandomEffects0.2ze[1,4]/(RandomEffects0.2ze[1,4]+RandomEffects0.2ze[2,4]+RandomEffects0.2ze[3,4])
ICC_0.2ze_2 <- RandomEffects0.2ze[2,4]/(RandomEffects0.2ze[1,4]+RandomEffects0.2ze[2,4]+RandomEffects0.2ze[3,4])


#Model 0.3z: Random intercept for nested session and mostly crossed bout 
model0.3z_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session)+(1|Bout),                       data=bout.analysis2_true.meanz2,na.action=na.exclude); #SINGULAR 
RandomEffects0.3z <- as.data.frame(VarCorr(model0.3z_fit))  
ICC_0.3z_1 <- RandomEffects0.3z[1,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4]) 
ICC_0.3z_2 <- RandomEffects0.3z[2,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4]) 
ICC_0.3z_3 <- RandomEffects0.3z[3,4]/(RandomEffects0.3z[1,4]+RandomEffects0.3z[2,4]+RandomEffects0.3z[3,4]+RandomEffects0.3z[4,4])  

# Model 0.3za - Model 0.3z with added nesting of Bout and crossed session
model0.3za_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:Bout)+(1|session),                       data=bout.analysis2_true.meanz2,na.action=na.exclude); 
RandomEffects0.3za <- as.data.frame(VarCorr(model0.3za_fit))  
ICC_0.3za_1 <- RandomEffects0.3za[1,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4])
ICC_0.3za_2 <- RandomEffects0.3za[2,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4])
ICC_0.3za_3 <- RandomEffects0.3za[3,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4]) 
#ICC_0.3za_4 <- RandomEffects0.3za[4,4]/(RandomEffects0.3za[1,4]+RandomEffects0.3za[2,4]+RandomEffects0.3za[3,4]+RandomEffects0.3za[4,4]+RandomEffects0.3za[5,4])  

# Model 0.3zb - Model 0.3z with only nested session 
model0.3zb_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:session),                       data=bout.analysis2_true.meanz2,na.action=na.exclude); #SINGULAR
RandomEffects0.3zb <- as.data.frame(VarCorr(model0.3zb_fit))  
ICC_0.3zb_1 <- RandomEffects0.3zb[1,4]/(RandomEffects0.3zb[1,4]+RandomEffects0.3zb[2,4]+RandomEffects0.3zb[3,4]) 
ICC_0.3zb_2 <- RandomEffects0.3zb[2,4]/(RandomEffects0.3zb[1,4]+RandomEffects0.3zb[2,4]+RandomEffects0.3zb[3,4])  

# Model 0.3zc - Model 0.3z with only nested bout 
model0.3zc_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|Mouse:Bout),                       data=bout.analysis2_true.meanz2,na.action=na.exclude);
RandomEffects0.3zc <- as.data.frame(VarCorr(model0.3zc_fit))  
ICC_0.3zc_1 <- RandomEffects0.3zc[1,4]/(RandomEffects0.3zc[1,4]+RandomEffects0.3zc[2,4]+RandomEffects0.3zc[3,4]) 
ICC_0.3zc_2 <- RandomEffects0.3zc[2,4]/(RandomEffects0.3zc[1,4]+RandomEffects0.3zc[2,4]+RandomEffects0.3zc[3,4])  

#Random intercept for fully crossed and completely unnested factors 
model0.4z_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse)+(1|session)+(1|Bout),                       data=bout.analysis2_true.meanz2,na.action=na.exclude);  
RandomEffects0.4z <- as.data.frame(VarCorr(model0.4z_fit))   
ICC_0.4z_1 <- RandomEffects0.4z[1,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
ICC_0.4z_2 <- RandomEffects0.4z[2,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
ICC_0.4z_3 <- RandomEffects0.4z[3,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4])  
#ICC_0.4z_4 <- RandomEffects0.4z[4,4]/(RandomEffects0.4z[1,4]+RandomEffects0.4z[2,4]+RandomEffects0.4z[3,4]+RandomEffects0.4z[4,4]+RandomEffects0.4z[5,4])   
```


### 

### c) (Info) Interpretation of Model Performance

Remember as you read these that you can't rule out that there would be some other model that fits your data better - these values only test the relative chance that models you've proposed describe your data.

#### i) ICC

The first measure we got from different model structures was intra-class correlation (ICC). ICC tells us how much variance is explained by the particular cluster (and each cluster is broken down in the different models). Think of this like the R2 of a regression line. It is the percent correlation between the variables. In MLM/LMM, you want your ICC to be high enough that clustering matters (maybe over 10%?) but not SO high that it explains ALL of the variance in the data, leaving nothing for your between subject fixed factors (i.e. your main variables of interest) to explain anything. There is too much of a good thing in this case. It is very subjective, however, in terms of what a "good ICC" is. If you'd be impressed if your data had that value as an R2, it might be worth using the MLM/LMM approach. What this code generates is the "variation/clustering" captured by ICC-within (since all our random vars are within-subject) that your other variables of interest can try to explain. Thus, the higher ICC-within, the better as long as 1 minus the ICC (ICC-between) is still a large enough proportion to warrant further probing with your fixed factors.

#### ii) Log Likelihood, BIC, & AIC

The next measures we have are some measures of overall model fit to the data from log likelihood (logLik), "consistency" from Bayesian Information Criterion (BIC) and "efficiency" from Akaike Information Criterion (AIC). LogLik looks at fit simply whereas AIC tries to get the best fit with the least number of parameters (parsimony). BIC uses the fact that larger sample sizes most likely represent the "true model" to see how consistently new data fits into the model. There are two critical things to know about these measures: 1) they are all relative measures - they don't mean anything by themselves and are only useful when comparing different models and 2) because of they way they are computed, AIC and BIC indicate "better fit" when they are LOWER but loglikelihood indicates "better fit" when it is HIGHER.

From UNCDependLab on how much difference is a lot of difference: "Summarizing extensive simulation work, Burnham and Anderson (2002) offer useful rules-of-thumb for inferring the degree of certainty afforded to a particular model relative to the best fitting model in the set:

-   models within 0--2 points on the AIC also have substantial support

-   models in the 4--7 point range have considerably less support

-   models greater than 10 points apart have almost no support."

#### iii) Log-Likelihood Ratio Test (LRT)

Finally, we have the LRT which basically uses statistics to see if dropping a variable to the model significantly changes the fit of the model. Just one more piece to the puzzle. If you can drop a parameter from the model and it not change it, it's best to just drop it in favor of parsimony.

### d) Export UCM Results to Excel

```{r}
#Write these models, RandomEffects, and ICCs to an Excel spreadsheet 
ICCs<-ls(envir=.GlobalEnv, pattern="ICC_0") 
ICC<-data.frame(mget(ICCs),row.names="Values") 
ICC<-t(ICC) 
ICC[,"Values"]<-round(ICC[,"Values"],3)   
##TO-DO: Eventually want to add the variable names next to their ICC

models<-ls(envir=.GlobalEnv,pattern="model0") 
models.call<-lapply(mget(models),get_call) 
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))   
model.obs<-NULL 
model.obs.df<-NULL 

for(k in models){
  obs<-sapply(ranef(get(k)),nrow)   
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs))) 
  model.obs.df<-rbind(model.obs.df,model.obs) 
  }  

model.info<-merge(models.call.df,model.obs.df)  
LLR<-NULL 
LLR.df<-NULL 
for(k in models){ 
  LLR<-data.frame("Model"=k,rand(get(k)))  
  LLR.df<-rbind(LLR.df,LLR) 
}   

summary<-modelsummary::msummary(mget(models),stars=T, output="data.frame")

rands<-ls(envir=.GlobalEnv,pattern="RandomEffects0") 
random<-NULL 
random.df<-NULL 
for(k in rands){ 
  names<-names(get(k)) 
  random<-cbind("Model"=k,get(k))  
  random.df<-merge(random.df,random,by=intersect(names(random.df),names(random)),all=TRUE) 
  }  
random.df<-sort.data.frame(random.df,by="var1",na.last=TRUE) #puts residuals at bottom and decreasing complexity of terms for easy viewing  



write.xlsx(model.info,file=filemod2, sheetName = "UCM-Sig Info", append=TRUE, row.names=FALSE) 
write.xlsx(ICC,file=filemod2, sheetName = "UCM-Sig ICC", append=TRUE, row.names=TRUE) 

write.xlsx(LLR.df,file=filemod2, sheetName = "UCM-Sig LLR", append=TRUE, row.names=TRUE)  
 
write.xlsx(summary,file=filemod2, sheetName = "UCM-Sig Compare", append=TRUE, row.names=FALSE)  

write.xlsx(random.df,file=filemod2, sheetName = "UCM-Sig Var", append=TRUE, row.names=FALSE)  

#Optional: Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
#plotREsim(REsim(model0.2zd_fit),labs=TRUE) 

##You can also check to see if your similar models are significantly different from each other from an ANOVA 
#anova(model0.3z_fit, model0.3za_fit)
```

## 4) Mixed Model Omnibus Analysis

### a) Info & Level 1 Model

#### i) Fit Models 

```{r}
##ONCE YOU DECIDE ON YOUR FINAL MODEL, THEN PROCEED##

##So what I'm thinking is that the models I want to test are (Standardized Only): 

#Simple: 
#model0.0z_fit <- lmerTest::lmer(formula = signal ~ 1 + (1|Mouse),data=bout.analysis2_true.meanz2,na.action=na.exclude);

#Complex:
#model0.1za_fit <- lmerTest::lmer(formula = signal ~ 1+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2,  na.action=na.exclude);  

#model0.1ze_fit <- lmerTest::lmer(forumla = signal ~ 1+ (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude);

#model0.2zd_fit <- lmerTest::lmer(formula = signal ~ 1+ (1|Mouse:session)+(1|Mouse:Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude);  


## Patrick ran in SAS code using the PROC MIXED function and specified the MODEL PeakAfter= Solution|Sex/solution("the /solution" refers to options that will display the fixed-effect parameter estimates. This formula is equivalent to ## Solution Sex Solution*Sex - two main effects and an interaction), REPEATED /subject=Mouse which is the same as treating Mouse as a random effect except that it isn't constrained to be a positive correlation) and LSMEANS Solution Sex Solution*Sex/tdiff ("/tdiff is an option that makes it display the t-values in a comparison between LSMEAN estimates). We can do the same thing with the emmeans package. See supporting documents.

#In the Step-Up strategy for model building used here, we next add in Level 1 covariates and consider adding in random effects for these variables to Level 2 during the next step. I have chosen to fit both the "basic model" (0.0/0.0z) with data simply nested within Mouse, and the selected random effect model candidates to allow us to determine whether this more complex linear mixed modeling/multilevel modeling is worth the hassle (i.e. does it change any effects).

model1.0z_fit <- lmerTest::lmer(formula = signal ~ time + (1|Mouse),data=bout.analysis2_true.meanz2,na.action=na.exclude); #Singular

#Built on 0.1ze
model1.1z_fit <- lmerTest::lmer(formula = signal ~ time + (1|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude)  

#Built on 0.1za
model1.1za_fit <- lmerTest::lmer(formula = signal ~ time+(1|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2,  na.action=na.exclude);  

#Built on 0.2zd
model1.1zb_fit <- lmerTest::lmer(formula = signal ~ time+(1|Mouse:session)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2,  na.action=na.exclude);  


```

#### ii) Gather Model Summaries (for Export)

```{r}
models1<-ls(envir=.GlobalEnv,pattern="model1")
models.call<-lapply(mget(models1),get_call)
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))


model.obs<-NULL
model.obs.df<-NULL
for(k in models1){
obs<-sapply(ranef(get(k)),nrow)  
model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))
model.obs.df<-rbind(model.obs.df,model.obs)
}

model.info<-merge(models.call.df,model.obs.df)


summary<-modelsummary::msummary(mget(models1),stars=T,output="data.frame")
```

#### iii) (Optional) Plot Effects and Interactions**

```{r}
# ##Make plots & tables to probe interactions - IMPORTANT to do this BEFORE you refit models using REML=FALSE in next step which will change estimates slightly. MOI = "Model of interest" 

#moi<-model1.0_fit
#moi<-model1.3_fit
#moi<-model1.0z_fit
moi<-model1.1z_fit

sjPlot::tab_model(moi,
                   show.re.var= TRUE,
                   pred.labels =c("(Intercept)", "Time"),
                   dv.labels= "Effects of Variables on Signal")
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

```


#### iv) Make Model Comparisons 

```{r}
#Note that these comparisons are ONLY valid if both models have the same # of observations as their UCM counterparts! You will get a warning about fitting using REML=False and that is normal and can be ignored.
model.0z_anova<-anova(model0.0z_fit,model1.0z_fit)
model.1z_anova<-anova(model0.1ze_fit,model1.1z_fit)
model.1za_anova<-anova(model0.1za_fit,model1.1za_fit)
model.1zb_anova<-anova(model0.2zd_fit,model1.1zb_fit)

LLR<-rbind(model.0z_anova,model.1z_anova, model.1za_anova,model.1zb_anova)
```

#### v) Export Model Summaries and Comparisons to Excel

```{r}
#FYI sometimes the first Excel file is still processing when the second tries to run and it will error. Just run the code again by line.

write.xlsx(model.info,file=filemod2, sheetName = "Lvl1 Info", append=TRUE, row.names=FALSE)

write.xlsx(LLR,file=filemod2, sheetName = "Lvl1 LLR", append=TRUE, row.names=TRUE)

write.xlsx(summary,file=filemod2, sheetName = "Lvl1 Compare", append=TRUE, row.names=FALSE)
```

### b) Level 2 Model

#### i) Fit Models 

```{r}
#In the Step-Up strategy for model building used here, we next add in Level 2 covariates and consider adding in random effects for these variables to Level 3 during the next step. All of these models now include time as a random slope because we are looking at cross-level effects. See Heisig and Schaeffer 2019 for why this is true. (Also as a side note, when I did early comparisons between models including time as a random slope and not, the fit JUMPED higher. So it definitely fits the data but tested the addition here before incorporating all of the Lvl 2 measures)

# FIRST, experimenting with adding time to slopes.
model2.0z_fit <- lmerTest::lmer(formula = signal ~ time + (1+time|Mouse),data=bout.analysis2_true.meanz2,na.action=na.exclude); #Singular

model2.1z_fit<-lmerTest::lmer(formula= signal ~ time + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model2.1za_fit<-lmerTest::lmer(formula= signal ~ time + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model2.1zb_fit <- lmerTest::lmer(formula = signal ~ time + (1+time|Mouse:session)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2,  na.action=na.exclude);  
```

#### ii) Gather Model Summaries (for Export)

```{r}
models2<-ls(envir=.GlobalEnv,pattern="model2")
models.call<-lapply(mget(models2),get_call)
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))


model.obs<-NULL
model.obs.df<-NULL
for(k in models2){
obs<-sapply(ranef(get(k)),nrow)  
model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))
model.obs.df<-rbind(model.obs.df,model.obs)
}

model.info<-merge(models.call.df,model.obs.df)


summary<-modelsummary::msummary(mget(models2),stars=T,output="data.frame")
```

#### iii) (Optional) Plot Effects and Interactions

```{r}
# ##Make plots & tables to probe interactions - IMPORTANT to do this BEFORE you refit models using REML=FALSE in next step which will change estimates slightly. MOI = "Model of interest" 

moi<-model2.0zi_fit

# sjPlot::tab_model(moi,
#                    show.re.var= TRUE,
#                    pred.labels =c("(Intercept)", "Time","Indv Duration","Indv Lick Freq","Time x Indv Duration", "Time x Indv Lick Freq", "Indv Duration x Indv Lick Freq", "Time x Indv Duration x Indv Lick Freq"), dv.labels= "Effects of Variables on Signal")

sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Create Reference Grid for Estimated Marginal Means - Allows you to see what levels of multiple variables do to the dependent variable
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(LicksPerBout_imc=c(-1,0,2,4), Duration_imc=c(-1,0,3.5,6)))

# Plot specific interactions
emmip(RG, LicksPerBout_imc ~ Duration_imc | time, style = "factor", CIs=TRUE)
```


#### iv) Make Model Comparisons 

```{r}
#Note that these comparisons are ONLY valid if both models have the same # of observations as their UCM counterparts! You will get a warning about refitting models using REML=False and this is what is supposed to happen and can be ignored.
model.0z_anova<-anova(model1.0z_fit,model2.0z_fit)
model.1z_anova<-anova(model1.1z_fit,model2.1z_fit)
model.1za_anova<-anova(model1.1za_fit,model2.1za_fit)
model.1zb_anova<-anova(model1.1zb_fit,model2.1zb_fit)

LLR<-rbind(model.0z_anova,model.1z_anova,model.1za_anova, model.1zb_anova)
```

#### v) Export Model Summaries and Comparisons

```{r}

write.xlsx(model.info,file=filemod2, sheetName = "Lvl2 Info", append=TRUE, row.names=FALSE)

write.xlsx(summary,file=filemod2, sheetName = "Lvl2 Compare", append=TRUE, row.names=FALSE)

write.xlsx(LLR,file=filemod2, sheetName = "Lvl2 LLR", append=TRUE, row.names=TRUE)

```

### c) Level 3 Model



#### i) Fit Models 

```{r}
#In the Step-Up strategy for model building used here, we next add in Level 3 covariates and consider adding in random effects for these variables to Level 4 during the next step.   

model3.0z_fit <- lmerTest::lmer(formula = signal ~ time*Solution + (1+time|Mouse),data=bout.analysis2_true.meanz2,na.action=na.exclude); #SINGULAR

model3.1z_fit<-lmerTest::lmer(formula= signal ~ time*Solution + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model3.1za_fit<-lmerTest::lmer(formula= signal ~ time*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude)
                               
                               #,control=lmerControl(optimizer="bobyqa",optCtrl=list(xtol_abs=1e-9, ftol_abs=1e-9,maxfun=100000))); #To get to converge

model3.2z_fit<-lmerTest::lmer(formula= signal ~ time*Solution + (1+time|Mouse:session)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model3.2za_fit<-lmerTest::lmer(formula= signal ~ time*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);
```

#### ii) Gather Model Summaries (for Export)

```{r}
models3<-ls(envir=.GlobalEnv,pattern="model3") 
models.call<-lapply(mget(models3),get_call) 
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))   

model.obs<-NULL 
model.obs.df<-NULL 

for(k in models3){ 
  obs<-sapply(ranef(get(k)),nrow)   
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs))) 
  model.obs.df<-rbind(model.obs.df,model.obs) 
}  

model.info<-merge(models.call.df,model.obs.df)

summary<-modelsummary::msummary(mget(models3),stars=T,output="data.frame")
```

#### iii) (Optional) Plot Effects and Interactions

```{r}

moi<-model3.1z_fit

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(moi, lmer.df="satterthwaite",lmerTest.limit=5667)

             
# Plot specific interactions
emmip(RG, Solution~time, style = "factor", CIs=TRUE)

```


#### iv) Make Model Comparisons 
```{r}

#Note that these comparisons are ONLY valid if both models have the same # of observations as their UCM counterparts! You will get a warning about refitting models using REML=False and this is what is supposed to happen and can be ignored.

model.0z_anova<-anova(model2.0z_fit,model3.0z_fit) 
model.1z_anova<-anova(model2.1z_fit,model3.1z_fit) 
model.1za_anova<-anova(model2.1za_fit,model3.2z_fit) 
model.1zb_anova<-anova(model3.1z_fit,model3.2z_fit) 
 

LLR<-rbind(model.0z_anova,model.1z_anova,model.1za_anova, model.1zb_anova)    
```

#### iii) PostHoc Comparisons

```{r}
tukey.signal<-emmeans(model3.1za_fit, list(pairwise~time|Solution), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=4444) # just checks the effect of time for each




CI.signal<-confint(tukey.signal,level=0.95)



remove(tukey) 

tukey<-ls(envir=.GlobalEnv,pattern="tukey.signal") 
CI<-ls(envir=.GlobalEnv, pattern="CI.signal")
tuk.summary1<-NULL 
tuk.summary2<-NULL  
tuk.summary3<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
}

for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}
```


#### v) Export Model Summaries and Comparisons

```{r}
write.xlsx(model.info,file=filemod2, sheetName = "Lvl3 Info", append=TRUE, row.names=FALSE)

write.xlsx(summary,file=filemod2, sheetName = "Lvl3 Compare", append=TRUE, row.names=FALSE)

write.xlsx(LLR,file=filemod2, sheetName = "Lvl3 LLR", append=TRUE, row.names=TRUE) 

```

### d) Level 4 Model

#### i) Fit Models 

```{r}
#In the Step-Up strategy for model building, we next add in Level 4 covariates. 

#Simple Control
model4.0z_fit <- lmerTest::lmer(formula = signal ~ time*Solution*Sex +(1|Mouse),data=bout.analysis2_true.meanz2,na.action=na.exclude);

model4.0za_fit <- lmerTest::lmer(formula = signal ~ time*Solution*Sex +(1+time|Mouse),data=bout.analysis2_true.meanz2,na.action=na.exclude);

#Complex Models
model4.1z_fit<-lmerTest::lmer(formula= signal ~ time*Solution*Sex + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model4.1za_fit<-lmerTest::lmer(formula= signal ~ time*Solution*Sex + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model4.2z_fit<-lmerTest::lmer(formula= signal ~ time*Solution*Sex + (1+time|Mouse:session)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model4.2za_fit<-lmerTest::lmer(formula= signal ~ time*Solution*Sex + (1+time+Solution|Mouse:session)+(1|Mouse:Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);
```

#### ii) Gather Model Summaries (for Export)

```{r}
models4<-ls(envir=.GlobalEnv,pattern="model4")  
models.call<-lapply(mget(models4),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models4){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info4<-merge(models.call.df,model.obs.df)  

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg"="Drinking","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking_sol_imc" = "Drinking_within","Drinking_sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between")

summary4<-modelsummary::msummary(mget(models4),stars=T,output="data.frame",coef_rename = term.streamline)

# Test if every variable in the model is necessary by using the function drop1. 
model.drop4<-NULL  
model.drop.df4<-NULL   
for(k in models4){    
  drop4<-drop1(get(k))      
  model.drop4<-data.frame("Model"=k,drop4)  
  model.drop.df4<-rbind(model.drop.df4,model.drop4)  
  }    



## Now that we have our full model, one last check to see if any of the random terms should be dropped. Only do this once. You'll need the LLR for the rest of the models for model comparison. AKA - comment this part out after doing once with the base models.
# 
LLR<-NULL
LLR.df4<-NULL
for(k in models4){
  LLR<-data.frame("Model"=k,rand(get(k)))
  LLR.df4<-rbind(LLR.df4,LLR)
}

```

#### iii) (Optional) Plot Effects and Interactions

```{r}
moi<-model4.1z_fit


# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Random Effects Plot (EBLUP)
plotREsim(REsim(moi),labs=TRUE) 
  
# Create Reference Grid for Estimated Marginal Means
#RG<-ref_grid(moi, pbkrtest.limit = 5667)
#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Drinking.mL.kg_gmc=c(-0.8,0,1.2)))
#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Drinking.mL.kg_imc=c(-1,0,1)))
#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Drinking.mL.kg_imc=c(-0.5,0,0.5),Drinking.mL.kg_gmc=c(-0.5,0,0.5)))

#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(EtOH.gkg_imc=c(-1,0,1)))   
#RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(EtOH.gkg_imc=c(-1,0,1),EtOH.gkg_gmc=c(-2,0,0.8)))             

# Plot specific interactions
#emmip(RG, Solution~time|Sex, style = "factor", CIs=TRUE)+facet_wrap(Sex~time)
#emmip(RG, Solution~Drinking.mL.kg_imc|Sex*time, style = "factor", CIs=TRUE)+facet_wrap(Sex*time~Solution)+scale_color_manual(values=c(c2,c1,c3))
#emmip(RG, Solution~Drinking.mL.kg_gmc|Sex*time, style = "factor", CIs=TRUE)+facet_wrap(Sex*time~Solution)
emmip(RG, Drinking.mL.kg_imc*Solution~Drinking.mL.kg_gmc|Sex*time, style = "factor", CIs=TRUE)+facet_wrap(Sex*time~Solution)
emmip(RG, Drinking.mL.kg_imc*Solution~Drinking.mL.kg_gmc|time, style = "factor", CIs=TRUE)+facet_wrap(time~Solution)
emmip(RG, Drinking.mL.kg_imc*Solution~Drinking.mL.kg_gmc|Sex, style = "factor", CIs=TRUE)+facet_wrap(Sex~Solution)

emmip(RG, EtOH.gkg_imc ~ time|Sex, style = "factor", CIs=TRUE)

emmip(RG, EtOH.gkg_imc ~ EtOH.gkg_gmc|Sex*time, style = "factor", CIs=TRUE)+facet_wrap(Sex~time)

emmeans()

#Optional: Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
#plotREsim(REsim(moi),labs=TRUE) 



moi<-model4.0zduration_fit2

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,1)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,4)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_gmc=c(-0.8,0,1.2)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,1),Drinking.mL.kg_gmc=c(-0.8,0,1.2)))
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,1)))   
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Duration_imc=c(-1,0,1),Duration_gmc=c(-2,0,0.8)))             

# Plot specific interactions
#emmip(RG, Solution~Duration_imc|time, style = "factor", CIs=TRUE)+facet_wrap(time~Solution)
#emmip(RG, Solution~Duration_imc|Sex, style = "factor", CIs=TRUE)+facet_wrap(~Sex)
emmip(RG, Duration_imc~time|Solution, style = "factor", CIs=TRUE)

emmip(RG, Duration_imc~time|Sex*Solution, style = "factor", CIs=TRUE)+facet_wrap(Sex~Solution)

#Optional: Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
#plotREsim(REsim(moi),labs=TRUE) 


moi<-model4.0zp_fit

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")

# Effects Plot
sjPlot::plot_model(moi,
 	show.values= TRUE, show.p=TRUE,
                   title= "Effects of Variables on Signal")

# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(moi, pbkrtest.limit = 5667)
         

# Plot specific interactions
emmip(RG, Sex~time|Solution, style = "factor", CIs=TRUE)

#Optional: Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
#plotREsim(REsim(moi),labs=TRUE) 
```

#### iv) Make Model Comparisons 

```{r}

#Note that these comparisons are ONLY valid if both models have the same # of observations as their UCM counterparts! You will get a warning that the models were refit using REML=FALSE. This is normal.

model.0z_anova<-anova(model3.0z_fit,model4.0z_fit)  
model.1z_anova<-anova(model3.1z_fit,model4.1z_fit)  
model.2z_anova<-anova(model3.2z_fit,model4.2z_fit) 

LLR4<-rbind(model.0z_anova,model.1z_anova,model.2z_anova)
```

#### v) PostHoc Comparisons

```{r}
## Only run the ones justified by the omnibus statistics or ones that are specific comparisons not given by the model
#Time, Solution, & Sex: Compare Water between Sexes for full 3-factor analysis of "control" group and 3-way interaction between Sucrose + QHCl (Low) 
tukey.signal<-emmeans(model4.1z_fit, list(pairwise~time|Solution*Sex), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=4444,at=list(Solution=c("Water","Sucrose + QHCl (Low)"))) 
simple.tukey<-pairs(pairs(tukey.signal),simple="Sex") # Contrast of contrasts
simple.tukey1<-pairs(pairs(tukey.signal),simple="Solution") # Contrast of contrasts

#Solution: Compare Suc + QHCl mixtures - signal by time
tukey.signal1<-emmeans(model4.1z_fit, list(pairwise~time|Solution), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=4444,at=list(Solution=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)"))) 
simple.tukey2<-pairs(pairs(tukey.signal1),simple="Solution")

#Solution: Compare Suc + QHCl mixtures - avg signal
tukey.signal2<-emmeans(model4.1z_fit, list(pairwise~Solution), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=4444,at=list(Solution=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)"))) 

#Solution & Sex: Compare Water and Suc + QHCl mixtures divided by sex to probe interactions
tukey.signal3<-emmeans(model4.1z_fit, list(pairwise~Solution|Sex), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=4444,at=list(Solution=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","Water")))

#Time, Solution & Sex: Compare Suc + QHCl mixtures effect of time divided by sex to probe interactions
tukey.signal4<-emmeans(model4.1z_fit, list(pairwise~time|Solution*Sex), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=4444,at=list(Solution=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)")))
simple.tukey3<-pairs(pairs(tukey.signal4),simple="Solution") # Contrast of contrasts
simple.tukey4<-pairs(pairs(tukey.signal4),simple="Sex") # Contrast of contrasts

#Solution & Sex: Compare QHCl divided by sex to probe interactions
tukey.signal5<-emmeans(model4.1z_fit, list(pairwise~Solution|Sex), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=4444,at=list(Solution=c("QHCl (Low)")))
simple.tukey5<-pairs(tukey.signal5,simple="Sex") # Contrast


CI.signal<-confint(tukey.signal,level=0.95)
CI.signal1<-confint(tukey.signal1,level=0.95)
CI.signal2<-confint(tukey.signal2,level=0.95)
CI.signal3<-confint(tukey.signal3,level=0.95)
CI.signal4<-confint(tukey.signal4,level=0.95)
CI.signal5<-confint(tukey.signal5, level=0.95)

CI.simple<-confint(simple.tukey,level=0.95)
CI.simple1<-confint(simple.tukey1,level=0.95)
CI.simple2<-confint(simple.tukey2,level=0.95)
CI.simple3<-confint(simple.tukey3,level=0.95)
CI.simple4<-confint(simple.tukey4,level=0.95)
CI.simple5<-confint(simple.tukey5,level=0.95)


remove(tukey)
remove(CI)
remove(simple)
remove(CI.simp)
tukey<-ls(envir=.GlobalEnv,pattern="tukey.signal") 
CI<-ls(envir=.GlobalEnv,pattern="CI.signal") 
simple<-ls(envir=.GlobalEnv,pattern="simple.tukey")
CI.simp<-ls(envir=.GlobalEnv,pattern="CI.simple")

tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL
tuk.summary4<-NULL
tuk.summary5<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
}

for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}

##For simple comparisions
for (n in 1:length(simple)){
temp<-NULL
temp<-rbind(summary(get(simple[[n]])),temp)
temp<-cbind(temp,"Test"=rep(simple[n],nrow(temp)))
tuk.summary4<-rbind.fill(tuk.summary4,temp)
}
for (n in 1:length(CI.simp)){
temp<-NULL
temp<-rbind(get(CI.simp[[n]]),temp)
temp<-cbind(temp,"Test"=rep(CI.simp[n],nrow(temp)))
tuk.summary5<-rbind.fill(tuk.summary5,temp)
}

```



#### v) Export Model Summaries and Comparisons

```{r}
write.xlsx(model.info4,file=filemod2, sheetName = "Signal_Lvl4 Info", append=TRUE, row.names=FALSE)  

write.xlsx(summary4,file=filemod2, sheetName = "Signal_Lvl4 Compare", append=TRUE, row.names=FALSE)  

write.xlsx(LLR4,file=filemod2, sheetName = "Signal (Lvl4-3) LLR", append=TRUE, row.names=TRUE)

write.xlsx(LLR.df4,file=filemod2, sheetName = "Signal (Lvl4) LLR", append=TRUE, row.names=TRUE) 
write.xlsx(model.drop.df4,file=filemod2, sheetName = "Signal (Lvl4) Drop1", append=TRUE, row.names=TRUE) 

write.xlsx(tuk.summary1,file=filemod3, sheetName = "Signal(Lvl4) PostHoc Est Means", append=TRUE, row.names=TRUE)
write.xlsx(tuk.summary2,file=filemod3, sheetName = "Signal(Lvl4) PostHoc Pairs", append=TRUE, row.names=TRUE)
write.xlsx(tuk.summary3,file=filemod3, sheetName = "Signal(Lvl4) PostHoc Pairs CIs", append=TRUE, row.names=TRUE)
write.xlsx(tuk.summary4,file=filemod3, sheetName = "Signal(Lvl4) PostHoc Simple", append=TRUE, row.names=TRUE)
write.xlsx(tuk.summary5,file=filemod3, sheetName = "Signal(Lvl4) PostHoc Simple CIs", append=TRUE, row.names=TRUE)
```

### e) Characteristics Models: Bout & Session Characteristics

#### i) Unconditional Means Models (UCM)

```{r}
## Note here that the random structure may be slightly different between them because of what level they are at and there may not be enough variation to prevent it from model issues. So we need to check on a structure for each outcome first! You also need to clear out any other UCMs from signal otherwise they will export along with these. 

#Also, the dataset each model uses differs. I decided to use the dataset that was the simplest AT the level of the outcome. So session level stats (Total Bouts, Consumption) use the session.analysis3 dataset (1 row per session) and bout level outcomes use the data.analysis_true dataset (1 row per bout)

#Unconditional Means Models 

#Drinking.mL.kg
#Negative Control
model0.drink_fit<-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|Mouse),data=session.analysis3, na.action=na.exclude);

#Rest of the random structures to test
model0.drink_fita <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);
model0.drink_fitb <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|session),data=session.analysis3, na.action=na.exclude);
model0.drink_fitc <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|Mouse:session)+(1|Mouse),data=session.analysis3, na.action=na.exclude);
model0.drink_fitd <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|Mouse:session) + (1|session),data=session.analysis3, na.action=na.exclude);
model0.drink_fite <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|session) + (1|Mouse),data=session.analysis3, na.action=na.exclude);
model0.drink_fitf <-lmerTest::lmer(formula= Drinking.mL.kg ~ 1 + (1|session) + (1|Mouse) + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);

# #Lick Frequency
# #Negative Control
# model0.freq_fit<-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
# 
# #Rest of the random structures to test
# model0.freq_fita <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
# model0.freq_fitb <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|session) + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
# model0.freq_fitc <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout),data=data.analysis_true, na.action=na.exclude);
# model0.freq_fitd <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# model0.freq_fite <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|session),data=data.analysis_true, na.action=na.exclude);
# model0.freq_fitf <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# model0.freq_fitg <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|Mouse)+(1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# model0.freq_fith <-lmerTest::lmer(formula= LickFrequency ~ 1 + (1|session)+(1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# 
# 
# #Session Total Bouts
# model0.bout_fit<-lmerTest::lmer(formula= Bout_max ~ 1 + (1|Mouse),data=session.analysis3, na.action=na.exclude);
# model0.bout_fita <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);
# model0.bout_fitb <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|session),data=session.analysis3, na.action=na.exclude);
# model0.bout_fitc <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|Mouse:session)+(1|Mouse),data=session.analysis3, na.action=na.exclude);
# model0.bout_fitd <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|Mouse:session) + (1|session),data=session.analysis3, na.action=na.exclude);
# model0.bout_fite <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|session) + (1|Mouse),data=session.analysis3, na.action=na.exclude);
# model0.bout_fitf <-lmerTest::lmer(formula= Bout_max ~ 1 + (1|session) + (1|Mouse) + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);
# 
# 
# #LicksPerBout
# model0.lick_fit<-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
# model0.lick_fita <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
# model0.lick_fitb <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|session) + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
# model0.lick_fitc <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout),data=data.analysis_true, na.action=na.exclude);
# model0.lick_fitd <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# model0.lick_fite <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|session),data=data.analysis_true, na.action=na.exclude);
# model0.lick_fitf <-lmerTest::lmer(formula= LicksPerBout ~ 1 + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# 
# #Bout Duration
# model0.duration_fit<-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
# model0.duration_fita <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
# model0.duration_fitb <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|session) + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
# model0.duration_fitc <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout),data=data.analysis_true, na.action=na.exclude);
# model0.duration_fitd <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# model0.duration_fite <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session) + (1|Mouse:session:Bout) + (1|session),data=data.analysis_true, na.action=na.exclude);
# model0.duration_fitf <-lmerTest::lmer(formula= BoutDuration ~ 1 + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# 
# #EtOH.gkg
# model0.etoh_fit<-lmerTest::lmer(formula= EtOH.gkg ~ 1 + (1|Mouse),data=session.analysis3, na.action=na.exclude);
# #model0.etoh_fita <-lmerTest::lmer(formula= EtOH.gkg ~ 1 + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);#Has error with grouping levels being > obs
# model0.etoh_fitb <-lmerTest::lmer(formula= EtOH.gkg ~ 1 + (1|session),data=session.analysis3, na.action=na.exclude); 
# model0.etoh_fitc <-lmerTest::lmer(formula= EtOH.gkg ~ 1 + (1|session) + (1|Mouse),data=session.analysis3, na.action=na.exclude);


models0<-ls(envir=.GlobalEnv,pattern="model0")  
models.call<-lapply(mget(models0),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models0){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info0c<-merge(models.call.df,model.obs.df)  

summary0c<-modelsummary::msummary(mget(models0),stars=T,output="data.frame")

LLR<-NULL 
LLR.df0c<-NULL 
for(k in models0){ 
  LLR<-data.frame("Model"=k,rand(get(k)))  
  LLR.df0c<-rbind(LLR.df0c,LLR) 
  }   

write.xlsx(model.info0c,file=filemod2, sheetName = "Characters UCM Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary0c,file=filemod2, sheetName = "Characters UCM", append=TRUE, row.names=FALSE)  
write.xlsx(LLR.df0c,file=filemod2,sheetName = "Characters UCM LLR",append=TRUE)


```

#### ii) Fit Models

```{r}
# model5.bout_basic <-lm(formula= TotalBouts_Total ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
#  
# model5.bout_nested <-lmerTest::lmer(formula= Bout_max ~ Sex*Solution + (1|Mouse),data=session.analysis3, na.action=na.exclude);
#  
# model5.bout_fit <-lmerTest::lmer(formula= Bout_max ~ Sex*Solution + (1|Mouse),data=session.analysis3, na.action=na.exclude); #Doesn't converge with Solution slope


model5.drink_fita <-lmerTest::lmer(formula= Drinking.mL.kg ~ Sex*Solution + (1|Mouse:session),data=session.analysis3, na.action=na.exclude);

model5.drink_fitb <-lmerTest::lmer(formula= Drinking.mL.kg ~ Sex*Solution + (1|session),data=session.analysis3, na.action=na.exclude);

model5.drink_basic <-lm(formula= Drinking.mL.kg_mean ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
 
model5.drink_nested <-lmerTest::lmer(formula= Drinking.mL.kg ~ Sex*Solution + (1|Mouse),data=session.analysis3, na.action=na.exclude);
 

# model5.duration_fita <-lmerTest::lmer(formula= BoutDuration ~ Sex*Solution + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
# 
# model5.duration_basic <-lm(formula= BoutDuration_mean_mean ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
#  
# model5.duration_nested <-lmerTest::lmer(formula= BoutDuration ~ Sex*Solution + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
# 
# 
# model5.lick_fita <-lmerTest::lmer(formula= LicksPerBout ~ Sex*Solution + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);
# 
# model5.lick_basic <-lm(formula= LicksPerBout_mean_mean ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
#  
# model5.lick_nested <-lmerTest::lmer(formula= LicksPerBout ~ Sex*Solution + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
#  
# 
# model5.freq_fitf <-lmerTest::lmer(formula= LickFrequency ~ Sex*Solution + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);
# 
# model5.freq_basic <-lm(formula= LickFrequency_mean_mean ~ Sex*Solution,data=subject.analysis_avgs2, na.action=na.exclude);
#  
# model5.freq_nested <-lmerTest::lmer(formula= LickFrequency ~ Sex*Solution + (1|Mouse),data=data.analysis_true, na.action=na.exclude);
#  
# 
# model5.etoh_fit <-lmerTest::lmer(formula= EtOH.gkg ~ Sex + (1|Mouse),data=session.analysis3, na.action=na.exclude);
# 

#model5.positionduration_fit <-lmerTest::lmer(formula= BoutDuration ~ Sex*Solution*Position + (1|Mouse:session),data=data.analysis_true, na.action=na.exclude);


#model5.positionfreq_fit <-lmerTest::lmer(formula= LickFrequency ~ Sex*Solution*Position + (1|Mouse:session) + (1|Bout),data=data.analysis_true, na.action=na.exclude);


```

#### iii) Gather Model Summaries (for Export)

```{r}

models5<-ls(envir=.GlobalEnv,pattern="model5")  
models.call<-lapply(mget(models5),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models5){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info5<-merge(models.call.df,model.obs.df)  

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg"="Drinking","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking_sol_imc" = "Drinking_within","Drinking_sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between")

summary5<-modelsummary::msummary(mget(models5),stars=T,output="data.frame",coef_rename = term.streamline)

remove(model5.drink_basic)
models5<-ls(envir=.GlobalEnv,pattern="model5")
LLR<-NULL 
LLR.df5<-NULL 
for(k in models5){ 
  LLR<-data.frame("Model"=k,rand(get(k)))  
  LLR.df5<-rbind(LLR.df5,LLR) 
  }   
```

#### iv) (Optional) Plot Effects and Interactions

```{r}
moi<-model5.drink_fitb
moi.name<-"model5.drink_fitb"

models.call<-lapply(mget(moi),get_call)  

#Effects plot
plot_model(moi, show.values = TRUE, vline.color = "black")

#Effects Table
sjPlot::tab_model(moi,show.ci=0.95,show.df=TRUE,show.r2=TRUE,show.icc=TRUE, show.p=TRUE,show.stat=TRUE,show.aic=TRUE,show.re.var= TRUE, title= moi.name,digits=3, digits.p= 4, df.method = "satterthwaite",col.order = c("est", "se", "std.est", "std.se", "ci", "std.ci", "ci.inner", "ci.outer","df.error", "stat", "std.stat", "p", "std.p", "response.level"))

##Plot interactions
emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### v) PostHoc Comparisons

```{r}
tukey5.drink<-emmeans(model5.drink_nested, list(pairwise ~ Solution), adjust = "tukey",lmer.df="satterthwaite")
CI.5drink<-confint(tukey5.drink,level=0.95)



remove(tukey)
remove(CI)
tukey<-ls(envir=.GlobalEnv,pattern="tukey5") 
CI<-ls(envir=.GlobalEnv,pattern="CI.5") 
tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
}

for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}

```

#### vi) Export Model Summaries and PostHoc Comparisons

```{r}

write.xlsx(model.info5,file=filemod2, sheetName = "Characters Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary5,file=filemod2, sheetName = "Characters Omnibus", append=TRUE, row.names=FALSE)  
write.xlsx(LLR.df5,file=filemod2, sheetName = "Characters LLR", append=TRUE, row.names=FALSE)  

write.xlsx(tuk.summary1,file=filemod3,sheetName = "Characters Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filemod3,sheetName = "Characters Tukey_Pairs",append=TRUE)
write.xlsx(tuk.summary3,file=filemod3,sheetName = "Characters Tukey_CI",append=TRUE)


```

### f) Signal-Drinking Models (NOT USED)

#### i) Fit Models - DID NOT DO FOR THIS EXPERIMENT

```{r}
#Drinking.sol_imc - need to filter out inf values from the problem children
#Four pesky Inf values for #9 have to be filtered out
bout.analysis2_true.meanz22<-subset(bout.analysis2_true.meanz2,!Drinking.sol_imc=="Inf")

#Drinking.mL.kg Control Models
#Drinking.mL.kg_imc
model4.2zcdrink_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_imc + (1|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);
#Drinking.mL.kg_sol_imc*Drinking.mL.kg_grpmc
model4.2zcdrink_nested9 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_imc*Drinking.mL.kg_grpmc + (1|Mouse),data=bout.analysis2_true.meanz22, na.action=na.exclude);

#Drinking.mL.kg_imc
model4.2zcdrink_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#Drinking.sol_imc
model4.2zcdrink_fit1 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz22, na.action=na.exclude);

#Drinking.mL.kg_gmc
model4.2zcdrink_fit2 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#Drinking.mL.kg_smc
model4.2zcdrink_fit3 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_smc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#Drinking.mL.kg_grpmc
model4.2zcdrink_fit4 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#Drinking.sol_gmc
model4.2zcdrink_fit5 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

## Filter out everything but EtOH sessions:
bout.analysis2_true.meanz2e<-subset(bout.analysis2_true.meanz2,!is.na(EtOH.gkg)==TRUE)
bout.analysis2_true.meanz2e<-subset(bout.analysis2_true.meanz2e,!EtOH.gkg_imc=="-Inf")

#EtOH.gkg_imc
model4.2zcdrink_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*EtOH.gkg_imc + (1+time|Mouse:session)+(1|Mouse:session:Bout),data=bout.analysis2_true.meanz2e, na.action=na.exclude); # Removed (1|Bout) because effect was 0

#EtOH.gkg_gmc
model4.2zcdrink_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*EtOH.gkg_gmc + (1+time|Mouse:session)+(1|Mouse:session:Bout),data=bout.analysis2_true.meanz2e, na.action=na.exclude); # Removed (1|Bout) because effect was 0

#EtOH.gkg_smc
model4.2zcdrink_fit8 <-lmerTest::lmer(formula= signal ~ time*Sex*EtOH.gkg_smc + (1+time|Mouse:session)+(1|Mouse:session:Bout),data=bout.analysis2_true.meanz2e, na.action=na.exclude); # Removed (1|Bout) because effect was 0


#Drinking.sol_imc * Drinking.mL.kg_grpmc

##Did not converge
#model4.2zcdrink_fit9 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_imc*Drinking.mL.kg_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz22, na.action=na.exclude);

#Removed Solution random slope - results in less fit overall so hard to interpret
model4.2zcdrink_fit9 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.sol_imc*Drinking.mL.kg_grpmc + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz22, na.action=na.exclude);
```

#### ii) (Optional) Plot Effects

```{r}
moi<-model4.2zcdrink_fit9
moi.name<-"model4.2zcdrink_fit9"

# Effects Table
sjPlot::tab_model(moi,
          show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")


# Effects Plot
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name))
#800 x 600

##Plot it!
emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### iii) PostHoc Comparisons

```{r}
tukey.drink<-emmeans(model4.2zcdrink_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=5663,at=list("Drinking.mL.kg_imc"=c(-1,0,1)))
CI.drink<-confint(tukey.drink,level=0.95)

tukey.drink1<-emmeans(model4.2zcdrink_fit1, list(pairwise ~ Solution*Sex), adjust = "tukey",pbkrtest.limit = 5664)
tukey.drink2<-emmeans(model4.2zcdrink_fit2, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664)
tukey.drink3<-emmeans(model4.2zcdrink_fit3, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664)
tukey.drink4<-emmeans(model4.2zcdrink_fit4, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664)


remove(tukey)
tukey<-ls(envir=.GlobalEnv,pattern="tukey.drink") 
tuk.summary1<-NULL
tuk.summary2<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)

}
```

#### iv) Export Model Summaries

```{r}

models.drink<-ls(envir=.GlobalEnv,pattern="model4.2zcdrink")  
models.call<-lapply(mget(models.drink),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models.drink){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.infosd<-merge(models.call.df,model.obs.df)  

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking.sol_imc" = "Drinking_within","Drinking.sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between","EtOH.gkg_imc"="Drinking_within","EtOH.gkg_smc"="Drinking_between","EtOH.gkg_gmc"="Drinking_between")

summarysd<-modelsummary::msummary(mget(models.drink),stars=T,output="data.frame",coef_rename = term.streamline)


write.xlsx(model.infosd,file=filemod2, sheetName = "Signal-Drink Info", append=TRUE, row.names=FALSE)  
write.xlsx(summarysd,file=filemod2, sheetName = "Signal-Drink Compare", append=TRUE, row.names=FALSE)  

write.xlsx(tuk.summary1,file=filemod3,sheetName = "Signal-Drink Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filemod3,sheetName = "Signal-Drink Tukey_Pairs",append=TRUE)

```

#### v) Make Model Comparisons

```{r}
#To compare the two models - Signal Lvl4 and Signal-Drink, we need to refit all models using REML=F.  
model4.2zc_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude, REML=FALSE); 

model4.2zcdrink_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude, REML=FALSE); 

#Note that these comparisons are ONLY valid if both models have the same # of observations!  

model.0z_anova<-anova(model4.2zcdrink_fit,model4.2zc_fit)  

LLR4<-rbind(model.0z_anova)
write.xlsx(LLR4,file=filemod2,sheetName = "Signal-Drink LLR",append=TRUE)

```
### g) Signal_Duration Models (NOT USED)

#### i) Fit Models

```{r}
#Duration Control Models
#Duration_imc
model4.2zcDuration_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_imc + (1|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude); #Singular
#Duration_sol_imc*Duration_grpmc
model4.2zcdDuration_nested6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_sol_imc*Duration_grpmc + (1|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#BoutDuration_imc
model4.2zcDuration_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#BoutDuration_sol_imc
model4.2zcDuration_fit1 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#BoutDuration_gmc
model4.2zcDuration_fit2 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#BoutDuration.sol_gmc
model4.2zcDuration_fit3 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_sol_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#BoutDuration_smc
model4.2zcDuration_fit4 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_smc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#BoutDuration_grpmc
model4.2zcDuration_fit5 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#BoutDuration_grpmc*Duration_sol_imc
model4.2zcDuration_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_grpmc*Duration_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#BoutDuration_gmc*Duration_imc
model4.2zcDuration_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Duration_gmc*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);
```

#### ii) (Optional) Plot Effects

```{r}
moi<-model4.2zcDuration_fit7 
moi.name<-"model4.2zcDuration_fit7"  

# Effects Table sjPlot::tab_model(moi,           show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")  
# Effects Plot 
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name)) #1000 x 600  
##Plot it! 
emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### iii) PostHoc Comparisons

```{r}
tukey.drink<-emmeans(model4.2zcdrink_fit, list(pairwise ~ Solution*Sex*time),at=list("Drinking.mL.kg_imc"=c(1)), adjust = "tukey",pbkrtest.limit = 5664)  

remove(tukey) 
tukey<-ls(envir=.GlobalEnv,pattern="tukey.drink")  
tuk.summary1<-NULL 
tuk.summary2<-NULL  
for (n in 1:length(tukey)){ 
  temp<-NULL 
  temp2<-NULL 
  temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
  temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
  tuk.summary1<-rbind.fill(tuk.summary1,temp)
  temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
  temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
  tuk.summary2<-rbind.fill(tuk.summary2,temp2)  
  }
```

#### iv) Export Model Summaries

```{r}
models.duration<-ls(envir=.GlobalEnv,pattern="model4.2zcDuration")   
models.call<-lapply(mget(models.duration),get_call)   
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))       

model.obs<-NULL   
model.obs.df<-NULL    
for(k in models.duration){       
  obs<-sapply(ranef(get(k)),nrow)         
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))       
  model.obs.df<-rbind(model.obs.df,model.obs)    
  }      
model.info<-merge(models.call.df,model.obs.df)    

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg"="Drinking","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking_sol_imc" = "Drinking_within","Drinking_sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between")

summary<-modelsummary::msummary(mget(models.duration),stars=T,output="data.frame",coef_rename = term.streamline)  

write.xlsx(model.info,file=filemod2, sheetName = "Signal-Duration Info", append=TRUE, row.names=FALSE)   
write.xlsx(summary,file=filemod2, sheetName = "Signal-Duration Compare", append=TRUE, row.names=FALSE)   

#write.xlsx(tuk.summary1,file=filemod3,sheetName = "Signal-Drink Tukey_Means",append=TRUE) 
#write.xlsx(tuk.summary2,file=filemod3,sheetName = "Signal-Drink Tukey_Pairs",append=TRUE) 
```
#### v) Make Model Comparisons

```{r}
#To compare the two models - Signal Lvl4 and Signal-Drink, we need to refit all models using REML=F.  
model4.2zc_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude, REML=FALSE); 

model4.2zcDuration_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude, REML=FALSE); 

#Note that these comparisons are ONLY valid if both models have the same # of observations!  

model.0z_anova<-anova(model4.2zcDuration_fit,model4.2zc_fit)  

LLR4<-rbind(model.0z_anova)
write.xlsx(LLR4,file=filemod2,sheetName = "Signal-Duration LLR",append=TRUE)

```
### 

```{r} ##CHECK RANDOM STRUCTURE!!}


#LickFrequency
model4.0zfreq_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_imc + (1+time|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model4.0zfreq_fit2 <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LickFrequency_gmc + (1+time|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model4.0zfreq_fit3 <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LickFrequency_gmc*LickFrequency_imc + (1+time|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model4.0zfreq_fit3a <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LickFrequency_gmc*LickFrequency_imc + (1+time+Solution|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#LicksPerBout
model4.0zlick_fit <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model4.0zlick_fit2 <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LicksPerBout_gmc + (1+time|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

model4.0zlick_fit3 <-lmerTest::lmer(formula= signal ~ time *Sex*Solution*LicksPerBout_gmc*LicksPerBout_imc + (1+time|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

```

### h) Signal_Frequency Models (NOT USED)

#### i) Fit Models

```{r}
#LickFrequency Control Models
#LickFrequency_imc
model4.2zcLickFreq_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_imc + (1|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude); #Singular
#LickFrequency_sol_imc*LickFrequency_sol_gmc
model4.2zcLickFreq_nested7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_sol_gmc*LickFrequency_sol_imc + (1|Mouse),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#LickFrequency_imc 
model4.2zcLickFreq_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);  

#LickFrequency_sol_imc 
model4.2zcLickFreq_fit1 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);  

#LickFrequency_gmc 
model4.2zcLickFreq_fit2 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#LickFrequency_sol_gmc 
model4.2zcLickFreq_fit3 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_sol_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#LickFrequency_smc 
model4.2zcLickFreq_fit4 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_smc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#LickFrequency_grpmc 
model4.2zcLickFreq_fit5 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);  

#LickFrequency__grpmc*LickFrequency__sol_imc 
model4.2zcLickFreq_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_grpmc*LickFrequency_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#LickFrequency_sol_gmc*LickFrequency_sol_imc 
model4.2zcLickFreq_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*LickFrequency_sol_gmc*LickFrequency_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);
```

#### ii) (Optional) Plot Effects

```{r}
moi<-model4.2zcLickFreq_fit7 
moi.name<-"model4.2zcLickFreq_fit7"    

# Effects Table 
sjPlot::tab_model(moi,show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")   

# Effects Plot  
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name)) #1000 x 600   

##Plot it!  
emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### iii) PostHoc Comparisons

```{r}
tukey.drink<-emmeans(model4.2zcdrink_fit, list(pairwise ~ Solution*Sex*time), adjust = "tukey",pbkrtest.limit = 5664) tukey.drink1<-emmeans(model4.2zcdrink_fit1, list(pairwise ~ Solution*Sex), adjust = "tukey",pbkrtest.limit = 5664) tukey.drink2<-emmeans(model4.2zcdrink_fit2, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664) tukey.drink3<-emmeans(model4.2zcdrink_fit3, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664) tukey.drink4<-emmeans(model4.2zcdrink_fit4, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664)   remove(tukey) tukey<-ls(envir=.GlobalEnv,pattern="tukey.drink")  tuk.summary1<-NULL tuk.summary2<-NULL  for (n in 1:length(tukey)){ temp<-NULL temp2<-NULL temp<-rbind(summary(get(tukey[[n]])[[1]]),temp) temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp))) tuk.summary1<-rbind.fill(tuk.summary1,temp) temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2) temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2))) tuk.summary2<-rbind.fill(tuk.summary2,temp2)  }
```

#### iv) Export Model Summaries

```{r}
models.freq<-ls(envir=.GlobalEnv,pattern="model4.2zcLickFreq")    
models.call<-lapply(mget(models.freq),get_call)    
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))         

model.obs<-NULL    
model.obs.df<-NULL     
for(k in models.freq){          
  obs<-sapply(ranef(get(k)),nrow)            
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))          
  model.obs.df<-rbind(model.obs.df,model.obs)       
  }      
model.info<-merge(models.call.df,model.obs.df)     

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking.sol_imc" = "Drinking_within","Drinking.sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between","EtOH.gkg_imc"="Drinking_within","EtOH.gkg_smc"="Drinking_between","EtOH.gkg_gmc"="Drinking_between")

summarysf<-modelsummary::msummary(mget(models.freq),stars=T,output="data.frame",coef_rename = term.streamline)   

write.xlsx(model.info,file=filemod2, sheetName = "Signal-LickFreq Info", append=TRUE, row.names=FALSE)    
write.xlsx(summarysf,file=filemod2, sheetName = "Signal-LickFreq Compare", append=TRUE, row.names=FALSE)     

#write.xlsx(tuk.summary1,file=filemod3,sheetName = "Signal-Drink Tukey_Means",append=TRUE)  
#write.xlsx(tuk.summary2,file=filemod3,sheetName = "Signal-Drink Tukey_Pairs",append=TRUE) 
```

### 

### h) Signal_Position Models (NOT USED)

#### i) Fit Models

```{r}
#Position Control - H2O
model4.0zPos_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position + (1|Mouse),data=bout.analysis2_true.meanz2.h2o, na.action=na.exclude); #SINGULAR

#Position Control - QHCl
model4.0zPos_nested <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position + (1|Mouse),data=bout.analysis2_true.meanz2.qhcl, na.action=na.exclude); #Rank Deficient

#Position Alone - H2O
model4.1zbPos_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2.h2o, na.action=na.exclude); #DOES NOT CONVERGE 

model4.1zbPos_fita <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position + (1+time|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2.h2o, na.action=na.exclude); #Converges!!









##Didn't run with CL20
#Position + Duration_imc
model4.2zcPos_fit2 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#Position + Duration_grpmc
model4.2zcPos_fit3 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Duration_grpmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude); #Rank deficient

#Position + Frequency_sol_imc
model4.2zcPos_fit4 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*LickFrequency_sol_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

#Position + Frequency_sol_gmc
model4.2zcPos_fit5 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*LickFrequency_sol_gmc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude); #Rank deficient

#Position + Drinking_imc
model4.2zcPos_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);

##Position + Drinking_imc+Duration_imc
model4.2zcPos_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Duration_imc*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude);
```

#### ii) (Optional) Plot Effects

```{r}
moi<-model4.2zcPos_fit  
moi.name<-"model4.2zcPos_fit"      

# Effects Table  
sjPlot::tab_model(moi,show.re.var= TRUE, dv.labels= "Effects of Variables on Signal")     

# Effects Plot   
sjPlot::plot_model(moi,show.values= TRUE, show.p=TRUE,vline.color = "black",value.offset = 0.4,value.size = 2.9,title= paste("Effects: ",moi.name)) #1000 x 600     ##Plot it!   emmip(moi,Solution~Sex,pbkrtest.limit=5667, type="factor",CIs=TRUE)
```

#### iii) PostHoc Comparisons

```{r}
tukey.pos<-emmeans(model4.2zcPos_fit, list(pairwise ~ Solution*time*Position),by=list(Solution=c("Water","Sucrose"),time="z2MeanAfter"), adjust = "tukey",pbkrtest.limit = 5664) 



tukey.drink1<-emmeans(model4.2zcdrink_fit1, list(pairwise ~ Solution*Sex), adjust = "tukey",pbkrtest.limit = 5664) tukey.drink2<-emmeans(model4.2zcdrink_fit2, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664) tukey.drink3<-emmeans(model4.2zcdrink_fit3, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664) tukey.drink4<-emmeans(model4.2zcdrink_fit4, list(pairwise ~ Solution*Sex), adjust = "tukey", pbkrtest.limit = 5664)   remove(tukey) tukey<-ls(envir=.GlobalEnv,pattern="tukey.drink")  tuk.summary1<-NULL tuk.summary2<-NULL  for (n in 1:length(tukey)){ temp<-NULL temp2<-NULL temp<-rbind(summary(get(tukey[[n]])[[1]]),temp) temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp))) tuk.summary1<-rbind.fill(tuk.summary1,temp) temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2) temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2))) tuk.summary2<-rbind.fill(tuk.summary2,temp2)  }`
```

#### v) Make Model Comparisons

```{r}
#To compare the two models - Signal Lvl4 and Signal-Drink, we need to refit all models using REML=F.  
model4.2zc_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude, REML=FALSE); 

model4.2zcPos_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Position + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude, REML=FALSE); 

model4.2zcDuration_fit <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude, REML=FALSE); 

model4.2zcPos_fit2 <- lmerTest::lmer(formula = signal ~ time*Sex*Solution*Position*Duration_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout), data=bout.analysis2_true.meanz2, na.action=na.exclude, REML=FALSE); 

model4.2zcdrink_fit <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude,REML=FALSE);


model4.2zcPos_fit6 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude,REML=FALSE);

model4.2zcPos_fit7 <-lmerTest::lmer(formula= signal ~ time*Sex*Solution*Position*Duration_imc*Drinking.mL.kg_imc + (1+time+Solution|Mouse:session)+(1|Mouse:session:Bout)+(1|Bout),data=bout.analysis2_true.meanz2, na.action=na.exclude,REML=FALSE);


#Note that these comparisons are ONLY valid if both models have the same # of observations!  

model.0z_anova<-anova(model4.2zcPos_fit2,model4.2zcDuration_fit)  
model.0z1_anova<-anova(model4.2zcPos_fit,model4.2zc_fit)
model.0z2_anova<-anova(model4.2zcPos_fit6,model4.2zcdrink_fit)
model.0z3_anova<-anova(model4.2zcPos_fit7,model4.2zcdrink_fit)
model.0z4_anova<-anova(model4.2zcPos_fit7,model4.2zcDuration_fit)

LLRpos<-rbind(model.0z_anova,model.0z1_anova,model.0z2_anova,model.0z3_anova,model.0z4_anova)
write.xlsx(LLRpos,file=filemod2,sheetName = "Signal-Pos LLR",append=TRUE)

```


#### iv) Export Model Summaries

```{r}
models.pos<-ls(envir=.GlobalEnv,pattern="model4.1zbPos")     
models.call<-lapply(mget(models.pos),get_call)    
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))           
model.obs<-NULL    
model.obs.df<-NULL      
for(k in models.pos){             
  obs<-sapply(ranef(get(k)),nrow)               
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))             
  model.obs.df<-rbind(model.obs.df,model.obs)          
  }      
model.info<-merge(models.call.df,model.obs.df)      

term.streamline<-c("LickFrequency_imc"="LickFrequency_within","LickFrequency_gmc" = "LickFrequency_between","LickFrequency_sol_imc" = "LickFrequency_within","LickFrequency_sol_gmc" = "LickFrequency_between","LickFrequency_smc" = "LickFrequency_between","LickFrequency_grpmc"="LickFrequency_between","Duration_imc"="Duration_within","Duration_gmc" = "Duration_between","Duration_sol_imc" = "Duration_within","Duration_sol_gmc" = "Duration_between","Duration_smc" = "Duration_between","Duration_grpmc"="Duration_between","Drinking.mL.kg_imc"="Drinking_within","Drinking.mL.kg_gmc" = "Drinking_between","Drinking.sol_imc" = "Drinking_within","Drinking.sol_gmc" = "Drinking_between","Drinking.mL.kg_smc" = "Drinking_between","Drinking.mL.kg_grpmc"="Drinking_between","EtOH.gkg_imc"="Drinking_within","EtOH.gkg_smc"="Drinking_between","EtOH.gkg_gmc"="Drinking_between")

summary<-modelsummary::msummary(mget(models.pos),stars=T,output="data.frame",coef_rename = term.streamline)

write.xlsx(model.info,file=filemod2, sheetName = "Signal-Pos Info", append=TRUE, row.names=FALSE)     
write.xlsx(summary,file=filemod2, sheetName = "Signal-Pos Compare", append=TRUE, row.names=FALSE)       

#write.xlsx(tuk.summary1,file=filemod3,sheetName = "Signal-Drink Tukey_Means",append=TRUE)   
#write.xlsx(tuk.summary2,file=filemod3,sheetName = "Signal-Drink Tukey_Pairs",append=TRUE) 
```

### 

## 5) Model Diagnostics

```{r}
moi<-model4.1z_fit
moi.name<-"CL20 model4.1z_fit (Signal-Outcome, Half Solutions)"

moi<-model5.drink_nested
moi.name<-"CL20 model5.drink_nested (Consumption-Outcome, Half Solutions)"

#Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
plotREsim(REsim(moi),labs=TRUE) 

#standard fitted vs. residual plots,
plot(moi, type = c("p", "smooth"))
#scale-location plots,
plot(moi, sqrt(abs(resid(.))) ~ fitted(.),
type = c("p", "smooth"))
#and quantile-quantile plots (from lattice),
qqmath(moi, id = 0.05)

#Kolmogorov-Smirnov Tests for Normality in large sample sizes
ks.test(residuals(moi),y=pnorm)

#Effects plot
plot_model(moi, show.values = TRUE, vline.color = "black")

#Effects Table
sjPlot::tab_model(moi,show.ci=0.95,show.df=TRUE,show.r2=TRUE,show.icc=TRUE, show.p=TRUE,show.stat=TRUE,show.aic=TRUE,show.re.var= TRUE, title= moi.name,digits=3, digits.p= 4, df.method = "satterthwaite",col.order = c("est", "se", "std.est", "std.se", "ci", "std.ci", "ci.inner", "ci.outer","df.error", "stat", "std.stat", "p", "std.p", "response.level"))

#QQPlots for Random Effects 
qqnorm(ranef(moi)$'Mouse:session'[,1])
qqnorm(ranef(moi)$'Mouse:session:Bout'[,1])
qqnorm(ranef(moi)$'Bout'[,1])


# Create Reference Grid for Estimated Marginal Means
RG<-ref_grid(moi, pbkrtest.limit = 5667, at=list(Drinking.mL.kg_gmc=c(),Drinking.mL.kg_imc=c(-2,0,2)))

             
# Plot specific interactions
emmip(RG, Solution ~ Duration_imc*Drinking.mL.kg_imc | time*Sex, style = "factor", CIs=TRUE)

# Plot diagnostics for clustered models
#refit as lm
model.clus<-lm(signal~Sex*Solution*time)
summclust(anova.nested3)


# See what proportions of variance are explained at each level
VarCorr(moi) #Take note of the names of each part of the random term. These will be what your PCA results represent and allow you to get rid of interactions or other variables that don't help (i.e. have near zero explained variance)
pca<-rePCA(moi)
var.MouseSesssionBout<-pca$`Mouse:session:Bout`$sdev^2
var.MouseSession.each<-pca$`Mouse:session`$sdev^2
var.MouseSession<-sum(pca$`Mouse:session`$sdev^2)
var.MouseBout<-pca$`Bout`$sdev^2
total.var<-sum(pca$`Mouse:session:Bout`$sdev^2,pca$`Bout`$sdev^2,pca$`Mouse:session`$sdev^2)

var_explained<-c("Mouse:Session:Bout"=(var.MouseSesssionBout/total.var),"Mouse:session"=(var.MouseSession/total.var),"Bout"=(var.MouseBout/total.var))
var_explained<-c("Mouse:Session:Bout"=(var.MouseSesssionBout/total.var),"Mouse:session"=(var.MouseSession.each/total.var),"Bout"=(var.MouseBout/total.var))

#Graph it!
qplot(names(var_explained), var_explained) + 
  geom_point(size=4)+
  xlab("Principal Component") + 
  ylab("Variance Explained") +
  ggtitle("Scree Plot") +
  ylim(0, 1)


## If failure to converge is not preceeded by a warning about singularity, you may want to see if a different optimizer can help it converge. Check all the optimizers using this code. This takes a while because it basically has to run your model through 7 times.

diff_optims <- allFit(model3.1za_fit) #Run all the optimizers. NOTE: "OK" does NOT MEAN THE MODEL CONVERGES! Gotta do the steps below to see that. 

summary.opt<-modelsummary::msummary(unlist(diff_optims),stars=T,output="data.frame")

#Check all the messages for each model.
diff_optims_OK <- diff_optims[sapply(diff_optims, is, "merMod")]
comp<-lapply(diff_optims_OK, function(x) x@optinfo$conv$lme4$messages)

names<-names(comp)
comp.temp<-NULL
for (j in names(comp)){
  if(!is.null(comp[[j]])==TRUE){
  comp.temp[[j]]<-comp[[j]]
  }else{
    comp.temp[[j]]<-"NA"
}
  
}

#Rerun model with specific optimizer using the option in lmer: 
#model_fit <-lmerTest::lmer(...,control=lmerControl(optimizer="bobyqa"));

#This is also recommended to try adjust to help convergence issues: 
#model_fit <-lmerTest::lmer(...,control=lmerControl(optCtrl=list(xtol_abs=1e-9, ftol_abs=1e-9)))

#Or let more iterations happen: 
#model_fit <-lmerTest::lmer(...,control=lmerControl(optCtrl=list(maxfun=100000)))

##Here to check all your defaults since these things change in the background sometimes
#environment(nloptwrap)$defaultControl

write.xlsx(summary.opt,file=filemod2, sheetName = "Opt_SignalLvl3", append=TRUE, row.names=FALSE)     
write.xlsx(comp,file=filemod2, sheetName = "Opt_SignalLvl3Errors", append=TRUE, row.names=FALSE) 

## RUN MULTICOLINARITY DIAGNOSTICS! (Especially if you get eigenvalue errors causing convergence issues)

vif(moi, all.diagnostics=TRUE)



ab <- augment(moi)
ggplot(ab,
       aes(signal, .resid, colour = factor(Solution))) + geom_point() + geom_smooth()
```



# CREATE PUBLISHABLE GRAPHS

## 1) Bout Histograms

```{r}
###Bout Histogram by Sex and Solution 
ggplot(bout.analysis2_true.meanz2,aes(x=BoutStarts/60,fill=Solution)) + labs(x="Bout Onset (min)", y="Density")+theme_minimal()+facet_grid(Solution + Sex ~ .,space="free_y")+geom_histogram(aes(y=..density..),stat = "bin",binwidth = 0.5)+scale_fill_manual(values = custom)+scale_x_continuous(breaks=scales::breaks_width(5),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(0.02),minor_breaks=scales::breaks_width(0.02))+theme(plot.title=element_text(size=18,face="bold"),legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="center", legend.position="top",legend.direction ="horizontal",legend.box.spacing = unit(-0.75,"cm"),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=16,face="bold"),strip.text.y = element_text(margin = margin(2, 0, 2, 0),face="bold",size=13),axis.ticks = element_line(colour = "grey70", linewidth = 0.2))+geom_hline(yintercept=0,linewidth=1,color="black")+geom_vline(xintercept=0,size=1,color="black")

#1200 x 500 - bin width 0.5

##Mean Signal Plots with duration as the width of the tile 
bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Mean-Before Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=MeanBefore),width=bout.analysis2_true$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

bout.histogram<-ggplot(bout.analysis4,aes(x=BoutStarts/60,y=session)) + labs(title="Mean-After Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=MeanAfter),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Mean Difference (After-Before) Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=meanbeforeafter),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

#Mean by subject
bout.histogram<-ggplot(data.analysis_true,aes(x=BoutStarts/60,y=Mouse)) + labs(title="Mean-Before Across Session",x="Bout Start (min)", y="Mouse")+ geom_tile(stat = "identity", aes(fill=MeanBefore),width=data.analysis_true$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_discrete(labels = NULL,expand = expansion(0))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

##Peak Plots with duration as the width of the tile
bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Peak-Before Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=PeakBefore),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Peak-After Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=PeakAfter),width=bout.analysis2$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()

bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Peak Difference (After-Before) Across Session",x="Bout Start (min)", y="Session")+ geom_tile(stat = "identity", aes(fill=peakbeforeafter),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Signal (%dF/F)")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()


##Licks Plot with duration as the width of the tile
bout.histogram<-ggplot(bout.analysis2_true,aes(x=BoutStarts/60,y=session)) + labs(title="Licks Across Session",x="Bout Start (min)", y="Session",size=16)+ geom_tile(stat = "identity", aes(fill=LicksPerBout),width=bout.analysis4$BoutDuration/2,height=1)+scale_fill_viridis_c(option="turbo",name="Licks")+facet_grid(Solution + Sex ~ .,scales = "free_y",space="free_y")+scale_x_continuous(breaks=scales::breaks_width(10),expand = expansion(0))+scale_y_continuous(labels = NULL,expand = expansion(0),breaks=scales::breaks_width(5,offset=0.5),minor_breaks=scales::breaks_width(1,offset=0.5))+theme(strip.text.y = element_text(margin = margin(2, 0, 2, 0)),axis.ticks = element_line(colour = "grey70", size = 0.2),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+theme_bw()
```

## 2) Bout Characteristics - Histograms of Raw & Centered Data

```{r}
##Signal raw
ggplot(data=bout.analysis2_true.mean)+geom_bar(aes(x=signal),stat="density")
ggplot(data=bout.analysis2_true.mean)+geom_bar(aes(x=signal),stat="density")+facet_wrap(~Sex*Solution)
ggplot(data=bout.analysis2_true.mean)+geom_bar(aes(x=signal),stat="density")+facet_wrap(~Sex)

##Signal z2 Standardized
ggplot(data=bout.analysis2_true.meanz2)+geom_bar(aes(x=signal),stat="density")
ggplot(data=bout.analysis2_true.meanz2)+geom_bar(aes(x=signal),stat="density")+facet_wrap(~Sex*Solution)
ggplot(data=bout.analysis2_true.meanz2)+geom_bar(aes(x=signal),stat="density")+facet_wrap(~Sex)


##Drinking.mL.kg
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg),stat="density")+facet_wrap(~Sex*Solution)
##Drinking.mL.kg
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg),stat="density")+facet_wrap(~Solution)


##Drinking.mL.kg_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_imc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_imc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_imc),stat="density")+facet_wrap(~Sex*Solution)

##Drinking.mL.kg_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_gmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_gmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_gmc),stat="density")+facet_wrap(~Sex*Solution)

#Drinking Within-Solution
#Drinkin.sol_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_imc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_imc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_imc),stat="density")+facet_wrap(~Sex*Solution)

##Drinking.sol_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_gmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_gmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.sol_gmc),stat="density")+facet_wrap(~Sex*Solution)

# Sex-mean Centered Drinking
##Drinking.mL.kg_smc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_smc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_smc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_smc),stat="density")+facet_wrap(~Sex*Solution)

# Group-mean Centered Drinking (Centered within Context)
##Drinking.mL.kg_grpmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_grpmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_grpmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Drinking.mL.kg_grpmc),stat="density")+facet_wrap(~Sex*Solution)

##EtOH.gkg
ggplot(data=data.analysis_true)+geom_bar(aes(x=EtOH.gkg),stat="density")+facet_wrap(~Sex)

#EtOH.gkg_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=EtOH.gkg_imc),stat="density")+facet_wrap(~Sex)

#EtOH.gkg_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=EtOH.gkg_gmc),stat="density")+facet_wrap(~Sex)

#EtOH.gkg_smc
ggplot(data=data.analysis_true)+geom_bar(aes(x=EtOH.gkg_smc),stat="density")+facet_wrap(~Sex)


#Duration 
ggplot(data=data.analysis_true)+geom_bar(aes(x=BoutDuration),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=BoutDuration),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=BoutDuration),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=BoutDuration),stat="density")+facet_wrap(Sex~Solution)

##Duration_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_imc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_imc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_imc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_imc),stat="density")+facet_wrap(Sex~Solution)


##Duration_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_gmc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_gmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_gmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_gmc),stat="density")+facet_wrap(Sex~Solution)


##Duration_smc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_smc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_smc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_smc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_smc),stat="density")+facet_wrap(Sex~Solution)

##Duration_grpmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")+facet_wrap(Sex~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=Duration_grpmc),stat="density")+facet_wrap(Sex~Solution)

##LicksPerBout
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout),stat="density")+facet_wrap(Sex~Solution)

##LicksPerBout_imc
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_imc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_imc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_imc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_imc),stat="density")+facet_wrap(Sex~Solution)


##LicksPerBout_gmc
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_gmc),stat="density")
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_gmc),stat="density")+facet_wrap(~Sex)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_gmc),stat="density")+facet_wrap(~Solution)
ggplot(data=data.analysis_true)+geom_bar(aes(x=LicksPerBout_gmc),stat="density")+facet_wrap(Sex~Solution)
```

## 3) Bout Characteristics - Correlations

```{r}
#Bout Duration by LicksPerBout
ggplot(data=data.analysis_true, aes(x=BoutDuration, y=LicksPerBout))+ geom_point(alpha=0.2)+facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0)+theme_classic()+scale_y_continuous(n.breaks = 9,expand = expansion(c(0.02,0.04)))+ scale_x_continuous(breaks = c(0,8,16,24),expand = expansion(c(0.15,0.15)))+theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Duration (s)", y="Total Licks in Bout (#)")

#500 x 500

#Bout Duration by LicksPerBout - can check each mouse
ggplot(data=subset(data.analysis_true,Mouse==14), aes(x=BoutDuration, y=LicksPerBout))+geom_point()+ facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+ geom_smooth(method=lm)+stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+theme_classic()+scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+ scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Duration (s)", y="LicksPerBout")

#Bout Duration by Bout Start
ggplot(data=data.analysis_true, aes(x=BoutStarts, y=BoutDuration))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Bout Duration (s)")

#Duration vs BoutStarts
ggplot(data=data.analysis_true, aes(x=BoutStarts, y=Duration))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Lick Frequency (Hz)")

#Duration vs BoutDuration
ggplot(data=data.analysis_true, aes(x=BoutDuration, y=Duration))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Duration (s)", y="Lick Frequency (Hz)")

#Duration vs LicksPerBout
ggplot(data=data.analysis_true, aes(x=LicksPerBout_imc, y=Duration_imc))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Licks Per Bout", y="Lick Frequency (Hz)")


#BoutStarts vs LicksPerBout
ggplot(data=data.analysis_true, aes(x=BoutStarts, y=LicksPerBout_imc))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Licks Per Bout (individually centered)")

# BoutStarts by Bout
ggplot(data=bout.analysis2.meanz2, aes(x=Bout,y=BoutStarts))+geom_point()+geom_smooth()+facet_grid(Sex~Solution)
```

## 4) Bout-Level Characteristics - Group Differences

```{r}
#Run these two lines if you did not run the stats section and are just making graphs
corevars2<-c(corevars,"Position","x_OfC")

myorder5<-myorder[!(myorder %in% corevars2)]


ReplicateAverages <- data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(myorder5,type = "mean_se");  
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))  
ReplicateAverages$Solution <-factor(ReplicateAverages$Solution,levels=sol.levels)

#Not for CL20
ReplicateAverages$group_shrt <-factor(ReplicateAverages$group_shrt) 

ReplicateAverages.duration<-filter(ReplicateAverages, variable=="BoutDuration",preserve=TRUE) 
ReplicateAverages.MeanBefore<-filter(ReplicateAverages, variable=="MeanBefore",preserve=TRUE) 
ReplicateAverages.MeanAfter<-filter(ReplicateAverages, variable=="MeanAfter",preserve=TRUE) 
ReplicateAverages.freq<-filter(ReplicateAverages, variable=="LickFrequency",preserve=TRUE)   
ReplicateAverages.lick<-filter(ReplicateAverages, variable=="LicksPerBout",preserve=TRUE)
ReplicateAverages.drink.imc<-filter(ReplicateAverages,variable=="Drinking.mL.kg_imc",preserve=TRUE) 
ReplicateAverages.drink.gmc<-filter(ReplicateAverages,variable=="Drinking.mL.kg_gmc",preserve=TRUE) 
ReplicateAverages.duration.imc<-filter(ReplicateAverages, variable=="BoutDuration_imc",preserve=TRUE) 
ReplicateAverages.duration.gmc<-filter(ReplicateAverages, variable=="BoutDuration_gmc",preserve=TRUE)
ReplicateAverages.freq.imc<-filter(ReplicateAverages, variable=="Duration_imc",preserve=TRUE)   
ReplicateAverages.lick.imc<-filter(ReplicateAverages, variable=="LicksPerBout_imc",preserve=TRUE)
ReplicateAverages.freq.gmc<-filter(ReplicateAverages, variable=="Duration_gmc",preserve=TRUE)   
ReplicateAverages.lick.gmc<-filter(ReplicateAverages, variable=="LicksPerBout_gmc",preserve=TRUE)
ReplicateAverages.etoh<-filter(ReplicateAverages, variable=="EtOH.gkg",preserve=TRUE)
ReplicateAverages.etoh.imc<-filter(ReplicateAverages, variable=="EtOH.gkg_imc",preserve=TRUE)   
ReplicateAverages.etoh.gmc<-filter(ReplicateAverages, variable=="EtOH.gkg_gmc",preserve=TRUE)

ReplicateAverages.r60<-filter(ReplicateAverages,variable=="RAMP60to50sec")
ReplicateAverages.r50<-filter(ReplicateAverages,variable=="RAMP50to40sec")
ReplicateAverages.r40<-filter(ReplicateAverages,variable=="RAMP40to30sec")
ReplicateAverages.r30<-filter(ReplicateAverages,variable=="RAMP30to20sec")
ReplicateAverages.r20<-filter(ReplicateAverages,variable=="RAMP20to10sec")
ReplicateAverages.r10<-filter(ReplicateAverages,variable=="RAMP10to0sec")

ReplicateAverages.rz60<-filter(ReplicateAverages,variable=="z2RAMP60to50sec")
ReplicateAverages.rz50<-filter(ReplicateAverages,variable=="z2RAMP50to40sec")
ReplicateAverages.rz40<-filter(ReplicateAverages,variable=="z2RAMP40to30sec")
ReplicateAverages.rz30<-filter(ReplicateAverages,variable=="z2RAMP30to20sec")
ReplicateAverages.rz20<-filter(ReplicateAverages,variable=="z2RAMP20to10sec")
ReplicateAverages.rz10<-filter(ReplicateAverages,variable=="z2RAMP10to0sec")

data.analysis_t_graph<-data.analysis_true
data.analysis_t_graph$Solution<-factor(data.analysis_t_graph$Solution,levels=sol.levels)

##BoutDuration# 
ggplot(data=data.analysis_t_graph,aes(x=group_shrt,y=BoutDuration), group= factor(group_shrt)) +theme_classic()+scale_fill_manual(limits=c("QHCl (Low)","Water","Water + Dep","","Sucrose + QHCl (Low)","Sucrose + QHCl (High)"),values = custom)+geom_bar(data=ReplicateAverages.duration,stat="identity",aes(y=mean,fill=Solution),size=1,alpha=0.3)+scale_color_manual(limits=c("QHCl (Low)","Water","Water + Dep","","Sucrose + QHCl (Low)","Sucrose + QHCl (High)"),values = custom)+geom_beeswarm(cex=0.35,size=1.5,alpha=0.55,priority="density",aes(color=Solution))+geom_errorbar(data=ReplicateAverages.duration,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+scale_x_discrete(labels=c("Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male"),expand=expansion(c(0.03,0.01)))+scale_y_continuous(n.breaks=15, limits=c(0,35),expand=expansion(c(0.01,0.01)))+theme(legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.0,0.86),legend.background=element_rect(fill="transparent"),axis.text.x=element_text(size=otr.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Bout Duration** (seconds)")+guides(color=guide_legend(override.aes = list(size=3,alpha=1),ncol=2),fill=guide_legend(ncol=2, override.aes=list(alpha=0.5)))

+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~symbol('***')",")",sep=""),paste("list(~scriptstyle(ns))",sep=","),paste("list(~symbol('*'))",sep=",")),y_position = c(15.5,15,17.8),textsize = otr.sz,tip_length = 0.00,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female Water"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol(''))",sep=",")),y_position = c(22),textsize = otr.sz,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.04,color="black")+geom_signif(xmin=c("Female Sucrose"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol(''))",sep=",")),y_position = c(19.3),textsize = otr.sz,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.04)+geom_signif(xmin=c("Female Water"), xmax = c("Male Water"),annotations= c(paste("list(~symbol(''))",sep=",")),y_position = c(16.5),textsize = otr.sz,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.04)+geom_signif(xmin=c("Male Water"), xmax = c("Female Sucrose"),annotations= c(paste("list(~symbol('**'))",sep=",")),y_position = c(20.5),textsize = otr.sz,tip_length = c(0.21,0.065),size=1,vjust= -0.05,parse=TRUE,extend_line=0.087,position=position_dodge(width=0.3))+geom_signif(xmin=c("Male EtOH"), xmax = c("Male Water"),annotations= c(paste("list(~symbol('*'))",sep=",")),y_position = c(23),textsize = otr.sz,tip_length = c(0.32,0.05),size=1,vjust= -0.05,parse=TRUE,extend_line=0.087,position=position_dodge(width=0.3))+geom_signif(xmin=c("Female EtOH"), xmax = c("Male EtOH"),annotations= c(paste("list(~symbol(''))",sep=",")),y_position = c(17),textsize = otr.sz,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.04)

#1250 x 450


#Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1

##LickFrequency# 
p1<-ggplot(data=data.analysis_t_graph,aes(x=group_shrt,y=LickFrequency), group_shrt= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.freq,stat="identity",aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.4,size=2,alpha=0.45,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.freq,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=2,limits=c(0,14),expand = expansion(c(0.0,0.0)))+scale_y_break(breaks=c(3,4.8),scales=15,ticklabels = c(4,5,6,7,8,9,10,11,12,13,14),expand = expansion(c(0.04,0.02)))+theme(legend.title=element_blank(),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.5,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.text.y.right = element_blank(),axis.ticks.y.right = element_blank(),axis.line.y.right = element_blank())+labs(x=NULL, y="**Lick Frequency**<br>(licks/sec)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep="")),y_position = c(12.5,12.5,13),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female EtOH"), xmax = c("Male EtOH"),annotations= c(paste("list(~symbol('*'))",sep="")),y_position = c(13.5),textsize = 6,tip_length = 0.00,size=1,vjust= -0.05,parse=TRUE,extend_line = .05)

## ggbreak plot without legend
p2 <- p1 +
    theme(legend.position="none") 

## extract legend from original plot
leg = cowplot::get_legend(p1)

## redraw the figure
p3 <- ggplotify::as.ggplot(print(p2))

## place the legend 
p3 + ggimage::geom_subview(x=.75, y=.95, subview=leg)
#700x500


##LickPerBout# 
ggplot(data=data.analysis_t_graph,aes(x=group_shrt,y=LicksPerBout), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.lick,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.2,size=2,alpha=0.6,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.lick,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.03,0.03)))+scale_y_continuous(n.breaks=10, limits=c(0,160),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.8,0.95),axis.text=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y = element_markdown(margin = margin(t = 0, r = 3, b = 0, l = 0,unit="mm")),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Licks in Each Bout**<br>(number)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1))) 
#750 x 300

##LicksPerBout_imc# 
ggplot(data=data.analysis_true,aes(x=group_shrt,y=LicksPerBout_imc), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.lick.imc,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.lick.imc,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-1.5,9),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Individual LicksPerBout**<br>(Bout Licks Mouse-Mean Centered)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1))) 

#BoutDuration_imc
ggplot(data=data.analysis_true,aes(x=group_shrt,y=Duration_imc), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.duration.imc,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.duration.imc,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-1.5,9),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Individual Bout Duration**<br>(Mouse-Mean Centered)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1))) 

#Duration_imc
ggplot(data=data.analysis_true,aes(x=group_shrt,y=Duration_imc), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.freq.imc,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.freq.imc,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-3,5.5),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Individual Bout Duration**<br>(Mouse-Mean Centered)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1))) 

##RAMP Signal - plug in each# 
ggplot(data=data.analysis_true,aes(x=group_shrt,y=RAMP10to0sec), group_shrt= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.r10,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.r10,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-10,45),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Signal**<br>(%dF/F,10-0sec Signal)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

##RAMP Signal - population#
spec<-data.frame(".name"=c("RAMP60to50sec","RAMP50to40sec","RAMP40to30sec","RAMP30to20sec","RAMP20to10sec","RAMP10to0sec"),".value"=c(rep.int("rampsignal",6)),"timepoint"=c("60","50","40","30","20","10"))
dat<-data.analysis_true %>%
  pivot_longer_spec(spec)

dat$Output.Order<-factor(dat$Output.Order,levels=c(1:3549))
dat$timepoint<-as.numeric(dat$timepoint)

ReplicateAverages.dat <- dat %>% group_by(Mouse,Sex,Solution,group_shrt,timepoint) %>% get_summary_stats(c("rampsignal"),type = "mean_se")
ReplicateAverages.dat$Sex <-factor(ReplicateAverages.dat$Sex,levels=c("Female", "Male"))  

ReplicateAverages.dat$group_shrt <-factor(ReplicateAverages.dat$group_shrt,labels=c("Female EtOH", "Male EtOH","Female Water","Male Water","Female Sucrose","Male Sucrose"))

ggplot(data=dat,aes(x=timepoint,y=rampsignal,group_shrt=Output.Order))+theme_classic()+geom_point(color="grey")+geom_line(size=0.5,alpha=0.6,aes(color=Solution))+facet_grid(~Solution)+geom_line(data=ReplicateAverages.dat,aes(x=timepoint,y=mean,group=Mouse))+scale_color_manual(values = c(custom))+scale_x_reverse(expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-10,45),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text=element_text(size=14,face="bold"))+labs(x="**Interval Beginning at X Seconds Before Bout**", y="**Ramping Signal**<br>(%dF/F)")+guides(color=guide_legend(override.aes = list(linewidth=6,alpha=1)))

##z2RAMP Signal - population#
spec<-data.frame(".name"=c("z2RAMP60to50sec","z2RAMP50to40sec","z2RAMP40to30sec","z2RAMP30to20sec","z2RAMP20to10sec","z2RAMP10to0sec"),".value"=c(rep.int("rampsignal",6)),"timepoint"=c("60","50","40","30","20","10"))
dat<-data.analysis_true %>%
  pivot_longer_spec(spec)

dat$Output.Order<-factor(dat$Output.Order,levels=c(1:3549))
dat$timepoint<-as.numeric(dat$timepoint)

ReplicateAverages.dat <- dat %>% group_by(Mouse,Sex,Solution,group_shrt,timepoint) %>% get_summary_stats(c("rampsignal"),type = "mean_se")
ReplicateAverages.dat$Sex <-factor(ReplicateAverages.dat$Sex,levels=c("Female", "Male"))  

WholeAvg.dat <- dat %>% group_by(Sex,Solution,group_shrt,timepoint) %>% get_summary_stats(c("rampsignal"),type = "mean_se")
WholeAvg.dat$Sex <-factor(WholeAvg.dat$Sex,levels=c("Female", "Male"))  

ReplicateAverages.dat$group_shrt <-factor(ReplicateAverages.dat$group_shrt)

ggplot(data=dat,aes(x=timepoint,y=rampsignal,group=Output.Order))+theme_classic()+geom_point(color="grey")+geom_line(size=0.5,alpha=0.5,aes(color=Solution),show.legend=FALSE)+facet_grid(~Solution)+geom_line(data=ReplicateAverages.dat,aes(x=timepoint,y=mean,group=Mouse))+geom_line(data=WholeAvg.dat,aes(x=timepoint,y=mean,group=group_shrt),linewidth=2)+geom_ribbon(data=WholeAvg.dat,aes(x=timepoint,y=mean,ymin=mean-se,ymax=mean+se,group=group_shrt),linetype=2,linewidth=3,alpha=0.1)+scale_color_manual(values = c(custom))+scale_x_reverse(expand = expansion(0.1),breaks=c(60,50,40,30,20,10,0))+scale_y_continuous(n.breaks=10, limits=c(-2,12),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.87,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text=element_text(size=14,face="bold"))+labs(x="**Seconds Before Bout**", y="**Signal**<br>(z%dF/F)")+guides(color=guide_legend(override.aes = list(linewidth=6,alpha=1)))

ggplot(data=dat,aes(x=timepoint,y=rampsignal,group=Output.Order))+theme_classic()+facet_grid(~Solution)+geom_line(data=ReplicateAverages.dat,aes(x=timepoint,y=mean,group=Mouse,color=Mouse),linewidth=1)+geom_line(data=WholeAvg.dat,aes(x=timepoint,y=mean,group=group_shrt),linewidth=1)+scale_x_reverse(expand = expansion(0.1),breaks=c(60,50,40,30,20,10,0))+scale_y_continuous(n.breaks=10, limits=c(-0.5,2.5),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.99,0.87),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text=element_text(size=14,face="bold"))+labs(x="**Seconds Before Bout**", y="**Ramping Signal**<br>(z%dF/F)")+guides(color=guide_legend(override.aes = list(linewidth=6,alpha=1)))


ggplot(data=dat,aes(x=timepoint,y=rampsignal,group=Output.Order))+theme_classic()+facet_grid(~Solution)+geom_line(data=WholeAvg.dat,aes(x=timepoint,y=mean,group=group_shrt,linetype=Sex),linewidth=1)+geom_ribbon(data=WholeAvg.dat,aes(x=timepoint,y=mean,ymin=mean-se,ymax=mean+se,group=group_shrt,fill=Solution),linetype=2,linewidth=3,alpha=0.2,show.legend=FALSE)+scale_color_manual(values = c(custom))+scale_x_reverse(expand = expansion(0.1),breaks=c(60,50,40,30,20,10,0))+scale_y_continuous(n.breaks=10, limits=c(0,2),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=15),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.35,0.85),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=16),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(),strip.text=element_text(size=14,face="bold"))+labs(x="**Seconds Before Bout**", y="**Signal**<br>(z%dF/F)")+guides(color=guide_legend(override.aes = list(linewidth=7,alpha=1)))




#Moving to Session Level Relationships with Bout Characteristics

#Get Stupid summaries of the new statistical variables
session.analysis5<-data.analysis_true %>%
    group_by(group_shrt,session,Mouse,subject,Solution,Sex,Channel,FileName) %>% 
   summarize(across(c("Drinking.mL.kg_imc","LicksPerBout_imc","Duration_imc","Duration_imc"),list(mean=mean,se=std.error,min=min,max=max)))

##Drinking.mL.kg_imc 
ggplot(data=session.analysis5,aes(x=group_shrt,y=Drinking.mL.kg_imc_mean), group= factor(group_shrt))+theme_classic()+geom_col(data=ReplicateAverages.drink.imc,aes(y=mean),size=1,color="grey", fill="grey")+geom_beeswarm(cex=0.25,size=2,alpha=0.6,priority="density",aes(color=Solution))+geom_hline(yintercept=0,size=1,color="black")+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.drink.imc,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-4,2.5),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Individual Drinking**<br>(Session Drinking Mouse-Mean Centered)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

## Now trying to get a handle on the crazy interactions



```

#### a) First 10 vs Last 10 minutes - Signal and Characteristics

```{r}
###############################
## First 10 vs Last 10 min#####

data.analysis_t_graph<-data.analysis_true
data.analysis_t_graph$Solution<-factor(data.analysis_t_graph$Solution,levels=c("EtOH","Water","Sucrose"))
data.analysis_t_graph$Position<-factor(data.analysis_t_graph$Position,levels=c("First 10 min","Middle","Last 10 min"))

#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds)

ReplicateAverages1 <- data.analysis_t_graph %>% group_by(Sex,Solution,group_shrt,Position) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","z2MeanAfter","z2MeanBefore","z2meanbeforeafter"),type = "mean_se"); 
ReplicateAverages1$Sex <-factor(ReplicateAverages1$Sex,levels=c("Female", "Male"))
ReplicateAverages1$Position <-factor(ReplicateAverages1$Position,levels=c("First 10 min", "Middle","Last 10 min"))

ReplicateAverages1.sigaft<-filter(ReplicateAverages1,variable=="z2MeanAfter",preserve=TRUE)
ReplicateAverages1.sigbef<-filter(ReplicateAverages1,variable=="z2MeanBefore",preserve=TRUE)
ReplicateAverages1.sigdiff<-filter(ReplicateAverages1,variable=="z2meanbeforeafter",preserve=TRUE)
ReplicateAverages1.freq<-filter(ReplicateAverages1,variable=="LickFrequency",preserve=TRUE)
ReplicateAverages1.duration<-filter(ReplicateAverages1,variable=="BoutDuration",preserve=TRUE)
ReplicateAverages1.licks<-filter(ReplicateAverages1,variable=="LicksPerBout" ,preserve=TRUE)

# Standardized Signal After 
ggplot(data=data.analysis_t_graph)+theme_classic()+geom_col_pattern(data=ReplicateAverages1.sigaft,aes(x=group_shrt,y=mean,pattern=Position), pattern_fill="black",pattern_density=0.55,pattern_spacing=0.02,pattern_key_scale_factor=2,fill="grey",size=1,position="dodge")+geom_beeswarm(data=data.analysis_t_graph,cex=0.25,size=2,alpha=0.6,aes(x=group_shrt,y=z2MeanAfter,group= factor(Position),color=Solution),dodge.width = .8)+scale_color_manual(values = custom)+geom_errorbar(data=subset(ReplicateAverages1.sigaft,!is.na(Position)),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.8))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-3,6),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.background=element_rect(fill="transparent"),legend.direction = "horizontal", legend.position=c(0.90,0.90),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Std Signal After (z%dF/F)**")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

#700 x 550

#Standardized Signal Before
ggplot(data=subset(data.analysis_true,!is.na(Position)))+theme_classic()+geom_col_pattern(data=subset(ReplicateAverages1.sigbef,!is.na(Position)),aes(x=group,y=mean,pattern=Position), pattern_fill="black",pattern_density=0.55,pattern_spacing=0.02,pattern_key_scale_factor=2,fill="grey",size=1,position="dodge")+geom_beeswarm(data=subset(data.analysis_true,!is.na(Position)),cex=0.25,size=2,alpha=0.6,aes(x=group_shrt,y=z2MeanBefore,group= factor(Position),color=Solution),dodge.width = .8)+scale_color_manual(values = custom)+geom_errorbar(data=subset(ReplicateAverages1.sigbef,!is.na(Position)),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.8))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-3,6),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.background=element_rect(fill="transparent"),legend.direction = "horizontal", legend.position=c(0.90,0.90),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Std Signal Before (z%dF/F)**")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

#700 x 550

#Standardized Signal Difference (After-Before) by First and Last 10 min
ggplot(data=subset(data.analysis_true,!is.na(Position)))+theme_classic()+geom_col_pattern(data=subset(ReplicateAverages1.sigdiff,!is.na(Position)),aes(x=group_shrt,y=mean,pattern=Position), pattern_fill="black",pattern_density=0.55,pattern_spacing=0.02,pattern_key_scale_factor=2,fill="grey",size=1,position="dodge")+geom_beeswarm(data=subset(data.analysis_true,!is.na(Position)),cex=0.25,size=2,alpha=0.6,aes(x=group_shrt,y=z2meanbeforeafter,group= factor(Position),color=Solution),dodge.width = .8)+scale_color_manual(values = custom)+geom_errorbar(data=subset(ReplicateAverages1.sigdiff,!is.na(Position)),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.8))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(-3.5,7),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.90,0.90),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Std Signal Difference (z%dF/F)**")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))


##LickFrequency by Position
p1<-ggplot(data=data.analysis_t_graph)+theme_classic()+geom_col_pattern(data=ReplicateAverages1.freq,aes(x=group_shrt,y=mean,pattern=Position), pattern_fill="black",pattern_density=0.55,pattern_spacing=0.02,pattern_key_scale_factor=1,fill="grey",size=1,position="dodge")+geom_beeswarm(data=data.analysis_t_graph,cex=0.1,size=2,alpha=0.6,aes(x=group_shrt,y=LickFrequency,group=Position,color=Solution),dodge.width = .85)+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages1.freq,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=Position),width=0.4,size=1,color="black",position=position_dodge(0.85))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=2,limits=c(0,14),expand = expansion(c(0.0,0.0)))+scale_y_break(breaks=c(3,4.8),scales=15,ticklabels = c(4,5,6,7,8,9,10,11,12,13,14),expand = expansion(c(0.04,0.02)))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.90),legend.spacing.y= unit(-0.1,"cm"),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=16),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Lick Frequency**<br>(licks/sec)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep="")),y_position = c(12.5,12.5,13),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female EtOH"), xmax = c("Male EtOH"),annotations= c(paste("list(~symbol('*'))",sep="")),y_position = c(13.5),textsize = 6,tip_length = 0.00,size=1,vjust= -0.05,parse=TRUE,extend_line = .05)

## ggbreak plot without legend
p2 <- p1 +
    theme(legend.position="none") 

## extract legend from original plot
leg = cowplot::get_legend(p1)

## redraw the figure
p3 <- ggplotify::as.ggplot(print(p2))

## place the legend 
p3 + ggimage::geom_subview(x=.75, y=.95, subview=leg)
#700x500


#750 x 500

##LicksPerBout
ggplot(data=subset(data.analysis_true,!is.na(Position)))+theme_classic()+geom_col_pattern(data=subset(ReplicateAverages1.licks,!is.na(Position)),aes(x=group_shrt,y=mean,pattern=Position),pattern_fill="black", pattern_density = 0.55, pattern_spacing=0.02,pattern_key_scale_factor = .85,fill="grey",size=1,position="dodge")+geom_beeswarm(data=subset(data.analysis_true,!is.na(Position)),cex=0.05,size=3,alpha=0.6,aes(x=group_shrt,y=LicksPerBout, group= Position,color=Solution),stat="identity",dodge.width = .85)+scale_color_manual(values = custom)+geom_errorbar(data=subset(ReplicateAverages1.licks,!is.na(Position)),aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.85))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,150),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.90),legend.spacing.y= unit(-0.1,"cm"),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Licks Within Bout (#)**")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

#BoutDuration
ggplot(data=data.analysis_t_graph)+theme_classic()+geom_col_pattern(data=ReplicateAverages1.duration,aes(x=group_shrt,y=mean,pattern=Position),pattern_fill="black", pattern_density = 0.55, pattern_spacing=0.02,pattern_key_scale_factor = .85,fill="grey",size=1,position="dodge")+geom_beeswarm(data=data.analysis_t_graph,cex=0.1,size=2,alpha=0.6,aes(x=group_shrt,y=BoutDuration, group= Position,color=Solution),stat="identity",dodge.width =0.85)+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages1.duration,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se,group=factor(Position)),width=0.4,size=1,color="black",position=position_dodge(0.85))+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,25),expand = expansion(0.0))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.90),legend.spacing.y =  unit(-0.1,"cm"),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Bout Duration**<br>(seconds)")+guides(color=guide_legend(override.aes = list(size=6,alpha=1)))

#+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep=""),paste("list(~scriptstyle(ns))",sep="")),y_position = c(12.5,12.5,13),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female EtOH"), xmax = c("Male EtOH"),annotations= c(paste("list(~symbol('*'))",sep="")),y_position = c(13.5),textsize = 6,tip_length = 0.00,size=1,vjust= -0.05,parse=TRUE,extend_line = .05)
#750x 500
```

## 5) Signal

#### i) Individual Bouts & Averages by Sex, Solution, & Time

```{r}
################ SIGNAL #####################
## By default, these use the solution as the color key but you can change this for any of these graphs by changing "aes(x= ,y=),group=factor(group)" to "aes(x= ,y=), group=subject" and change "scale_color_manual(values = custom)" to "scale_colour_brewer(palette = "Dark2")"

#Overall Within-Mouse Trend - Mean Before vs Mean After
ggplot(data=bout.analysis2_true.mean, aes(x=time,y=signal,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+
  labs(title="Mouse #",y="Mean Signal (%dF/F)",x="Time Around Bout") + 
  facet_grid2(Solution~ Mouse) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=14, face="bold"),
        axis.title.x = element_markdown(size=16),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text=element_text(size=12),
        strip.text=element_text(size=14))


#Overall Within-Mouse Trend - Mean After minus Mean Before  
ggplot(data=data.analysis_true, aes(x=Mouse,y=meanbeforeafter,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  labs(title="Mouse #",y="Mean Signal After-Before (%dF/F)") + 
  facet_grid2(Solution~ Mouse) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=14, face="bold"),
        axis.title.x = element_blank(),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text.x=element_blank(),
        axis.text.y=element_text(size=12),
        strip.text=element_text(size=14))

#Overall Within-Session Trend - Mean Before vs Mean After
ggplot(data=bout.analysis2_true.mean, aes(x=time,y=signal,color=Solution)) +
  geom_point(show.legend = FALSE) +
  theme_minimal()+
  scale_color_manual(values=custom)+
  stat_smooth(method="lm", fullrange=FALSE,show.legend = FALSE) +
  scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"))+
  labs(title="Session #",y="Mean Signal (%dF/F)",x="Time Around Bout") + 
  facet_grid2(Solution~ session) +
  theme(panel.grid.minor = element_blank(),
        title = element_text(size=14, face="bold"),
        axis.title.x = element_markdown(size=16),
        axis.title.y=element_text(size=16,face="bold"),
        axis.text=element_text(size=12),
        strip.text=element_text(size=14))

############
##Plot signal for all bouts per group 
ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","signal","meanbeforeafter","z1meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="signal",preserve=TRUE)
ReplicateAverages.signal.mean<-filter(ReplicateAverages.signal,time=="MeanBefore"|time=="MeanAfter",preserve=TRUE)
ReplicateAverages.signal.meanz1<-filter(ReplicateAverages.signal,time=="z1MeanBefore"|time=="z1MeanAfter",preserve=TRUE)

ggplot(data=bout.analysis2_true.mean,aes(x=group,y=signal), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages.signal.mean,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0),limits=c(-5,20))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))

#750 x 450

#Same as above but now color encodes animals (as an example)
ggplot(data=bout.analysis2_true.mean,aes(x=group,y=signal), group= subject) +
theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=subject,size=2))+
scale_colour_brewer(palette = "Dark2")+geom_point(data=ReplicateAverages.signal.mean,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))

#First 10 min vs last 10 min
##Plot signal for all bouts per group 
#First 10 min is anything less than or equal to 140 (minimum start) plus 600 (10 min in seconds)
bout.analysis2_true.mean10<-filter(bout.analysis2_true.mean,BoutStarts<=740,preserve=TRUE)
ReplicateAverages1 <- bout.analysis2_true.mean10 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","signal","meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages1$Sex <-factor(ReplicateAverages1$Sex,levels=c("Female", "Male"))
ReplicateAverages1.signal<-filter(ReplicateAverages1,variable=="signal",preserve=TRUE)
ReplicateAverages1.freq<-filter(ReplicateAverages1,variable=="Duration",preserve=TRUE)

ggplot(data=bout.analysis2_true.mean10,aes(x=group,y=signal), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages1.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-5,34),breaks=c(-5,0,5,10,15,20,25,30,35))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))



#Last 10 min (7888-600)
bout.analysis2_true.mean90<-filter(bout.analysis2_true.mean,BoutStarts>=7288,preserve=TRUE)

ReplicateAverages2 <- bout.analysis2_true.mean90 %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","signal","meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages2$Sex <-factor(ReplicateAverages2$Sex,levels=c("Female", "Male"))
ReplicateAverages2.signal<-filter(ReplicateAverages2,variable=="signal",preserve=TRUE)
ReplicateAverages2.freq<-filter(ReplicateAverages2,variable=="Duration",preserve=TRUE)

ggplot(data=bout.analysis2_true.mean90,aes(x=group,y=signal), group= factor(group)) +theme_classic()+geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom) +geom_point(data=ReplicateAverages2.signal,aes(x=group,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.05))+scale_y_continuous(expand = expansion(0),limits=c(-5,34),breaks=c(-5,0,5,10,15,20,25,30,35))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend(override.aes = list(size=4)))

#Let's look at differences between before and after
#As Mean Difference
ReplicateAverages.data<-data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.data.meandiff<-filter(ReplicateAverages.data,variable=="meanbeforeafter",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=meanbeforeafter,group= factor(group_shrt))) + geom_beeswarm(cex=0.4,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom)+geom_point(data=ReplicateAverages.data.meandiff,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(limits=c(-10,25),breaks=c(-10,-5,0,5,10,15,20,25),labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+labs(x="**Group**", y="**Signal Change**<br>(Post-Pre Bout,%dF/F)")+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title.y =element_markdown(size=18),axis.title.x =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))+geom_hline(aes(yintercept=0),linetype="88",linewidth=1.3)

#As Percent Difference - GARBAGE. Too Variable
ReplicateAverages.data<-data.analysis_true %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","Duration","Onset","End","meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.data.pmeandiff<-filter(ReplicateAverages.data,variable=="pmeanbeforeafter",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=pmeanbeforeafter,group= factor(group_shrt))) + geom_beeswarm(cex=.09,size=1,alpha=0.8,aes(color=Solution,size=2))+scale_color_manual(values = custom)+geom_point(data=ReplicateAverages.data.pmeandiff,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=3)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(limits=c(-10000,15000),labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Percent Signal Change (Post-Pre Bout,%dF/F)")+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))

##Now bout duration#
ReplicateAverages.data.duration<-filter(ReplicateAverages.data,variable=="BoutDuration",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=BoutDuration), group= factor(group_shrt)) + geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2)) + scale_colour_manual(values = custom)+geom_point(data=ReplicateAverages.data.duration,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Bout Duration (s)")+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))

##Lick frequency#
ReplicateAverages.data.freq<-filter(ReplicateAverages.data,variable=="Duration",preserve=TRUE)

ggplot(data=data.analysis_true,aes(x=group_shrt,y=Duration), group= factor(group_shrt)) + geom_beeswarm(cex=0.5,size=1,alpha=0.8,aes(color=Solution,size=2)) + scale_colour_manual(values = custom)+geom_point(data=ReplicateAverages.data.freq,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Lick Frequency (licks/s)")+guides(color=guide_legend("Subject",override.aes = list(size=4)),shape=guide_legend("Sex"))

##Licks/Bout#
ReplicateAverages.data.licksbout<-filter(ReplicateAverages.data,variable=="LicksPerBout",preserve=TRUE)

ggplot(data=data.analysis,aes(x=group_shrt,y=LicksPerBout, color=factor(subject)), group= factor(Solution)) + geom_beeswarm(cex=0.5,size=1) + scale_colour_brewer(palette = "Dark2")+geom_point(data=ReplicateAverages.data.licksbout,aes(x=group_shrt,y=mean,shape=factor(Sex)),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Licks/Bout")


##Tried out error bars. Hated it:
ggplot(data=bout.analysis2_true.mean,aes(x=group,y=signal, color=subject), group= factor(Solution)) + geom_beeswarm(cex=0.5,size=1) + scale_colour_brewer(palette = "Dark2")+geom_errorbar(data=ReplicateAverages.signal.mean,aes(x=group,y=mean,ymin=mean-se,ymax=mean+se),color="black")+geom_point(data=ReplicateAverages.signal.mean,aes(x=group,y=mean,shape=Sex),color="black",size=4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+theme_classic2()+theme(legend.title=element_text(size=14,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text=element_text(size=15,color="black"),axis.ticks = element_line(colour = "black", size = 0.2),axis.title=element_text(size=18, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Signal (%dF/F)")+guides(color=guide_legend("Subject"),shape=guide_legend("Sex"))
```

#### iii) Global Correlations With Bout Characteristics

##### 1) Bout Duration

```{r}
#Bout Duration by Solution
ggplot(data=bout.analysis2_true.mean, aes(x=Duration_imc, y=signal))+
  geom_point()+
  facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration (ind. mean centered)", y="Signal %dF/F")

#Bout Duration by Solution & Sex
ggplot(data=bout.analysis2_true.mean, aes(x=Duration_imc, y=signal))+
  geom_point()+
  facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration (indiv. mean centered)", y="Signal %dF/F")

#Bout Duration by Solution - Diff Between After and Before
ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Sex - Signal Difference between Before & After
ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Mouse - Signal Difference between Before & After
ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")
```

##### b) Bout \#

```{r}
#Bout Duration by Solution
ggplot(data=bout.analysis2_true.mean, aes(x=Bout, y=signal))+
  geom_point()+
  facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal %dF/F")

#Bout Duration by Solution & Sex
ggplot(data=bout.analysis2_true.mean, aes(x=Bout, y=signal))+
  geom_point()+
  facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal %dF/F")

#Bout Duration by Solution - Signal Diff Between Before & After
ggplot(data=bout.analysis2_true.mean, aes(x=Bout, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Sex - Signal Diff Between Before & After
ggplot(data=bout.analysis2_true.mean, aes(x=Bout, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Mouse - Signal Difference between Before & After
ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")
```

##### c) Bout Start

```{r}
#Bout Starts by Solution 
ggplot(data=bout.analysis2_true.mean, aes(x=BoutStarts, y=signal))+   geom_point()+   facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Signal %dF/F")  
#Bout Duration by Solution & Sex 
ggplot(data=bout.analysis2_true.mean, aes(x=BoutStarts, y=signal))+   geom_point()+   facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Signal %dF/F")
```

##### 4) Lick Frequency

```{r}
#Lick Frequency by Solution
ggplot(data=bout.analysis2_true.mean, aes(x=Duration_mc, y=signal))+
  geom_point()+
  facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (z-score)", y="Signal (%dF/F)")

#Lick Frequency by Solution & Sex
ggplot(data=bout.analysis2_true.mean, aes(x=Duration, y=signal))+
  geom_point()+
  facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (%dF/F)")

#Lick Frequency by Solution & Mouse 
ggplot(data=bout.analysis2_true.mean, aes(x=Duration, y=signal))+
  geom_point()+
  facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (%dF/F)")

#Lick Frequency by Solution - Signal Diff Between Before & After
ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (scaled)", y="Signal (After-Before) %dF/F")

#Bout Duration by Solution & Sex - Signal Diff Between Before & After
ggplot(data=bout.analysis2_true.mean, aes(x=Duration, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (After-Before) %dF/F")

#Lick Frequency by Solution & Mouse - Signal Difference between Before & After
ggplot(data=bout.analysis2_true.mean, aes(x=Duration, y=meanbeforeafter))+
  geom_point()+
  facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+
  geom_smooth(method=lm)+
  stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+
  theme_classic()+
  scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+
  scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+
  theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (After-Before) %dF/F")
```



## 6) Standardized Signal

#### i) Individual Bouts & Averages by Sex, Solution, & Time

```{r}

##Plot signal for all bouts per group - Separated by Sex

ReplicateAverages <- bout.analysis2_true %>% group_by(Sex,Solution,time,group) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","signal","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="signal",preserve=TRUE)
ReplicateAverages.signal.mean<-filter(ReplicateAverages.signal,time=="MeanBefore"|time=="MeanAfter",preserve=TRUE)
ReplicateAverages.signal.meanz2<-filter(ReplicateAverages.signal,time=="z2MeanBefore"|time=="z2MeanAfter",preserve=TRUE)


boutgraphz2<-bout.analysis2_true.meanz2
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=sol.levels)
boutgraphz2$time<-factor(boutgraphz2$Solution,levels=c("z2MeanBefore","z2MeanAfter"))

## For QHCl
ggplot(data=subset(boutgraphz2, Solution=="QHCl (High)"|Solution=="QHCl (Low)"),aes(x=group,y=signal), group= factor(group))+theme_classic()+geom_beeswarm(cex=1,size=3,alpha=0.3,aes(color=Solution,size=2))+scale_color_manual(values =c(c8,c4))+geom_point(data=subset(ReplicateAverages.signal.meanz2,Solution=="QHCl (High)"|Solution=="QHCl (Low)"),aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After"),expand = expansion(0.05))+scale_y_continuous(expand=expansion(c(0.03,0.03)),limits=c(-2.6,5),breaks=c(-3,-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz1),legend.justification="left",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.0,0.92),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(), plot.caption = element_markdown(lineheight=1,size=txt.sz2,hjust=c(0.057,-3.46,-4.27,-10.15)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**Signal** (z%dF/F)")+guides(color=guide_legend(order=1,override.aes=list(size=4,alpha=1))) 

#650 x 450

# For H2o
ggplot(data=subset(boutgraphz2, Solution=="Water"|Solution=="Water + Dep"),aes(x=group,y=signal), group= factor(group))+theme_classic()+geom_beeswarm(cex=1.0,size=3,alpha=0.3,aes(color=Solution,size=2))+scale_color_manual(values =c(c2,c7))+geom_point(data=ReplicateAverages.signal.meanz2.h2o,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After"),expand = expansion(0.05))+scale_y_continuous(expand=expansion(c(0.03,0.03)),limits=c(-2.8,5),breaks=c(-3,-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz1),legend.justification="left",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.0,0.92),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(), plot.caption = element_markdown(lineheight=1,size=txt.sz2,hjust=c(0.057,-3.46,-4.27,-10.15)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**Signal** (z%dF/F)")+guides(color=guide_legend(override.aes=list(size=4,alpha=1))) 

#650 x 450

# For all solutions after QHCl and H2O
ggplot(data=subset(boutgraphz2, !Solution=="QHCl (High)" & !Solution=="QHCl (Low)" & !Solution=="Water" & !Solution=="Water + Dep"),aes(x=group,y=signal), group= factor(group))+theme_classic()+geom_beeswarm(cex=0.6,size=2,alpha=0.6,aes(color=Solution,size=2))+scale_color_manual(values =custom.alt3)+geom_point(data=subset(ReplicateAverages.signal.meanz2,!Solution=="QHCl (High)" & !Solution=="QHCl (Low)" & !Solution=="Water" & !Solution=="Water + Dep") ,aes(x=group,y=mean,shape=Sex),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After","Before","After"),expand = expansion(0.03))+scale_y_continuous(expand=expansion(c(0.02,0.05)),limits=c(-2.3,5.7),breaks=c(-3,-2,-1,0,1,2,3,4,5,6))+theme(legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz1),legend.justification="left",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.0,0.90),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=otr.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank(), plot.caption = element_markdown(lineheight=1,size=otr.sz2,hjust=c(0.018,-2.4,-2.74,-6.65,-5.45,-10.9,-8.15,-15.15,-10.9,-19.4)),plot.caption.position="panel")+labs(caption=c("Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male"),x=NULL,color=NULL,shape=NULL, y="**Signal** (z%dF/F)")+guides(color=guide_legend(override.aes=list(size=4,alpha=1),nrow=2)) 

#800 x 450

#############################################################
##### PUBLISHABLE GRAPH ####################################
############################################################

##Plot signal for all bouts per group - Collapsed by Sex

ReplicateAverages <- bout.analysis2_true %>% group_by(Solution,time) %>% get_summary_stats(c("BoutStarts","BoutDuration","LicksPerBout","LickFrequency","Onset","End","signal","meanbeforeafter","z2meanbeforeafter","pmeanbeforeafter","end.onset"),type = "mean_se"); 
ReplicateAverages.signal<-filter(ReplicateAverages,variable=="signal",preserve=TRUE)
ReplicateAverages.signal.mean<-filter(ReplicateAverages.signal,time=="MeanBefore"|time=="MeanAfter",preserve=TRUE)
ReplicateAverages.signal.meanz2<-filter(ReplicateAverages.signal,time=="z2MeanBefore"|time=="z2MeanAfter",preserve=TRUE)

ReplicateAverages.signal.meanz2$time<-factor(ReplicateAverages.signal.meanz2$time, levels=c("z2MeanBefore","z2MeanAfter"))
ReplicateAverages.signal.meanz2$Solution<-factor(ReplicateAverages.signal.meanz2$Solution, levels=sol.levels)

boutgraphz2<-bout.analysis2_true.meanz2
boutgraphz2$Solution<-factor(boutgraphz2$Solution,levels=sol.levels)
boutgraphz2$time<-factor(boutgraphz2$time,levels=c("z2MeanBefore","z2MeanAfter"))


##Figured this out through many many painful hours of trying to code across facets, you need to have a data frame that defines ONLY the Solution that the bar starts in but then you get to the solution you want it to end in by adjusting the length of the bar (xend). Because we have told it not to clip in the coordinates, it will go to the other facet. The brackets connecting lines above groups have to be in different facets to show the sig indicators (weird R voodoo). 

#Sig indicator lines over both Before and After bout data to begin to indicate differences between solutions. 
annotation_df<-data.frame(
  xstart=c(0.8,0.8,0.8,0.8),
  xend=c(2.2,2.2,2.2,2.2),
  Solution=c("QHCl (Low)","Water","Water + Dep","Sucrose + QHCl (High)"),
  yvals= c(3.8,3.3,5.1,4.2),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over both Before and After bout data to begin to indicate differences between solutions. 
annotation_df2<-data.frame(
  xstart=c(1.5),
  xend=c(-0.56),
  Solution=c("Water"),
  yvals= c(4.4),
  labels=c(paste("list(symbol('***'))",sep=","))
  )
annotation_df3<-data.frame(
  xstart=c(1.5),
  xend=c(3.566),
  Solution=c("Water"),
  yvals= c(5.6),
  labels=c(paste("list(symbol('***'))",sep=","))
  )
#Sig indicator connectors to lines over both Before and After bout data to begin to indicate differences between solutions. 

annotation_df4<-data.frame(
  xstart=c(1.5),
  xend=c(7.69),
  Solution=c("Water"),
  yvals= c(5.6),
  labels=c(paste("list(symbol(''))",sep=","))
  )
annotation_df5<-data.frame(
  xstart=c(1.5),
  xend=c(9.72),
  Solution=c("Water"),
  yvals= c(5.15),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df1<-data.frame(
  xstart=c(1.5),
  xend=c(5.625),
  Solution=c("Water"),
  yvals= c(3.87),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df$Solution<-factor(annotation_df$Solution, levels=sol.levels)
annotation_df1$Solution<-factor(annotation_df1$Solution, levels=sol.levels)
annotation_df2$Solution<-factor(annotation_df2$Solution, levels=sol.levels)
annotation_df3$Solution<-factor(annotation_df3$Solution, levels=sol.levels)
annotation_df4$Solution<-factor(annotation_df4$Solution, levels=sol.levels)
annotation_df5$Solution<-factor(annotation_df5$Solution, levels=sol.levels)

ggplot(data=boutgraphz2,aes(x=time,y=signal),group=Solution)+theme_classic()+geom_beeswarm(cex=2,size=3,alpha=0.4,aes(color=Solution,size=2),corral="wrap")+scale_color_manual(values =custom)+geom_point(data=ReplicateAverages.signal.meanz2,aes(x=time,y=mean),size=4,color="black")+scale_x_discrete(labels=c("Before<br>Bout","After<br>Bout"),expand = expansion(c(0.0,0.0)))+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_y_continuous(expand=expansion(c(0.01,0.09)),limits=c(-2.8,5.7),n.breaks=10)+theme(panel.background = element_blank(),strip.text=element_blank(),legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz1),legend.justification="left",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.0,0.9),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL,color=NULL,shape=NULL, y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)")+guides(color=guide_legend(override.aes=list(size=4,alpha=1),nrow=3))+coord_cartesian(clip = "off",xlim=c(0.5,2.5))+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,group=Solution,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,group=Solution,y_position=yvals),textsize = otr.sz, tip_length = c(0.135,0.072),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,group=Solution,y_position=yvals),textsize = otr.sz, tip_length = c(0.15,0.06),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,group=Solution,y_position=yvals),textsize = otr.sz, tip_length = c(0.09,0.17),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+facet_grid(~Solution)

#+geom_signif(inherit.aes=FALSE,data=annotation_df5,aes(xmin=xstart, xmax =xend,annotations=labels,group=Solution,y_position=yvals),textsize = otr.sz, tip_length = c(0.07,0.215),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df1,aes(xmin=xstart, xmax =xend,annotations=labels,group=Solution,y_position=yvals),textsize = otr.sz, tip_length = c(0.07,0.048),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"
ggsave(filename="CL20_BeeswarmBouts_HalfSolutions_StandardizedSignal_by_time_SI.tiff",plot=last_plot(), units="mm", width=1100/.pt, height=350/.pt, dpi=1000,path=output,device=grDevices::tiff)


########################
# For all solutions after QHCl and H2O - collapsed by sex
boutgraphz2.2<-subset(boutgraphz2, Solution=="Sucrose + QHCl (Low)" | Solution=="Sucrose + QHCl (High)" | Solution=="EtOH")
boutgraphz2.2$Solution<-factor(boutgraphz2.2$Solution, levels=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"))

#Sig indicator lines over both Before and After bout data to begin to indicate differences between solutions. 
# annotation_df<-data.frame(
#   xstart=c(0.8),
#   xend=c(2.2),
#   Solution=c("EtOH"),
#   yvals= c(3.44),
#   labels=c(paste("list(symbol(''))",sep=","))
#   )

#Sig indicator connectors to lines over both Before and After bout data to begin to indicate differences between solutions. 
# annotation_df1<-data.frame(
#   xstart=c(1.5),
#   xend=c(3.616),
#   Solution=c("EtOH"),
#   yvals= c(4.05),
#   labels=c(paste("list(symbol('***'))",sep=","))
#)
# annotation_df2<-data.frame(
#   xstart=c(1.5),
#   xend=c(-0.576),
#   Solution=c("S"),
#   yvals= c(4.5),
#   labels=c(paste("list(symbol('*'))",sep=","))
# )
  
#Sig indicators over all After bout data to indicate an effect of time. 
annotation_df3<-data.frame(
  xstart=c(2,2),
  xend=c(2,2),
  Solution=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)"),
  yvals= c(3.75,3.6),
  labels=c(paste("list(symbol('**'))",sep=","),paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df4<-data.frame(
  xstart=c(2),
  xend=c(2),
  Solution=c("EtOH"),
  yvals= c(3.25),
  labels=c(paste("list(symbol('***')~plain('^'))",sep=","))
  )


#annotation_df$Solution<-factor(annotation_df$Solution,levels=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"))
#annotation_df1$Solution<-factor(annotation_df1$Solution,levels=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"))
#annotation_df2$Solution<-factor(annotation_df2$Solution,levels=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"))
annotation_df3$Solution<-factor(annotation_df3$Solution,levels=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"))
annotation_df4$Solution<-factor(annotation_df4$Solution,levels=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"))

ggplot(data=boutgraphz2.2,aes(x=time,y=signal), group=factor(Solution))+theme_classic()+geom_beeswarm(cex=2,size=3,alpha=0.4,aes(color=Solution,size=2),corral="wrap",corral.width = 0.8)+scale_color_manual(values =custom.alt3)+geom_point(data=subset(ReplicateAverages.signal.meanz2,Solution=="Sucrose + QHCl (Low)" | Solution=="Sucrose + QHCl (High)" | Solution=="EtOH") ,aes(x=time,y=mean),size=4,color="black")+geom_hline(yintercept=0,linetype=3,linewidth=.9)+scale_x_discrete(labels=c("Before<br>Bout","After<br>Bout"),expand = expansion(c(0.0,0.0)))+scale_y_continuous(expand=expansion(c(0.01,0.05)),limits=c(-2.3,5.7),breaks=c(-3,-2,-1,0,1,2,3,4,5,6))+theme(panel.background = element_blank(),strip.text=element_blank(),legend.title=element_text(size=txt.sz2,face="bold"),legend.text=element_text(size=txt.sz1),legend.justification="left",legend.background=element_rect("transparent"),legend.direction="horizontal",legend.position=c(0.0,0.96),legend.spacing=unit(-0.1,"cm"),axis.text.x=element_markdown(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),axis.title.x=element_blank(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL,color=NULL,shape=NULL, y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)")+guides(color=guide_legend(override.aes=list(size=4,alpha=1),nrow=2))+facet_grid(.~Solution)+coord_cartesian(clip = "off",xlim=c(0.5,2.5))+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,group=Solution,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,group=Solution,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0,vjust= 0.8,hjust=0.65,parse=TRUE,manual=TRUE)


output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"
ggsave(filename="CL20_BeeswarmBouts_NearlyAllSolutions_StandardizedSignal_by_time_Last3_SI.tiff",plot=last_plot(), units="mm", width=550/.pt, height=450/.pt, dpi=900,path=output,device=grDevices::tiff)
```



#### ii) Correlations With Bout Characteristics

##### 1) Bout Duration

```{r}
#Bout Duration 
ggplot(data=bout.analysis2_true.meanz1, aes(x=Duration_imc, y=signal,group=subject))+geom_point(aes(color=time))+facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+geom_smooth(method=lm,aes(fill=subject))+theme_classic()+scale_color_manual(values=c("z1MeanBefore"="black","z1MeanAfter"="grey"))+scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+scale_x_continuous(n.breaks = 10,expand = expansion(0.02),labels = scales::number_format(accuracy = 0.1))+theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration (ind. mean centered)", y="Signal %dF/F")    

#Bout Duration by Solution - Diff Between After and Before 
ggplot(data=bout.analysis2_true.meanz1, aes(x=Duration_imc, y=z1meanbeforeafter))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 20,expand = expansion(0.02),labels = scales::number_format(accuracy = 0.1))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Individual Bout Duration  (s)", y="Signal (After-Before) %dF/F")  


#Bout Duration by Solution & Sex - Signal Difference between Before & After ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+   geom_point()+   facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")  #Bout Duration by Solution & Mouse - Signal Difference between Before & After ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+   geom_point()+   facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")
```

##### b) Bout \#

`{r} #Bout Duration by Solution ggplot(data=bout.analysis2_true.mean, aes(x=Bout, y=signal))+   geom_point()+   facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal %dF/F")  #Bout Duration by Solution & Sex ggplot(data=bout.analysis2_true.mean, aes(x=Bout, y=signal))+   geom_point()+   facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal %dF/F")  #Bout Duration by Solution - Signal Diff Between Before & After ggplot(data=bout.analysis2_true.mean, aes(x=Bout, y=meanbeforeafter))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal (After-Before) %dF/F")  #Bout Duration by Solution & Sex - Signal Diff Between Before & After ggplot(data=bout.analysis2_true.mean, aes(x=Bout, y=meanbeforeafter))+   geom_point()+   facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout (#)", y="Signal (After-Before) %dF/F")  #Bout Duration by Solution & Mouse - Signal Difference between Before & After ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+   geom_point()+   facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Signal (After-Before) %dF/F")}`

##### c) Bout Start

`{r} #Bout Starts by Solution  ggplot(data=bout.analysis2_true.mean, aes(x=BoutStarts, y=signal))+   geom_point()+   facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Signal %dF/F")   #Bout Duration by Solution & Sex  ggplot(data=bout.analysis2_true.mean, aes(x=BoutStarts, y=signal))+   geom_point()+   facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Bout Start (s)", y="Signal %dF/F")}`

##### 4) Lick Frequency

`{r} #Lick Frequency by Solution ggplot(data=bout.analysis2_true.mean, aes(x=Duration_mc, y=signal))+   geom_point()+   facet_grid2(~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (z-score)", y="Signal (%dF/F)")  #Lick Frequency by Solution & Sex ggplot(data=bout.analysis2_true.mean, aes(x=Duration, y=signal))+   geom_point()+   facet_grid2(Sex~time+Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (%dF/F)")  #Lick Frequency by Solution & Mouse  ggplot(data=bout.analysis2_true.mean, aes(x=Duration, y=signal))+   geom_point()+   facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (%dF/F)")  #Lick Frequency by Solution - Signal Diff Between Before & After ggplot(data=bout.analysis2_true.mean, aes(x=Duration_scaled, y=meanbeforeafter))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (scaled)", y="Signal (After-Before) %dF/F")  #Bout Duration by Solution & Sex - Signal Diff Between Before & After ggplot(data=bout.analysis2_true.mean, aes(x=LickFrequency, y=meanbeforeafter))+   geom_point()+   facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (After-Before) %dF/F")  #Lick Frequency by Solution & Mouse - Signal Difference between Before & After ggplot(data=bout.analysis2_true.mean, aes(x=LickFrequency, y=meanbeforeafter))+   geom_point()+   facet_grid2(Mouse~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 5,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Lick Frequency (Hz)", y="Signal (After-Before) %dF/F")}`


#### ii) Standardization at the Session-level - Is it necessary?

```{r}
#Each point is a single session - Signal vs Descriptive Stats, Session Avgs
ggplot(data=session.analysis3,aes(x=z1meanbeforeafter_mean,y=SigMedian_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.01,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),axis.title.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Standardized Signal Difference<br>(After Bout- Before Bout)", y="Session Signal Median")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

#500x 400

ggplot(data=session.analysis3,aes(x=meanbeforeafter_mean,y=SigMAD_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Signal Diff", y="Signal MAD")+guides(color=guide_legend(override.aes = list(size=4)))+ facet_wrap(~Solution)

ggplot(data=session.analysis3,aes(x=meanbeforeafter_mean,y=SigStdev_mean), group= factor(group_shrt))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Signal Diff", y="Signal StDev")+guides(color=guide_legend(override.aes = list(size=4)))+ facet_wrap(~Solution)

ggplot(data=session.analysis3,aes(x=MeanBefore_mean,y=z1MeanBefore_mean), group= factor(group_shrt)) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal vs Standardized Signal",x="Signal", y="Standardized Signal")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_wrap(~Solution)


ggplot(data=session.analysis3,aes(x=subject,y=SigMedian_mean, group= factor(Mouse)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Subject # (of group)", y="Signal Median")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

ggplot(data=session.analysis3,aes(x=subject,y=SigMAD_mean, group= factor(Mouse)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Subject # (of group)", y="Signal MAD")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)


ggplot(data=session.analysis3,aes(x=subject,y=(SigMedian_mean/SigMAD_mean), group= factor(Mouse)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.98,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Subject # (of group)", y="Signal Median/Signal MAD")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

ggplot(data=session.analysis3,aes(x=z1MeanAfter_mean,y=(SigMedian_mean/SigMAD_mean), group= factor(group_shrt)))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=1.0,label.x.npc = 0.1) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_continuous(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Signal Standardization",x="Standardized Signal After Bout", y="Signal Median/Signal MAD")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)



#Each point is a single session - Signal, Session Avgs
ggplot(data=session.analysis3,aes(x=session,y=MeanAfter_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.01,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),axis.title.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Characteristic Standardization",x="Session (Chronological Order)", y="Session Signal After Mean")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

#500x 500

ggplot(data=session.analysis3,aes(x=session,y=z1MeanAfter_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.01,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),axis.title.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Characteristic Standardization",x="Session (Chronological Order)", y="Session Std Signal After Mean")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)


ggplot(data=session.analysis3,aes(x=session,y=z2MeanAfter_mean), group= factor(Mouse))+geom_smooth(method=lm)+ stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc=0.01,label.x.npc = 0) +theme_classic()+geom_point(size=2,alpha=0.8,aes(color=Solution))+scale_color_manual(values = custom)+scale_x_discrete(expand = expansion(0.05))+scale_y_continuous(expand = expansion(0.2))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="top", legend.direction = "vertical",legend.box.spacing = unit(0,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),axis.title.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(title="Characteristic Standardization",x="Session (Chronological Order)", y="Session Std Signal After Mean")+ guides(color=guide_legend(override.aes = list(size=4)))+facet_grid(Sex~Solution)

```

## 7) Session Bouts & Consumption

### a) CL8

#### i) Session Consumption Averages

```{r}
ReplicateAverages <- session.analysis3 %>% group_by(Sex,Solution,group_shrt) %>% get_summary_stats(type = "mean_se");  
ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male")) 
ReplicateAverages$Solution <-factor(ReplicateAverages$Solution, levels=c("EtOH","Water","Sucrose")) 
ReplicateAverages$group_shrt<-factor(ReplicateAverages$group_shrt,levels=c("Female EtOH","Male EtOH","Female Water", "Male Water", "Female Sucrose", "Male Sucrose")) 
ReplicateAverages.mL<-filter(ReplicateAverages,variable=="Drinking.mL.kg",preserve=TRUE)
ReplicateAverages.g<-filter(ReplicateAverages,variable=="EtOH.gkg",preserve=TRUE)
ReplicateAverages.bout<-filter(ReplicateAverages,variable=="Bout_max",preserve=TRUE) 

##Plot all bouts per group with each solution a different color
session.analysis_graph<-session.analysis3 
session.analysis_graph$Solution<-factor(session.analysis_graph$Solution,levels=c("EtOH","Water","Sucrose"))


ggplot(data=session.analysis_graph,aes(x=group_shrt,y=Drinking.mL.kg, fill=Solution), group= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.mL,stat="identity",aes(y=mean,fill=Solution),size=1,alpha=0.3)+geom_beeswarm(cex=2.4,size=4,alpha=0.8,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+scale_fill_manual(values = custom)+geom_errorbar(data=ReplicateAverages.mL,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+scale_x_discrete(labels=c("Female","Male","Female","Male","Female","Male"),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,90),expand = expansion(c(0.015,0.03)))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.65,0.97),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=16,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(group_shrt=c("Female","Male","Female","Male","Female","Male"),x=NULL, y="**Consumption** (mL/kg)")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns)",")",sep=""),paste("list(~symbol('*'))",sep=","),paste("list(~symbol('*'))",sep=",")),y_position = c(30,58,58),textsize = otr.sz,tip_length = 0.00,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female Water"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol(''))",sep=",")),y_position = c(77),textsize = otr.sz,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.04)+geom_signif(xmin=c("Female Sucrose"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol(''))",sep=",")),y_position = c(65.5),textsize = otr.sz,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.04)+geom_signif(xmin=c("Female Water"), xmax = c("Male Water"),annotations= c(paste("list(~symbol(''))",sep=",")),y_position = c(65.5),textsize = otr.sz,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.04)+geom_signif(xmin=c("Male Water"), xmax = c("Female Sucrose"),annotations= c(paste("list(~symbol('**'))",sep=",")),y_position = c(70.3),textsize = otr.sz,tip_length = c(0.08,0.08),size=1,vjust= -0.05,parse=TRUE,extend_line=0.085,position=position_dodge(width=0.01))+geom_signif(xmin=c("Male EtOH"), xmax = c("Male Water"),annotations= c(paste("list(~symbol('***'))",sep=",")),y_position = c(81.5),textsize = otr.sz,tip_length = c(0.77,0.08),size=1,vjust= -0.05,parse=TRUE,extend_line=0.09,position=position_dodge(width=0.8))+geom_signif(xmin=c("Female EtOH"), xmax = c("Male EtOH"),annotations= c(paste("list(~symbol(''))",sep=",")),y_position = c(38.5),textsize = otr.sz,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.04)

#550 x 450


#Same as above but now color encodes animals 
ggplot(data=session.analysis3,aes(x=group_shrt,y=Drinking.mL.kg)) + theme_classic()+geom_beeswarm(cex=2.5,size=4,alpha=0.8,aes(color=factor(subject)))+ scale_colour_brewer(palette = "Dark2")+geom_point(data=ReplicateAverages.mL,aes(x=group_shrt,y=mean,shape=Sex),size=4,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,70),expand = expansion(0.03))+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.38,0.9),legend.box.spacing = unit(-0.5,"cm"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Group", y="Consumption (mL/kg)")+guides(color=guide_legend("Subject",override.aes = list(size=4)))  

##Now g/kg 
session.analysis_graph.EtOH<-filter(session.analysis_graph,Solution=="EtOH",preserve=TRUE) 
g<-ggplot(data=session.analysis_graph.EtOH,aes(x=Sex,y=EtOH.gkg)) +theme_classic()+geom_bar(data=ReplicateAverages.g,stat="identity",aes(y=mean),width=0.95,color="grey", fill="grey")+geom_beeswarm(cex=6,size=4.5,alpha=0.8,priority="density",aes(color=Solution),show.legend=FALSE)+scale_color_manual(values = c1)+geom_errorbar(data=ReplicateAverages.g,aes(x=Sex,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.1))+scale_y_continuous(n.breaks=10, limits=c(0,6),expand = expansion(0.03))+theme(axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="g/kg")+geom_signif(xmin=c("Female"), xmax = c("Male"),annotations= c(paste("list(~scriptstyle(ns)",")",sep="")),parse=TRUE,vjust=-0.2,y_position = c(5),textsize = 6,tip_length = 0.07,size=1) 
print(g)

##Final mL/kg plot with inset of g/kg  
ggplot(data=session.analysis_graph,aes(x=group_shrt,y=Drinking.mL.kg), group= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.mL,stat="identity",aes(y=mean),width=0.9,color="grey", fill="grey")+geom_beeswarm(cex=2,size=5,alpha=0.8,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.mL,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(c(0.08,0.08)))+scale_y_continuous(n.breaks=10, limits=c(0,70),expand = expansion(c(0.02,0.03)))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.98),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Consumption** <br> mL/kg")+guides(color=guide_legend(override.aes = list(size=6)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns)",")",sep=""),paste("list(~symbol('*'))",sep=","),paste("list(~symbol('*'))",sep=",")),y_position = c(30,58,58),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female Water"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol('***'))",sep=",")),y_position = c(65),textsize = 6,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.2)+geom_signif(xmin=c("Female Sucrose"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol('**'))",sep=",")),y_position = c(61.5),textsize = 6,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line=0.06)+inset_element(g, left = unit(0, "npc") + unit(22, "mm"),bottom = 0.6,right = 0.45,top = unit(1, "npc") - unit(1, "mm"),align_to = "full")

#700x550

## Session Bouts
ggplot(data=session.analysis_graph,aes(x=group_shrt,y=Bout_max), group= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.bout,stat="identity",aes(y=mean),width=0.9,color="grey", fill="grey")+geom_beeswarm(cex=2,size=5,alpha=0.8,priority="density",aes(color=Solution))+scale_color_manual(values = custom)+geom_errorbar(data=ReplicateAverages.bout,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,size=1,color="black")+scale_x_discrete(limits=c("Female EtOH","Male EtOH","A","Female Water","Male Water", "B", "Female Sucrose","Male Sucrose"),breaks=c("Female EtOH","Male EtOH","Female Water","Male Water", "Female Sucrose","Male Sucrose"),labels=scales::label_wrap(4),expand = expansion(c(0.08,0.08)))+scale_y_continuous(n.breaks=10, limits=c(0,90),expand = expansion(c(0.02,0.03)))+theme(legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.52,0.95),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(margin = margin(t = 0, r = 5, b = 0, l = 0)),axis.title.x = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Total Session Bouts** (#)")+guides(color=guide_legend(override.aes = list(size=6)))+geom_signif(xmin=c("Female EtOH","Female Water","Female Sucrose"), xmax = c("Male EtOH","Male Water","Male Sucrose"),annotations= c(paste("list(~scriptstyle(ns)",")",sep=""),paste("list(~scriptstyle(ns))",sep=","),paste("list(~scriptstyle(ns))",sep=",")),y_position = c(35,70,70),textsize = 6,tip_length = 0.04,size=1,vjust= -0.05,parse=TRUE)+geom_signif(xmin=c("Female Water"), xmax = c("Male Sucrose"),annotations= c(paste("list(~symbol('***'))",sep=",")),y_position = c(75),textsize = 6,tip_length = 0.0,size=1,vjust= -0.05,parse=TRUE,extend_line = 0.03)

#700 x 550
```

#### ii) Correlations With Session Bout Characteristics

```{r}
#Bout Duration Total by Solution 
ggplot(data=session.analysis3, aes(x=BoutDuration_Total, y=Drinking.mL.kg))+   geom_point()+   facet_grid2(~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 10,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Consumption (mL/kg)")  

#Bout Duration Total by Solution & Sex 
ggplot(data=session.analysis3, aes(x=BoutDuration_Total, y=Drinking.mL.kg))+   geom_point()+   facet_grid2(Sex~Solution,strip=strip_themed(background_x = elem_list_rect(fill = custom)))+   geom_smooth(method=lm)+   stat_cor(aes(label = paste(after_stat(rr.label),after_stat(p.label),sep="\n")),p.digits=4,color = "black",output.type = "text",label.y.npc="top")+   theme_classic()+   scale_y_continuous(n.breaks = 10,expand = expansion(0.01))+   scale_x_continuous(n.breaks = 10,expand = expansion(0.02))+   theme(strip.text.x=element_text(size=12,face="bold",color="white"),strip.text.y=element_text(size=12,face="bold"),legend.title=element_blank(),legend.text=element_text(size=16),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.25,0.89),axis.text=element_text(size=14,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x="Total Bout Duration  (s)", y="Consumption (mL/kg)")
```


#### i) Session Consumption Averages

```{r}
#############################################################
##### PUBLICATION GRAPH ####################################
############################################################

session.analysis_graph<-session.analysis3
session.analysis_graph$Solution<-factor(session.analysis_graph$Solution,levels=sol.levels)

ReplicateAverages <- session.analysis_graph %>% group_by(Solution,Sex,group_shrt) %>% get_summary_stats(type = "mean_se");  
ReplicateAverages$Solution <-factor(ReplicateAverages$Solution, levels=sol.levels) 
ReplicateAverages.mL<-filter(ReplicateAverages,variable=="Drinking.mL.kg",preserve=TRUE)  
  
#Sig indicator lines over both Before and After bout data to begin to indicate differences between solutions. 
annotation_df<-data.frame(
  xstart=c(0.6,4.6,6.6),
  xend=c(4.4,6.4,10.4),
  yvals= c(52,107,60),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over both Before and After bout data to begin to indicate differences between solutions. 
annotation_df2<-data.frame(
  xstart=c(2.5),
  xend=c(5.5),
  yvals= c(112),
  labels=c(paste("list(symbol('***'))",sep=","))
  )
annotation_df3<-data.frame(
  xstart=c(5.5),
  xend=c(8.5),
  yvals= c(112),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

ggplot(data=session.analysis_graph,aes(x=group_shrt,y=Drinking.mL.kg, fill=Solution), group= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.mL,stat="identity",aes(y=mean,fill=Solution),size=1,alpha=0.3)+geom_beeswarm(cex=2.4,size=4,alpha=0.8,priority="density",aes(color=Solution))+scale_color_manual(limits=c("QHCl (Low)","Water","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)"),values = custom)+scale_fill_manual(limits=c("QHCl (Low)","Water","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)"),values=custom)+geom_errorbar(data=ReplicateAverages.mL,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+scale_x_discrete(labels=c("Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male"),expand = expansion(c(0.07,0.03)))+scale_y_continuous(n.breaks=12, limits=c(0,130),expand = expansion(c(0.026,0.1)))+theme(legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction="vertical",legend.position=c(0.0,0.92),legend.background=element_rect(fill="transparent"),axis.text.x=element_text(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor=element_blank())+labs(x=NULL, y="**Consumption** (mL/kg)")+guides(color=guide_legend(override.aes = list(size=3),ncol=2))+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.5,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.535,0.026),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.041,0.465),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)


output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"
#output<-"C:/Users/Christina/OneDrive/Desktop/"
ggsave(filename="CL20_BeeswarmBouts_HalfSolutions_Consumption_by_Sex_Solution_SI.tiff",plot=last_plot(), units="mm", width=650/.pt, height=350/.pt, dpi=1000,path=output,device=grDevices::tiff)



#Last 3 solutions
session.analysis_graph.last<-subset(session.analysis_graph,!Solution=="QHCl (High)" & !Solution=="QHCl (Low)" & !Solution=="Water" & !Solution=="Water + Dep")
session.analysis_graph.last$Solution <-factor(session.analysis_graph.last$Solution, levels=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH")) 
ReplicateAverages.mL_last<-subset(ReplicateAverages.mL,!Solution=="QHCl (High)" & !Solution=="QHCl (Low)" & !Solution=="Water" & !Solution=="Water + Dep")
ReplicateAverages.mL_last$Solution <-factor(ReplicateAverages.mL_last$Solution, levels=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH")) 



#Sig indicator lines over both Before and After bout data to begin to indicate differences between solutions. 
annotation_df<-data.frame(
  xstart=c(4.6),
  xend=c(6.4),
  yvals= c(35),
  labels=c(paste("list(symbol('*'))",sep=","))
  )

ggplot(data=session.analysis_graph.last,aes(x=group_shrt,y=Drinking.mL.kg, fill=Solution), group= factor(group_shrt)) +theme_classic()+geom_bar(data=ReplicateAverages.mL_last,stat="identity",aes(y=mean,fill=Solution),size=1,alpha=0.3)+geom_beeswarm(cex=2.4,size=4,alpha=0.8,priority="density",aes(color=Solution))+scale_color_manual(limits=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"),values = custom.alt3)+scale_fill_manual(limits=c("Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"),values=custom.alt3)+geom_errorbar(data=ReplicateAverages.mL_last,aes(x=group_shrt,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+scale_x_discrete(labels=c("Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male","Female","Male"),expand = expansion(c(0.1,0.03)))+scale_y_continuous(n.breaks=10, limits=c(0,110),expand = expansion(c(0.016,0.05)))+theme(legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction="vertical",legend.position=c(0.0,0.94),legend.background=element_rect(fill="transparent"),axis.text.x=element_text(size=txt.sz1,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor=element_blank())+labs(x=NULL, y="**Consumption** (mL/kg)")+guides(color=guide_legend(override.aes = list(size=3),ncol = 1),fill=guide_legend(size=3,ncol=1))+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"
ggsave(filename="CL20_BeeswarmBouts_NearlyAllSolutions_Consumption_by_Sex_Solution_Last3_SI.tiff",plot=last_plot(), units="mm", width=330/.pt, height=450/.pt, dpi=600,path=output)


###Collapsed by Sex
ReplicateAverages <- session.analysis_graph %>% group_by(Solution) %>% get_summary_stats(type = "mean_se");  
ReplicateAverages$Solution <-factor(ReplicateAverages$Solution, levels=c("QHCl (High)","QHCl (Low)","Water","Water + Dep","","Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH","Saccharin","Citric Acid")) 
ReplicateAverages.mL<-filter(ReplicateAverages,variable=="Drinking.mL.kg",preserve=TRUE)  
  




```

## 8) MLM Results & Interactions

### a) Signal Outcome Model 4.1z

```{r}

## Signal Outcome Model Estimated Means 

###############################################
######## Publishable Graph ####################
###############################################
## Sex Collapsed and Solutions Separated using Facet
sig1z.df<-emmip(model4.1z_fit,"Solution"~"time", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig1z.df$Solution<-factor(sig1z.df$Solution,levels=sol.levels.contr,labels=c("Water (Control)","QHCl (Low)","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)"))

sig1z.df$xvar<-factor(sig1z.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

#Duplicate Water to include in multiple facets
# How many replicates you want of each row
duptimes <- c(4,1,1,1,1,4,1,1,1,1)
# Create an index of the rows you want with duplication
idx <- rep(1:nrow(sig1z.df), duptimes)
# Use that index to generate your new data frame
sig1z.df2 <- sig1z.df[idx,]

sig1z.df2$tvar<-c("panel1","panel2","panel3","panel4")
sig1z.df2$tvar<-factor(sig1z.df2$tvar,levels=c("panel1","panel2","panel3","panel4"))

ggplot(data=subset(sig1z.df2,!tvar=="NA"),aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.16),linewidth=0.7)+geom_point(position=position_dodge(0.16),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.5,position=position_dodge(0.16))+theme_classic()+scale_color_manual(breaks=c("Water (Control)","QHCl (Low)","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)"),limits=c("Water (Control)","QHCl (Low)","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)"),values = c(custom.alt),drop=FALSE)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.25,0.3)))+scale_y_continuous(expand = expansion(c(0.00,0.04)),limits=c(-0.9,1.1),n.breaks=10)+facet_wrap(.~tvar,ncol=5)+theme(strip.text.x = element_blank(),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal",legend.position=c(0.0,0.9),legend.key.spacing.x=unit(.77, "cm"),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y = element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+guides(color=guide_legend(nrow=3,ncol=2,override.aes = list(size=3,alpha=1)))

output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"
ggsave(filename="CL20 Model4.1z_fit HalfSolutions_StandardizedSignal_EstimatedMeans_by_time_SexCollapsed.tiff",plot=last_plot(), units="mm", width=650/.pt, height=350/.pt, dpi=1000,path=output,device=grDevices::tiff)

###############################################
######## Publishable Graph ####################
###############################################

## Sex Separated and Solutions Separated using Facet
sig1z.df<-emmip(model4.1z_fit,"Solution"~"time",by="Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig1z.df$Solution<-factor(sig1z.df$Solution,levels=c("Water","Sucrose + QHCl (Low)"),labels=c("Water (Control)","Sucrose + QHCl (Low)"))
sig1z.df<-remove_missing(sig1z.df,na.rm=TRUE)

sig1z.df$xvar<-factor(sig1z.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

# #Duplicate Water to include in multiple facets
# # How many replicates you want of each row
# duptimes <- c(1,1,1,1,1,1,1,1)
# # Create an index of the rows you want with duplication
# idx <- rep(1:nrow(sig1z.df), duptimes)
# # Use that index to generate your new data frame
# sig1z.df2 <- sig1z.df[idx,]

sig1z.df2$tvar<-c("panel1","panel2","panel1","panel2")
sig1z.df2$tvar<-factor(sig1z.df2$tvar,levels=c("panel1","panel2"))

#This allows us to do some customization to the facet labels.   
strips <- strip_nested(
  text_x = list(element_blank(),element_text()),
  background_x = list(element_blank(),element_rect()), 
  by_layer_x = TRUE
)
#Note: had to reduce top plot margin to correct for the area left by the invisible strip label.

ggplot(data=subset(sig1z.df2,!tvar=="NA"),aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.20),linewidth=0.7)+geom_point(position=position_dodge(0.20),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.5,position=position_dodge(0.20))+theme_classic()+scale_color_manual(breaks=c("Water (Control)","Sucrose + QHCl (Low)","EtOH"),limits=c("Water (Control)","Sucrose + QHCl (Low)"),values = c(c2.2,c9,c1),drop=FALSE)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.25,0.3)))+scale_y_continuous(expand = expansion(c(0.00,0.01)),limits=c(-0.9,1.2),n.breaks=10)+facet_nested(.~tvar+Sex,strip=strips)+theme(strip.text.x = element_text(face="bold",size=title.sz),plot.margin = margin(t = -22),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal",legend.position=c(0.00,0.9),legend.key.spacing.x=unit(.77, "cm"),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y = element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+guides(color=guide_legend(nrow=2,ncol=3,override.aes = list(size=3,alpha=1)))

output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"
ggsave(filename="CL20 Model4.1z_fit HalfSolutions_StandardizedSignal_EstimatedMeans_by_time_SexDivided.tiff",plot=last_plot(), units="mm", width=450/.pt, height=350/.pt, dpi=1000,path=output,device=grDevices::tiff)



###############################################
######## Publishable Graph ####################
###############################################

## Sex Divided and Solutions Separated using Facet
sig1z.df2<-emmip(model4.1z_fit,"Solution"~"time",by="Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig1z.df2$Solution<-factor(sig1z.df2$Solution,levels=c("Water","Sucrose + QHCl (Low)"),labels=c("Water (Control)","Sucrose + QHCl (Low)"))
sig1z.df2<-remove_missing(sig1z.df2,na.rm=TRUE)

sig1z.df2$xvar<-factor(sig1z.df2$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

sig1z.df2$Sex<-factor(sig1z.df2$Sex, levels=c("Female","Male"))

sig1z.df2$tvar<-c("panel1","panel2")

ggplot(data=subset(sig1z.df2,!tvar=="NA"),aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.20),linewidth=0.7)+geom_point(position=position_dodge(0.20),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.5,position=position_dodge(0.20))+theme_classic()+scale_color_manual(breaks=c("Water (Control)","Sucrose + QHCl (Low)","EtOH"),limits=c("Water (Control)","Sucrose + QHCl (Low)"),values = c(c2.2,c9,c1),drop=FALSE)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.25,0.3)))+scale_y_continuous(expand = expansion(c(0.00,0.01)),limits=c(-0.9,1.1),n.breaks=10)+facet_nested(.~Sex)+theme(strip.text.x = element_text(face="bold",size=title.sz),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "vertical",legend.position=c(0.00,0.9),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y = element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+guides(color=guide_legend(nrow=3,ncol=1,override.aes = list(size=3,alpha=1)))

output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"

ggsave(filename="CL20 Model4.1z_fit MostSolutions_StandardizedSignal_EstimatedMeans_by_time_SexDivided_Last3.tiff",plot=last_plot(), units="mm", width=400/.pt, height=350/.pt, dpi=1000,path=output,device=grDevices::tiff)



####################################
######### PUBLISHABLE GRAPH ########
####################################

## Sex Divided and Solutions Separated using Facet
sig1z.df3<-emmip(model4.1z_fit,"Solution"~"time",by="Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig1z.df3$Solution<-factor(sig1z.df3$Solution,levels=c("Water","Sucrose + QHCl (Low)","EtOH"),labels=c("Water (Control)","Sucrose + QHCl (Low)","EtOH"))
sig1z.df4<-remove_missing(sig1z.df3,na.rm=TRUE)

sig1z.df4$xvar<-factor(sig1z.df4$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


sig1z.df4$tvar<-c("panel1","panel2","panel1","panel2","panel1","panel2","panel1","panel2")

k<-ggplot(data=subset(sig1z.df4,!tvar=="NA"),aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.20),linewidth=0.7)+geom_point(position=position_dodge(0.20))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.5,position=position_dodge(0.20))+theme_classic()+scale_color_manual(breaks=c("Water (Control)","Sucrose + QHCl (Low)","EtOH"),limits=c("Water (Control)","Sucrose + QHCl (Low)","EtOH"),values = c(c2.2,c9,c1),drop=FALSE)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.25,0.3)))+scale_y_continuous(expand = expansion(c(0.00,0.01)),limits=c(-0.9,1.1),n.breaks=9)+facet_nested(.~Sex)+theme(strip.text.x = element_text(face="bold",size=otr.sz2),legend.title=element_blank(),legend.text=element_text(size=otr.sz1),legend.justification="left", legend.direction = "horizontal",legend.position="none",legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=otr.sz2,color="black"),axis.text.y=element_text(size=otr.sz1,color="black"),axis.title.y = element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL,y=NULL)+guides(color=guide_legend(nrow=1,ncol=3,override.aes = list(size=3,alpha=1)))

## Sex Collapsed and Solutions Separated using Facet
sig1z.df<-emmip(model4.1z_fit,"Solution"~"time", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

sig1z.df$Solution<-factor(sig1z.df$Solution,levels=sol.levels.contr,labels=c("Water (Control)","QHCl (Low)","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"))

sig1z.df$xvar<-factor(sig1z.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

#Duplicate Water to include in multiple facets
# How many replicates you want of each row
duptimes <- c(5,1,1,1,1,1,5,1,1,1,1,1)
# Create an index of the rows you want with duplication
idx <- rep(1:nrow(sig1z.df), duptimes)
# Use that index to generate your new data frame
sig1z.df2 <- sig1z.df[idx,]

sig1z.df2$tvar<-c("panel1","panel2","panel3","panel4","panel5")
sig1z.df2$tvar<-factor(sig1z.df2$tvar,levels=c("panel1","panel2","panel3","panel4","panel5"))

ggplot(data=subset(sig1z.df2,!tvar=="NA"),aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.16),linewidth=0.7)+geom_point(position=position_dodge(0.16))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.5,position=position_dodge(0.16))+theme_classic()+scale_color_manual(breaks=c("Water (Control)","QHCl (Low)","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"),limits=c("Water (Control)","QHCl (Low)","Water + Dep","Sucrose + QHCl (Low)","Sucrose + QHCl (High)","EtOH"),values = c(custom.alt),drop=FALSE)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.25,0.3)))+scale_y_continuous(expand = expansion(c(0.00,0.01)),limits=c(-0.9,1.1),n.breaks=10)+facet_wrap(.~tvar,ncol=5)+theme(strip.text.x = element_blank(),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal",legend.position=c(0.00,0.93),legend.key.spacing.x=unit(.77, "cm"),legend.background=element_rect("transparent"),legend.box.spacing = unit(-3.5,"cm"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.title.y = element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL,y="**GCaMP7f Signal** (z%<span style='font-family: Symbol;'>D</span>_F/F_)<br>Estimated Means")+guides(color=guide_legend(nrow=2,ncol=3,override.aes = list(size=3,alpha=1)))+inset_element(k,left = unit(0.5, "npc") + unit(22, "mm"),bottom = 0.6,right = 1,top = unit(1, "npc") - unit(1, "mm"),align_to = "full")

output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"
ggsave(filename="CL20 Model4.1z_fit MostSolutions_StandardizedSignal_EstimatedMeans_by_time_inset.tiff",plot=last_plot(), units="mm", width=750/.pt, height=450/.pt, dpi=900,path=output,device=grDevices::tiff)
```



### c) Characteristic Outcome Models

#### i) Consumption

```{r}
#############################################################
##### PUBLICATION GRAPH ####################################
############################################################


drink.df<-emmip(model5.drink_nested,"Solution"~"Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)

drink.df$Solution<-factor(drink.df$Solution,levels=sol.levels)
drink.df$Sex<-factor(drink.df$Sex, levels=c("Female","Male"))

ggplot(data=drink.df,aes(x=Sex,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.18))+geom_point(position=position_dodge(0.18),size=3)+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.03,0.02)),limits=c(-3.5,113),n.breaks=10)+labs(x=NULL,y="**Consumption** (mL/kg)<br> Estimated Means")+theme(legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.99,0.9),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title.x=element_text(size=title.sz),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit = "mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1),nrow=3))

output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/"

ggsave(filename="CL20 Model5.drink_nested HalfSolutions_StandardizedSignal_EstimatedMeans_by_time.tiff",plot=last_plot(), units="mm", width=480/.pt, height=350/.pt, dpi=1000,path=output)

```

#### ii) Total Bouts

```{r}
bout.df<-emmip(model5.bout_fit,"Solution"~"Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)  

bout.df$Solution<-factor(bout.df$Solution,levels=c("EtOH","Water","Sucrose"))  

ggplot(data=bout.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.065))+geom_point(position=position_dodge(0.065))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.065))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.03)),breaks=c(5,10,15,20,25,30,35,40,45))+labs(x=NULL,y="**Total Bouts (#)**<br> Estimated Means")+theme(legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.98),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #500 x 450
```


####iii) Bout Duration
```{r}
duration.df<-emmip(model5.duration_fita,"Solution"~"Sex", lmer.df="satterthwaite",lmerTest.limit=5667, type="factor",CIs=TRUE,plotit = FALSE)  

duration.df$Solution<-factor(duration.df$Solution,levels=c("EtOH","Water","Sucrose"))  

ggplot(data=duration.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.095))+geom_point(position=position_dodge(0.095))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.095))+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.25))+scale_y_continuous(expand = expansion(c(0.05,0.03)),limits=c(0,5),breaks=c(0,0.5,1,1.5,2,2.5,3,3.5,4,4.5,5,5.5))+labs(color=NULL,x=NULL,y="**Bout Duration** (seconds)<br> Estimated Means")+theme(legend.title=element_text(size=txt.sz1,face="bold"),legend.text=element_text(size=txt.sz1),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.77,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  

#500 x 450
```

### 

### d) Signal-Characteristic Outcome Models

#### i) Session-Level: Consumption

```{r}
## Wide range graphs
## Estimated Means of Drinking.mL.kg_imc Outcome Model - Males
drinkm.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1,2),Sex=c("Male")))

drinkm.df$Drinking.mL.kg_imc <- factor(drinkm.df$Drinking.mL.kg_imc,levels=c("-1","0","1","2"),labels=c("Male<br>Low<br>Drinking<br>Session", "Male<br>Mean<br>Drinking<br>Session", "Male<br>High<br>Drinking<br>Session","Male<br>Very<br>High<br>Drinking<br>Session"))

drinkm.df$Solution<-factor(drinkm.df$Solution,levels=c("EtOH","Water","Sucrose"))
drinkm.df$xvar<-factor(drinkm.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drinkm.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc,ncol=4)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.4,3.2),breaks=c(-1.6,-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.8,3.2))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.54,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=14,color="black"),axis.title.y =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_imc Outcome Model - Females
drinkf.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1,2),Sex=c("Female")))

drinkf.df$Drinking.mL.kg_imc <- factor(drinkf.df$Drinking.mL.kg_imc,levels=c("-1","0","1","2"),labels=c("Female<br>Low<br>Drinking<br>Session", "Female<br>Mean<br>Drinking<br>Session", "Female<br>High<br>Drinking<br>Session","Female<br>Very<br>High<br>Drinking<br>Session"))

drinkf.df$Solution<-factor(drinkf.df$Solution,levels=c("EtOH","Water","Sucrose"))
drinkf.df$xvar<-factor(drinkf.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drinkf.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc,ncol=4)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.4,3.2),breaks=c(-1.6,-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.8,3.2))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.54,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=14,color="black"),axis.title.y =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400


## Normal range graphs
## Estimated Means of Drinking.mL.kg_imc Outcome Model - Males
drinkm.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1),Sex=c("Male")))

drinkm.df$Drinking.mL.kg_imc <- factor(drinkm.df$Drinking.mL.kg_imc,levels=c("-1","0","1"),labels=c("Male<br>Low<br>Drinking Session", "Male<br>Mean<br>Drinking Session", "Male<br>High<br>Drinking Session"))

drinkm.df$Solution<-factor(drinkm.df$Solution,levels=c("EtOH","Water","Sucrose"))
drinkm.df$xvar<-factor(drinkm.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drinkm.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc,ncol=4)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.08,2.38),breaks=c(-1.5,-1.2,-0.9,-0.6,-0.3,0,0.3,0.6,.9,1.2,1.5,1.8,2.1,2.4,2.7,3.1))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=16),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.6,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=16,color="black"),axis.title.y =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_imc Outcome Model - Females
drinkf.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1),Sex=c("Female")))

drinkf.df$Drinking.mL.kg_imc <- factor(drinkf.df$Drinking.mL.kg_imc,levels=c("-1","0","1"),labels=c("Female<br>Low<br>Drinking Session", "Female<br>Mean<br>Drinking Session", "Female<br>High<br>Drinking Session"))

drinkf.df$Solution<-factor(drinkf.df$Solution,levels=c("EtOH","Water","Sucrose"))
drinkf.df$xvar<-factor(drinkf.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drinkf.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc,ncol=4)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.08,2.38),breaks=c(-1.5,-1.2,-0.9,-0.6,-0.3,0,0.3,0.6,.9,1.2,1.5,1.8,2.1,2.4,2.7,3.1))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.6,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=14,color="black"),axis.title.y =element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_imc Outcome Model - Both Sexes
drink.df<-emmip(model4.2zcdrink_fit,"Solution"~"time",by="Drinking.mL.kg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_imc=c(-1,0,1)))

drink.df$Drinking.mL.kg_imc <- factor(drink.df$Drinking.mL.kg_imc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Session", "Mean Drinking<br>Session", "High Drinking<br>Session"))

drink.df$Solution<-factor(drink.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink.df$xvar<-factor(drink.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-0.8,1.4),breaks=c(-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Mean")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400
########################################################################

## Estimated Means of Drinking.sol_imc Outcome Model - Males
drink1m.df<-emmip(model4.2zcdrink_fit1,"Solution"~"time",by="Drinking.sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Sex=c("Male")))

drink1m.df$Drinking.sol_imc <- factor(drink1m.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("Male<br>Low Drinking<br>Session", "Male<br>Mean Drinking<br>Session", "Male<br>High Drinking<br>Session"))

drink1m.df$Solution<-factor(drink1m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink1m.df$xvar<-factor(drink1m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink1m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.9),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.sol_imc Outcome Model - Females
drink1f.df<-emmip(model4.2zcdrink_fit1,"Solution"~"time",by="Drinking.sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Sex=c("Female")))

drink1f.df$Drinking.sol_imc <- factor(drink1f.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("Female<br>Low Drinking<br>Session", "Female<br>Mean Drinking<br>Session", "Female<br>High Drinking<br>Session"))

drink1f.df$Solution<-factor(drink1f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink1f.df$xvar<-factor(drink1f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink1f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.7,1.9),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Version with just EtOH
drink1.df<-emmip(model4.2zcdrink_fit1,"Sex"~"time",by="Drinking.sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Solution=c("EtOH")))

drink1.df$Drinking.sol_imc<-factor(drink1.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("Low EtOH<br>Drinking Session", "Mean EtOH<br>Drinking Session", "High EtOH<br>Drinking Session"))

drink1.df$xvar<-factor(drink1.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

linetypes<-c("longdash","solid","dotted")

ggplot(data=drink1.df,aes(x=xvar,y=yvar,group=Drinking.sol_imc,color=Drinking.sol_imc))+geom_line(aes(linetype=Drinking.sol_imc),linewidth=0.75,position=position_dodge(0.10))+geom_point(position=position_dodge(0.10))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.10),linetype="solid", show.legend = FALSE)+theme_classic()+facet_wrap(~Sex)+scale_color_manual(values = c("#F399A7","#D41159","#66192D"))+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.7,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8))+labs(linetype=NULL,color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_markdown(size=13,face="bold"),legend.text=element_markdown(size=13,margin = unit(0.1,"cm")),legend.justification="right", legend.direction = "vertical", legend.position=c(0.38,0.81),legend.key.width = unit(1.6,"cm"),legend.box.spacing = unit(-1.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)),linetype=guide_legend(override.aes = list(linewidth=0.75)))

#650 x 400


########################################################################

## Estimated Means of Drinking.mL.kg_gmc Outcome Model - Males
drink2m.df<-emmip(model4.2zcdrink_fit2,"Solution"~"time",by="Drinking.mL.kg_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_gmc=c(-1,0,0.5),Sex=c("Male")))

drink2m.df$Drinking.mL.kg_gmc <- factor(drink2m.df$Drinking.mL.kg_gmc,levels=c("-1","0","0.5"),labels=c("Low Drinking<br>Male", "Mean Drinking<br>Male", "High Drinking<br>Male"))

drink2m.df$Solution<-factor(drink2m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink2m.df$xvar<-factor(drink2m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink2m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.35,2.3),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_gmc Outcome Model - Females
drink2f.df<-emmip(model4.2zcdrink_fit2,"Solution"~"time",by="Drinking.mL.kg_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_gmc=c(-1,0,0.5),Sex=c("Female")))

drink2f.df$Drinking.mL.kg_gmc <- factor(drink2f.df$Drinking.mL.kg_gmc,levels=c("-1","0","0.5"),labels=c("Low Drinking<br>Female", "Mean Drinking<br>Female", "High Drinking<br>Female"))

drink2f.df$Solution<-factor(drink2f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink2f.df$xvar<-factor(drink2f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink2f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.35,2.3),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400


########################################################################

## Estimated Means of Drinking.mL.kg_smc Outcome Model - Males
drink3m.df<-emmip(model4.2zcdrink_fit3,"Solution"~"time",by="Drinking.mL.kg_smc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_smc=c(-1,0,1),Sex=c("Male")))

drink3m.df$Drinking.mL.kg_smc <- factor(drink3m.df$Drinking.mL.kg_smc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Male", "Mean Drinking<br>Male", "High Drinking<br>Male"))

drink3m.df$Solution<-factor(drink3m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink3m.df$xvar<-factor(drink3m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink3m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_smc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.9),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_smc Outcome Model - Females
drink3f.df<-emmip(model4.2zcdrink_fit3,"Solution"~"time",by="Drinking.mL.kg_smc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_smc=c(-1,0,1),Sex=c("Female")))

drink3f.df$Drinking.mL.kg_smc <- factor(drink3f.df$Drinking.mL.kg_smc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Female", "Mean Drinking<br>Female", "High Drinking<br>Female"))

drink3f.df$Solution<-factor(drink3f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink3f.df$xvar<-factor(drink3f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink3f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_smc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.9),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

########################################################################

## Estimated Means of Drinking.mL.kg_grpmc Outcome Model - Males
drink4m.df<-emmip(model4.2zcdrink_fit4,"Solution"~"time",by="Drinking.mL.kg_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_grpmc=c(-1,0,1),Sex=c("Male")))

drink4m.df$Drinking.mL.kg_grpmc <- factor(drink4m.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Male", "Mean Drinking<br>Male", "High Drinking<br>Male"))

drink4m.df$Solution<-factor(drink4m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink4m.df$xvar<-factor(drink4m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink4m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.mL.kg_gmc Outcome Model - Females
drink4f.df<-emmip(model4.2zcdrink_fit4,"Solution"~"time",by="Drinking.mL.kg_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_grpmc=c(-1,0,1),Sex=c("Female")))

drink4f.df$Drinking.mL.kg_grpmc <- factor(drink4f.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Female", "Mean Drinking<br>Female", "High Drinking<br>Female"))

drink4f.df$Solution<-factor(drink4f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink4f.df$xvar<-factor(drink4f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink4f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.mL.kg_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Version with just EtOH
drink4.df<-emmip(model4.2zcdrink_fit4,"Sex"~"time",by="Drinking.mL.kg_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.mL.kg_grpmc=c(-1,0,1),Solution=c("EtOH")))

drink4.df$Drinking.mL.kg_grpmc<-factor(drink4.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low EtOH Drinker","Mean EtOH Drinker","High EtOH Drinker"))

drink4.df$xvar<-factor(drink4.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

linetypes<-c("longdash","solid","dotted")

ggplot(data=drink4.df,aes(x=xvar,y=yvar,group=Drinking.mL.kg_grpmc,color=Drinking.mL.kg_grpmc))+geom_line(aes(linetype=Drinking.mL.kg_grpmc),linewidth=0.75,position=position_dodge(0.10))+geom_point(position=position_dodge(0.10))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.10),linetype="solid", show.legend = FALSE)+theme_classic()+facet_wrap(~Sex)+scale_color_manual(values = c("#F399A7","#D41159","#66192D"))+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.2,2.0),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8))+labs(linetype=NULL,color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_markdown(size=13,face="bold"),legend.text=element_markdown(size=13,margin = unit(0.1,"cm")),legend.justification="right", legend.direction = "vertical", legend.position=c(0.42,0.88),legend.key.width = unit(1.6,"cm"),legend.box.spacing = unit(-1.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)),linetype=guide_legend(override.aes = list(linewidth=0.75)))

#650 x 400


########################################################################

## Estimated Means of Drinking.sol_gmc Outcome Model - Males
drink5m.df<-emmip(model4.2zcdrink_fit5,"Solution"~"time",by="Drinking.sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_gmc=c(-1,0,1),Sex=c("Male")))

drink5m.df$Drinking.sol_gmc <- factor(drink5m.df$Drinking.sol_gmc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Male", "Mean Drinking<br>Male", "High Drinking<br>Male"))

drink5m.df$Solution<-factor(drink5m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink5m.df$xvar<-factor(drink5m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink5m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,1.94),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

## Estimated Means of Drinking.sol_gmc Outcome Model - Females
drink5f.df<-emmip(model4.2zcdrink_fit5,"Solution"~"time",by="Drinking.sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_gmc=c(-1,0,1),Sex=c("Female")))

drink5f.df$Drinking.sol_gmc <- factor(drink5f.df$Drinking.sol_gmc,levels=c("-1","0","1"),labels=c("Low Drinking<br>Female", "Mean Drinking<br>Female", "High Drinking<br>Female"))

drink5f.df$Solution<-factor(drink5f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink5f.df$xvar<-factor(drink5f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=drink5f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Drinking.sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,1.94),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400


########################################################################
########################################################################

## Estimated Means of Drinking.sol_gmc Outcome Model - Males
drink9m.df<-emmip(model4.2zcdrink_fit9,"Solution"~"time",by=c("Drinking.sol_imc","Drinking.mL.kg_grpmc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Drinking.mL.kg_grpmc=c(-1,0,1),Sex=c("Male")))

drink9m.df<-filter(drink9m.df, !Drinking.sol_imc=="0" & !Drinking.mL.kg_grpmc=="0")

drink9m.df$Drinking.mL.kg_grpmc <- factor(drink9m.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low Drinker", "Mean Drinker", "High Drinker"))

drink9m.df$Drinking.sol_imc <- factor(drink9m.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("in <br>Low Drinking Session", "in<br>Mean Drinking Session", "in<br>High Drinking Session"))

drink9m.df<-drink9m.df %>%
  mutate(group=paste(Drinking.mL.kg_grpmc,Drinking.sol_imc))

drink9m.df$group<-factor(drink9m.df$group,levels=c("Low Drinker in <br>Low Drinking Session","Low Drinker in<br>High Drinking Session","High Drinker in <br>Low Drinking Session","High Drinker in<br>High Drinking Session"))

drink9m.df$Solution<-factor(drink9m.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink9m.df$xvar<-factor(drink9m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")

ggplot(data=drink9m.df,aes(x=xvar,y=yvar, group=group,color=Solution, linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_wrap(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-2.2,2.4),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=11),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color="none")

#950 x 500



## Estimated Means of Drinking.sol_imc*Drinking.mL.kg_grpmc Outcome Model - Females
drink9f.df<-emmip(model4.2zcdrink_fit9,"Solution"~"time",by=c("Drinking.sol_imc","Drinking.mL.kg_grpmc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Drinking.mL.kg_grpmc=c(-1,0,1),Sex=c("Female")))

drink9f.df<-filter(drink9f.df, !Drinking.sol_imc=="0" & !Drinking.mL.kg_grpmc=="0")

drink9f.df$Drinking.mL.kg_grpmc <- factor(drink9f.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low Drinker", "Mean Drinker", "High Drinker"))

drink9f.df$Drinking.sol_imc <- factor(drink9f.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("in <br>Low Drinking Session", "in<br>Mean Drinking Session", "in<br>High Drinking Session"))

drink9f.df<-drink9f.df %>%
  mutate(group=paste(Drinking.mL.kg_grpmc,Drinking.sol_imc))

drink9f.df$group<-factor(drink9f.df$group,levels=c("Low Drinker in <br>Low Drinking Session","Low Drinker in<br>High Drinking Session","High Drinker in <br>Low Drinking Session","High Drinker in<br>High Drinking Session"))

drink9f.df$Solution<-factor(drink9f.df$Solution,levels=c("EtOH","Water","Sucrose"))
drink9f.df$xvar<-factor(drink9f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")

ggplot(data=drink9f.df,aes(x=xvar,y=yvar, group=group,color=Solution, linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_wrap(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-2.2,2.7),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=11),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")

#950 x 500



#Better interaction graph
## Estimated Means of Drinking.sol_imc*Drinking Outcome Model  
drink9.df<-emmip(model4.2zcdrink_fit9,"Solution"~"Sex",by=c("Drinking.sol_imc","Drinking.mL.kg_grpmc","time"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Drinking.sol_imc=c(-1,0,1),Drinking.mL.kg_grpmc=c(-1,0,1)))

drink9.df<-filter(drink9.df, !Drinking.sol_imc=="0" & !Drinking.mL.kg_grpmc=="0")

drink9.df$Drinking.mL.kg_grpmc <- factor(drink9.df$Drinking.mL.kg_grpmc,levels=c("-1","0","1"),labels=c("Low<br>Drinker", "Mean<br>Drinker", "High<br>Drinker"))

drink9.df$Drinking.sol_imc <- factor(drink9.df$Drinking.sol_imc,levels=c("-1","0","1"),labels=c("<br>Low Drinking<br>Session", "<br>Mean Drinking<br> Session", "<br>High Drinking<br>Session"))

drink9.df<-drink9.df %>%
  mutate(group=paste(Drinking.mL.kg_grpmc,Drinking.sol_imc))

drink9.df$group<-factor(drink9.df$group,levels=c("Low<br>Drinker <br>Low Drinking<br>Session","Low<br>Drinker <br>High Drinking<br>Session",
"High<br>Drinker <br>Low Drinking<br>Session", "High<br>Drinker <br>High Drinking<br>Session"))

drink9.df$Solution<-factor(drink9.df$Solution,levels=c("EtOH","Water","Sucrose"))

drink9.df$time<-factor(drink9.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")


ggplot(data=drink9.df,aes(x=group,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.21),linewidth=0.75)+geom_point(position=position_dodge(0.21))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.21),linetype="solid")+theme_classic()+facet_grid(Sex~time)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.04)),limits=c(-2.2,2.7),breaks=c(-2.2,-1.8,-1.4,-1.0,-0.6,-0.2,.2,.6,1.0,1.4,1.8,2.2,2.6,3.0,3.4,3.8))+labs(color=NULL,x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=14),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.36,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14 ),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#900 x 500


########################################################################

## Estimated Means of EtOH.gkg_imc Outcome Model  
drink6.df<-emmip(model4.2zcdrink_fit6,"Sex"~"time",by="EtOH.gkg_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(EtOH.gkg_imc=c(-1,0,1)))

drink6.df$EtOH.gkg_imc <- factor(drink6.df$EtOH.gkg_imc,levels=c("-1","0","1"),labels=c("Low EtOH<br>Drinking Session", "Mean EtOH<br>Drinking Session", "High EtOH<br>Drinking Session"))

drink6.df$xvar<-factor(drink6.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

linetypes<-c("longdash","solid","dotted")

ggplot(data=drink6.df,aes(x=xvar,y=yvar,group=EtOH.gkg_imc,color=EtOH.gkg_imc))+geom_line(aes(linetype=EtOH.gkg_imc),linewidth=0.75,position=position_dodge(0.10))+geom_point(position=position_dodge(0.10))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.10),linetype="solid", show.legend = FALSE)+theme_classic()+facet_wrap(~Sex)+scale_color_manual(values = c("#F399A7","#D41159","#66192D"))+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.7,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8))+labs(linetype=NULL,color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_markdown(size=13,face="bold"),legend.text=element_markdown(size=13,margin = unit(0.1,"cm")),legend.justification="right", legend.direction = "vertical", legend.position=c(0.38,0.81),legend.key.width = unit(1.6,"cm"),legend.box.spacing = unit(-1.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)),linetype=guide_legend(override.aes = list(linewidth=0.75)))

#650 x 400

## Estimated Means of EtOH.gkg_imc Outcome Model  
drink7.df<-emmip(model4.2zcdrink_fit7,"Sex"~"time",by="EtOH.gkg_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(EtOH.gkg_gmc=c(-1.0,0.0,1.0)))

drink7.df$EtOH.gkg_gmc <- factor(drink7.df$EtOH.gkg_gmc,levels=c(-1.0,0.0,1.0),labels=c("Low EtOH Drinker","Mean EtOH Drinker","High EtOH Drinker"))

drink7.df$xvar<-factor(drink7.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

linetypes<-c("longdash","solid","dotted")

ggplot(data=drink7.df,aes(x=xvar,y=yvar,group=EtOH.gkg_gmc,color=EtOH.gkg_gmc))+geom_line(aes(linetype=EtOH.gkg_gmc),linewidth=0.75,position=position_dodge(0.1))+geom_point(position=position_dodge(0.1))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.1),linetype="solid", show.legend = FALSE)+theme_classic()+facet_wrap(~Sex)+scale_color_manual(values = c("#F399A7","#D41159","#66192D"))+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.05)),limits=c(-1.96,2.2),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8))+labs(linetype=NULL,color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_markdown(size=13,face="bold"),legend.text=element_markdown(size=13,margin = unit(0.1,"cm")),legend.justification="right", legend.direction = "vertical", legend.position=c(0.42,0.88),legend.key.width = unit(1.6,"cm"),legend.box.spacing = unit(-1.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)),linetype=guide_legend(override.aes = list(linewidth=0.75)))

#650 x 400



```

#### ii) Bout-Level: Duration_imc

```{r}
##Signal-BoutDuration_imc Males
durationm.df<-emmip(model4.2zcDuration_fit,"Solution"~"time",by="Duration_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_imc=c(-1,0,1),Sex=c("Male")))

durationm.df$Duration_imc <- factor(durationm.df$Duration_imc,levels=c("-1","0","1"),labels=c("Males<br>During Shorter<br>Drinking Bouts", "Males<br>During Mean<br>Drinking Bouts", "Males<br>During Longer<br>Drinking Bouts"))

durationm.df$Solution<-factor(durationm.df$Solution,levels=c("EtOH","Water","Sucrose"))
durationm.df$xvar<-factor(durationm.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=durationm.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.55,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=16,color="black"),axis.title.y=element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_imc Females
durationf.df<-emmip(model4.2zcDuration_fit,"Solution"~"time",by="Duration_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_imc=c(-1,0,1),Sex=c("Female")))

durationf.df$Duration_imc <- factor(durationf.df$Duration_imc,levels=c("-1","0","1"),labels=c("Females<br>During Shorter<br>Drinking Bouts", "Females<br>During Mean<br>Drinking Bouts", "Females<br>During Longer<br>Drinking Bouts"))

durationf.df$Solution<-factor(durationf.df$Solution,levels=c("EtOH","Water","Sucrose"))
durationf.df$xvar<-factor(durationf.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=durationf.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.55,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=16,color="black"),axis.title.y=element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))
#650 x 400

##Signal-BoutDuration_imc Both Sexes
duration.df<-emmip(model4.2zcDuration_fit,"Solution"~"time",by="Duration_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_imc=c(-1,0,1)))

duration.df$Duration_imc <- factor(duration.df$Duration_imc,levels=c("-1","0","1"),labels=c("During Shorter<br>Drinking Bouts", "During Mean<br>Drinking Bouts", "During Longer<br>Drinking Bouts"))

duration.df$Solution<-factor(duration.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration.df$xvar<-factor(duration.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.4),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="**Signal** (z%dF/F)<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.55,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=16,color="black"),axis.title.y=element_markdown(size=18),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400


## Solution Centered
##Signal-BoutDuration_sol_imc Males
duration1m.df<-emmip(model4.2zcDuration_fit1,"Solution"~"time",by="Duration_sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1),Sex=c("Male")))

duration1m.df$Duration_sol_imc <- factor(duration1m.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("Males During<br>Shorter Drinking", "Males During<br>Mean Drinking", "Males During<br>Longer Drinking"))

duration1m.df$Solution<-factor(duration1m.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration1m.df$xvar<-factor(duration1m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration1m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_sol_imc Females
duration1f.df<-emmip(model4.2zcDuration_fit1,"Solution"~"time",by="Duration_sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1),Sex=c("Female")))

duration1f.df$Duration_sol_imc <- factor(duration1f.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("Females During<br>Shorter Drinking", "Females During<br>Mean Drinking", "Females During<br>Longer Drinking"))

duration1f.df$Solution<-factor(duration1f.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration1f.df$xvar<-factor(duration1f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration1f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_sol_imc Both Sexes
duration1.df<-emmip(model4.2zcDuration_fit1,"Solution"~"time",by="Duration_sol_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1)))

duration1.df$Duration_sol_imc <- factor(duration1.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("DuringShorter<br>Drinking Bouts", "During Mean<br>Drinking Bouts", "During Longer<br>Drinking Bouts"))

duration1.df$Solution<-factor(duration1.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration1.df$xvar<-factor(duration1.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration1.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_sol_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400
```

#### iii) Bout-Level: Duration_gmc

```{r}
##Signal-BoutDuration_gmc Males
duration2m.df<-emmip(model4.2zcDuration_fit2,"Solution"~"time",by="Duration_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_gmc=c(-1,0,1),Sex=c("Male")))

duration2m.df$Duration_gmc <- factor(duration2m.df$Duration_gmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Males", "Mean Drinking<br>Males", "Sustained Drinking<br>Males"))

duration2m.df$Solution<-factor(duration2m.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration2m.df$xvar<-factor(duration2m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration2m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-2.8,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_gmc Females
duration2f.df<-emmip(model4.2zcDuration_fit2,"Solution"~"time",by="Duration_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_gmc=c(-1,0,1),Sex=c("Female")))

duration2f.df$Duration_gmc <- factor(duration2f.df$Duration_gmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Females", "Mean Drinking<br>Females", "Sustained Drinking<br>Females"))

duration2f.df$Solution<-factor(duration2f.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration2f.df$xvar<-factor(duration2f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration2f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-2.8,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

########################################################################

##Signal-BoutDuration_grpmc Males
duration5m.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1),Sex=c("Male")))

duration5m.df$Duration_grpmc <- factor(duration5m.df$Duration_grpmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Males", "Mean Drinking<br>Males", "Sustained Drinking<br>Males"))

duration5m.df$Solution<-factor(duration5m.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration5m.df$xvar<-factor(duration5m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration5m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.2),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_grpmc Females
duration5f.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1),Sex=c("Female")))

duration5f.df$Duration_grpmc <- factor(duration5f.df$Duration_grpmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Females", "Mean Drinking<br>Females", "Sustained Drinking<br>Females"))

duration5f.df$Solution<-factor(duration5f.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration5f.df$xvar<-factor(duration5f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration5f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.2),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400

##Signal-BoutDuration_sol_gmc Both Sexes
duration5.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1)))

duration5.df$Duration_grpmc <- factor(duration5.df$Duration_grpmc,levels=c("-1","0","1"),labels=c("Quick Drinkers", "Mean Drinkers", "Sustained Drinkers"))

duration5.df$Solution<-factor(duration5.df$Solution,levels=c("EtOH","Water","Sucrose"))
duration5.df$xvar<-factor(duration5.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))

ggplot(data=duration5.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-.9,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#650 x 400
```

#### iv) Bout-Level: Duration_imc\*\_gmc

```{r}
## Estimated Means of Duration.sol_imc*Duration_grpmc Outcome Model  
duration6.df<-emmip(model4.2zcDuration_fit6,"Solution"~"Sex",by=c("Duration_sol_imc","Duration_grpmc","time"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1),Duration_grpmc=c(-1,0,1)))

duration6.df<-filter(duration6.df, !Duration_sol_imc=="0" & !Duration_grpmc=="0")

duration6.df$Duration_grpmc <- factor(duration6.df$Duration_grpmc,levels=c("-1","0","1"),labels=c("Quick<br>Drinker", "Mean<br>Drinker", "Sustained<br>Drinker"))

duration6.df$Duration_sol_imc <- factor(duration6.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("<br>Short Bout", "<br>Mean Bout", "<br>Long Bout"))

duration6.df<-duration6.df %>%
  mutate(group=paste(Duration_grpmc,Duration_sol_imc))

duration6.df$group<-factor(duration6.df$group,levels=c("Quick<br>Drinker <br>Short Bout","Quick<br>Drinker <br>Long Bout","Sustained<br>Drinker <br>Short Bout","Sustained<br>Drinker <br>Long Bout"))

duration6.df$Solution<-factor(duration6.df$Solution,levels=c("EtOH","Water","Sucrose"))

duration6.df$time<-factor(duration6.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")

ggplot(data=duration6.df,aes(x=xvar,y=yvar, group=group,color=Solution, linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_wrap(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.7),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=11),legend.justification="right", legend.direction = "horizontal", legend.key.width = unit(1.6,"cm"),legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")

#1000 x 500

ggplot(data=duration6.df,aes(x=group,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.21),linewidth=0.75)+geom_point(position=position_dodge(0.21))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.21),linetype="solid")+theme_classic()+facet_grid(Sex~time)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.04)),limits=c(-1.3,2.4),breaks=c(-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=14),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.36,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#900 x 500

```

#### ii) Bout-Level: LickFreq_imc

```{r}
##Signal-LickFreq_imc Males 
freqm.df<-emmip(model4.2zcLickFreq_fit,"Solution"~"time",by="LickFrequency_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_imc=c(-1,0,1),Sex=c("Male")))  

freqm.df$LickFrequency_imc <- factor(freqm.df$LickFrequency_imc,levels=c("-1","0","1"),labels=c("Males During<br>Slow Drinking", "Males During<br>Mean Drinking", "Males During<br>Fast Drinking"))  

freqm.df$Solution<-factor(freqm.df$Solution,levels=c("EtOH","Water","Sucrose")) 
freqm.df$xvar<-factor(freqm.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freqm.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.44),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  
#650 x 400 

##Signal-LickFreq_imc Females 
freqf.df<-emmip(model4.2zcLickFreq_fit,"Solution"~"time",by="LickFrequency_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_imc=c(-1,0,1),Sex=c("Female")))  

freqf.df$LickFrequency_imc <- factor(freqf.df$LickFrequency_imc,levels=c("-1","0","1"),labels=c("Females During<br>Slow Drinking", "Females During<br>Mean Drinking", "Females During<br>Fast Drinking"))  

freqf.df$Solution<-factor(freqf.df$Solution,levels=c("EtOH","Water","Sucrose")) 

freqf.df$xvar<-factor(freqf.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freqf.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.44),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  
#650 x 400 

 
##Signal-LickFreq_imc Both Sexes 
freq.df<-emmip(model4.2zcLickFreq_fit,"Solution"~"time",by="LickFrequency_imc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_imc=c(-1,0,1)))  

freq.df$LickFrequency_imc <- factor(freq.df$LickFrequency_imc,levels=c("-1","0","1"),labels=c("During<br>Slow Drinking", "During<br>Mean Drinking", "During<br>Fast Drinking"))  

freq.df$Solution<-factor(freq.df$Solution,levels=c("EtOH","Water","Sucrose")) 

freq.df$xvar<-factor(freq.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freq.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_imc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.44),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  
# 650 x 400


## Trying to pull out what the sex interaction looks like - all vars
freq.df<-emmip(model4.2zcLickFreq_fit,"Solution"~"Sex",by=c("LickFrequency_imc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_imc=c(-1,0,1)))  

freq.df$LickFrequency_imc <- factor(freq.df$LickFrequency_imc,levels=c("-1","0","1"),labels=c("During<br>Slow Drinking", "During<br>Mean Drinking", "During<br>Fast Drinking"))  

freq.df$Solution<-factor(freq.df$Solution,levels=c("EtOH","Water","Sucrose")) 


ggplot(data=freq.df,aes(x=LickFrequency_imc,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_grid(~Sex)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.4,1.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14),axis.title.y = element_markdown(),axis.text.x=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  
#650 x 400 
```

#### iii) Bout-Level: LickFreq_gmc

```{r}
##Signal-LickFrequency_sol_gmc Males 
freq2m.df<-emmip(model4.2zcLickFreq_fit3,"Solution"~"time",by="LickFrequency_sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_gmc=c(-1,0,1),Sex=c("Male")))  

freq2m.df$LickFrequency_sol_gmc <- factor(freq2m.df$LickFrequency_sol_gmc,levels=c(-1,0,1),labels=c("Slow Drinking<br>Males", "Mean Drinking<br>Males", "Fast Drinking<br>Males"))  

freq2m.df$Solution<-factor(freq2m.df$Solution,levels=c("EtOH","Water","Sucrose")) 

freq2m.df$xvar<-factor(freq2m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freq2m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#650 x 400  

##Signal-LickFrequency_sol_gmc Males 
freq2f.df<-emmip(model4.2zcLickFreq_fit3,"Solution"~"time",by="LickFrequency_sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_gmc=c(-1,0,1),Sex=c("Female")))  

freq2f.df$LickFrequency_sol_gmc <- factor(freq2f.df$LickFrequency_sol_gmc,levels=c(-1,0,1),labels=c("Slow Drinking<br>Females", "Mean Drinking<br>Females", "Fast Drinking<br>Females"))  

freq2f.df$Solution<-factor(freq2f.df$Solution,levels=c("EtOH","Water","Sucrose")) 

freq2f.df$xvar<-factor(freq2f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freq2f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.1,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#650 x 400 

########################################################################  
##Signal-BoutDuration_grpmc Males 
freq5m.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1),Sex=c("Male")))  freq5m.df$Duration_grpmc <- factor(freq5m.df$Duration_grpmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Males", "Mean Drinking<br>Males", "Sustained Drinking<br>Males"))  freq5m.df$Solution<-factor(freq5m.df$Solution,levels=c("EtOH","Water","Sucrose")) freq5m.df$xvar<-factor(freq5m.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  ggplot(data=freq5m.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.2),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #650 x 400  ##Signal-BoutDuration_grpmc Females freq5f.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1),Sex=c("Female")))  freq5f.df$Duration_grpmc <- factor(freq5f.df$Duration_grpmc,levels=c(-1,0,1),labels=c("Quick Drinking<br>Females", "Mean Drinking<br>Females", "Sustained Drinking<br>Females"))  freq5f.df$Solution<-factor(freq5f.df$Solution,levels=c("EtOH","Water","Sucrose")) freq5f.df$xvar<-factor(freq5f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  ggplot(data=freq5f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.2,2.2),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #650 x 400  ##Signal-BoutDuration_sol_gmc Both Sexes freq5.df<-emmip(model4.2zcDuration_fit5,"Solution"~"time",by="Duration_grpmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_grpmc=c(-1,0,1)))  freq5.df$Duration_grpmc <- factor(freq5.df$Duration_grpmc,levels=c("-1","0","1"),labels=c("Quick Drinkers", "Mean Drinkers", "Sustained Drinkers"))  freq5.df$Solution<-factor(freq5.df$Solution,levels=c("EtOH","Water","Sucrose")) freq5.df$xvar<-factor(freq5.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  ggplot(data=freq5.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~Duration_grpmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-.9,2.0),breaks=c(-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #650 x 400
```

#### iv) Bout-Level: LickFreq_imc\*\_gmc

```{r}
## Estimated Means of LickFrequency.sol_imc*LickFrequency_sol_gmc Outcome Model - all vars 
freq7.df<-emmip(model4.2zcLickFreq_fit7,"Solution"~"Sex",by=c("LickFrequency_sol_imc","LickFrequency_sol_gmc","time"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_imc=c(-1,0,1),LickFrequency_sol_gmc=c(-1,0,1)))

freq7.df<-filter(freq7.df, !LickFrequency_sol_imc=="0" & !LickFrequency_sol_gmc=="0")  

freq7.df$LickFrequency_sol_gmc <- factor(freq7.df$LickFrequency_sol_gmc,levels=c("-1","0","1"),labels=c("Low Frequency<br>Licker", "Mean<br>Drinker", "High Frequency<br>Licker")) 

freq7.df$LickFrequency_sol_imc <- factor(freq7.df$LickFrequency_sol_imc,levels=c("-1","0","1"),labels=c("<br>Slow Lick Bout", "<br>Mean Bout", "<br>Fast Lick Bout"))  

freq7.df<-freq7.df %>%   
  mutate(group=paste(LickFrequency_sol_gmc,LickFrequency_sol_imc))  

freq7.df$group<-factor(freq7.df$group,levels=c("Low Frequency<br>Licker <br>Slow Lick Bout","Low Frequency<br>Licker <br>Fast Lick Bout","High Frequency<br>Licker <br>Slow Lick Bout", "High Frequency<br>Licker <br>Fast Lick Bout"))  

freq7.df$Solution<-factor(freq7.df$Solution,levels=c("EtOH","Water","Sucrose"))  

freq7.df$time<-factor(freq7.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))   

linetypes=c("dotted","dotdash","dashed","solid")  


ggplot(data=freq7.df,aes(x=group,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.21),linewidth=0.75)+geom_point(position=position_dodge(0.21))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.21),linetype="solid")+theme_classic()+facet_grid(Sex~time)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.04)),limits=c(-1.3,1.8),breaks=c(-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=14),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.36,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))  #900 x 500 


## Estimated Means of LickFrequency.sol_imc*LickFrequency_sol_gmc Outcome Model - collapsed on sex 
freq7ns.df<-emmip(model4.2zcLickFreq_fit7,"Solution"~"time",by=c("LickFrequency_sol_imc","LickFrequency_sol_gmc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_imc=c(-1,0,1),LickFrequency_sol_gmc=c(-1,0,1)))

freq7ns.df<-filter(freq7ns.df, !LickFrequency_sol_imc=="0" & !LickFrequency_sol_gmc=="0")  

freq7ns.df$LickFrequency_sol_gmc <- factor(freq7ns.df$LickFrequency_sol_gmc,levels=c("-1","0","1"),labels=c("Low Frequency<br>Licker", "Mean<br>Drinker", "High Frequency<br>Licker")) 

freq7ns.df$LickFrequency_sol_imc <- factor(freq7ns.df$LickFrequency_sol_imc,levels=c("-1","0","1"),labels=c("<br>Slow Lick Bout", "<br>Mean Bout", "<br>Fast Lick Bout"))  

freq7ns.df<-freq7ns.df %>%   
  mutate(group=paste(LickFrequency_sol_gmc,LickFrequency_sol_imc))  

freq7ns.df$group<-factor(freq7ns.df$group,levels=c("Low Frequency<br>Licker <br>Slow Lick Bout","Low Frequency<br>Licker <br>Fast Lick Bout","High Frequency<br>Licker <br>Slow Lick Bout", "High Frequency<br>Licker <br>Fast Lick Bout"))  

freq7ns.df$Solution<-factor(freq7ns.df$Solution,levels=c("EtOH","Water","Sucrose"))  

freq7ns.df$time<-factor(freq7ns.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before<br>Bout","After<br>Bout"))   

linetypes=c("dotted","dotdash","dashed","solid")  


ggplot(data=freq7ns.df,aes(x=time,y=yvar, group=group,color=Solution,linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_grid(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.key.width = unit(1.6,"cm"),legend.title=element_blank(),legend.text=element_markdown(size=12),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.98,0.90),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")
#900 x 500 



## Estimated Means of LickFrequency.sol_imc*LickFrequency_sol_gmc Outcome Model - collapsed on sex and LickFrequency.sol_imc
freq7nsni.df<-emmip(model4.2zcLickFreq_fit7,"Solution"~"time",by=c("LickFrequency_sol_gmc"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_gmc=c(-1,0,1)))

freq7nsni.df<-filter(freq7nsni.df, !LickFrequency_sol_gmc=="0")  

freq7nsni.df$LickFrequency_sol_gmc <- factor(freq7nsni.df$LickFrequency_sol_gmc,levels=c("-1","0","1"),labels=c("Low Frequency<br>Licker", "Mean<br>Drinker", "High Frequency<br>Licker")) 

freq7nsni.df$Solution<-factor(freq7nsni.df$Solution,levels=c("EtOH","Water","Sucrose"))  

freq7nsni.df$time<-factor(freq7nsni.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before<br>Bout","After<br>Bout"))   

linetypes=c("dotted","dotdash","dashed","solid")  


ggplot(data=freq7nsni.df,aes(x=time,y=yvar, group=LickFrequency_sol_gmc,color=Solution,linetype=LickFrequency_sol_gmc))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_grid(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.key.width = unit(1.6,"cm"),legend.title=element_blank(),legend.text=element_markdown(size=13),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.98,0.90),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")
#450 x 500 
```

#### ii) Position

```{r}
##Signal-Position Males & Females (no sex diffs with just Position) 
pos.df<-emmip(model4.1zbPos_fita,"Solution"~"Position",by="time", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE)  

pos.df$xvar <- factor(pos.df$xvar,levels=c("First 10 min","Middle","Last 10 min"))  

pos.df$time<-factor(pos.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  


ggplot(data=pos.df,aes(x=time,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.1))+geom_point(position=position_dodge(0.1))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.1))+facet_wrap(.~xvar)+theme_classic()+scale_color_manual(values = c(c2,c7))+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.03,0.03)),limits=c(-2.8,3.7),breaks=c(-2.4,-2,-1.6,-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.8,3.2,3.6,4))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=txt.sz2),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.0,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.text.x=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#500 x 450  


##Signal-Position H2O Females 
pos.df2f<-emmip(model4.1zbPos_fita,"time"~"Position",by="Solution", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",at=list("Sex"="Female"),CIs=TRUE,plotit = FALSE)  

pos.df2f$xvar <- factor(pos.df2f$xvar,levels=c("First 10 min","Middle","Last 10 min"),labels=c("Female<br>First 10 min","Female<br>Middle","Female<br>Last 10 min"))  

pos.df2f$tvar<-factor(pos.df2f$tvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=pos.df2f,aes(x=tvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.1))+geom_point(position=position_dodge(0.1))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.1))+facet_wrap(.~xvar)+theme_classic()+scale_color_manual(values = c(c2,c7))+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.03,0.03)),limits=c(-2.8,3.7),breaks=c(-2.4,-2,-1.6,-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.8,3.2,3.6,4))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=txt.sz2),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.0,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.text.x=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#700 x 450  

##Signal-Position H2O Males 
pos.df2m<-emmip(model4.1zbPos_fita,"time"~"Position",by="Solution", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",at=list("Sex"="Male"),CIs=TRUE,plotit = FALSE)  

pos.df2m$xvar <- factor(pos.df2m$xvar,levels=c("First 10 min","Middle","Last 10 min"),labels=c("Male<br>First 10 min","Male<br>Middle","Male<br>Last 10 min"))  

pos.df2m$tvar<-factor(pos.df2m$tvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=pos.df2m,aes(x=tvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.1))+geom_point(position=position_dodge(0.1))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.1))+facet_wrap(.~xvar)+theme_classic()+scale_color_manual(values = c(c2,c7))+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.03,0.03)),limits=c(-2.8,3.7),breaks=c(-2.4,-2,-1.6,-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.8,3.2,3.6,4))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=txt.sz2),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.0,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.text.x=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#700 x 450  

##Signal-Position H2O Collapsed Across Sex and Position
pos.df2<-emmip(model4.1zbPos_fita,~"Solution", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE)  

#pos.df$xvar <- factor(pos.df$xvar,levels=c("First 10 min","Middle","Last 10 min"))  

#pos.df$time<-factor(pos.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  


ggplot(data=pos.df2,aes(x=xvar,y=yvar))+geom_line(position=position_dodge(0.1))+geom_point(position=position_dodge(0.1))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.1))+theme_classic()+scale_color_manual(values = c(c2,c7))+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.03,0.03)),limits=c(-0.8,1),breaks=c(-2.4,-2,-1.6,-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.8,3.2,3.6,4))+labs(x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=txt.sz2),legend.title=element_blank(),legend.text=element_text(size=txt.sz1),legend.justification="left", legend.direction = "horizontal", legend.position=c(0.0,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text.y=element_text(size=txt.sz1,color="black"),axis.text.x=element_text(size=txt.sz1,color="black"),axis.title=element_text(size=title.sz),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#500 x 450  




##Signal-Position Males & Females (no sex diffs with just Position) 
pos.df<-emmip(model4.2zcPos_fit,"Solution"~"Position", by="time",lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE)  

pos.df$xvar <- factor(pos.df$xvar,levels=c("First 10 min","Middle","Last 10 min"))  

pos.df$Solution<-factor(pos.df$Solution,levels=c("EtOH","Water","Sucrose")) 

pos.df$time<-factor(pos.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=pos.df,aes(x=time,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.1))+geom_point(position=position_dodge(0.1))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.1))+facet_wrap(~xvar)+theme_classic()+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.35))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-0.8,1.5),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(color=NULL,x=NULL,y="**Signal (z%dF/F)**<br>Estimated Means")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=14),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.53,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=16,color="black"),axis.title=element_text(size=18),axis.title.y=element_markdown(),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#650 x 400  

##Signal-LickFrequency_sol_gmc Males 
freq2f.df<-emmip(model4.2zcLickFreq_fit3,"Solution"~"time",by="LickFrequency_sol_gmc", lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(LickFrequency_sol_gmc=c(-1,0,1),Sex=c("Female")))  

freq2f.df$LickFrequency_sol_gmc <- factor(freq2f.df$LickFrequency_sol_gmc,levels=c(-1,0,1),labels=c("Slow Drinking<br>Females", "Mean Drinking<br>Females", "Fast Drinking<br>Females"))  

freq2f.df$Solution<-factor(freq2f.df$Solution,levels=c("EtOH","Water","Sucrose")) 


freq2f.df$xvar<-factor(freq2f.df$xvar, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))  

ggplot(data=freq2f.df,aes(x=xvar,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.13))+geom_point(position=position_dodge(0.13))+geom_linerange(aes(ymax=UCL,ymin=LCL),size=2, alpha=0.4,position=position_dodge(0.13))+theme_classic()+facet_wrap(~LickFrequency_sol_gmc)+scale_color_manual(values = custom)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.1,1.7),breaks=c(-2.6,-2.4,-2.2,-2,-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6))+labs(x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_text(size=13,face="bold"),legend.text=element_text(size=13),legend.justification="right", legend.direction = "horizontal", legend.position=c(0.63,0.95),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank()) +guides(color=guide_legend(override.aes = list(size=4,alpha=1))) 

#650 x 400 


####################################################################

## Estimated Means of Duration.sol_imc*Duration_grpmc Outcome Model  
duration6.df<-emmip(model4.2zcDuration_fit6,"Solution"~"Sex",by=c("Duration_sol_imc","Duration_grpmc","time"), lmer.df="satterthwaite",lmerTest.limit=5663,type="factor",CIs=TRUE,plotit = FALSE, at=list(Duration_sol_imc=c(-1,0,1),Duration_grpmc=c(-1,0,1)))

duration6.df<-filter(duration6.df, !Duration_sol_imc=="0" & !Duration_grpmc=="0")

duration6.df$Duration_grpmc <- factor(duration6.df$Duration_grpmc,levels=c("-1","0","1"),labels=c("Quick<br>Drinker", "Mean<br>Drinker", "Sustained<br>Drinker"))

duration6.df$Duration_sol_imc <- factor(duration6.df$Duration_sol_imc,levels=c("-1","0","1"),labels=c("<br>Short Bout", "<br>Mean Bout", "<br>Long Bout"))

duration6.df<-duration6.df %>%
  mutate(group=paste(Duration_grpmc,Duration_sol_imc))

duration6.df$group<-factor(duration6.df$group,levels=c("Quick<br>Drinker <br>Short Bout","Quick<br>Drinker <br>Long Bout","Sustained<br>Drinker <br>Short Bout","Sustained<br>Drinker <br>Long Bout"))

duration6.df$Solution<-factor(duration6.df$Solution,levels=c("EtOH","Water","Sucrose"))

duration6.df$time<-factor(duration6.df$time, levels=c("z2MeanBefore","z2MeanAfter"),labels=c("Before Bout","After Bout"))


linetypes=c("dotted","dotdash","dashed","solid")

ggplot(data=duration6.df,aes(x=xvar,y=yvar, group=group,color=Solution, linetype=group))+geom_line(position=position_dodge(0.18),linewidth=0.75)+geom_point(position=position_dodge(0.18))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.18),linetype="solid")+theme_classic()+facet_wrap(~Solution)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(0.15))+scale_y_continuous(expand = expansion(c(0.01,0.01)),limits=c(-1.0,1.7),breaks=c(-1.8,-1.6,-1.4,-1.2,-1.0,-0.8,-0.6,-0.4,-0.2,0,.2,.4,.6,.8,1,1.2,1.4,1.6,1.8,2.0,2.2,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=11),legend.justification="right", legend.direction = "horizontal", legend.key.width = unit(1.6,"cm"),legend.position=c(0.98,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color="none")

#1000 x 500

ggplot(data=duration6.df,aes(x=group,y=yvar, group=Solution,color=Solution))+geom_line(position=position_dodge(0.21),linewidth=0.75)+geom_point(position=position_dodge(0.21))+geom_linerange(aes(ymax=UCL,ymin=LCL),linewidth=2, alpha=0.4,position=position_dodge(0.21),linetype="solid")+theme_classic()+facet_grid(Sex~time)+scale_color_manual(values = custom)+scale_linetype_manual(values=linetypes)+scale_x_discrete(labels=scales::label_wrap(4),expand= expansion(c(0.15,0.15)))+scale_y_continuous(expand = expansion(c(0.01,0.04)),limits=c(-1.3,2.4),breaks=c(-1.2,-0.8,-0.4,0,.4,.8,1.2,1.6,2.0,2.4,2.6,2.8,3.0,3.2,3.4))+labs(color=NULL,x=NULL,y="Predicted Signal (z%dF/F)")+theme(strip.text.x = element_markdown(face="bold",size=14),strip.text.y = element_markdown(face="bold",size=14),legend.title=element_blank(),legend.text=element_markdown(size=14),legend.justification="right", legend.direction = "horizontal",legend.position=c(0.36,0.93),legend.box.spacing = unit(-3.5,"cm"),legend.background=element_rect(fill="transparent"),axis.text=element_text(size=12,color="black"),axis.text.x = element_markdown(),axis.title=element_text(size=14, face="bold"),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+guides(color=guide_legend(override.aes = list(size=4,alpha=1)))

#900 x 500


```

## MOVEMENT ARTIFACT ANALYSIS

### 1) Read in Data

```{r}
file5<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Movement Artifact Analysis/CL20_FlipTest1-2_Data.xlsx"

output<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Movement Artifact Analysis/"


movement.analysis<-read.xlsx(file5,sheetIndex=3,header=TRUE) # This is the movement artifact "flip" data
```

### 2) Filter & Finalize Data

```{r}
file2<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Drinking/CL20exptkey.xlsx"

sexkey<-read.xlsx(file2, sheetIndex=2)  

##For signal analysis
#Code to automatically enter in Output Order,Mouse,& Sex based on order in spreadsheet and FileName
setDT(movement.analysis)[,Sex:=rep(NA,length(row.names(movement.analysis)))] 

## Grab the Sex from the entry in the key that matches each Mouse
for (i in 1:length(movement.analysis$Subject)){ 
  movement.analysis$Sex[[i]]<-sexkey$Sex[[which(sexkey$Mouse==movement.analysis$Subject[[i]])]]}


##Levels of different factors specific to experiment - used later and is EXTREMELY IMPORTANT for contrasts

#This is used for the wide format data
sex.levels<-c("Female", "Male")
def.levels<-c("up", "down")

#This is used for the long format data
group3.levels<-c("Female UN 470","Female Standard","Female Robust","Female Joint","Male UN 470","Male Standard","Male Robust","Male Joint")

method.levels<-c("None","Standard","NNLS","Joint")
method.labels<-c("470 UN","Standard","Robust","Joint")


#Drop any mice or flips
##NOTE: Three flips were excluded before the data was read in due to perceived low quality of the flip in that there was not a clear single deflection in both the 470 and 405.These are in red on the original spreadsheet and were excluded in the "R" tab the data here is read from. 
#Prescreened out: 1) Subject 2, Flip 1; 2) Subject 4, Flip 3; 3) Subject 7, Flip 3. 

droppedmice<-c("") 
droppedflips<-data.frame("Subject"=c(""),"Flip"=c(""))
#droppedflips<-data.frame("Subject"=c("3"),"Flip"=c("1")) #This flip showed a massive outlier in both Standard and Joint normalization data - was an opposite sign as all the others and nearly equal magnitude. Other outliers existed but were included anyway because the very low variation in Standard and Joint groups allowed them to be statistical outliers but were really not that different from the other points. 

#Define replicates within sex manually here - exclude dropped animals!
subject<-data.frame("mouse"=c(2,3,4,5,6,7,8,9),"subject"=c(1,2,3,1,2,3,4,5)) 
sub.levels=c(1:9)


#Drop mice and flips defined above
movement.analysis2<-filter(movement.analysis, !Subject %in% droppedmice)

for (k in 1:nrow(droppedflips)){
movement.analysis2<-filter(movement.analysis2, !(Subject==droppedflips$Subject[[k]] & Flip==droppedflips$Flip[[k]]))
}

#Codes the subjects as replicate within sex  
setDT(movement.analysis2)[,Replicate:=rep(NA,length(row.names(movement.analysis2)))] 
for (i in 1:length(rownames(movement.analysis2))){     
      movement.analysis2$Replicate[[i]]<-subject$subject[[which(subject$mouse==movement.analysis2$Subject[[i]])]]
}


## Sort columns into desired order (feel free to customize). This will also be used to refer to all your variables later on so don't leave any out - THEY WILL BE DROPPED! 

myorder.m<-c("Subject","Sex","Replicate","Flip","Deflection.Up.Down","X405.Max","X405.Min","X405.Slope","Deflection.Amplitude","None.Max","None.Min","None.Correlation","None.Slope","Standard.Correlation","Standard.Slope","Standard..dCorrelation","Standard..dSlope","NNLS.Correlation","NNLS.Slope","NNLS..dCorrelation","NNLS..dSlope","Joint.Correlation","Joint.Slope","Joint..dCorrelation","Joint..dSlope")


#Define variables that are key descriptors of the data (e.g. Filename, Channel, Mouse, Sex, subject...)

indvars.m<-c("None.Correlation","None.Slope","Standard.Correlation","Standard.Slope","NNLS.Correlation","NNLS.Slope","Joint.Correlation","Joint.Slope")

movement.analysis2<-movement.analysis2[,..myorder.m]


rownames(movement.analysis2)<-c(1:length(rownames(movement.analysis2))) #reset row names so they follow a consecutive order again

myorder2.m<-myorder.m[which(myorder.m %in% indvars.m) ]

movement.analysis2_long<-movement.analysis2 %>% pivot_longer(cols=all_of(myorder2.m), cols_vary="slowest",names_to=c("Method",".value"),names_sep = "\\.") 

movement.analysis2_long$Method<-factor(movement.analysis2_long$Method, levels=method.levels,labels=method.labels)

#Create group variable that is a combination of Sex and Method
group_shrt<-paste(movement.analysis2_long$Sex,movement.analysis2_long$Method,sep=" ") 
movement.analysis2_long<-cbind(movement.analysis2_long,group_shrt) 

movement.analysis2_long$group_shrt<-factor(movement.analysis2_long$group_shrt,levels=group3.levels)
movement.analysis2_long$Sex<-factor(movement.analysis2_long$Sex,levels=sex.levels)
movement.analysis2_long$Deflection.Up.Down<-factor(movement.analysis2_long$Deflection.Up.Down,levels=def.levels)

remove(group_shrt,droppedmice,subject)

```

### 3) Set Graph Color Palette and Text Size
```{r}
c1<-"#D41159" #This is rgb(212,17,89, maxColorValue=255) or red for EtOH
c2<-"#1A85FF" #This is rgb(26,133,255, maxColorValue=255) or blue for Water
c3<-"#5225A0" #This is rgb(82,37,160, maxColorValue=255) or purple for Sucrose

custom<-c(c1,c2,c3) #Define custom color palette

c4<-"white" #For None
c5<-"lightgrey" #"#d3d3d3"#For Standard
c6<-"darkgrey" # "#a9a9a9" #For NNLS
c7<-"#B4F8DF" #This is rgb(180,248,223,maxColorValue=255)or sea green for Joint

custom2<-c(c4,c5,c6,c7)

patterns24<-c("stripe","stripe","stripe","stripe",rep.int("none",20))
patterns12<-c("stripe","stripe","stripe",rep.int("none",9))
patterns4<-c("stripe","none","none","none")

#Set specific relationships between titles, axis text, and other text categories so allow consistency between figures of the same size.

title.sz<-6.5*.pt
title.sz2<-8*.pt
txt.sz1<-5*.pt
txt.sz2<-5.5*.pt
txt.sz3<-6*.pt
otr.sz<-2.5*.pt
otr.sz1<-3.5*.pt
otr.sz2<-4.5*.pt
```

###4) Graph Data
#### a) Correlation with 405

```{r}
############
##Plot signal for all sessions per group divided only by sex 
ReplicateAverages <- movement.analysis2_long %>% group_by(Sex,Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.corr<-filter(ReplicateAverages,variable=="Correlation",preserve=TRUE)
ReplicateAverages.slope<-filter(ReplicateAverages,variable=="Slope",preserve=TRUE)


#Group by Method
ggplot(data=movement.analysis2_long,aes(x=Method,y=Correlation)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.corr,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE,color=c("black",NA,NA,NA,"black",NA,NA,NA))+geom_errorbar(data=ReplicateAverages.corr,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2),corral = "wrap",corral.width = 0.8)+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Sex,ncol=2) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(-1,1))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz1,color="black"),axis.title.y=element_markdown(size=title.sz),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Correlation** (With 405 nm Signal)")+guides(color=guide_legend(override.aes = list(size=4)))

#500 x 450


#################################
##### Publication Graph #########
#################################

############
##Plot signal for all sessions per group collapsed by sex 
ReplicateAverages <- movement.analysis2_long %>% group_by(Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages.corr<-filter(ReplicateAverages,variable=="Correlation",preserve=TRUE)

ggplot(data=movement.analysis2_long,aes(x=Method,y=Correlation)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.corr,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE,color=c("black",NA,NA,NA))+geom_errorbar(data=ReplicateAverages.corr,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.4,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2),corral = "wrap",corral.width = 0.8)+scale_fill_manual(values = custom2)+geom_hline(yintercept=0,linetype=1)+scale_pattern_manual(values = patterns4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.2))+scale_y_continuous(expand = expansion(c(0.02,0.1)),limits=c(-1,1))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Correlation** (With 405 nm Signal)")+guides(color=guide_legend(override.aes = list(size=4)))

#500 x 450

#Sig indicator lines over any group to begin to indicate differences between methods 
annotation_df<-data.frame(
  xstart=c(0.6,1.6,1.6,1.6,2.6,2.6,3.6,3.6,3.6),
  xend=c(1.4,2.4,2.4,2.4,3.4,3.4,4.4,4.4,4.4),
  yvals= c(1.05,1.05,0.57,0.4,1.05,0.35,0.57,0.4,1.05),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over methods to begin to indicate differences between them 
annotation_df1<-data.frame(
  xstart=c(1),
  xend=c(2),
  yvals= c(1.15),
  labels=c(paste("list(symbol('***'))",sep=","))
  )
annotation_df2<-data.frame(
  xstart=c(2),
  xend=c(4),
  yvals= c(0.65),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df3<-data.frame(
  xstart=c(1),
  xend=c(3),
  yvals= c(1.15),
  labels=c(paste("list(symbol(''))",sep=","))
  )

annotation_df4<-data.frame(
  xstart=c(1),
  xend=c(4),
  yvals= c(1.15),
  labels=c(paste("list(symbol(''))",sep=","))
  )

annotation_df5<-data.frame(
  xstart=c(3),
  xend=c(4),
  yvals= c(0.453),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df6<-data.frame(
  xstart=c(2),
  xend=c(3),
  yvals= c(0.453),
  labels=c(paste("list(symbol('***'))",sep=","))
  )
ggplot(data=movement.analysis2_long,aes(x=Method,y=Correlation)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.corr,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE,color=c("black",NA,NA,NA),width=0.7)+geom_errorbar(data=ReplicateAverages.corr,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2),corral = "wrap",corral.width = 0.8)+scale_fill_manual(values = custom2)+geom_hline(yintercept=0,linetype=1)+scale_pattern_manual(values = patterns4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.2))+scale_y_continuous(expand = expansion(c(0.02,0.04)),limits=c(-1,1.2))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=title.sz,color="black"),axis.text.x=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**470 nm Signal Correlation**<br>(With 405 nm Signal)")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df1,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.02,0.045),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.035,0.035),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.045,0.045),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.02,0.046),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df5,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.045,0.023),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df6,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.023,0.045),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

#+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

ggsave(filename="CL20_MovementAnalysis_BeeswarmFlips_Correlation_by_Method_SI_narrow.tiff",plot=last_plot(), units="mm", width=450/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)
```


#### b) 470 nm Slope

```{r}
############
##Plot signal for all sessions per group divided only by sex 
ReplicateAverages <- movement.analysis2_long %>% group_by(Sex,Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages$Sex <-factor(ReplicateAverages$Sex,levels=c("Female", "Male"))

ReplicateAverages.slope<-filter(ReplicateAverages,variable=="Slope",preserve=TRUE)

#Sig indicator lines over any group to begin to indicate differences between methods 
annotation_df<-data.frame(
  Sex=c(rep.int("Female",9),rep.int("Male",9)),
  xstart=c(0.6,  1.6,1.6,1.6,  2.6,2.6,  3.6,3.6,3.6,     0.6,  1.6,1.6,1.6,  2.6,2.6,  3.6,3.6,3.6),
  xend=c(1.4,  2.4,2.4,2.4,  3.4,3.4,4.4,4.4,4.4,       1.4,  2.4,2.4,2.4,  3.4,3.4,  4.4,4.4,4.4),
  yvals= c(9,  7.6,12.75,10.3,  5.9,12.75,  10.3,7.6,12.75,        9,  7,12.75,4.7,   2.8,10,  7,4.7,12.75),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over methods to begin to indicate differences between them 
annotation_df1<-data.frame(
  Sex=c("Female","Male"),
  xstart=c(1,1),
  xend=c(2,2),
  yvals= c(14,14),
  labels=c(paste("list(symbol('***'))",sep=","),paste("list(symbol('***'))",sep=","))
  )

annotation_df2<-data.frame(
  Sex=c("Female","Male"),
  xstart=c(2,2),
  xend=c(4,4),
  yvals= c(11.2,8),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df3<-data.frame(
  xstart=c(1),
  xend=c(4),
  yvals= c(14),
  labels=c(paste("list(symbol(''))",sep=","))
  )

annotation_df4<-data.frame(
  Sex=c("Female","Male"),
  xstart=c(1,1),
  xend=c(3,3),
  yvals= c(14,11.2),
  labels=c(paste("list(scriptstyle(''))",sep=","),paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df5<-data.frame(
  Sex=c("Female","Male"),
  xstart=c(3,3),
  xend=c(4,4),
  yvals= c(8.5,5.5),
  labels=c(paste("list(symbol('*'))",sep=","),paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df6<-data.frame(
  Sex=c("Female","Male"),
  xstart=c(2,2),
  xend=c(3,3),
  yvals= c(8.5,5.5),
  labels=c(paste("list(symbol('*'))",sep=","),paste("list(scriptstyle('ns'))",sep=","))
  )

ggplot(data=movement.analysis2_long,aes(x=Method,y=Slope)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.slope,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE,color=c("black",NA,NA,NA,"black",NA,NA,NA),width=0.7)+geom_errorbar(data=ReplicateAverages.slope,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(x = as.integer(Method) +.35,size=2),corral = "wrap",corral.width = 0.3)+scale_fill_manual(values = custom2)+geom_hline(yintercept=0,linetype=1)+facet_wrap(.~Sex)+scale_pattern_manual(values = patterns4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(c(0.15,0.19)))+scale_y_continuous(expand = expansion(c(0.02,0.02)),limits=c(-13,15),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**470 nm Signal Slope**<br>(%<span style='font-family: Symbol;'>D</span>_F/F_ / Seconds)")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df1,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.19,0.047),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.035,0.035),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.045,0.045),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.046,0.046),hjust=1.75,size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df5,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.045,0.03),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df6,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = c(0.03,0.1),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

ggsave(filename="CL20_MovementAnalysis_BeeswarmFlips_Slope_by_Method_SI.tiff", plot=last_plot(), units="mm", width=600/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

# 600 x 450
#Group by Method
ggplot(data=movement.analysis2_long,aes(x=Method,y=Slope)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.slope,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE,color=c("black",NA,NA,NA,"black",NA,NA,NA),width=0.7)+geom_hline(yintercept=0,linetype=1)+geom_errorbar(data=ReplicateAverages.slope,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2),corral = "wrap",corral.width = 0.8)+scale_fill_manual(values = custom2)+scale_pattern_manual(values = patterns4)+facet_wrap(.~Sex,ncol=2) +scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.01))+scale_y_continuous(expand = expansion(0.02),limits=c(-13,10))+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=otr.sz1,color="black"),axis.title.y=element_markdown(size=title.sz),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Slope** (%dF/F / Seconds)")+guides(color=guide_legend(override.aes = list(size=4)))

#500 x 450



############
##Plot signal for all sessions per group collapsed by sex 
ReplicateAverages <- movement.analysis2_long %>% group_by(Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages.slope<-filter(ReplicateAverages,variable=="Slope",preserve=TRUE)

ggplot(data=movement.analysis2_long,aes(x=Method,y=Slope)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.slope,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE,color=c("black",NA,NA,NA),width=0.7)+geom_errorbar(data=ReplicateAverages.slope,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2),corral = "wrap",corral.width = 0.8)+scale_fill_manual(values = custom2)+geom_hline(yintercept=0,linetype=1)+scale_pattern_manual(values = patterns4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.2))+scale_y_continuous(expand = expansion(c(0.02,0.05)),limits=c(-13,10),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=txt.sz2,color="black"),axis.text.x=element_text(size=txt.sz2,color="black"),axis.title.y=element_markdown(size=title.sz,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**Slope** (%dF/F / Seconds)")+guides(color=guide_legend(override.aes = list(size=4)))

#500 x 450



#####################################
########## Publication Graph ########
#####################################

ReplicateAverages <- movement.analysis2_long %>% group_by(Method) %>% get_summary_stats(type = "mean_se");

ReplicateAverages.slope<-filter(ReplicateAverages,variable=="Slope",preserve=TRUE)


#Sig indicator lines over any group to begin to indicate differences between methods 
annotation_df<-data.frame(
  xstart=c(0.6,  1.6,1.6,1.6,  2.6,2.6,  3.6,3.6,3.6),
  xend=c(1.4,  2.4,2.4,2.4,  3.4,3.4,4.4,4.4,4.4),
  yvals= c(9,  7.6,12.75,10.3,  5.9,12.75,  10.3,7.6,12.75),
  labels=c(paste("list(symbol(''))",sep=","))
  )

#Sig indicator connectors to lines over methods to begin to indicate differences between them 
annotation_df1<-data.frame(
  xstart=c(1),
  xend=c(2),
  yvals= c(14),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df2<-data.frame(
  xstart=c(2),
  xend=c(4),
  yvals= c(11.2),
  labels=c(paste("list(scriptstyle('ns'))",sep=","))
  )

annotation_df3<-data.frame(
  xstart=c(1),
  xend=c(4),
  yvals= c(14),
  labels=c(paste("list(symbol(''))",sep=","))
  )

annotation_df4<-data.frame(
  xstart=c(1),
  xend=c(3),
  yvals= c(14),
  labels=c(paste("list(scriptstyle(''))",sep=","))
  )

annotation_df5<-data.frame(
  xstart=c(3),
  xend=c(4),
  yvals= c(8.5),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

annotation_df6<-data.frame(
  xstart=c(2),
  xend=c(3),
  yvals= c(8.5),
  labels=c(paste("list(symbol('***'))",sep=","))
  )

ggplot(data=movement.analysis2_long,aes(x=Method,y=Slope)) +theme_classic()+geom_col_pattern(data=ReplicateAverages.slope,aes(x=Method,y=mean,fill=Method,pattern=Method),show.legend = FALSE,color=c("black",NA,NA,NA),width=0.7)+geom_errorbar(data=ReplicateAverages.slope,aes(x=Method,y=mean,ymin=mean-se,ymax=mean+se),width=0.3,linewidth=1,color="black")+geom_beeswarm(cex=2.5,size=2,alpha=0.8,aes(size=2),corral = "wrap",corral.width = 0.8)+scale_fill_manual(values = custom2)+geom_hline(yintercept=0,linetype=1)+scale_pattern_manual(values = patterns4)+scale_x_discrete(labels=scales::label_wrap(4),expand = expansion(0.2))+scale_y_continuous(expand = expansion(c(0.02,0.02)),limits=c(-13,15),n.breaks=10)+theme(strip.text.x=element_text(size=title.sz),legend.background=element_rect(fill="transparent"),legend.title=element_blank(),legend.text=element_text(size=1),legend.justification="right", legend.direction = "horizontal", legend.position.inside=c(0.95,0.9),legend.box.spacing = unit(-3.5,"cm"),axis.text.y=element_text(size=title.sz,color="black"),axis.text.x=element_text(size=title.sz,color="black"),axis.title.y=element_markdown(size=title.sz2,margin=margin(r=3,unit="mm")),panel.grid.major = element_blank(),panel.grid.minor = element_blank())+labs(x=NULL, y="**470 nm Signal Slope**<br>(%dF/F / Seconds)")+guides(color=guide_legend(override.aes = list(size=4)))+geom_signif(inherit.aes=FALSE,data=annotation_df1,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.13,0.035),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df2,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.035,0.035),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df3,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.035,0.035),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df4,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.085,0.035),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df5,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.045,0.02),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)+geom_signif(inherit.aes=FALSE,data=annotation_df6,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz1, tip_length = c(0.02,0.045),size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

#+geom_signif(inherit.aes=FALSE,data=annotation_df,aes(xmin=xstart, xmax =xend,annotations=labels,y_position=yvals),textsize = otr.sz, tip_length = 0.00,size=0.5,vjust= 0.1,parse=TRUE,manual=TRUE)

ggsave(filename="CL20_MovementAnalysis_BeeswarmFlips_Slope_by_Method_SI.tiff", plot=last_plot(), units="mm", width=450/.pt, height=450/.pt, dpi=1000,path=output,device=grDevices::tiff)

```

### 5) Lies, Damn Lies, & Statistics - Dip Signal

#### i) Set Contrasts
```{r}
filenormod2<-"Z:/Christina Lebonville/2022.10.10 (CL20) CeA Dyn FP in Drinking Hedonics (CL20)/Movement Artifact Analysis/CL20 Movement Analysis Mixed Models Results (Effect Coded Method).xlsx"

############### CONTRAST ASSIGNMENT ########################
#Assigned contrasts use the factor levels previously made. 
#Check contrasts and change if desired:
#contrasts(bout.analysis2_true$Sex)
#contrasts(bout.analysis2_true$Solution)
#NOTE: CL made a Word document summarizing all the pre-made and custom contrasts and how to use them in R. 

##Declare this line of options to make comparable to SAS
#options(contrasts = c(faccontrtor = "contr.SAS", ordered = "contr.poly")) #Contrasts (decided to use centered contrasts after reading Yaremych et al 2023) *Time is set as a contrast after data is separated below. And do yourself a MASSIVE favor and use the colnames arguments to relabel the contrasts so you can determine what contrast you used. H = Helmert; S = Sum, E = Effect, T= Treatment. 

### IMPORTANT ###
#Here you will set the contrast scheme to be used for factors of different levels. You can use different contrasts depending on your hypotheses, but most options produce the same comparisons for a two-level factor. Things only get weird when it is a 3+ level factor.

movement.analysis2_long$Subject<-factor(movement.analysis2_long$Subject)
movement.analysis2_long$Sex<-factor(movement.analysis2_long$Sex,levels=sex.levels)
contrasts(movement.analysis2_long$Sex)<-contr.Helmert(levels(movement.analysis2_long$Sex))
colnames(contrasts(movement.analysis2_long$Sex))<-c("[H.Male-Female]")

# Effects Contrast Code: 
#creating the contrast matrix manually by modifying the dummy coding scheme
c<-contr.treatment(4) # Number of levels of factor in ()
my.coding<-matrix(rep(1/4, 12), ncol=3) # The first part of rep for matrix is 1/levels; Cols = 1-levels so the second part of rep for matrix is (1-levels * levels)
my.simple<-c-my.coding
colnames(my.simple)<-c("[E.Standard]","[E.Robust]","[E.Joint]")

contrasts(movement.analysis2_long$Method)<- my.simple

```

#### ii) Unconditional Means Models (UCM)

```{r}
## Note here that the random structure may be slightly different between measures. So we need to check on a structure for each measure first! 


#Unconditional Means Models 

model0.corr_fit<-lmerTest::lmer(formula= Correlation ~ 1 + (1|Subject),data=movement.analysis2_long, na.action=na.exclude);

model0.slope_fit<-lmerTest::lmer(formula= Slope ~ 1 + (1|Subject),data=movement.analysis2_long, na.action=na.exclude); #Singular!


models0<-ls(envir=.GlobalEnv,pattern="model0")  
models.call<-lapply(mget(models0),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models0){    
  obs<-sapply(ranef(get(k)),nrow)      
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info0c<-merge(models.call.df,model.obs.df)  

summary0c<-modelsummary::msummary(mget(models0),stars=T,output="data.frame")

LLR<-NULL 
LLR.df0c<-NULL 
for(k in models0){ 
  LLR<-data.frame("Model"=k,rand(get(k)))  
  LLR.df0c<-rbind(LLR.df0c,LLR) 
  }   

write.xlsx(model.info0c,file=filenormod2, sheetName = "Method_Move UCM Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary0c,file=filenormod2, sheetName = "Method_Move UCM", append=TRUE, row.names=FALSE)  
write.xlsx(LLR.df0c,file=filenormod2,sheetName = "Method_Move UCM LLR",append=TRUE)

```

#### iii) Lvl1 Models

```{r}
model1.corr_fit<-lmerTest::lmer(formula= Correlation ~ Method + (1|Subject),data=movement.analysis2_long, na.action=na.exclude);

model1.slope_fit<-lmerTest::lmer(formula= Slope ~ Method + (1|Subject),data=movement.analysis2_long, na.action=na.exclude);

```
#### iv) Gather Model Summaries (for Export)

```{r}

models1<-ls(envir=.GlobalEnv,pattern="model1")  
models.call<-lapply(mget(models1),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models1){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info1<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary1<-modelsummary::msummary(mget(models1),stars=T,output="data.frame",coef_rename = term.streamline)

## Now that we have our full model, one last check to see if any of the random terms should be dropped. Only do this once. You'll need the LLR for the rest of the models for model comparison. AKA - comment this part out after doing once with the base models.
# 
LLR1<-NULL
LLR1.df<-NULL
for(k in models1){
  LLR1<-data.frame("Model"=k,rand(get(k)))
  LLR1.df<-rbind(LLR1.df,LLR1)
}
```

#### v) Lvl2 Models

```{r}
model2.corr_fit<-lmerTest::lmer(formula= Correlation ~ Method*Sex + (1|Subject),data=movement.analysis2_long, na.action=na.exclude);

model2.slope_fit<-lmerTest::lmer(formula= Slope ~ Method*Sex + (1|Subject),data=movement.analysis2_long, na.action=na.exclude);
```
#### vi) Gather Model Summaries (for Export)

```{r}

models2<-ls(envir=.GlobalEnv,pattern="model2")  
models.call<-lapply(mget(models2),get_call)  
models.call.df<-data.frame("Model"=names(models.call),"Model_Call"=as.character(models.call))     

model.obs<-NULL  
model.obs.df<-NULL   
for(k in models2){    
  if (!class(get(k))=="lm"){
  obs<-sapply(ranef(get(k)),nrow)
  }else{obs<-"Model Has No Random Effects"}
  model.obs<-data.frame("Model"=k,"Observations"=toString(paste(names(obs),obs)))    
  model.obs.df<-rbind(model.obs.df,model.obs)  
  }    

model.info2<-merge(models.call.df,model.obs.df)  

term.streamline<-c("CAL_imc"="Calcium_within","CAL_gmc" = "Calcium_between","CTL_imc" = "Control_within","CTL_gmc" = "Control_between")
                   

summary2<-modelsummary::msummary(mget(models2),stars=T,output="data.frame",coef_rename = term.streamline)

## Now that we have our full model, one last check to see if any of the random terms should be dropped. Only do this once. You'll need the LLR for the rest of the models for model comparison. AKA - comment this part out after doing once with the base models.
# 
LLR2<-NULL
LLR2.df<-NULL
for(k in models2){
  LLR2<-data.frame("Model"=k,rand(get(k)))
  LLR2.df<-rbind(LLR2.df,LLR2)
}
```

#### vii) Model Plots and Stat Tables
```{r}
moi<-model2.slope_fit
moi.name<-"model2.slope_fit (Normalization Analysis: Movement Artifact 470 nm Slope)"

moi<-model1.corr_fit
moi.name<-"model1.corr_fit (Normalization Analysis: Movement Artifact Signal Correlation)"

#Check out EBLUP Plots of Effects for each random variable to get a sense for outliers and effects. 
plotREsim(REsim(moi),labs=TRUE) 

#standard fitted vs. residual plots,
plot(moi, type = c("p", "smooth"))
#scale-location plots,
plot(moi, sqrt(abs(resid(.))) ~ fitted(.),
type = c("p", "smooth"))
#and quantile-quantile plots (from lattice),
qqmath(moi, id = 0.05)

#Kolmogorov-Smirnov Tests for Normality in large sample sizes
ks.test(residuals(moi),y=pnorm)

#Effects plot
plot_model(moi, show.values = TRUE, vline.color = "black")

#Effects Table
sjPlot::tab_model(moi,show.ci=0.95,show.df=TRUE,show.r2=TRUE,show.icc=TRUE, show.p=TRUE,show.stat=TRUE,show.aic=TRUE,show.re.var= TRUE, title= moi.name,digits=3, digits.p=4,df.method = "satterthwaite",col.order = c("est", "se", "std.est", "std.se", "ci", "std.ci", "ci.inner", "ci.outer","df.error", "stat", "std.stat", "p", "std.p", "response.level"))

```


#### viii) Model Comparisons
```{r}
#To compare two models - we need to refit all models using REML=F.  
#Note that these comparisons are ONLY valid if both models have the same # of observations! 

#Easiest just to let it do that automatically when you try to run the code

model.0corr_anova<-anova(model1.corr_fit,model0.corr_fit)  
model.0slope_anova<-anova(model1.slope_fit,model0.slope_fit)  

LLR1<-rbind(model.0corr_anova, model.0slope_anova)

write.xlsx(LLR1,file=filenormod2,sheetName = "Method_Move Lvl1-Lvl0 LLR",append=TRUE)



##Level 2
model.1corr_anova<-anova(model1.corr_fit,model2.corr_fit)  
model.1slope_anova<-anova(model1.slope_fit,model2.slope_fit)  

LLR2<-rbind(model.1corr_anova, model.1slope_anova)

write.xlsx(LLR2,file=filenormod2,sheetName = "Method_Move Lvl2-Lvl1 LLR",append=TRUE)

```

#### ix) PostHoc Comparisons

```{r}
tukey1.corr<-emmeans(model1.corr_fit, list(pairwise ~ Method), adjust = "tukey",lmer.df="satterthwaite")

CI.corr<-confint(tukey1.corr,level=0.95)


tukey2.slope<-emmeans(model2.slope_fit, list(pairwise ~ Method*Sex), adjust = "tukey",lmer.df="satterthwaite")

CI.slope<-confint(tukey2.slope,level=0.95)

tukey2a.slope<-emmeans(model2.slope_fit, list(pairwise ~ Method), adjust = "tukey",lmer.df="satterthwaite")

CIa.slope<-confint(tukey2a.slope,level=0.95)

tuk2.slope<-emmeans(model2.slope_fit, ~Sex,by="Method", adjust = "tukey",lmer.df="satterthwaite",lmerTest.limit=4444) 
Method.simple<-pairs(pairs(tuk2.slope),simple="Method")
Method.simple.conf<-confint(Method.simple,level=0.95)


remove(tukey)
remove(CI)
remove(my.simple)
tukey<-ls(envir=.GlobalEnv,pattern="tukey") 
CI<-ls(envir=.GlobalEnv,pattern="CI") 
Simple<-ls(envir=.GlobalEnv,pattern="simple")
tuk.summary1<-NULL
tuk.summary2<-NULL
tuk.summary3<-NULL
tuk.summary4<-NULL

for (n in 1:length(tukey)){
temp<-NULL
temp2<-NULL
temp<-rbind(summary(get(tukey[[n]])[[1]]),temp)
temp<-cbind(temp,"Test"=rep(tukey[n],nrow(temp)))
tuk.summary1<-rbind.fill(tuk.summary1,temp)
temp2<-rbind(summary(get(tukey[[n]])[[2]]),temp2)
temp2<-cbind(temp2,"Test"=rep(tukey[n],nrow(temp2)))
tuk.summary2<-rbind.fill(tuk.summary2,temp2)
}

for (n in 1:length(CI)){
temp<-NULL
temp<-rbind(summary(get(CI[[n]])[[2]]),temp)
temp<-cbind(temp,"Test"=rep(CI[n],nrow(temp)))
tuk.summary3<-rbind.fill(tuk.summary3,temp)
}

##For simple comparisions
for (n in 1:length(Simple)){
temp<-NULL
temp<-rbind(summary(get(Simple[[n]])),temp)
temp<-cbind(temp,"Test"=rep(Simple[n],nrow(temp)))
tuk.summary4<-rbind.fill(tuk.summary4,temp)
}

```

#### x) Export Model Summaries and PostHoc Comparisons

```{r}
write.xlsx(model.info1,file=filenormod2, sheetName = "Method_Move Lvl1 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary1,file=filenormod2, sheetName = "Method_Move Lvl1", append=TRUE, row.names=FALSE)


write.xlsx(model.info2,file=filenormod2, sheetName = "Method_Move Lvl2 Info", append=TRUE, row.names=FALSE)  
write.xlsx(summary2,file=filenormod2, sheetName = "Method_Move Lvl2", append=TRUE, row.names=FALSE)



write.xlsx(tuk.summary1,file=filenormod2,sheetName = "Method_Move Tukey_Means",append=TRUE)
write.xlsx(tuk.summary2,file=filenormod2,sheetName = "Method_Move Tukey_Pairs",append=TRUE)
write.xlsx(tuk.summary3,file=filenormod2,sheetName = "Method_Move Tukey_CI",append=TRUE)
write.xlsx(tuk.summary4,file=filenormod2,sheetName = "Method_Move Tukey_Simple",append=TRUE)

##LLR Check for final models
write.xlsx(LLR1.df,file=filenormod2,sheetName = "Method_Move Lvl1 LLR",append=TRUE)
write.xlsx(LLR2.df,file=filenormod2,sheetName = "Method_Move Lvl2 LLR",append=TRUE)

```
